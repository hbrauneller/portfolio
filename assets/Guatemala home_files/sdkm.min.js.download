(function (root, factory) {
    if (typeof define === 'function' && define.amd) {
        define('ProductSDK', [], factory);
        if (typeof window.MagicShop !== 'undefined' &&
            typeof window.MagicShop.parentApp !== 'undefined' &&
            window.MagicShop.parentApp === "IC_WEB_CART") {
            require('ProductSDK');
        }
    } else {
        window.ProductSDK = factory();
    }
    window.newMgSdkVersion = true;
}(this, function () {
/**
 * @license almond 0.3.0 Copyright (c) 2011-2014, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/jrburke/almond for details
 */
//Going sloppy to avoid 'use strict' string cost, but strict practices should
//be followed.
/*jslint sloppy: true */
/*global setTimeout: false */

var requirejs, require, define;
(function (undef) {
    var main, req, makeMap, handlers,
        defined = {},
        waiting = {},
        config = {},
        defining = {},
        hasOwn = Object.prototype.hasOwnProperty,
        aps = [].slice,
        jsSuffixRegExp = /\.js$/;

    function hasProp(obj, prop) {
        return hasOwn.call(obj, prop);
    }

    /**
     * Given a relative module name, like ./something, normalize it to
     * a real name that can be mapped to a path.
     * @param {String} name the relative name
     * @param {String} baseName a real name that the name arg is relative
     * to.
     * @returns {String} normalized name
     */
    function normalize(name, baseName) {
        var nameParts, nameSegment, mapValue, foundMap, lastIndex,
            foundI, foundStarMap, starI, i, j, part,
            baseParts = baseName && baseName.split("/"),
            map = config.map,
            starMap = (map && map['*']) || {};

        //Adjust any relative paths.
        if (name && name.charAt(0) === ".") {
            //If have a base name, try to normalize against it,
            //otherwise, assume it is a top-level require that will
            //be relative to baseUrl in the end.
            if (baseName) {
                //Convert baseName to array, and lop off the last part,
                //so that . matches that "directory" and not name of the baseName's
                //module. For instance, baseName of "one/two/three", maps to
                //"one/two/three.js", but we want the directory, "one/two" for
                //this normalization.
                baseParts = baseParts.slice(0, baseParts.length - 1);
                name = name.split('/');
                lastIndex = name.length - 1;

                // Node .js allowance:
                if (config.nodeIdCompat && jsSuffixRegExp.test(name[lastIndex])) {
                    name[lastIndex] = name[lastIndex].replace(jsSuffixRegExp, '');
                }

                name = baseParts.concat(name);

                //start trimDots
                for (i = 0; i < name.length; i += 1) {
                    part = name[i];
                    if (part === ".") {
                        name.splice(i, 1);
                        i -= 1;
                    } else if (part === "..") {
                        if (i === 1 && (name[2] === '..' || name[0] === '..')) {
                            //End of the line. Keep at least one non-dot
                            //path segment at the front so it can be mapped
                            //correctly to disk. Otherwise, there is likely
                            //no path mapping for a path starting with '..'.
                            //This can still fail, but catches the most reasonable
                            //uses of ..
                            break;
                        } else if (i > 0) {
                            name.splice(i - 1, 2);
                            i -= 2;
                        }
                    }
                }
                //end trimDots

                name = name.join("/");
            } else if (name.indexOf('./') === 0) {
                // No baseName, so this is ID is resolved relative
                // to baseUrl, pull off the leading dot.
                name = name.substring(2);
            }
        }

        //Apply map config if available.
        if ((baseParts || starMap) && map) {
            nameParts = name.split('/');

            for (i = nameParts.length; i > 0; i -= 1) {
                nameSegment = nameParts.slice(0, i).join("/");

                if (baseParts) {
                    //Find the longest baseName segment match in the config.
                    //So, do joins on the biggest to smallest lengths of baseParts.
                    for (j = baseParts.length; j > 0; j -= 1) {
                        mapValue = map[baseParts.slice(0, j).join('/')];

                        //baseName segment has  config, find if it has one for
                        //this name.
                        if (mapValue) {
                            mapValue = mapValue[nameSegment];
                            if (mapValue) {
                                //Match, update name to the new value.
                                foundMap = mapValue;
                                foundI = i;
                                break;
                            }
                        }
                    }
                }

                if (foundMap) {
                    break;
                }

                //Check for a star map match, but just hold on to it,
                //if there is a shorter segment match later in a matching
                //config, then favor over this star map.
                if (!foundStarMap && starMap && starMap[nameSegment]) {
                    foundStarMap = starMap[nameSegment];
                    starI = i;
                }
            }

            if (!foundMap && foundStarMap) {
                foundMap = foundStarMap;
                foundI = starI;
            }

            if (foundMap) {
                nameParts.splice(0, foundI, foundMap);
                name = nameParts.join('/');
            }
        }

        return name;
    }

    function makeRequire(relName, forceSync) {
        return function () {
            //A version of a require function that passes a moduleName
            //value for items that may need to
            //look up paths relative to the moduleName
            var args = aps.call(arguments, 0);

            //If first arg is not require('string'), and there is only
            //one arg, it is the array form without a callback. Insert
            //a null so that the following concat is correct.
            if (typeof args[0] !== 'string' && args.length === 1) {
                args.push(null);
            }
            return req.apply(undef, args.concat([relName, forceSync]));
        };
    }

    function makeNormalize(relName) {
        return function (name) {
            return normalize(name, relName);
        };
    }

    function makeLoad(depName) {
        return function (value) {
            defined[depName] = value;
        };
    }

    function callDep(name) {
        if (hasProp(waiting, name)) {
            var args = waiting[name];
            delete waiting[name];
            defining[name] = true;
            main.apply(undef, args);
        }

        if (!hasProp(defined, name) && !hasProp(defining, name)) {
            throw new Error('No ' + name);
        }
        return defined[name];
    }

    //Turns a plugin!resource to [plugin, resource]
    //with the plugin being undefined if the name
    //did not have a plugin prefix.
    function splitPrefix(name) {
        var prefix,
            index = name ? name.indexOf('!') : -1;
        if (index > -1) {
            prefix = name.substring(0, index);
            name = name.substring(index + 1, name.length);
        }
        return [prefix, name];
    }

    /**
     * Makes a name map, normalizing the name, and using a plugin
     * for normalization if necessary. Grabs a ref to plugin
     * too, as an optimization.
     */
    makeMap = function (name, relName) {
        var plugin,
            parts = splitPrefix(name),
            prefix = parts[0];

        name = parts[1];

        if (prefix) {
            prefix = normalize(prefix, relName);
            plugin = callDep(prefix);
        }

        //Normalize according
        if (prefix) {
            if (plugin && plugin.normalize) {
                name = plugin.normalize(name, makeNormalize(relName));
            } else {
                name = normalize(name, relName);
            }
        } else {
            name = normalize(name, relName);
            parts = splitPrefix(name);
            prefix = parts[0];
            name = parts[1];
            if (prefix) {
                plugin = callDep(prefix);
            }
        }

        //Using ridiculous property names for space reasons
        return {
            f: prefix ? prefix + '!' + name : name, //fullName
            n: name,
            pr: prefix,
            p: plugin
        };
    };

    function makeConfig(name) {
        return function () {
            return (config && config.config && config.config[name]) || {};
        };
    }

    handlers = {
        require: function (name) {
            return makeRequire(name);
        },
        exports: function (name) {
            var e = defined[name];
            if (typeof e !== 'undefined') {
                return e;
            } else {
                return (defined[name] = {});
            }
        },
        module: function (name) {
            return {
                id: name,
                uri: '',
                exports: defined[name],
                config: makeConfig(name)
            };
        }
    };

    main = function (name, deps, callback, relName) {
        var cjsModule, depName, ret, map, i,
            args = [],
            callbackType = typeof callback,
            usingExports;

        //Use name if no relName
        relName = relName || name;

        //Call the callback to define the module, if necessary.
        if (callbackType === 'undefined' || callbackType === 'function') {
            //Pull out the defined dependencies and pass the ordered
            //values to the callback.
            //Default to [require, exports, module] if no deps
            deps = !deps.length && callback.length ? ['require', 'exports', 'module'] : deps;
            for (i = 0; i < deps.length; i += 1) {
                map = makeMap(deps[i], relName);
                depName = map.f;

                //Fast path CommonJS standard dependencies.
                if (depName === "require") {
                    args[i] = handlers.require(name);
                } else if (depName === "exports") {
                    //CommonJS module spec 1.1
                    args[i] = handlers.exports(name);
                    usingExports = true;
                } else if (depName === "module") {
                    //CommonJS module spec 1.1
                    cjsModule = args[i] = handlers.module(name);
                } else if (hasProp(defined, depName) ||
                           hasProp(waiting, depName) ||
                           hasProp(defining, depName)) {
                    args[i] = callDep(depName);
                } else if (map.p) {
                    map.p.load(map.n, makeRequire(relName, true), makeLoad(depName), {});
                    args[i] = defined[depName];
                } else {
                    throw new Error(name + ' missing ' + depName);
                }
            }

            ret = callback ? callback.apply(defined[name], args) : undefined;

            if (name) {
                //If setting exports via "module" is in play,
                //favor that over return value and exports. After that,
                //favor a non-undefined return value over exports use.
                if (cjsModule && cjsModule.exports !== undef &&
                        cjsModule.exports !== defined[name]) {
                    defined[name] = cjsModule.exports;
                } else if (ret !== undef || !usingExports) {
                    //Use the return value from the function.
                    defined[name] = ret;
                }
            }
        } else if (name) {
            //May just be an object definition for the module. Only
            //worry about defining if have a module name.
            defined[name] = callback;
        }
    };

    requirejs = require = req = function (deps, callback, relName, forceSync, alt) {
        if (typeof deps === "string") {
            if (handlers[deps]) {
                //callback in this case is really relName
                return handlers[deps](callback);
            }
            //Just return the module wanted. In this scenario, the
            //deps arg is the module name, and second arg (if passed)
            //is just the relName.
            //Normalize module name, if it contains . or ..
            return callDep(makeMap(deps, callback).f);
        } else if (!deps.splice) {
            //deps is a config object, not an array.
            config = deps;
            if (config.deps) {
                req(config.deps, config.callback);
            }
            if (!callback) {
                return;
            }

            if (callback.splice) {
                //callback is an array, which means it is a dependency list.
                //Adjust args if there are dependencies
                deps = callback;
                callback = relName;
                relName = null;
            } else {
                deps = undef;
            }
        }

        //Support require(['a'])
        callback = callback || function () {};

        //If relName is a function, it is an errback handler,
        //so remove it.
        if (typeof relName === 'function') {
            relName = forceSync;
            forceSync = alt;
        }

        //Simulate async callback;
        if (forceSync) {
            main(undef, deps, callback, relName);
        } else {
            //Using a non-zero value because of concern for what old browsers
            //do, and latest browsers "upgrade" to 4 if lower value is used:
            //http://www.whatwg.org/specs/web-apps/current-work/multipage/timers.html#dom-windowtimers-settimeout:
            //If want a value immediately, use require('id') instead -- something
            //that works in almond on the global level, but not guaranteed and
            //unlikely to work in other AMD implementations.
            setTimeout(function () {
                main(undef, deps, callback, relName);
            }, 4);
        }

        return req;
    };

    /**
     * Just drops the config on the floor, but returns req in case
     * the config return value is used.
     */
    req.config = function (cfg) {
        return req(cfg);
    };

    /**
     * Expose module registry for debugging and tooling
     */
    requirejs._defined = defined;

    define = function (name, deps, callback) {

        //This module may not have dependencies
        if (!deps.splice) {
            //deps is not an array, so probably means
            //an object literal or factory function for
            //the value. Adjust args.
            callback = deps;
            deps = [];
        }

        if (!hasProp(defined, name) && !hasProp(waiting, name)) {
            waiting[name] = [name, deps, callback];
        }
    };

    define.amd = {
        jQuery: true
    };
}());

define("lib/almond.js", function(){});

//     Underscore.js 1.7.0
//     http://underscorejs.org
//     (c) 2009-2014 Jeremy Ashkenas, DocumentCloud and Investigative Reporters & Editors
//     Underscore may be freely distributed under the MIT license.
(function(){var n=this,t=n._,r=Array.prototype,e=Object.prototype,u=Function.prototype,i=r.push,a=r.slice,o=r.concat,l=e.toString,c=e.hasOwnProperty,f=Array.isArray,s=Object.keys,p=u.bind,h=function(n){return n instanceof h?n:this instanceof h?void(this._wrapped=n):new h(n)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=h),exports._=h):n._=h,h.VERSION="1.7.0";var g=function(n,t,r){if(t===void 0)return n;switch(null==r?3:r){case 1:return function(r){return n.call(t,r)};case 2:return function(r,e){return n.call(t,r,e)};case 3:return function(r,e,u){return n.call(t,r,e,u)};case 4:return function(r,e,u,i){return n.call(t,r,e,u,i)}}return function(){return n.apply(t,arguments)}};h.iteratee=function(n,t,r){return null==n?h.identity:h.isFunction(n)?g(n,t,r):h.isObject(n)?h.matches(n):h.property(n)},h.each=h.forEach=function(n,t,r){if(null==n)return n;t=g(t,r);var e,u=n.length;if(u===+u)for(e=0;u>e;e++)t(n[e],e,n);else{var i=h.keys(n);for(e=0,u=i.length;u>e;e++)t(n[i[e]],i[e],n)}return n},h.map=h.collect=function(n,t,r){if(null==n)return[];t=h.iteratee(t,r);for(var e,u=n.length!==+n.length&&h.keys(n),i=(u||n).length,a=Array(i),o=0;i>o;o++)e=u?u[o]:o,a[o]=t(n[e],e,n);return a};var v="Reduce of empty array with no initial value";h.reduce=h.foldl=h.inject=function(n,t,r,e){null==n&&(n=[]),t=g(t,e,4);var u,i=n.length!==+n.length&&h.keys(n),a=(i||n).length,o=0;if(arguments.length<3){if(!a)throw new TypeError(v);r=n[i?i[o++]:o++]}for(;a>o;o++)u=i?i[o]:o,r=t(r,n[u],u,n);return r},h.reduceRight=h.foldr=function(n,t,r,e){null==n&&(n=[]),t=g(t,e,4);var u,i=n.length!==+n.length&&h.keys(n),a=(i||n).length;if(arguments.length<3){if(!a)throw new TypeError(v);r=n[i?i[--a]:--a]}for(;a--;)u=i?i[a]:a,r=t(r,n[u],u,n);return r},h.find=h.detect=function(n,t,r){var e;return t=h.iteratee(t,r),h.some(n,function(n,r,u){return t(n,r,u)?(e=n,!0):void 0}),e},h.filter=h.select=function(n,t,r){var e=[];return null==n?e:(t=h.iteratee(t,r),h.each(n,function(n,r,u){t(n,r,u)&&e.push(n)}),e)},h.reject=function(n,t,r){return h.filter(n,h.negate(h.iteratee(t)),r)},h.every=h.all=function(n,t,r){if(null==n)return!0;t=h.iteratee(t,r);var e,u,i=n.length!==+n.length&&h.keys(n),a=(i||n).length;for(e=0;a>e;e++)if(u=i?i[e]:e,!t(n[u],u,n))return!1;return!0},h.some=h.any=function(n,t,r){if(null==n)return!1;t=h.iteratee(t,r);var e,u,i=n.length!==+n.length&&h.keys(n),a=(i||n).length;for(e=0;a>e;e++)if(u=i?i[e]:e,t(n[u],u,n))return!0;return!1},h.contains=h.include=function(n,t){return null==n?!1:(n.length!==+n.length&&(n=h.values(n)),h.indexOf(n,t)>=0)},h.invoke=function(n,t){var r=a.call(arguments,2),e=h.isFunction(t);return h.map(n,function(n){return(e?t:n[t]).apply(n,r)})},h.pluck=function(n,t){return h.map(n,h.property(t))},h.where=function(n,t){return h.filter(n,h.matches(t))},h.findWhere=function(n,t){return h.find(n,h.matches(t))},h.max=function(n,t,r){var e,u,i=-1/0,a=-1/0;if(null==t&&null!=n){n=n.length===+n.length?n:h.values(n);for(var o=0,l=n.length;l>o;o++)e=n[o],e>i&&(i=e)}else t=h.iteratee(t,r),h.each(n,function(n,r,e){u=t(n,r,e),(u>a||u===-1/0&&i===-1/0)&&(i=n,a=u)});return i},h.min=function(n,t,r){var e,u,i=1/0,a=1/0;if(null==t&&null!=n){n=n.length===+n.length?n:h.values(n);for(var o=0,l=n.length;l>o;o++)e=n[o],i>e&&(i=e)}else t=h.iteratee(t,r),h.each(n,function(n,r,e){u=t(n,r,e),(a>u||1/0===u&&1/0===i)&&(i=n,a=u)});return i},h.shuffle=function(n){for(var t,r=n&&n.length===+n.length?n:h.values(n),e=r.length,u=Array(e),i=0;e>i;i++)t=h.random(0,i),t!==i&&(u[i]=u[t]),u[t]=r[i];return u},h.sample=function(n,t,r){return null==t||r?(n.length!==+n.length&&(n=h.values(n)),n[h.random(n.length-1)]):h.shuffle(n).slice(0,Math.max(0,t))},h.sortBy=function(n,t,r){return t=h.iteratee(t,r),h.pluck(h.map(n,function(n,r,e){return{value:n,index:r,criteria:t(n,r,e)}}).sort(function(n,t){var r=n.criteria,e=t.criteria;if(r!==e){if(r>e||r===void 0)return 1;if(e>r||e===void 0)return-1}return n.index-t.index}),"value")};var m=function(n){return function(t,r,e){var u={};return r=h.iteratee(r,e),h.each(t,function(e,i){var a=r(e,i,t);n(u,e,a)}),u}};h.groupBy=m(function(n,t,r){h.has(n,r)?n[r].push(t):n[r]=[t]}),h.indexBy=m(function(n,t,r){n[r]=t}),h.countBy=m(function(n,t,r){h.has(n,r)?n[r]++:n[r]=1}),h.sortedIndex=function(n,t,r,e){r=h.iteratee(r,e,1);for(var u=r(t),i=0,a=n.length;a>i;){var o=i+a>>>1;r(n[o])<u?i=o+1:a=o}return i},h.toArray=function(n){return n?h.isArray(n)?a.call(n):n.length===+n.length?h.map(n,h.identity):h.values(n):[]},h.size=function(n){return null==n?0:n.length===+n.length?n.length:h.keys(n).length},h.partition=function(n,t,r){t=h.iteratee(t,r);var e=[],u=[];return h.each(n,function(n,r,i){(t(n,r,i)?e:u).push(n)}),[e,u]},h.first=h.head=h.take=function(n,t,r){return null==n?void 0:null==t||r?n[0]:0>t?[]:a.call(n,0,t)},h.initial=function(n,t,r){return a.call(n,0,Math.max(0,n.length-(null==t||r?1:t)))},h.last=function(n,t,r){return null==n?void 0:null==t||r?n[n.length-1]:a.call(n,Math.max(n.length-t,0))},h.rest=h.tail=h.drop=function(n,t,r){return a.call(n,null==t||r?1:t)},h.compact=function(n){return h.filter(n,h.identity)};var y=function(n,t,r,e){if(t&&h.every(n,h.isArray))return o.apply(e,n);for(var u=0,a=n.length;a>u;u++){var l=n[u];h.isArray(l)||h.isArguments(l)?t?i.apply(e,l):y(l,t,r,e):r||e.push(l)}return e};h.flatten=function(n,t){return y(n,t,!1,[])},h.without=function(n){return h.difference(n,a.call(arguments,1))},h.uniq=h.unique=function(n,t,r,e){if(null==n)return[];h.isBoolean(t)||(e=r,r=t,t=!1),null!=r&&(r=h.iteratee(r,e));for(var u=[],i=[],a=0,o=n.length;o>a;a++){var l=n[a];if(t)a&&i===l||u.push(l),i=l;else if(r){var c=r(l,a,n);h.indexOf(i,c)<0&&(i.push(c),u.push(l))}else h.indexOf(u,l)<0&&u.push(l)}return u},h.union=function(){return h.uniq(y(arguments,!0,!0,[]))},h.intersection=function(n){if(null==n)return[];for(var t=[],r=arguments.length,e=0,u=n.length;u>e;e++){var i=n[e];if(!h.contains(t,i)){for(var a=1;r>a&&h.contains(arguments[a],i);a++);a===r&&t.push(i)}}return t},h.difference=function(n){var t=y(a.call(arguments,1),!0,!0,[]);return h.filter(n,function(n){return!h.contains(t,n)})},h.zip=function(n){if(null==n)return[];for(var t=h.max(arguments,"length").length,r=Array(t),e=0;t>e;e++)r[e]=h.pluck(arguments,e);return r},h.object=function(n,t){if(null==n)return{};for(var r={},e=0,u=n.length;u>e;e++)t?r[n[e]]=t[e]:r[n[e][0]]=n[e][1];return r},h.indexOf=function(n,t,r){if(null==n)return-1;var e=0,u=n.length;if(r){if("number"!=typeof r)return e=h.sortedIndex(n,t),n[e]===t?e:-1;e=0>r?Math.max(0,u+r):r}for(;u>e;e++)if(n[e]===t)return e;return-1},h.lastIndexOf=function(n,t,r){if(null==n)return-1;var e=n.length;for("number"==typeof r&&(e=0>r?e+r+1:Math.min(e,r+1));--e>=0;)if(n[e]===t)return e;return-1},h.range=function(n,t,r){arguments.length<=1&&(t=n||0,n=0),r=r||1;for(var e=Math.max(Math.ceil((t-n)/r),0),u=Array(e),i=0;e>i;i++,n+=r)u[i]=n;return u};var d=function(){};h.bind=function(n,t){var r,e;if(p&&n.bind===p)return p.apply(n,a.call(arguments,1));if(!h.isFunction(n))throw new TypeError("Bind must be called on a function");return r=a.call(arguments,2),e=function(){if(!(this instanceof e))return n.apply(t,r.concat(a.call(arguments)));d.prototype=n.prototype;var u=new d;d.prototype=null;var i=n.apply(u,r.concat(a.call(arguments)));return h.isObject(i)?i:u}},h.partial=function(n){var t=a.call(arguments,1);return function(){for(var r=0,e=t.slice(),u=0,i=e.length;i>u;u++)e[u]===h&&(e[u]=arguments[r++]);for(;r<arguments.length;)e.push(arguments[r++]);return n.apply(this,e)}},h.bindAll=function(n){var t,r,e=arguments.length;if(1>=e)throw new Error("bindAll must be passed function names");for(t=1;e>t;t++)r=arguments[t],n[r]=h.bind(n[r],n);return n},h.memoize=function(n,t){var r=function(e){var u=r.cache,i=t?t.apply(this,arguments):e;return h.has(u,i)||(u[i]=n.apply(this,arguments)),u[i]};return r.cache={},r},h.delay=function(n,t){var r=a.call(arguments,2);return setTimeout(function(){return n.apply(null,r)},t)},h.defer=function(n){return h.delay.apply(h,[n,1].concat(a.call(arguments,1)))},h.throttle=function(n,t,r){var e,u,i,a=null,o=0;r||(r={});var l=function(){o=r.leading===!1?0:h.now(),a=null,i=n.apply(e,u),a||(e=u=null)};return function(){var c=h.now();o||r.leading!==!1||(o=c);var f=t-(c-o);return e=this,u=arguments,0>=f||f>t?(clearTimeout(a),a=null,o=c,i=n.apply(e,u),a||(e=u=null)):a||r.trailing===!1||(a=setTimeout(l,f)),i}},h.debounce=function(n,t,r){var e,u,i,a,o,l=function(){var c=h.now()-a;t>c&&c>0?e=setTimeout(l,t-c):(e=null,r||(o=n.apply(i,u),e||(i=u=null)))};return function(){i=this,u=arguments,a=h.now();var c=r&&!e;return e||(e=setTimeout(l,t)),c&&(o=n.apply(i,u),i=u=null),o}},h.wrap=function(n,t){return h.partial(t,n)},h.negate=function(n){return function(){return!n.apply(this,arguments)}},h.compose=function(){var n=arguments,t=n.length-1;return function(){for(var r=t,e=n[t].apply(this,arguments);r--;)e=n[r].call(this,e);return e}},h.after=function(n,t){return function(){return--n<1?t.apply(this,arguments):void 0}},h.before=function(n,t){var r;return function(){return--n>0?r=t.apply(this,arguments):t=null,r}},h.once=h.partial(h.before,2),h.keys=function(n){if(!h.isObject(n))return[];if(s)return s(n);var t=[];for(var r in n)h.has(n,r)&&t.push(r);return t},h.values=function(n){for(var t=h.keys(n),r=t.length,e=Array(r),u=0;r>u;u++)e[u]=n[t[u]];return e},h.pairs=function(n){for(var t=h.keys(n),r=t.length,e=Array(r),u=0;r>u;u++)e[u]=[t[u],n[t[u]]];return e},h.invert=function(n){for(var t={},r=h.keys(n),e=0,u=r.length;u>e;e++)t[n[r[e]]]=r[e];return t},h.functions=h.methods=function(n){var t=[];for(var r in n)h.isFunction(n[r])&&t.push(r);return t.sort()},h.extend=function(n){if(!h.isObject(n))return n;for(var t,r,e=1,u=arguments.length;u>e;e++){t=arguments[e];for(r in t)c.call(t,r)&&(n[r]=t[r])}return n},h.pick=function(n,t,r){var e,u={};if(null==n)return u;if(h.isFunction(t)){t=g(t,r);for(e in n){var i=n[e];t(i,e,n)&&(u[e]=i)}}else{var l=o.apply([],a.call(arguments,1));n=new Object(n);for(var c=0,f=l.length;f>c;c++)e=l[c],e in n&&(u[e]=n[e])}return u},h.omit=function(n,t,r){if(h.isFunction(t))t=h.negate(t);else{var e=h.map(o.apply([],a.call(arguments,1)),String);t=function(n,t){return!h.contains(e,t)}}return h.pick(n,t,r)},h.defaults=function(n){if(!h.isObject(n))return n;for(var t=1,r=arguments.length;r>t;t++){var e=arguments[t];for(var u in e)n[u]===void 0&&(n[u]=e[u])}return n},h.clone=function(n){return h.isObject(n)?h.isArray(n)?n.slice():h.extend({},n):n},h.tap=function(n,t){return t(n),n};var b=function(n,t,r,e){if(n===t)return 0!==n||1/n===1/t;if(null==n||null==t)return n===t;n instanceof h&&(n=n._wrapped),t instanceof h&&(t=t._wrapped);var u=l.call(n);if(u!==l.call(t))return!1;switch(u){case"[object RegExp]":case"[object String]":return""+n==""+t;case"[object Number]":return+n!==+n?+t!==+t:0===+n?1/+n===1/t:+n===+t;case"[object Date]":case"[object Boolean]":return+n===+t}if("object"!=typeof n||"object"!=typeof t)return!1;for(var i=r.length;i--;)if(r[i]===n)return e[i]===t;var a=n.constructor,o=t.constructor;if(a!==o&&"constructor"in n&&"constructor"in t&&!(h.isFunction(a)&&a instanceof a&&h.isFunction(o)&&o instanceof o))return!1;r.push(n),e.push(t);var c,f;if("[object Array]"===u){if(c=n.length,f=c===t.length)for(;c--&&(f=b(n[c],t[c],r,e)););}else{var s,p=h.keys(n);if(c=p.length,f=h.keys(t).length===c)for(;c--&&(s=p[c],f=h.has(t,s)&&b(n[s],t[s],r,e)););}return r.pop(),e.pop(),f};h.isEqual=function(n,t){return b(n,t,[],[])},h.isEmpty=function(n){if(null==n)return!0;if(h.isArray(n)||h.isString(n)||h.isArguments(n))return 0===n.length;for(var t in n)if(h.has(n,t))return!1;return!0},h.isElement=function(n){return!(!n||1!==n.nodeType)},h.isArray=f||function(n){return"[object Array]"===l.call(n)},h.isObject=function(n){var t=typeof n;return"function"===t||"object"===t&&!!n},h.each(["Arguments","Function","String","Number","Date","RegExp"],function(n){h["is"+n]=function(t){return l.call(t)==="[object "+n+"]"}}),h.isArguments(arguments)||(h.isArguments=function(n){return h.has(n,"callee")}),"function"!=typeof/./&&(h.isFunction=function(n){return"function"==typeof n||!1}),h.isFinite=function(n){return isFinite(n)&&!isNaN(parseFloat(n))},h.isNaN=function(n){return h.isNumber(n)&&n!==+n},h.isBoolean=function(n){return n===!0||n===!1||"[object Boolean]"===l.call(n)},h.isNull=function(n){return null===n},h.isUndefined=function(n){return n===void 0},h.has=function(n,t){return null!=n&&c.call(n,t)},h.noConflict=function(){return n._=t,this},h.identity=function(n){return n},h.constant=function(n){return function(){return n}},h.noop=function(){},h.property=function(n){return function(t){return t[n]}},h.matches=function(n){var t=h.pairs(n),r=t.length;return function(n){if(null==n)return!r;n=new Object(n);for(var e=0;r>e;e++){var u=t[e],i=u[0];if(u[1]!==n[i]||!(i in n))return!1}return!0}},h.times=function(n,t,r){var e=Array(Math.max(0,n));t=g(t,r,1);for(var u=0;n>u;u++)e[u]=t(u);return e},h.random=function(n,t){return null==t&&(t=n,n=0),n+Math.floor(Math.random()*(t-n+1))},h.now=Date.now||function(){return(new Date).getTime()};var _={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"},w=h.invert(_),j=function(n){var t=function(t){return n[t]},r="(?:"+h.keys(n).join("|")+")",e=RegExp(r),u=RegExp(r,"g");return function(n){return n=null==n?"":""+n,e.test(n)?n.replace(u,t):n}};h.escape=j(_),h.unescape=j(w),h.result=function(n,t){if(null==n)return void 0;var r=n[t];return h.isFunction(r)?n[t]():r};var x=0;h.uniqueId=function(n){var t=++x+"";return n?n+t:t},h.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var A=/(.)^/,k={"'":"'","\\":"\\","\r":"r","\n":"n","\u2028":"u2028","\u2029":"u2029"},O=/\\|'|\r|\n|\u2028|\u2029/g,F=function(n){return"\\"+k[n]};h.template=function(n,t,r){!t&&r&&(t=r),t=h.defaults({},t,h.templateSettings);var e=RegExp([(t.escape||A).source,(t.interpolate||A).source,(t.evaluate||A).source].join("|")+"|$","g"),u=0,i="__p+='";n.replace(e,function(t,r,e,a,o){return i+=n.slice(u,o).replace(O,F),u=o+t.length,r?i+="'+\n((__t=("+r+"))==null?'':_.escape(__t))+\n'":e?i+="'+\n((__t=("+e+"))==null?'':__t)+\n'":a&&(i+="';\n"+a+"\n__p+='"),t}),i+="';\n",t.variable||(i="with(obj||{}){\n"+i+"}\n"),i="var __t,__p='',__j=Array.prototype.join,"+"print=function(){__p+=__j.call(arguments,'');};\n"+i+"return __p;\n";try{var a=new Function(t.variable||"obj","_",i)}catch(o){throw o.source=i,o}var l=function(n){return a.call(this,n,h)},c=t.variable||"obj";return l.source="function("+c+"){\n"+i+"}",l},h.chain=function(n){var t=h(n);return t._chain=!0,t};var E=function(n){return this._chain?h(n).chain():n};h.mixin=function(n){h.each(h.functions(n),function(t){var r=h[t]=n[t];h.prototype[t]=function(){var n=[this._wrapped];return i.apply(n,arguments),E.call(this,r.apply(h,n))}})},h.mixin(h),h.each(["pop","push","reverse","shift","sort","splice","unshift"],function(n){var t=r[n];h.prototype[n]=function(){var r=this._wrapped;return t.apply(r,arguments),"shift"!==n&&"splice"!==n||0!==r.length||delete r[0],E.call(this,r)}}),h.each(["concat","join","slice"],function(n){var t=r[n];h.prototype[n]=function(){return E.call(this,t.apply(this._wrapped,arguments))}}),h.prototype.value=function(){return this._wrapped},"function"==typeof define&&define.amd&&define("underscore",[],function(){return h})}).call(this);
/* This is for specific-Widget settings */
define("app/settings", [], function() {
    var settings = { cache: {} };

    return settings;
});
/*
    The cache module is used for Widget-wide settings
    All widgets on the same page - will share those settings.
 */

define("app/cache_module", ['underscore', 'app/settings'], function(_, settings) {

    function isPhotos() {
        console.log(">> Checking what cache mode to use:");
        var isInPhotos =
            typeof window.ThisLife !== 'undefined' &&
            typeof window.ThisLife.Settings !== 'undefined' &&
            typeof window.ThisLife.Settings.app !== 'undefined' &&
            window.ThisLife.Settings.app.indexOf("photos") !== -1;

        if (isInPhotos) {
            console.log(">> we are in Photos, localStorage OFF");
            return true;
        } else {
            console.log(">> we are not in Photos, localStorage ON");
            return false;
        }
    }

    var localStorageMgFlag = 'Mg3:';
    var localStorageEnableCheck = isPhotos() ? false : null;

    /*
    Check if the localStorage is enabled
    @return boolean
     */
    function localStorageEnabled() {
        if(localStorageEnableCheck === null) {
            try {
                if('localStorage' in window && window['localStorage'] !== null){
                    localStorage.setItem("test", 1);
                    localStorage.removeItem("test");
                    localStorageEnableCheck = true;
                    return true;
                } else {
                    localStorageEnableCheck = false;
                    return false;
                }
            } catch (e) {
                localStorageEnableCheck = false;
                return false;
            }
        } else {
            return localStorageEnableCheck;
        }
    }

    function isQuotaExceeded(e) {
        var quotaExceeded = false;
        if (e) {
            if (e.code) {
                switch (e.code) {
                    case 22:
                        quotaExceeded = true;
                        break;
                    case 1014:
                        // Firefox
                        if (e.name === 'NS_ERROR_DOM_QUOTA_REACHED') {
                            quotaExceeded = true;
                        }
                        break;
                }
            } else if (e.number === -2147024882) {
                // Internet Explorer 8
                quotaExceeded = true;
            }
        }
        return quotaExceeded;
    }

    return {
        /*
        Return the requested key from local storage.
        @key - key to retrieve
        @fromLocalStorage - if get from local storage
        @return null on failure, value on success.
         */
        get: function(key, fromLocalStorage) {
            key = localStorageMgFlag+key;
            fromLocalStorage = fromLocalStorage || false;
            if (fromLocalStorage && localStorageEnabled()) {
                var val = localStorage.getItem(key);
                if (val != 'undefined' && val != null) {
                    var result = JSON.parse(val);
                    if (typeof result.timestamp !== 'undefined') {
                        var valIsCurrent = new Date().getTime() < result.timestamp;
                        //if the value is deprecated, burst cache and return undefined
                        if (!valIsCurrent) {
                            localStorage.removeItem(key);
                            return undefined;
                        }
                    }
                    return JSON.parse(result.value);
                }
            } else {
                if (typeof window.MagicShop === 'undefined') {
                    window.MagicShop = {};
                }
                if (typeof window.MagicShop.cache === 'undefined') {
                    window.MagicShop.cache = {};
                }

                result = typeof window.MagicShop.cache[key] !== "undefined" ? window.MagicShop.cache[key] : undefined;

                return result !== undefined && fromLocalStorage ?  JSON.parse(result) : result;
            }
        },

        /*
        Set a value in the given key in the local storage
        @key - key to store the value in
        @val - value to store in the key
        @fromLocalStorage - store it as a reused key for commonalities
        @exirationInMs - Add expirationTime to burst the cache for that key
        @return nothing
         */
        set: function(key, val, fromLocalStorage, expirationInMs) {
            key = localStorageMgFlag+key;
            fromLocalStorage = fromLocalStorage || false;
            if (fromLocalStorage && localStorageEnabled()) {
                try {
                    var result = {value: JSON.stringify(val)};
                    if (typeof expirationInMs !== 'undefined') {
                        _.extend(result, {timestamp: Date.now() + expirationInMs});
                    }
                    localStorage.setItem(key, JSON.stringify(result));
                } catch(e) {
                    if (isQuotaExceeded(e)) {
                        console.log('[Products Widget] Quota Exceeded. Not using cache.');
                        this.clearLocalStorage();
                    }
                }
            } else {
                // If we have no local storage, use just a global JS object. Can happen in some anonymous browsing
                if (typeof window.MagicShop === 'undefined') {
                    window.MagicShop = {};
                }
                if (typeof window.MagicShop.cache === 'undefined') {
                    window.MagicShop.cache = {};
                }

                if (fromLocalStorage) {
                    val = JSON.stringify(val);
                }
                window.MagicShop.cache[key] = val;
            }

            return this;
        },

        /*
        Remove a key from local storage
        @key - key to remove. Will be removed with the value attached.
         */
        remove: function(key, fromLocalStorage) {
            key = localStorageMgFlag+key;
            fromLocalStorage = fromLocalStorage || false;
            if (fromLocalStorage && localStorageEnabled()) {
                localStorage.removeItem(key);
            } else {
                if (typeof window.MagicShop === 'undefined') {
                    window.MagicShop = {};
                }
                if (typeof window.MagicShop.cache !== 'undefined' && typeof window.MagicShop.cache[key] !== 'undefined') {
                    delete window.MagicShop.cache[key];
                }
            }
        },
        /*
         Remove keys starting with from local storage
         @keystart - keys to remove. Will be removed with the value attached.
         */
        removeStartWith: function(keystart, fromLocalStorage){
            var fromLocalStorage = fromLocalStorage || false;
            var keys = new Array();

            if (fromLocalStorage && localStorageEnabled()) {
                for (var i = 0, len = localStorage.length; i < len; i++) {
                    keys.push(localStorage.key(i));
                }
            } else if(typeof window.MagicShop.cache !== 'undefined') {
                keys = Object.keys(window.MagicShop.cache);
                fromLocalStorage = false;
            }

            for (var i = 0, len = keys.length; i < len; i++) {
                if (keys[i].indexOf(localStorageMgFlag+keystart) === 0) {
                    this.remove(keys[i].replace(localStorageMgFlag, ''), fromLocalStorage);
                }
            }
        },

        /*
        Will clear the cache
         */
        clearCache: function() {
            if (typeof window.MagicShop === 'undefined') {
                window.MagicShop = {};
            }
            if (typeof window.MagicShop.cache !== 'undefined') {
                window.MagicShop.cache = {};
            }
        },

        /*
         Will clear the local storage
         */
        clearLocalStorage: function() {
            Object.keys(localStorage).forEach(function(key) {
                if(key.indexOf(localStorageMgFlag) === 0) {
                    localStorage.removeItem(key);
                }
            });

            //localStorage.clear();
        },

        /*
        Will save a book JSON
        @param int albumId
        @param string bookId
        @param object json
        @return none
         */
        saveBookWithAlbum: function(albumId, bookId, onlyCover, isManual, json) {
            this.set(bookId + '_' + albumId + (onlyCover ? '_onlycover' : '')+ (isManual ? '_manual' : ''), json);
        },

        /*
        Will return a saved JSON with the given bookId and albumId
        @param int albumId
        @param string bookId
        @return object - the request JSON or null if not found
         */
        getBookWithAlbum: function(albumId, bookId, onlyCover, isManual) {
            return this.get(bookId + '_' + albumId + (onlyCover ? '_onlycover' : '') + (isManual ? '_manual' : ''));
        },

        /*
         Will save a print JSON
         @param int albumId
         @param string printsId
         @param boolean isManual
         @param object json
         @return none
         */
        savePrintsWithAlbum: function(albumId, printsId, isManual, json) {
            this.set(printsId + '_' + albumId + (isManual ? '_manual' : ''), json);
        },

        /*
         Will return a saved JSON with the given printsId and albumId
         @param int albumId
         @param string printsId
         @param boolean isManual
         @return object - the request JSON or null if not found
         */
        getPrintsWithAlbum: function(albumId, printsId, isManual) {
            return this.get(printsId + '_' + albumId + (isManual ? '_manual' : ''));
        },

        /*
         Will save a product JSON
         @param int albumId
         @param string productId
         @param object json
         @return none
         */
        saveProductWithAlbum: function(albumId, productId, json) {
            this.set(productId + '_' + albumId, json);
        },

        /*
         Will return a saved JSON with the given productId and albumId
         @param int albumId
         @param string productId
         @return object - the request JSON or null if not found
         */
        getProductWithAlbum: function(albumId, productId) {
            return this.get(productId + '_' + albumId);
        },

        saveCalendarWithAlbum: function(albumId, calId, json) {
            this.set('cal_' + calId + '_' + albumId, json);
        },

        getCalendarWithAlbum: function(albumId, calId) {
            return this.get('cal_' + calId + '_' + albumId);
        },

        saveUserAlbums: function(userId, albums) {
            this.set('albums_' + userId, albums);
        },

        getUserAlbums: function(userId) {
            return this.get('albums_' + userId);
        },

        saveUserAlbumPhotos: function(albumId, photos) {
            this.set('photos_' + albumId, photos);
        },

        getUserAlbumPhotos: function(albumId) {
            return this.get('photos_' + albumId);
        },

        getUserMessage: function() {
            return this.get('user_msg');
        },

        saveProduct: function(sku, productJson) {
            this.set('product_json_' + sku, productJson);
        },

        removeProduct: function(pId) {
            this.remove('product_json_' + pId);
        },

        getProduct: function(sku) {
            return this.get('product_json_' + sku);
        },

        removeProductsAll: function() {
            this.removeStartWith('product_json_');
        },

        getCoupon: function () {
            var coupon = this.get('coupon');
            if (typeof coupon === "undefined") {
                coupon = this.get('coupon', true);
                if (typeof coupon !== "undefined") {
                    this.set('coupon', coupon);
                }
            }
            return typeof coupon !== "undefined" && Math.floor(Date.now() / 1000)
                                                    <= coupon.utcExpirationTime ? coupon
                : undefined;
        },

        setCoupon: function (coupon) {
            if (typeof coupon !== "undefined" && coupon.hasOwnProperty("utcExpirationTime")) {
                var expireTime = coupon.utcExpirationTime * 1000 - Date.now();
                this.set('coupon', coupon, true, expireTime);
                this.set('coupon', coupon);
            }
        },

        getSku: function (sku) {
            if(typeof window.MagicShop.cache.skus === "undefined") {
                window.MagicShop.cache.skus = this.get('skus', true);
                if(typeof window.MagicShop.cache.skus === "undefined" || window.MagicShop.cache.skus === null) {
                    window.MagicShop.cache.skus = {};
                }
            }
            if(typeof window.MagicShop.cache.skus[sku] !== "undefined") {
                return window.MagicShop.cache.skus[sku];
            } else {
                return null;
            }
        },

        saveSku: function (sku, skuJson, permanent) {
            permanent = typeof permanent !== "undefined" ? permanent : true;
            if(typeof window.MagicShop.cache.skus === "undefined") {
                window.MagicShop.cache.skus = this.get('skus', true);
                if(typeof window.MagicShop.cache.skus === "undefined" || window.MagicShop.cache.skus === null) {
                    window.MagicShop.cache.skus = {};
                }
            }
            var savedSkus = Object.keys(window.MagicShop.cache.skus);
            var savedSkusLength = savedSkus.length;
            if(savedSkusLength >= 1000) {
                delete window.MagicShop.cache.skus[savedSkus[ savedSkusLength * Math.random() << 0]];
            }
            window.MagicShop.cache.skus[sku] = skuJson;
            if (permanent === true) {
                this.saveSkuInLocalStorage();
            }
        },

        saveSkuInLocalStorage: function() {
            if(typeof window.MagicShop.cache.skus === "undefined" || window.MagicShop.cache.skus === null) {
                window.MagicShop.cache.skus = {};
            }
            this.set('skus', window.MagicShop.cache.skus, true, 86400000);
        },

        getLayout: function (layout) {
            if(typeof window.MagicShop.cache.layouts === "undefined") {
                window.MagicShop.cache.layouts = this.get('layouts', true);
                if(typeof window.MagicShop.cache.layouts === "undefined" || window.MagicShop.cache.layouts === null) {
                    window.MagicShop.cache.layouts = {};
                }
            }
            if(typeof window.MagicShop.cache.layouts[layout] !== "undefined") {
                return window.MagicShop.cache.layouts[layout];
            } else {
                return null;
            }
        },

        saveLayout: function (layout, layoutJson, permanent) {
            permanent = typeof permanent !== "undefined" ? permanent : true;
            if(typeof window.MagicShop.cache.layouts === "undefined") {
                window.MagicShop.cache.layouts = this.get('layouts', true);
                if(typeof window.MagicShop.cache.layouts === "undefined" || window.MagicShop.cache.layouts === null) {
                    window.MagicShop.cache.layouts = {};
                }
            }
            var savedLayouts = Object.keys(window.MagicShop.cache.layouts);
            var savedLayoutsLength = savedLayouts.length;
            if(savedLayoutsLength >= 1500) {
                delete window.MagicShop.cache.layouts[savedLayouts[ savedLayoutsLength * Math.random() << 0]];
            }
            window.MagicShop.cache.layouts[layout] = layoutJson;
            if (permanent === true) {
                this.saveLayoutInLocalStorage();
            }
        },

        saveLayoutInLocalStorage: function() {
            if(typeof window.MagicShop.cache.layouts === "undefined" || window.MagicShop.cache.layouts === null) {
                window.MagicShop.cache.layouts = {};
            }
            this.set('layouts', window.MagicShop.cache.layouts, true, 86400000);
        }
    }
});
/*
The utils module will hold various methods.
 */
define('app/cookies', ['app/cache_module'], function(cache) {

    function correctCookieName(currName) {
        return currName + '_' + cache.get('partner_user_id');
    }

    return {
        /*
        Will set a cookie with the given name and value.
        @param string name - name of the cookie to add
        @param string value - the value of the cookie
        @param int expiresHours - In how many hours the cookie will expire
         */
        setCookie: function(name, value, expiresHours) {
            var expDate = new Date();
            expDate.setTime(expDate.getTime() + (expiresHours*60*60*1000));
            var expires = "expires=" + expDate.toUTCString();
            document.cookie = correctCookieName(name) + "=" + value + "; " + expires;
        },

        /*
         Will return the value of the cookie, if exists.
         @param string name - name of the cookie to return
         @return string - will return the value of cookie, null if not exists
         */
        getCookie: function(name) {
            var cookieName = correctCookieName(name) + "=";
            var cookieList = document.cookie.split(';');
            for (var i = 0; i < cookieList.length; i++) {
                var c = cookieList[i];

                while (c.charAt(0) == ' ') {
                    c = c.substring(1)
                }

                if (c.indexOf(cookieName) == 0) {
                    return c.substring(cookieName.length, c.length);
                }
            }
            return null;
        },

        /*
         Check if the given cookie is set.
         @param string name - name of the cookie to check
         @return boolean - true if exists
         */
        cookieExists: function(name) {
            var cookie = this.getCookie(name);
            return cookie != null;
        }
    }
});
/* Module for monitoring times and sending the results to an end-point */

define('app/time_monitor', ['underscore', 'app/cache_module'], function (_, cache) {
    function Monitoring(prodType) {

        var locked = false,
            env = 'prod',
            lastReport = Date.now(),
            events = {},
            waiting = {},
            self = this;

        var monitor_url = "https://02qrwk91yj.execute-api.us-east-1.amazonaws.com/prod/monitor";

        var APP_SOURCE = "MagicShopSDK_" + prodType;

        this.init = function () {
            this.env = cache.get('env');
            if (this.env !== "prod") {
                monitor_url =
                    "https://i05gyatc0l.execute-api.us-east-1.amazonaws.com/prod/monitor";
            }
        };

        this.start = function () {
            this.init();
            setInterval(this.report, 6000);
        };

        this.isLocked = function () {
            return locked;
        };

        this.lock = function () {
            locked = true;
        };

        this.unlock = function () {
            locked = false;
        };

        this.addCounter = function(eventName)
        {
            var arr = (this.isLocked() ? waiting : events);
            var current = Date.now();
            arr[eventName] =
                {
                    type: "counter",
                    name: eventName,
                    source: APP_SOURCE,
                    ready: true,
                    timestamp: Math.floor(current/1000),
                    value: 1
                };

        };

        this.eventStart = function (eventName, ts) {

            //if is locked - add to waiting list. otherwise to regular events
            this.add('timer', eventName,
                     typeof ts !== "undefined" ? ts : undefined);
        };

        this.eventEnd = function (eventName, ts) {
            //if is locked - add to waiting list. otherwise to regular events
            this.add('end', eventName,
                     typeof ts !== "undefined" ? ts : undefined);
        };

        this.reportEvent = function (eventName, data) {
            //if is locked - add to waiting list. otherwise to regular events
            this.add('failure', eventName);
        };

        this.add = function (typeOfEvent, eventName, value) {

            if (eventName.match(/\:generate\:|\:prepare/i)) {
                return;
            }

            var arr = (this.isLocked() ? waiting : events);
            var current = Date.now();
            var readyToSent = false;

            if (typeOfEvent === "end") {
                typeOfEvent = 'timer';
                readyToSent = true;
                if (arr.hasOwnProperty((eventName)) && typeof arr[eventName] === "object") {
                    value = current - arr[eventName].value;
                }
            } else {
                if(typeof value == "undefined")
                    value = current;
            }

            arr[eventName] =
                {
                    type: typeOfEvent,
                    name: eventName,
                    source: APP_SOURCE,
                    ready: readyToSent,
                    timestamp: Math.floor(current/1000),
                    value: typeof value === "undefined" ? 1 : value
                };
        };

        this.report = function () {

            if(cache.get('full_load') || Date.now() - lastReport >= 5000) {
                lastReport = Date.now();

                self.lock();

                var keysToRemove = [];
                var objsToSend = [];

                Object.keys(events).forEach(function (key) {
                    if (events[key].type === 'timer' || events[key].type === 'failure' || events[key].type === 'counter') {

                        if(events[key].ready === true ) {
                            objsToSend.push(events[key]);
                            // And remove it from the queue
                            keysToRemove.push(key);
                        }
                    }
                });

                // Send them to server and remove
                if (objsToSend.length > 0) {
                    $.ajax({
                               contentType: 'application/json',
                               data: JSON.stringify(objsToSend),
                               dataType: 'json',
                               async: true,
                               type: 'POST',
                               url: monitor_url
                           });
                }

                keysToRemove.forEach(function (key) {
                    delete events[key];
                });

                self.unlock();

                // After all is done, we can process the wait list if filled during the wait
                events = waiting;
                waiting = {};
            }
        };

        this.start();
    }

    return Monitoring;
});

define('app/globals', [], function() {
    return {
        "SMALL_MOBILE_THRESHOLD": 640,
        "MOBILE_THRESHOLD": 992,
        "TABLET_THRESHOLD": 768
    }
});
/*
The utils module will hold various methods.
 */
define("app/utils", ['app/globals'], function(globals) {

    function isCanvasSupported(){
        var elem = document.createElement('canvas');
        return !!(elem.getContext && elem.getContext('2d'));
    }

    function escapeRegExp(string) {
        return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, "\\$1");
    }

    /* -- helpers for disabling scrolling -- */

    // left: 37, up: 38, right: 39, down: 40,
    var keys = [37, 38, 39, 40];

    function preventDefault(e) {
        e = e || window.event;
        if (e.preventDefault)
            e.preventDefault();
        e.returnValue = false;
    }

    function onKeydown(e) {
        for (var i = keys.length; i--;) {
            if (e.keyCode === keys[i]) {
                preventDefault(e);
                return;
            }
        }
    }

    function onWheelScroll(e) {
        preventDefault(e);
    }
    /* -- finish scrolling helpers -- */

    function isMobileDeviceDetect() {
        var isMobile = false; //initiate as false
        // device detection
        if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|ipad|iris|kindle|Android|Silk|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(navigator.userAgent)
            || /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(navigator.userAgent.substr(0,4))) isMobile = true;
        return isMobile;
    }


    /** Browser Detection logic
     * taken from https://github.com/DamonOehlman/detect-browser
     Copyright (c) 2017 Damon Oehlman damon.oehlman@gmail.com
     Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the 'Software'), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:
     The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.
     THE SOFTWARE IS PROVIDED 'AS IS', WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
    **/
    function detectBrowser() {
        if (typeof navigator !== 'undefined') {
            return parseUserAgent(navigator.userAgent);
        }

        return null;
    }

    function detectOS(userAgentString) {
        var rules = getOperatingSystemRules();
        var detected = rules.filter(function (os) {
            return os.rule && os.rule.test(userAgentString);
        })[0];

        return detected ? detected.name : null;
    }

    function parseUserAgent(userAgentString) {
        var browsers = getBrowserRules();
        if (!userAgentString) {
            return null;
        }

        var detected = browsers.map(function(browser) {
                var match = browser.rule.exec(userAgentString);
                var version = match && match[1].split(/[._]/).slice(0,3);

                if (version && version.length < 3) {
                    version = version.concat(version.length == 1 ? [0, 0] : [0]);
                }

                return match && {
                        name: browser.name,
                        version: version.join('.')
                    };
            }).filter(Boolean)[0] || null;

        if (detected) {
            detected.os = detectOS(userAgentString);
        }

        return detected;
    }

    function getOperatingSystemRules() {
        return buildRules([
            [ 'iOS', /iP(hone|od|ad)/ ],
            [ 'Android OS', /Android/ ],
            [ 'BlackBerry OS', /BlackBerry|BB10/ ],
            [ 'Windows Mobile', /IEMobile/ ],
            [ 'Amazon OS', /Kindle/ ],
            [ 'Windows 3.11', /Win16/ ],
            [ 'Windows 95', /(Windows 95)|(Win95)|(Windows_95)/ ],
            [ 'Windows 98', /(Windows 98)|(Win98)/ ],
            [ 'Windows 2000', /(Windows NT 5.0)|(Windows 2000)/ ],
            [ 'Windows XP', /(Windows NT 5.1)|(Windows XP)/ ],
            [ 'Windows Server 2003', /(Windows NT 5.2)/ ],
            [ 'Windows Vista', /(Windows NT 6.0)/ ],
            [ 'Windows 7', /(Windows NT 6.1)/ ],
            [ 'Windows 8', /(Windows NT 6.2)/ ],
            [ 'Windows 8.1', /(Windows NT 6.3)/ ],
            [ 'Windows 10', /(Windows NT 10.0)/ ],
            [ 'Windows ME', /Windows ME/ ],
            [ 'Open BSD', /OpenBSD/ ],
            [ 'Sun OS', /SunOS/ ],
            [ 'Linux', /(Linux)|(X11)/ ],
            [ 'Mac OS', /(Mac_PowerPC)|(Macintosh)/ ],
            [ 'QNX', /QNX/ ],
            [ 'BeOS', /BeOS/ ],
            [ 'OS/2', /OS\/2/ ],
            [ 'Search Bot', /(nuhk)|(Googlebot)|(Yammybot)|(Openbot)|(Slurp)|(MSNBot)|(Ask Jeeves\/Teoma)|(ia_archiver)/ ]
        ]);
    }

    function getBrowserRules() {
        return buildRules([
            [ 'edge', /Edge\/([0-9\._]+)/ ],
            [ 'yandexbrowser', /YaBrowser\/([0-9\._]+)/ ],
            [ 'vivaldi', /Vivaldi\/([0-9\.]+)/ ],
            [ 'kakaotalk', /KAKAOTALK\s([0-9\.]+)/ ],
            [ 'chrome', /(?!Chrom.*OPR)Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/ ],
            [ 'phantomjs', /PhantomJS\/([0-9\.]+)(:?\s|$)/ ],
            [ 'crios', /CriOS\/([0-9\.]+)(:?\s|$)/ ],
            [ 'firefox', /Firefox\/([0-9\.]+)(?:\s|$)/ ],
            [ 'fxios', /FxiOS\/([0-9\.]+)/ ],
            [ 'opera', /Opera\/([0-9\.]+)(?:\s|$)/ ],
            [ 'opera', /OPR\/([0-9\.]+)(:?\s|$)$/ ],
            [ 'ie', /Trident\/7\.0.*rv\:([0-9\.]+).*\).*Gecko$/ ],
            [ 'ie', /MSIE\s([0-9\.]+);.*Trident\/[4-7].0/ ],
            [ 'ie', /MSIE\s(7\.0)/ ],
            [ 'bb10', /BB10;\sTouch.*Version\/([0-9\.]+)/ ],
            [ 'android', /Android\s([0-9\.]+)/ ],
            [ 'ios', /Version\/([0-9\._]+).*Mobile.*Safari.*/ ],
            [ 'safari', /Version\/([0-9\._]+).*Safari/ ]
        ]);
    }

    function buildRules(ruleTuples) {
        return ruleTuples.map(function(tuple) {
            return {
                name: tuple[0],
                rule: tuple[1]
            };
        });
    }

    return {
        /*
        Will parse parameters in a query string
        @return object with the parsed parameters
        */
        parse_query_vars: function (text)
        { // Extract name=value pairs from URL query string.
            // Empty object to store name, value pairs.
            var qvars = {},
            // Capture non-empty query string in $1.
                re_q = /\?([^#]+)/, // From '?' up to '#' or EOS.
            // Capture variable name in $1 and value in $2.
                re_nv = /([^=]+)=([^&]*)(?:&(amp;)?|$)/gi,
            // Match array for query string and va=val pairs.
                m =  text.match(re_q),
            // Query string plucked from URL
                q = '';
            // If there is a query string, copy to q var.
            if (m) q = m[1];
            while (m = re_nv.exec(q)) {
                if(m[1] !== "token") {
                    m[1] = m[1].toLowerCase();
                }
                qvars[m[1]] = m[2];
            }

            return qvars; // Return results in object
        },

        /*
         Check if we can render the HTML5 based widget or have to resort to static images
         @return boolean - true if the current IE is supported
         */
        IESupported: function() {
            var jscriptMap = {
                "5.5": "5.5",
                "5.6": "6",
                "5.7": "7",
                "5.8": "8",
                "9": "9",
                "10": "10",
                "11": "11"
            };
            var jscriptVersion = new Function("/*@cc_on return @_jscript_version; @*/")(); // A trick to get IE version

            if (jscriptVersion != undefined) {
                var ieVersion = jscriptMap[jscriptVersion];
                if (ieVersion <= 10) {
                    return false;
                }
            }

            return true;
        },

        isIE11: function() {
            return window.navigator.userAgent.indexOf('Trident/7.0') != -1;
        },

        isIE: function() {
            var ua = window.navigator.userAgent;

            var msie = ua.indexOf('MSIE ');
            if (msie > 0) {
                // IE 10 or older => return version number
                //return parseInt(ua.substring(msie + 5, ua.indexOf('.', msie)), 10);
                return true;
            }

            var trident = ua.indexOf('Trident/');
            if (trident > 0) {
                // IE 11 => return version number
                //var rv = ua.indexOf('rv:');
                //return parseInt(ua.substring(rv + 3, ua.indexOf('.', rv)), 10);
                return true;
            }

            var edge = ua.indexOf('Edge/');
            if (edge > 0) {
                // Edge (IE 12+) => return version number
                //return parseInt(ua.substring(edge + 5, ua.indexOf('.', edge)), 10);
                return true;
            }

            // other browser
            return false;
        },

        /*
        Check if a canvas can be rendered
        @return boolean - true if current browser can render a canvas
         */
        browserSupported: function() {
            return this.IESupported() && isCanvasSupported();
        },

        /*
        Check if the widget has enough space to open
        @param object widgetSize - object with the widget sizes
        @return boolean - true if can be open, false if not
         */
        hasSpaceToOpenWidget: function(widgetSize) {
            var winHeight   = $(window).height();
            var winWidth    = $(window).width();

            if (winHeight < widgetSize.height + widgetSize.vertical_small) {
                return false;
            }

            return winWidth >= widgetSize.width + widgetSize.openwidth + widgetSize.horizontal;
        },

        isMobile: (function() {
            return isMobileDeviceDetect() //|| $(window).width() < globals.SMALL_MOBILE_THRESHOLD;
        })(),

        /* Will disable scrolling in the window */
        disableScroll: function() {
            // Disable scrolling by keys and by mouse
            if (window.addEventListener) {
                window.addEventListener('DOMMouseScroll', onWheelScroll, false);
            }

            window.onmousewheel = document.onmousewheel = onWheelScroll;
            document.onkeydown = onKeydown;
        },

        /* Will enable scrolling in the window */
        enableScroll: function() {
            if (window.removeEventListener) {
                window.removeEventListener('DOMMouseScroll', onWheelScroll, false);
            }
            window.onmousewheel = document.onmousewheel = document.onkeydown = null;
        },

        /* Will disable scrolling in the document body */
        disableScrollBody: function() {
            document.onkeydown = onKeydown;
            $(document.body).addClass('no-scroll');
        },

        /* Will enable scrolling in the document body */
        enableScrollBody: function() {
            window.onmousewheel = document.onmousewheel = document.onkeydown = null;
            $(document.body).removeClass('no-scroll');
        },

        replaceAll: function(str, find, replace) {
            return str.replace(new RegExp(escapeRegExp(find), 'g'), replace);
        },

        /*
         Will return a random Id for use to open a new tab. Assumption: the space for 14 alphanumerics is so large we won't get collides
         @return string
         */
        getWindowHandlerId: function() {
            // This is a trick to get easily an alphanumeric string
            return Math.random().toString(36).substring(7) + Math.random().toString(36).substring(7);
        },

        inheritPrototype: function(childObject, parentObject) {
            var copyOfParent = Object.create(parentObject.prototype);
            copyOfParent.constructor = childObject;
            childObject.prototype = copyOfParent;
        },
        /*
            Formats string and replaces {0}, {1} with values
        */
        formatString: function() {
            var s = arguments[0];
            for (var i = 0; i < arguments.length - 1; i++) {
                var reg = new RegExp("\\{" + i + "\\}", "gm");
                s = s.replace(reg, arguments[i + 1]);
            }
            return s;
        },

        findParentWithClass: function(el, classToFind) {
            return el.closest('.'+classToFind);
        },

        cloneObject: function (obj) {
            var copy;

            // Handle the 3 simple types, and null or undefined
            if (null === obj || "object" !== typeof obj) {
                return obj;
            }

            // Handle Date
            if (obj instanceof Date) {
                copy = new Date();
                copy.setTime(obj.getTime());
                return copy;
            }

            // Handle Array
            if (obj instanceof Array) {
                copy = [];
                for (var i = 0, len = obj.length; i < len; i++) {
                    copy[i] = this.cloneObject(obj[i]);
                }
                return copy;
            }

            // Handle Object
            if (obj instanceof Object) {
                copy = {};
                for (var attr in obj) {
                    if (obj.hasOwnProperty(attr)) {
                        copy[attr] = this.cloneObject(obj[attr]);
                    }
                }
                return copy;
            }

            throw new Error("Unable to copy obj! Its type isn't supported.");
        },

        browserInfo: (function() {
            return detectBrowser();
        })()

    }
});
/*
The config manager is responsible for managing configurations for the widget.
It will use the cache module for storing the configuration.
Primarily it's purpose is to parse config files, store them and retrieve the right values.
 */

define("app/config_manager", ['underscore', 'app/cache_module', 'app/cookies', 'app/time_monitor', 'app/settings', 'app/utils'], function(_, cache, cookie, Monitor, settings, utils) {
    var supportWidgetTypes = ['photobook', 'prints', 'cns', 'photogifts', 'personalized-gifts', 'homedecor', 'home-decor', 'calendar', 'specialoffers', 'homepage', 'mysfly', 'cross_sell', 'statement-gifts', 'algo'];

    function getBookIdsFromRecipeJson(json) {
        var bookStyles = Object.keys(json.ProductInfoByStyle);
        var bookSize = json.productInfo.size;

        var ids = [];

        bookStyles.forEach(function(style) {
           ids.push(style + "_" + bookSize);
        });
    }

    function addMinutes(dateObj, minutes) {
        return new Date(dateObj.getTime() + minutes * 60000);
    }

    function updateShuffleForStructureSection(structure, newMapping) {
        var mappingHash = {};
        var newStructure = {};
        newMapping.forEach(function(item) {
            mappingHash[item.origSku] = item.newSku;
        });

        Object.keys(structure).forEach(function(key) {
            newStructure[key] = [];
            structure[key].forEach(function(sku) {
                newStructure[key].push(mappingHash[sku]);
            });
        });

        return newStructure;
    }

    function shuffleProducts(section, productMap, widgetType) {
        var shuffleCookieName = widgetType+"_shuffle";

        // Seach for prints - as we might have different sizes
        var productsWithoutPrint = _.filter(section.products, function(prod) { return prod.indexOf('prints') == -1; });
        // Count the min num of associations, so we can iterate only over this number
        var minNumOfProds = _.min(_.map(productsWithoutPrint, function(sku) {
            return section.associations[sku].length;
        })) - 1;

        var selectedIndex = 0;
        //var previousShuffle = cookie.getCookie(shuffleCookieName);
        var previousShuffle = cache.get(shuffleCookieName, true);
        if (typeof previousShuffle !== "undefined" && previousShuffle != null) {
            selectedIndex = parseInt(previousShuffle)+1;
            if(selectedIndex >= minNumOfProds - 1){
                selectedIndex = 0;
            }
        }

        //cookie.setCookie(shuffleCookieName, selectedIndex, 720);
        cache.set(shuffleCookieName, selectedIndex, true, 604800000); // one week

        var newProdMapping  = [];
        var products        = cache.get('products');
        section.products.forEach(function(pSku) {
            // shuffle the products that are not photobook, prints, calendar
            var productType = null;
            productMap.forEach(function(prod){
                if(prod['sku'] == pSku) {
                    productType = prod['type'];
                    return;
                }
            });

            var associationsWithOnePhotoSupport = _.filter(section.associations[pSku], function(asscSku) {
                //remove all products with more then 1 photo - except mysfly, homepage and homedecor, were we use all the products in the shuffle
                return asscSku.indexOf('_') > -1 || products[asscSku].minPhotos <= 1 || widgetType === 'horizontal_mysfly' || widgetType === 'horizontal_homepage' || widgetType === 'tl_horizontal_homedecor';
            });

            // Shuffle all products except Prints
            if(productType !== null && productType !== 'prints') {
                // We want to shuffle only from first 4 products - as they're most popular
                if(widgetType === 'horizontal_mysfly' || widgetType === 'horizontal_homepage') {
                    var cutPoint = _.min([4, minNumOfProds]);
                    var firstFour = _.first(section.associations[pSku], cutPoint);
                    var restProds = _.rest(section.associations[pSku], cutPoint);

                    // put one of the 4 as first
                    firstFour.splice(0, 0, firstFour.splice(selectedIndex, 1)[0]);
                    section.associations[pSku] = _.compact(_.union(firstFour, restProds));
                } else {
                    var shuffleIndex = Math.floor(Math.random() * _.min([4, associationsWithOnePhotoSupport.length]));
                    var chosenSku = associationsWithOnePhotoSupport[shuffleIndex];
                    var chosenSkuIndex = section.associations[pSku].indexOf(chosenSku);
                    section.associations[pSku].splice(chosenSkuIndex, 1);
                    section.associations[pSku].splice(0, 0, chosenSku);
                }
            }

            newProdMapping.push({
                origSku: pSku,
                newSku: section.associations[pSku][0]
            });
        });

        // Need this one as to not change the array we're running on
        newProdMapping.forEach(function(newMapping) {
            section.products[section.products.indexOf(newMapping.origSku)] = newMapping.newSku;

            // Update zoom levels
            section.zoom_levels[newMapping.newSku] = section.zoom_levels[newMapping.origSku];

            // Update options if applicable
            if (section.hasOwnProperty('options')) {
                section.options[newMapping.newSku] = section.options[newMapping.origSku];
            }

            // Update association
            section.associations[newMapping.newSku] = section.associations[newMapping.origSku];
        });

        if (section.hasOwnProperty('structure')) {
            section.structure = updateShuffleForStructureSection(section.structure, newProdMapping);
        }

        return section;
    }

    function shuffleBook(section, productMap, widgetType) {
        // Assumption: All photo books have the same styles.

        function updateShuffleSectionPart(sectionName, newStyle) {
            var oldKeys = [];
            Object.keys(section[sectionName]).forEach(function(key) {
                var size = key.split('_')[1];
                var newKey = [newStyle, size].join('_');
                section[sectionName][newKey] = section[sectionName][key];
                if (newKey != key) {
                    oldKeys.push(key);
                }
            });

            oldKeys.forEach(function(key) {
                delete section[sectionName][key];
            });
        }

        function updateShuffleStructure(newStyle) {
            if (!section.hasOwnProperty('structure')) {
                return;
            }

            var newStructure = {};

            Object.keys(section['structure']).forEach(function(category) {
                newStructure[category] = [];

                section['structure'][category].forEach(function(bookId) {
                    var size = bookId.split('_')[1];
                    newStructure[category].push([newStyle, size].join('_'));
                })
            });

            section['structure'] = newStructure;
        }


        // 1. Choose a random style from the first pb

        var firstProd   = section.associations[Object.keys(section.associations)[0]];
        var randomStyle = Math.floor(Math.random() * firstProd.length);
        var chosenStyle = firstProd[randomStyle].split('_')[0];

        // 2. Apply it to all pb

        // Set the zoom keys
        updateShuffleSectionPart('zoom_levels', chosenStyle);

        // Update the options
        updateShuffleSectionPart('options', chosenStyle);

        //Update associations
        updateShuffleSectionPart('associations', chosenStyle);

        // Update Structure
        updateShuffleStructure(chosenStyle);

        // Make sure first product is the association
        Object.keys(section.associations).forEach(function(key) {
            var size = key.split('_')[1];
            var origFirst = section.associations[key][0];
            var newFirst = [chosenStyle, size].join('_');
            var newFirstIndex = section.associations[key].indexOf(newFirst);
            section.associations[key][newFirstIndex] = origFirst;
            section.associations[key][0] = newFirst;
        });

        // Update the products
        for (var i = 0; i < section.products.length; i++) {
            var size = section.products[i].split('_')[1];
            section.products[i] = [chosenStyle, size].join('_');
        }

        return section;
    }

    function shuffleCalendar(section, productMap, widgetType) {
        // Assumption: All calendars have the same styles.

        var calendarStyles      = cache.get('calendars_map');
        var calIdByStyleIdCache = {};

        function findCalendarIdByStyleId(styleId, calendarSizeId) {
            var calFound,
                cacheKey = styleId + ':' + calendarSizeId;

            // if cached, return
            if (calIdByStyleIdCache.hasOwnProperty(cacheKey)) {
                return calIdByStyleIdCache[cacheKey];
            }

            Object.keys(calendarStyles).forEach(function(calId) {
                var calSizeId = calId.split('_')[2];
                if (calSizeId == calendarSizeId && calendarStyles[calId].styleInternalId == styleId) {
                    calFound = calId;
                }
            });

            calIdByStyleIdCache[cacheKey] = calFound;

            return calFound;
        }

        function updateShuffleSectionPart(sectionName, newStyleId) {
            var oldKeys = [];
            Object.keys(section[sectionName]).forEach(function(key) {
                var size = key.split('_')[2];
                var calId = findCalendarIdByStyleId(newStyleId, size).split('_');
                var newCalId = [[calId[0], calId[1]].join('_'), size].join('_');
                section[sectionName][newCalId] = section[sectionName][key];
                if (newCalId != key) {
                    oldKeys.push(key);
                }
            });

            oldKeys.forEach(function(key) {
                delete section[sectionName][key];
            });
        }

        // 1. Choose a random style from the first calendar

        var firstProd       = section.associations[Object.keys(section.associations)[0]];
        var randomStyle     = Math.floor(Math.random() * firstProd.length);
        var chosenStyle     = firstProd[randomStyle];
        var chosenStyleId   = calendarStyles[chosenStyle]['styleInternalId'];

        // 2. Apply same style to all calendars

        // Set the zoom keys
        updateShuffleSectionPart('zoom_levels', chosenStyleId);

        // Update the options
        updateShuffleSectionPart('options', chosenStyleId);

        //Update associations
        updateShuffleSectionPart('associations', chosenStyleId);

        // Make sure first product is the association
        Object.keys(section.associations).forEach(function(key) {
            var size = key.split('_')[2];
            var origFirst = section.associations[key][0];
            var calId = findCalendarIdByStyleId(chosenStyleId, size).split('_');
            var newFirst = [[calId[0], calId[1]].join('_'), size].join('_');
            var newFirstIndex = section.associations[key].indexOf(newFirst);
            section.associations[key][newFirstIndex] = origFirst;
            section.associations[key][0] = newFirst;
        });

        // Update the products
        for (var i = 0; i < section.products.length; i++) {
            var size = section.products[i].split('_')[2];
            var calId = findCalendarIdByStyleId(chosenStyleId, size).split('_');
            section.products[i] = [[calId[0], calId[1]].join('_'), size].join('_');
        }

        return section;
    }

    function getOverrideMode(options) {
        var overrideMode = null;
        if (options.hasOwnProperty('timeline') && options.timeline) {
            overrideMode = 'timeline';
        }
        return overrideMode;
    }

    function cacheGetOrInit(key) {
        var result = cache.get(key);
        return typeof result !== "undefined" ? result : {};
    }

    function addMinNumPhotosCountToRecipe(recipe) {
        recipe.product_map.forEach(function(prod) {
            var minPhotos = 1;
            if (prod.hasOwnProperty('layouts')) {
                minPhotos = _.min(_.map(prod.layouts, function (layout)
                {
                    return layout.numPhotos;
                }));
            }
            prod['minPhotos'] = minPhotos;
        });

        return recipe;
    }

    return {
        /*
        Will receive the config Json and parse it into the cache for later use.
        @cfgJson    - The config JSON
        @recipes    - The recipes
        @callback   - Will be called after parsing finished
         */
        parseConfigJson: function(cfgJson, callback) {
            cache.set('widget_position',                cfgJson.widget_positioning);
            cache.set('widget_types',                   cfgJson.widget_modes);
            cache.set('products_fallback',              cfgJson.product_fallback);
            cache.set('static_assets',                  cfgJson.static_assets);
            cache.set('calendars_map',                  cfgJson.calendars_map);

            if (typeof callback == 'function') {
                callback();
            }
        },

        getRecipeName: function(options, model) {
            var modeConfig      = this.getWidgetModeConfig(getOverrideMode(options));
            var recipeProdsName = this.getRecipeProdsNameByModeAndType(modeConfig.orientation, this.getWidgetProdType({"model": model}), cache.get('mode'));
            var recipeName = recipeProdsName.replace("_prods","");

            if (recipeName === "horizontal_flex_mysfly") {
                if (typeof window.MagicShop !== 'undefined' &&
                    window.MagicShop.abTestGroup ==='GroupB'
                )
                {
                    recipeName = "horizontal_flex_mysfly_oneline";
                }
            }
            return recipeName;
        },


        /**
         * Will receive the recipes, select the right one and parse it into the cache for later use.
         * @param recipes
         * @param options
         * @param model
         * @param callback
         */
        parseRecipes: function(recipes, options, model, callback) {
            var recipeName      = this.getRecipeName(options, model);
            var that            = this;

            // Create a Hashmap of all the products
            var products = {};
            var prints = {};
            var book = {};
            var calendar = {};
            var product_skus = {};
            var prodRealSkus = {};
            var prodIdToSku = {};
            var categoriesInfo = {};
            if(cache.get('mode') === "instance" || cache.get('mode').indexOf('gifting') > -1) {
                products        = cacheGetOrInit('products');
                prints          = cacheGetOrInit('prints');
                book            = cacheGetOrInit('book');
                calendar        = cacheGetOrInit('calendar');
                product_skus    = cacheGetOrInit('product_skus');
                prodRealSkus    = cacheGetOrInit('product_real_skus');
                prodIdToSku     = cacheGetOrInit('prod_id_to_sku');
                categoriesInfo  = cacheGetOrInit('categories_info');
            }

            // restoring skip recipe for cross_sell
            if(cache.get('mode') !== "cross_sell") {
                if (typeof recipes[recipeName] === "undefined" && recipes[recipeName] !== null) {
                    console.log('[Product Widget] Recipe not defined ('+recipeName+'). Aborting.');
                    return;
                }

                //var recipeObj = addMinNumPhotosCountToRecipe(recipes[recipeName]);

                this.parsePersonalizedRecipe(recipes[recipeName], model, function (recipeObj) {

                    recipeObj = addMinNumPhotosCountToRecipe(recipeObj);

                    var parsedProductMap = that.parseProductMap(recipeObj['product_map']);
                    products        = _.extend(products, parsedProductMap.products);
                    book            = _.extend(book, parsedProductMap.book);
                    prints          = _.extend(prints, parsedProductMap.prints);
                    calendar        = _.extend(calendar, parsedProductMap.calendar);
                    prodRealSkus    = _.extend(prodRealSkus, parsedProductMap.prodRealSkus);
                    prodIdToSku     = _.extend(prodIdToSku, parsedProductMap.prodIdToSku);

                    // Save the hashmaps
                    cache.set('products',           products);
                    cache.set('prints',             prints);
                    cache.set('book',               book);
                    cache.set('calendar',           calendar);
                    cache.set('product_skus',       product_skus);
                    cache.set('product_real_skus',  prodRealSkus);
                    cache.set('prod_id_to_sku',     prodIdToSku);
                    cache.set('loaded_products',    []);
                    cache.set('loaded_products_layout',    []);
                    cache.set('categories_info', _.extend(categoriesInfo, recipeObj['category-info']));

                    if (typeof callback == 'function') {
                        callback();
                    }
                });
            } else {
               // Save the hashmaps
               cache.set('products',           products);
               cache.set('prints',             prints);
               cache.set('book',               book);
               cache.set('calendar',           calendar);
               cache.set('product_skus',       product_skus);
               cache.set('product_real_skus',  prodRealSkus);
               cache.set('prod_id_to_sku',     prodIdToSku);
               cache.set('loaded_products',    []);
               cache.set('loaded_products_layout',    []);
               cache.set('categories_info',    categoriesInfo);

               if (typeof callback == 'function') {
                   callback();
               }
            }
        },

        shuffleRecipe: function (recipeName, recipeObj) {
            if (recipeName == 'horizontal_mysfly' || recipeName == 'horizontal_flex_mysfly' || recipeName == 'horizontal_flex_mysfly_oneline' ||recipeName == 'horizontal_homepage' || recipeName == 'store' || recipeName.indexOf("tl_") == 0 ) {
                if(recipeName != 'tl_horizontal_autostories' && recipeName != 'tl_horizontal_throwback' && recipeName != 'tl_horizontal_collage' && recipeName != 'tl_horizontal_gifs' && recipeName != 'tl_horizontal_movie' && recipeName != 'tl_horizontal_calendar' && recipeName != 'tl_horizontal_photobook'){
                    recipeObj[recipeName] = shuffleProducts(recipeObj[recipeName], recipeObj['product_map'], recipeName);
                } else if (recipeName == 'tl_horizontal_photobook') {
                    recipeObj[recipeName] = shuffleBook(recipeObj[recipeName], recipeObj['product_map'], recipeName);
                } else if (recipeName == 'tl_horizontal_calendar') {
                    // TODO: create a smart shuffle calendar until deskcalendar will use galleon
                    //recipeObj[recipeName] = shuffleCalendar(recipeObj[recipeName], recipeObj['product_map'], recipeName);
                }
            }
            return recipeObj;
        },

        parseProductMap: function(productMap) {
            var prodRealSkus = {},
                prodIdToSku = {},
                products = {},
                prints = {},
                book = {},
                calendar = {};

            function parseLayouts(product, print) {
                if (product.hasOwnProperty('layouts')) {
                    product.layouts.forEach(function(layout) {
                        product[layout.layoutId] = layout;
                    });
                }

                return product;
            }


            _.each(Object.keys(productMap), function (pos) {
                var key = '';
                var elem = productMap[pos];

                if (elem['type'] == 'photobook') {
                    key = elem['style'] + '_' + elem['size'];
                    book[key] = elem;
                } else if (elem['type'] == 'prints') {
                    key = 'prints_' + elem['size'];
                    prints[key] = elem;
                } else if (elem['type'] == 'calendar') {
                    key = 'cal_' + elem['styleId'] + '_' + elem['sizeId'];
                    calendar[elem.sku] = elem;
                } else if (elem['type'] == 'deskcalendar') {
                    key = elem['occasionId'] + '_' + elem['styleId'] + '_' + elem['sizeId'];
                    calendar[elem.sku] = elem;
                } else {
                    key = elem['occasionId'] + '_' + elem['styleId'] + '_' + elem['sizeId'];
                    products[elem.sku] = parseLayouts(elem);
                }

                prodRealSkus[elem['sku']] = key;
                prodIdToSku[key] = elem.sku;
            });


            return {
                "prodRealSkus": prodRealSkus,
                "prodIdToSku": prodIdToSku,
                "products": products,
                "prints": prints,
                "book": book,
                "calendar": calendar
            }
        },

        parseProductsFromServer: function(json, prodType) {
            var productsParsed = this.parseProductMap(json.product_map);

            cache.set('products',     _.extend(cache.get('products'), productsParsed.products));
            cache.set('prints',             _.extend(cache.get('prints'), productsParsed.prints));
            cache.set('book',               _.extend(cache.get('book'), productsParsed.book));
            cache.set('calendar',           _.extend(cache.get('calendar'), productsParsed.calendar));
            cache.set('product_real_skus',  _.extend(cache.get('product_real_skus'), productsParsed.prodRealSkus));
            cache.set('prod_id_to_sku',     _.extend(cache.get('prod_id_to_sku'), productsParsed.prodIdToSku));

            cache.set('loadedProd:' + prodType, '1');
        },

        isProductMapSaved: function(prodType) {
            return typeof cache.get('loadedProd:' + prodType) !== 'undefined';
        },

        /*
        Will parse the recipe JSON and save for later use in cache
        @recipe - the recipe JSON
        @callback - A callback to call after parsing is finished
         */
        parseRecipeJson: function(recipe, callback) {
            cache.set('recipe_layout', recipe.layout);
            cache.set('recipe_design', recipe.design);
            cache.set('product_sizes', recipe.sizes);
            cache.set('recipe_loaded', true);

            if (typeof callback == 'function') {
                callback();
            }
        },

        parsePersonalizedRecipe: function(recipe, model, callback){
            //skip personalization
            callback(recipe);

            /*if(cache.get('mode') != "mode2" || cache.get('prod_type') != 'mysfly'){
                callback(recipe);
                return;
            }

            var personalization = this.getPersonalization();
            var mg_product = false;
            var group = window.location.href.indexOf('version1')!= -1 ? 'PRE01' : ""; // get user group
            var numOfProducts = recipe.horizontal_mysfly.products.length;

            if (typeof personalization != 'undefined' && group == 'PRE01') {

                var converTable = this.getConversionTable();
                var fixedProducts = this.getFixProducts(recipe);

                //Sort the personalization json
                var sortPrediction = Object.keys(personalization.predictions).sort(function (a, b) {
                    return personalization.predictions[a] - personalization.predictions[b]
                });

                //Remove products with the same SKU/SIzeId
                sortPrediction =this.removeDuplicateSku(sortPrediction, converTable.PersonalizationProducts);


                //Find the relevant products to create the personalization recipe
                for (var skey = 0; skey < sortPrediction.length; skey ++) {
                    var personProduct = sortPrediction[skey];

                    //set ProductSwitch flag to false
                    var ProductSwitch = false;

                    //Check if the product exist in the Personalization file
                    if (typeof converTable.PersonalizationProducts[personProduct] === 'undefined')
                        continue;

                    var pSizeId = converTable.PersonalizationProducts[personProduct].sizeId;
                    var pType = converTable.PersonalizationProducts[personProduct].type;
                    var pSku = converTable.PersonalizationProducts[personProduct].mgSku;


                    //Check if the product is in the MG recipe
                    if (pType == "calendar") {
                        if ($.inArray(pSku, recipe.horizontal_mysfly.products) != -1) {
                            mg_product = true;
                        }
                    }
                    else {
                        for (var i = 0; i < recipe.product_map.length; i++) {
                            if ((typeof recipe.product_map[i].sizeId !== "undefined" && recipe.product_map[i].sizeId == pSizeId)) {
                                mg_product = true;
                                break;
                            }
                        }
                    }

                    //If the product is in the recipe, just switch him to the second place
                    if (mg_product) {

                        mg_product = false;


                            $.each(recipe.horizontal_mysfly.products, function (key, mgSku) {
                                $.each(recipe.product_map, function (pkey, recipeProduct) {
                                    if ((converTable.PersonalizationProducts[personProduct].type == recipeProduct.type) && (mgSku == recipeProduct.sku)) {
                                        var index = recipe.horizontal_mysfly.products.indexOf(mgSku);
                                        recipe.horizontal_mysfly.products.splice(index, 1);
                                        recipe.horizontal_mysfly.products.splice(1, 0, mgSku);
                                        ProductSwitch = true;
                                        return false;
                                    }
                                });
                            });

                                ////if product was switched break from the loop
                                //if (!ProductSwitch) {
                                //    //for shoppingBag case, where we have different sizeId for the same product
                                //    recipe  = that.addProduct(recipe, converTable,personProduct, pSku);
                                //    ProductSwitch = false;
                                //}


                    //The product is not in the MG, find if product exist in the convert table and insert it to the recipe
                    } else if ($.inArray(personProduct, Object.keys(converTable.PersonalizationProducts)) != -1) {
                        recipe = this.addProduct(recipe, converTable, personProduct, pSku);
                    }
                    //Product is not in the convert table and not in the recipe
                    else {
                        console.log("Product ", personProduct, " not supported")
                    }
                }

                //Bring back selected product to previous place
                $.each(fixedProducts, function (prod, location) {
                    var index = recipe.horizontal_mysfly.products.indexOf(prod);
                    if(index > location) {
                        recipe.horizontal_mysfly.products.splice(index, 1);
                        recipe.horizontal_mysfly.products.splice(location, 0, prod);
                    }

                });

                //remove all the tail product till we have only 16 in the recipe
                recipe = this.removeTailProducts(recipe);

            }



            this.getMonitorProducts(recipe, converTable,personalization, group, model);

            callback(recipe);*/

        },

        getFixProducts: function(recipe)
        {
            var fixedProducts = {};
            _.each(recipe.horizontal_mysfly.products, function(recipeProd, index){
                if(recipeProd.indexOf("_") !== -1){
                    fixedProducts[recipeProd] = index;
                }
            });
            return fixedProducts;
        },

        isproductExist: function (converTable, personProduct, sku)
        {
            var result = false;

            for (var i = 0 ; i < converTable.associations[sku].length ; i++) {
                result = false;
                converTable.product_map[personProduct].forEach( function (item) {
                    if(item.sku == converTable.associations[sku][i]){
                        result = true;
                    }
                });

                if(result) continue; else break;

            }
            return result;
        },

        addProduct: function(recipe, converTable, personProduct, sku)
        {
            //check if the product exist in product map
            if(this.isproductExist(converTable, personProduct, sku)) {
                //Add all the related product to the recipe
                _.each(converTable.product_map[personProduct], function (pushProduct) {
                    recipe.product_map.push(pushProduct);
                });

                //Add the new product in the second place of the MG
                recipe.horizontal_mysfly.products.splice(1, 0, sku);

                recipe.horizontal_mysfly.associations[sku] = converTable.associations[sku];
                recipe.horizontal_mysfly.options[sku] = converTable.options[sku];
                recipe.horizontal_mysfly.zoom_levels[sku] = 1;

                return recipe;

            } else {
                console.log('One product was missing in product map of ' + personProduct);
                return recipe;
            }
        },

        getType: function(recipe, product)
        {
            for (var i=0; i < recipe.product_map.length; i++) {
                if(product == recipe.product_map[i].sku) {
                    var type = recipe.product_map[i].type;
                    break;
                }
            }
            return type;
        },

        getMonitorProducts: function(recipe, converTable, personalization, group, model)
        {
            var monitor = new Monitor(model.get('prod_type'));
            var products = "";
            var type     = "";

            if (group === "")//if regular MG - No A/B testing
                return;

            //if(group === '') { //group is default - regulat MG
            //    monitor.eventStart('mgv3:personalize:' + group);
            //    monitor.eventEnd('mgv3:personalize:' + group);
            //    return;
            //}

            if (group == 'PRE01') {
                if(typeof personalization !== 'undefined'){ //The user gets the new products

                    for (var i = 1; i < 4; i ++ ) {
                        var product = recipe.horizontal_mysfly.products[i];
                        for (var j = 0; j < recipe.product_map.length; j++) {
                            if(product == recipe.product_map[j].sku) {
                                type    = recipe.product_map[j].type;
                                products    += type + "_" + product + ",";
                                break;
                            }
                        }
                    }

                    //for (var productName in personalization.predictions) {
                    //    //find the product sku from the cover-Table.
                    //    var productSku = false;
                    //    if(typeof converTable.PersonalizationProducts[productName] !== "undefined" && typeof converTable.PersonalizationProducts[productName].mgSku !== "undefined") {
                    //        productSku = converTable.PersonalizationProducts[productName].mgSku;
                    //    }
                    //
                    //    //if product exist in the convert table
                    //    if(productSku) {
                    //        for (var i=1; i < 4; i++) {
                    //            //if prouctSku exist in the recipe, add to monitor
                    //            if(recipe.horizontal_mysfly.products[i] == productSku) {
                    //                products += productName + ',';
                    //            }
                    //        }
                    //    }
                    //}

                    monitor.eventStart('mgv3:personalize:' + group + ":" + products);
                    monitor.eventEnd('mgv3:personalize:' + group + ":" + products);

                    //}

                } else { //The user is on the A/B testing, but have no file
                    monitor.eventStart('mgv3:personalize:' + group + 'noFile');
                    monitor.eventEnd('mgv3:personalize:' + group + 'noFile');
                }
            }




        },

        removeDuplicateSku: function(sortPrediction, cTableProducts) {
            var skuList = [];
            $.each(sortPrediction, function (skey, personProduct) {
                if( typeof  cTableProducts[personProduct] != 'undefined') {
                    if($.inArray(cTableProducts[personProduct].mgSku, skuList) != -1) {
                        var removeProduct = $.inArray(cTableProducts[personProduct].mgSku, skuList);
                        sortPrediction.splice(removeProduct, 1);
                        //return false;
                    } else {
                        skuList.push(cTableProducts[personProduct].mgSku);
                    }
                }
            });

            return sortPrediction;
        },

        secondsUntilMidnight: function () {
            var midnight = new Date();
            midnight.setHours( 24 );
            midnight.setMinutes( 0 );
            midnight.setSeconds( 0 );
            midnight.setMilliseconds( 0 );
            return ( midnight.getTime() - new Date().getTime() ) / 1000;
         },

        //Remove products from the end of the recipe, till it contains 16 products
        removeTailProducts: function(recipe)
        {

            recipe.horizontal_mysfly.products =   _.first( recipe.horizontal_mysfly.products, 16);

            return recipe;
        },

        /*
         Will add new entries to the recipe_layout
         */
        addToLayoutJson: function(pId, layout) {
            if (typeof layout !== 'undefined') {
                var layoutJson = cache.get('recipe_layout') || {};
                layoutJson[pId] = layout;
                cache.set('recipe_layout', layoutJson);
            }
        },
        /*
         Will add new entries to the recipe_design
         */
        addToDesignJson: function(pId, design) {
            if (typeof design !== 'undefined') {
                var designJson = cache.get('recipe_design') || {};
                designJson[pId] = design;
                cache.set('recipe_design', designJson);
            }
        },

        /*
         Will add / rewrite entries to the recipe_layout json
         */
        addToProductsJson: function(sku, recipe) {
            var key, prodId, pId;
            var productType = recipe.type;

            if (productType == "prints") {
                key = 'prints';
            } else if (productType == "photobook") {
                key = 'book'
            } else if (productType == "calendar" || productType == "deskcalendar") {
                key = 'calendar'
            } else {
                // product
                key = 'products';
            }

            if (recipe['type']        == 'photobook') {
                pId = recipe['style'] + '_' + recipe['size'];
            } else if (recipe['type'] == 'prints') {
                pId = 'prints_' + recipe['size'];
            } else if (recipe['type'] == 'calendar') {
                pId = 'cal_' + recipe['styleId']+'_'+recipe['sizeId'];
            } else {
                pId = recipe['occasionId']+'_'+recipe['styleId']+'_'+recipe['sizeId'];
            }

            prodId = sku;

            var jsonToUpdate = cache.get(key);

            // if is product use also layout id used in the begin
            if(key == 'products' && typeof jsonToUpdate[prodId] !== "undefined" && !recipe.hasOwnProperty('layoutId') && jsonToUpdate[prodId].hasOwnProperty('layoutId')){
                recipe['layoutId'] = jsonToUpdate[prodId]['layoutId'];
            }

            jsonToUpdate[prodId] = recipe;

            cache.set(key, utils.cloneObject(jsonToUpdate));

            var productSkus     = cache.get('product_skus');
            var productIds      = cache.get('prod_id_to_sku');

            productSkus[recipe['sflySku']] = prodId;
            if(typeof productIds[pId] !== 'undefined' && (recipe['sku'] != productIds[pId])) {

                if(!(productIds[pId] instanceof Array ))
                {
                    productIds[pId] = [productIds[pId] , recipe['sku']];
                }
                else if($.inArray(recipe['sku'], productIds[pId]) == -1)
                {
                    productIds[pId].push(recipe['sku']);
                }

            } else {
                productIds[pId] = recipe['sku'];
            }


            if (recipe['type'] == 'photobook' || recipe['type'] == 'book') {
                // Add all supported styles
                productIds[pId] = recipe['style'] + '_' + recipe['size'];
            }


            cache.set('product_skus', productSkus);
            cache.set('prod_id_to_sku', productIds);


            var realSkus = cache.get('product_real_skus');
            realSkus[sku] = prodId;
            cache.set('product_real_skus', realSkus);
        },
        /*
        Will parse the given prices JSON and save for later use
        @prices - the JSON received from the Prices API
        @skus - skus requested
         */
        parsePrices: function(prices, skus) {

            function getQuantity(type) {
                switch (type) {
                    case "card":
                        return 50;
                        break;
                    default:
                        return 1;
                }
            }
            var pricesMap = this.getPrices();
            if(typeof pricesMap === "undefined"){
                pricesMap = {};
            }
            _.each(prices, function(val) {
                var newPriceStruct = {};
                var isSingleProduct = val.sku.indexOf("PB") > -1 || val.sku.indexOf("SB") > -1 || val.sku.indexOf("CAL") > -1;
                var priceValue = isSingleProduct? val.price[1] : val.price[getQuantity(skus[val.skuRef].prodType)];
                newPriceStruct.originalPrice = priceValue.listUnitPrice;
                newPriceStruct.salePrice = typeof priceValue.saleUnitPrice !== 'undefined' ? priceValue.saleUnitPrice : -1;
                newPriceStruct.couponApplied = false;

                // If they're the same - this is not a sale
                if (newPriceStruct.originalPrice === newPriceStruct.salePrice) {
                    newPriceStruct.salePrice = -1;
                }
                var priceKey = isSingleProduct ? val.sku : val.epSku;
                pricesMap[priceKey] = newPriceStruct;
            });
            var multipleSkus = new Array();
            _.each(skus, function(sku, sflySku){
                if (sku === "photobook") {
                    multipleSkus.push(sflySku);
                }
            });

            if(multipleSkus.length > 0){
                _.each(multipleSkus, function(multipleSku) {
                    var multipleSkuExploded = multipleSku.split(",");
                    var skuPrice = {originalPrice: 0, salePrice: -1};
                    _.each(multipleSkuExploded, function (sku) {
                        if(pricesMap[sku].originalPrice !== -1) {
                            skuPrice.originalPrice += parseFloat(pricesMap[sku].originalPrice);
                        }
                        if(pricesMap[sku].salePrice !== -1) {
                            skuPrice.salePrice = skuPrice.salePrice ? skuPrice.salePrice : 0;
                            skuPrice.salePrice += parseFloat(pricesMap[sku].salePrice);
                        }
                    });
                    pricesMap[multipleSku] = skuPrice;
                });
            }

            function calculateCouponPrice(coupon, price, sku){
                var originalSalePrice = price.salePrice;
                coupon.discount.forEach(function(rule) {
                    var discount = rule.value / 100;
                    if(rule.hasOwnProperty("min") && price.originalPrice >= rule.min) {
                        if(coupon.overAll && originalSalePrice !== -1) {
                            price.salePrice = (originalSalePrice - originalSalePrice * discount);
                        } else {
                            price.salePrice = (price.originalPrice - price.originalPrice * discount);
                        }
                    } else if(rule.hasOwnProperty("sku") && sku.lastIndexOf(rule.sku, 0) === 0) {
                        price.salePrice = (price.originalPrice - price.originalPrice * discount);
                    }
                    if(coupon.overAll){
                        price.couponApplied = true;
                    }
                });
                return price;
            }

            var coupon = cache.getCoupon();
            if (typeof coupon !== "undefined" && Math.floor(Date.now() / 1000) < coupon.utcExpirationTime) {
                _.each(pricesMap, function (price, sku) {
                    if (!price.couponApplied) {
                        pricesMap[sku] = calculateCouponPrice(coupon, price, sku);
                    }
                });
            }

            cache.set('prices_loaded', true);
            this.savePrices(pricesMap);
        },
        /*
         If we have a broken prices API - we can use this to simulate the API
         */
        mockParsePrices: function(SKUs) {
            var skus = SKUs.split(',');
            var pricesMap = {};

            _.each(skus, function(sku) {
                var newPriceStruct = {};
                newPriceStruct.originalPrice = -1;
                newPriceStruct.salePrice = -1;
                pricesMap[sku] = newPriceStruct;
            });

            cache.set('prices_loaded', true);
            this.savePrices(pricesMap);
        },
        savePrices: function(prices) {
            cache.set('prices', prices);
        },
        getPrices: function() {
            return cache.get('prices');
        },
        getPrice: function(sku) {
            var prices = cache.get('prices');
            var price;

            if (typeof prices === 'undefined') {
                return {
                    originalPrice: -1,
                    salePrice: -1
                }
            }
            if (sku && sku.indexOf(",") > -1) {
                var productPrice = sku.split(",");
                var newPrice = {};
                newPrice.originalPrice = 0;
                newPrice.salePrice = 0;
                productPrice.forEach(function (pPriceSku) {
                    if (typeof prices[pPriceSku] !== "undefined") {
                        newPrice.originalPrice += prices[pPriceSku].originalPrice;
                        newPrice.salePrice = prices[pPriceSku].salePrice === -1 ? -1 : newPrice.salePrice + prices[pPriceSku].salePrice;
                    } else {
                        newPrice.originalPrice = -1;
                        newPrice.salePrice = -1;
                    }
                });
                price = newPrice;
            } else {
                price = prices[sku];
                if (typeof price === 'undefined') {
                    return {
                        originalPrice: -1,
                        salePrice: -1
                    }
                }
            }

            return price;
        },
        isPricesLoaded: function() {
            return (typeof cache.get('prices_loaded') !== 'undefined' && cache.get('prices_loaded'));
        },
        getRecipeProdsNameByModeAndType: function(orientation, type, mode) {
            if (mode != 'store') {
                return orientation + '_' + type + '_prods';
            } else {
                return 'store_prods';
            }
        },
        getProductsByModeAndType: function(orientation, type, mode) {
            if (mode !== 'store') {
                var recipe = this.getRecipe(orientation + '_' + type);
                return typeof recipe !== "undefined" ? recipe[orientation + '_' + type] : {};
            } else {
                return cache.get('store_prods', true);
            }
        },
        getProducts: function() {
            return cache.get('products');
        },
        getProductsByIds: function(productIds) {
            var products = this.getProducts();
            var returnProducts = [];
            _.each(products, function(product, key) {
                if (_.contains(productIds, key)) {
                    returnProducts.push(product);
                }
            });

            return returnProducts;
        },
        getProductsBySkus: function(skus) {
            var products = this.getProducts();
            var returnProducts = [];
            _.each(products, function(product, key) {
                if (_.contains(skus, key)) {
                    returnProducts.push(product);
                }
            });

            return returnProducts;
        },
        getPrints: function() {
            return cache.get('prints');
        },
        getPrintsByIds: function(printIds) {
            var prints = this.getPrints();
            var returnPrints = [];
            _.each(prints, function(print, key) {
                if (_.contains(printIds, key)) {
                    returnPrints.push(print);
                }
            });

            return returnPrints;
        },
        getBooks: function() {
            return cache.get('book');
        },
        getBooksByIds: function(bookIds) {
            var books = this.getBooks();
            var returnBooks = [];
            _.each(books, function(book, key) {
                if (_.contains(bookIds, key)) {
                    returnBooks.push(book);
                }
            });

            return returnBooks;
        },
        getCalendar: function() {
            return cache.get('calendar');
        },
        getCalendarsById: function(calIds) {
            var cals = this.getCalendar();
            var returnCals = [];
            _.each(cals, function(cal, key) {
                if (_.contains(calIds, key)) {
                    returnCals.push(cal);
                }
            });

            return returnCals;
        },
        getProductSkus: function() {
            return cache.get('product_skus');
        },
        getProductRealSkus: function() {
            return cache.get('product_real_skus');
        },
        getProductBySku: function(sku) {
            return this.getProducts()[sku] || this.getBooks()[sku] || this.getPrints()[sku] || this.getCalendar()[sku];
        },
        getProductIdBySku: function(sku) {
            return this.getProductRealSkus()[sku];
        },
        getRecipeLayout: function() {
            return cache.get('recipe_layout');
        },
        getRecipeDesign: function() {
            return cache.get('recipe_design');
        },
        getRecipeUrl: function() {
            return cache.get('recipe_url');
        },
        getProductSizes: function() {
            return utils.cloneObject(cache.get('product_sizes'));
        },
        /*
        Check if recipe JSON is loaded and ready for use
        @return boolean - true if ready, false if not ready yet
         */
        isRecipeLoaded: function() {
            var loaded = cache.get('recipe_loaded');
            return !!(typeof loaded != 'undefined' && loaded == true);
        },
        getWidgetPosition: function() {
            return cache.get('widget_position')
        },
        getWidgetModeConfig: function(overrideMode) {
            var modes       = cache.get('widget_types');
            var currMode    = cache.get('mode');

            if (typeof overrideMode !== 'undefined' && overrideMode != null) {
                currMode = overrideMode;
            }

            return modes[currMode];
        },
        getWidgetProdType: function(params) {
            if (typeof params !== 'undefined' && params.hasOwnProperty('overrideType')) {
                return params.overrideType;
            }

            function modelExists(params) {
                return typeof params !== 'undefined' && params.hasOwnProperty('model') && typeof params.model !== 'undefined'
            }

            return modelExists(params) && params.model.get('prod_type') !== null ? params.model.get('prod_type') : cache.get('prod_type');
        },
        isProductTypeSupport: function(prodType) {
            return supportWidgetTypes.indexOf(prodType) > -1;
        },
        saveLayoutMasks: function(mask) {
            var layoutMasks = cache.get('layoutmasks');
            if (typeof layoutMasks === 'undefined') {
                layoutMasks = {};
            }

            _.extend(layoutMasks, mask);
            cache.set('layoutmasks', layoutMasks);
        },
        getLayoutMasks: function() {
            return cache.get('layoutmasks');
        },
        getProductSkuById: function(id, returnArray) {
            returnArray = returnArray || false;
            var ids = cache.get('prod_id_to_sku')[id];
            if(returnArray) {
                return ids;
            }
            if(ids instanceof Array) {
                return ids[0];
            } else {
                return ids;
            }
        },
        // Will return a productId from a product json
        parseProductId: function(product) {
            if (product['type']        == 'photobook') {
                return product['style'] + '_' + product['size'];
            } else if (product['type'] == 'prints') {
                return 'prints_' + product['size'];
            } else if (product['type'] == 'calendar') {
                return 'cal_' + product['styleId']+'_'+product['sizeId'];
            } else {
                return product['occasionId']+'_'+product['styleId']+'_'+product['sizeId'];
            }
        },
        getProductFallbackMap: function() {
            return cache.get('products_fallback');
        },
        isProductLoaded: function(sku) {
            try {
                var loadedProducts = cache.get('loaded_products');
                return (loadedProducts.indexOf(sku) != -1);
            } catch (e) {
                return false;
            }
        },
        isProductAndLayoutLoaded: function(sku, layoutId) {
            try {
                var loadedProducts = cache.get('loaded_products_layout');
                var key = [sku, layoutId].join(':');
                return (loadedProducts.indexOf(key) != -1);
            } catch (e) {
                return false;
            }
        },
        markLoadedProduct: function(sku) {
            try {
                var loadedProducts = cache.get('loaded_products');
                loadedProducts.push(sku);
                cache.set('loaded_products', loadedProducts);
            } catch (e) {}
        },
        markLoadedProductWithLayout: function(sku, layoutId) {
            var loadedProducts = utils.cloneObject(cache.get('loaded_products'));
            if(typeof loadedProducts === "undefined" || loadedProducts === null) {
                loadedProducts = {};
            }
            var key = [sku, layoutId].join(':');
            loadedProducts.push(key);
            cache.set('loaded_products_layout', loadedProducts);
        },
        getStaticAsset: function(pId) {
            return cache.get('static_assets')[pId];
        },
        getStaticAssetLink: function(pId) {
            return cache.get('static_assets_links')[pId];
        },
        getRandomStaticAssetId: function() {
            var idsPool     = Object.keys(cache.get('static_assets'));
            var randIndex   = Math.floor(Math.random() * idsPool.length);
            return idsPool[randIndex];
        },
        saveMgSource: function(type, mgSource) {
            cache.set('mgsource:' + type, mgSource, true, 604800000); // A week in milliseconds
        },
        getMgSource: function(type) {
            return cache.get('mgsource:' + type, true);
        },
        isMgSourceFromCache: function(type) {
            cache.set('mgsource:' + type + 'fromcache', true);
        },
        wasMgSourceFromCache: function(type) {
            return cache.get('mgsource:' + type + 'fromcache');
        },
        // savePersonalization: function(json){
        //     return cache.set('mgPersonalization', json, true);
        // },
        // getPersonalization: function() {
        //     return cache.get('mgPersonalization', true);
        // },
        saveRecipe: function(recipeName,json){
            return cache.set('recipe-'+recipeName, json, true, 21600000); // 6 hours
        },
        getRecipe: function(recipeName) {
            return cache.get('recipe-'+recipeName, true);
        },
        // getConversionTable: function() {
        //     return cache.get('personalize_table', true);
        // },
        // setConversionTable: function() {
        //     return cache.set('personalize_table', personJson, true);
        // },

        // Will return a product for the requested slot
        getStoreProductAtSlot: function(slotId) {
            var store       = cache.get('store_prods', true);
            var storeProds  = cache.get('store_prods', true).products;
            var prodSku     = storeProds.length >= slotId ? storeProds[slotId] : null;

            if (prodSku != null) {
                return {
                    product: this.getProductBySku(prodSku),
                    associations: store.associations[prodSku]
                }
            }

            return null;
        },

        setAssetsVersion: function(version) {
            cache.set('asset_version', version);
        },

        getAssetsVersion: function() {
            return cache.get('asset_version');
        },

        getCategoryInfo: function(category) {
            try {
                return cache.get('categories_info')[category];
            } catch (e) {}
        }
    }
});
define('app/view_engine/widgets/widget', ['underscore', 'app/cache_module', 'app/config_manager'], function(_, cache, config) {
    function Widget(params) {
        this.viewEngine     = params.viewEngine;
        this.modalEngine    = params.modalView;
        this.params         = params;
        this.Model          = params.Model;
    }

    Widget.prototype = {
        init: function() {},

        render: function() {
            this.init();

            this.viewEngine.render(this.params);
        }
    };

    return Widget;
});
/*
 This code is taken "as is" from the MagicShop in Sfly.
 It is intended to help parse product / project JSONs.
 */
define("app/asset_mapper", ['app/config_manager'], function(config) {
    /*
     This file was taken AS-IS from the MagicShop project. Mistakes might be found here and should be correct via the MagicShop project.
     */

    function AssetCustomDesigns() {}
    AssetCustomDesigns.getCustomDesign = function(key) {
        var customDesigns = {
            '64_1211_261':'green',
            '64_1215_261': 'natural',

            // candle
            '65_149_266': 'green',
            '65_1381_266': 'red'
        };

        return (customDesigns[key] != 'undefined' ? customDesigns[key] : null);
    }

    function AssetById() {}
    AssetById.getAssetListById = function()
    {
        return '{'+
            //    '"1":    {"name":"BOOK_4X4",                 "type":"",          "size":"",          "subType":""}'+
            //    ',"2":    {"name":"BOOK_8X8",                 "type":"",          "size":"",          "subType":""}'+
            //    ',"3":    {"name":"BOOK_12X12",               "type":"",          "size":"",          "subType":""}'+
            //    ',"4":    {"name":"BOOK_8X11",                "type":"",          "size":"",          "subType":""}'+
            //    ',"5":    {"name":"BOOK_5X7",                 "type":"",          "size":"",          "subType":""}'+
            '"6":     {"name":"PHOTOCARD_4X8",            "type":"card",        "size":"4x8",       "subType":"flat",       "ori":1}'+
            ',"7":    {"name":"PHOTOCARD_5X7",            "type":"card",        "size":"5x7",       "subType":"flat",       "ori":1}'+
            //    ',"8":    {"name":"GREETINGCARD",             "type":"",          "size":"",          "subType":""}'+
            //    ',"9":    {"name":"CALENDAR",                 "type":"",          "size":"",          "subType":""}'+
            ',"10":   {"name":"LARGE_PRINT_8X10",         "type":"collage",     "size":"8x10",      "subType":"",       "ori":1}'+
            ',"11":   {"name":"LARGE_PRINT_11X14",        "type":"collage",          "size":"11x14",          "subType":"",       "ori":1}'+
            //    ',"12":   {"name":"LARGE_PRINT_16X20",        "type":"",          "size":"",          "subType":""}'+
            ',"13":   {"name":"LARGE_PRINT_20X30",        "type":"collage",          "size":"20x30",          "subType":"",       "ori":1}'+
            ',"14":   {"name":"SQUARE_PRINT_8X8",         "type":"collage",          "size":"8x8",          "subType":""}'+
            //    ',"15":   {"name":"SQUARE_PRINT_12X12",       "type":"",          "size":"",          "subType":""}'+
            //    ',"16":   {"name":"DESIGNERCARD_5X7",         "type":"",          "size":"",          "subType":""}'+
            //    ',"17":   {"name":"NOTEBOOK",                 "type":"",          "size":"",          "subType":""}'+
            //    ',"18":   {"name":"NOTEPAD",                  "type":"",          "size":"",          "subType":""}'+
            ',"19":   {"name":"STICKERS_2X2",                  "type":"stikers",          "size":"2x2",          "subType":""}'+
            //    ',"20":   {"name":"ADDRESSLABEL",             "type":"",          "size":"",          "subType":""}'+
            ',"21":   {"name":"ADDRESSLABEL",          "type":"addresslabel",          "size":"21",          "subType":"",     "ori":1}'+
            //    ',"22":   {"name":"CALLINGCARD_2x3_5",        "type":"",          "size":"",          "subType":""}'+
            ',"23":   {"name":"STATIONERYCARD_5x7",       "type":"card",      "size":"5x7",       "subType":"flat",       "ori":1}'+
            ',"24":   {"name":"STATIONERYCARD_A2",        "type":"card",          "size":"4x5",          "subType":"flat",       "ori":1}'+
            ',"25":   {"name":"NOTEPAD_5x7",              "type":"notepad",          "size":"5x7",          "subType":""}'+
            //    ',"26":   {"name":"GIFTTAG_2x3",              "type":"",          "size":"",          "subType":""}'+
            ',"27":   {"name":"STATIONERYCARD_FOLDED_5x7","type":"card",      "size":"5x7",       "subType":"folded",     "ori":1}'+
            //    ',"28":   {"name":"BOOK_5X7_NEW",             "type":"",          "size":"",          "subType":""}'+
            //    ',"29":   {"name":"BOOK_7X9",                 "type":"",          "size":"",          "subType":""}'+
            ',"30":   {"name":"STATIONERYCARD_FOLDED_3x5","type":"card",      "size":"3x5",       "subType":"folded",     "ori":1}'+
            ',"31":   {"name":"STATIONERYCARD_5x5",       "type":"card",      "size":"5x5",       "subType":"flat"}'+
            ',"32":   {"name":"CALENDARWALL",             "type":"calendar",   "size":"8x11",          "subType":"wall"}'+
            ',"33":   {"name":"CALENDARDESK",             "type":"deskcalendar",          "size":"5x11",          "subType":"desk"}'+
            ',"34":   {"name":"CANVASPRINT_10x14",        "type":"canvas",          "size":"10x14",          "subType":"",  "ori":1}'+
            ',"35":   {"name":"CANVASPRINT_12x12",        "type":"canvas",          "size":"12x12",          "subType":""}'+
            ',"36":   {"name":"CANVASPRINT_16x20",        "type":"canvas",      "size":"16x20",     "subType":"",           "ori":1}'+
            ',"37":   {"name":"CANVASPRINT_20x30",        "type":"canvas",          "size":"20x30",          "subType":"",  "ori":1}'+
            ',"38":   {"name":"CANVASPRINT_24x36",        "type":"canvas",          "size":"24x36",          "subType":"",  "ori":1}'+
            ',"39":   {"name":"WALLART_10x14",            "type":"wallart",     "size":"10x14",     "subType":"",           "ori":1}'+
            ',"40":   {"name":"WALLART_12x12",            "type":"wallart",          "size":"12x12",          "subType":""}'+
            ',"41":   {"name":"WALLART_16x20",            "type":"wallart",          "size":"16x20",          "subType":"", "ori":1}'+
            //    ',"42":   {"name":"WALLART_20x30",            "type":"",          "size":"",          "subType":""}'+
            //    ',"43":   {"name":"WALLART_24x36",            "type":"",          "size":"",          "subType":""}'+
            ',"44":   {"name":"PLAQUE_8x10_RECTENGLE_L",         "type":"plaque",          "size":"8x10",          "subType":"rectangle",  "ori":1}'+
            ',"45":   {"name":"DESKTOPPLAQ_5x7",          "type":"plaque",    "size":"5x7",       "subType":"",             "ori":1}'+
            ',"46":   {"name":"DESKTOPPLAQ_5x5",          "type":"plaque",          "size":"5x5",          "subType":""}'+
            ',"47":   {"name":"MUG_11oz_WHITE",           "type":"mug",       "size":"11",        "subType":"w"}'+
            //',"48":   {"name":"MUG_15oz_WHITE",           "type":"mug",       "size":"15",        "subType":"w"}'+
            //    ',"49":   {"name":"MUG_11oz_BLACK",           "type":"mug",       "size":"11",        "subType":"b"}'+
            ',"50":   {"name":"MOUSEPAD_7x9",             "type":"mouse",     "size":"7x9",       "subType":""}'+
            ',"51":   {"name":"CERAMICORNAMENT_CIRCLE",       "type":"ceramicor",    "size":"circle",          "subType":""}'+
            ',"52":   {"name":"ORNPEWTER",            "type":"pewteror",          "size":"rect",          "subType":"",   "ori":1}' +
            //    ',"53":   {"name":"",                         "type":"",          "size":"",          "subType":""}'+
            //    ',"54":   {"name":"",                         "type":"",          "size":"",          "subType":""}'+
            ',"55":   {"name":"ACRYLIC_WALL_10x14",       "type":"acrylicprint",          "size":"10x14",          "subType":"",       "ori":1}'+
            //    ',"56":   {"name":"ACRYLIC_WALL_12x12",       "type":"",          "size":"",          "subType":""}'+
            //    ',"57":   {"name":"ACRYLIC_WALL_16x20",       "type":"",          "size":"",          "subType":""}'+
            //    ',"58":   {"name":"ACRYLIC_WALL_20x30",       "type":"",          "size":"",          "subType":""}'+
            //    ',"59":   {"name":"ACRYLIC_WALL_24x36",       "type":"",          "size":"",          "subType":""}'+
            //    ',"60":   {"name":"ACRYLIC_DESK_5x5",         "type":"",          "size":"",          "subType":""}'+
            ',"61":   {"name":"ACRYLIC_DESK_5x7",         "type":"acrylicblock","size":"5x7",          "subType":"",       "ori":1}'+
            ',"62":   {"name":"BLNKT_FLEECE_50x60",         "type":"blanket",   "size":"50x60",          "subType":"",     "ori":1}'+
            //    ',"63":   {"name":"BLNKT_FLEECE_60x80",       "type":"",          "size":"",          "subType":""}'+
            ',"64":   {"name":"BLNKT_WOVEN_54x70",        "type":"woven",          "size":"54x70",          "subType":""}'+
            ',"65":   {"name":"BLNKT_WOVEN_60x80",        "type":"woven",          "size":"60x80",          "subType":""}'+
            //    ',"66":   {"name":"COMM_MUG_16oz",            "type":"travelmug",   "size":"16",          "subType":""}'+
            //    ',"67":   {"name":"COMM_MUG_20oz",            "type":"",          "size":"",          "subType":""}'+
            ',"68":   {"name":"SHOPPING_BAG_IV",             "type":"shoppingbag", "size":"",          "subType":"ivory"}'+
            ',"69":   {"name":"STATIONERYCARD_4x8",       "type":"card",      "size":"4x8",       "subType":"flat",       "ori":1}'+
            ',"70":   {"name":"IPHONECASE_3_CAP",         "type":"iphone",          "size":"3",          "subType":"2pc"}'+
            //    ',"71":   {"name":"IPHONECASE_4_CAP",         "type":"",          "size":"",          "subType":""}'+
            ',"72":   {"name":"IPHONECASE_4_DEF",         "type":"iphone",          "size":"4",          "subType":"1pc"}'+
            //    ',"73":   {"name":"WATERBTL_400ml",           "type":"",          "size":"",          "subType":""}'+
            ',"74":   {"name":"WATERBTL_600ml",           "type":"waterbottle", "size":"20",          "subType":""}'+
            //    ',"75":   {"name":"GRWTHCHART_14x42",         "type":"",          "size":"",          "subType":""}'+
            //    ',"76":   {"name":"GRWTHCHART_37x51",         "type":"",          "size":"",          "subType":""}'+
            ',"77":   {"name":"PLATE_10x10",              "type":"plate",       "size":"10x10",     "subType":""}'+
            ',"78":   {"name":"CUP_12oz",                 "type":"cup",         "size":"12",          "subType":""}'+
            //    ',"79":   {"name":"DIMENSIONAL_ART_21x21",    "type":"",          "size":"",          "subType":""}'+
            //    ',"80":   {"name":"DIMENSIONAL_ART_15x10",    "type":"",          "size":"",          "subType":""}'+
            //    ',"81":   {"name":"DIMENSIONAL_ART_26x23",    "type":"",          "size":"",          "subType":""}'+
            //    ',"82":   {"name":"DIMENSIONAL_ART_24x18",    "type":"",          "size":"",          "subType":""}'+
            //    ',"83":   {"name":"CUBE_DECOR_4X4",           "type":"",          "size":"",          "subType":""}'+
            //    ',"84":   {"name":"DECAL_DECOR_20x42",        "type":"",          "size":"",          "subType":""}'+
            //    ',"85":   {"name":"DECAL_DECOR_30x22",        "type":"",          "size":"",          "subType":""}'+
            //    ',"86":   {"name":"DECAL_DECOR_30x60",        "type":"",          "size":"",          "subType":""}'+
            //    ',"87":   {"name":"DECAL_DECOR_82x42",        "type":"",          "size":"",          "subType":""}'+
            //    ',"88":   {"name":"ORNACUBE_1x75",            "type":"",          "size":"",          "subType":""}'+
            ',"89":   {"name":"STATIONERYCARD_6x8",       "type":"card",      "size":"6x8",       "subType":"flat",       "ori":1}'+
            //    ',"90":   {"name":"IPHONECASE_5_CAP",         "type":"",          "size":"",          "subType":""}'+
            ',"91":   {"name":"IPHONECASE_5_DEF",         "type":"iphone",    "size":"5",         "subType":"1pc"}'+
            //    ',"92":   {"name":"EASEL",                    "type":"",          "size":"",          "subType":""}'+
            ',"93":   {"name":"COMM_MUG_SS_16OZ",         "type":"travelmug",          "size":"16",          "subType":"ss"}'+
            //    ',"94":   {"name":"HMK_WRD_LOVE",             "type":"",          "size":"",          "subType":""}'+
            //    ',"95":   {"name":"HMK_WRD_MOM",              "type":"",          "size":"",          "subType":""}'+
            //    ',"96":   {"name":"HMK_WRD_DAD",              "type":"",          "size":"",          "subType":""}'+
            //    ',"97":   {"name":"HMK_WRD_HOME",             "type":"",          "size":"",          "subType":""}'+
            //    ',"98":   {"name":"HMK_8X10_PT_8X10_BROWN",   "type":"",          "size":"",          "subType":""}'+
            //    ',"99":   {"name":"HMK_10X10_PT_10X10_BROWN", "type":"",          "size":"",          "subType":""}'+
            //    ',"100":  {"name":"HMK_FTREE_PT_9X12",        "type":"",          "size":"",          "subType":""}'+
            //    ',"101":  {"name":"HMK_FTREE_3D_9X9",         "type":"",          "size":"",          "subType":""}'+
            //    ',"102":  {"name":"HMK_5X7_PT_5X7_WHITE",     "type":"",          "size":"",          "subType":""}'+
            //    ',"103":  {"name":"HMK_8X10_PT_8X10_WHITE",   "type":"",          "size":"",          "subType":""}'+
            //    ',"104":  {"name":"HMK_10X10_PT_10X10_WHITE", "type":"",          "size":"",          "subType":""}'+
            ',"107":   {"name":"FRAMED_CANVAS_16x16",         "type":"framedcanvas",   "size":"16x16",          "subType":""}' +
            ',"115":   {"name":"NOTEBOOK_5X8",         "type":"notebook",   "size":"5x8",          "subType":""}' +
            ',"117":  {"name":"MAGNET_4X5.5",            "type":"magnet",      "size":"4x5.5",     "subType":"",       "ori":1}'+
            ',"118":  {"name":"MAGNET_3X5",              "type":"magnet",      "size":"3x5",     "subType":"",       "ori":1}'+
            ',"119":  {"name":"MAGNET_3X3",              "type":"magnet",      "size":"3x3",     "subType":""}'+
            ',"120":  {"name":"MAGNET_2X3",              "type":"magnet",      "size":"2x3",     "subType":"",       "ori":1}'+
            ',"121":  {"name":"PILLOW_16x16_IVORY",      "type":"pillow",      "size":"16x16",     "subType":"i"}'+
            ',"122":  {"name":"PILLOW_18x18_IVORY",      "type":"pillow",      "size":"18x18",     "subType":"i"}'+
            ',"125":   {"name":"CANVASPRINT_8x10",        "type":"canvas",          "size":"8x10",          "subType":"",  "ori":1}'+
            ',"126":   {"name":"WALLART_8x10",        "type":"wallart",          "size":"8x10",          "subType":"",  "ori":1}' +
            ',"128":  {"name":"PLAYING_CARDS",          "type":"playingcards",      "size":"52pc",     "subType":""}'+
            ',"129":  {"name":"PLACEMENT",          "type":"placement",      "size":"11x17",     "subType":""}' +
            ',"135":  {"name":"WOOD_WALLART",          "type":"wood_wallprint",      "size":"8x10",     "subType":"", "ori":1}'+
            ',"140":  {"name":"CURVED_GLASS_5x7",        "type":"curvedglass",      "size":"5x7",     "subType":""}'+
            ',"145":  {"name":"IPADCASE_RED",                "type":"ipad",        "size":"f",     "subType":"r"}'+
            ',"146":  {"name":"IPADCASE_BLACK",                "type":"ipad",        "size":"f",     "subType":"b"}'+
            ',"147":  {"name":"CUBEORNAMENT_2X2",                "type":"cubeor",        "size":"2x2",     "subType":""}'+
            ',"150":  {"name":"FRAMED_CANVAS_8x10_BLACK",      "type":"framedcanvas",        "size":"8x10",     "subType":"b",       "ori":1}'+
            ',"165":  {"name":"FRAMED_CANVAS_16x16",      "type":"framedcanvas",        "size":"16x16",     "subType":""}'+
            ',"182":   {"name":"METALORNAMENT_SQUARE",       "type":"metalor",    "size":"square",          "subType":""}'+
            ',"183":   {"name":"METALORNAMENT_RECT",       "type":"metalor",    "size":"rect",          "subType":""}'+
            ',"184":   {"name":"SHOPPING_BAG_WEAVE",             "type":"shoppingbag", "size":"",          "subType":"weave"}' +
            ',"185":   {"name":"SHOPPING_BAG_TRUEBLUE",             "type":"shoppingbag", "size":"",          "subType":"trueblue"}'+
            ',"186":   {"name":"SHOPPING_BAG_CHEV",             "type":"shoppingbag", "size":"",          "subType":"chevron"}'+
            ',"187":   {"name":"SHOPPING_BAG_MOS",             "type":"shoppingbag", "size":"",          "subType":"mosaic"}'+
            ',"191":   {"name":"SHOPPING_BAG_GEOCIRCLES",             "type":"shoppingbag", "size":"",          "subType":"geocircles"}'+
            ',"194":   {"name":"PUZZLE_252PC",             "type":"puzzle", "size":"252pc",          "subType":""}'+
            ',"195":   {"name":"CALENDARWALL",             "type":"calendar",   "size":"12x12",          "subType":"wall"}'+
            ',"199":   {"name":"QUILT_50X60_TAUPE",         "type":"quilt",     "size":"50x60",     "subType":"taupe"}'+
            ',"209":   {"name":"IPHONECASE_3_SLIM",         "type":"iphone",    "size":"3",         "subType":"slim"}'+
            ',"210":   {"name":"IPHONECASE_4_SLIM",         "type":"iphone",    "size":"4",         "subType":"slim"}'+
            ',"212":   {"name":"IPHONECASE_5_SLIM",         "type":"iphone",    "size":"5",         "subType":"slim"}'+
            ',"213":   {"name":"IPHONECASE_5_LINER",         "type":"iphone",   "size":"5",         "subType":"liner"}'+
            ',"214":   {"name":"IPHONECASE_6_SLIM",         "type":"iphone",    "size":"6",         "subType":"slim"}'+
            ',"215":   {"name":"IPHONECASE_6_LINER",         "type":"iphone",    "size":"6",         "subType":"liner"}'+
            ',"226":   {"name":"METAL_WALLART_8x10",         "type":"metalwallart",    "size":"8x10",         "subType":"",       "ori":1}'+
            ',"227":   {"name":"METAL_WALLART_10x14",         "type":"metalwallart",    "size":"10x14",         "subType":"",       "ori":1}'+
            ',"229":   {"name":"METAL_WALLART_12X12",         "type":"metalwallart",    "size":"12x12",         "subType":""}'+
            ',"231":   {"name":"METAL_WALLART_16X16",         "type":"metalwallart",    "size":"16x16",         "subType":""}'+
            ',"233":   {"name":"METAL_WALLART_20X30_P",         "type":"metalwallart",    "size":"20x30",         "subType":"p",       "ori":1}'+
            ',"235":   {"name":"LUGGAGE_TAG_SMALL",         "type":"luggagetag",    "size":"f",         "subType":"",       "ori":1}'+
            ',"236":   {"name":"LUGGAGE_TAG_LARGE",         "type":"luggagetag",    "size":"f",         "subType":"",       "ori":1}'+
            ',"237":  {"name":"PILLOW_12X16",      "type":"pillow",      "size":"12x16",     "subType":"i"}'+
            ',"238":  {"name":"PILLOW_18X24",      "type":"pillow",      "size":"18x24",     "subType":"i"}'+
            ',"239":   {"name":"GALAXYCASE_4_SLIM",         "type":"galaxy",    "size":"4",         "subType":"slim"}'+
            ',"243":   {"name":"FLAT_GLASS_PRINT",         "type":"flatglass",    "size":"5x7",         "subType":"",               "ori":1}'+
            ',"244":   {"name":"FLAT_GLASS_PRINT",         "type":"flatglass",    "size":"9x9",         "subType":""}'+
            ',"245":   {"name":"FLAT_GLASS_PRINT",         "type":"flatglass",    "size":"10x12",         "subType":"",               "ori":1}'+
            ',"246":   {"name":"FLAT_GLASS_PRINT",         "type":"flatglass",    "size":"8x10",         "subType":"",               "ori":1}'+
            ',"247":   {"name":"FLAT_GLASS_PRINT",         "type":"flatglass",    "size":"5x5",         "subType":""}'+
            ',"248":   {"name":"FLAT_GLASS_PRINT",         "type":"flatglass",    "size":"7x7",         "subType":""}'+
            ',"249":   {"name":"JOURNAL_6x8",         "type":"journal",    "size":"6x8",         "subType":""}'+
            ',"250":   {"name":"GARDENSTONE",         "type":"gardenstone",    "size":"11x18",         "subType":""}'+
            ',"251":   {"name":"GARDENSTONE",         "type":"gardenstone",    "size":"6x4",         "subType":""}'+
            ',"252":   {"name":"GARDENSTONE",         "type":"gardenstone",    "size":"9x9",         "subType":""}'+
            ',"255":   {"name":"NOTEBOOK_8X11",         "type":"notebook",   "size":"8x11",          "subType":""}' +
            ',"256":   {"name":"GLASS_MAGNET_3PC",         "type":"glassmagnet",    "size":"3pc",         "subType":""}'+
            ',"257":   {"name":"LUNCHBAG",         "type":"lunchbag",    "size":"10_7_4",         "subType":""}' +
            ',"258":   {"name":"POSTAGE",         "type":"postage",    "size":"49",         "subType":""}' +
            ',"261":   {"name":"STOCKINGS",                 "type":"stockings",    "size":"xmes",         "subType":""}'+
            ',"262":   {"name":"GLASSORNAMENT_SQUARE",         "type":"glassor",    "size":"square",         "subType":""}'+
            ',"263":   {"name":"GLASSORNAMENT_CIRCLE",         "type":"glassor",    "size":"circle",         "subType":""}'+
            ',"266":   {"name":"CANDLE_SMALL",                 "type":"candle",    "size":"small",         "subType":""}'+
            ',"267":   {"name":"GIFTWRAP_6FT",             "type":"giftwrap",    "size":"6ft",         "subType":""}'+
            ',"268":   {"name":"GIFTWRAP_6FT",             "type":"giftwrap",    "size":"10ft",         "subType":""}'+
            ',"269":   {"name":"PORTABLE_CHARGER",             "type":"portable",    "size":"charger",         "subType":""}'+
            ',"272":   {"name":"FRAMED_PRINT_8X10",             "type":"framedprint",    "size":"8x10",         "subType":"",     "ori":1}'+
            ',"273":   {"name":"FRAMED_PRINT_11X14",             "type":"framedprint",    "size":"11x14",         "subType":"",     "ori":1}'+
            ',"274":   {"name":"FRAMED_PRINT_12X12",             "type":"framedprint",    "size":"12x12",         "subType":""}'+
            ',"275":   {"name":"FRAMED_PRINT_16X16",             "type":"framedprint",    "size":"16x16",         "subType":""}'+
            ',"276":   {"name":"FRAMED_PRINT_16X20",             "type":"framedprint",    "size":"16x20",         "subType":"",     "ori":1}'+
            ',"277":   {"name":"FRAMED_PRINT_20X30",             "type":"framedprint",    "size":"20x30",         "subType":"",     "ori":1}'+
            ',"278":   {"name":"FRAMED_PRINT_24X36",             "type":"framedprint",    "size":"24x36",         "subType":"",     "ori":1}'+
            ',"279":   {"name":"FRAMED_PRINT_10X24",             "type":"framedprint",    "size":"10x24",         "subType":"",     "ori":1}'+
            ',"281":   {"name":"IPHONECASE_6PLUS_LINER",         "type":"iphone",    "size":"6plus",         "subType":"liner"}'+
            ',"284":   {"name":"PET_TAG",         "type":"pet-tag",    "size":"bone",         "subType":""}' +
            ',"287":   {"name":"PET_PLACEMENT",         "type":"pet-placement",    "size":"12x17",         "subType":""}' +
            ',"290":   {"name":"MAGNET_3X5",              "type":"magnet",      "size":"3x5",     "subType":"",       "ori":1}' +
            ',"295":   {"name":"SERVING_TRAY",              "type":"serving-tray",      "size":"17x13",     "subType":""}' +
            ',"297":  {"name":"PILLOW_16x16_IVORY",      "type":"pillow",      "size":"16x16",     "subType":"i"}'+
            ',"336":   {"name":"PERSONALIZE_FRAME",      "type":"personalizeframe",      "size":"8x10",     "subType":"p",       "ori":1}'+
            ',"359":   {"name":"GLASSPLATES",      "type":"glassplates",      "size":"6x6",     "subType":""}'+
            ',"360":   {"name":"GLASSPLATES",      "type":"glassplates",      "size":"4x10",     "subType":"",       "ori":1}'+
            ',"361":   {"name":"GLASSPLATES",      "type":"glassplates",      "size":"4x8",     "subType":"",       "ori":1}'+
            ',"402":   {"name":"RUBBERSTAMP",             "type":"rubberstamp",    "size":"custom",         "subType":""}'+
            ',"419":   {"name":"ARTPRINT_5x7",             "type":"artprint",    "size":"5x7",         "subType":"",     "ori":1}'+
            ',"421":   {"name":"ARTPRINT_8x10",             "type":"framedartprint",    "size":"8x10",         "subType":"",     "ori":1}'+
            ',"422":   {"name":"ARTPRINT_11x14",             "type":"framedartprint",    "size":"11x14",         "subType":"",     "ori":1}'+
            ',"423":   {"name":"ARTPRINT_12x12",             "type":"framedartprint",    "size":"12x12",         "subType":"",     "ori":1}'+
            ',"424":   {"name":"WINEGLASS",             "type":"wineglass",    "size":"15",         "subType":""}'+
            ',"425":   {"name":"MASON",                 "type":"mason",    "size":"16",         "subType":""}' +
            ',"426":   {"name":"METALORNAMENT_SNOW",             "type":"metalor",    "size":"snow",         "subType":"",     "ori":1}'+
            ',"431":   {"name":"COASTERS",             "type":"coaster",    "size":"4x4",         "subType":""}'+
            ',"442":   {"name":"CERAMIC_TILE",             "type":"ceramicTile",    "size":"square",         "subType":""}'+
            ',"445":   {"name":"DESKTOPPLAQ_8x10_BRACKET",          "type":"plaque",    "size":"8x10",       "subType":"bracket", "ori":1}'+
            ',"446":   {"name":"DESKTOPPLAQ_5x7_BRACKET",          "type":"plaque",    "size":"5x7",       "subType":"bracket", "ori":1}'+
            ',"447":   {"name":"DESKTOPPLAQ_5x5_BRACKET",          "type":"plaque",          "size":"5x5",          "subType":"bracket"}'+
            ',"448":   {"name":"DESKTOPPLAQ_8x10_TICKET",          "type":"plaque",    "size":"8x10",       "subType":"ticket", "ori":1}'+
            ',"449":   {"name":"DESKTOPPLAQ_5x7_TICKET",          "type":"plaque",    "size":"5x7",       "subType":"ticket", "ori":1}'+
            ',"450":   {"name":"DESKTOPPLAQ_5x5_TICKET",          "type":"plaque",          "size":"5x5",          "subType":"ticket"}'+
            ',"451":   {"name":"PLAQUE_OVAL",          "type":"plaque",          "size":"",          "subType":"oval"}'+
            ',"452":   {"name":"DESKTOPPLAQ_6x6_HEART",          "type":"plaque",          "size":"6x6",          "subType":"heart"}'+
            ',"454":   {"name":"DECANTER",          "type":"decanter",          "size":"43",          "subType":""}'+
            ',"456":   {"name":"GROWLER_BLACK",          "type":"growler",          "size":"",          "subType":"black"}'+
            ',"458":   {"name":"GROWLER_COPPER",          "type":"growler",          "size":"",          "subType":"copper"}'+
            ',"460":   {"name":"GROWLER_STAINLESS",          "type":"growler",          "size":"",          "subType":"stainless"}'+
            ',"462":   {"name":"PILSNER",             "type":"pilsner",    "size":"16",         "subType":""}' +
            ',"473":   {"name":"MOUSEPAD",             "type":"mouse",    "size":"",         "subType":"bracket"}' +
            ',"474":   {"name":"CUTTINGBOARD",             "type":"cuttingboard",    "size":"10x10",         "subType":""}' +
            ',"475":   {"name":"CUTTINGBOARD",             "type":"cuttingboard",    "size":"10x14",         "subType":""}' +
            ',"476":   {"name":"CUTTINGBOARD",             "type":"cuttingboard",    "size":"17x7",         "subType":""}' +
            ',"478":   {"name":"CANVASTOTEBAG",             "type":"canvastotebag",    "size":"",         "subType":"bucket"}' +
            ',"479":   {"name":"CANVASTOTEBAG",             "type":"canvastotebag",    "size":"",         "subType":"large"}' +
            ',"496":   {"name":"PAPERWEIGHT",             "type":"paperweight",    "size":"",         "subType":"dome"}' +
            ',"497":   {"name":"PAPERWEIGHT",             "type":"paperweight",    "size":"",         "subType":"square"}' +
            ',"498":   {"name":"PAPERWEIGHT",             "type":"paperweight",    "size":"",         "subType":"heart"}' +
            ',"502":   {"name":"CANVASPOUCH",             "type":"canvaspouch",    "size":"large",         "subType":""}' +
            ',"503":   {"name":"STATIONERYCARD_5x7",             "type":"card",    "size":"5x7",         "subType":"flat", "ori":1}' +
            ',"504":   {"name":"STATIONERYCARD_5x7",             "type":"card",    "size":"5x7",         "subType":"flat", "ori":1}' +
            ',"511":   {"name":"TRUMPET",             "type":"trumpet",    "size":"6",         "subType":""}' +
            ',"527":   {"name":"SHOPPING_BAG_CHEVRON_STRIPE",     "type":"shoppingbag", "size":"",          "subType":"chevronstripe"}'+
            ',"528":   {"name":"SHOPPING_WAVES",     "type":"shoppingbag", "size":"",          "subType":"waves"}'+
            ',"531":   {"name":"SHOPPING_BAG_HERRINGBONE",     "type":"shoppingbag", "size":"",          "subType":"herringbone"}'+
            ',"550":   {"name":"GARDENSTONE",     "type":"gardenstone", "size":"11x18",          "subType":""}'+
            ',"551":   {"name":"GARDENSTONE",     "type":"gardenstone", "size":"6x4",          "subType":""}'+
            ',"552":   {"name":"GARDENSTONE",     "type":"gardenstone", "size":"9x9",          "subType":""}'+
            ',"559":   {"name":"GLASSJAR_SMALL",     "type":"glassjar", "size":"small",          "subType":""}'+
            ',"561":   {"name":"GLASSJAR_LARGE",     "type":"glassjar", "size":"large",          "subType":""}'+
            ',"584":   {"name":"GALAXY_8_SLIM",     "type":"galaxy", "size":"8",          "subType":"slim"}'+
            ',"585":   {"name":"GALAXY_8_LINER",     "type":"galaxy", "size":"8",          "subType":"liner"}'+
            ',"586":   {"name":"GALAXY_8PLUS_SLIM",     "type":"galaxy", "size":"8plus",          "subType":"slim"}'+
            ',"587":   {"name":"GALAXY_8PLUS_LINER",     "type":"galaxy", "size":"8plus",          "subType":"liner"}'+
            ',"592":   {"name":"SANTA_SACK_MEDIUM",     "type":"santasack", "size":"medium",          "subType":""}'+
            ',"593":   {"name":"SANTA_SACK_LARGE",     "type":"santasack", "size":"large",          "subType":""}'+
            ',"597":   {"name":"GLASSOR_GLITTER",     "type":"glassor", "size":"glitter",          "subType":""}'+
            ',"598":   {"name":"KEYCHAIN",     "type":"keychain", "size":"",          "subType":"sq"}'+
            ',"599":   {"name":"KEYCHAIN",     "type":"keychain", "size":"",          "subType":"rec"}'+
            ',"601":   {"name":"IPHONE_8_SLIM",     "type":"iphone", "size":"8",          "subType":"slim"}'+
            ',"602":   {"name":"IPHONE_8_LINER",     "type":"iphone", "size":"8",          "subType":"liner"}'+
            ',"603":   {"name":"IPHONE_8PLUS_SLIM",     "type":"iphone", "size":"8plus",          "subType":"slim"}'+
            ',"604":   {"name":"IPHONE_8PLUS_LINER",     "type":"iphone", "size":"8plus",          "subType":"liner"}'+
            ',"609":   {"name":"IPHONE_X_LINER",     "type":"iphone", "size":"x",          "subType":"slim"}'+
            ',"610":   {"name":"IPHONE_X_LINER",     "type":"iphone", "size":"x",          "subType":"liner"}'+
            ',"613":   {"name":"TRIVET_6X6",     "type":"trivet",   "size":"6x6",           "subType":""}'+
            ',"614":   {"name":"BOTTLEOPENER",     "type":"bottleopener",   "size":"2x7",   "subType":"", "ori":1}'+
            ',"615":   {"name":"FOLDERFRONT",    "type":"folder",   "size":"",              "subType":"front"}'+
            ',"628":   {"name":"POT_HOLDER",    "type":"pot",   "size":"",              "subType":"holder"}'+
            ',"632":   {"name":"NAMEPLAQUE",     "type":"name",     "size":"",              "subType":"plaque"}'+
            ',"635":   {"name":"PENCILCASE",     "type":"pencil",   "size":"",              "subType":"case"}'+
            ',"642":   {"name":"TOWEL_30X60",    "type":"towel",    "size":"30x60",         "subType":"", "ori":1}' +
            ',"648":   {"name":"TRAVELMUG_",    "type":"travelmug",    "size":"",         "subType":"handle"}' +
            ',"649":   {"name":"HANGINGCANVAS",    "type":"hangingcanvas",    "size":"11x14",         "subType":"", "ori":1}' +
            ',"650":   {"name":"HANGINGCANVAS",    "type":"hangingcanvas",    "size":"16x20",         "subType":"", "ori":1}' +
            ',"654":   {"name":"CAN_COOLER",    "type":"can",    "size":"",         "subType":"cooler"}' +
            ',"658":   {"name":"LAPTOPCASE",    "type":"laptopcase",    "size":"13",   "subType":"" }' +
            ',"659":   {"name":"LAPTOPCASE",    "type":"laptopcase",    "size":"15",   "subType":"" }' +
            ',"661":   {"name":"NIGHTLIGHT",    "type":"night",    "size":"",   "subType":"light" }' +
            ',"672":   {"name":"DRAWSTRING_BACKPACK",    "type":"drawstring",    "size":"",   "subType":"backpack" }' +
            ',"678":   {"name":"CANVAS_EASEL",    "type":"canvas",    "size":"5x7",  "subType":"easel", "ori":1}' +
            ',"683":   {"name":"SHOPPING_BAG_BLUE_NEW",             "type":"shoppingbag", "size":"",          "subType":"trueblue_new"}'+
            ',"685":   {"name":"IPHONE_XR_SLIM",     "type":"iphone", "size":"xr",          "subType":"slim"}'+
            ',"686":   {"name":"IPHONE_XR_LINER",     "type":"iphone", "size":"xr",          "subType":"liner"}'+
            ',"687":   {"name":"IPHONE_XS_SLIM",     "type":"iphone", "size":"xs",          "subType":"slim"}'+
            ',"688":   {"name":"IPHONE_XS_LINER",     "type":"iphone", "size":"xs",          "subType":"liner"}'+
            ',"689":   {"name":"IPHONE_XSMAX_SLIM",     "type":"iphone", "size":"xsmax",          "subType":"slim"}'+
            ',"690":   {"name":"IPHONE_XSMAX_LINER",     "type":"iphone", "size":"xsmax",          "subType":"liner"}'+

            //Hack Day
            ',"MP-8x10-Easel":   {"name":"DESKTOPPLAQ_5x7",          "type":"plaque",    "size":"5x7",       "subType":"",             "ori":1}'+
            ',"5002":   {"name":"LARGE_PRINT_8X10",         "type":"collage",     "size":"8x10",      "subType":""}'+
            ',"5003":   {"name":"IPHONECASE_5_DEF",         "type":"iphone",    "size":"5",         "subType":"hack"}'+
            ',"5004":   {"name":"MUG_11oz_WHITE",           "type":"mug",       "size":"11",        "subType":"w"}'+
            '}';
    };



    var loadAssets = (function()
    {
        var assets = JSON.parse(AssetById.getAssetListById());
        return function(){
            return assets
        };
    })();


    function GetBookStructure(jsonData)
    {
        return jsonData.book.info.size;
    }

    function GetCalendarStructure(jsonData)
    {
        return jsonData.product.info.size;
    }

    function GetLayoutIdFromJSON(jsonData, surfaceType)
    {
        // default surface is front
        var surfaceType = surfaceType || 'front';

        if (typeof jsonData.product.surfaces != 'undefined')
        {
            var surfaces = jsonData.product.surfaces;
            for(var surfaceIndex in surfaces)
                if (surfaces.hasOwnProperty(surfaceIndex)) {
                    var surface = surfaces[surfaceIndex];
                    if (surface.type == surfaceType)
                        if (typeof surface.canvas.layout.layoutId != 'undefined')
                            return surface.canvas.layout.layoutId;
                }

        }
        return "";

    }

    return {
        GetProductStructure: function(sku, jsonData, withType)
        {
            /** @param withType is defaulted to 'false' */
            var withType = withType || false;
            var nameStructure = "";

            if (typeof jsonData.product.info.sizeId == 'undefined')
            {
                console.error("Error: no sizeId found in JSON");
                return nameStructure;
            }

            var sizeId = jsonData.product.info.sizeId;
            var assets = loadAssets();

            if (typeof assets[sizeId] != 'undefined')
                if (typeof assets[sizeId]["type"] != 'undefined' &&  assets[sizeId]["type"] != '')
                {
                    if (withType)
                        nameStructure += assets[sizeId].type + "_";

                    if (typeof assets[sizeId]["size"] != 'undefined' &&  assets[sizeId]["size"] != '')
                        nameStructure += assets[sizeId].size;

                    if (typeof assets[sizeId]["subType"] != 'undefined' &&  assets[sizeId]["subType"] != '')
                        if (typeof assets[sizeId]["size"] != 'undefined' &&  assets[sizeId]["size"] != '')
                            nameStructure += "_" + assets[sizeId].subType;
                        else
                            nameStructure += assets[sizeId].subType;

                    // if this product supports orientation:
                    if (typeof assets[sizeId]["ori"] != 'undefined' &&  assets[sizeId]["ori"] != '')
                    {
                        var orientation = "";
                        var layoutId = GetLayoutIdFromJSON(jsonData);
                        if (layoutId != "")
                        {
                            //get orientation from layout file
                            if((typeof config.getProducts()[sku][layoutId] !== 'undefined') && (typeof config.getProducts()[sku][layoutId].isLandscape !== 'undefined')) {
                                orientation = config.getProducts()[sku][layoutId].isLandscape ? 'l' : 'p';
                            } else {
                                var res = layoutId.split("_");
                                // special case:
                                if ((sizeId == 6 && res[0] != "6") || (sizeId == 7 && res[0] != "7"))
                                {
                                    orientation = res[0].slice(-1).toLowerCase(); // get last char
                                    nameStructure += "_" + orientation;
                                }
                                else // any other case
                                {
                                    orientation = res[1].toLowerCase();
                                    if(orientation !== 'l' && orientation !== "p") // Bad Logic to find orientation, try another one
                                    {
                                        orientation = (layoutId.toLowerCase().indexOf("_l_") !== -1)   ? "l" : "p";
                                    }

                                }
                            }
                            nameStructure += "_" + orientation;
                        }
                    }

                }

            var partnerId = this.GetPartnerId(jsonData);
            if (partnerId) {
                var customDesign = this.loadCustomDesigns(partnerId);
                if (customDesign)
                    nameStructure += (nameStructure == "" ? "" : "_") + customDesign;
            }

            return nameStructure;
        },
        GetProductTypeBySizeId : function(sizeId)
        {
            var assets = loadAssets();

            if (typeof assets[sizeId] != 'undefined')
            {
                if (typeof assets[sizeId]["type"] != 'undefined' &&  assets[sizeId]["type"] != '')
                    return assets[sizeId]["type"];
            }

            console.error("Error: Unknown Product Type (sizeId: " + sizeId +")");
            return null;
        },

        loadCustomDesigns: function(partnerId) {
            return AssetCustomDesigns.getCustomDesign(partnerId);
        },

        GetProductType : function(jsonData)
        {
            if (jsonData == undefined) {
                return null;
            }

            if (typeof jsonData["book"] !== 'undefined')
                return "book";
            else
            if (typeof jsonData["prints"] !== 'undefined')
                return "prints";
            else
            if (typeof jsonData["product"] !== 'undefined' && typeof jsonData.product.info.product !== "undefined" && jsonData.product.info.product == "MATISSE_CALENDAR")
                return "calendar";
            else
            if (typeof jsonData["product"] !== 'undefined')
                return this.GetProductTypeBySizeId(jsonData.product.info.sizeId);
            else
            {
                console.error("Error: Unknown Product Type! JSON:", jsonData);
                return null;
            }

        },

        GetBookStructure: function(jsonData) {
            return jsonData.book.info.size;
        },

        GetPrintsStructure: function(jsonData) {
            return jsonData.prints.info.size;
        },

        GetProductNameStructure : function(sku, jsonData, productType)
        {
            if (typeof jsonData === 'undefined' || jsonData == null) {
                return null;
            }

            if (productType == "book" ||  productType == "photobook")
                return GetBookStructure(jsonData);
            else if (productType == "calendar")
                return GetCalendarStructure(jsonData);
            else if (productType == "prints")
                return this.GetPrintsStructure(jsonData);
            else
                return this.GetProductStructure(sku, jsonData);
        },

        /**
         * @return {string}
         */
        GetPartnerId : function(jsonData, productType) {
            if (typeof jsonData !== 'undefined') {
                if (typeof jsonData['book'] !== 'undefined') {
                    var style = jsonData.book.info.style;
                    var size = jsonData.book.info.size;
                    return style + "_" + size;
                }
                else if (typeof jsonData['prints'] !== 'undefined') {
                    var size = jsonData.prints.info.size;
                    return "prints_" + size;
                }
                else if (productType == 'calendar') {
                    var style = jsonData.product.info.style;
                    var size= jsonData.product.info.size;
                    return  "cal_" + style + "_" + size;
                }
                else if (typeof jsonData['product'] !== 'undefined') {
                    var occasionId = jsonData.product.info.occasionId;
                    var styleId = jsonData.product.info.styleId;
                    var sizeId = jsonData.product.info.sizeId;
                    return occasionId + "_" + styleId + "_" + sizeId;
                }
            }

            return "";
        }
    }
});

/**
 * @license RequireJS text 2.0.12 Copyright (c) 2010-2014, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/requirejs/text for details
 */
/*jslint regexp: true */
/*global require, XMLHttpRequest, ActiveXObject,
  define, window, process, Packages,
  java, location, Components, FileUtils */

define('text',['module'], function (module) {
    'use strict';

    var text, fs, Cc, Ci, xpcIsWindows,
        progIds = ['Msxml2.XMLHTTP', 'Microsoft.XMLHTTP', 'Msxml2.XMLHTTP.4.0'],
        xmlRegExp = /^\s*<\?xml(\s)+version=[\'\"](\d)*.(\d)*[\'\"](\s)*\?>/im,
        bodyRegExp = /<body[^>]*>\s*([\s\S]+)\s*<\/body>/im,
        hasLocation = typeof location !== 'undefined' && location.href,
        defaultProtocol = hasLocation && location.protocol && location.protocol.replace(/\:/, ''),
        defaultHostName = hasLocation && location.hostname,
        defaultPort = hasLocation && (location.port || undefined),
        buildMap = {},
        masterConfig = (module.config && module.config()) || {};

    text = {
        version: '2.0.12',

        strip: function (content) {
            //Strips <?xml ...?> declarations so that external SVG and XML
            //documents can be added to a document without worry. Also, if the string
            //is an HTML document, only the part inside the body tag is returned.
            if (content) {
                content = content.replace(xmlRegExp, "");
                var matches = content.match(bodyRegExp);
                if (matches) {
                    content = matches[1];
                }
            } else {
                content = "";
            }
            return content;
        },

        jsEscape: function (content) {
            return content.replace(/(['\\])/g, '\\$1')
                .replace(/[\f]/g, "\\f")
                .replace(/[\b]/g, "\\b")
                .replace(/[\n]/g, "\\n")
                .replace(/[\t]/g, "\\t")
                .replace(/[\r]/g, "\\r")
                .replace(/[\u2028]/g, "\\u2028")
                .replace(/[\u2029]/g, "\\u2029");
        },

        createXhr: masterConfig.createXhr || function () {
            //Would love to dump the ActiveX crap in here. Need IE 6 to die first.
            var xhr, i, progId;
            if (typeof XMLHttpRequest !== "undefined") {
                return new XMLHttpRequest();
            } else if (typeof ActiveXObject !== "undefined") {
                for (i = 0; i < 3; i += 1) {
                    progId = progIds[i];
                    try {
                        xhr = new ActiveXObject(progId);
                    } catch (e) {}

                    if (xhr) {
                        progIds = [progId];  // so faster next time
                        break;
                    }
                }
            }

            return xhr;
        },

        /**
         * Parses a resource name into its component parts. Resource names
         * look like: module/name.ext!strip, where the !strip part is
         * optional.
         * @param {String} name the resource name
         * @returns {Object} with properties "moduleName", "ext" and "strip"
         * where strip is a boolean.
         */
        parseName: function (name) {
            var modName, ext, temp,
                strip = false,
                index = name.indexOf("."),
                isRelative = name.indexOf('./') === 0 ||
                             name.indexOf('../') === 0;

            if (index !== -1 && (!isRelative || index > 1)) {
                modName = name.substring(0, index);
                ext = name.substring(index + 1, name.length);
            } else {
                modName = name;
            }

            temp = ext || modName;
            index = temp.indexOf("!");
            if (index !== -1) {
                //Pull off the strip arg.
                strip = temp.substring(index + 1) === "strip";
                temp = temp.substring(0, index);
                if (ext) {
                    ext = temp;
                } else {
                    modName = temp;
                }
            }

            return {
                moduleName: modName,
                ext: ext,
                strip: strip
            };
        },

        xdRegExp: /^((\w+)\:)?\/\/([^\/\\]+)/,

        /**
         * Is an URL on another domain. Only works for browser use, returns
         * false in non-browser environments. Only used to know if an
         * optimized .js version of a text resource should be loaded
         * instead.
         * @param {String} url
         * @returns Boolean
         */
        useXhr: function (url, protocol, hostname, port) {
            var uProtocol, uHostName, uPort,
                match = text.xdRegExp.exec(url);
            if (!match) {
                return true;
            }
            uProtocol = match[2];
            uHostName = match[3];

            uHostName = uHostName.split(':');
            uPort = uHostName[1];
            uHostName = uHostName[0];

            return (!uProtocol || uProtocol === protocol) &&
                   (!uHostName || uHostName.toLowerCase() === hostname.toLowerCase()) &&
                   ((!uPort && !uHostName) || uPort === port);
        },

        finishLoad: function (name, strip, content, onLoad) {
            content = strip ? text.strip(content) : content;
            if (masterConfig.isBuild) {
                buildMap[name] = content;
            }
            onLoad(content);
        },

        load: function (name, req, onLoad, config) {
            //Name has format: some.module.filext!strip
            //The strip part is optional.
            //if strip is present, then that means only get the string contents
            //inside a body tag in an HTML string. For XML/SVG content it means
            //removing the <?xml ...?> declarations so the content can be inserted
            //into the current doc without problems.

            // Do not bother with the work if a build and text will
            // not be inlined.
            if (config && config.isBuild && !config.inlineText) {
                onLoad();
                return;
            }

            masterConfig.isBuild = config && config.isBuild;

            var parsed = text.parseName(name),
                nonStripName = parsed.moduleName +
                    (parsed.ext ? '.' + parsed.ext : ''),
                url = req.toUrl(nonStripName),
                useXhr = (masterConfig.useXhr) ||
                         text.useXhr;

            // Do not load if it is an empty: url
            if (url.indexOf('empty:') === 0) {
                onLoad();
                return;
            }

            //Load the text. Use XHR if possible and in a browser.
            if (!hasLocation || useXhr(url, defaultProtocol, defaultHostName, defaultPort)) {
                text.get(url, function (content) {
                    text.finishLoad(name, parsed.strip, content, onLoad);
                }, function (err) {
                    if (onLoad.error) {
                        onLoad.error(err);
                    }
                });
            } else {
                //Need to fetch the resource across domains. Assume
                //the resource has been optimized into a JS module. Fetch
                //by the module name + extension, but do not include the
                //!strip part to avoid file system issues.
                req([nonStripName], function (content) {
                    text.finishLoad(parsed.moduleName + '.' + parsed.ext,
                                    parsed.strip, content, onLoad);
                });
            }
        },

        write: function (pluginName, moduleName, write, config) {
            if (buildMap.hasOwnProperty(moduleName)) {
                var content = text.jsEscape(buildMap[moduleName]);
                write.asModule(pluginName + "!" + moduleName,
                               "define(function () { return '" +
                                   content +
                               "';});\n");
            }
        },

        writeFile: function (pluginName, moduleName, req, write, config) {
            var parsed = text.parseName(moduleName),
                extPart = parsed.ext ? '.' + parsed.ext : '',
                nonStripName = parsed.moduleName + extPart,
                //Use a '.js' file name so that it indicates it is a
                //script that can be loaded across domains.
                fileName = req.toUrl(parsed.moduleName + extPart) + '.js';

            //Leverage own load() method to load plugin value, but only
            //write out values that do not have the strip argument,
            //to avoid any potential issues with ! in file names.
            text.load(nonStripName, req, function (value) {
                //Use own write() method to construct full module value.
                //But need to create shell that translates writeFile's
                //write() to the right interface.
                var textWrite = function (contents) {
                    return write(fileName, contents);
                };
                textWrite.asModule = function (moduleName, contents) {
                    return write.asModule(moduleName, fileName, contents);
                };

                text.write(pluginName, nonStripName, textWrite, config);
            }, config);
        }
    };

    if (masterConfig.env === 'node' || (!masterConfig.env &&
            typeof process !== "undefined" &&
            process.versions &&
            !!process.versions.node &&
            !process.versions['node-webkit'])) {
        //Using special require.nodeRequire, something added by r.js.
        fs = require.nodeRequire('fs');

        text.get = function (url, callback, errback) {
            try {
                var file = fs.readFileSync(url, 'utf8');
                //Remove BOM (Byte Mark Order) from utf8 files if it is there.
                if (file.indexOf('\uFEFF') === 0) {
                    file = file.substring(1);
                }
                callback(file);
            } catch (e) {
                if (errback) {
                    errback(e);
                }
            }
        };
    } else if (masterConfig.env === 'xhr' || (!masterConfig.env &&
            text.createXhr())) {
        text.get = function (url, callback, errback, headers) {
            var xhr = text.createXhr(), header;
            xhr.open('GET', url, true);

            //Allow plugins direct access to xhr headers
            if (headers) {
                for (header in headers) {
                    if (headers.hasOwnProperty(header)) {
                        xhr.setRequestHeader(header.toLowerCase(), headers[header]);
                    }
                }
            }

            //Allow overrides specified in config
            if (masterConfig.onXhr) {
                masterConfig.onXhr(xhr, url);
            }

            xhr.onreadystatechange = function (evt) {
                var status, err;
                //Do not explicitly handle errors, those should be
                //visible via console output in the browser.
                if (xhr.readyState === 4) {
                    status = xhr.status || 0;
                    if (status > 399 && status < 600) {
                        //An http 4xx or 5xx error. Signal an error.
                        err = new Error(url + ' HTTP status: ' + status);
                        err.xhr = xhr;
                        if (errback) {
                            errback(err);
                        }
                    } else {
                        callback(xhr.responseText);
                    }

                    if (masterConfig.onXhrComplete) {
                        masterConfig.onXhrComplete(xhr, url);
                    }
                }
            };
            xhr.send(null);
        };
    } else if (masterConfig.env === 'rhino' || (!masterConfig.env &&
            typeof Packages !== 'undefined' && typeof java !== 'undefined')) {
        //Why Java, why is this so awkward?
        text.get = function (url, callback) {
            var stringBuffer, line,
                encoding = "utf-8",
                file = new java.io.File(url),
                lineSeparator = java.lang.System.getProperty("line.separator"),
                input = new java.io.BufferedReader(new java.io.InputStreamReader(new java.io.FileInputStream(file), encoding)),
                content = '';
            try {
                stringBuffer = new java.lang.StringBuffer();
                line = input.readLine();

                // Byte Order Mark (BOM) - The Unicode Standard, version 3.0, page 324
                // http://www.unicode.org/faq/utf_bom.html

                // Note that when we use utf-8, the BOM should appear as "EF BB BF", but it doesn't due to this bug in the JDK:
                // http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=4508058
                if (line && line.length() && line.charAt(0) === 0xfeff) {
                    // Eat the BOM, since we've already found the encoding on this file,
                    // and we plan to concatenating this buffer with others; the BOM should
                    // only appear at the top of a file.
                    line = line.substring(1);
                }

                if (line !== null) {
                    stringBuffer.append(line);
                }

                while ((line = input.readLine()) !== null) {
                    stringBuffer.append(lineSeparator);
                    stringBuffer.append(line);
                }
                //Make sure we return a JavaScript string and not a Java string.
                content = String(stringBuffer.toString()); //String
            } finally {
                input.close();
            }
            callback(content);
        };
    } else if (masterConfig.env === 'xpconnect' || (!masterConfig.env &&
            typeof Components !== 'undefined' && Components.classes &&
            Components.interfaces)) {
        //Avert your gaze!
        Cc = Components.classes;
        Ci = Components.interfaces;
        Components.utils['import']('resource://gre/modules/FileUtils.jsm');
        xpcIsWindows = ('@mozilla.org/windows-registry-key;1' in Cc);

        text.get = function (url, callback) {
            var inStream, convertStream, fileObj,
                readData = {};

            if (xpcIsWindows) {
                url = url.replace(/\//g, '\\');
            }

            fileObj = new FileUtils.File(url);

            //XPCOM, you so crazy
            try {
                inStream = Cc['@mozilla.org/network/file-input-stream;1']
                           .createInstance(Ci.nsIFileInputStream);
                inStream.init(fileObj, 1, 0, false);

                convertStream = Cc['@mozilla.org/intl/converter-input-stream;1']
                                .createInstance(Ci.nsIConverterInputStream);
                convertStream.init(inStream, "utf-8", inStream.available(),
                Ci.nsIConverterInputStream.DEFAULT_REPLACEMENT_CHARACTER);

                convertStream.readString(inStream.available(), readData);
                convertStream.close();
                inStream.close();
                callback(readData.value);
            } catch (e) {
                throw new Error((fileObj && fileObj.path || '') + ': ' + e);
            }
        };
    }
    return text;
});


define('text!app/templates/listview/listview_container.html',[],function () { return '<div class="sfly_wgt_listview_container sfly_wgt_listview sfly_wgt">\n    <!--<div class="sfly_wgt_loading sfly_wgt_throbber"></div>-->\n    <div class="sfly_wgt_loading sfly_wgt_starting_side">\n        <div class="sfly_wgt_item_placeholder p_<%= typeof products[0] !== \'undefined\' ? products[0] : \'\' %>">\n            <span class="sfly_wgt_item_placeholder_prod"></span>\n            <span class="sfly_wgt_item_placeholder_line"></span>\n            <span class="sfly_wgt_item_placeholder_line"></span>\n        </div>\n        <div class="sfly_wgt_item_placeholder p_<%= typeof products[1] !== \'undefined\' ? products[1] : \'\' %>">\n            <span class="sfly_wgt_item_placeholder_prod"></span>\n            <span class="sfly_wgt_item_placeholder_line"></span>\n            <span class="sfly_wgt_item_placeholder_line"></span>\n        </div>\n        <div class="sfly_wgt_item_placeholder p_<%= typeof products[2] !== \'undefined\' ? products[2] : \'\' %>">\n            <span class="sfly_wgt_item_placeholder_prod"></span>\n            <span class="sfly_wgt_item_placeholder_line"></span>\n            <span class="sfly_wgt_item_placeholder_line"></span>\n        </div>\n    </div>\n</div>';});


define('text!app/templates/listview/listview_container_horiz.html',[],function () { return '<div class="sfly_wgt_listview_container sfly_wgt_listview sfly_wgt <%= typeof useNewStyleGuide !== \'undefined\' && useNewStyleGuide ? \'use-new-style-guide\' : \'\' %>">\n    <!--<div class="sfly_wgt_loading sfly_wgt_throbber"></div>-->\n    <div class="sfly_wgt_loading sfly_wgt_starting_side">\n        <div class="sfly_wgt_item_placeholder sfly_wgt_item_placeholder_horiz p_<%= typeof products[0] !== \'undefined\' ? products[0] : \'\' %>">\n            <span class="sfly_wgt_item_placeholder_prod"></span>\n            <span class="sfly_wgt_item_placeholder_line"></span>\n            <span class="sfly_wgt_item_placeholder_line"></span>\n        </div>\n        <div class="sfly_wgt_item_placeholder sfly_wgt_item_placeholder_horiz p_<%= typeof products[1] !== \'undefined\' ? products[1] : \'\' %>">\n            <span class="sfly_wgt_item_placeholder_prod"></span>\n            <span class="sfly_wgt_item_placeholder_line"></span>\n            <span class="sfly_wgt_item_placeholder_line"></span>\n        </div>\n        <div class="sfly_wgt_item_placeholder sfly_wgt_item_placeholder_horiz p_<%= typeof products[2] !== \'undefined\' ? products[2] : \'\' %>">\n            <span class="sfly_wgt_item_placeholder_prod"></span>\n            <span class="sfly_wgt_item_placeholder_line"></span>\n            <span class="sfly_wgt_item_placeholder_line"></span>\n        </div>\n        <div class="sfly_wgt_item_placeholder sfly_wgt_item_placeholder_horiz p_<%= typeof products[3] !== \'undefined\' ? products[3] : \'\' %>">\n            <span class="sfly_wgt_item_placeholder_prod"></span>\n            <span class="sfly_wgt_item_placeholder_line"></span>\n            <span class="sfly_wgt_item_placeholder_line"></span>\n        </div>\n    </div>\n</div>';});


define('text!app/templates/listview/listview_container_tlVertic.html',[],function () { return '<div class="sfly_wgt_listview_container sfly_wgt_listview sfly_wgt sfly_wgt_tlVert" data-prodtype="<%= prodType %>">\n\t<div class="sfly_wgt_restriction">\n\t\t<div class="sfly_wgt_popup">\n\t\t\t<div class="sfly_wgt_bubble_warning"></div>\n\t\t\t<div class="sfly_wgt_bubble_text">Not enough photos to personalize products. Please select at least <span class="count">20</span> photos.</div>\n\t\t</div>\n\t</div>\n    <div class="sfly_wgt_listview_embedded_title">\n    \t<div class="sfly_wgt_special_offers">\n    \t</div>\n\t</div>\n\t<div class="sfly_wgt_loading sfly_wgt_throbber"></div>\n</div>';});


define('text!app/templates/listview/listview_container_gifting.html',[],function () { return '<div class="sfly_wgt_listview_container sfly_wgt_listview sfly_wgt sfly_wgt_gifting">\n    <div class="sfly_wgt_loading sfly_wgt_throbber"></div>\n</div>';});


define('text!app/templates/fullview/fullview_product.html',[],function () { return '<div class="sfly_wgt_product" data-pid="<%= pid %>" data-sku="<%= sku %>" data-ptype="<%= ptype %>">\n    <div class="sfly_wgt_product_inner"></div>\n</div>';});


define('text!app/templates/fullview/fullview_product_price.html',[],function () { return '<li class="sfly_wgt_product" data-pid="<%= pid %>" data-sku="<%= sku %>" data-ptype="<%= ptype %>">\n    <div class="sfly_wgt_product_inner"></div>\n    <div class="sfly_wgt_product_inner_action">\n        <div class="sfly_wgt_product_price">\n            <strong><%= title %></strong>\n            <% if (price != null && price.originalPrice > 0) { %>\n                <div class="sfly_wgt_product_price_inner">\n                    <% if (price.salePrice > 0) { %>\n                    <span class="price-old">$<%= parseFloat(price.originalPrice).toFixed(2) %></span>\n                    &nbsp;\n                    <span class="price-sale">$<%= parseFloat(price.salePrice).toFixed(2) %></span>\n                    <% } else { %>\n                    <span class="price-wrapper">$<%= parseFloat(price.originalPrice).toFixed(2) %></span>\n                    <% } %>\n                </div>\n            <% } %>\n        </div>\n        <% if (!(isMobile != null && isMobile)) { %>\n            <div id="sfly_wgt_product_buttons">\n                <div class="sfly-wgt-orange-btn-sfly">Personalize</div>\n            </div>\n        <% } %>\n    </div>\n</li>';});


define('text!app/templates/fullview/no_photos.html',[],function () { return '<div class="sfly_wgt_product" data-pid="<%= pid %>" data-sku="<%= sku %>" data-ptype="<%= ptype %>">\n    <div class="sfly_wgt_product_inner_no_photos"></div>\n</div>';});


define('text!app/templates/fullview/fullview_prod_hover.html',[],function () { return '<div class="sfly_wgt_product_hover">\n    <span class="sfly_wgt_search"></span> Quick look\n</div>';});


define('text!app/templates/fullview/fullview_prod_hover_tl.html',[],function () { return '<%\n    var title = "See more styles";\n    if (clickthroughNoModal) {\n        title = \'Personalize\';\n        if (productType == \'prints\') { title = \'Order prints\' }\n        if (productType == \'photobook\' || productType == \'book\') { title = \'Create photo book\' }\n    } else {\n        if (productType == \'prints\') { title = \'Order prints\' }\n    }\n    if(typeof forcedTitleText !== \'undefined\') {\n    \ttitle = forcedTitleText;\n    }\n%>\n<div class="sfly_wgt_product_hover sfly_wgt_product_hover_tl">\n    <span class="sfly_wgt_search"></span> <%= title %>\n</div>';});


define('text!app/templates/listview/listview_product_price.html',[],function () { return '<div class="sfly_wgt_product_price">\n\t<% if(typeof title !== \'undefined\') { %>\n    <!--<h5><%= title %> ></h5>-->\n    <h5><%= title %></h5>\n    <% } %>\n    <%= price_template({price: price}) %>\n    <% if(typeof coupon !== \'undefined\' && coupon != false) { %>\n        <div class="sfly_wgt_product_price_coupon">Code: <%= coupon %></div>\n    <% } %>\n</div>';});


define('text!app/templates/listview/listview_product_title.html',[],function () { return '<div class="sfly_wgt_product_title">\n    <h5><%= title %></h5>\n</div>';});


define('text!app/templates/listview/listview_product_price_inner.html',[],function () { return '<% if (price != null && price.salePrice > -1) { %>\n    <span class="price-wrapper"><span class="price-old">$<%= parseFloat(price.originalPrice).toFixed(2) %></span> <span class="price-sale">$<%= parseFloat(price.salePrice).toFixed(2) %><span class="price-sale-save"> Save <%= Math.round((1-price.salePrice/price.originalPrice)*100) %>%</span></span></span>\n<% } else if (price != null && price.originalPrice > 0) { %>\n    <span class="price-wrapper">from $<%= parseFloat(price.originalPrice).toFixed(2) %></span>\n<% } else { %>\n    <span class="price-wrapper"></span>\n<% } %>';});


define('text!app/templates/listview/listview_spread_nav.html',[],function () { return '<div class="sfly_wgt_<%= typeOfView %>_paging_wrapper">\n    <% for(i = 0; i < numOfSpreads; i++) { %>\n    <div class="sfly_wgt_<%= typeOfView %>_paging_elem sfly_wgt_<%= typeOfView %>_page_<%= i%>" data-page="<%=i%>"></div>\n    <% } %>\n</div>';});


define('text!app/templates/fullview/fullview_calendar_nav.html',[],function () { return '<% var months = ["Cover", "Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec", "Jan", "Feb", "Mar", "Apr", "May", "Jun"] %>\n\n<ul class="sfly-wgt-cal-nav">\n    <% for(var i = 0; i < numOfMonths; i++) { %>\n        <% if (i == numOfMonths-1 && i != currMonth) { %>\n        <li class="sfly-wgt-month_<%=i%>"><div class="last"></div><span><%= months[i] %></span></li>\n        <% } else if (i == numOfMonths-1 && i == currMonth) { %>\n        <li class="sfly-wgt-month_<%=i%> wgt-nav-selected"><div class="last"></div><span><%= months[i] %></span></li>\n        <% } else if (i == currMonth) { %>\n        <li class="sfly-wgt-month_<%=i%> wgt-nav-selected"><div></div><span><%= months[i] %></span></li>\n        <% } else { %>\n        <li class="sfly-wgt-month_<%=i%>"><div></div><span><%= months[i] %></span></li>\n        <% } %>\n    <% } %>\n</ul>';});


define('text!app/templates/fullview/fullview_calendar_nav_horiz.html',[],function () { return '<% var months = ["Cover", "Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec", "Jan", "Feb", "Mar", "Apr", "May", "Jun"] %>\n\n<ul class="sfly-wgt-cal-nav-horiz">\n    <% for(var i = 0; i < numOfMonths; i++) { %>\n        <% if (i == numOfMonths-1 && i != currMonth) { %>\n        <li class="sfly-wgt-month_<%=i%>"><span><%= months[i] %></span><div class="last"></div></li>\n        <% } else if (i == numOfMonths-1 && i == currMonth) { %>\n        <li class="sfly-wgt-month_<%=i%> wgt-nav-selected"><span><%= months[i] %></span><div class="last"></div></li>\n        <% } else if (i == currMonth) { %>\n        <li class="sfly-wgt-month_<%=i%> wgt-nav-selected"><span><%= months[i] %></span><div></div></li>\n        <% } else { %>\n        <li class="sfly-wgt-month_<%=i%>"><span><%= months[i] %></span><div></div></li>\n        <% } %>\n    <% } %>\n</ul>';});


define('text!app/templates/fullview/fullview_book_nav.html',[],function () { return '<ul class="sfly-wgt-book-nav">\n    <% for(var i = 0; i < pages; i++) { %>\n    <% if (i == pages-1 && type == "book") { %>\n    <li class="sfly-wgt-page_99 <%= currPage==99?\'wgt-nav-selected\':\'\' %>"><div class="last"></div></li>\n    <% } else if (i == pages-1) { %>\n    <li class="sfly-wgt-page_<%=i%>"><div class="last"></div></li>\n    <% } else if ((i == 0 && currPage == -1) || (currPage == i)) { %>\n    <li class="sfly-wgt-page_<%=i%> wgt-nav-selected"><div></div></li>\n    <% } else { %>\n    <li class="sfly-wgt-page_<%=i%>"><div></div></li>\n    <% } %>\n    <% } %>\n</ul>';});


define('text!app/templates/fullview/fullview_prod_price_nav.html',[],function () { return '<div class="sfly_wgt_product_price_nav">\n    <h5>\n        <% if (!noPages) { %>\n            <% if (ptype == \'prints\') { %>\n                <%=pages%> photos,\n            <% } else { %>\n                <%=pages%> pages,\n            <% } %>\n        <% } %>\n        <%= title %>\n    </h5>\n\n    <% if (price.salePrice > -1) { %>\n    <span class="price-wrapper">from <span class="price-old">$<%= parseFloat(price.originalPrice).toFixed(2) %></span> <span class="price-sale">$<%= parseFloat(price.salePrice).toFixed(2) %> Save <%= Math.round((1-price.salePrice/price.originalPrice)*100) %>%</span></span>\n    <% } else { %>\n    <span class="price-wrapper">from $<%= parseFloat(price.originalPrice).toFixed(2) %></span>\n    <% } %>\n</div>';});


define('text!app/templates/sidemodule/sidemodule_product_price.html',[],function () { return '<div class="sfly_wgt_product" data-pid="<%= pid %>" data-sku="<%= sku %>" data-ptype="<%= ptype %>">\n    <div class="sfly_wgt_product_inner"></div>\n    <div class="sfly_wgt_product_inner_action">\n        <div class="sfly_wgt_product_price">\n            <strong><%= title %></strong>\n        </div>\n        <div id="sfly_wgt_product_buttons">\n            <div class="sfly-wgt-orange-btn-sfly">Personalize</div>\n        </div>\n    </div>\n</div>';});


define('text!app/templates/misc/transfer_modal.html',[],function () { return '<div class="sfly_wgt_modal_wrapper">\n    <div class="sfly_wgt_transfer">\n        <img class="sfly_wgt_transfer_spinner" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACYAAAAmCAMAAACf4xmcAAABy1BMVEXWWwDbXQDiYADdXgDcXQDnYgDiYADjYADYWwDmYQDgXwDWWwDiYADlYQDWWwDaXADYWwDcXQDkYQDjYADaXADcXQDlYQDkYQDhXwDeXgDbXQDZXADfXgDWWwDWWwDaXADWWwDWWwDbXQDZXADgXwDiYADeXgDeXgDbXQDdXgDWWwDgXwDgXwDhXwDWWwDfXgDWWwDgXwDXWwDcXQDWWwDfXgDWWwDaXADWWwDcXQDYWwDWWwDcXQDlYQDcXQDXWwDnYgDeXgDYWwDcXQDWWwDbXQDWWwDZXADiYADiYADWWwDcXQDWWwDWWwDWWwDaXADWWwDXWwDWWwDWWwDWWwDYWwDYWwDaXADWWwDWWwDWWwDWWwDWWwDWWwDXWwDhXwDgXwDXWwDYWwDWWwDWWwDWWwDlYQDWWwDWWwDWWwDhXwDbXQDkYQDWWwDWWwDWWwDWWwDWWwDWWwDWWwDWWwDWWwDWWwDWWwDWWwAAAADjYADlYQD7agDYWwDaXADgXwDkYQDiYAD8awDvZQD9awDnYgD6agDmYQDsZADpYwDzZwDtZADoYgDxZgDyZgDwZgDrZADuZQD1aADqYwD0ZwD2aAD3aQD5aQD4aQB0bo3hAAAAenRSTlM/yefe0vzq+YT83pP2+XK6n7T86pOu8/b8up+x5Jyf4a7hzMzq/MzGwLds8PP5b+eE25PMYNJI9pD2olrD0irM0tUPDxIkzOrw7cb8w13wnBuZJAyHqHi0CYEDORXkePDt5/ZOIVf2Y1RL8/b5DxgtNkI8J0UeBiozAHw2RusAAAIOSURBVHjazdRlc9tAEAbgMjMzMzMzc5iZbMcxxSQVk5jEeLD3c+umlieWLtN+zH3TzKPR7runXfb1v85SYHdu3Lw+Nzd0piMSX5TFr10ta4bquth0lH0tzXw2eQiZhAGrHgCKtU3t+SDrPSwZFIjp2IqCNIMAU5XliQA7omMgln6785YoTg7ul4oEiLay2cfuzRgMo/Oi91auabXJqLaqu5FN37ed0IWG5tZYjKKNHvPc3al0Yzi5FQbgHUmPeW7Cn2kqhJnTtYBlMtzsO2Xmzgp1JoyMJHmsbSdmcrvHxGFZHhZ5blcRjEc11jdkAVjRNIeNIYajf9n0qEJKJYJGs0GWQ4yWE39Y5tObx+qPgvvs6QchwF46lYrzulbbC5tVik8CZnzgp+4WCgT9+pKa7zTmgsz5ZOatTUslplVzn2fPTdAGOR0k3xuVihrL1nJ74IB5lhdI6p1TjI158T7UKSkLPJee+jhRn0L3JRWs7dx5ZT8vmGmPTYkSDpSW813ytlMm4M19jap14HjOd8nDZRfMUKSh/A22fnTcd8k7EAFVb0p4KL5uvUGNmWM+lt+KXCDOnt0RsTcvTh7Yq1Uf7ZPxOvPctrLJmGvZuiTptuUyhpUTrzi/85aojCkwWj0MGHbW9uS5yyHRchpZKqGUYMv+dlBYdNX0h7suzkrS98vnrvT/a3EJYuvS2Ja/AXltnZiA1hh7AAAAAElFTkSuQmCC"/>\n    </div>\n    <div class="sfly_wgt_modal_bg"></div>\n</div>';});


define('text!app/templates/misc/transfer_animation.html',[],function () { return '<style type="text/css">\n    /* ==== CLICK THROUGH MODAL == */\n    @-webkit-keyframes rotateClockwise {\n        from {-webkit-transform:rotate(0deg);}\n        to {-webkit-transform:rotate(360deg);}\n    }\n    .sfly_wgt_modal_wrapper {\n        width: 100%;\n        height: 100%;\n        position: fixed;\n        top: 0;\n        left: 0;\n        z-index: 10000; }\n    .sfly_wgt_modal_wrapper .sfly_wgt_modal_bg {\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background-color: #000;\n        opacity: 0.6;\n        filter: alpha(opacity=60); }\n    .sfly_wgt_modal_wrapper .sfly_wgt_transfer {\n        position: fixed;\n        top: 50%;\n        left: 50%;\n        margin-left: -249px;\n        margin-top: -157px;\n        width: 498px;\n        height: 313px;\n        z-index: 10;\n        background-image: url("https://d22bbwxztp2lry.cloudfront.net/productswidget/Shutterfly/sidewidget/images/prod/thislife_transfer.png"); }\n    .sfly_wgt_modal_wrapper .sfly_wgt_transfer .sfly_wgt_transfer_spinner {\n        position: absolute;\n        top: 220px;\n        left: 230px;\n        -webkit-animation-name: rotateClockwise;\n        animation-name: rotateClockwise;\n        -webkit-animation-duration: 1500ms;\n        animation-duration: 1500ms;\n        -webkit-animation-iteration-count: infinite;\n        animation-iteration-count: infinite;\n        -webkit-animation-timing-function: linear;\n        animation-timing-function: linear; }\n\n    /* ==== END MODAL           == */\n</style>\n\n\n<div class="sfly_wgt_modal_wrapper">\n    <div class="sfly_wgt_transfer">\n        <img class="sfly_wgt_transfer_spinner" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACYAAAAmCAMAAACf4xmcAAABy1BMVEXWWwDbXQDiYADdXgDcXQDnYgDiYADjYADYWwDmYQDgXwDWWwDiYADlYQDWWwDaXADYWwDcXQDkYQDjYADaXADcXQDlYQDkYQDhXwDeXgDbXQDZXADfXgDWWwDWWwDaXADWWwDWWwDbXQDZXADgXwDiYADeXgDeXgDbXQDdXgDWWwDgXwDgXwDhXwDWWwDfXgDWWwDgXwDXWwDcXQDWWwDfXgDWWwDaXADWWwDcXQDYWwDWWwDcXQDlYQDcXQDXWwDnYgDeXgDYWwDcXQDWWwDbXQDWWwDZXADiYADiYADWWwDcXQDWWwDWWwDWWwDaXADWWwDXWwDWWwDWWwDWWwDYWwDYWwDaXADWWwDWWwDWWwDWWwDWWwDWWwDXWwDhXwDgXwDXWwDYWwDWWwDWWwDWWwDlYQDWWwDWWwDWWwDhXwDbXQDkYQDWWwDWWwDWWwDWWwDWWwDWWwDWWwDWWwDWWwDWWwDWWwDWWwAAAADjYADlYQD7agDYWwDaXADgXwDkYQDiYAD8awDvZQD9awDnYgD6agDmYQDsZADpYwDzZwDtZADoYgDxZgDyZgDwZgDrZADuZQD1aADqYwD0ZwD2aAD3aQD5aQD4aQB0bo3hAAAAenRSTlM/yefe0vzq+YT83pP2+XK6n7T86pOu8/b8up+x5Jyf4a7hzMzq/MzGwLds8PP5b+eE25PMYNJI9pD2olrD0irM0tUPDxIkzOrw7cb8w13wnBuZJAyHqHi0CYEDORXkePDt5/ZOIVf2Y1RL8/b5DxgtNkI8J0UeBiozAHw2RusAAAIOSURBVHjazdRlc9tAEAbgMjMzMzMzc5iZbMcxxSQVk5jEeLD3c+umlieWLtN+zH3TzKPR7runXfb1v85SYHdu3Lw+Nzd0piMSX5TFr10ta4bquth0lH0tzXw2eQiZhAGrHgCKtU3t+SDrPSwZFIjp2IqCNIMAU5XliQA7omMgln6785YoTg7ul4oEiLay2cfuzRgMo/Oi91auabXJqLaqu5FN37ed0IWG5tZYjKKNHvPc3al0Yzi5FQbgHUmPeW7Cn2kqhJnTtYBlMtzsO2Xmzgp1JoyMJHmsbSdmcrvHxGFZHhZ5blcRjEc11jdkAVjRNIeNIYajf9n0qEJKJYJGs0GWQ4yWE39Y5tObx+qPgvvs6QchwF46lYrzulbbC5tVik8CZnzgp+4WCgT9+pKa7zTmgsz5ZOatTUslplVzn2fPTdAGOR0k3xuVihrL1nJ74IB5lhdI6p1TjI158T7UKSkLPJee+jhRn0L3JRWs7dx5ZT8vmGmPTYkSDpSW813ytlMm4M19jap14HjOd8nDZRfMUKSh/A22fnTcd8k7EAFVb0p4KL5uvUGNmWM+lt+KXCDOnt0RsTcvTh7Yq1Uf7ZPxOvPctrLJmGvZuiTptuUyhpUTrzi/85aojCkwWj0MGHbW9uS5yyHRchpZKqGUYMv+dlBYdNX0h7suzkrS98vnrvT/a3EJYuvS2Ja/AXltnZiA1hh7AAAAAElFTkSuQmCC"/>\n    </div>\n    <div class="sfly_wgt_modal_bg"></div>\n</div>';});


define('text!app/templates/sidemodule_books/booksmodal.html',[],function () { return '<div id="sfly_wgt_sideopen_container">\n    <div class="sfly_wgt_arrow_book"></div>\n    <div class="sfly_wgt_bg_throbber"></div>\n    <div id="sfly_wgt_sideopen_title">\n        <h3><%= title %></h3>\n\n        <% if (price.salePrice > -1) { %>\n        <h4 class="price-wrapper">from <span class="price-old">$<%= parseFloat(price.originalPrice).toFixed(2) %></span> <span class="price-sale">$<%= parseFloat(price.salePrice).toFixed(2) %><%= coupon != false ? \' Code: \'+coupon : \'\' %></span></h4>\n        <% } else if (price.originalPrice > 0) { %>\n        <h4 class="price-wrapper">from $<%= parseFloat(price.originalPrice).toFixed(2) %></h4>\n        <% } else { %>\n        <h4 class="price-wrapper"></h4>\n        <% } %>\n    </div>\n    <div id="sfly_wgt_upp">\n        <div id="sfly_wgt_upp_select" href="javascript:;" class="sfly-wgt-gray-btn-sfly">Change Photos</div>\n    </div>\n    <div id="sfly_wgt_sideopen_products"><%= products %></div>\n    <div id="sfly_wgt_sideopen_bottompart">\n        <div id="sfly_wgt_sideopen_styles" data-pid="<%= pid %>">\n        </div>\n        <div id="sfly_wgt_sideopen_buttons">\n            <div class="sfly-wgt-orange-btn-sfly">Personalize</div>\n            <br/>\n            <a href="<%= see_all %>" class="sfly-wgt-lightlink">See more styles ></a>\n        </div>\n    </div>\n    <div id="sfly_wgt_no_enough_photos_popup" class="sfy_wgt_messageBox">\n        <div>This album doesn\'t have enough photos to create a photo book.</div>\n        <div>Please select an album with at least 20 photos.</div>\n        <div id="sfly_wgt_no_enough_photos_button">\n            <div class="sfly-wgt-orange-btn-sfly">Close</div>\n        </div>\n    </div>\n</div>';});


define('text!app/templates/sidemodule_books/button_closeopen.html',[],function () { return '<div class="sfly-wgt-btn-sidemodule open-state">\n    <div class="sfly-wgt-side-foryou">\n        Made<br/>for you\n    </div>\n</div>';});


define('text!app/templates/sidemodule_books/info_window.html',[],function () { return '<div class="sfy_wgt_messageBox" id="sfy_wgt_learnMoreBox" style="display: block;"><div class="sfy_wgt_learnMoreClose"></div><h3>Learn More</h3>We\'ve created a new feature that takes your recently uploaded photos, applies our smart photo selection technology to find pictures that go great together, and makes them into amazing products just for you.</div>';});


define('text!app/templates/sidemodule_books/style_product.html',[],function () { return '<div class="sfly_wgt_product" data-pid="<%= pid %>" data-sku="<%= sku %>" data-ptype="<%= ptype %>">\n    <div class="sfly_wgt_product_inner"></div>\n    <p class="sfly_wgt_product_style_title"><%= title %></p>\n</div>';});


define('text!app/templates/fullview/fullview_book_paging.html',[],function () { return '<div class="sfly-wgt-book-paging">\n    <div id="sfly_wgt_sideopen_arrow_left" class="sfly-wgt-lv-arrow-left sfly-wgt-arrow" data-dir="left"></div>\n    <div class="sfly-wgt-pages">\n        Cover\n    </div>\n    <div id="sfly_wgt_sideopen_arrow_right" class="sfly-wgt-lv-arrow-right sfly-wgt-arrow" data-dir="right"></div>\n</div>';});


define('text!app/templates/fullview/fullview_prints_paging.html',[],function () { return '<div class="sfly-wgt-book-paging">\n    <div id="sfly_wgt_sideopen_arrow_left" class="sfly-wgt-lv-arrow-left sfly-wgt-arrow" data-dir="left"></div>\n    <div class="sfly-wgt-pages">\n        1\n    </div>\n    <div id="sfly_wgt_sideopen_arrow_right" class="sfly-wgt-lv-arrow-right sfly-wgt-arrow" data-dir="right"></div>\n</div>';});


define('text!app/templates/fullview/fullview_calendar_paging.html',[],function () { return '<div class="sfly-wgt-book-paging sfly-wgt-calendar-paging">\n    <div id="sfly_wgt_sideopen_arrow_left" class="sfly-wgt-lv-arrow-left sfly-wgt-arrow" data-dir="left"></div>\n    <div id="sfly_wgt_sideopen_arrow_right" class="sfly-wgt-lv-arrow-right sfly-wgt-arrow" data-dir="right"></div>\n</div>';});


define('text!app/templates/sidemodule_prints/printsmodal.html',[],function () { return '<div id="sfly_wgt_sideopen_container">\n    <div class="sfly_wgt_arrow_book"></div>\n    <div class="sfly_wgt_bg_throbber"></div>\n    <div id="sfly_wgt_sideopen_title">\n        <h3><%= title %></h3>\n\n        <% if (price.salePrice > -1) { %>\n        <h4 class="price-wrapper"><span class="price-old">$<%= parseFloat(price.originalPrice).toFixed(2) %></span> <span class="price-sale">$<%= parseFloat(price.salePrice).toFixed(2) %></span> per print<%= coupon != false ? \' <span class="price-sale">Code: \'+coupon+\'</span>\' : \'\' %></h4>\n        <% } else if (price.originalPrice > 0) { %>\n        <h4 class="price-wrapper">$<%= parseFloat(price.originalPrice).toFixed(2) %> per print</h4>\n        <% } else { %>\n        <h4 class="price-wrapper"></h4>\n        <% } %>\n    </div>\n    <div id="sfly_wgt_upp">\n        <div id="sfly_wgt_upp_select" href="javascript:;" class="sfly-wgt-gray-btn-sfly">Change Photos</div>\n    </div>\n    <div id="sfly_wgt_sideopen_products" class="sfly-wgt-prints"><%= products %></div>\n    <div id="sfly_wgt_sideopen_bottompart">\n        <div id="sfly_wgt_sideopen_styles" data-pid="<%= pid %>">\n        </div>\n        <div id="sfly_wgt_sideopen_buttons">\n            <div class="sfly-wgt-orange-btn-sfly">Personalize</div>\n            <!--\n            <br/>\n            <a href="http://www.shutterfly.com/custom-path/stylecatalog.sfly?fromLocation=lightbox&order=false&defaultBookTitle=My%20Photo%20Book&bookSize=<%= size %>&occasions=Our%20Top%20Picks" class="sfly-wgt-lightlink">See more styles ></a>\n            -->\n        </div>\n    </div>\n    <div id="sfly_wgt_no_enough_photos_popup" class="sfy_wgt_messageBox">\n        <div>The chosen album doesn\'t have enough photos to create prints.</div>\n        <div>Please select an album with at least 1 photo.</div>\n        <div id="sfly_wgt_no_enough_photos_button">\n            <div class="sfly-wgt-orange-btn-sfly">Close</div>\n        </div>\n    </div>\n</div>';});


define('text!app/templates/sidemodule_products/productsmodal.html',[],function () { return '<div id="sfly_wgt_sideopen_container">\n    <div class="sfly_wgt_arrow_book"></div>\n    <div id="sfly_wgt_sideopen_title">\n        <h3><%= title %></h3>\n        <% if (price.salePrice > -1) { %>\n        <h4 class="price-wrapper"><%= per_text.length > 0 ? \'\' : \'from \' %><span class="price-old">$<%= parseFloat(price.originalPrice).toFixed(2) %></span> <span class="price-sale">$<%= parseFloat(price.salePrice).toFixed(2) %></span><%= per_text %><%= coupon != false ? \' <span class="price-sale">Code: \'+coupon+\'</span>\' : \'\' %></h4>\n        <% } else if (price.originalPrice > 0) { %>\n        <h4 class="price-wrapper"><%= per_text.length > 0 ? \'\' : \'from \' %>$<%= parseFloat(price.originalPrice).toFixed(2) %><%= per_text %></h4>\n        <% } else { %>\n        <h4 class="price-wrapper"></h4>\n        <% } %>\n    </div>\n    <div id="sfly_wgt_upp">\n        <div id="sfly_wgt_upp_select" href="javascript:;" class="sfly-wgt-gray-btn-sfly">Change Photos</div>\n    </div>\n    <div id="sfly_wgt_sideopen_products_container">\n        <div id="sfly_wgt_sideopen_products_1" class="sfly_wgt_sideopen_product"></div>\n        <div id="sfly_wgt_sideopen_products_2" class="sfly_wgt_sideopen_product"></div>\n    </div>\n    <div id="sfly_wgt_more_styles_produts">\n        <% if(see_all) {%>\n            <a href="<%= see_all %>" class="sfly-wgt-lightlink">See more styles ></a>\n        <% } %>\n    </div>\n    <div id="sfly_wgt_no_enough_photos_popup" class="sfy_wgt_messageBox">\n        <div>The chosen album doesn\'t have enough photos to create a product.</div>\n        <div>Please select an album with at least 1 photo.</div>\n        <div id="sfly_wgt_no_enough_photos_button">\n            <div class="sfly-wgt-orange-btn-sfly">Close</div>\n        </div>\n    </div>\n</div>';});


define('text!app/templates/sidemodule/albumchange.html',[],function () { return '<div id="sfly_wgt_album_switch_select">\n    <select id="sfly_wgt_albumswitch">\n        <% for (var i = 0; i < albums.length; i++) { %>\n        <option value="<%=albums[i].id%>"><%=albums[i].title%></option>\n        <% } %>\n    </select>\n</div>';});


define('text!app/templates/sidemodule/help_title.html',[],function () { return '<p class="sfly_wgt_side_widget_title">MADE FOR YOU <span class="sfly-wgt-qst-mark">&nbsp;</span></p>';});


define('text!app/templates/sidemodule/signin_message.html',[],function () { return '<div class="sfly-wgt-overlay-message">\n    <a href="https://www<%=env%>.shutterfly.com/forwardingSignin/start.sfly">Sign in to see your photos on these products ></a>\n</div>';});


define('text!app/templates/sidemodule/upload_message.html',[],function () { return '<div class="sfly-wgt-overlay-message">\n    <a href="https://www<%=env%>.shutterfly.com/nav/mypics.sfly">Upload 20 or more photos to personalize your products and check back soon ></a>\n</div>';});


define('text!app/templates/sidemodule/upload_message_popup.html',[],function () { return '<div class="sfly-wgt-overlay-message">\n    <a href="<%= superfly == true ? \'https://photos\'+env+\'.shutterfly.com/add\' : \'javascript:showUploadPopupDialog(true);\' %>">Upload 20 or more photos to personalize your products and check back soon ></a>\n</div>';});


define('text!app/templates/sidemodule/upload_embedded_message.html',[],function () { return '<div class="sfly-wgt-overlay-message">\n    <a href="https://www<%=env%>.shutterfly.com/nav/mypics.sfly">Upload 20 or more photos to personalize your products and check back soon ></a>\n</div>';});


define('text!app/templates/sidemodule/static_books_filler.html',[],function () { return '<div class="sfly-wgt-static-filler">\n    <img src="https://d22bbwxztp2lry.cloudfront.net/productswidget/Shutterfly/sidewidget/images/<%= env %>/vertical_book_empty_state.png"/>\n</div>';});


define('text!app/templates/sidemodule/static_products_filler.html',[],function () { return '<div class="sfly-wgt-static-filler">\n    <img src="https://d22bbwxztp2lry.cloudfront.net/productswidget/Shutterfly/sidewidget/images/<%= env %>/vertical_products_empty_state.png"/>\n</div>';});


define('text!app/templates/sidemodule/static_calendar_filler.html',[],function () { return '<div class="sfly-wgt-static-filler">\n    <img src="https://d22bbwxztp2lry.cloudfront.net/productswidget/Shutterfly/sidewidget/images/<%= env %>/vertical_calendar_empty_state.png"/>\n</div>';});


define('text!app/templates/sidemodule/static_cns_filler.html',[],function () { return '<div class="sfly-wgt-static-filler">\n    <img src="https://d22bbwxztp2lry.cloudfront.net/productswidget/Shutterfly/sidewidget/images/<%= env %>/vertical_cns_empty_state.png"/>\n</div>';});


define('text!app/templates/popup/static_mg_filler.html',[],function () { return '<div class="sfly-wgt-mg-static-filler">\n    <img src="https://d22bbwxztp2lry.cloudfront.net/productswidget/Shutterfly/sidewidget/images/<%= env %>/mg_empty_state.png"/>\n</div>';});


define('text!app/templates/sidemodule_calendar/calendar_modal.html',[],function () { return '<div id="sfly_wgt_sideopen_container">\n    <div class="sfly_wgt_arrow_book"></div>\n    <div class="sfly_wgt_bg_throbber"></div>\n    <div id="sfly_wgt_sideopen_title">\n        <h3><%= title %></h3>\n\n        <% if (price.salePrice > -1) { %>\n        <h4 class="price-wrapper">from <span class="price-old">$<%= parseFloat(price.originalPrice).toFixed(2) %></span> <span class="price-sale">$<%= parseFloat(price.salePrice).toFixed(2) %><%= coupon != false ? \' Code: \'+coupon : \'\' %></span></h4>\n        <% } else if (price.originalPrice > 0) { %>\n        <h4 class="price-wrapper">from $<%= parseFloat(price.originalPrice).toFixed(2) %></h4>\n        <% } else { %>\n        <h4 class="price-wrapper"></h4>\n        <% } %>\n    </div>\n    <div id="sfly_wgt_upp">\n        <div id="sfly_wgt_upp_select" href="javascript:;" class="sfly-wgt-gray-btn-sfly">Change Photos</div>\n    </div>\n    <div id="sfly_wgt_sideopen_products"><%= products %></div>\n    <div id="sfly_wgt_sideopen_bottompart">\n        <div id="sfly_wgt_sideopen_styles" data-pid="<%= pid %>">\n        </div>\n        <div id="sfly_wgt_sideopen_buttons">\n            <div class="sfly-wgt-orange-btn-sfly">Personalize</div>\n            <br/>\n            <a href="<%= see_all %>" class="sfly-wgt-lightlink">See more styles ></a>\n        </div>\n    </div>\n    <div id="sfly_wgt_no_enough_photos_popup" class="sfy_wgt_messageBox">\n        <div>This album doesn\'t have enough photos to create a calendar.</div>\n        <div>Please select an album with at least 12 photos.</div>\n        <div id="sfly_wgt_no_enough_photos_button">\n            <div class="sfly-wgt-orange-btn-sfly">Close</div>\n        </div>\n    </div>\n</div>';});


define('text!app/templates/popup/productsmodal.html',[],function () { return '<div id="sfly_wgt_sideopen_left_pane">\n    <div id="sfly_wgt_sideopen_left_pane_product_container"></div>\n</div>\n<div id="sfly_wgt_sideopen_container" class="<%= typeof useNewStyleGuide !== \'undefined\' && useNewStyleGuide ? \'use-new-style-guide\' : \'\' %>">\n    <div id="sfly_wgt_sideopen_products_header">\n        <div id="sfly_wgt_sideopen_title" class="sfly-wgt-products">\n            <% if (showTooltip) { %>\n                <div id="sfly_wgt_tooltip_container_background"></div>\n            <% } %>\n            <% if(isMobile) { %>\n                <h2><div class="sfly_wgt_tooltip_hover_area no-hover"><%= title %></div></h2>\n            <% } else {\n                if(useNewStyleGuide) {\n                %>\n                    <h2><div class="sfly_wgt_tooltip_hover_area no-hover"><%= title %>,</div></h2>\n                    <!--<h2>Choose Your Gift - <div class="sfly_wgt_tooltip_hover_area <%= showTooltip ? \'\' : \'no-hover\' %>"><%= title %><% if (showTooltip) { %> <span class="sfly_wgt_tooltip_triangle" ><div id="sfly_wgt_tooltip_container"></div></span><% } %></div></h2>-->\n                <% } else {%>\n                    <h2>Choose Your Gift - <div class="sfly_wgt_tooltip_hover_area <%= showTooltip ? \'\' : \'no-hover\' %>"><%= title %><% if (showTooltip) { %> <span class="sfly_wgt_tooltip_triangle" ><div id="sfly_wgt_tooltip_container"></div></span><% } %></div></h2>\n                <% } %>\n                <% if (price.salePrice > -1) { %>\n                    <h4 class="price-wrapper"><span><%= useNewStyleGuide ? "" : titleModal+"," %></span> from <span class="price-old">$<%= parseFloat(price.originalPrice).toFixed(2) %></span> <span class="price-sale">$<%= parseFloat(price.salePrice).toFixed(2) %></span><%= per_text %><%= coupon != false ? \' <span class="price-sale">Code: \'+coupon+\'</span>\' : \'\' %></h4>\n                    <% } else if (price.originalPrice > 0) { %>\n                    <h4 class="price-wrapper"><span><%= useNewStyleGuide ? "" : titleModal+"," %></span> from $<%= parseFloat(price.originalPrice).toFixed(2) %><%= per_text %></h4>\n                    <% } else { %>\n                    <h4 class="price-wrapper"><span><%= useNewStyleGuide ? "" : titleModal %></span></h4>\n                <% } %>\n            <% } %>\n        </div>\n        <% if (!isMobile) { %>\n            <div id="sfly_wgt_upp" class="sfly-wgt-products">\n                <div id="sfly_wgt_upp_select" href="javascript:;" class="<%= typeof useNewStyleGuide !== \'undefined\' && useNewStyleGuide ? \'sfly-wgt-white-btn-sfly\' : \'sfly-wgt-gray-btn-sfly\' %> <%= typeof hideSelectButton !== \'undefined\' && hideSelectButton ? \'hide-btn-in-selection-mode\' : \'\' %>"><%= typeof hasModalMenu !== \'undefined\' && hasModalMenu ? \'CHANGE PHOTOS\' : \'Select photos\' %></div>\n            </div>\n        <% } %>\n        <div id="sfly_wg_sideopen_close">\n            <span class="sfly-wgt-qst-mark">&nbsp;</span>\n        </div>\n    </div>\n    <div id="sfly_wgt_sideopen_products_container" class="sfly-wgt-products">\n        <div id="sfly_wgt_sideopen_products_container_space"></div>\n        <ul id="sfly_wgt_sideopen_products_inner_container"></ul>\n    </div>\n</div>';});


define('text!app/templates/popup/booksmodal.html',[],function () { return '<div id="sfly_wgt_sideopen_container" class="<%= typeof useNewStyleGuide !== \'undefined\' && useNewStyleGuide ? \'use-new-style-guide\' : \'\' %>">\n    <div class="sfly_wgt_bg_throbber"></div>\n    <div id="sfly_wgt_sideopen_products_header">\n        <div id="sfly_wgt_sideopen_title" class="sfly-wgt-photobooks">\n            <%= title_template({size: size, pages: pages, price: price, style: style, coupon: coupon, isMobile: isMobile, hasModalMenu: hasModalMenu}) %>\n        </div>\n        <div id="sfly_wgt_upp" class="<%= isMobile ? \'sfly-wgt-mobile-btns\' : \'\' %>  sfly-wgt-photobooks">\n            <div id="sfly_wgt_upp_select" href="javascript:;" class="<%= typeof useNewStyleGuide !== \'undefined\' && useNewStyleGuide ? \'sfly-wgt-white-btn-sfly\' : \'sfly-wgt-gray-btn-sfly\' %>  <%= typeof hideSelectButton !== \'undefined\' && hideSelectButton ? \'hide-btn-in-selection-mode\' : \'\' %>"><%= typeof hasModalMenu !== \'undefined\' && hasModalMenu ? \'CHANGE PHOTOS\' : \'Select photos\' %></div>\n            <div class="sfly-wgt-orange-btn-sfly">\n                <%  if (hasModalMenu) { %>\n                PERSONALIZE\n                <%  } else if (isMobile) { %>\n                Personalize book\n                <% } else { %>\n                Personalize<%= responsiveBtns ? \'\' : \' this photo book\' %>\n                <% } %>\n            </div>\n        </div>\n        <div id="sfly_wg_sideopen_close">\n            <span class="sfly-wgt-qst-mark"></span>\n        </div>\n    </div>\n    <div id="sfly_wgt_sideopen_products"  class="sfly-wgt-photobooks"><%= products %></div>\n    <div id="sfly_wgt_sideopen_bottompart">\n        <ul class="sfly_wgt_sideopen_bottompart_tabs">\n            <li id="sfly_wgt_sideopen_bottompart_tab_choose_style" class="sfly_wgt_sideopen_bottompart_tab sfly_wgt_tab_active">Styles</li>\n            <li id="sfly_wgt_sideopen_bottompart_tab_choose_size" class="sfly_wgt_sideopen_bottompart_tab ">Sizes</li>\n        </ul>\n\n        <div id="sfly_wgt_sideopen_bottompart_tab_choose_style_content" class="sfly_wgt_sideopen_bottompart_tab_content sfly_wgt_tab_active">\n            <div id="sfly_wgt_sideopen_styles_left"></div>\n            <div id="sfly_wgt_sideopen_styles_container">\n                <div id="sfly_wgt_sideopen_styles" data-pid="<%= pid %>">\n                    <div id="sfly_wgt_sideopen_buttons"><a href="<%= see_all %>" class="sfly-wgt-lightlink see-more-styles">See more<br/>styles ></a></div>\n                </div>\n            </div>\n            <div id="sfly_wgt_sideopen_styles_right"></div>\n        </div>\n        <div id="sfly_wgt_sideopen_bottompart_tab_choose_size_content" class="sfly_wgt_sideopen_bottompart_tab_content">\n            <div id="sfly-wgt-book-options">\n                <div id="sfly-wgt-book-choose-sizes">\n                    <div class="sfly-wgt-book-choose-size <%= size == \'8x8\' ? \'sfly-wgt-book-choose-size-selected\' : \'\' %>" data-code="8x8"></div>\n                    <div class="sfly-wgt-book-choose-size <%= size == \'8x11\' ? \'sfly-wgt-book-choose-size-selected\' : \'\' %>" data-code="8x11"></div>\n                    <div class="sfly-wgt-book-choose-size <%= size == \'11x14\' ? \'sfly-wgt-book-choose-size-selected\' : \'\' %>" data-code="11x14"></div>\n                </div>\n            </div>\n        </div>\n    </div>\n    <% if ((typeof isStoryBook === "undefined" || (typeof isStoryBook === "boolean" && isStoryBook === false)) && !(isMobile || hasModalMenu)) { %>\n        <div id="sfly-wgt-book-choose-hightlights">\n            <div class="checkbox_wrapper">\n                <input type="checkbox" name="highlights" checked>\n                <label></label>\n            </div> Curate your photos\n        </div>\n        <div id="sfly_wgt_highlight_bubble">\n            <div class="sfly_wgt_highlight_bubble_txt"><strong>Uncheck to not curate</strong><br/>We will use all your selected photos in your photo book.</div>\n            <div id="sfly_wgt_highlight_bubble_arrow"></div>\n        </div>\n    <% } %>\n    <div id="sfly_wgt_no_enough_photos_bubble">\n        <div><span id="sfly_wgt_no_enough_photos_bubble_warning"></span> You don\'t have enough photos to create a photo book.</div>\n        <div>Please select at least 20 photos.</div>\n        <div id="sfly_wgt_no_enough_photos_bubble_arrow"></div>\n    </div>\n    <div id="sfly-wgt-popup-disable-overlay"></div>\n</div>\n';});


define('text!app/templates/popup/printsmodal.html',[],function () { return '<div id="sfly_wgt_sideopen_container" class="<%= typeof useNewStyleGuide !== \'undefined\' && useNewStyleGuide ? \'use-new-style-guide\' : \'\' %>">\n    <div id="sfly_wgt_sideopen_products_header">\n        <div id="sfly_wgt_sideopen_title">\n            <h2>Prints, </h2>\n            <% if (price.salePrice > -1) { %>\n            <h4 class="price-wrapper">from <span class="price-old">$<%= parseFloat(price.originalPrice).toFixed(2) %></span> <span class="price-sale">$<%= parseFloat(price.salePrice).toFixed(2) %></span><%= coupon != false ? \' <span class="price-sale">Code: \'+coupon+\'</span>\' : \'\' %></h4>\n            <% } else if (price.originalPrice > 0) { %>\n            <h4 class="price-wrapper">from $<%= parseFloat(price.originalPrice).toFixed(2) %></h4>\n            <% } else { %>\n            <h4 class="price-wrapper"></h4>\n            <% } %>\n        </div>\n        <div id="sfly_wgt_upp" style="display:none;">\n            <div id="sfly_wgt_upp_select" href="javascript:;" class="sfly-wgt-gray-btn-sfly">Change Photos</div>\n            <div class="sfly-wgt-orange-btn-sfly">ORDER PRINTS</div>\n        </div>\n        <div id="sfly_wg_sideopen_close" style="display:none;">\n            <span class="sfly-wgt-qst-mark">&nbsp;</span>\n        </div>\n    </div>\n    <div id="sfly_wgt_sideopen_products" class="sfly-wgt-prints"><%= products %></div>\n\n    <div class="sfly-wgt-prints-info">\n        <div class="sfly-wgt-prints-size-selector">\n            <ul class="size-selector">\n            <li>\n                <div class="selector-item" id="4x4">\n                    <div class="selector-tem label">4x4</div>\n                    <div class="selector-tem radio"></div>\n                </div>\n            </li>\n            <li>\n                <div class="selector-item" id="4x6">\n                    <div class="selector-tem label">4x6</div>\n                    <div class="selector-tem radio selected"></div>\n                </div>\n            </li>\n            <li>\n                <div class="selector-item" id="5x7">\n                    <div class="selector-tem label">5x7</div>\n                    <div class="selector-tem radio"></div>\n                </div>\n            </li>\n            <li>\n                <div class="selector-item" id="8x8">\n                    <div class="selector-tem label">8x8</div>\n                    <div class="selector-tem radio"></div>\n                </div>\n            </li>\n            <li>\n                <div class="selector-item" id="8x10">\n                    <div class="selector-tem label">8x10</div>\n                    <div class="selector-tem radio"></div>\n                </div>\n            </li>\n\n        </ul>\n        </div>\n    </div>\n    <div class="sfly-wgt-orange-btn-sfly sfly-wgt-order-prints"><%= typeof orderButton !== \'undefined\' ? orderButton : \'ORDER PRINTS\' %></div>\n    <div id="sfly-wgt-prints-options">\n    </div>\n    <div class="sfly-wgt-send-link-container"></div>\n\n</div>';});


define('text!app/templates/sidemodule/spread_container.html',[],function () { return '<div class="sfly_wgt_listview_spread_container">\n\n</div>';});


define('text!app/templates/misc/scroller.html',[],function () { return '<div class="sfly-wgt-listview-scrollbar-<%= orientation %>">\n    <div class="sfly-wgt-scroll-track">\n        <span class="sfly-wgt-scroll-thumb"></span>\n    </div>\n</div>';});


define('text!app/templates/popup/calendarmodal.html',[],function () { return '<div id="sfly_wgt_sideopen_container" class="<%= typeof useNewStyleGuide !== \'undefined\' && useNewStyleGuide ? \'use-new-style-guide\' : \'\' %>">\n    <div class="sfly_wgt_bg_throbber"></div>\n    <div id="sfly_wgt_sideopen_products_header">\n        <div id="sfly_wgt_sideopen_title" class="sfly-wgt-calendars">\n            <%= title_template({sizeTitle: sizeTitle, months: months, price: price, style: style, coupon: coupon, hasModalMenu: hasModalMenu}) %>\n        </div>\n        <div id="sfly_wgt_upp" class="<%= isMobile ? \'sfly-wgt-mobile-btns\' : \'\' %> sfly-wgt-calendars">\n            <div id="sfly_wgt_upp_select" href="javascript:;" class="<%= typeof useNewStyleGuide !== \'undefined\' && useNewStyleGuide ? \'sfly-wgt-white-btn-sfly\' : \'sfly-wgt-gray-btn-sfly\' %>  <%= typeof hideSelectButton !== \'undefined\' && hideSelectButton ? \'hide-btn-in-selection-mode\' : \'\' %>"><%= typeof hasModalMenu !== \'undefined\' && hasModalMenu ? \'CHANGE PHOTOS\' : \'Select photos\' %></div>\n            <div class="sfly-wgt-orange-btn-sfly">\n                <%  if (hasModalMenu) { %>\n                PERSONALIZE\n                <%  } else { %>\n                Personalize<%= responsiveBtns ? \'\' : (isMobile ? \' calendar\' : \' this calendar\') %>\n                <% } %>\n            </div>\n        </div>\n        <div id="sfly_wg_sideopen_close">\n            <span class="sfly-wgt-qst-mark">&nbsp;</span>\n        </div>\n    </div>\n    <div id="sfly_wgt_sideopen_products" class="sfly-wgt-calendars"><%= products %></div>\n    <div id="sfly_wgt_sideopen_bottompart">\n        <ul class="sfly_wgt_sideopen_bottompart_tabs">\n            <li id="sfly_wgt_sideopen_bottompart_tab_choose_style" class="sfly_wgt_sideopen_bottompart_tab sfly_wgt_tab_active">Styles</li>\n            <% if(showSizes) { %>\n                <li id="sfly_wgt_sideopen_bottompart_tab_choose_size" class="sfly_wgt_sideopen_bottompart_tab ">Sizes</li>\n            <% } %>\n        </ul>\n        <div id="sfly_wgt_sideopen_bottompart_tab_choose_style_content" class="sfly_wgt_sideopen_bottompart_tab_content sfly_wgt_tab_active">\n            <div id="sfly_wgt_sideopen_styles_left"></div>\n            <div id="sfly_wgt_sideopen_styles_container">\n                <div id="sfly_wgt_sideopen_styles" data-pid="<%= pid %>">\n                    <div id="sfly_wgt_sideopen_buttons"><a href="<%= see_all %>" class="sfly-wgt-lightlink see-more-styles">See more<br/>styles ></a></div>\n                </div>\n            </div>\n            <div id="sfly_wgt_sideopen_styles_right"></div>\n        </div>\n        <% if(showSizes) { %>\n        <div id="sfly_wgt_sideopen_bottompart_tab_choose_size_content" class="sfly_wgt_sideopen_bottompart_tab_content">\n            <div id="sfly-wgt-calendar-options">\n                <div id="sfly-wgt-book-choose-sizes">\n                    <div class="sfly-wgt-book-choose-size <%= size == \'8x11\' ? \'sfly-wgt-book-choose-size-selected\' : \'\' %>" data-code="8x11">\n                        <div class="sfly-wgt-calendar-choose-size-calendar"></div>\n                        <div class="sfly-wgt-book-choose-size-title">8x11</div>\n                        <div class="sfly-wgt-book-icon-price"></div>\n                    </div>\n                    <!--<div class="sfly-wgt-book-choose-size <%= size == \'33\' ? \'sfly-wgt-book-choose-size-selected\' : \'\' %>" data-code="33">-->\n                        <!--<div class="sfly-wgt-calendar-choose-size-deskcalendar"></div>-->\n                        <!--<div class="sfly-wgt-book-choose-size-title">5x11</div>-->\n                        <!--<div class="sfly-wgt-book-icon-price"></div>-->\n                    <!--</div>-->\n                    <div class="sfly-wgt-book-choose-size <%= size == \'12x12\' ? \'sfly-wgt-book-choose-size-selected\' : \'\' %>" data-code="12x12">\n                        <div class="sfly-wgt-calendar-choose-size-calendar calendar-12x12"></div>\n                        <div class="sfly-wgt-book-choose-size-title">12x12</div>\n                        <div class="sfly-wgt-book-icon-price"></div>\n                    </div>\n                </div>\n            </div>\n        </div>\n        <% } %>\n    </div>\n    <div id="sfly_wgt_no_enough_photos_bubble">\n        <div><span id="sfly_wgt_no_enough_photos_bubble_warning"></span> You don\'t have enough photos to create a calendar.</div>\n        <div>Please select at least 12 photos.</div>\n        <div id="sfly_wgt_no_enough_photos_bubble_arrow"></div>\n    </div>\n    <div id="sfly-wgt-popup-disable-overlay"></div>\n</div>';});


define('text!app/templates/popup/embedded_title.html',[],function () { return '<% var themeClass = (typeof theme !== \'undefined\' && theme ? theme : \'\' ); %>\n<div class="sfly_wgt_listview_embedded_title">\n    <div class="sfly-wgt-title <%= themeClass %>"></div>\n    <!--<h5 class="sfly_wgt_listview_embedded_caption">Your photos + Our favorite designs = The perfect match</h5>-->\n    <div class="sfly_wgt_listview_embedded_title_actions <%= themeClass %>">\n        <div href="javascript:;" class="sfly_wgt_upp_select_main">Change Photos</div>\n    </div>\n</div>\n<% if (themeClass) { %>\n<div class="sfly_wgt_listview_embedded_title_background <%= themeClass %>">\n    <div class="<%= \'sfly-wgt-\' + themeClass +\'-title-left-corner\'%>"></div>\n    <div class="<%= \'sfly-wgt-\' + themeClass +\'-title-right-corner\'%>"></div>\n</div>\n<% } %>';});


define('text!app/templates/popup/embedded_title_flex.html',[],function () { return '<% var themeClass = (typeof theme !== \'undefined\' && theme ? theme : \'\' ); %>\n<div class="sfly_wgt_listview_embedded_title">\n    <div class="sfly-wgt-title-flex">\n        <div class="sfly-wgt-title-text <%= themeClass %>"></div>\n\n        <% if (themeClass === \'made-just\') { %>\n            <span class=\'sfly-wgt-subtitle-text\'></span>\n        <% } %>\n\n    </div>\n    <!--<h5 class="sfly_wgt_listview_embedded_caption">Your photos + Our favorite designs = The perfect match</h5>-->\n    <div class="sfly_wgt_listview_embedded_title_actions <%= themeClass %>">\n        <div href="javascript:;" class="sfly_wgt_upp_select_main">Change Photos</div>\n    </div>\n</div>\n<% if (themeClass) { %>\n    <div class="sfly_wgt_listview_embedded_title_background <%= themeClass %>">\n        <div class="<%= \'sfly-wgt-\' + themeClass +\'-title-left-corner\'%>"></div>\n        <div class="<%= \'sfly-wgt-\' + themeClass +\'-title-right-corner\'%>"></div>\n    </div>\n<% } %>';});


define('text!app/templates/popup/tl_embedded_title.html',[],function () { return '<div class="sfly_wgt_listview_embedded_title">\n    <%= html %>\n</div>';});


define('text!app/templates/popup/embedded_signout_title.html',[],function () { return '<div class="sfly_wgt_listview_embedded_title">\n    <div class="embedded_signout">Your photos + our favorite designs = the perfect match\n        <a href="https://www<%=env%>.shutterfly.com/forwardingSignin/start.sfly">SIGN IN TO SEE ></a>\n    </div>\n    <div class="sfly_wgt_listview_embedded_title_actions" style="display: none;">\n        <div href="javascript:;" class="sfly_wgt_upp_select_main sfly-wgt-gray-btn-sfly sfly-wgt-gray-btn-sfly-hp">Change Photos</div>\n    </div>\n</div>';});


define('text!app/templates/popup/embedded_homepage_no_title.html',[],function () { return '<div class="sfly_wgt_listview_embedded_title">\n    <h5 class="embedded_signout">\n        Love what we made for you? Get it in a click\n    </h5>\n    <div class="sfly_wgt_listview_embedded_title_actions">\n        <div href="javascript:;" class="sfly_wgt_upp_select_main sfly-wgt-gray-btn-sfly sfly-wgt-gray-btn-sfly-hp">Change Photos</div>\n    </div>\n</div>';});


define('text!app/templates/popup/embedded_homepage_no_photos.html',[],function () { return '<div class="sfly_wgt_listview_embedded_title">\n    <h5 class="embedded_signout">How would your photos look in these products? Just click on\n        <a style="color: #f05323;" class="sfly_wgt_upp_select_main"   href="javascript:;" >CHANGE PHOTOS ></a></h5>\n    <div class="sfly_wgt_listview_embedded_title_actions">\n        <div href="javascript:;" class="sfly_wgt_upp_select_main sfly-wgt-gray-btn-sfly sfly-wgt-gray-btn-sfly-hp">Change Photos</div>\n    </div>\n</div>';});


define('text!app/templates/listview/listview_arrows.html',[],function () { return '<% var themeClass = (typeof theme !== \'undefined\' && theme ? theme : \'\' ); %>\n<div class="sfly_wgt_listview_scroll_arrows <%= themeClass %>">\n    <div class="sfly_wgt_listview_scroll_arrow sfly_wgt_listview_scroll_left_arrow"></div>\n    <div class="sfly_wgt_listview_scroll_arrow sfly_wgt_listview_scroll_right_arrow"></div>\n</div>';});


define('text!app/templates/sidemodule_products/placeholder.html',[],function () { return '<div class="sfly_wgt_product_placeholder">\n    <span class="sfly_wgt_item_placeholder_prod"></span>\n    <span class="sfly_wgt_item_placeholder_line"></span>\n</div>';});


define('text!app/templates/popup/new_upp_bubble.html',[],function () { return '<div class="sfly_wgt_bubble_new_upp">\n    <div class="sfly_wgt_bubble_new_upp_title">NEW!</div>\n    <div>Select photos from your computer, Facebook, Instagram and more.</div>\n    <div class="sfly_wgt_bubble_new_upp_close">\n        <div class="sfly-wgt-orange-btn-sfly">Got it!</div>\n    </div>\n    <div class="sfly_wgt_bubble_new_upp_arrow"></div>\n</div>';});


define('text!app/templates/popup/upp_bubble_hp.html',[],function () { return '<div class="sfly_wgt_bubble_new_upp">\n    <div class="sfly_wgt_bubble_new_upp_title">Upload photos</div>\n    <div>Select photos from your computer, Facebook, Instagram and more.</div>\n    <div class="sfly_wgt_bubble_new_upp_close">\n        <div class="sfly-wgt-orange-btn-sfly">Got it!</div>\n    </div>\n    <div class="sfly_wgt_bubble_new_upp_arrow"></div>\n</div>';});


define('text!app/templates/misc/flyout_store.html',[],function () { return '<a href="https://www<%=env%>.shutterfly.com/forwardingSignin/start.sfly" id="sfly-wgt-store-flyout">\n    <p>Sign in to see your photos<br/>in these products ></p>\n</a>';});


define('text!app/templates/misc/flyout_store_no_photos.html',[],function () { return '<a href="https://www<%=env%>.shutterfly.com/nav/mypics.sfly" id="sfly-wgt-store-flyout">\n    <p class="sfly-wgt-store-flyout-no-photos"><b>We don\'t have enough photos to personalize these products.</b><br/>Please upload more (you need at least 60) and check back soon</p>\n</a>';});


define('text!app/templates/misc/flyout_store_welcome.html',[],function () { return '<div id="sfly-wgt-store-flyout">\n    <p class="sfly-wgt-store-flyout-welcome"><b>Welcome to your personalized store page.</b><br/>Take a look at the products we\'ve made for you. See below.</p>\n</div>';});


define('text!app/templates/popup/loadmore.html',[],function () { return '<div class="sfly-wgt-modal-load-more">\n    <div class="sfly-wgt-modal-load-more-action">Load More</div>\n</div>';});


define('text!app/templates/popup/products_tooltip.html',[],function () { return '<div>\n    <ul class="sfly-wgt-tooltip-list">\n        <% _.each(products, function(product) {\n            var prodTitle = getTitle(product.renderData.prodOptions[product.sku], product.sku);\n        %>\n            <li class="sfly-wgt-book-choose-size <%= currentProduct == prodTitle ? \'sfly-wgt-book-choose-size-selected\' : \'\' %>" data-code="<%= product.sku %>">\n                <div class="sfly-wgt-tooltip-choose-size-title"><%= prodTitle %></div>\n            </li>\n        <% }); %>\n    </ul>\n\n</div>';});


define('text!app/templates/popup/products_left_pane.html',[],function () { return '<div id="sfly-wgt-left-pane-content">\n    <% _.each(products, function(category, categoryTitle) {\n        if (categoryTitle !== \'Prints\') {\n    %>\n            <ul class="sfly-wgt-left-pane-category">\n                <div class="sfly-wgt-left-pane-category-title"><%= categoryTitle %></div>\n                <% _.each(category, function(product) {\n                    var prodTitle = product.title;\n                    var prodSku = product.sku;\n                %>\n                    <li class="sfly-wgt-left-pane-category-product <%= currentProduct == prodTitle ? \'sfly-wgt-left-pane-category-product-selected\' : \'\' %>" data-code="<%= prodSku %>">\n                        <div class="sfly-wgt-left-pane-category-product-title"><%= prodTitle %></div>\n                    </li>\n                <% }); %>\n            </ul>\n        <% } %>\n    <% }); %>\n</div>';});


define('text!app/templates/popup/calendar_tooltip.html',[],function () { return '<div>\n    <ul class="sfly-wgt-tooltip-list">\n        <li class="sfly-wgt-book-choose-size <%= size == \'8x11\' ? \'sfly-wgt-book-choose-size-selected\' : \'\' %>" data-code="8x11">\n            <div class="sfly-wgt-tooltip-choose-size-title">8x11</div>\n        </li>\n        <li class="sfly-wgt-book-choose-size <%= size == \'12x12\' ? \'sfly-wgt-book-choose-size-selected\' : \'\' %>" data-code="12x12">\n            <div class="sfly-wgt-tooltip-choose-size-title">12x12</div>\n        </li>\n        <li class="sfly-wgt-book-choose-size <%= size == \'33\' ? \'sfly-wgt-book-choose-size-selected\' : \'\' %>" data-code="33">\n            <div class="sfly-wgt-tooltip-choose-size-title">Desk Calendar</div>\n        </li>\n    </ul>\n</div>';});


define('text!app/templates/popup/photobook_tooltip.html',[],function () { return '<!-- Note: order of tooltip item is important! -->\n<div>\n    <ul class="sfly-wgt-tooltip-list">\n        <li class="sfly-wgt-book-choose-size <%= size == \'8x8\' ? \'sfly-wgt-book-choose-size-selected\' : \'\' %>" data-code="8x8">\n            <div class="sfly-wgt-tooltip-choose-size-title">8x8</div>\n        </li>\n        <li class="sfly-wgt-book-choose-size <%= size == \'8x11\' ? \'sfly-wgt-book-choose-size-selected\' : \'\' %>" data-code="8x11">\n            <div class="sfly-wgt-tooltip-choose-size-title">8x11</div>\n        </li>\n        <li class="sfly-wgt-book-choose-size <%= size == \'11x14\' ? \'sfly-wgt-book-choose-size-selected\' : \'\' %>" data-code="11x14">\n            <div class="sfly-wgt-tooltip-choose-size-title">11x14</div>\n        </li>\n    </ul>\n</div>\n\n';});


define('text!app/templates/popup/photobook_icon.html',[],function () { return '<%\n    var split_arr = bookSize.split(\'x\');\n    var width = split_arr[1];\n    var height = split_arr[0];\n    var factor = 5; // how many pixels per book size (in inc.)\n    var pages__border_left_width = factor*width-5;\n    var pages_hider__left = -pages__border_left_width -2;\n    var core__width = factor*width - 4;\n    var core__height = factor*height - 4;\n    var spine__height = factor*height;\n%>\n<div class="sfly-wgt-book-icon-wrapper">\n    <div class="sfly-wgt-book-icon">\n        <div class="sfly-wgt-book-icon-pages" style="border-left-width: <%= pages__border_left_width %>px;" >\n            <div class="sfly-wgt-book-icon-pages-hider" style="border-left-width: <%= pages__border_left_width %>px; left: <%= pages_hider__left %>px"></div>\n        </div>\n        <div class="sfly-wgt-book-icon-core" style="width: <%= core__width %>px; height: <%= core__height %>px">\n            <div class="sfly-wgt-book-icon-core-size-label"><%= bookSize %></div>\n        </div>\n        <div class="sfly-wgt-book-icon-spine" style="height: <%= spine__height %>px"></div>\n    </div>\n    <div class="sfly-wgt-book-icon-price"><%= priceText %></div>\n</div>';});


define('text!app/templates/listview/listview_container_textual.html',[],function () { return '<div class="sfly_wgt_textual_wrapper use-new-style-guide" data-prodtype="<%= prodType %>">\n    <% var idx = 0; %>\n    <% _.each(Object.keys(model), function(category) { %>\n        <% var areaClass = (idx+1) == Object.keys(model).length ? "right" : "" %>\n        <% var menuClass = category.toLowerCase() == \'prints\' ? "floatLeft" : "" %>\n        <div class="sfly_wgt_textual_area <%= areaClass %>" data-category="<%= category.toLowerCase() %>">\n            <h5 class="sfly_wgt_textual_title"><%= category %></h5>\n            <div class="sfly_wgt_textual_area_menu <%= menuClass %>">\n                <ul>\n                <% var prodIdx = 0 %>\n                <% _.each(model[category], function(prod) { %>\n                    <% var prodClass = prodIdx == 0 ? \'hover\' : \'\' %>\n                    <li data-sku="<%= prod[\'sku\'] %>" data-pid="<%= prod[\'sku\'] %>" data-ptype="<%= prod[\'title\'] %>" class="<%= prodClass %>"><%= prod[\'title\'] %></li>\n                    <% prodIdx++ %>\n                <% }) %>\n                </ul>\n            </div>\n            <div class="sfly_wgt_textual_product_placeholder" data-forcat="<%= category %>"></div>\n        </div>\n    <% idx++ %>\n    <% }) %>\n</div>';});


define('text!app/templates/listview/listview_textual_print_button.html',[],function () { return '<div class="sfly_wgt_textual_order_prints sfly-wgt-orange-btn-sfly" data-pid="prints_4x6" data-sku="4x6">\n    ORDER PRINTS\n</div>\n<br style="clear:both;"/>\n<div class="sfly_wgt_textual_order_prints_info">\n    4x4, 4x6, 5x7 and more...\n</div>';});


define('text!app/templates/listview/listview_textual_print_button_auto.html',[],function () { return '<div class="sfly_wgt_textual_order_prints sfly-wgt-orange-btn-sfly" data-pid="prints_4x6" data-sku="4x6">\n    ORDER PRINTS\n</div>\n<br style="clear:both;"/>\n<div class="sfly_wgt_textual_order_prints_info">\n    4x4, 4x6, 5x7 and more...\n</div>';});


define('text!app/templates/popup/bookmodal_title.html',[],function () { return '<% if(typeof isStoryBook === "boolean" && isStoryBook === true) { %>\n    <h2>Personalized Story Book</h2>\n    <h4 class="price-wrapper">\n        <%= typeof pages !== \'undefined\' ? pages + \' Pages\' : \'\' %><% if (price.salePrice > -1) { %><span>, from </span><span class="price-old">$<%= parseFloat(price.originalPrice).toFixed(2) %></span> <span class="price-sale">$<%= parseFloat(price.salePrice).toFixed(2) %><%= coupon != false ? \' Code: \'+coupon : \'\' %></span><% } else if (price.originalPrice > 0) { %><span>, from $<%= parseFloat(price.originalPrice).toFixed(2) %></span><% } %>\n    </h4>\n<% } else if (isMobile) { %>\n    <h2><%= size %> Photo Book </h2>\n    <h3><%= typeof pages !== \'undefined\' ? pages + \' Pages\' : \'\' %>, <%= style %></h3>\n    <h4 class="price-wrapper">\n        <% if (price.salePrice > -1) { %><span></span><span class="price-old">$<%= parseFloat(price.originalPrice).toFixed(2) %></span> <span class="price-sale">$<%= parseFloat(price.salePrice).toFixed(2) %><%= coupon != false ? \' Code: \'+coupon : \'\' %></span><% } else if (price.originalPrice > 0) { %><span>$<%= parseFloat(price.originalPrice).toFixed(2) %></span><% } %>\n    </h4>\n<% } else if (typeof hasModalMenu !== \'undefined\' && hasModalMenu) { %>\n    <h2 class="photobook-modal-title">Photo Book <%= size %></h2>\n    <h4 class="photobook-modal-sub-title"><span class="sub-title-page-num"><%= typeof pages !== \'undefined\' ? pages + \' pages, \' : \'\' %></span><%= typeof style !== \'undefined\' ? style + \', \' : \'\' %></h4>\n    <h4 class="price-wrapper">\n        <% if (price.salePrice > -1) { %><span>from </span><span class="price-old">$<%= parseFloat(price.originalPrice).toFixed(2) %></span> <span class="price-sale">$<%= parseFloat(price.salePrice).toFixed(2) %><%= coupon != false ? \' Code: \'+coupon : \'\' %></span><% } else if (price.originalPrice > 0) { %><span>from $<%= parseFloat(price.originalPrice).toFixed(2) %></span><% } %>\n    </h4>\n<% } else { %>\n    <h2>Photobook <%= size %> - <%= style %></h2>\n    <h4 class="price-wrapper">\n        <%= typeof pages !== \'undefined\' ? pages + \' Pages\' : \'\' %><% if (price.salePrice > -1) { %><span>, from </span><span class="price-old">$<%= parseFloat(price.originalPrice).toFixed(2) %></span> <span class="price-sale">$<%= parseFloat(price.salePrice).toFixed(2) %><%= coupon != false ? \' Code: \'+coupon : \'\' %></span><% } else if (price.originalPrice > 0) { %><span>, from $<%= parseFloat(price.originalPrice).toFixed(2) %></span><% } %>\n    </h4>\n<% } %>';});


define('text!app/templates/popup/calendarmodal_title.html',[],function () { return '<%  if (typeof hasModalMenu !== \'undefined\' && hasModalMenu) { %>\n    <h2 class="calendar-modal-title">Calendar <%= sizeTitle %></h2>\n    <h4 class="calendar-modal-sub-title"><span class="sub-title-page-num"><%= typeof months !== \'undefined\' ? months + \' months, \' : \'\' %></span><%= typeof style !== \'undefined\' ? style + \', \' : \'\' %></h4>\n    <h4 class="price-wrapper">\n        <% if (price.salePrice > -1) { %><span>from </span><span class="price-old">$<%= parseFloat(price.originalPrice).toFixed(2) %></span> <span class="price-sale">$<%= parseFloat(price.salePrice).toFixed(2) %><%= coupon != false ? \' Code: \'+coupon : \'\' %></span><% } else if (price.originalPrice > 0) { %><span>from $<%= parseFloat(price.originalPrice).toFixed(2) %></span><% } %>\n    </h4>\n<% } else { %>\n\n    <h2><%= sizeTitle == \'5x11\' ? \'Desk Calendar\' : \'Calendar \' + sizeTitle %> - <%= style %></h2>\n    <h4 class="price-wrapper">\n        <%= typeof months !== \'undefined\' ? months + \' Months\' : \'\' %><% if (price.salePrice > -1) { %><span>, from </span><span class="price-old">$<%= parseFloat(price.originalPrice).toFixed(2) %></span> <span class="price-sale">$<%= parseFloat(price.salePrice).toFixed(2) %><%= coupon != false ? \' Code: \'+coupon : \'\' %></span><% } else if (price.originalPrice > 0) { %><span>, from $<%= parseFloat(price.originalPrice).toFixed(2) %></span><% } %>\n    </h4>\n<% } %>';});


define('text!app/templates/popup/modal_left_pane.html',[],function () { return '<div class="sfly-wgt-modal-sub-menu-content">\n    <% _.each(products, function(category, categoryTitle) { %>\n        <ul class="sfly-wgt-left-pane-category">\n            <div class="sfly-wgt-left-pane-category-title"><%= categoryTitle %></div>\n            <% _.each(category, function(product) {\n                var prodTitle = product.title;\n                var prodSku = product.sku;\n                %>\n                <li class="sfly-wgt-left-pane-category-product <%= currentProduct == prodTitle ? \'sfly-wgt-left-pane-category-product-selected\' : \'\' %>" data-sku="<%= prodSku %>" data-order="0">\n                    <div class="sfly-wgt-left-pane-category-product-title"><%= prodTitle %></div>\n                </li>\n            <% }); %>\n        </ul>\n    <% }); %>\n</div>';});


define('text!app/templates/send_link_widget.html',[],function () { return '<div class="widget-send-link" id="sfly-wgt-send-link">\n    <div class="send-link-form">\n        <div class="info">\n            <div class="info-text">Unlimited free prints. A Shutterfly app exclusive</div>\n            <div class="send-to-phone">\n                <input type="text" class="phone-input" placeholder="Phone number" />\n                <span class="send-link-btn send" id="sendPhone">\n                    <span class="send">SEND</span>\n                </span>\n                <div class="warning-icon"></div>\n                <div class="warning-tooltip"></div>\n            </div>\n        </div>\n    </div>\n    <div class="success-overlay">\n        <div class="phone-number-container">\n            <div class="checkcircle"></div>\n            <div class="phone-number"></div>\n        </div>\n        <div class="wrong-number">Wrong number?</div>\n    </div>\n</div>';});


define('text!app/templates/fullview/fullview_prints_banner.html',[],function () { return '<div class="sfly_banner_free_prints sfly_wgt_product_banner">\n</div>\n';});


define('text!app/templates/fullview/fullview_new_banner.html',[],function () { return '<div class="sfly_banner_new_badge"></div>\n';});

/*
The templates module can be considered a template repository. The templates are underscore based
and will be loaded using the 'text' plugin for require.js.
 */
define('app/templates', [
        'text!./templates/listview/listview_container.html',
        'text!./templates/listview/listview_container_horiz.html',
        'text!./templates/listview/listview_container_tlVertic.html',
        'text!./templates/listview/listview_container_gifting.html',
        'text!./templates/fullview/fullview_product.html',
        'text!./templates/fullview/fullview_product_price.html',
        'text!./templates/fullview/no_photos.html',
        'text!./templates/fullview/fullview_prod_hover.html',
        'text!./templates/fullview/fullview_prod_hover_tl.html',
        'text!./templates/listview/listview_product_price.html',
        'text!./templates/listview/listview_product_title.html',
        'text!./templates/listview/listview_product_price_inner.html',
        'text!./templates/listview/listview_spread_nav.html',
        'text!./templates/fullview/fullview_calendar_nav.html',
        'text!./templates/fullview/fullview_calendar_nav_horiz.html',
        'text!./templates/fullview/fullview_book_nav.html',
        'text!./templates/fullview/fullview_prod_price_nav.html',
        'text!./templates/sidemodule/sidemodule_product_price.html',
        'text!./templates/misc/transfer_modal.html',
        'text!./templates/misc/transfer_animation.html',
        'text!./templates/sidemodule_books/booksmodal.html',
        'text!./templates/sidemodule_books/button_closeopen.html',
        'text!./templates/sidemodule_books/info_window.html',
        'text!./templates/sidemodule_books/style_product.html',
        'text!./templates/fullview/fullview_book_paging.html',
        'text!./templates/fullview/fullview_prints_paging.html',
        'text!./templates/fullview/fullview_calendar_paging.html',
        'text!./templates/sidemodule_prints/printsmodal.html',
        'text!./templates/sidemodule_products/productsmodal.html',
        'text!./templates/sidemodule/albumchange.html',
        'text!./templates/sidemodule/help_title.html',
        'text!./templates/sidemodule/signin_message.html',
        'text!./templates/sidemodule/upload_message.html',
        'text!./templates/sidemodule/upload_message_popup.html',
        'text!./templates/sidemodule/upload_embedded_message.html',
        'text!./templates/sidemodule/static_books_filler.html',
        'text!./templates/sidemodule/static_products_filler.html',
        'text!./templates/sidemodule/static_calendar_filler.html',
        'text!./templates/sidemodule/static_cns_filler.html',
        'text!./templates/popup/static_mg_filler.html',
        'text!./templates/sidemodule_calendar/calendar_modal.html',
        'text!./templates/popup/productsmodal.html',
        'text!./templates/popup/booksmodal.html',
        'text!./templates/popup/printsmodal.html',
        'text!./templates/sidemodule/spread_container.html',
        'text!./templates/misc/scroller.html',
        'text!./templates/popup/calendarmodal.html',
        'text!./templates/popup/embedded_title.html',
        'text!./templates/popup/embedded_title_flex.html',
        'text!./templates/popup/tl_embedded_title.html',
        'text!./templates/popup/embedded_signout_title.html',
        'text!./templates/popup/embedded_homepage_no_title.html',
        'text!./templates/popup/embedded_homepage_no_photos.html',
        'text!./templates/listview/listview_arrows.html',
        'text!./templates/sidemodule_products/placeholder.html',
        'text!./templates/popup/new_upp_bubble.html',
        'text!./templates/popup/upp_bubble_hp.html',
        'text!./templates/misc/flyout_store.html',
        'text!./templates/misc/flyout_store_no_photos.html',
        'text!./templates/misc/flyout_store_welcome.html',
        'text!./templates/popup/loadmore.html',
        'text!./templates/popup/products_tooltip.html',
        'text!./templates/popup/products_left_pane.html',
        'text!./templates/popup/calendar_tooltip.html',
        'text!./templates/popup/photobook_tooltip.html',
        'text!./templates/popup/photobook_icon.html',
        'text!./templates/listview/listview_container_textual.html',
        'text!./templates/listview/listview_textual_print_button.html',
        'text!./templates/listview/listview_textual_print_button_auto.html',
        'text!./templates/popup/bookmodal_title.html',
        'text!./templates/popup/calendarmodal_title.html',
        'text!./templates/popup/modal_left_pane.html',
        'text!./templates/send_link_widget.html',
        'text!./templates/fullview/fullview_prints_banner.html',
        'text!./templates/fullview/fullview_new_banner.html'
    ],
    function(listview_ctr, listview_ctr_horiz, listview_ctr_tlVert, listview_ctr_gifting, fullview_prod, fullview_prod_price, no_photos, fullview_prod_hover, fullview_prod_hover_tl,
             listview_pprice,listview_ptitle, listview_pprice_inner, listview_spread_nav, calendar_nav, calendar_nav_horiz, book_nav, prod_price_nav, sidemodule_product_price,
             transfer_modal, transfer_animation, side_booksmodal, side_button_closeopen,
             side_info_win, side_style_product, side_book_paging, side_prints_paging, side_calendar_paging, side_printsmodal,
             side_productsmodal, albumchange, help_title, signin_msg, upload_msg, upload_msg_popup, upload_msg_embedded, static_books_filler, static_prods_filler, static_cal_filler, static_cns_filler, static_mg_filler, cal_modal,
             popup_productsmodal, popup_booksmodal, popup_printsmodal, side_spread_cont, scroller, popup_calendarmodal,
             embedded_title_hor, embedded_title_flex_hor, tl_embedded_title_hor, embedded_title_signout, embedded_hp_no_title, embedded_hp_no_photos, listview_arrows, popup_prod_placeholder, new_upp_bubble, upp_bubble_hp, store_flyout, store_flyout_no_photos, store_flyout_welcome,
             popup_loadmore, popup_products_tooltip, popup_products_left_pane, popup_calendar_tooltip, popup_photobook_tooltip, popup_photobook_icon,
             listview_textual_container, listview_textual_prints_btn, listview_textual_prints_auto_btn, popup_booksmodal_title, popup_calendarmodal_title,
             modal_leftpane, send_link_widget, fullview_prints_banner, fullview_new_banner
        ) {
       return {
           fullview_product:    fullview_prod,
           fullview_product_price:fullview_prod_price,
           fullview_prod_hover: fullview_prod_hover,
           fullview_prod_hover_tl: fullview_prod_hover_tl,
           fullview_no_photos: no_photos,
           listview_container:  listview_ctr,
           listview_cont_horiz: listview_ctr_horiz,
           listview_cont_tlVert: listview_ctr_tlVert,
           listview_prod_price: listview_pprice,
           listview_prod_title: listview_ptitle,
           listview_pprice_inr: listview_pprice_inner,
           listview_spread_nav: listview_spread_nav,
           listview_arrows:     listview_arrows,
           listview_gifting:    listview_ctr_gifting,
           listview_textual_container: listview_textual_container,
           listview_textual_prints_btn: listview_textual_prints_btn,
           listview_textual_prints_auto_btn: listview_textual_prints_auto_btn,
           side_productsmodal:  side_productsmodal,
           side_printsmodal:    side_printsmodal,
           side_calendarmodal:  cal_modal,

           side_booksmodal:     side_booksmodal,
           side_books_button:   side_button_closeopen,
           side_info_window:    side_info_win,
           side_style_product:  side_style_product,
           side_book_paging:    side_book_paging,
           side_prints_paging:  side_prints_paging,
           side_calendar_paging:side_calendar_paging,
           side_albumswitch:    albumchange,
           side_help_title:     help_title,
           side_signin_msg:     signin_msg,
           side_upload_msg:     upload_msg,
           side_upload_msg_popup:upload_msg_popup,
           side_product_price: sidemodule_product_price,
           upload_msg_embedded: upload_msg_embedded,
           side_static_books:   static_books_filler,
           side_static_prods:   static_prods_filler,
           side_static_cal:     static_cal_filler,
           side_static_cns:     static_cns_filler,
           side_static_mg:      static_mg_filler,

           side_spread_cont:    side_spread_cont,
           mg_embd_title:       embedded_title_hor,
           mg_embd_title_flex: embedded_title_flex_hor,
           tl_mg_embd_title:     tl_embedded_title_hor,
           mg_embd_signout_title:embedded_title_signout,
           mg_homepage_no_title: embedded_hp_no_title,
           mg_homepage_no_photos: embedded_hp_no_photos,

           popup_productsmodal: popup_productsmodal,
           popup_booksmodal:    popup_booksmodal,
           popup_printsmodal:   popup_printsmodal,
           popup_calendarmodal: popup_calendarmodal,
           popup_placeholder:   popup_prod_placeholder,
           popup_loadmore:      popup_loadmore,
           new_upp_bubble:      new_upp_bubble,
           upp_bubble_hp:       upp_bubble_hp,
           popup_products_tooltip: popup_products_tooltip,
           popup_products_left_pane: popup_products_left_pane,
           popup_calendar_tooltip: popup_calendar_tooltip,
           popup_photobook_tooltip: popup_photobook_tooltip,
           popup_photobook_icon: popup_photobook_icon,
           popup_booksmodal_title: popup_booksmodal_title,
           popup_calendarmodal_title: popup_calendarmodal_title,
           popup_leftpane:      modal_leftpane,

           calendar_nav:        calendar_nav,
           calendar_nav_horiz:  calendar_nav_horiz,
           book_nav:            book_nav,
           prod_price_nav:      prod_price_nav,
           click_through_modal: transfer_modal,
           click_through_anim:  transfer_animation,
           scroller:            scroller,
           store_flyout:        store_flyout,
           store_flyout_no_photos:store_flyout_no_photos,
           store_flyout_welcome:store_flyout_welcome,
           send_link_widget: send_link_widget,
           fullview_prints_banner: fullview_prints_banner,
           fullview_new_banner_badge: fullview_new_banner
       }
});
/*
This module assumes Omniture is installed as the 's' namespace.
 */

define("app/tracking", ['app/cache_module'], function(cache) {
    var SFLY_LINK_PAGE          = '/photo-books?c=18970';
    // var SFLY_SIDE_PREFIX        = 'magic shop:sidebar:';
    var SFLY_SIDE_PREFIX        = 'MagicShop:sidebar:';
    var SFLY_OPEN_PREFIX        = 'MagicShop:';

    //todo: new DTL report
    // var SFLY_SIDE_PREFIX        = 'magic shop:';
    // var SFLY_OPEN_PREFIX        = 'magic shop:';
    var IS_DEBUG_DONT_SEND      = false;

    /*
    Check if the omniture library exists
    @return boolen - true if yes, false if not
     */
    function _omnitureExists() {
        // window.s = {};
        // window.putOmnitureJSPData = function() {}
        // window.removeOmnitureJSPData = function() {}
        // window.processOmnitureJSPData = function() {}
        //
        // return true;
        return ((typeof window.s !== 'undefined') || (typeof(window.putOmnitureJSPData) === 'function'));
    }

    function getCorrectLinkPage(params) {
        var widgetPage  = typeof params !== "undefined" && typeof params['prod_type'] !== "undefined" ? params['prod_type'] : cache.get('prod_type');
        var mode        = typeof params !== "undefined" && typeof params['mode'] !== "undefined" ? params['mode'] : cache.get('mode');

        if(mode == "gifting" || mode == "gifting_gm") {
            return "sflyphotos/appgifting";
        } else if(mode == "instance") {
            // This code is specific to ThisLife
            if(typeof ThisLife !== "undefined" && typeof ThisLife.app !== "undefined" && typeof ThisLife.app.currentState !== "undefined" && typeof ThisLife.app.currentState.fragment !== "undefined") {
                var isSelectionActive = (typeof ThisLife.app.controller !== "undefined" && typeof ThisLife.app.controller('selection') !== "undefined" ? ThisLife.app.controller('selection').isActive() : false);
                var suffix = isSelectionActive? "/Select" : "";

                // Special case for shareIntercept
                var shareWidgets = ["photobook_share", "prints_share", "photogifts_share"];
                if (shareWidgets.indexOf(widgetPage) > -1) {
                    suffix = "/ShareIntercept";
                }
                
                return 'sflyphotos/app' + ThisLife.app.currentState.fragment.split("/")[0] + suffix;
            } else {
                return '/';
            }
        } else {
            switch (widgetPage) {
                case 'photobook':
                    return '/photo-books?c=18970';
                    break;
                case 'prints':
                    return '/prints?c=1096392';
                    break;
                case 'cns':
                    return '/c-s?c=60000';
                    break;
                case 'photogifts':
                    return '/photo-gifts?c=1083998';
                    break;
                case 'homedecor':
                    return '/home-decor?c=1091982';
                    break;
                case 'calendar':
                    return '/calendars?c=10014';
                    break;
                case 'specialoffers':
                    return '/special-offers?c=1085970';
                    break;
                case 'mysfly':
                    return '/home/myshutterfly.sfly';
                    break;
                case 'homepage':
                    return '/entry/home.sfly?mode=' + mode;
                    break;
                case 'cross_sell':
                    return '/order/recommendations.sfly';
                    break;
                default:
                    if (mode == 'store') {
                        return '/store?c=1107182'
                    }
                    return '/';
                    break;
            }
        }
    }
    
    function getWidgetPageAbbr(widgetPage) {
        switch(widgetPage) {
            case 'photobook':
                return 'PB';
            case 'prints':
                return 'Prints';
            case 'cns':
                return 'CS';
            case 'photogifts':
                return 'PG';
            case 'homedecor':
                return 'HD';
            case 'calendar':
                return 'Cal';
            case 'homepage':
                return 'Home';
            default:
                return '';
        }
    }

    function getCorrectLModule(params) {
        var widgetPage  = typeof params !== "undefined" && typeof params['prod_type'] !== "undefined" ? params['prod_type'] : cache.get('prod_type');
        var mode        = typeof params !== "undefined" && typeof params['mode'] !== "undefined" ? params['mode'] : cache.get('mode');

        if(mode == "gifting" || mode == "gifting_gm") {
            switch (widgetPage) {
                case 'homepage':
                    return 'Sflyphotos-Gifting/MagicShop';
                    break;
                default:
                    return '';
                    break;
            }
        } else if(mode == "instance") {
            switch(widgetPage) {
                case 'photobook':
                    return 'Sflyphotos-PB/MagicShop';
                    break;
                case 'prints':
                    return 'Sflyphotos-Prints/MagicShop';
                    break;
                case 'cns':
                    return 'Sflyphotos-CS/MagicShop';
                    break;
                case 'photogifts':
                    return 'Sflyphotos-PG/MagicShop';
                    break;
                case 'homedecor':
                    return 'Sflyphotos-HD/MagicShop';
                    break;
                case 'calendar':
                    return 'Sflyphotos-Cal/MagicShop';
                    break;
                case 'homepage':
                    return 'Sflyphotos-Home/MagicShop';
                    break;
                default:
                    return '';
                    break;
            }
        } else {
            switch (widgetPage) {
                case 'photobook':
                    return 'PBCat/MagicShop';
                    break;
                case 'prints':
                    return 'PrintCat/MagicShop';
                    break;
                case 'cns':
                    return 'CSCat/MagicShop';
                    break;
                case 'photogifts':
                    return 'PGCat/MagicShop';
                    break;
                case 'homedecor':
                    return 'HDCat/MagicShop';
                    break;
                case 'calendar':
                    return 'CalCat/MagicShop';
                    break;
                case 'specialoffers':
                    return 'SOCat/MagicShop';
                    break;
                case 'mysfly':
                    return 'MySFLY/MagicShop';
                    break;
                case 'homepage':
                    if (mode == 'mode2') {
                        return 'Home/MagicShop';
                    }
                    return 'HomeCat/MagicShop';
                    break;
                default:
                    if (mode == 'store') {
                        return 'Store/MagicShop'
                    }
                    return '';
                    break;
            }
        }
    }

    return {
        /*
        Track in omniture the given params
        @type   - Type of the widget being tracked (listview, fullview, transfer)
        @target - What action was performed (tab, select_photos, prod_click, prod_hover, on_load, click_through)
        @params - additional parameters
         */
        track: function(type, target, params, waitLoad) {
            // if multiple skus take just the first
            if(typeof params !== "undefined" && typeof params.sku !== "undefined") {
                params.sku = params.sku.split(",")[0];
            }

            var dtlEventLocation = type === 'side' ? "MagicShop Vertical" : "MagicShop Horizontal";

            var event = {
                event : {
                    eventInfo: {
                        eventName: '',
                    },
                    eventDetails: {
                        location: dtlEventLocation
                    }
                }
            };

            var waitLoad = waitLoad || false;
            if (_omnitureExists() || waitLoad) {
                var linkName    = type === 'side' ? SFLY_SIDE_PREFIX : SFLY_OPEN_PREFIX;
                linkName    += type === 'cross_sell' ? 'cross_sell:' : "";
                var mode        = typeof params !== "undefined" && typeof params['mode'] !== "undefined" ? params['mode'] : cache.get('mode');
                var order = "";
                if(mode !== "instance" &&  typeof params !== "undefined"  &&  params.hasOwnProperty('order'))
                {
                    order = ":" + params.order + '_1_1';
                }

                switch(target) {
                    case 'click':
                        event.event.eventInfo.eventName = linkName + 'click';
                        event.event.eventDetails.skus = params.sku;
                        linkName += params.sku;
                        break;
                    case 'hover':
                        event.event.eventInfo.eventName = linkName + 'hover';
                        event.event.eventDetails.skus =  params.sku;
                        linkName = SFLY_OPEN_PREFIX + 'hover-' + params.sku + order;
                        break;
                    case 'static-hover':
                        event.event.eventInfo.eventName = linkName + 'static-hover';
                        event.event.eventDetails.skus =  params.sku;
                        linkName = SFLY_OPEN_PREFIX + 'static-hover-' + params.sku + order;
                        break;
                    case 'learn_more':
                        event.event.eventInfo.eventName = "Learn More";
                        linkName += 'Learn More';
                        break;
                    case 'open_button':
                        event.event.eventInfo.eventName = "Made for you expand";
                        linkName += 'Made for you expand';
                        break;
                    case 'close_button':
                        event.event.eventInfo.eventName = "Made for you minimized";
                        linkName += 'Made for you minimize';
                        break;
                    case 'close_open_button':
                        event.event.eventInfo.eventName = "Made for you Full minimize";
                        linkName += 'Made for you Full minimize';
                        break;
                    case 'personalize':
                        event.event.eventInfo.eventName = linkName + 'click';
                        event.event.eventDetails.skus =  params.sku;
                        linkName = SFLY_OPEN_PREFIX + 'click-' + params.sku + order;
                        break;
                    case 'change_style':
                        event.event.eventInfo.eventName = "Change style";
                        linkName = SFLY_OPEN_PREFIX + 'Change style';
                        break;
                    case 'on_load':
                        event.event.eventInfo.eventName =  linkName + "Load";
                        if (!window.DTLSiteFeatureEnabled) {
                            window.s.prop16 = window.s.eVar43 = getCorrectLinkPage(params) + ' | MagicShop';
                        }
                        break;
                    case 'on_init':
                        event.event.eventInfo.eventName = "Initialization";
                        linkName += 'initialization';
                        break;
                    // case 'on_load_static':
                    //     event.event.eventInfo.eventName = "Load Static";
                    //     linkName += 'static overlay';
                    //     break;
                    case 'on_load_fail':
                        event.event.eventInfo.eventName = "Load fail";
                        linkName += 'load fail';
                        break;
                    case 'on_first_product_load':
                        event.event.eventInfo.eventName = "first product";
                        linkName += 'first product';
                        break;
                    case 'upp' :
                        event.event.eventInfo.eventName = "upp";
                        linkName += 'upp:' + params.sku + ':' + params.action;
                        break;
                    case 'flip_book':
                        event.event.eventInfo.eventName = "flipbook";
                        event.event.eventDetails.skus =  params.page;
                        linkName += 'flipbook-' + params.sku + ':' + params.page;
                        break;
                    case 'book_size_change':
                        event.event.eventInfo.eventName = "booksize";
                        event.event.eventDetails.skus =  params.sku;
                        linkName += 'booksize-' + params.sku;
                        break;
                    case 'flip_cal':
                        event.event.eventInfo.eventName = "flipcal";
                        event.event.eventDetails.skus =  params.page;
                        linkName += 'flipcal-' + params.sku + ':' + params.page;
                        break;
                    case 'cal_size_change':
                        event.event.eventInfo.eventName = "calsize";
                        event.event.eventDetails.skus =  params.sku;
                        linkName += 'calsize-' + params.sku;
                        break;
                    case 'flip_prints':
                        event.event.eventInfo.eventName = "prints-flip";
                        event.event.eventDetails.skus =  params.page;
                        linkName += 'prints-flip:' + params.page;
                        break;
                    case 'mg_arrow':
                        event.event.eventInfo.eventName = "mgarrow";
                        event.event.eventDetails.skus =  params.dir;
                        linkName += 'mgarrow:' + params.dir;
                        break;
                    case 'go_store':
                        event.event.eventInfo.eventName = "go store";
                        linkName += 'go store';
                        break;
                    case 'hover-category':
                    case 'click-product':
                    case 'click-product-style':
                    case 'click-on':
                    case 'click-category':
                        break;
                    default:
                        console.log('[PROD WIDGET] tracking error. Tried to track:', target);
                }

                // specific for tl_horizontal/tl_vertical
                if (mode == 'instance') {
                    var widgetPage  = typeof params !== "undefined" && typeof params['prod_type'] !== "undefined" ? params['prod_type'] : "";
                    var clickTarget  = typeof params !== "undefined" && typeof params['click_target'] !== "undefined" ? params['click_target'] : "";
                    var pid  = typeof params !== "undefined" && typeof params['pid'] !== "undefined" ? params['pid'] : "";
                    var sku  = typeof params !== "undefined" && typeof params['sku'] !== "undefined" ? params['sku'] : "";
                    // protection from multiple SKUs in photobook sku string
                    sku = sku.split(',')[0];
                    sku = sku.replace(/\s+/g, "").replace("'", "");
                    event.event.eventDetails.location = 'photos_photofirst';

                    switch(target) {
                        // this is actually hover-area. TODO: modify that, and in tl-html5
                            //Load Textual
                        case 'hover-category':
                            //make sure the magicshop load was sent only once
                            if(!cache.get('trackSent')) {
                                event.event.eventInfo.eventName = 'MagicShop:Load';
                                // linkName = SFLY_OPEN_PREFIX + "popup-" + getWidgetPageAbbr(widgetPage);
                                if (!window.DTLSiteFeatureEnabled) {
                                    window.s.prop16 = window.s.eVar43 = 'MagicShop-' + getWidgetPageAbbr(widgetPage);
                                }
                                cache.set('trackSent', true)
                            }

                            break;
                            //click textual (hover)
                        case 'click-category':
                            event.event.eventInfo.eventName = 'MagicShop:Hover';
                            event.event.eventDetails.eventLocation = params.prod_type + "/" + params.sku;
                            linkName = getWidgetPageAbbr(widgetPage) + ":" + "click-" + sku;
                            if (!window.DTLSiteFeatureEnabled) {
                                window.s.prop16 = window.s.eVar43 = 'MagicShop-' + getWidgetPageAbbr(widgetPage);
                            }
                            break;
                        // case 'hover-textual-category':
                        //     linkName = getWidgetPageAbbr(widgetPage) + ":" + "hover-" + sku;
                        //     if (typeof(window.putOmnitureJSPData) !== 'function') {
                        //         window.s.prop16 = window.s.eVar43 = 'MagicShop-' + getWidgetPageAbbr(widgetPage);
                        //     }
                        //     break;
                        // case 'modal-click-category':
                        //     linkName = getWidgetPageAbbr(widgetPage) + "-modal:" + "click-" + sku;
                        //     if (typeof(window.putOmnitureJSPData) !== 'function') {
                        //         window.s.prop16 = window.s.eVar43 = 'MagicShop-' + getWidgetPageAbbr(widgetPage);
                        //     }
                        //     break;

                            //click modal
                        case 'click-product':
                            event.event.eventInfo.eventName = 'MagicShop:Click';
                            event.event.eventDetails.eventLocation = params.prod_type + "/" + params.sku;
                            event.event.eventDetails.skus = params.pid;
                            linkName = sku + ":" + "click-" + pid;
                            if (!window.DTLSiteFeatureEnabled) {
                                window.s.prop16 = window.s.eVar43 = 'MagicShop-' + getWidgetPageAbbr(widgetPage) + "-" + sku;
                            }
                            break;
                        // case 'click-on':
                        //     linkName = SFLY_OPEN_PREFIX + "click-on-" + clickTarget;
                        //     if (typeof(window.putOmnitureJSPData) !== 'function') {
                        //         window.s.prop16 = window.s.eVar43 = 'MagicShop-' + getWidgetPageAbbr(widgetPage);
                        //     }
                            break;
                    }
                }

                function sendTracking(){

                    var dtlLayer = "";
                    if (typeof(window.putOmnitureJSPData) === 'function') {
                        dtlLayer = window;
                    } else if (window.DTLSiteFeatureEnabled && typeof window.$omnitureDTL === 'object') {
                        dtlLayer = window.$omnitureDTL
                    }

                    if (!dtlLayer) {
                        window.s.prop26 = getCorrectLModule(params);
                        if (target !== 'on_load') {
                            window.s.eVar39 = window.s.prop12 = getCorrectLinkPage(params);
                            window.s.eVar40 = window.s.prop13 = linkName;
                            window.s.eVar41 = window.s.prop14 = getCorrectLinkPage(params) + ' | ' + linkName;
                        } else {
                            window.s.eVar39 = window.s.prop12 = null;
                            window.s.eVar40 = window.s.prop13 = null;
                            window.s.eVar41 = window.s.prop14 = null;
                        }

                        window.s.tl();

                        // reset all variables
                        window.s.prop26 = null;
                        window.s.eVar39 = window.s.prop12 = null;
                        window.s.eVar40 = window.s.prop13 = null;
                        window.s.eVar41 = window.s.prop14 = null;
                        window.s.eVar43 = window.s.prop16 = null;

                    } else {
                        if(window.DTLSiteFeatureEnabled) {
                            dtlLayer.removeOmnitureJSPData(location.origin, 'event');
                        } else {
                            dtlLayer.removeOmnitureJSPData('event');
                        }

                        // Send new DTL event
                        // var event = {
                        //     event : {
                        //         eventInfo: {
                        //             eventName: dtlEventName,
                        //         },
                        //         eventDetails: {
                        //             location: dtlEventLocation
                        //         }
                        //     }
                        // };
                        // if (dtlEventDetails !== "" && mode !== 'instance') {
                        //     event.event.eventDetails['skus'] = dtlEventDetails;
                        // }
                        dtlLayer.processOmnitureJSPData(function() { console.log('clean event buffer') });
                        if(window.DTLSiteFeatureEnabled) {
                            if(event.event.eventInfo.eventName) {
                                dtlLayer.putOmnitureJSPData(location.origin, event);
                            }
                        } else {
                            dtlLayer.putOmnitureJSPData(event);
                        }

                    }

                }

                if (!IS_DEBUG_DONT_SEND) {
                    if(_omnitureExists() && cache.get("partner_user_id") !== "009085953279") {
                        sendTracking();
                    } else if(waitLoad) {
                        var start = Date.now();
                        function timeout() {
                            if(Date.now() - start < 10000) {
                                setTimeout(function () {
                                    if (_omnitureExists() && cache.get("partner_user_id") !== "009085953279") {
                                        sendTracking();
                                    } else {
                                        timeout();
                                    }
                                }, 200);
                            }
                        }
                        timeout();
                    }
                }
            }
        }
    }
});

(function(a){if(typeof exports==="object"){module.exports=a()}else{if(typeof define==="function"&&define.amd){define('md5',a)}else{var c;try{c=window}catch(b){c=self}c.SparkMD5=a()}}}(function(c){var e=function(s,r){return(s+r)&4294967295},n=function(z,v,u,r,y,w){v=e(e(v,z),e(r,w));return e((v<<y)|(v>>>(32-y)),u)},a=function(v,u,A,z,r,y,w){return n((u&A)|((~u)&z),v,u,r,y,w)},k=function(v,u,A,z,r,y,w){return n((u&z)|(A&(~z)),v,u,r,y,w)},f=function(v,u,A,z,r,y,w){return n(u^A^z,v,u,r,y,w)},p=function(v,u,A,z,r,y,w){return n(A^(u|(~z)),v,u,r,y,w)},d=function(s,u){var t=s[0],r=s[1],w=s[2],v=s[3];t=a(t,r,w,v,u[0],7,-680876936);v=a(v,t,r,w,u[1],12,-389564586);w=a(w,v,t,r,u[2],17,606105819);r=a(r,w,v,t,u[3],22,-1044525330);t=a(t,r,w,v,u[4],7,-176418897);v=a(v,t,r,w,u[5],12,1200080426);w=a(w,v,t,r,u[6],17,-1473231341);r=a(r,w,v,t,u[7],22,-45705983);t=a(t,r,w,v,u[8],7,1770035416);v=a(v,t,r,w,u[9],12,-1958414417);w=a(w,v,t,r,u[10],17,-42063);r=a(r,w,v,t,u[11],22,-1990404162);t=a(t,r,w,v,u[12],7,1804603682);v=a(v,t,r,w,u[13],12,-40341101);w=a(w,v,t,r,u[14],17,-1502002290);r=a(r,w,v,t,u[15],22,1236535329);t=k(t,r,w,v,u[1],5,-165796510);v=k(v,t,r,w,u[6],9,-1069501632);w=k(w,v,t,r,u[11],14,643717713);r=k(r,w,v,t,u[0],20,-373897302);t=k(t,r,w,v,u[5],5,-701558691);v=k(v,t,r,w,u[10],9,38016083);w=k(w,v,t,r,u[15],14,-660478335);r=k(r,w,v,t,u[4],20,-405537848);t=k(t,r,w,v,u[9],5,568446438);v=k(v,t,r,w,u[14],9,-1019803690);w=k(w,v,t,r,u[3],14,-187363961);r=k(r,w,v,t,u[8],20,1163531501);t=k(t,r,w,v,u[13],5,-1444681467);v=k(v,t,r,w,u[2],9,-51403784);w=k(w,v,t,r,u[7],14,1735328473);r=k(r,w,v,t,u[12],20,-1926607734);t=f(t,r,w,v,u[5],4,-378558);v=f(v,t,r,w,u[8],11,-2022574463);w=f(w,v,t,r,u[11],16,1839030562);r=f(r,w,v,t,u[14],23,-35309556);t=f(t,r,w,v,u[1],4,-1530992060);v=f(v,t,r,w,u[4],11,1272893353);w=f(w,v,t,r,u[7],16,-155497632);r=f(r,w,v,t,u[10],23,-1094730640);t=f(t,r,w,v,u[13],4,681279174);v=f(v,t,r,w,u[0],11,-358537222);w=f(w,v,t,r,u[3],16,-722521979);r=f(r,w,v,t,u[6],23,76029189);t=f(t,r,w,v,u[9],4,-640364487);v=f(v,t,r,w,u[12],11,-421815835);w=f(w,v,t,r,u[15],16,530742520);r=f(r,w,v,t,u[2],23,-995338651);t=p(t,r,w,v,u[0],6,-198630844);v=p(v,t,r,w,u[7],10,1126891415);w=p(w,v,t,r,u[14],15,-1416354905);r=p(r,w,v,t,u[5],21,-57434055);t=p(t,r,w,v,u[12],6,1700485571);v=p(v,t,r,w,u[3],10,-1894986606);w=p(w,v,t,r,u[10],15,-1051523);r=p(r,w,v,t,u[1],21,-2054922799);t=p(t,r,w,v,u[8],6,1873313359);v=p(v,t,r,w,u[15],10,-30611744);w=p(w,v,t,r,u[6],15,-1560198380);r=p(r,w,v,t,u[13],21,1309151649);t=p(t,r,w,v,u[4],6,-145523070);v=p(v,t,r,w,u[11],10,-1120210379);w=p(w,v,t,r,u[2],15,718787259);r=p(r,w,v,t,u[9],21,-343485551);s[0]=e(t,s[0]);s[1]=e(r,s[1]);s[2]=e(w,s[2]);s[3]=e(v,s[3])},q=function(t){var u=[],r;for(r=0;r<64;r+=4){u[r>>2]=t.charCodeAt(r)+(t.charCodeAt(r+1)<<8)+(t.charCodeAt(r+2)<<16)+(t.charCodeAt(r+3)<<24)}return u},m=function(r){var t=[],s;for(s=0;s<64;s+=4){t[s>>2]=r[s]+(r[s+1]<<8)+(r[s+2]<<16)+(r[s+3]<<24)}return t},l=function(A){var u=A.length,r=[1732584193,-271733879,-1732584194,271733878],w,t,z,x,y,v;for(w=64;w<=u;w+=64){d(r,q(A.substring(w-64,w)))}A=A.substring(w-64);t=A.length;z=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(w=0;w<t;w+=1){z[w>>2]|=A.charCodeAt(w)<<((w%4)<<3)}z[w>>2]|=128<<((w%4)<<3);if(w>55){d(r,z);for(w=0;w<16;w+=1){z[w]=0}}x=u*8;x=x.toString(16).match(/(.*?)(.{0,8})$/);y=parseInt(x[2],16);v=parseInt(x[1],16)||0;z[14]=y;z[15]=v;d(r,z);return r},o=function(z){var t=z.length,r=[1732584193,-271733879,-1732584194,271733878],v,s,y,w,x,u;for(v=64;v<=t;v+=64){d(r,m(z.subarray(v-64,v)))}z=(v-64)<t?z.subarray(v-64):new Uint8Array(0);s=z.length;y=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(v=0;v<s;v+=1){y[v>>2]|=z[v]<<((v%4)<<3)}y[v>>2]|=128<<((v%4)<<3);if(v>55){d(r,y);for(v=0;v<16;v+=1){y[v]=0}}w=t*8;w=w.toString(16).match(/(.*?)(.{0,8})$/);x=parseInt(w[2],16);u=parseInt(w[1],16)||0;y[14]=x;y[15]=u;d(r,y);return r},j=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"],h=function(u){var t="",r;for(r=0;r<4;r+=1){t+=j[(u>>(r*8+4))&15]+j[(u>>(r*8))&15]}return t},b=function(r){var s;for(s=0;s<r.length;s+=1){r[s]=h(r[s])}return r.join("")},i=function(r){return b(l(r))},g=function(){this.reset()};if(i("hello")!=="5d41402abc4b2a76b9719d911017c592"){e=function(r,u){var t=(r&65535)+(u&65535),s=(r>>16)+(u>>16)+(t>>16);return(s<<16)|(t&65535)}}g.prototype.append=function(r){if(/[\u0080-\uFFFF]/.test(r)){r=unescape(encodeURIComponent(r))}this.appendBinary(r);return this};g.prototype.appendBinary=function(t){this._buff+=t;this._length+=t.length;var s=this._buff.length,r;for(r=64;r<=s;r+=64){d(this._state,q(this._buff.substring(r-64,r)))}this._buff=this._buff.substr(r-64);return this};g.prototype.end=function(t){var w=this._buff,v=w.length,u,s=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],r;for(u=0;u<v;u+=1){s[u>>2]|=w.charCodeAt(u)<<((u%4)<<3)}this._finish(s,v);r=!!t?this._state:b(this._state);this.reset();return r};g.prototype._finish=function(s,w){var u=w,t,v,r;s[u>>2]|=128<<((u%4)<<3);if(u>55){d(this._state,s);for(u=0;u<16;u+=1){s[u]=0}}t=this._length*8;t=t.toString(16).match(/(.*?)(.{0,8})$/);v=parseInt(t[2],16);r=parseInt(t[1],16)||0;s[14]=v;s[15]=r;d(this._state,s)};g.prototype.reset=function(){this._buff="";this._length=0;this._state=[1732584193,-271733879,-1732584194,271733878];return this};g.prototype.destroy=function(){delete this._state;delete this._buff;delete this._length};g.hash=function(t,r){if(/[\u0080-\uFFFF]/.test(t)){t=unescape(encodeURIComponent(t))}var s=l(t);return !!r?s:b(s)};g.hashBinary=function(s,r){var t=l(s);return !!r?t:b(t)};g.ArrayBuffer=function(){this.reset()};g.ArrayBuffer.prototype.append=function(r){var u=this._concatArrayBuffer(this._buff,r),t=u.length,s;this._length+=r.byteLength;for(s=64;s<=t;s+=64){d(this._state,m(u.subarray(s-64,s)))}this._buff=(s-64)<t?u.subarray(s-64):new Uint8Array(0);return this};g.ArrayBuffer.prototype.end=function(t){var w=this._buff,v=w.length,s=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],u,r;for(u=0;u<v;u+=1){s[u>>2]|=w[u]<<((u%4)<<3)}this._finish(s,v);r=!!t?this._state:b(this._state);this.reset();return r};g.ArrayBuffer.prototype._finish=g.prototype._finish;g.ArrayBuffer.prototype.reset=function(){this._buff=new Uint8Array(0);this._length=0;this._state=[1732584193,-271733879,-1732584194,271733878];return this};g.ArrayBuffer.prototype.destroy=g.prototype.destroy;g.ArrayBuffer.prototype._concatArrayBuffer=function(u,s){var t=u.length,r=new Uint8Array(t+s.byteLength);r.set(u);r.set(new Uint8Array(s),t);return r};g.ArrayBuffer.hash=function(r,s){var t=o(new Uint8Array(r));return !!s?t:b(t)};return g}));
define('app/model', ['underscore'], function(_) {
    function Model(attributes) {
        this.attributes = _.clone(attributes) || {};
    }

    Model.prototype = {
        set: function(key, value) {
            if (key != null) {
                this.attributes[key.toLowerCase()] = value;
            }

            return this;
        },

        get: function(key) {
            if (key == null || !this.attributes.hasOwnProperty(key.toLowerCase()) || typeof this.attributes[key.toLowerCase()] === 'undefined') {
                return null;
            }

            return this.attributes[key.toLowerCase()];
        },

        copy: function() {
            return new Model(this.attributes);
        }
    };

    return Model;
});
define('app/thumbgen_wrapper', ['underscore', 'app/utils', 'app/cache_module', 'app/config_manager', 'app/time_monitor'], function(_, utils, cache, config, Monitor) {

    // This is for testing purposes only.
    var env;
    //var serverUrl_beta          = 'https://s3.amazonaws.com/sfly-thumb-assets/' + env + '/{{prod_type}}/skus/';
    var serverUrl;
    var layoutsUrl;
    var missingSkuEndpoint;
    var usedAlternateSkus       = [];
    var remainingFallbackTries  = 6;
    var initUsed                = false;
    var monitor;
    var GET_SKUS_URL, GET_LAYOUTS_URL;

    function init() {
        if (!initUsed) {
            env = cache.get('env');

            serverUrl = (env == 'beta') ? 'https://s3.amazonaws.com/sfly-thumb-assets/' + env + '/{{prod_type}}/skus/' : 'https://d36611kofft9sk.cloudfront.net/' + env + '/{{prod_type}}/skus/';
            layoutsUrl = (env == 'beta') ? 'https://s3.amazonaws.com/sfly-thumb-assets/' + env + '/{{prod_type}}/layouts/' : 'https://d36611kofft9sk.cloudfront.net/' + env + '/{{prod_type}}/layouts/';
            missingSkuEndpoint = env == 'prod' ? 'https://magic-api.photoccino.com/MissingSku' : "https://" + env + "-magic.photoccino.com/MissingSku";
            GET_SKUS_URL = 'https://magicapi' + (env !== "prod" ? "-" + env : "") + '.photoccino.com/assets/getSkus';
            GET_LAYOUTS_URL = 'https://magicapi' + (env !== "prod" ? "-" + env : "") + '.photoccino.com/assets/getLayouts';
            usedAlternateSkus = [];
            remainingFallbackTries = 6;

            initUsed = true;
            monitor = new Monitor(cache.get('mode'));
        }
    }

    function isVersionSupported(versions, version) {
        var found = false;

        versions.forEach(function(v) {
            if (v.name == version) {
                found = true;
            }
        });

        return found;
    }

    function addVersionToAsset(assetUrl) {
        return assetUrl + '?v=' + config.getAssetsVersion();
    }

    var missingProductsQueue = [];

    var reportInterval = null;
    var startReportInterval = null;
    function activateReportInterval() {
        if(reportInterval == null) {
            startReportInterval = Date.now();
            reportInterval = setInterval(function () {
                if (missingProductsQueue.length > 0 && (cache.get('full_load') !== undefined || (Date.now() - startReportInterval >= 10*1000))) {
                    if (cache.get('use_pending') == 'false') {
                        $.each(missingProductsQueue, function(i, data) {
                            $.post(missingSkuEndpoint, data, function () {
                                console.log('[Product Widget] Missing SKU reported: ', JSON.parse(data.payload).sku);
                            });
                        });
                    }
                    missingProductsQueue = [];
                    clearInterval(reportInterval);
                    reportInterval = null;
                }
            }, 1000);
        }
    }

    function reportMissingProduct(sku, prodCode, textStatus, errorThrown) {
        var data    = { payload: '{ "sku" : "' + sku + '", "prodCode" : "' + prodCode + '", "mode": "' + cache.get('mode') + '", "prodType": "' + cache.get('prod_type') + '", "uid": "' + cache.get('partner_user_id') + '", "textStatus": "' + textStatus + '", "error": "' + errorThrown + '", "url": "'+window.location.href +'", "user-agent": "'+navigator.userAgent+'"}' };
        missingProductsQueue.push(data);
        activateReportInterval();
    }

    // Can't choose a pId that is in existingPids
    function activateFallbackForNonexistingSku(pId, existingPids) {
        // 1. get size id
        var idParts = pId.split('_');
        var sizeId  = idParts[idParts.length-1];
        var isPBorCalendar = false;

         if(idParts[0] === "pb" || idParts[0] === "cal")
         {
             sizeId  = idParts[0];
             isPBorCalendar = true;
         }

        // 2. see if we support this id, if Id not supported, choose one randomly
        var fallbackMap = config.getProductFallbackMap();
        var newProduct;

        if (typeof fallbackMap === 'undefined' || fallbackMap === undefined) {
            return {
                'sku': '',
                'pId': ''
            }
        }

        if (typeof fallbackMap[sizeId] !== 'undefined') {
            console.log('[Product Widget] Using Alternate product for given SizeID: ', sizeId);

            // Try to find a product that has not been used
            // We might fail at this, so we'll have the latest product used

            //get a random product from the fallback list from 0 to number of products in the list
            var randomID = 0;
            if (fallbackMap[sizeId].length > 1) { //if we have only one product
                randomID = Math.floor(Math.random() * fallbackMap[sizeId].length);
            }

            newProduct = fallbackMap[sizeId][randomID];

        } else {
            console.log('[Product Widget] Looking for random new product');
            var randomSizeId, randomPlace;
            do {
                randomSizeId    = chooseRandomSizeId(fallbackMap, isPBorCalendar);
                randomPlace     = Math.floor(Math.random() * fallbackMap[randomSizeId].length); // Choose random prod under the chosen sizeId
                newProduct      = fallbackMap[randomSizeId][randomPlace];

            } while(_.indexOf(usedAlternateSkus, newProduct.sku) != -1 || _.indexOf(existingPids, config.parseProductId(newProduct)) != -1);
        }

        usedAlternateSkus.push(newProduct.sku);

        if(newProduct.type == "book") { // TEMP - fallback map dont get updated
            newProduct.type = "photobook";
            newProduct.style = newProduct.styleId;
            newProduct.size = newProduct.sizeId;
        } else if(newProduct.type == 'calendar') {
            newProduct.type = "calendar";
            newProduct.style = newProduct.styleId;
            newProduct.size = newProduct.sizeId;
        }


        // Add the product so the gen can find it later
        config.addToProductsJson(newProduct.sku, newProduct);

        return {
            'sku': newProduct.sku,
            'pId': config.parseProductId(newProduct)
        }
    }

    function chooseRandomSizeId(fallbackMap, PBorCalendarAllowed) {
        var sizesIds        = Object.keys(fallbackMap);
        var randomId        = Math.floor(Math.random() * (sizesIds.length - 1)); // Choose random sizeId
        var randomSizeId    = sizesIds[randomId];
        if (!PBorCalendarAllowed && (randomSizeId === "cal" || randomSizeId === "pb")) {
            return chooseRandomSizeId(fallbackMap, PBorCalendarAllowed);
        } else {
            return randomSizeId;
        }
    }

    function chooseOrientationFromLayouts(layoutIds, productType, pId) {
        if (productType != 'prints' && productType != 'book' && productType != 'photobook' && productType != 'calendar') {
            var mainLayout  = layoutIds[0];
            var sizeId      = pId.split('_')[2];

            var res = mainLayout.split("_");
            var orientation;
            // special case:
            if (sizeId == 6 && res[0] != "6")
            {
                orientation = res[0].slice(-1).toLowerCase(); // get last char
            }
            else // any other case
            {
                orientation = res[1].toLowerCase();
            }

            return orientation;
        }

        return 'portrait';
    }

    function getSKUJson(sku, pId, prodType, version, orientation, callback) {

        var cachedSku = cache.getSku(sku);
        if (cachedSku !== null) {
            callback(parseSKUJson(cachedSku, version, orientation));
            return;
        }

        if (remainingFallbackTries <= 0) {
            // We have failed to get fallback products. return null;
            callback(null);
            return;
        }

        var productType = 'products';
        if(prodType == "prints" || prodType == "book" || prodType == "photobook" || prodType == "calendar"){
            productType = prodType;
        }
        if(prodType == "deskcalendar"){
            productType = "calendar";
        }

        var url = (productType == 'book' || productType == "photobook") ? serverUrl.replace('{{prod_type}}', 'photobook') : serverUrl.replace('{{prod_type}}', productType);

        if (cache.get('use_pending') == 'true') {
            url += 'pending/'
        }

        var fileName = url + sku + '.json';
        if (productType == 'book' || productType == "photobook") {
            fileName = url + 'book_' + sku.split('_')[1] + '.json';
        } else if (prodType == 'calendar') {
            fileName = url + 'calendar_' + sku.split('_')[2] + '.json';
        }
        var skuUrl = addVersionToAsset(fileName);

        var retryGetSkuJson = cache.get('mode') == "mode1" || cache.get('mode') == "mode2" ? 2 : 0;
        $.ajax({
            dataType: "json",
            url: skuUrl,
            tryCount : 0,
            retryLimit : retryGetSkuJson,
            prodType: prodType,
            success: function(response) {
                cache.saveSku(sku, response);
                callback(parseSKUJson(response, version, orientation));
            },
            error : function(jqXHR, textStatus, errorThrown ) {
                // retry
                this.tryCount++;
                if (this.tryCount <= this.retryLimit) {
                    //try again
                    console.log('[Product Widget] SkuJson not found (' + sku + '). Retry: '+ this.tryCount);
                    var that = this;
                    setTimeout(function(){$.ajax(that);}, 500);
                    return;
                }

                // if we have a callback after fails run it
                if (_.isFunction(callback)) {
                    //callback(null);
                    monitor.reportEvent('LoadRemoteAssetsFail:SKU', { sku: sku });

                    // Send to monitoring endpoint
                    // reportMissingProduct(sku, '', textStatus, errorThrown);

                    // Try again with a new sku
                    var newProduct = activateFallbackForNonexistingSku(pId);
                    remainingFallbackTries--;

                    console.log('[Product Widget] Product not found (' + sku + '). Looking for new one: ', newProduct);

                    getSKUJson(newProduct.sku, newProduct.pId, prodType, version, orientation, callback);
                }
            }
        });
    }

    function getProductsSKUsJson(skus, skuPids, version, callback) {

        // if (cache.get('use_pending') === 'true') {
        //     url += 'pending/'
        // }

        var skusJsons = {};
        var skusToRequest = [];
        var skusPromisesHolder = {};
        var skusPromises = [];
        skus.forEach(function (sku) {
            skusPromisesHolder[sku] = $.Deferred();
            skusPromises.push(skusPromisesHolder[sku]);
            var cachedSku = cache.getSku(sku);
            if (cachedSku !== null) {
                skusJsons[sku] = parseSKUJson(cachedSku, version, null);
                skusPromisesHolder[sku].resolve();
            } else {
                skusToRequest.push(sku);
            }
        });

        if(skusToRequest.length > 0) {
            $.ajax({
                       type: "POST",
                       url: GET_SKUS_URL,
                       dataType: "json",
                       contentType: "text/plain",
                       timeout: 3000,
                       data: JSON.stringify(skusToRequest),
                       success: function (response) {
                           var skusResponse = Object.keys(response);
                           skusResponse.forEach(function (sku) {
                               function addSku(skuJson) {
                                   skusJsons[sku] = skuJson;
                                   skusPromisesHolder[sku].resolve();
                               }
                               if(typeof response[sku] === "object") {
                                   cache.saveSku(sku, response[sku], false);
                                   addSku(parseSKUJson(response[sku], version, null));
                               } else {
                                   // get from cloudfront
                                   getSKUJson(sku, skuPids[sku], "product", version, null, addSku);
                               }
                           });
                           cache.saveSkuInLocalStorage();
                       },
                       error: function (jqXHR, textStatus, errorThrown) {
                           if (textStatus === "timeout") {
                               monitor.reportEvent('GetProductsSKUsJsonTimeoutFailed', { error: textStatus });
                           } else {
                               monitor.reportEvent('GetProductsSKUsJsonFailed', { error: textStatus });
                           }
                           skus.forEach(function(sku){
                               function addSku(skuJson) {
                                   skusJsons[sku] = skuJson;
                                   skusPromisesHolder[sku].resolve();
                               }
                               // get from cloudfront
                               getSKUJson(sku, skuPids[sku], "product", version, null, addSku);
                           });
                       }
                   });
        }

        $.when.apply(undefined, skusPromises).then(function () {
            callback(skusJsons);
        });
    }

    function parseSKUJson(json, version, orientation) {
        // test input is valid
        if (json == null || typeof json === 'undefined' || version == null || typeof version === 'undefined') {
            return null;
        }

        // Check version is supported
        if (!isVersionSupported(json.supportedVersions, version)) {
            console.log('[Version not supported]');
            return null;
        }

        var productType = json.productInfo.type;

        // in design json replace the {{version}} directive in the paths - to the correct version
        var designJson = JSON.parse(utils.replaceAll(JSON.stringify(json.designJson), '{{version}}', version));

        // Prints has 'portrait' and 'landscape' and we want it as is!
        // All else we want the first one
        if (productType != 'prints' && productType != 'book' && productType != 'photobook' && productType != 'calendar' && productType != 'deskcalendar') {
            orientation = orientation == 'p' ? 'portrait' : 'landscape';
            if (typeof orientation === 'undefined' || orientation == null || !designJson.hasOwnProperty(orientation)) {
                // if no orientation, just take the first one.
                designJson = designJson[Object.keys(designJson)[0]];
            } else {
                designJson = designJson[orientation];
            }
        }

        var localProd = config.getProductBySku(json.productInfo.sku);

        // Needed for backward compliancy
        json.productInfo.sfly_sku   = json.productInfo.sflySku;
        if (typeof localProd !== 'undefined' && localProd.hasOwnProperty('personalizeUrl')) {
            json.productInfo.personalizeUrl   = env == 'prod' ? localProd.personalizeUrl : localProd.personalizeUrl.replace('shutterfly.com', env +'.shutterfly.com');
        }

        json.productInfo.title      = json.productInfo.hasOwnProperty('displayName') && json.productInfo.displayName.length > 0 ? json.productInfo.displayName : json.productInfo.formFactor;

        if (!json.productInfo.hasOwnProperty('seeMoreUrl')) {
            json.productInfo.seeMoreUrl = typeof localProd !== 'undefined' && localProd.hasOwnProperty('seeMoreUrl') ? localProd.seeMoreUrl : '';
        }

        if (typeof localProd !== 'undefined' && localProd.hasOwnProperty('layoutId')) {
            json.productInfo.layoutId   = localProd.layoutId;
        }

        if (typeof localProd !== 'undefined' && localProd.hasOwnProperty('layouts')) {
            json.productInfo.layouts   = localProd.layouts;
        }

        if (typeof localProd !== 'undefined' && localProd.hasOwnProperty('layouts')) {
            json.productInfo.layouts   = localProd.layouts;
        }

        if (typeof localProd !== 'undefined' && localProd.hasOwnProperty('productCode')) {
            json.productInfo.productCode   = localProd.productCode;
        }

        var styles = json.hasOwnProperty('ProductInfoByStyle') ? json.ProductInfoByStyle : {};

        // If calendar, we need to save the styles with the "cal_" prefix, if not already saved so
        if (productType == 'calendar') {
            var keys = Object.keys(styles);
            keys.forEach(function(calId) {
                if (calId.indexOf('cal_') == -1) {
                    styles['cal_' + calId] = styles[calId];
                    delete styles[calId];
                }
            });
        }

        return {
            "designJson": designJson,
            "productInfo": json.productInfo,
            "layoutsInfo": json.layoutsInfo,
            "styles": styles
        }
    }

    function getLayoutJson(sku, layoutInfo, version, productType, layoutIds, callback, originalIds) {
        var layoutUrl       = layoutInfo.layoutFolder;
        var layoutMaskUrl   = layoutInfo.hasOwnProperty('layoutMaskFolder') ? utils.replaceAll(layoutInfo.layoutMaskFolder, '{{version}}', version) : '';
        var layoutJsons     = {};
        var layoutMasks     = {};

        // If we don't have callback, no reason to do anything
        if (_.isFunction(callback)) {
            if (productType == 'book' || productType == 'photobook') {
                // we have just one unified file
                layoutUrl = layoutUrl.replace('{{bookId}}', sku);
                $.getJSON(addVersionToAsset(layoutUrl), function(response) {
                    _.extend(layoutJsons, response);
                    callback({'layoutJson': layoutJsons, 'layoutMasks': layoutMasks});
                }).fail(function() {
                    callback(null);
                });
            } else if (productType == 'calendar' || productType == 'deskcalendar') {
                // we have just one unified file
                layoutUrl = layoutUrl.replace('{{calendarId}}', sku.replace('cal_', ''));
                $.getJSON(addVersionToAsset(layoutUrl), function(response) {
                    _.extend(layoutJsons, response);
                    callback({'layoutJson': layoutJsons, 'layoutMasks': layoutMasks});
                }).fail(function() {
                    callback(null);
                });
            } else {
                var promises = [];

                function getLayoutJson(layoutId) {
                    layoutId = typeof layoutId !== "undefined" ? layoutId : null;
                    var layoutIdUrl = layoutId !== null ? layoutUrl + layoutId + '.json' : layoutUrl + 'layout.json';

                    var deffered = $.Deferred();
                    promises.push(deffered);

                    var layoutIdUrlSplit = layoutIdUrl.split("/");
                    var cachedLayoutId = layoutIdUrlSplit.slice(layoutIdUrlSplit.length - 4).join("/").replace(".json","");
                    var cachedLayout = cache.getLayout(cachedLayoutId);
                    if (cachedLayout !== null) {
                        callback(cachedLayout);
                        return;
                    }

                    $.getJSON(addVersionToAsset(layoutIdUrl), function(response) {
                        if (layoutId === null) {
                            layoutId = Object.keys(response[0])[0];
                            response = response[0][layoutId];
                        }
                        var layout = _.extend({}, response.layout); // make the returned array an object
                        layout["useMask"]       = response.useMask; // useMask is saved on an upper level
                        layout["lWidth"]        = response.lWidth;
                        layout["lHeight"]       = response.lHeight;
                        //if isLanscape attribute exist
                        if(typeof response.isLandscape !== 'undefined') {
                            layout["isLandscape"]   =  response.isLandscape;
                        }

                        if (response.hasOwnProperty('bgColor')) {
                            layout['bgColor'] = response.bgColor;
                        }
                        layoutJsons[layoutId]   = layout;
                        layoutMasks[layoutId]   = layoutMaskUrl + layoutId + '.png';
                        deffered.resolve();
                    }).fail(function() {
                        deffered.reject();
                    })
                }

                if(layoutIds.length === 0) { // Get just the first layout
                    getLayoutJson();
                } else { // Iterate all required Layouts, get the layout json and the layout mask.
                    layoutIds.forEach(function(layoutId) {
                        getLayoutJson(layoutId);
                    });
                }

                // Wait for all layouts to return and then callback with results
                $.when.apply($, promises).then(function() {
                    if (typeof originalIds !== 'undefined' && originalIds.length > 0) {
                        var newKey = Object.keys(layoutJsons)[0];
                        var newLayoutJson = {};
                        newLayoutJson[originalIds[0]] = layoutJsons[newKey];
                        layoutJsons = newLayoutJson;
                        var newLayoutMasks = {};
                        newLayoutMasks[originalIds[0]] = layoutMasks[newKey];
                        layoutMasks = newLayoutMasks;
                    }
                    var finalLayoutJson = {'layoutJson': layoutJsons, 'layoutMasks': layoutMasks};
                    if(layoutIds.length === 1) {
                        cache.saveLayout(layoutIds[0], finalLayoutJson);
                    }
                    if (typeof originalIds !== 'undefined' && originalIds.length > 0) {
                        var layoutIdUrl = layoutUrl + originalIds[0];
                        var layoutIdUrlSplit = layoutIdUrl.split("/");
                        var cachedLayoutId = layoutIdUrlSplit.slice(layoutIdUrlSplit.length - 4).join("/");
                        cache.saveLayout(cachedLayoutId, finalLayoutJson);
                    }
                    callback(finalLayoutJson);
                }).fail(function() {
                    callback(null);
                })
            }
        } else {
            callback(null);
        }
    }

    function getProductsLayoutsJson(skusJsons, version, callback) {

        var layoutsJsons = {};
        var layoutsToRequest = {};
        var layoutsPromisesHolder = {};
        var layoutsPromises = [];
        var skus = Object.keys(skusJsons);
        skus.forEach(function (sku) {

            var splitLayoutId = skusJsons[sku].selectedLayout.split("**");
            var prodIdSplit = splitLayoutId[0].split("_");
            var prodId = prodIdSplit[2] + "/" + prodIdSplit[0] + "/" + prodIdSplit[1];
            var prodStyle = typeof splitLayoutId[1] === "undefined" || splitLayoutId[1] === "" ? "layout" : splitLayoutId[1];
            var layoutId = prodId + "/" + prodStyle;

            layoutsPromisesHolder[layoutId] = $.Deferred();
            layoutsPromises.push(layoutsPromisesHolder[layoutId]);
            var cachedLayout = cache.getLayout(layoutId);
            if (cachedLayout !== null) {
                layoutsJsons[prodStyle === "layout" ? layoutId.replace("layout", Object.keys(cachedLayout['layoutJson'])[0]) : layoutId] = cachedLayout;
                layoutsPromisesHolder[layoutId].resolve();
            } else {
                layoutsToRequest[layoutId] = sku;
            }
        });

        if(Object.keys(layoutsToRequest).length > 0) {
            $.ajax({
                       type: "POST",
                       url: GET_LAYOUTS_URL,
                       dataType: "json",
                       contentType: "text/plain",
                       timeout: 3000,
                       data: JSON.stringify(Object.keys(layoutsToRequest)),
                       success: function (response) {

                           var layoutsResponse = Object.keys(response);
                           layoutsResponse.forEach(function (layout) {
                               var skuOfLayout = layoutsToRequest[layout];
                               var layoutId = layout.split("/").splice(3).join("/");
                               function addLayout(layoutJson) {
                                   layoutsJsons[ /\/layout$/.test(layout) ? layout.replace("layout", Object.keys(layoutJson['layoutJson'])[0]) : layout ] = layoutJson;
                                   layoutsPromisesHolder[layout].resolve();
                               }
                               if(typeof response[layout] === "object") {

                                   var layoutFormatted = _.extend({}, response[layout].layout); // make the returned array an object
                                   layoutFormatted["useMask"]       = response[layout].useMask; // useMask is saved on an upper level
                                   layoutFormatted["lWidth"]        = response[layout].lWidth;
                                   layoutFormatted["lHeight"]       = response[layout].lHeight;
                                   //if isLanscape attribute exist
                                   if(typeof response[layout].isLandscape !== 'undefined') {
                                       layoutFormatted["isLandscape"]   =  response[layout].isLandscape;
                                   }

                                   if (response[layout].hasOwnProperty('bgColor')) {
                                       layoutFormatted['bgColor'] = response[layout].bgColor;
                                   }

                                   if (response[layout].hasOwnProperty('layoutName')) {
                                       layoutId = response[layout].layoutName;
                                   }

                                   var layoutJsons = {}, layoutMasks = {};
                                   var layoutMaskUrl   = skusJsons[skuOfLayout].hasOwnProperty("layoutsInfo") && skusJsons[skuOfLayout].layoutsInfo.hasOwnProperty('layoutMaskFolder') ? utils.replaceAll(skusJsons[skuOfLayout].layoutsInfo.layoutMaskFolder, '{{version}}', version) : '';
                                   layoutJsons[layoutId] = layoutFormatted;
                                   layoutMasks[layoutId] = layoutMaskUrl + layoutId + '.png';
                                   var finalLayoutJson = {'layoutJson': layoutJsons, 'layoutMasks': layoutMasks};
                                   cache.saveLayout(layout, finalLayoutJson, false);
                                   // if we request layout.js save the original layout name too
                                   if (response[layout].hasOwnProperty('layoutName')) {
                                       cache.saveLayout(layout.replace("layout", layoutId), finalLayoutJson, false);
                                   }
                                   addLayout(finalLayoutJson);

                               } else {
                                   // get from cloudfront
                                   var layoutIds = [];
                                   if(layoutId !== "layout") {
                                       layoutIds.push(layoutId);
                                   }
                                   getLayoutJson(skuOfLayout, skusJsons[skuOfLayout].layoutsInfo, version, "products", [], addLayout, layoutIds);
                               }
                           });
                           cache.saveLayoutInLocalStorage();
                       },
                       error: function (jqXHR, textStatus, errorThrown) {
                           if (textStatus === "timeout") {
                               monitor.reportEvent('GetProductsLayoutsJsonTimeoutFailed', { error: textStatus });
                           } else {
                               monitor.reportEvent('GetProductsLayoutsJsonFailed', { error: textStatus });
                           }
                           Object.keys(layoutsToRequest).forEach(function(layout){
                               var skuOfLayout = layoutsToRequest[layout];
                               var layoutId = layout.split("/").splice(3).join("/");
                               var layoutIds = [];
                               if(layoutId !== "layout") {
                                   layoutIds.push(layoutId);
                               }
                               function addLayout(layoutJson) {
                                   layoutsJsons[/\/layout$/.test(layout) ? layout.replace("layout", Object.keys(layoutJson['layoutJson'])[0]) : layout] = layoutJson;
                                   cache.saveLayout(layout, layoutJson);
                                   layoutsPromisesHolder[layout].resolve();
                               }
                               // get from cloudfront
                               getLayoutJson(skuOfLayout, skusJsons[skuOfLayout].layoutsInfo, version, "products", layoutIds, addLayout);
                           })
                       }
                   });
        }

        $.when.apply(undefined, layoutsPromises).then(function () {
            callback(layoutsJsons);
        });
    }

    // Receives a product json and returns the layout Ids requested by the productJson (as an array)
    function getLayoutIdsFromProductJson(productJson, productType) {
        var layoutIds = [];
        // For a book, we will have a unified layout file - no need to get the files
        if (typeof productJson !== 'undefined' && productType != 'book' && productType != 'photobook' && productType != 'calendar') {
            // for now we want to render only the first surfaces for products
            layoutIds.push(productJson.product.surfaces[0].canvas.layout.layoutId)
            // productJson.product.surfaces.forEach(function (surface)
            // {
            //     layoutIds.push(surface.canvas.layout.layoutId);
            // });
        }

        return layoutIds;
    }

    function saveToLocalStorage(sku, result, noLayout) {
        var productType = result.productInfo.type;
        //var pId = config.getProductIdBySku(sku);

        if (productType == 'book' || productType == 'photobook') {
            // We want to save this for all books with the same size
            var currBookSize    = sku.split('_')[1];
            var bookStyles      = Object.keys(result.styles);

            bookStyles.forEach(function(bookStyle) {
                var bookSize    = result.productInfo.size;
                var bookId      = bookStyle + "_" + bookSize;

                var localProd = config.getProductBySku(bookId);

                if (bookSize == currBookSize) {
                    result.productInfo.title        = result.productInfo.size + ' - ' + result.styles[bookStyle].styleName;
                    result.productInfo.style        = result.styles[bookStyle].style; //it is not present in the sku.json
                    result.productInfo.styleName    = result.styles[bookStyle].styleName; //it is not present in the sku.json
                    result.productInfo.static       = result.styles[bookStyle].static; //it is not present in the sku.json
                    result.productInfo.storyBook       = result.styles[bookStyle].hasOwnProperty("storyBook") && result.styles[bookStyle].storyBook === true; //is storyBook?
                    result.productInfo.seeMoreUrl   = typeof localProd !== 'undefined' && localProd.hasOwnProperty('seeMoreUrl') ? localProd.seeMoreUrl : '';

                    if(result.productInfo.storyBook && result.styles[bookStyle].hasOwnProperty("pricingSku")){ //is storyBook? add custom pricing sku
                        result.productInfo.sflySku = result.styles[bookStyle].pricingSku;
                        result.productInfo.sfly_sku = result.styles[bookStyle].pricingSku;
                    }

                    config.addToDesignJson(bookId, result.designJson);
                    config.addToProductsJson(bookId, result.productInfo);

                    if (typeof noLayout === 'undefined' || !noLayout) {
                        config.addToLayoutJson(bookId, result.layoutJson[bookId]);
                    }
                }
            });
        } else {
            config.addToDesignJson(sku, result.designJson);
            if (productType == 'deskcalendar' || productType == 'calendar') {
                result.productInfo.style        = result.styles[sku].style; //it is not present in the sku.json
                result.productInfo.styleName    = result.styles[sku].styleName; //it is not present in the sku.json
                result.productInfo.static       = result.styles[sku].static; //it is not present in the sku.json
                var localProd = config.getProductBySku(sku);
                _.extend(result.productInfo, localProd);
                if (productType == 'calendar') {
                    cache.set('calendars_map', _.extend(cache.get('calendars_map'), result.styles));
                }
            }

            //add layouts to localstorage
            var productInfo = result.productInfo;
            _.extend(productInfo,  result.layoutJson);
            config.addToProductsJson(sku, productInfo);
            config.saveLayoutMasks(result.layoutMasks);

            if (typeof noLayout === 'undefined' || !noLayout) {
                config.addToLayoutJson(sku, result.layoutJson);

                Object.keys(result.layoutJson).forEach(function(layoutId) {
                    _.defer(config.markLoadedProductWithLayout.bind(undefined, sku, layoutId));
                });
            }
        }

        config.markLoadedProduct(sku);
    }

    function getFromLocalStorage(sku, productType) {
        var layoutObject = {};
        if (productType == 'photobook' || productType == 'book') {
            layoutObject[sku] = config.getRecipeLayout()[sku];
        } else {
            layoutObject = config.getRecipeLayout()[sku];
        }

        return {
            layoutJson: layoutObject,
            designJson: config.getRecipeDesign()[sku],
            layoutMasks: config.getLayoutMasks()
        }
    }

    return {
        prepareThumbGenAssets: function(sku, pId, version, productType, productJson, callback) {
            init();

            if (_.isFunction(callback)) {
                var resultObj   = {};

                try {
                    var layoutIds = getLayoutIdsFromProductJson(productJson, productType);
                    var orientation = chooseOrientationFromLayouts(layoutIds, productType, pId);
                } catch (e) {
                    console.log('[Product Widget] Failed using given layout. SKU: ', pId, '(', e, ')');
                    callback(null);
                }

                // Check if all requested layouts are already loaded
                var missingLayoutFound = false;
                layoutIds.forEach(function(layoutId) {
                    if (!config.isProductAndLayoutLoaded(sku, layoutId)) {
                        missingLayoutFound = true;
                    }
                });

                if (!missingLayoutFound && productType != 'book' && productType != 'photobook' && productType != 'calendar') {
                    callback(getFromLocalStorage(sku, productType));
                    console.log('[Product Widget] Using stored product info for:', sku);
                    return;
                }

                //if (config.isProductLoaded(sku)) {
                //    console.log('[Product Widget] Using stored product info');
                //    callback(getFromLocalStorage(sku, productType));
                //    return;
                //}

                getSKUJson(sku, pId, productType, version, orientation, function(result) {
                    if (result != null) {
                        _.extend(resultObj, result);

                        productType = result.productInfo.type;

                        // We might not get the same SKU we asked for and get a fallback. So update the layouts.
                        layoutIds   = getLayoutIdsFromProductJson(productJson, productType);

                        if(productType == 'calendar') {
                            //sku = sku.replace("cal_", "");
                            //cache.set('calendars_map', _.extend(cache.get('calendars_map'), result.styles), true);
                        } else if(productType != 'photobook' && productType != 'book' && productType != 'prints') {
                            sku = result.productInfo.sku;
                        }

                        getLayoutJson(sku, resultObj.layoutsInfo, version, productType, layoutIds, function(layoutData)
                        {
                            if (layoutData != null) {
                                _.extend(resultObj, layoutData);

                                // Save changes to local storage
                                saveToLocalStorage(sku, resultObj);

                                callback(resultObj);
                            } else {
                                monitor.reportEvent('LoadRemoteAssetsFail:Layout', { layouts: layoutIds, sku: sku });
                                console.log('[Product Widget] Failed loading remote Layout', { layouts: layoutIds, sku: sku });
                                callback(null);
                            }
                        });
                    } else {
                        monitor.reportEvent('LoadRemoteAssetsFail:SKU', { sku: sku });
                        console.log('[Product Widget] Failed loading remote SKU', { sku: sku });
                        callback(null);
                    }
                });
            }
        },

        loadProductSKU: function(sku, pId, prodType, version, callback) {
            init();

            getSKUJson(sku, pId, prodType, version, null, function(result) {
                saveToLocalStorage(sku, result, true);
                if (_.isFunction(callback)) {
                    callback();
                }
            });
        },

        getLayoutJson: function(sku, pId, version, productType, layoutIds, callback) {
            init();

            getSKUJson(sku, pId, productType, version, null, function(result) {
                if(result.hasOwnProperty("layoutsInfo")){
                    getLayoutJson(sku, result.layoutsInfo, version, productType, layoutIds, callback);
                } else {
                    callback(null);
                }
            });
        },

        getLayoutsJson: function(skusProducts, version, productType, callback) {
            init();

            if(productType === "products") {
                var skus = Object.keys(skusProducts);
                var skuPids = {};
                skus.forEach(function (sku) {
                    skuPids[sku] = skusProducts[sku].split("**")[0];
                });
                getProductsSKUsJson(skus, skuPids, version, function(result) {
                    var receivedSkus = Object.keys(result);
                    receivedSkus.forEach(function (sku) {
                        if(skusProducts.hasOwnProperty(sku)) {
                            result[sku].selectedLayout = skusProducts[sku];
                        }
                    });
                    getProductsLayoutsJson(result, version, callback);
                });
            } else {
                // TODO: support not products
            }

        },

        // Callback will be called with new SKU if the given not found
        checkSKUExists: function(sku, pId, prodCode, existingPids, version, callback) {
            init();

            console.log('[Product Widget] Check Sku exists:', sku);

            // The book will have a '_'
            var productType = 'product';
            if (pId.indexOf('pb') !== -1) {
                productType = 'book';
            } else if (pId.indexOf('cal') !== -1) {
                productType = 'calendar';
                sku = sku.replace("cal_", "");
            }

            var url;
            if(productType == 'book') {
                url = layoutsUrl.replace('{{prod_type}}', 'photobook');
            } else if(productType == 'calendar'){
                url = layoutsUrl.replace('{{prod_type}}', 'calendar');
            }
            else{
                url = serverUrl.replace('{{prod_type}}', 'products');
            }


            if (cache.get('use_pending') == 'true') {
                url += 'pending/'
            }

            var skuUrl = addVersionToAsset((productType == 'book' || productType == 'calendar') ? url + sku + '/layout.json' : url + sku + '.json');


            $.ajax({
                url: skuUrl,
                type: 'HEAD',
                error: function(jqXHR, textStatus, errorThrown) {
                    // Report missing SKU
                    // reportMissingProduct(sku, prodCode, textStatus, errorThrown);
                    var newProduct = activateFallbackForNonexistingSku(pId, existingPids);

                    console.log('[Product Widget] SKU doesn`t exist (' + sku + '). using new:', newProduct);

                    callback(newProduct.sku, newProduct.pId, productType);
                },
                success: function() {
                    callback(sku, pId, productType);
                }
            })
        },

        replaceGivenSkus: function(missingSkus) {
            // make sure, that the new SKUs are not in the already missing ones
            var newSkus = _.map(missingSkus, function(sku) {
                var newProd = activateFallbackForNonexistingSku(config.getProductIdBySku(sku));

            });
        }
    }
});

/*
 The product proxy is the way to communicate with the product server that will return the project Json.
 As a side effect it will also handle loading prices for the products through sfly servers.
 */

define("app/product_proxy", ['underscore', 'md5', 'app/cache_module', 'app/config_manager', 'app/time_monitor', 'app/cookies', 'app/utils', 'app/model', 'app/thumbgen_wrapper', 'app/globals'], function(_, md5, cache, config, Monitor, cookie, utils, Model, thumbGenWrapper, globals) {
    var env;
    var SERVER_URL;
    var APIKEY;
    var PRICE_URL;
    var MAGIC_URL   = '//magicapi-beta.photoccino.com/';
    var MAGIC_API_URL='//beta-magic.photoccino.com/';
    var PERSON_URL  = '//s3.amazonaws.com/photoccino-personalization/predictions/2016-03-17-run-f/';
    var SFLY_PROMO_URL  = 'productswidget/Shutterfly/sidewidget/promos/{0}/promo.json';
    var COUPON_URL  = 'productswidget/Shutterfly/sidewidget/coupon/{0}/coupon.json';
    var RECIPES_URL  = 'productswidget/Shutterfly/sidewidget/recipes/{0}/';
    var REQUEST_APP_LINK = '//cmd{0}.thislife.com/json';

    var KEY         = '917418fa13822ffc168f016937407f2e';
    var KEY_TL      = 'e60972e6e25250eef243dc2fb5cffdd2';
    var initUsed    = false;
    var monitor;

    var MSG_TYPE_SFLY = {
        "pid": "Web",
        "af_channel": "Web",
        "c": "SFLY_twilio_magiccatalog",
        "is_retargeting": "true"
    };

    var REQUEST_APP_LINK_PARAMS = {
        method: 'message.sendMobileInstallLink',
        params: [],
        headers: {'X-SFLY-SubSource':'library'},
        id: null
    };
    // Should be run on every call
    function init() {
        if (!initUsed) {
            env             = (typeof cache.get('env') !== 'undefined') ? cache.get('env') : 'beta';
            SERVER_URL      = env !== 'prod' ? "https://rank." + env + ".thislife.com/" : 'https://rank.thislife.com/';
            MAGIC_URL       = env !== 'prod' ? 'https://magicapi-' + env + '.photoccino.com/' : 'https://magicapi.photoccino.com/';
            MAGIC_API_URL   = env == 'prod' ? 'https://magic-api.photoccino.com/' : "https://" + env + "-magic.photoccino.com/";
            SFLY_PROMO_URL  = ((env == 'prod' || env == 'stage') ? 'https://d22bbwxztp2lry.cloudfront.net/' : '//s3.amazonaws.com/magicshopfiles/')
                              + utils.formatString(SFLY_PROMO_URL, env);
            COUPON_URL  = ((env == 'prod' || env == 'stage') ? 'https://d22bbwxztp2lry.cloudfront.net/' : '//s3.amazonaws.com/magicshopfiles/')
                              + utils.formatString(COUPON_URL, env);
            RECIPES_URL  = ((env == 'prod' || env == 'stage') ? 'https://d22bbwxztp2lry.cloudfront.net/' : '//s3.amazonaws.com/magicshopfiles/')
                          + utils.formatString(RECIPES_URL, env);

            // request application link to phone
            var subDomain = (env === 'prod') ? '' : '.'.concat(env);
            REQUEST_APP_LINK = utils.formatString(REQUEST_APP_LINK, subDomain);

            initUsed        = true;
            // note: using a new Monitor here will result in the Monitoring GUID being different from other calls,
            // but this reduces complication of passing the Monitoring object into the product_proxy from outside (roman)
            monitor         = new Monitor(cache.get('mode'));
            PRICE_URL   = env === "prod" ? "https://api2.shutterfly.com/v1/pricing-orchestration/price/v1/lookup/itemprice"
                : "https://api2." + env + ".shutterfly.com/v1/pricing-orchestration/price/v1/lookup/itemprice";
            APIKEY      = env === "prod" ? "OIMmm2kTGy2gS1OEjrhsGAuumkHcWP0F" : "T9euP4AI4hSqzqzNHVNeNW0c3imkw0pb";
        }
    }

    function generateProductProjectJson(layouts, photoStrip, userId, prodType) {

        function generateLayoutSurface (layout, type) {

            var layoutId = layout.id.split("**")[1];
            var hasMultiSurface = layoutId.indexOf("|surface");
            var prodStyle = hasMultiSurface !== -1 ? layoutId.substring(0, hasMultiSurface): layoutId;

            // sort photos by well index but actually we need to this in the thumbgen
            layout.photos.sort(function (a, b) {
                return a.wellIndex < b.wellIndex ? -1 : 1;
            });

            return {
                "type": type,
                "canvas": {
                    "layout": {
                        "layoutId": prodStyle,
                        "photos": layout.photos.map(function(photo){
                            var photoRefId;
                            for (var i = 0; i < photoStrip.length; i++) {
                                if (photoStrip[i].photoId === photo.photoId) {
                                    photoRefId = i + 1;
                                    break;
                                }
                            }
                            return {
                                "finalCrop": photo.crop,
                                "photoRefId": photoRefId,
                                "seqNum": photo.wellIndex
                            }
                        }),
                        "textareas": layout.hasOwnProperty("textWells") ? layout.textWells : []
                    }
                }
            }
        }

        var layout = layouts[0];
        var layoutId = layout.id;
        var prodId = layoutId.split("**")[0];
        var prodIdSplit = prodId.split("_");
        var productResponse = {
            "product": {
                "info": {
                    "occasionId": prodIdSplit[0],
                    "styleId": prodIdSplit[1],
                    "sizeId": prodIdSplit[2],
                    "userId": userId,
                    "productType": prodType
                },
                "surfaces": [generateLayoutSurface(layout, "front")],
                "photoStrip": photoStrip
            }
        };

        if (layouts.length > 1) {
            layouts.forEach(function (layout, index) {
                if(index === 0) return;
                productResponse.product.surfaces.push(generateLayoutSurface(layout, "front" + (index+1)))
            })
        }

        return productResponse;
    }

    function generatePrintPageProjectJson(print, photoStrip, index) {
        var photoRefId, orientation;
        for (var i = 0; i < photoStrip.length; i++) {
            if (photoStrip[i].photoId === print) {
                photoRefId = i + 1;
                orientation = photoStrip[i].orientation;
                break;
            }
        }
        return {
            "canvas": {
                "layout": {
                    "backgroundId": "",
                    "layoutId": "4x6_prints_" + orientation,
                    "photos": [
                        {
                            "finalCrop": [0, 0, 1, 1],
                            "photoRefId": photoRefId
                        }
                    ],
                    "photosBehindCanvas": ""
                }
            },
            "orientation": orientation,
            "type": "page",
            "pageNum": index
        }
    }

    function generateMagicSDKLayout (layout, layoutJsonResponse) {
        var layoutName = Object.keys(layoutJsonResponse)[0];
        var layoutJson = layoutJsonResponse[layoutName];

        var layoutSplit = layout.split("/");
        var prodId = layoutSplit[1] + "_" + layoutSplit[2] + "_" + layoutSplit[0];
        var prodStyle = layoutSplit.splice(3).join("/");
        var newLayoutId = prodId + "**" + prodStyle;

        var newLayout = {
            "id": newLayoutId,
            "wells" : []
        };
        Object.keys(layoutJson).forEach(function (key, index) {
            var value = layoutJson[key];
            if(_.isObject(value)){
                var wellType = "image";
                if(value.hasOwnProperty("b")) {
                    wellType = "blocker";
                } else if(value.hasOwnProperty("t")) {
                    wellType = "text";
                } else if(value.hasOwnProperty("e")) {
                    wellType = "embellishment";
                }
                var well = {
                    'wellIndex': index,
                    'type': wellType,
                    'height': (value.hasOwnProperty("h") ? value.h : 0),
                    'width': (value.hasOwnProperty("w") ? value.w : 0),
                    'x': value.hasOwnProperty("x") ? value.x : 0,
                    'y': value.hasOwnProperty("y") ? value.y : 0,
                    'rotation': value.hasOwnProperty("r") ? value.r : 0,
                    'zIndex': value.hasOwnProperty("z") ? value.z: 0
                };

                if(wellType === "text") {
                    well['textArea'] = {
                        "id": value.hasOwnProperty("id") ? value.id : "",
                        "templateText": value.hasOwnProperty("templateText") ? value.templateText : "",
                        "fieldsUsed": value.hasOwnProperty("fieldsUsed") ? value.fieldsUsed : [],
                        "font": {
                            "id": value.hasOwnProperty("areaType") ? value.areaType : "body",
                            "color": value.hasOwnProperty("color") ? value.color : "",
                            "name": value.hasOwnProperty("font") ? value.font : "",
                            "pointSize": value.hasOwnProperty("size") ? value.size : "",
                            "bold": value.hasOwnProperty("bold") ? value.bold : false,
                            "italic": value.hasOwnProperty("italic") ? value.italic : false,
                            "underline": value.hasOwnProperty("underline") ? value.underline : false,
                            "horizontalJustification": value.hasOwnProperty("horizontalJustification") ? value.horizontalJustification : "center",
                            "verticalJustification": value.hasOwnProperty("verticalJustification") ? value.verticalJustification : "middle"
                        }
                    }
                }

                newLayout.wells.push(well);
            } else if(key === "lWidth"){
                newLayout["width"] = value;
            } else if(key === "lHeight"){
                newLayout["height"] = value;
            } else {
                newLayout[key] = value;
            }
        });
        return newLayout;
    }

    function fixProductPhotoStrip(products, isManual) {
        products.forEach(function (product) {
            product = product.product;
            var desiredNumOfPhotosInStrip = !isManual && product['photoStrip'].length > 40 ? 40 : 60;
            if (product['photoStrip'].length > desiredNumOfPhotosInStrip) {
                var usedPhotos = product['surfaces'][0]['canvas']['layout']['photos'];

                //if the product has no photos - just leave the limit
                if (usedPhotos.length === 0) {
                    product['photoStrip'].splice(desiredNumOfPhotosInStrip);
                    return;
                }

                var newPhotoStrip = [],
                    extraPhotos = [];

                // add the used photos to the new photostrip
                product['photoStrip'].forEach(function (photo) {
                    var foundPhoto = _.find(usedPhotos, function (usedPhoto) {
                        if (photo['photoRefId'] === usedPhoto['photoRefId']) {
                            newPhotoStrip.push(photo);
                            return true;
                        }
                        return false;
                    });

                    if (!foundPhoto) {
                        extraPhotos.push(photo);
                    }
                });

                var numOfPhotosToAdd = desiredNumOfPhotosInStrip - newPhotoStrip.length;
                if (numOfPhotosToAdd > 0) {
                    newPhotoStrip = newPhotoStrip.concat(extraPhotos.slice(0, numOfPhotosToAdd));
                }
                product['photoStrip'] = newPhotoStrip;

                newArrangePhotoStrip(product);
            }
        });
    }

    function newArrangePhotoStrip (product) {
        var newPhotoStripOrderMap = {};

        //re-arrange photoStrip
        product['photoStrip'].forEach(function (photoStrip, key) {
            //if the photo is not in the right order
            if(key + 1 !==  photoStrip['photoRefId']) {
                newPhotoStripOrderMap[photoStrip['photoRefId']] = key + 1;
                photoStrip['photoRefId'] = key + 1;
            }
        });

        //re-arrange surfaces
        product['surfaces'].forEach(function (surface) {
            surface['canvas']['layout']['photos'].forEach(function (photoSurface) {
                if (Object.keys(newPhotoStripOrderMap).indexOf('' + photoSurface['photoRefId'] ) !== -1) {
                    photoSurface['photoRefId'] = newPhotoStripOrderMap[photoSurface['photoRefId']];
                }
            });
        });
    }

    //noinspection JSAnnotator
    return {

        /*
         Will get the project Jsons and call the given callback with the response.
         The returned value is a jQuery promise.
         @param array photos
         @param function callback
         @param boolean isManual
         @param array includeProducts - An array of requested products Ids. Can be empty if all are required.
         @param boolean oneRequest - Load all the products using only one api request (use same photos).
         @param boolean isThisLife
         */
        getProducts: function (album, callback, isManual, includeProducts, oneRequest, isThisLife, mixedSources, dontCache, forceGet, useThesePids, importantPhotos)
        {
            init();

            var promises = [];
            var _that = this;
            var useSingleAlbum = !(album.constructor === Array);
            var oneRequest = oneRequest || false;
            var isThisLife = isThisLife || false;
            var mixedSources = mixedSources || false;
            var dontCache = typeof dontCache !== 'undefined' ? dontCache : false;
            var forceGet = typeof forceGet !== 'undefined' ? forceGet : false;
            var isManual = typeof isManual !== 'undefined' ? isManual : false;
            var useFullPhotodata = (useSingleAlbum && !(_.isString(album.photos[0]) || _.isNumber(album.photos[0])));
            var usePids = (typeof useThesePids !== 'undefined' && Array.isArray(useThesePids));
            var products;
            var importantPhotos = importantPhotos || [];

            var userData = {};
            if (typeof window.MagicShop.AddressLabel !== "undefined") {
                userData = window.MagicShop.AddressLabel;
            } else if((typeof Shr !== "undefined" ) && (typeof Shr.U !== 'undefined')) { // if user information is available
                var firstName = Shr.U.firstName;
                var lastName  = Shr.U.lastName;

                if (firstName && lastName) {
                    userData = { first : firstName, last : lastName };
                }
            }

            if (cache.get('mode').indexOf('gifting') > -1) {
                isManual = true;
            }

            if (usePids) {
                products = useThesePids;
            }
            else if (!forceGet && typeof includeProducts !== 'undefined' && _.isArray(includeProducts)) {
                products = config.getProductsBySkus(includeProducts);
            }
            else {
                products = config.getProducts();
            }

            if (products.length === 0) {
                var deferred = $.Deferred();
                deferred.resolve();
                return deferred;
            }

            // if is one request wrap the products in a array so the foreach loop will treat them all togheter
            if (oneRequest) {
                products = [products];
            }

            var i = 0;
            // Support multiple products
            _.each(products, function (product)
            {
                var numOfPhotos = useFullPhotodata ? album.photos.length : (useSingleAlbum ? album.photos : album[i % album.length].photos).length;
                var productString = oneRequest ? _that._prepareProductsString(product, usePids, numOfPhotos, isManual) : _that._prepareProductsString([product], usePids, numOfPhotos, isManual);
                var albumId = useSingleAlbum ? album.albumId : album[i % album.length].albumId;

                var deferred = $.Deferred();
                promises.push(deferred);

                // Prefer cache over requesting again
                var pJson = cache.getProductWithAlbum(albumId, productString);
                // Using a cache
                if (typeof pJson !== "undefined" && pJson !== null) {
                    console.info('[Product Widget] Use cache for the current product');
                    callback(pJson);
                    deferred.resolve();
                }
                else { // Using the rank service

                    var productsLayoutsPromises = [];
                    var allLayouts = [];
                    var albumPhotos = !(album.constructor === Array) ? album.photos : album[0].photos.map(function (photoId) {if (photoId !== 0) { return {"id": photoId}; }});
                    if(typeof albumPhotos[0] === 'string' || typeof albumPhotos[0] === 'number'){
                        albumPhotos = albumPhotos.map(function (photoId) {if (photoId !== 0) {return {"id": photoId};}});
                    }
                    var albumPhotosLength = albumPhotos.length;
                    if(albumPhotosLength > 1000){
                        albumPhotos.splice(0, albumPhotosLength - 1000);
                    }

                    var splitProductStrings = productString.split(",");
                    var productsWrapper = {};
                    product.forEach(function (productOne, index) {
                        productsWrapper[productOne.sku] = splitProductStrings[index];
                    });
                    var deferredLayout = $.Deferred();
                    productsLayoutsPromises.push(deferredLayout);
                    thumbGenWrapper.getLayoutsJson(productsWrapper, "medium","products", function (result) {
                        var layoutNames = Object.keys(result);
                        layoutNames.forEach(function (layout) {
                            var layoutJsonResponse = result[layout].layoutJson;
                            allLayouts.push(generateMagicSDKLayout(layout, layoutJsonResponse));
                        });
                        deferredLayout.resolve();
                    });

                    /* // commented because we're using the new magicAPI endpoint
                    productString.split(",").forEach(function (productQuery, index) {
                        var prodId = productQuery.split("**")[0];
                        var prodStyle = productQuery.split("**")[1];
                        var deferredLayout = $.Deferred();
                        productsLayoutsPromises.push(deferredLayout);
                        thumbGenWrapper.getLayoutJson([product[index].sku], prodId, "medium", "products", prodStyle.length === 0 ? prodStyle : [prodStyle], function(result) {
                            var layoutJsonResponse = result.layoutJson;
                            allLayouts.push(generateMagicSDKLayout(layout, layoutJsonResponse));
                        });
                    });
                    */

                    $.when.apply(undefined, productsLayoutsPromises).then(function() {
                        var magicSDKFitPhotosToLayoutsPromise = [],
                            singleSurfaceLayouts = [],
                            multipleSurfaceLayouts = {};

                        allLayouts.forEach(function (layout) {

                            // if is coaster duplicate 3 times the first layout
                            if (layout.id.indexOf("431**") !== -1) {
                                var styleId = layout.id.split("_")[1];
                                multipleSurfaceLayouts[styleId] = [];
                                for (var i = 0; i < 4; i++) {
                                    var modifiedLayout = utils.cloneObject(layout);
                                    modifiedLayout.id += "|surface" + i;
                                    multipleSurfaceLayouts[styleId].push(modifiedLayout);
                                }
                            } else {
                                singleSurfaceLayouts.push(layout);
                            }
                        });

                        var productResponseGeneral = {
                            "responseHeader": {
                                "status": "Success"
                            },
                            "responseBody": {
                                "products": []
                            }
                        };

                        var params = {
                            "userId": cache.get('partner_user_id'),
                            "photos": albumPhotos,
                            "oauthToken": cache.get('token'),
                            "migrated": typeof cache.get('superfly_user') !== 'undefined' || isThisLife,
                            "onlySmarts": false,
                            "changeGroups": true,
                            "force": true,
                            "allowDuplicates": true,
                            "layouts": singleSurfaceLayouts,
                            "timeout": 10000,
                            "userData": userData,
                            "importantPhotos": importantPhotos
                        };

                        if(singleSurfaceLayouts.length > 0) {
                            var deferredMagicSDKFitPhotosToLayoutsSingleLayouts = $.Deferred();
                            magicSDKFitPhotosToLayoutsPromise.push(deferredMagicSDKFitPhotosToLayoutsSingleLayouts);

                            var generateProjectJson = function(rankResponseError, rankResponse) {
                                var responseCloned = typeof rankResponse !== "undefined" ? utils.cloneObject(rankResponse) : undefined;
                                var responseErrorCloned = typeof rankResponseError !== "undefined" ? utils.cloneObject(rankResponseError) : undefined;
                                if (typeof window.MagicShop.showRequestMagicSDK !== "undefined"
                                    && window.MagicShop.showRequestMagicSDK === true) {
                                    console.log("output rank", responseCloned, responseErrorCloned);
                                }
                                if(responseErrorCloned !== null) {
                                    _that.postToSimpleQueue({from: "project", errorRank: responseErrorCloned, responseRank: responseCloned, inputRank: params});
                                    deferredMagicSDKFitPhotosToLayoutsSingleLayouts.reject();
                                    return;
                                }

                                responseCloned.photoStrip.forEach(function(inPhotoStrip, index){
                                    inPhotoStrip.photoRefId = index + 1;
                                });

                                responseCloned.layouts.forEach(function (layout) {
                                    productResponseGeneral.responseBody.products.push(generateProductProjectJson([layout], utils.cloneObject(responseCloned.photoStrip), cache.get('partner_user_id'), "none"));
                                });

                                deferredMagicSDKFitPhotosToLayoutsSingleLayouts.resolve();
                            };

                            if (typeof window.MagicShop.showRequestMagicSDK !== "undefined"
                                && window.MagicShop.showRequestMagicSDK === true) {
                                console.log("request to rank singleSurfaceLayouts", params);
                            }
                            globals.magicSDK.fitPhotosToLayouts(params, generateProjectJson);
                        }

                        if(Object.keys(multipleSurfaceLayouts).length > 0) {
                            Object.keys(multipleSurfaceLayouts).forEach(function (multipleSurfaceProduct) {
                                var deferredMagicSDKFitPhotosToLayouts = $.Deferred();
                                magicSDKFitPhotosToLayoutsPromise.push(deferredMagicSDKFitPhotosToLayouts);

                                params.layouts = multipleSurfaceLayouts[multipleSurfaceProduct];

                                var generateProjectJson = function(rankResponseError, rankResponse) {
                                    var responseCloned = typeof rankResponse !== "undefined" ? utils.cloneObject(rankResponse) : undefined;
                                    var responseErrorCloned = typeof rankResponseError !== "undefined" ? utils.cloneObject(rankResponseError) : undefined;
                                    if(responseErrorCloned !== null) {
                                        deferredMagicSDKFitPhotosToLayouts.reject();
                                        return;
                                    }

                                    responseCloned.photoStrip.forEach(function(inPhotoStrip, index){
                                        inPhotoStrip.photoRefId = index + 1;
                                    });

                                    productResponseGeneral.responseBody.products.push(generateProductProjectJson(responseCloned.layouts, responseCloned.photoStrip, cache.get('partner_user_id'), "none"));
                                    deferredMagicSDKFitPhotosToLayouts.resolve();
                                };

                                globals.magicSDK.fitPhotosToLayouts(params, generateProjectJson);
                            });
                        }

                        $.when.apply(undefined, magicSDKFitPhotosToLayoutsPromise).then(function () {
                            fixProductPhotoStrip(productResponseGeneral.responseBody.products);

                            if (!dontCache) {
                                cache.saveProductWithAlbum(albumId, productString, productResponseGeneral.responseBody.products);
                            }

                            callback(productResponseGeneral.responseBody.products);
                            deferred.resolve();
                        }, function() {
                            monitor.reportEvent('GetProductsFailed', {error: "fail magicSDK"});
                            callback(null);
                            deferred.reject();
                        });
                    });
                }
                i++;
            }, isThisLife, mixedSources, dontCache, forceGet);

            return $.when.apply(undefined, promises).promise();
        },

        /*
         Will get the book Jsons and call the given callback with the response.
         The returned value is a jQuery promise.
         @param array photos
         @param int numOfPages
         @param function callback
         @param boolean isManual
         @param array includedBooks - An array of requested Book Ids. Can be empty if all are required.
         @param boolean isThisLife
         */
        getPhotobook: function (album, numOfPages, callback, onlyCover, isManual, includeBooks, isThisLife, mixedSources, dontCache, useThesePids)
        {
            init();

            var promises = [];
            var _that = this;
            var url = SERVER_URL + "GetBook";
            var useSingleAlbum = !(album.constructor === Array);
            var isManual = typeof isManual !== 'undefined' ? isManual : false;
            var useFullPhotodata = (useSingleAlbum && !(_.isString(album.photos[0]) || _.isNumber(album.photos[0])));
            var isThisLife = isThisLife || false;
            var mixedSources = mixedSources || false;
            var dontCache = typeof dontCache !== 'undefined' ? dontCache : false;
            var usePids         = (typeof useThesePids !== 'undefined' && Array.isArray(useThesePids));
            var books;

            if (cache.get('mode') == 'gifting' || cache.get('mode') == 'gifting_gm') {
                isManual = true;
            }

            if (usePids) {
                books = useThesePids;
            } else if (typeof includeBooks !== 'undefined' && includeBooks.constructor === Array) {
                books = config.getBooksByIds(includeBooks);
            }
            else {
                books = config.getBooks();
            }

            if (books.length == 0) {
                var deffered = $.Deferred();
                deffered.resolve();
                return deffered;
            }

            var i = 0;

            // Support multiple photobooks
            _.each(books, function (book)
            {
                var deffered = $.Deferred();
                promises.push(deffered);

                // Prefer cache over requesting again
                var albumId = useSingleAlbum ? album.albumId : album[i % album.length].albumId;


                var pJson = cache.getBookWithAlbum(albumId, _that._preparePhotobookString([book]), onlyCover, isManual);
                var bookSize = (usePids == false) ? book.size : book.split("_")[1];

                // Using a cache
                if (pJson != null) {
                    console.info('[Product Widget] Use cache for the current book');
                    callback(pJson);
                    deffered.resolve();
                }
                else { // Using the rank service
                    var request;
                    if (useFullPhotodata) {
                        request = {
                            "requestHeader": {
                                "key": typeof cache.get('superfly_user') !== 'undefined' || isThisLife ? KEY_TL : KEY
                            },
                            "requestBody": {
                                "partnerUserId": cache.get('partner_user_id'),
                                "fullPhotoData": album.photos,
                                "style": _that._preparePhotobookString([book], usePids),
                                "size": bookSize,
                                "format": "SflyProjectJson",
                                "onDemand": true,
                                "forceCreate": true,
                                "manual": isManual,
                                "onlyCover": onlyCover,
                                "source": _that.getRightSource(),
                                "doNotUseRank": mixedSources
                            }
                        };
                    }
                    else {
                        request = {
                            "requestHeader": {
                                "key": typeof cache.get('superfly_user') !== 'undefined' || isThisLife ? KEY_TL : KEY
                            },
                            "requestBody": {
                                "partnerUserId": cache.get('partner_user_id'),
                                "photoIds": useSingleAlbum ? album.photos : album[i % album.length].photos,
                                "style": _that._preparePhotobookString([book], usePids),
                                "size": bookSize,
                                "format": "SflyProjectJson",
                                "onDemand": true,
                                "forceCreate": true,
                                "manual": isManual,
                                "onlyCover": onlyCover,
                                "source": _that.getRightSource(),
                                "doNotUseRank": mixedSources
                            }
                        };
                    }

                    $.ajax({
                        type: "POST",
                        url: url,
                        crossDomain: true,
                        dataType: "json",
                        timeout: 20000,
                        data: JSON.stringify(request),
                        success: function (response)
                        {

                            if (typeof callback == 'function') {
                                if (response.hasOwnProperty('responseHeader') && response.responseHeader.hasOwnProperty('status') && response.responseHeader.status == 'Success') {
                                    // Clean empty products

                                    var products = [];
                                    products.push({"book": response.responseBody.book});

                                    if (onlyCover || !dontCache) {
                                        cache.saveBookWithAlbum(albumId, _that._preparePhotobookString([book], usePids), onlyCover, isManual, products);
                                    }

                                    callback(products);
                                    deffered.resolve();
                                }
                                else {
                                    monitor.reportEvent('GetPhotobookFailed', {error: 'rank_failed'});
                                    callback(null);
                                    if(cache.get('mode') === 'instance'){
                                        //we are resolving this because for lesser number of images pb getbooks can fail, so keep the widget empty...
                                        deffered.resolve();
                                    } else {
                                        deffered.reject();
                                    }

                                }
                            }
                        },
                        error: function (jqXHR, textStatus, errorThrown)
                        {
                            monitor.reportEvent('GetPhotobookFailed', {error: textStatus});
                            callback(null);
                            deffered.reject();
                        }
                    });
                }

                i++;
            });

            return $.when.apply(undefined, promises).promise();
        },

        getCalendar: function (album, callback, isManual, includedCalendars, isThisLife, mixedSources, dontCache, useThesePids)
        {
            init();

            var promises = [];
            var _that = this;
            var url = SERVER_URL + "GetCalendar";
            var useSingleAlbum = !(album.constructor === Array);
            var useFullPhotodata = (useSingleAlbum && !(_.isString(album.photos[0]) || _.isNumber(album.photos[0])));
            var isThisLife = isThisLife || false;
            var mixedSources = mixedSources || false;
            var dontCache = typeof dontCache !== 'undefined' ? dontCache : false;
            var usePids         = (typeof useThesePids !== 'undefined' && Array.isArray(useThesePids));

            if (cache.get('mode') == 'gifting' || cache.get('mode') == 'gifting_gm') {
                isManual = true;
            }

            var calendars;

            if(usePids) {
                calendars = useThesePids;
            }
            else if (typeof includedCalendars !== 'undefined' && includedCalendars.constructor === Array) {
                calendars = config.getCalendarsById(includedCalendars);
            }
            else {
                calendars = config.getCalendar();
            }

            if (calendars.length == 0) {
                var deffered = $.Deferred();
                deffered.resolve();
                return deffered;
            }

            var i = 0;
            //var albumId = 0;

            _.each(calendars, function (cal)
            {
                var deffered = $.Deferred();
                promises.push(deffered);

                var albumId = useSingleAlbum ? album.albumId : album[i % album.length].albumId;
                var pJson = cache.getCalendarWithAlbum(albumId, _that._prepareCalendarString([cal]));

                var calStyle;
                var calSize;

                // for wall calendar use galleon render
                if(cal['sizeId'] != "33") {
                    if(usePids == false) {
                        calStyle = cal['styleId'];
                        calSize = cal['sizeId'];
                    }
                    else {
                        calStyle = _that._prepareCalendarString([cal], usePids).split("_")[1];
                        calSize = _that._prepareCalendarString([cal], usePids).split("_")[2];
                    }
                }
                else { // for desk calendar
                    calStyle = _that._prepareCalendarString([cal]);
                }

                if (pJson != null) {
                    console.info('[Product Widget] Use cache for the current calendar');
                    callback(pJson);
                    deffered.resolve();
                }
                else {
                    var request = {
                        "requestHeader": {
                            "key": typeof cache.get('superfly_user') !== 'undefined' || isThisLife ? KEY_TL : KEY
                        },
                        "requestBody": {
                            "partnerUserId": cache.get('partner_user_id'),
                            "style": calStyle,
                            "format": "SflyProjectJson",
                            "onDemand": true,
                            "forceCreate": true,
                            "manual": isManual,
                            "source": _that.getRightSource(),
                            "doNotUseRank": mixedSources
                        }
                    };

                    // for desktop calendar to not use galleon render
                    if(cal['sizeId'] != "33") {
                        request.requestBody.size = calSize;
                    }


                    // request by photoIds or fullPhotoData
                    request.requestBody[ useFullPhotodata ? "fullPhotoData" : "photoIds" ] = useSingleAlbum ? album.photos : album[i % album.length].photos;

                    $.ajax({
                        type: "POST",
                        url: url,
                        crossDomain: true,
                        dataType: "json",
                        timeout: 20000,
                        data: JSON.stringify(request),
                        success: function (response)
                        {
                            if (typeof callback == 'function') {
                                if (response.hasOwnProperty('responseHeader') && response.responseHeader.hasOwnProperty('status') && response.responseHeader.status == 'Success') {
                                    // Clean empty products

                                    var cals = [];
                                    cals.push({"product": response.responseBody.product});

                                    if (!dontCache) {
                                        cache.saveCalendarWithAlbum(albumId, _that._prepareCalendarString([cal], usePids), cals);
                                    }
                                    callback(cals);
                                    deffered.resolve();

                                }
                                else {
                                    monitor.reportEvent('GetCalendarFailed', {error: 'rank_failed'});
                                    callback(null);
                                    deffered.reject();
                                }
                            }
                        },
                        error: function (jqXHR, textStatus, errorThrown)
                        {
                            monitor.reportEvent('GetCalendarFailed', {error: textStatus});
                            callback(null);
                            deffered.reject();
                        }
                    });
                }

                i++;
            });


            return $.when.apply(undefined, promises).promise();
        },
        getPrints: function (album, callback, isManual, includedPrints, isThisLife, mixedSources, dontCache)
        {
            var that = this;
            init();

            var useSingleAlbum = !(album.constructor === Array);
            var dontCache = typeof dontCache !== 'undefined' ? dontCache : false;
            if (cache.get('mode') === 'gifting' || cache.get('mode') === 'gifting_gm') {
                isManual = true;
            }

            var deferred = $.Deferred();

            var prints;
            if (typeof includedPrints !== 'undefined' && includedPrints.constructor === Array) {
                prints = config.getPrintsByIds(includedPrints);
            }
            else {
                prints = config.getPrints();
            }
            if (prints.length === 0) {
                deferred.resolve();
                return deferred;
            }

            // Prefer cache over requesting again
            var albumId = useSingleAlbum ? album.albumId : album[/*i % album.length*/0].albumId;
            var cachePhotoIdsString = this._preparePrintsString(prints);
            var pJson = cache.getPrintsWithAlbum(albumId, cachePhotoIdsString, isManual);
            if (typeof pJson !== "undefined" && pJson !== null) { // Using a cache
                console.info('[Product Widget] Use cache for the current prints');
                callback(pJson);
                deferred.resolve();
            }
            else { // Using the rank service
                var albumPhotos = !(album.constructor === Array) ? album.photos
                    : album[0].photos.map(function (photoId) {
                        if (photoId !== 0) {
                            return {"id": photoId};
                        }
                    });
                if (typeof albumPhotos[0] === 'string' || typeof albumPhotos[0] === 'number') {
                    albumPhotos = albumPhotos.map(function (photoId) {
                        if (photoId !== 0) {
                            return {"id": photoId};
                        }
                    });
                }

                var albumPhotosLength = albumPhotos.length;
                if(albumPhotosLength > 1000) {
                    albumPhotos.splice(0, albumPhotosLength - 1000);
                    albumPhotosLength = 1000;
                }

                var params = {
                    "userId": cache.get('partner_user_id'),
                    "photos": albumPhotos,
                    "oauthToken": cache.get('token'),
                    "migrated": typeof cache.get('superfly_user') !== 'undefined' || isThisLife,
                    "timeout": 10000,
                    "maxPhotos": isManual ? albumPhotosLength : 200
                };

                var generateProjectJson = function (rankResponseError, rankResponse) {
                    var responseCloned = typeof rankResponse !== "undefined" ? utils.cloneObject(rankResponse) : undefined;
                    var responseErrorCloned = typeof rankResponseError !== "undefined" ? utils.cloneObject(rankResponseError) : undefined;
                    if (typeof window.MagicShop.showRequestMagicSDK !== "undefined"
                        && window.MagicShop.showRequestMagicSDK === true) {
                        console.log("output rank get prints", responseCloned, responseErrorCloned);
                    }
                    if (responseErrorCloned !== null) {
                        monitor.reportEvent('GetPrintsFailed', {error: 'rank_failed'});
                        that.postToSimpleQueue({from: "prints", errorRank: responseErrorCloned, responseRank: responseCloned, inputRank: params});
                        callback(null);
                        deferred.reject();
                        return;
                    }

                    responseCloned.photoStrip.forEach(function (inPhotoStrip, index) {
                        inPhotoStrip.photoRefId = index + 1;
                    });

                    var printResponse = {
                        "prints": {
                            "info": {
                                "style": "",
                                "userId": cache.get('partner_user_id'),
                                "size": "4x6"
                            },
                            "title": "4x6 prints",
                            "photoStrip": responseCloned.photoStrip,
                            "pages": responseCloned.prints.map(function (print, index) {
                                return generatePrintPageProjectJson(print, responseCloned.photoStrip, index);
                            })
                        }
                    };

                    var products = [printResponse];
                    if (!dontCache) {
                        cache.savePrintsWithAlbum(albumId, cachePhotoIdsString, isManual, products);
                    }

                    callback(products);
                    deferred.resolve();
                };

                if (typeof window.MagicShop.showRequestMagicSDK !== "undefined"
                    && window.MagicShop.showRequestMagicSDK === true) {
                    console.log("request to rank getPrints", params);
                }
                globals.magicSDK.getPrints(params, generateProjectJson);
            }

            return deferred.promise();
        },
        postToSimpleQueue: function (message) {
            message.env = cache.get('env');
            message.version = 197;
            $.ajax({
                type: "POST",
                url: "https://a3292fdvq0.execute-api.us-east-1.amazonaws.com/prod/message",
                contentType: "application/json",
                data: JSON.stringify(message),
                dataType: 'json',
                crossDomain: true,
                timeout: 20000,
                success: function () {
                    console.log('added error message to queue');
                }
            });
        },

        requestToAppLink: function (token, phoneNumber) {
            var deferred = $.Deferred();
            phoneNumber = (phoneNumber) ? phoneNumber.replace(/[^\d.+]/g, "") : '';
            var message = _.clone(REQUEST_APP_LINK_PARAMS);
            message.params = [phoneNumber, MSG_TYPE_SFLY];

            $.ajax({
                type: 'POST',
                cache: false,
                url: REQUEST_APP_LINK,
                processData: false,
                data: JSON.stringify(message),
                dataType: 'json',
                crossDomain: true,
                timeout: 20000,
                success: function (result) {
                    if (result.error) {
                        return deferred.reject();
                    }
                    return deferred.resolve(result.result);
                },
                error: function( jqXhr, textStatus, errorThrown ) {
                    return deferred.reject(jqXhr);
                }
            });
            return deferred.promise();
        },

        getMGSources: function (callback, refreshCache, typeMG)
        {
            init();
            var deffered = $.Deferred();
            var ownerId = cache.get('partner_user_id');

            // Signout mode, return list of photoIds for Model user (hardcoded)
            if (ownerId === '009085953279') {
                var modelsSources = JSON.parse('{"photobooks":[{"albumId":null,"time":1455463640,"numPhotos":30,"photos":["40739677222","40739677226","40739677301","40739677302","40739677308","40739677310","40739677424","40739677468","40739677471","40739677611","40739677752","40739677831","40739678100","40739678204","40739678240","40739678351","40739678352","40739678367","40739678388","40739678426","40739678460","40739678564","40739678597","40739678600","40739678603","40739678605","40739678606","40739678714","40739678747","40739678750"]}],"products":[{"albumId":null,"time":1455463640,"numPhotos":30,"photos":["40739677222","40739677226","40739677301","40739677302","40739677308","40739677310","40739677424","40739677468","40739677471","40739677611","40739677752","40739677831","40739678100","40739678204","40739678240","40739678351","40739678352","40739678367","40739678388","40739678426","40739678460","40739678564","40739678597","40739678600","40739678603","40739678605","40739678606","40739678714","40739678747","40739678750"]}],"calendars":[{"albumId":null,"time":1455463640,"numPhotos":30,"photos":["40739677222","40739677226","40739677301","40739677302","40739677308","40739677310","40739677424","40739677468","40739677471","40739677611","40739677752","40739677831","40739678100","40739678204","40739678240","40739678351","40739678352","40739678367","40739678388","40739678426","40739678460","40739678564","40739678597","40739678600","40739678603","40739678605","40739678606","40739678714","40739678747","40739678750"]}],"prints":[{"albumId":null,"time":1455463640,"numPhotos":30,"photos":["40739677222","40739677226","40739677301","40739677302","40739677308","40739677310","40739677424","40739677468","40739677471","40739677611","40739677752","40739677831","40739678100","40739678204","40739678240","40739678351","40739678352","40739678367","40739678388","40739678426","40739678460","40739678564","40739678597","40739678600","40739678603","40739678605","40739678606","40739678714","40739678747","40739678750"]}],"superfly":true}');
                cache.set('superfly_user', true);
                if (_.isFunction(callback)) {
                    callback(modelsSources);
                    deffered.resolve();
                }
                if(typeof Shr === "undefined" || typeof Shr.U.uid === "undefined" || Shr.U.uid === ownerId){
                    return;
                } else {
                    ownerId = Shr.U.uid;
                }
                return;
            }

            var typeMG = typeof typeMG === 'undefined' ? 'vips' : typeMG;
            //var typeMG = 'recent'; // default
            var abTestGroup = cache.get('cohort');
            var shouldUseVips =
                abTestGroup === 'GroupC' || abTestGroup === 'Group_C' ||
                abTestGroup === 'GroupE' || abTestGroup === 'Group_E' ||
                window.location.href.indexOf("useVips") > -1;

            if (window.location.href.indexOf("useRecent") > -1) {
                typeMG = 'recent';
            } else {
                if (shouldUseVips) {
                    typeMG = 'vips';
                }
            }

            var refreshCache = refreshCache || false;
            var token = cache.get('token');
            var url = MAGIC_URL + 'mgsource?photobooks=3&products=2&prints=3&calendars=2&userId=' + ownerId + '&token=' + token + '&type=' + typeMG + '&source=' + this.getRightSource();

            if(!refreshCache) {
                var mgSource = config.getMgSource(typeMG);
                if (typeof mgSource !== "undefined" && mgSource !== null) { // Using a cache
                    console.log('[Product Widget] Getting Saved MG Source');

                    // set that we got if from cache so is a valid refresh after render
                    config.isMgSourceFromCache(typeMG);

                    // Save if is a SuperFly user
                    if (typeof mgSource['superfly'] !== "undefined") {
                        cache.set('superfly_user', true);
                    }

                    if (_.isFunction(callback)) {
                        callback(mgSource);
                        deffered.resolve();
                    }

                    return;
                }
            } else {
                // if we don't have callback check if we need really to fresh the mgsource
                if(callback === null) {
                    var wasMgSourceFromCache = config.wasMgSourceFromCache(typeMG);
                    if (typeof wasMgSourceFromCache === 'undefined' || wasMgSourceFromCache !== true) {
                        deffered.resolve();
                        return;
                    }
                }
            }

            $.ajax({
                type: "GET",
                url: url,
                crossDomain: true,
                dataType: "json",
                timeout: 20000,
                success: function (resp)
                {
                    if (resp.hasOwnProperty('message') || !resp.hasOwnProperty('products') || resp.products.length === 0) {
                        console.log('[Products Widget] Not enough photos');
                        monitor.reportEvent('GetMgSourceFailedNoSources');
                        if (_.isFunction(callback)) {
                            callback([]);
                        }
                        deffered.resolve();
                        return;
                    }

                    // Save mgSource
                    config.saveMgSource(typeMG, resp);

                    // Save if is a SuperFly user
                    if (typeof resp['superfly'] !== "undefined") {
                        cache.set('superfly_user', true);
                    }

                    if (_.isFunction(callback)) {
                        callback(resp);
                        deffered.resolve();
                    }
                },
                error: function (jqXHR, textStatus, errorThrown)
                {
                    if (typeof callback === 'function') {
                        callback(null);
                    }
                    monitor.reportEvent('GetMgSourceFailed', {error: textStatus});
                    deffered.reject();
                }
            });

            return deffered.promise();

        },
        MgFail: function ()
        {
            init();
            monitor.reportEvent('MgFail');
        },
        loadPrices: function (callback)
        {
            var origSkusList = {};
            init();

            function getPricesSkuCall() {
                function getSFLYSKU(prod)
                {
                    var sflySkus = "";
                    var prodSflySku = prod['sfly_sku'] || prod['sflySku'] || "";
                        origSkusList = {
                            sflySky: prodSflySku,
                            prodType: prod['type'],
                            epSku: prod["sku"]
                        };
                        if(prodSflySku) {
                            if(prodSflySku.indexOf(",") > 1) {
                                sflySkus = prodSflySku.split(",");
                                return sflySkus
                            } else {
                                return prodSflySku;
                            }
                        }
                }
                function getType(prod)
                {
                    if (prod.hasOwnProperty('type')) {
                        return prod['type'];
                    }
                    return '';
                }
                function getSKU(prod)
                {
                    if (prod.hasOwnProperty('sku')) {
                        return prod['sku'];
                    }
                    return '';
                }
                function getProductCode(prod)
                {
                    if (prod.hasOwnProperty('productCode')) {
                        return prod['productCode'];
                    }
                    return '';
                }

                function addPriceSku(p) {
                    var cPrice = {};
                    cPrice['prodType'] = getType(p);
                    var cPriceSflySKU = getSFLYSKU(p);
                    var sku = getSKU(p);
                    var productCode = getProductCode(p);
                    if (cPrice['prodType'] && cPriceSflySKU) {
                        if (Array.isArray(cPriceSflySKU)) {
                            cPriceSflySKU.forEach(function (sSku) {
                                cPrice["sflySku"] = sSku;
                                skus.push({
                                    "prodType":cPrice['prodType'],
                                    "sflySku": sSku,
                                    "epSku": sku,
                                    "epProduct": productCode
                                });
                            })
                        } else {
                            cPrice["sflySku"] = cPriceSflySKU;
                            cPrice["epSku"] = sku;
                            cPrice["epProduct"] = productCode;
                            skus.push(cPrice);
                        }
                    }
                }

                function getQuantity(type) {
                    switch (type) {
                        case "card":
                            return [1, 50];
                            break;
                        default:
                            return [1];
                    }
                }

                var skus = [];
                _.each(config.getProducts(), function (p)
                {
                    addPriceSku(p);

                });

                _.each(config.getPrints(), function (p)
                {
                    addPriceSku(p);
                });

                _.each(config.getBooks(), function (p)
                {
                    addPriceSku(p);
                });

                _.each(config.getCalendar(), function (p)
                {
                    addPriceSku(p);
                });

                var skusToRequest = {};
                _.each(skus, function (sku, index)
                {
                    if(sku.prodType !== "photobook" && sku.prodType !== "calendar") {
                        skusToRequest[index] = {};
                        skusToRequest[index] = {
                            sflySku : sku.sflySku,
                            prodType: sku.prodType,
                            epSku: sku.epSku,
                            epProduct: sku.epProduct
                        }
                    } else {
                        skusToRequest[sku.sflySku] = sku.prodType;
                    }

                });

                var skusPrice = {};

                    if (skus.length > 0) {
                        var index = 0;
                        skusPrice['currency'] = "USD";
                        skusPrice['skus'] = [];
                        _.each(skusToRequest, function (prod, key) {
                            if (prod === "photobook" || prod === "calendar") {
                                skusPrice.skus.push({
                                    skuRef: index,
                                    sflySku: key,
                                    quantities: [1],
                                    epProduct: "",
                                    epSku: key
                                })
                            } else {
                                skusPrice.skus.push({
                                    skuRef: index,
                                    sflySku: prod.sflySku,
                                    quantities: getQuantity(prod.prodType),
                                    epProduct: prod.epProduct,
                                    epSku: prod.epSku
                                })

                            }
                            index++;
                        });
                    }

                if (Object.keys(skusPrice.skus).length > 0) {
                        while(Object.keys(skusPrice.skus).length > 0) {
                            var skuPriceBulk = {};
                            skuPriceBulk = {
                                currency: "USD",
                                skus: skusPrice.skus.splice(0, 300)
                            };

                            var skuString = JSON.stringify(skuPriceBulk);
                            $.ajax({
                                type: "POST",
                                url: PRICE_URL,
                                crossDomain: true,
                                timeout: 8000,
                                data: skuString,
                                contentType: "application/json",
                                headers: {
                                    'SFLY-apiKey': APIKEY
                                },
                                success: function (response) {
                                    if(response) {
                                        let newPricing = JSON.parse(JSON.stringify(response));
                                        newPricing.items.forEach(function (item) {
                                            if(typeof skusToRequest[item.skuRef] !== "undefined") {
                                                item.epSku = skusToRequest[item.skuRef].epSku
                                            }
                                        });

                                        config.parsePrices(newPricing.items, skusToRequest);

                                        if ('function' === typeof callback) {
                                            callback();
                                        }
                                    }
                                },
                                error: function (XMLHttpRequest, textStatus, errorThrown) {
                                    config.mockParsePrices(skuString);
                                    monitor.reportEvent('LoadPricesFailed', {error: textStatus});

                                    if ('function' === typeof callback) {
                                        callback();
                                    }
                                }
                            });
                        }
                }
                else {
                    if ('function' === typeof callback) {
                        callback();
                    }
                }

            }

            if(typeof cache.getCoupon() === "undefined") {
                this.getCoupon(getPricesSkuCall);
            } else {
                getPricesSkuCall();
            }
        },

        getCoupon: function(callback) {
            $.ajax({
                   type: "GET",
                   url: COUPON_URL,
                   crossDomain: true,
                   dataType: "json",
                   timeout: 8000,
                   success: function (response)
                   {
                       cache.setCoupon(response);
                       if ('function' == typeof callback) {
                           callback();
                       }
                   },
                   error: function (XMLHttpRequest, textStatus, errorThrown)
                   {
                       monitor.reportEvent('couponFailed', {error: textStatus});
                       if ('function' == typeof callback) {
                           callback();
                       }
                   }
               });
        },

        /*
         Gets the promo code from the s3 file which has the latest promo info for the sfly promos for various products and
         sets the info in the cache for the use in the widgets and updated the cache if there is a indicator.
         productType: If the producType is specified then it will just return the markup for that product if exists...
         */
        getSflyPromos: function (productType, isMobile)
        {

            init();

            if (productType == "cns") {
                productType = "cards";
            }

            function getProductMarkUp(productType, sflyPromo, isMobile)
            {
                var objStr = utils.formatString('sflyPromo.categories.{0}.{1}', productType, isMobile ? "mobile_html" : "html");
                var markUp;
                try {
                    markUp = eval(objStr);
                }
                catch (e) {
                }
                return markUp;
            }

            var getNewPromos = true;
            var deferred = $.Deferred();
            //it will check the cache expiry time and return undefined if cache needs to be updated or we are go to return a value
            var sflyPromo = cache.get('sfly_promos', true);
            if (typeof sflyPromo !== 'undefined') {
                getNewPromos = false;
                deferred.resolve(typeof productType !== 'undefined' ? getProductMarkUp(productType, sflyPromo, isMobile) : sflyPromo);
            }

            // if cache needs to be updated or empty
            if (getNewPromos) {
                $.ajax({
                    type: "GET",
                    url: SFLY_PROMO_URL,
                    crossDomain: true,
                    dataType: "json",
                    timeout: 8000,
                    success: function (response)
                    {
                        var expInMs = 0;
                        if (typeof response.expiration !== 'undefined') {
                            expInMs = parseInt(response.expiration) * 60 * 60 * 1000; //ms & epr = 12hours by server
                        }

                        cache.set('sfly_promos', response, true, expInMs);
                        deferred.resolve(typeof productType !== 'undefined' ? getProductMarkUp(productType, response, isMobile) : response);
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown)
                    {
                        //decide what to do in the function callback
                        deferred.resolve();
                    }
                });
            }
            return deferred.promise();
        },

        loadPersonalization: function ()
        {

            var promises = [];
            var deferred = $.Deferred();
            var ownerId = cache.get('partner_user_id');
            var url = PERSON_URL + ownerId + '.json';
            promises.push(deferred);

            // Prefer config over requesting again
            var pJson = config.getPersonalization();

            //Check if the user logged in
            if (typeof cache.get('partner_user_id') !== 'undefined' && cache.get('partner_user_id') != "") {
                $.ajax({
                    type: "GET",
                    url: url,
                    crossDomain: true,
                    dataType: "json",
                    timeout: 20000,
                    success: function (json)
                    {

                        if (typeof JSON.stringify(pJson) === 'undefined' || (md5.hash(JSON.stringify(pJson)) != md5.hash(JSON.stringify(json)))) {
                            config.savePersonalization(json); //Save the file in the cache
                        }

                        //if (!cookie.cookieExists('presonalize_group')) { //if cookie wasn't set yet
                        //    //var random = Math.random();
                        //    // Use the personalization file only for WL users
                        //    //if (random <= 0.9) {
                        //    if(config.isUserWhitelisted(cache.get('partner_user_id'))) {
                        //        //Group B + save cookie  6 months
                        //        cookie.setCookie('presonalize_group', 'PER01', 4320);
                        //    } else {
                        //        //Group A + save cookie 6 months
                        //        cookie.setCookie('presonalize_group', 'NOTPER', 4320);
                        //    }
                        //
                        //}
                        deferred.resolve();

                    },
                    error: function ()
                    {
                        //send no file
                        var newUrl = MAGIC_API_URL +  "MissingPersonalization?userId="+ownerId;
                        $.ajax({
                           type: "GET",
                           url: newUrl,
                           crossDomain: true,
                           timeout: 20000,
                           success: function () {
                               console.log(ownerId + "has no file");
                           }
                        });

                        deferred.reject();
                    }
                });

            }
            else {
                //cookie.setCookie('presonalize_group', 'NOTPER', 24); //Cookie for 24 hours
                deferred.resolve();
            }


            return $.when.apply(undefined, promises).promise();
        },

        getRecipe: function (recipeName, callback)
        {

            // if is xsell return empty recipe
            if (recipeName === "replacement_cross_sell") {
                if(typeof callback === 'function'){
                    callback({});
                }
                return;
            }

            init();
            var promises = [];
            var deferred = $.Deferred();
            promises.push(deferred);

            // Prefer cache over requesting again
            var pJson = config.getRecipe(recipeName);

            if (typeof pJson !== "undefined" && pJson !== null) {
                console.log('[Product Widget] Use cache for the current recipe');
                deferred.resolve();
                if(typeof callback === 'function'){
                    callback(pJson);
                }
            } else {
                $.ajax({
                           type: "GET",
                           url: RECIPES_URL + recipeName + ".json",
                           crossDomain: true,
                           dataType: "json",
                           timeout: 20000,
                           success: function (json)
                           {
                               config.saveRecipe(recipeName, json);
                               deferred.resolve();
                               if(typeof callback === 'function'){
                                   callback(json);
                               }
                           },
                           error: function (XMLHttpRequest, textStatus, errorThrown)
                           {
                               monitor.reportEvent('getRecipeFailed', {error: textStatus});
                               deferred.reject();
                               if(typeof callback === 'function') {
                                   callback(null);
                               }
                           }
                       });
            }

            return $.when.apply(undefined, promises).promise();
        },

        getRightSource: function ()
        {
            var source = cache.get('prod_type');
            if (source == "homepage") {
                source += "-" + cache.get('mode');
            }
            return source;
        },

        getMinimalNumOfSupportedPhotos: function(sku) {
            return this._getMinNumOfPhotos(config.getProductBySku(sku));
        },

        _getToken: function ()
        {
            var unixTimeStamp = Math.round(+new Date() / 1000);
            return md5.hash(unixTimeStamp + SECRET);
        },
        _prepareProductsString: function (products, usePids, numOfPhotos, isManualSelect)
        {
            var pString = "";
            var that = this;

            if (usePids) {
                _.each(products, function (pid)
                {
                    if (pString.length > 0) {
                        pString += ',';
                    }
                    pString += pid;

                    // see if we have a layoutId
                    var prod = config.getProductBySku(config.getProductSkuById(pid));
                    var layout = that._getLayoutForProduct(prod, numOfPhotos, isManualSelect);

                    if (typeof prod !== 'undefined' && typeof layout !== 'undefined') {
                        pString += "**" + layout;
                    }

                });
                return pString;
            }

            _.each(products, function (prod)
            {
                var p;

                if (prod['type'] != 'photobook' && prod['type'] != 'calendar' && prod['type'] != 'prints' && prod['type'] != 'cns') {
                    p = prod['occasionId'] + '_' + prod['styleId'] + '_' + prod['sizeId'];
                    var layout = that._getLayoutForProduct(prod, numOfPhotos, isManualSelect);
                    if (typeof layout !== 'undefined') {
                        p += "**" + layout;
                    }
                    if (pString.length > 0) {
                        pString += ",";
                    }
                    pString += p;
                }
            });

            return pString;
        },
        _prepareProductString: function (prod, usePids, numOfPhotos, isManualSelect)
        {
            var pString = "";
            var p;

            if (usePids) {
                return prod;
            }

            if (prod['type'] != 'photobook' && prod['type'] != 'calendar' && prod['type'] != 'prints' && prod['type'] != 'cns') {
                //p = prod['occasionId']+'_'+prod['styleId']+'_'+prod['sizeId']+"**"+prod["layoutId"];
                p = prod['occasionId'] + '_' + prod['styleId'] + '_' + prod['sizeId'];
                var layout = this._getLayoutForProduct(prod, numOfPhotos, isManualSelect);
                if (typeof layout !== 'undefined') {
                    p += "**" + layout;
                }
                if (pString.length > 0) {
                    pString += ",";
                }
                pString += p;
            }

            return pString;
        },
        _preparePhotobookString: function (products, usePids)
        {
            var pString = "";

            if (usePids) {
                return products[0];
            }

            _.each(products, function (prod)
            {
                if (prod['type'] == 'photobook') {
                    var p = prod['style'] + '_' + prod['size'];
                    if (pString.length > 0) {
                        pString += ",";
                    }

                    pString += p;
                }
            });

            return pString;
        },
        _prepareCalendarString: function (products, usePids)
        {
            if (usePids) {
                return products[0];
            }

            var pString = "";
            _.each(products, function (prod)
            {
                var p;
                if (prod['sizeId'] == '33') {
                    p = 'cns:' + prod['occasionId'] + '_' + prod['styleId'] + '_' + prod['sizeId'];
                } else {
                    p = prod['styleId'] + '_' + prod['sizeId'];
                }
                if (pString.length > 0) {
                    pString += ",";
                }
                pString += p;
            });

            return pString;
        },
        _preparePrintsString: function (products)
        {
            var pString = "";
            _.each(products, function (prod)
            {
                if (prod['type'] == 'prints') {
                    var p = prod['size'];
                    if (pString.length > 0) {
                        pString += ",";
                    }
                    pString += p;
                }
            });

            return pString;
        },
        _getLayoutForProduct: function(product, numOfPhotosUsed, isManualSelect)
        {
            isManualSelect = typeof isManualSelect !== 'undefined' ? isManualSelect : false;

            if (numOfPhotosUsed > 10 || numOfPhotosUsed == 0) {
                // Use the default
                return this._getDefaultProductLayout(product)['layoutId'];
            } else if (product.hasOwnProperty('layouts')) {
                // Choose a layout with the given number of photos or less
                var suitableLayouts = _.filter(product.layouts, function(layout) {
                    return layout['numPhotos'] <= numOfPhotosUsed;
                });

                if (isManualSelect) {
                    var layout = _.max(suitableLayouts, function(layout) {
                        return layout.numPhotos;
                    });
                } else {
                    var randomLayoutIdx = Math.floor(Math.random() * suitableLayouts.length);
                    var layout = suitableLayouts[randomLayoutIdx];
                }

                // if nothing found, take the default
                return typeof layout !== 'undefined' ? layout['layoutId'] : this._getDefaultProductLayout(product)['layoutId'];
            } else {
                return this._getDefaultProductLayout(product)['layoutId'];
            }
        },

        _getDefaultProductLayout: function(product)
        {
            if (product.hasOwnProperty('layouts')) {
                var defaultLayout = _.find(product.layouts, function (layout)
                {
                    return layout.hasOwnProperty('default') && layout['default']
                });

                return defaultLayout !== undefined ? defaultLayout : product.layouts[0];
            } else {
                // wrap this, as the default response is wrapped
                return { "layoutId": product.layoutId };
            }
        },

        _getMinNumOfPhotos: function(product) {
            var min = 1;
            var updated = false;
            if (product.hasOwnProperty('layouts')) {
                product.layouts.forEach(function(layout) {
                    if (!updated && layout.numPhotos > 0) {
                        updated = true;
                        min = layout.numPhotos;
                    } else {
                        min = layout.numPhotos < min && layout.numPhotos > 0 ? layout.numPhotos : min;
                    }
                })
            }

            return min;
        }
    }

});

/*
The module includes methods used by all rendering engines of the widget.
 */

define('app/view_engine/widgets/common', ['underscore', 'app/config_manager', 'app/asset_mapper', 'app/cache_module', 'app/templates', 'app/time_monitor', 'app/tracking', 'app/cookies', 'app/product_proxy'], function(_, config, AssetMapper, cache, templates, monitor, tracking, cookie, productProxy) {
    return {
        // Will return a product Json by the given pId
        getProduct: function(sku) {
            return config.getProducts()[sku] || config.getBooks()[sku] || config.getPrints()[sku] || config.getCalendar()[sku];
        },

        // Will return a product denoted by @productId in @projectJson
        // Used a hack here - saving the product in memory. This is meant for saving state of product between the side
        // widget and the modal it opens - we want to make sure that the same product will have the same layout.
        // After an albumSwitch - we don't want to use or to save to the cache.
        findProjectJsonProduct: function(productJson, sku, ignoreCache, overwriteCache, product) {
            product = typeof product !== 'undefined' ? product : this.getProduct(sku);

            overwriteCache = overwriteCache || false;

            if (typeof product !== "undefined" && (product.type == 'photobook' || product.type == 'prints' || product.type == 'calendar' || product.type == 'deskcalendar')) {
                ignoreCache = true;
            } else {
                ignoreCache = (typeof ignoreCache !== 'undefined') ? ignoreCache : false;
            }

            var prod = ignoreCache ? undefined : cache.getProduct(sku);

            if (typeof prod !== 'undefined' && prod !== undefined && prod != null) {
                return prod;
            }

            prod = _.find(productJson, function(prod) {
                if (prod != undefined && typeof prod.length === 'undefined') { // roman: this is a hack! solve this.
                    var productType = AssetMapper.GetProductType(prod);
                    var id          = AssetMapper.GetPartnerId(prod, productType);
                    // TEMP SOLUTION

                    var pSku = config.getProductSkuById(id, true);

                    if (pSku instanceof Array) {
                         if($.inArray(sku, pSku) != -1) {
                             return true;
                         }
                    } else {
                        return pSku == sku;
                    }
                }
            });

            if ((!ignoreCache || overwriteCache) && typeof prod !== "undefined") {
                cache.saveProduct(sku, prod);
            }

            return prod;
        },

        GetPrintsByOrientation : function(orientation){
            return orientation == "landscape" ? 'printsl' : 'printsp';
        },

        // Will return the "real" product size. i.e - without the blank spacing around. Product is found by @pId in the @productJson
        getProductRealSize: function (productJson, sku, isSprite, product, dontUseCache) {
            if (typeof isSprite == 'undefined') {
                isSprite = false;
            }

            product         = typeof product !== 'undefined' ? product : this.getProduct(sku);
            var productKey  = AssetMapper.GetProductNameStructure(sku, this.findProjectJsonProduct(productJson, sku, dontUseCache, undefined, product), product.type);

            if(product.type == "prints"){
                product = _.clone(product); // Need this so the product.type won't change the original object when not using localStorage
                var projectJson = this.findProjectJsonProduct(productJson, sku);
                if(projectJson["prints"].pages.length > 0){
                    product.type = this.GetPrintsByOrientation(projectJson["prints"].pages[0].orientation);
                }
            }

            var size = config.getProductSizes()[product.type];

            if (typeof size === "undefined") {
                console.log('missing size for sku: ' + sku, product);
                return {};
            }

            if (isSprite) {
                productKey = productKey + '_sprite';
            }
            if ('undefined' != typeof size[productKey]) {
                size = size[productKey];
            }

            // Return the real width without the side padding
            size.origWidth  = size.width;
            size.width      = size.width - size.left - size.right;
            size.realHeight = size.height - size.top - size.bottom;

            return size;
        },

        // Given template @tpl and @data - will return HTML of the compiled template.
        renderTemplate: function(tpl, data) {
            var tplCompiled = _.template(tpl);
            return tplCompiled(data);
        },

        isProductRotatable: (function(){
            var rotateSupported = ["mug", "cup", "travelmug", "waterbottle", "cubeor"];
            return function(productType){
                return rotateSupported.indexOf(productType) > -1;
            }
        })(),

        showLoading: function(target) {
            // Check if the overlay if already there
            if ($(target).children('.sfly_wgt_throbber_overlay').length == 0) {
                $(target).append('<div class="sfly_wgt_throbber_overlay"></div><div class="sfly_wgt_loading sfly_wgt_throbber"></div>');
            }
        },

        removeLoading: function(target) {
            if ($('#sfly_wgt_no_enough_photos_popup').length == 0 || !$('#sfly_wgt_no_enough_photos_popup').is(':visible')) {
                $(target).find('.sfly_wgt_throbber').remove();
                $(target).find('.sfly_wgt_throbber_overlay').remove();
            }
        },

        showNewBubblePop : function(container, prodType) {
            var prodType = prodType || 'products';

            return; //todo remove that if the popup is needed
                var hideNewBobblePopup = function () {
                    //$('#sfly_wgt_upp_select').removeClass('sfly-wgt-gray-dark-btn-sfly').addClass('sfly-wgt-gray-btn-sfly');
                    $('.sfly_wgt_bubble_new_upp').hide();
                };
                var popup = $(this.renderTemplate(templates.upp_bubble_hp));
                var rightMargin = {
                    "book": 330,
                    "calendar": 310,
                    "prints": 275
                };
                if (typeof rightMargin[prodType] !== "undefined") {
                    popup.css('right', rightMargin[prodType] + "px");
                }
                container.append(popup);
                //container.find('#sfly_wgt_upp_select').on('click', hideNewBobblePopup).removeClass('sfly-wgt-gray-btn-sfly').addClass('sfly-wgt-gray-dark-btn-sfly');
                popup.find('.sfly-wgt-orange-btn-sfly').on('click', hideNewBobblePopup);
        },

        openNewWindow: function(handler) {
            if (typeof handler !== 'undefined' && handler != null && !handler.closed) {
                handler.close();
            }

            return handler = window.open("","sfly_redirect_" + this.getWindowHandlerId());
        },

        updateProductSize: function(elem, targetWidth, pId, productJson, targetSizes, product) {
            var container               = $(elem).children('.sfly_wgt_product_inner');
            var size                    = this.getProductRealSize(productJson, pId, false, product);
            var targetSize              = targetSizes[pId];
            var ratio                   = targetSize.width / size.width;
            var targetRealWidth         = targetSize.width + (size.right + size.left)*ratio;
            var targetRealHeight        = size.height * ratio;

            container
                .height(targetRealHeight)
                .width(targetRealWidth)
                .attr('data-height',        targetRealHeight)
                .attr('data-width',         targetRealWidth)
                .attr('data-real-height',   targetRealHeight)
                .attr('data-real-width',    size.width*ratio)
                .attr('data-top-size',      size.top*ratio)
                .attr('data-bottom',        size.bottom*ratio)
                .attr('data-left',          size.left*ratio)
                .attr('data-right',         size.right*ratio);
        },

        getTrackingSku: function(sflySku, pId, pType) {
            var sku = sflySku; // default case
            switch (pType) {
                case 'calendar':
                case 'deskcalendar':
                    sku = pType.toUpperCase() + "_" + pId.split("_")[2];
                    break;
                default:
                    break;
                }
            return sku;
        }
    }
});
define('app/view_engine/widgets/widgetVertical', ['underscore', 'app/view_engine/widgets/widget', 'app/cache_module', 'app/config_manager', 'app/utils', 'app/view_engine/widgets/common', 'app/templates', 'app/cookies'], function(_, Widget, cache, config, utils, view_common, templates, cookies) {
    function WidgetVertical(params) {
        Widget.call(this, params);

        this.widgetWidth             = 0;
        this.widgetHeight            = 0;
        this.openWidgetWidth         = 0;
        this.horizontalGap           = 0;
        this.container               = this.Model.get('container');
        this.COOKIE_STATE_NAME       = 'prodwidget.state';

        this.addSideButton = function() {
            // Add the open/close button
            var sideButton = $(view_common.renderTemplate(templates.side_books_button));
            $('body').append(sideButton);
            // Position it in the right position (middle of the side module)
            var right   = parseInt($(this.container).css('right').replace('px', '')) + $(this.container).width() + 2; // +2 for the border
            var top     = parseInt($(this.container).css('top').replace('px', '')) + $(this.container).height()/2 - sideButton.height()/2;
            sideButton
                .css('top', top+'px')
                .css('right', right + 'px')
                .attr('orig-right', right)
                .attr('data-state', 'open')
                .children('.sfly-wgt-arrow')
                .attr('data-state', 'open');
        };

        this.addMainContainer = function() {
            var source = this.params.source;

            $(this.container)
                .html(view_common.renderTemplate(templates.listview_container, { products: source }))
                .children('.sfly_wgt_listview_container')
                .append(view_common.renderTemplate(templates.side_help_title));
        };

        this.positionWidget = function() {
            // Side panel position
            // Position vertical - if has space, position as requested. If no space - push up.
            var menuPosition = this.verticalPos;
            var elementOffset = 0;
            if ($('#promoBannerTop').length) {
                // var scrollTop     = $(window).scrollTop(),
                elementOffset = $('#promoBannerTop').offset().top;
                //menuPosition  = (elementOffset - scrollTop) + $('#siteSubNavContainer').height();
                menuPosition = elementOffset
            } else  if ($('#heroImage').length) {

                elementOffset = $('#heroImage').offset().top;
                menuPosition = elementOffset;
            }

            var verticalPos = $(window).height() < this.widgetHeight + menuPosition ? this.vertical_small : menuPosition;

            $(this.container)
                .css('top', verticalPos)
                .css(this.widgetSide, this.horizontalGap)
                .css('width', this.widgetWidth+'px')
                .css('height', this.widgetHeight+'px')
                .addClass('sfly-wgt-side-open');

            // The open window container position
            $('#sfly_wgt_openwin_container').css('top', verticalPos);
        }

        this.minimizeContainer = function() {
            $('#sfly_wgt_container').css('width', '0px');
        };

        this.positionClosedButton = function() {
            $('.sfly-wgt-btn-sidemodule')
                .hide()
                .css('right', this.horizontalGap + 'px');
        };

        this.getWidgetState = function() {
            // if in homepage we have the Prospect load it as closed
            if (cache.get('prod_type') == "homepage" && $('.signupForm-wrapper').length > 0 && $('.signupForm-wrapper').is(':visible')) {
                return 'closed';
            }

            var cookie = cookies.getCookie(this.COOKIE_STATE_NAME);
            if (cookie != null) {
                return cookie;
            } else {
                return 'open';
            }
        };

        this.showWidget = function() {
            $('#sfly_wgt_container')
                .show()
                .animate({'width': this.widgetWidth + 'px'}, 200);

            $('.sfly-wgt-btn-sidemodule')
                .show()
                .animate({'right': (this.widgetWidth + 2) + 'px'}, 200);
        }
    }

    utils.inheritPrototype(WidgetVertical, Widget);

    WidgetVertical.prototype = {
        init: function() {
            var widgetPosition      = config.getWidgetPosition();

            this.widgetWidth        = widgetPosition.width;
            this.widgetHeight       = widgetPosition.height;
            this.openWidgetWidth    = widgetPosition.openwidth;
            this.horizontalGap      = widgetPosition.horizontal;
            this.vertical_small     = widgetPosition.vertical_small;
            this.verticalPos        = widgetPosition.vertical;
            this.widgetSide         = widgetPosition.side;

            Widget.prototype.init.call(this);
        },

        render: function() {
            this.init();
            this.addMainContainer();
            this.positionWidget();
            this.addSideButton();
            this.minimizeContainer();
            this.positionClosedButton();

            if (this.getWidgetState() == 'open') {
                this.showWidget();
            }

            // Remove classes added on hover on product
            var that = this;
            $(this.container).on('mouseleave', function() {
                that.viewEngine.removeHoverStates(this);
            });

            Widget.prototype.render.call(this, this.params);
        }
    };

    return WidgetVertical;
});
window.MgThumbGenerator=function(t){function e(r){if(n[r])return n[r].exports;var i=n[r]={i:r,l:!1,exports:{}};return t[r].call(i.exports,i,i.exports,e),i.l=!0,i.exports}var n={};return e.m=t,e.c=n,e.d=function(t,n,r){e.o(t,n)||Object.defineProperty(t,n,{configurable:!1,enumerable:!0,get:r})},e.n=function(t){var n=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(n,"a",n),n},e.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e.p="",e(e.s=41)}([function(t,e,n){var r=n(26)("wks"),i=n(18),o=n(1).Symbol,a="function"==typeof o;(t.exports=function(t){return r[t]||(r[t]=a&&o[t]||(a?o:i)("Symbol."+t))}).store=r},function(t,e){var n=t.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=n)},function(t,e){},function(t,e){var n=t.exports={version:"2.5.7"};"number"==typeof __e&&(__e=n)},function(t,e,n){var r=n(7);t.exports=function(t){if(!r(t))throw TypeError(t+" is not an object!");return t}},function(t,e,n){var r=n(11),i=n(28);t.exports=n(8)?function(t,e,n){return r.f(t,e,i(1,n))}:function(t,e,n){return t[e]=n,t}},function(t,e,n){var r=n(1),i=n(5),o=n(12),a=n(18)("src"),s=Function.toString,u=(""+s).split("toString");n(3).inspectSource=function(t){return s.call(t)},(t.exports=function(t,e,n,s){var h="function"==typeof n;h&&(o(n,"name")||i(n,"name",e)),t[e]!==n&&(h&&(o(n,a)||i(n,a,t[e]?""+t[e]:u.join(String(e)))),t===r?t[e]=n:s?t[e]?t[e]=n:i(t,e,n):(delete t[e],i(t,e,n)))})(Function.prototype,"toString",function(){return"function"==typeof this&&this[a]||s.call(this)})},function(t,e){t.exports=function(t){return"object"==typeof t?null!==t:"function"==typeof t}},function(t,e,n){t.exports=!n(27)(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},function(t,e){t.exports={}},function(t,e){var n={}.toString;t.exports=function(t){return n.call(t).slice(8,-1)}},function(t,e,n){var r=n(4),i=n(44),o=n(45),a=Object.defineProperty;e.f=n(8)?Object.defineProperty:function(t,e,n){if(r(t),e=o(e,!0),r(n),i)try{return a(t,e,n)}catch(t){}if("get"in n||"set"in n)throw TypeError("Accessors not supported!");return"value"in n&&(t[e]=n.value),t}},function(t,e){var n={}.hasOwnProperty;t.exports=function(t,e){return n.call(t,e)}},function(t,e,n){var r=n(1),i=n(3),o=n(5),a=n(6),s=n(14),u=function(t,e,n){var h,c,l,f,d=t&u.F,p=t&u.G,g=t&u.S,v=t&u.P,m=t&u.B,y=p?r:g?r[e]||(r[e]={}):(r[e]||{}).prototype,w=p?i:i[e]||(i[e]={}),x=w.prototype||(w.prototype={});p&&(n=e);for(h in n)c=!d&&y&&void 0!==y[h],l=(c?y:n)[h],f=m&&c?s(l,r):v&&"function"==typeof l?s(Function.call,l):l,y&&a(y,h,l,t&u.U),w[h]!=l&&o(w,h,f),v&&x[h]!=l&&(x[h]=l)};r.core=i,u.F=1,u.G=2,u.S=4,u.P=8,u.B=16,u.W=32,u.U=64,u.R=128,t.exports=u},function(t,e,n){var r=n(15);t.exports=function(t,e,n){if(r(t),void 0===e)return t;switch(n){case 1:return function(n){return t.call(e,n)};case 2:return function(n,r){return t.call(e,n,r)};case 3:return function(n,r,i){return t.call(e,n,r,i)}}return function(){return t.apply(e,arguments)}}},function(t,e){t.exports=function(t){if("function"!=typeof t)throw TypeError(t+" is not a function!");return t}},function(t,e,n){var r=n(10),i=n(0)("toStringTag"),o="Arguments"==r(function(){return arguments}()),a=function(t,e){try{return t[e]}catch(t){}};t.exports=function(t){var e,n,s;return void 0===t?"Undefined":null===t?"Null":"string"==typeof(n=a(e=Object(t),i))?n:o?r(e):"Object"==(s=r(e))&&"function"==typeof e.callee?"Arguments":s}},function(t,e){t.exports=!1},function(t,e){var n=0,r=Math.random();t.exports=function(t){return"Symbol(".concat(void 0===t?"":t,")_",(++n+r).toString(36))}},function(t,e,n){var r=n(7),i=n(1).document,o=r(i)&&r(i.createElement);t.exports=function(t){return o?i.createElement(t):{}}},function(t,e){var n=Math.ceil,r=Math.floor;t.exports=function(t){return isNaN(t=+t)?0:(t>0?r:n)(t)}},function(t,e){t.exports=function(t){if(void 0==t)throw TypeError("Can't call method on  "+t);return t}},function(t,e,n){var r=n(52),i=n(21);t.exports=function(t){return r(i(t))}},function(t,e,n){var r=n(26)("keys"),i=n(18);t.exports=function(t){return r[t]||(r[t]=i(t))}},function(t,e,n){var r=n(11).f,i=n(12),o=n(0)("toStringTag");t.exports=function(t,e,n){t&&!i(t=n?t:t.prototype,o)&&r(t,o,{configurable:!0,value:e})}},function(t,e,n){"use strict";function r(t){var e,n;this.promise=new t(function(t,r){if(void 0!==e||void 0!==n)throw TypeError("Bad Promise constructor");e=t,n=r}),this.resolve=i(e),this.reject=i(n)}var i=n(15);t.exports.f=function(t){return new r(t)}},function(t,e,n){var r=n(3),i=n(1),o=i["__core-js_shared__"]||(i["__core-js_shared__"]={});(t.exports=function(t,e){return o[t]||(o[t]=void 0!==e?e:{})})("versions",[]).push({version:r.version,mode:n(17)?"pure":"global",copyright:"© 2018 Denis Pushkarev (zloirock.ru)"})},function(t,e){t.exports=function(t){try{return!!t()}catch(t){return!0}}},function(t,e){t.exports=function(t,e){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:e}}},function(t,e,n){"use strict";var r=n(17),i=n(13),o=n(6),a=n(5),s=n(9),u=n(48),h=n(24),c=n(55),l=n(0)("iterator"),f=!([].keys&&"next"in[].keys()),d=function(){return this};t.exports=function(t,e,n,p,g,v,m){u(n,e,p);var y,w,x,b=function(t){if(!f&&t in k)return k[t];switch(t){case"keys":case"values":return function(){return new n(this,t)}}return function(){return new n(this,t)}},_=e+" Iterator",S="values"==g,M=!1,k=t.prototype,P=k[l]||k["@@iterator"]||g&&k[g],I=P||b(g),E=g?S?b("entries"):I:void 0,O="Array"==e?k.entries||P:P;if(O&&(x=c(O.call(new t)))!==Object.prototype&&x.next&&(h(x,_,!0),r||"function"==typeof x[l]||a(x,l,d)),S&&P&&"values"!==P.name&&(M=!0,I=function(){return P.call(this)}),r&&!m||!f&&!M&&k[l]||a(k,l,I),s[e]=I,s[_]=d,g)if(y={values:S?I:b("values"),keys:v?I:b("keys"),entries:E},m)for(w in y)w in k||o(k,w,y[w]);else i(i.P+i.F*(f||M),e,y);return y}},function(t,e,n){var r=n(51),i=n(32);t.exports=Object.keys||function(t){return r(t,i)}},function(t,e,n){var r=n(20),i=Math.min;t.exports=function(t){return t>0?i(r(t),9007199254740991):0}},function(t,e){t.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(t,e,n){var r=n(1).document;t.exports=r&&r.documentElement},function(t,e,n){var r=n(4),i=n(15),o=n(0)("species");t.exports=function(t,e){var n,a=r(t).constructor;return void 0===a||void 0==(n=r(a)[o])?e:i(n)}},function(t,e,n){var r,i,o,a=n(14),s=n(67),u=n(33),h=n(19),c=n(1),l=c.process,f=c.setImmediate,d=c.clearImmediate,p=c.MessageChannel,g=c.Dispatch,v=0,m={},y=function(){var t=+this;if(m.hasOwnProperty(t)){var e=m[t];delete m[t],e()}},w=function(t){y.call(t.data)};f&&d||(f=function(t){for(var e=[],n=1;arguments.length>n;)e.push(arguments[n++]);return m[++v]=function(){s("function"==typeof t?t:Function(t),e)},r(v),v},d=function(t){delete m[t]},"process"==n(10)(l)?r=function(t){l.nextTick(a(y,t,1))}:g&&g.now?r=function(t){g.now(a(y,t,1))}:p?(i=new p,o=i.port2,i.port1.onmessage=w,r=a(o.postMessage,o,1)):c.addEventListener&&"function"==typeof postMessage&&!c.importScripts?(r=function(t){c.postMessage(t+"","*")},c.addEventListener("message",w,!1)):r="onreadystatechange"in h("script")?function(t){u.appendChild(h("script")).onreadystatechange=function(){u.removeChild(this),y.call(t)}}:function(t){setTimeout(a(y,t,1),0)}),t.exports={set:f,clear:d}},function(t,e){t.exports=function(t){try{return{e:!1,v:t()}}catch(t){return{e:!0,v:t}}}},function(t,e,n){var r=n(4),i=n(7),o=n(25);t.exports=function(t,e){if(r(t),i(e)&&e.constructor===t)return e;var n=o.f(t);return(0,n.resolve)(e),n.promise}},function(t,e){var n;n=function(){return this}();try{n=n||Function("return this")()||(0,eval)("this")}catch(t){"object"==typeof window&&(n=window)}t.exports=n},function(t,e,n){"use strict";(function(e){var r=n(80),i=n(81),o=n(82),a={decodeBase64Image:function(t){var n=t.match(/^data:([A-Za-z-+\/]+);base64,(.+)$/),r={};return 3!==n.length?new Error("Invalid input string"):(r.type=n[1],r.data=new e(n[2],"base64"),r)},download:function(t,e,n){if(t.startsWith("data:image/")){var i=a.decodeBase64Image(t);return void r.writeFile(e,i.data,n)}o.head(t,function(i,a,s){i?console.error("Had an error in head request "+i):200===a.statusCode?o(t).pipe(r.createWriteStream(e)).on("close",n):console.error("Download error, Status Code: "+a.statusCode+" "+t)})},isBrowser:function(){try{return"undefined"!=typeof window}catch(t){return!1}},pathCreator:function(t,e,n){var o=i.tmpdir()+"/ThumbService/assets/";r.existsSync(o+t)?r.existsSync(o+t+"/layers")?r.existsSync(o+t+"/layers/"+e)?r.existsSync(o+t+"/layers/"+e+"/"+n)||r.mkdirSync(o+t+"/layers/"+e+"/"+n):(r.mkdirSync(o+t+"/layers/"+e),r.mkdirSync(o+t+"/layers/"+e+"/"+n)):(r.mkdirSync(o+t+"/layers"),r.mkdirSync(o+t+"/layers/"+e),r.mkdirSync(o+t+"/layers/"+e+"/"+n)):(r.mkdirSync(o+t),r.mkdirSync(o+t+"/layers"),r.mkdirSync(o+t+"/layers/"+e),r.mkdirSync(o+t+"/layers/"+e+"/"+n))},directoryInit:function(t,e,n){var o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;try{r.existsSync(i.tmpdir()+"/ThumbService")?r.existsSync(i.tmpdir()+"/ThumbService/"+o)||r.mkdirSync(i.tmpdir()+"/ThumbService/"+o):(r.mkdirSync(i.tmpdir()+"/ThumbService"),r.mkdirSync(i.tmpdir()+"/ThumbService/"+o))}catch(t){throw console.log("Static asset definitions will be applied."),"Utilities::directoryInit Failed to Create folder structure "+t}},clean:function(t,e){var n=i.tmpdir()+"/ThumbService/"+e+"/";r.readdir(n,function(e,i){i.forEach(function(e){e.indexOf(t)>-1&&r.unlink(n+e,function(t){t&&console.log(t),console.log("Deleted file: "+e)})})})},getHomePath:function(){if(i.hasOwnProperty("tmpdir"))return i.tmpdir()+"/ThumbService/"},imgDownload:function(t,e,n){r.access(t,function(r){r&&"ENOENT"===r.code?a.download(n,t,function(){e.src=t}):e.src=t})}};t.exports=a}).call(e,n(76).Buffer)},function(t,e,n){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var i=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),o=n(39),a=o.isBrowser,s=function(){function t(){r(this,t)}return i(t,[{key:"createCanvas",value:function(t,e){if(a())var r=document.createElement("canvas");else var i=n(2),o=i.createCanvas,r=o("canvas");return r.width=t,r.height=e,r}},{key:"getContext",value:function(t){return t.getContext("2d")}}]),t}();t.exports.Creators=s;var u=function(){function t(){r(this,t)}return i(t,[{key:"dist",value:function(t,e,n,r){return Math.sqrt(Math.pow(t-n,2)+Math.pow(e-r,2))}},{key:"targetDimensions",value:function(t){return{width:this.dist(t.nww,t.nwh,t.new,t.neh),height:this.dist(t.nww,t.nwh,t.sww,t.swh)}}},{key:"degToRad",value:function(t){return t*Math.PI/180}}]),t}();t.exports.Computations=u},function(t,e,n){n(42),t.exports=n(75)},function(t,e,n){n(43),n(46),n(57),n(61),n(73),n(74),t.exports=n(3).Promise},function(t,e,n){"use strict";var r=n(16),i={};i[n(0)("toStringTag")]="z",i+""!="[object z]"&&n(6)(Object.prototype,"toString",function(){return"[object "+r(this)+"]"},!0)},function(t,e,n){t.exports=!n(8)&&!n(27)(function(){return 7!=Object.defineProperty(n(19)("div"),"a",{get:function(){return 7}}).a})},function(t,e,n){var r=n(7);t.exports=function(t,e){if(!r(t))return t;var n,i;if(e&&"function"==typeof(n=t.toString)&&!r(i=n.call(t)))return i;if("function"==typeof(n=t.valueOf)&&!r(i=n.call(t)))return i;if(!e&&"function"==typeof(n=t.toString)&&!r(i=n.call(t)))return i;throw TypeError("Can't convert object to primitive value")}},function(t,e,n){"use strict";var r=n(47)(!0);n(29)(String,"String",function(t){this._t=String(t),this._i=0},function(){var t,e=this._t,n=this._i;return n>=e.length?{value:void 0,done:!0}:(t=r(e,n),this._i+=t.length,{value:t,done:!1})})},function(t,e,n){var r=n(20),i=n(21);t.exports=function(t){return function(e,n){var o,a,s=String(i(e)),u=r(n),h=s.length;return u<0||u>=h?t?"":void 0:(o=s.charCodeAt(u),o<55296||o>56319||u+1===h||(a=s.charCodeAt(u+1))<56320||a>57343?t?s.charAt(u):o:t?s.slice(u,u+2):a-56320+(o-55296<<10)+65536)}}},function(t,e,n){"use strict";var r=n(49),i=n(28),o=n(24),a={};n(5)(a,n(0)("iterator"),function(){return this}),t.exports=function(t,e,n){t.prototype=r(a,{next:i(1,n)}),o(t,e+" Iterator")}},function(t,e,n){var r=n(4),i=n(50),o=n(32),a=n(23)("IE_PROTO"),s=function(){},u=function(){var t,e=n(19)("iframe"),r=o.length;for(e.style.display="none",n(33).appendChild(e),e.src="javascript:",t=e.contentWindow.document,t.open(),t.write("<script>document.F=Object<\/script>"),t.close(),u=t.F;r--;)delete u.prototype[o[r]];return u()};t.exports=Object.create||function(t,e){var n;return null!==t?(s.prototype=r(t),n=new s,s.prototype=null,n[a]=t):n=u(),void 0===e?n:i(n,e)}},function(t,e,n){var r=n(11),i=n(4),o=n(30);t.exports=n(8)?Object.defineProperties:function(t,e){i(t);for(var n,a=o(e),s=a.length,u=0;s>u;)r.f(t,n=a[u++],e[n]);return t}},function(t,e,n){var r=n(12),i=n(22),o=n(53)(!1),a=n(23)("IE_PROTO");t.exports=function(t,e){var n,s=i(t),u=0,h=[];for(n in s)n!=a&&r(s,n)&&h.push(n);for(;e.length>u;)r(s,n=e[u++])&&(~o(h,n)||h.push(n));return h}},function(t,e,n){var r=n(10);t.exports=Object("z").propertyIsEnumerable(0)?Object:function(t){return"String"==r(t)?t.split(""):Object(t)}},function(t,e,n){var r=n(22),i=n(31),o=n(54);t.exports=function(t){return function(e,n,a){var s,u=r(e),h=i(u.length),c=o(a,h);if(t&&n!=n){for(;h>c;)if((s=u[c++])!=s)return!0}else for(;h>c;c++)if((t||c in u)&&u[c]===n)return t||c||0;return!t&&-1}}},function(t,e,n){var r=n(20),i=Math.max,o=Math.min;t.exports=function(t,e){return t=r(t),t<0?i(t+e,0):o(t,e)}},function(t,e,n){var r=n(12),i=n(56),o=n(23)("IE_PROTO"),a=Object.prototype;t.exports=Object.getPrototypeOf||function(t){return t=i(t),r(t,o)?t[o]:"function"==typeof t.constructor&&t instanceof t.constructor?t.constructor.prototype:t instanceof Object?a:null}},function(t,e,n){var r=n(21);t.exports=function(t){return Object(r(t))}},function(t,e,n){for(var r=n(58),i=n(30),o=n(6),a=n(1),s=n(5),u=n(9),h=n(0),c=h("iterator"),l=h("toStringTag"),f=u.Array,d={CSSRuleList:!0,CSSStyleDeclaration:!1,CSSValueList:!1,ClientRectList:!1,DOMRectList:!1,DOMStringList:!1,DOMTokenList:!0,DataTransferItemList:!1,FileList:!1,HTMLAllCollection:!1,HTMLCollection:!1,HTMLFormElement:!1,HTMLSelectElement:!1,MediaList:!0,MimeTypeArray:!1,NamedNodeMap:!1,NodeList:!0,PaintRequestList:!1,Plugin:!1,PluginArray:!1,SVGLengthList:!1,SVGNumberList:!1,SVGPathSegList:!1,SVGPointList:!1,SVGStringList:!1,SVGTransformList:!1,SourceBufferList:!1,StyleSheetList:!0,TextTrackCueList:!1,TextTrackList:!1,TouchList:!1},p=i(d),g=0;g<p.length;g++){var v,m=p[g],y=d[m],w=a[m],x=w&&w.prototype;if(x&&(x[c]||s(x,c,f),x[l]||s(x,l,m),u[m]=f,y))for(v in r)x[v]||o(x,v,r[v],!0)}},function(t,e,n){"use strict";var r=n(59),i=n(60),o=n(9),a=n(22);t.exports=n(29)(Array,"Array",function(t,e){this._t=a(t),this._i=0,this._k=e},function(){var t=this._t,e=this._k,n=this._i++;return!t||n>=t.length?(this._t=void 0,i(1)):"keys"==e?i(0,n):"values"==e?i(0,t[n]):i(0,[n,t[n]])},"values"),o.Arguments=o.Array,r("keys"),r("values"),r("entries")},function(t,e,n){var r=n(0)("unscopables"),i=Array.prototype;void 0==i[r]&&n(5)(i,r,{}),t.exports=function(t){i[r][t]=!0}},function(t,e){t.exports=function(t,e){return{value:e,done:!!t}}},function(t,e,n){"use strict";var r,i,o,a,s=n(17),u=n(1),h=n(14),c=n(16),l=n(13),f=n(7),d=n(15),p=n(62),g=n(63),v=n(34),m=n(35).set,y=n(68)(),w=n(25),x=n(36),b=n(69),_=n(37),S=u.TypeError,M=u.process,k=M&&M.versions,P=k&&k.v8||"",I=u.Promise,E="process"==c(M),O=function(){},A=i=w.f,T=!!function(){try{var t=I.resolve(1),e=(t.constructor={})[n(0)("species")]=function(t){t(O,O)};return(E||"function"==typeof PromiseRejectionEvent)&&t.then(O)instanceof e&&0!==P.indexOf("6.6")&&-1===b.indexOf("Chrome/66")}catch(t){}}(),R=function(t){var e;return!(!f(t)||"function"!=typeof(e=t.then))&&e},C=function(t,e){if(!t._n){t._n=!0;var n=t._c;y(function(){for(var r=t._v,i=1==t._s,o=0;n.length>o;)!function(e){var n,o,a,s=i?e.ok:e.fail,u=e.resolve,h=e.reject,c=e.domain;try{s?(i||(2==t._h&&B(t),t._h=1),!0===s?n=r:(c&&c.enter(),n=s(r),c&&(c.exit(),a=!0)),n===e.promise?h(S("Promise-chain cycle")):(o=R(n))?o.call(n,u,h):u(n)):h(r)}catch(t){c&&!a&&c.exit(),h(t)}}(n[o++]);t._c=[],t._n=!1,e&&!t._h&&z(t)})}},z=function(t){m.call(u,function(){var e,n,r,i=t._v,o=D(t);if(o&&(e=x(function(){E?M.emit("unhandledRejection",i,t):(n=u.onunhandledrejection)?n({promise:t,reason:i}):(r=u.console)&&r.error&&r.error("Unhandled promise rejection",i)}),t._h=E||D(t)?2:1),t._a=void 0,o&&e.e)throw e.v})},D=function(t){return 1!==t._h&&0===(t._a||t._c).length},B=function(t){m.call(u,function(){var e;E?M.emit("rejectionHandled",t):(e=u.onrejectionhandled)&&e({promise:t,reason:t._v})})},j=function(t){var e=this;e._d||(e._d=!0,e=e._w||e,e._v=t,e._s=2,e._a||(e._a=e._c.slice()),C(e,!0))},U=function(t){var e,n=this;if(!n._d){n._d=!0,n=n._w||n;try{if(n===t)throw S("Promise can't be resolved itself");(e=R(t))?y(function(){var r={_w:n,_d:!1};try{e.call(t,h(U,r,1),h(j,r,1))}catch(t){j.call(r,t)}}):(n._v=t,n._s=1,C(n,!1))}catch(t){j.call({_w:n,_d:!1},t)}}};T||(I=function(t){p(this,I,"Promise","_h"),d(t),r.call(this);try{t(h(U,this,1),h(j,this,1))}catch(t){j.call(this,t)}},r=function(t){this._c=[],this._a=void 0,this._s=0,this._d=!1,this._v=void 0,this._h=0,this._n=!1},r.prototype=n(70)(I.prototype,{then:function(t,e){var n=A(v(this,I));return n.ok="function"!=typeof t||t,n.fail="function"==typeof e&&e,n.domain=E?M.domain:void 0,this._c.push(n),this._a&&this._a.push(n),this._s&&C(this,!1),n.promise},catch:function(t){return this.then(void 0,t)}}),o=function(){var t=new r;this.promise=t,this.resolve=h(U,t,1),this.reject=h(j,t,1)},w.f=A=function(t){return t===I||t===a?new o(t):i(t)}),l(l.G+l.W+l.F*!T,{Promise:I}),n(24)(I,"Promise"),n(71)("Promise"),a=n(3).Promise,l(l.S+l.F*!T,"Promise",{reject:function(t){var e=A(this);return(0,e.reject)(t),e.promise}}),l(l.S+l.F*(s||!T),"Promise",{resolve:function(t){return _(s&&this===a?I:this,t)}}),l(l.S+l.F*!(T&&n(72)(function(t){I.all(t).catch(O)})),"Promise",{all:function(t){var e=this,n=A(e),r=n.resolve,i=n.reject,o=x(function(){var n=[],o=0,a=1;g(t,!1,function(t){var s=o++,u=!1;n.push(void 0),a++,e.resolve(t).then(function(t){u||(u=!0,n[s]=t,--a||r(n))},i)}),--a||r(n)});return o.e&&i(o.v),n.promise},race:function(t){var e=this,n=A(e),r=n.reject,i=x(function(){g(t,!1,function(t){e.resolve(t).then(n.resolve,r)})});return i.e&&r(i.v),n.promise}})},function(t,e){t.exports=function(t,e,n,r){if(!(t instanceof e)||void 0!==r&&r in t)throw TypeError(n+": incorrect invocation!");return t}},function(t,e,n){var r=n(14),i=n(64),o=n(65),a=n(4),s=n(31),u=n(66),h={},c={},e=t.exports=function(t,e,n,l,f){var d,p,g,v,m=f?function(){return t}:u(t),y=r(n,l,e?2:1),w=0;if("function"!=typeof m)throw TypeError(t+" is not iterable!");if(o(m)){for(d=s(t.length);d>w;w++)if((v=e?y(a(p=t[w])[0],p[1]):y(t[w]))===h||v===c)return v}else for(g=m.call(t);!(p=g.next()).done;)if((v=i(g,y,p.value,e))===h||v===c)return v};e.BREAK=h,e.RETURN=c},function(t,e,n){var r=n(4);t.exports=function(t,e,n,i){try{return i?e(r(n)[0],n[1]):e(n)}catch(e){var o=t.return;throw void 0!==o&&r(o.call(t)),e}}},function(t,e,n){var r=n(9),i=n(0)("iterator"),o=Array.prototype;t.exports=function(t){return void 0!==t&&(r.Array===t||o[i]===t)}},function(t,e,n){var r=n(16),i=n(0)("iterator"),o=n(9);t.exports=n(3).getIteratorMethod=function(t){if(void 0!=t)return t[i]||t["@@iterator"]||o[r(t)]}},function(t,e){t.exports=function(t,e,n){var r=void 0===n;switch(e.length){case 0:return r?t():t.call(n);case 1:return r?t(e[0]):t.call(n,e[0]);case 2:return r?t(e[0],e[1]):t.call(n,e[0],e[1]);case 3:return r?t(e[0],e[1],e[2]):t.call(n,e[0],e[1],e[2]);case 4:return r?t(e[0],e[1],e[2],e[3]):t.call(n,e[0],e[1],e[2],e[3])}return t.apply(n,e)}},function(t,e,n){var r=n(1),i=n(35).set,o=r.MutationObserver||r.WebKitMutationObserver,a=r.process,s=r.Promise,u="process"==n(10)(a);t.exports=function(){var t,e,n,h=function(){var r,i;for(u&&(r=a.domain)&&r.exit();t;){i=t.fn,t=t.next;try{i()}catch(r){throw t?n():e=void 0,r}}e=void 0,r&&r.enter()};if(u)n=function(){a.nextTick(h)};else if(!o||r.navigator&&r.navigator.standalone)if(s&&s.resolve){var c=s.resolve(void 0);n=function(){c.then(h)}}else n=function(){i.call(r,h)};else{var l=!0,f=document.createTextNode("");new o(h).observe(f,{characterData:!0}),n=function(){f.data=l=!l}}return function(r){var i={fn:r,next:void 0};e&&(e.next=i),t||(t=i,n()),e=i}}},function(t,e,n){var r=n(1),i=r.navigator;t.exports=i&&i.userAgent||""},function(t,e,n){var r=n(6);t.exports=function(t,e,n){for(var i in e)r(t,i,e[i],n);return t}},function(t,e,n){"use strict";var r=n(1),i=n(11),o=n(8),a=n(0)("species");t.exports=function(t){var e=r[t];o&&e&&!e[a]&&i.f(e,a,{configurable:!0,get:function(){return this}})}},function(t,e,n){var r=n(0)("iterator"),i=!1;try{var o=[7][r]();o.return=function(){i=!0},Array.from(o,function(){throw 2})}catch(t){}t.exports=function(t,e){if(!e&&!i)return!1;var n=!1;try{var o=[7],a=o[r]();a.next=function(){return{done:n=!0}},o[r]=function(){return a},t(o)}catch(t){}return n}},function(t,e,n){"use strict";var r=n(13),i=n(3),o=n(1),a=n(34),s=n(37);r(r.P+r.R,"Promise",{finally:function(t){var e=a(this,i.Promise||o.Promise),n="function"==typeof t;return this.then(n?function(n){return s(e,t()).then(function(){return n})}:t,n?function(n){return s(e,t()).then(function(){throw n})}:t)}})},function(t,e,n){"use strict";var r=n(13),i=n(25),o=n(36);r(r.S,"Promise",{try:function(t){var e=i.f(this),n=o(t);return(n.e?e.reject:e.resolve)(n.v),e.promise}})},function(t,e,n){"use strict";(function(e){function r(t){function e(t,e,n){void 0===(void 0===n?"undefined":i(n))&&(n="prod");var r="products";if("book"===t||"photobook"===t?r="photobook":"calendar"!==t&&"deskcalendar"!==t||(r="calendar"),"calendar"===t&&(e=e.replace("cal_","")),"products"===r)if(-1!==e.indexOf("_")){var o=e.split("_");q=W+"/"+r+"/assets/medium/masks/"+o[2]+"/"+o[0]+"/"+o[1]}else q=W+"/"+r+"/assets/medium/masks/"+e;else H=W+"/"+r+"/assets/medium/assets/"+e+"/embellishments",G=W+"/"+r+"/assets/medium/assets/"+e+"/backgrounds";F="https://www.shutterfly.com/",X="https://text.shutterfly.com/web2print/personalize/textbox/",u()&&-1!==J.indexOf(window.location.hostname)&&"prod"!==n&&(F="https://www."+n+".shutterfly.com/",X="https://text."+n+".shutterfly.com/web2print/personalize/textbox/"),F+="creationpath/text/preview?"}function r(t){return"Error: [div: "+U.divId+"]: "+t}function c(){var t=U.productType,e={};e="book"===t||"prints"===t?U.projectJson[t].photoStrip:U.projectJson.product.photoStrip;var n={};for(var r in e)if(e.hasOwnProperty(r)){var i=e[r];n[i.photoRefId]=i}return n}function l(t){var e=f(t,U.productType);return null!==e&&Object.keys(e).length>0?x(e,U.productType,U.layoutJson,t):(j&&console.error(r("Requested num="+t+" not found!")),null)}function f(t,e){return isNaN(parseInt(t))||t<0?(j&&console.error(r("illegal num: "+t)),null):p(t,e)}function d(t,e){if(t>99)return j&&console.error(r("NUM value="+t+", too big")),null;if("book"===e)return 0===t?"cover":1===t?"title":t>1&&t<99?"inner":99===t?"back":null;if("calendar"===e)return 0===t?"cover":t>0&&t<36?"inner":null;if(-1!==V.indexOf(e))return t<0||t>4?null:"front";if("prints"===e){var n=U.projectJson.prints.pages;if(void 0!==n[t]&&void 0!==n[t].orientation)return n[t].orientation}return-1!==Z.indexOf(e)?0===t?"cover":t>=1&&t<=12?{month:t}:null:0===t?"front":(j&&console.error(r("NUM value="+t+" is not supported for PRODUCT_TYPE="+e)),null)}function p(t,e){return"book"===e?g(t):"prints"===e?m(t):"calendar"===e?v(t):-1!==Z.indexOf(e)?y(t,e):w(d(t,e))}function g(t){var e=U.projectJson.book.pages;if(99!==t&&e.length<2*t)return j&&console.error(r("NUM value="+t+" exceeds 'pages' array length")),null;var n=[];if(99===t)n[t]=e[e.length-1];else if(t<2)n[t]=e[t];else{var i=2*(t-1);n[i]=e[i],n[i+1]=e[i+1]}return 0===n.length?null:n}function v(t){var e=U.projectJson.product.pages;if(t>0&&void 0===e[t])return j&&console.error(r("NUM value="+t+" does not exist in pages of calendar")),null;var n=[];if(t<1)n[t]=e[t];else{var i=2*t-1;n[i]=e[i],n[i+1]=e[i+1]}return 0===n.length?null:n}function m(t){var e=U.projectJson.prints.pages;return void 0===e[t]?(j&&console.error(r("NUM value="+t+" does not exist in pages of prints")),null):t>=0&&t<=e.length?e[t]:null}function y(t,e){var n=U.projectJson.product.surfaces;if(t>0&&void 0===n[t])return j&&console.error(r("NUM value="+t+" does not exist in pages of calendar")),null;var i=[];if(0===t)i[0]=w(d(t,e));else{if(!(t>=1&&t<=12))return null;i[t]=n[t]}return i}function w(t){var e=U.projectJson;if(void 0!==e.product.surfaces)for(var n in e.product.surfaces)if(e.product.surfaces.hasOwnProperty(n)){var r=e.product.surfaces[n];if(r.type===t)return r}return null}function x(t,e,n,r){switch(U.currentSurface=d(r,e),e){case"book":case"calendar":case"deskcalendar":return _(t,n,e);case"prints":default:return b(t,n,e,r)}}function b(t,e,n,r){var i={};-1!==V.indexOf(n)?U.thumbnailJson[U.currentSurface]=U.thumbnailJson[U.currentSurface][r]:U.thumbnailJson[U.currentSurface]=Array.isArray(U.thumbnailJson[U.currentSurface])?U.thumbnailJson[U.currentSurface][0]:U.thumbnailJson[U.currentSurface];var o=U.thumbnailJson[U.currentSurface].canvases,a=o[0].width,s=o[0].height,u=t.canvas.layout.layoutId;"prints"===n&&(u="prints_default");var h=k(e[u],a,s,1,t.canvas.layout),c=t.canvas.layout.photos,l=P(c,h),f=I(l,c),d={};d.width=a,d.height=s,d.mask_img="";var p=void 0!==e[u].useMask&&e[u].useMask;return"string"==typeof e[u].useMask&&(p="1"===e[u].useMask),p&&(d.mask_img=E(u)),d.cells=R(h,f,u),d.back_img="",void 0!==e[u].bgColor&&""!==e[u].bgColor&&"#"===e[u].bgColor.substr(0,1)&&(d.back_img=e[u].bgColor),void 0!==o[0].transformation?d.transformation=o[0].transformation:delete d.transformation,void 0!==o[0].offset?d.offset=o[0].offset:delete d.offset,void 0!==o[0].cropping?d.cropping=o[0].cropping:delete d.cropping,void 0!==o[0].cylinderize?d.cylinderize=o[0].cylinderize:delete d.cylinderize,i[0]=d,i}function _(t,e,n){var r={},o=0,a=[];"book"===n&&void 0!==t[0]&&1===Object.keys(t).length&&"frontCover"===t[0].type&&(t=S(t));var s=null,u="none";-1!==Z.indexOf(n)&&null!==U.currentSurface&&"object"===i(U.currentSurface)?(s=M(U.thumbnailJson,U.currentSurface),a=s.canvases,u=null!==s&&void 0!==s?s.backgroundId:"none"):a=U.thumbnailJson[U.currentSurface].canvases;for(var h in t)if(t.hasOwnProperty(h)){var c=t[h],l=a[o].width,f=a[o].height,d=c.canvas.layout.layoutId,p=k(e[d],l,f,1,c.canvas.layout),g=c.canvas.layout.photos,v=P(g,p),m=I(v,g),y={};if(y.width=l,y.height=f,y.mask_img="",y.cells=R(p,m,d),y.back_img="","book"===n||"calendar"===n){var w=c.canvas.backgroundId;y.back_img=T(w)}if(-1!==Z.indexOf(n)){var x="none";"cover"===c.type?x=c.canvas.backgroundId:(x=u,"calendar"===n&&-1===c.pageNum&&(x+="_bottom")),y.back_img=T(x)}void 0!==a[o].transformation?y.transformation=a[o].transformation:delete y.transformation,void 0!==a[o].offset?y.offset=a[o].offset:delete y.offset,void 0!==a[o].cropping?y.cropping=a[o].cropping:delete y.cropping,r[o]=y,o++}return r}function S(t){if(1!==Object.keys(t).length)return t;var e={};return e.type="none",e.pageNum=-1,e.canvas={},e.canvas.layout={},e.canvas.layout.layoutId="8x8hard_universal_00_00L00P00S_a_debosspreview",e.canvas.layout.photos=[],e.canvas.backgroundId="spine",e.canvas.photosBehindCanvas="1",t[1]=e,t}function M(t,e){var n=Object.keys(e)[0],r=e[n];return t[n][r]}function k(t,e,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{},a={},s=r,u=1,h=1;for(var c in t)if(t.hasOwnProperty(c)){var l={},f=t[c];if("object"!==(void 0===f?"undefined":i(f))||void 0===f.x)continue;if(void 0!==f.b)continue;if(void 0===f.sx&&(f.sx=1),void 0===f.sy&&(f.sy=1),void 0!==f.e&&(l.e=f.e),void 0!==f.t){if(l.t=f.t,l.text="",void 0!==f.font&&(l.font=f.font.replace(new RegExp(" ","g"),"+"),l.size=f.size,l.color=f.color.replace("#","%23"),l.bold=void 0!==f.bold&&f.bold,l.italic=void 0!==f.italic&&f.italic,l.underline=void 0!==f.underline&&f.underline,l.horizontalJustification=void 0!==f.horizontalJustification?f.horizontalJustification:"center",l.verticalJustification=void 0!==f.verticalJustification?f.verticalJustification:" middle",l.f_width=Math.round(2*f.w*e/100),l.f_height=Math.round(2*f.h*n/100),l.textAreaWidth=void 0!==f.textAreaWidth?f.textAreaWidth:null,l.textAreaHeight=void 0!==f.textAreaHeight?f.textAreaHeight:null,void 0!==o.textareas))for(var d=0;d<o.textareas.length;d++)if(o.textareas[d].id===f.id){l.text=o.textareas[d].text.replace(new RegExp("/\r\n|\r|\n","g"),"%0A").replace("&","%26").replace("+","%2B").replace("'","%27").replace(new RegExp(" ","g"),"+");break}if("book"===U.productType)if(l.isTextPB=!0,void 0!==f.fontName){if(l.fontColor=f.fontColor.replace("#",""),l.f_width=void 0!==f.fontWidth?f.fontWidth:Math.round(1.58*f.w*e/100),l.f_height=void 0!==f.fontHeight?f.fontHeight:Math.round(1.58*f.h*n/100),l.fontName=encodeURIComponent(f.fontName),l.text=f.text,l.fontSize=f.fontSize,l.horizontalAlignment=f.horizontalAlignment,l.verticalAlignment=f.verticalAlignment,l.leading=f.leading,void 0!==o.textareas)for(var p=0;p<o.textareas.length;p++)if(o.textareas[p].id==f.id){l.text=o.textareas[p].text;break}l.text=encodeURIComponent(encodeURIComponent(l.text))}else if(void 0!==o.textareas)for(var g=0;g<o.textareas.length;g++)if(o.textareas[g].id==f.id&&o.textareas[g].text){l.fontColor=o.textareas[g].font.fontColor.replace("#",""),l.f_width=void 0!==o.textareas[g].font.fontWidth?o.textareas[g].font.fontWidth:Math.round(1.58*f.w*e/100),l.f_height=void 0!==o.textareas[g].font.fontHeight?o.textareas[g].font.fontHeight:Math.round(1.58*f.h*n/100),l.fontName=encodeURIComponent(o.textareas[g].font.fontName),l.fontSize=o.textareas[g].font.fontSize,l.horizontalAlignment=o.textareas[g].font.horizontalAlignment,l.verticalAlignment=o.textareas[g].font.verticalAlignment,l.leading=o.textareas[g].font.leading,l.text=encodeURIComponent(encodeURIComponent(o.textareas[g].text));break}}l.x_cell=f.x/100,l.y_cell=f.y/100,l.w_cell=f.w/100,l.h_cell=f.h/100,l.r_cell=f.r,l.sx_cell=f.sx,l.sy_cell=f.sy,l.seqNum=void 0!==f.seqNum?f.seqNum:u,void 0!==f.t?h++:void 0===f.e&&u++,a[s]=l,s++}return a}function P(t){var e=(arguments.length>1&&void 0!==arguments[1]&&arguments[1],{});for(var n in t)if(t.hasOwnProperty(n)){var r=t[n],i={},o=r.photoRefId;void 0!==U.photosByRefId[o]&&(i.photoId=U.photosByRefId[o].photoId,i.usrPhoto=!0,"prod"===U.env||u()||-1!==U.photosByRefId[o].url.indexOf(L)?i.url=U.photosByRefId[o].url:i.url="https://proxy-sfly.thislife.com/"+U.env+"/image/ng/services/mediarender/THISLIFE/"+U.uid+"/media/"+U.photosByRefId[o].url.split("/")[9]+"/small/enhance",e[i.photoId]=i)}return e}function I(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,r={},i=n;for(var o in e)if(e.hasOwnProperty(o)){var a=e[o],s={},u=a.photoRefId,h=U.photosByRefId[u].photoId;s.usrImg=void 0!==t[h].usrPhoto&&!0===t[h].usrPhoto,s.cell_img=t[h].url,s.x_aoi=a.finalCrop[0],s.y_aoi=a.finalCrop[1],s.w_aoi=a.finalCrop[2]-a.finalCrop[0],s.h_aoi=a.finalCrop[3]-a.finalCrop[1],r[i]=s,i++}return r}function E(t){var e=void 0!==K&&null!==K?K[t]:q+"/"+t+".png";return"none"!==t&&""!==t?e:""}function O(t){var e=H+"/"+t+".png";return"none"!==t&&""!==t?e:""}function A(t){if("none"===t.text||""===t.text)return"";if(void 0!==i(t.isTextPB)&&!0===t.isTextPB)return X+"restrictSize/0/width/"+t.f_width+"/height/"+t.f_height+"/resolution/72/fontName/"+t.fontName+"/fontSize/"+t.fontSize+"/fontColor/"+t.fontColor+"/stroke/0/verticalAlignment/"+t.verticalAlignment+"/horizontalAlignment/"+t.horizontalAlignment+"/angle/0.0/text/"+t.text+"/leading/"+t.leading+".png";var e=F+"text="+t.text+"&fontName="+t.font+"&fontSize="+t.size+"&fontColor="+t.color+"&vertJustification="+t.verticalJustification+"&horizJustification="+t.horizontalJustification+"&height="+t.f_height+"&width="+t.f_width+"&rotation="+t.r_cell+"&brand=SFLY&textAreaHeight="+t.textAreaHeight+"&textAreaWidth="+t.textAreaWidth;return t.bold&&(e+="&bold=true"),t.italic&&(e+="&italic=true"),t.underline&&(e+="&underline=true"),u()&&-1==J.indexOf(window.location.hostname)?"https://proxy.photoccino.com/proxy.php?endpoint="+encodeURIComponent(e):e}function T(t){return"none"!==t&&""!==t?G+"/"+t+".jpg":""}function R(t,e,n){var i=0;for(var o in t)if(t.hasOwnProperty(o)){var a=t[o];void 0===a.e&&void 0===a.t&&i++}if(!U.skipPhotosCount&&i!==Object.keys(e).length)return j&&console.error(r("mismatch between #photos in CANVAS and #cells in LAYOUT ("+n+")")),null;var s={},u=1;for(var h in t)if(t.hasOwnProperty(h)){var c=t[h],l={};if(void 0!==c.e){var f=O(c.e);if(""===f)continue;l.cell_img=f,l.e=1,l.x_aoi=0,l.y_aoi=0,l.w_aoi=1,l.h_aoi=1}else if(void 0!==c.t){var d=A(c);if(""===d)continue;l.cell_img=d,l.t=1,l.x_aoi=0,l.y_aoi=0,l.w_aoi=1,l.h_aoi=1}else{var p=c.seqNum;l.isEmpty=U.skipPhotosCount&&!e.hasOwnProperty(p),l.isEmpty||void 0===e[p].usrImg||(l.usrImg=e[p].usrImg),l.isEmpty||(l.cell_img=e[p].cell_img),l.x_aoi=l.isEmpty?0:e[p].x_aoi,l.y_aoi=l.isEmpty?0:e[p].y_aoi,l.w_aoi=l.isEmpty?0:e[p].w_aoi,l.h_aoi=l.isEmpty?0:e[p].h_aoi}l.x_cell=c.x_cell,l.y_cell=c.y_cell,l.w_cell=c.w_cell,l.h_cell=c.h_cell,l.r_cell=c.r_cell,l.sx_cell=c.sx_cell,l.sy_cell=c.sy_cell,s[u]=l,u++}return s}function C(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",e={};e=-1!==Z.indexOf(U.productType)&&null!==U.currentSurface&&"object"===i(U.currentSurface)?M(U.thumbnailJson,U.currentSurface):U.thumbnailJson[U.currentSurface];var n={};return n.width=parseInt(e.thumbWidth),n.height=parseInt(e.thumbHeight),n.multiply_mask="",n.canvases=U.canvasParts,e.hasOwnProperty("opacity_mask")&&e.opacity_mask?n.opacity_mask=e.opacity_mask:e.hasOwnProperty("layers")&&e.layers.hasOwnProperty("opacity")?n.opacity_mask=e.layers.opacity:n.opacity_mask="",e.hasOwnProperty("background_img")&&e.background_img?n.background_img=e.background_img:e.hasOwnProperty("layers")&&e.layers.hasOwnProperty("background")?n.background_img=e.layers.background:n.background_img="",e.hasOwnProperty("overlay_img")&&e.overlay_img?n.overlay_img=e.overlay_img.replace("{{month}}",t):e.hasOwnProperty("layers")&&e.layers.hasOwnProperty("overlay")?n.overlay_img=e.layers.overlay:n.overlay_img="",n}function z(){}var D=this,B=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],j=arguments.length>2&&void 0!==arguments[2]&&arguments[2],U=this,L="d22bbwxztp2lry.cloudfront.net",N=t,Y=u(),J=["shutterfly.com","www.shutterfly.com","www.dev.shutterfly.com","www.beta.shutterfly.com","www.stage.shutterfly.com"],F=void 0,X=void 0,W=B?"https://d36611kofft9sk.cloudfront.net/"+N:"https://s3.amazonaws.com/sfly-thumb-assets/"+N,q=void 0,H=void 0,G=void 0,V=["mug","cup","travelmug","waterbottle"],Z=["deskcalendar"],K=void 0;this.init=function(n,r,o,a,s,u){var h=arguments.length>6&&void 0!==arguments[6]&&arguments[6];"object"===(void 0===o?"undefined":i(o))?D.projectJson=o:D.projectJson=JSON.parse(o),"object"===(void 0===a?"undefined":i(a))?D.layoutJson=a:D.layoutJson=JSON.parse(a),"object"===(void 0===s?"undefined":i(s))?D.thumbnailJson=s:D.thumbnailJson=JSON.parse(s),D.productType=n,D.partnerId=r,D.env=t,D.doNotResizeImages=h,D.photosByRefId=c(),"function"!=typeof u&&(u=function(){}),D.errorCallback=u,e(n,r,N)},this.generate=function(t,e,n,r){var i=arguments.length>4&&void 0!==arguments[4]&&arguments[4],o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{},a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:"",s=arguments.length>7&&void 0!==arguments[7]&&arguments[7];if(n=void 0===n||n,D.uid=a,!u()){if(""===D.uid)return console.error("missing userId in args"),!1;D.uid=D.uid.replace("user","").split("_")[0]}D.divId=e,D.currentSurface=null,D.skipPhotosCount=s,D.textEnabled=void 0===o||!o.hasOwnProperty("textEnabled")||null===o.textEnabled||o.textEnabled,D.orientation=void 0!==o&&o.hasOwnProperty("orientation")&&null!==o.orientation?o.orientation:"",K=void 0!==o&&o.hasOwnProperty("masks")&&null!==o.masks&&void 0!==o.masks?o.masks:void 0;var h={};Object.assign(h,D.thumbnailJson),D.canvasParts=l(t),D.thumbnailObject=C(t),j&&console.info(JSON.stringify(D.thumbnailObject)),z.createThumbnail(D.thumbnailObject,function(t){i?r(t):(document.getElementById(e).innerHtml=t,void 0!==r&&r())},n,D.partnerId,D.uid,t,D.errorCallback),D.thumbnailJson=h},this.clean=function(t,e){u()||o.clean(t,e)},this.directoryInit=function(t,e,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;u()||o.directoryInit(t,e,n,r)},z.createThumbnail=function(t,e,i,c,l,f,d){function p(){for(var t in _)if(_.hasOwnProperty(t)&&!P.hasOwnProperty(t)){var e=6e4;-1!==t.indexOf("cell_img")&&(e=9e4),-1!==_[t].indexOf("proxy.php")&&(e=1e4),I.push(m(t,_[t].replace(/\/\-S(\d*)S\-\//,"/"),e,c.replace(new RegExp("/","g"),"_")))}}function g(){try{if(P.hasOwnProperty("sprite_img")&&-1===P.sprite_img.src.indexOf("1x1")){S=P.sprite_img;var e={width:S.width/M.length||t.width,height:t.height},r=void 0;Y?(r=document.createElement("canvas"),r.width=e.width,r.height=e.height):r=(0,n(2).createCanvas)(e.width,e.height);var i=r.getContext("2d"),o=0,a=!0,s=!1,u=void 0;try{for(var h,l=M[Symbol.iterator]();!(a=(h=l.next()).done);a=!0){var f=h.value;i.clearRect(0,0,r.width,r.height),i.drawImage(S,o*e.width,0,e.width,e.height,0,0,t.width,t.height),P[f]=m(f,i.canvas.toDataURL(),1e4,c.replace(new RegExp("/","g"),"_")),o++}}catch(t){s=!0,u=t}finally{try{!a&&l.return&&l.return()}finally{if(s)throw u}}}p(),v()}catch(t){p(),v(),console.log("failed to parse sprite - "+t.message)}}function v(){Promise.all(I).then(function(){U.images=P;try{var n=w.bind(E,t,P,i,c.replace(new RegExp("/","g"),"_"),l,f);setTimeout(function(){e(n())},0)}catch(t){d("ThumbGenFailed",{exception:t.message})}}).catch(function(){d("LoadPhotoFailed"),j&&console.error(r("Error loading Images!"))})}function m(t,e){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e3,i=arguments[3],a=arguments[4];return new Promise(function(s,u){function c(){g&&(clearTimeout(g),g=null)}function l(){if(void 0!==this.complete&&!this.complete&&!this.hasOwnProperty("isPixel"))return void f();c(),this.id=t,P[t]=this,s()}function f(){v--,c(),v<0?(this.onload=this.onabort=this.onerror=function(){},this.src===e&&(Y?this.src="https://d22bbwxztp2lry.cloudfront.net/productswidget/Shutterfly/sidewidget/1x1.png":o.imgDownload(h+i+"/"+t+".png",this,"https://d22bbwxztp2lry.cloudfront.net/productswidget/Shutterfly/sidewidget/1x1.png"),this.isPixel=!0),console.log("[Product Widget] Could not load the image after 3 retries: "+e),l.call(this)):d()}function d(){if(p.onload=l,p.onerror=p.onerror=f,Y)p.src=e;else{var n=h+i+"/"+t+".png";o.imgDownload(n,p,e)}g=setTimeout(function(t){return function(){f.call(t)}}(p),r)}var p=void 0,g=void 0,v=void 0===a||isNaN(a)?3:a;if(r/=v+1,Y)p=new Image;else{var m=n(2),y=m.Image;p=new y}p.crossOrigin="Anonymous",d()})}function y(t,e,n,r){var i=t.cell_img;if(void 0!==t.e||void 0!==t.t)return i;var o=e*t.w_cell/t.w_aoi,a=n*t.h_cell/t.h_aoi,s=1.2*Math.max(o,a),h="1000",c="small",l=!1;return s<150?(c="x-small",h="350",l=!0):s<350?h="350":s<500?h="700":s<700&&(h="700"),"1000"!==h&&(i=i.replace("1000x1000",h+"x"+h)),i.match(/THISLIFE|enhance/)&&(i=i.replace(/medium|x-large|large/,c)),u()&&(void 0===window.MagicShop&&(window.MagicShop={}),void 0===window.MagicShop.requestedImages&&(window.MagicShop.requestedImages={}),l&&i.match(/THISLIFE|enhance/)&&window.MagicShop.requestedImages.hasOwnProperty(i.replace("x-small","small"))&&(i=i.replace("x-small","small")),window.MagicShop.requestedImages.hasOwnProperty(i)||(window.MagicShop.requestedImages[i]=1)),i}function w(t,e,r,i,o,u){var c=void 0,l=void 0,f=void 0,d=void 0,p=void 0,g=void 0,v=void 0,m=void 0,y="",w=h+i+"/"+this.orientation+"_"+u;if(Y)c=document.createElement("canvas"),c.width=t.width,c.height=t.height,r&&c.setAttribute("style","width:100%;height:100%");else{y=this.orientation+"_"+u+"_";var b=n(2),_=b.createCanvas;c=_(t.width,t.height)}if(c.id="mgCanvas-"+U.divId+"-thumbnail",l=c.getContext("2d"),l.imageSmoothingEnabled=!1,void 0!==e[y+"background_img"]&&""!==e[y+"background_img"]){if(Y)p=document.createElement("canvas"),p.style.zIndex=0,v=e.background_img,p.width=t.width,p.height=t.height;else{var S=n(2),M=S.createCanvas,k=S.Image;p=M(t.width,t.height),v=new k,v.src=w+"_background_img.png"}p.id="mgCanvas-"+U.divId+"-bgLayer",g=p.getContext("2d");var P=Math.min(v.width,t.width),I=Math.min(v.height,t.height);g.drawImage(v,0,0,P,I),l.drawImage(p,0,0)}Y?(f=document.createElement("canvas"),f.width=t.width,f.height=t.height):f=(0,n(2).createCanvas)(t.width,t.height),f.id="mgCanvas-"+U.divId+"-canvasesLayer",d=f.getContext("2d"),d.imageSmoothingEnabled=!1;for(var E in t.canvases)!function(r){if(t.canvases.hasOwnProperty(r)){var u=function(t){for(var a in l.cells)if(l.cells.hasOwnProperty(a)){var s=l.cells[a],u=void 0!==s.t,c=void 0,d=void 0,g=void 0;if(u){if(!t)continue}else if(t)continue;var v=Math.floor(s.x_cell*f.width),m=Math.floor(s.y_cell*f.height),y=Math.max(1,Math.floor(s.w_cell*f.width)),w=Math.max(1,Math.floor(s.h_cell*f.height));if(Y)c=document.createElement("canvas"),g=e["canvas-"+r+"-cell-"+a+"-cell_img"],c.width=y,c.height=w;else{var x=n(2),b=x.createCanvas,_=(x.loadImage,x.Image);c=b(y,w),g=new _,g.src=h+i+"/"+o+"_canvas-"+r+"-cell-"+a+"-cell_img.png"}var S=s.hasOwnProperty("isEmpty")&&s.isEmpty;if(void 0===g&&!S)continue;S&&(g={width:1e3,height:1e3,bgColor:"#DDDDDD"}),d=c.getContext("2d");var M=Math.floor(s.x_aoi*g.width),k=Math.floor(s.y_aoi*g.height),P=Math.floor(s.w_aoi*g.width),I=Math.floor(s.h_aoi*g.height),E=void 0!==s.e,O=P,A=I,T=M,R=k;if(!E&&!u){var C=y/w,z=P/I;O=Math.floor(P*Math.min(z,C)/z),A=Math.floor(I*Math.min(z,C)/C),T=Math.floor(M+(P-O)/2),R=Math.floor(g.height-k-(I+A)/2)}if(d.save(),!isNaN(s.sx_cell)&&1!==s.sx_cell){var D=s.sx_cell,B=-1*D*c.width;d.translate(B,0),d.scale(D,1)}if(!isNaN(s.sy_cell)&&1!==s.sy_cell){var j=s.sy_cell,U=-1*j*c.height;d.translate(0,U),d.scale(1,j)}var L=g.hasOwnProperty("isPixel")&&!0===g.isPixel,N=L&&O>y?O:y,J=L&&A>w?A:w;try{S?(d.beginPath(),d.rect(0,0,N,J),d.fillStyle=g.bgColor,d.strokeStyle="rgba(0,0,0,0.9)",d.lineWidth=1,d.fill(),d.stroke()):d.drawImage(g,T,R,O,A,0,0,N,J),d.restore()}catch(t){console.log("[Product Widget] Could not draw the Image in canvas",t.message)}var F=!1;if(u&&(s.r_cell=0),!isNaN(s.r_cell)&&1!==s.r_cell){if(Y){var X=window.chrome,W=window.navigator.vendor;X=null!==X&&"Google Inc."===W}F=!0,p.save();var q=s.r_cell*Math.PI/180,H=Math.round(v+y/2),G=Math.round(m+w/2);p.translate(H,G),p.rotate(q),p.drawImage(c,Math.floor(-c.width/2),Math.floor(-c.height/2),c.width,c.height),p.translate(-H,-G),p.restore()}F||p.drawImage(c,0,0)}},l=t.canvases[r],f=void 0,p=void 0,g=void 0,v=void 0,m=0,y=0,x=0,b=0;void 0!==l.cropping&&(m=void 0!==l.cropping.left?l.cropping.left:0,y=void 0!==l.cropping.right?l.cropping.right:0,x=void 0!==l.cropping.top?l.cropping.top:0,b=void 0!==l.cropping.bottom?l.cropping.bottom:0);var _=0,S=0;if(void 0!==l.offset&&(_=void 0!==l.offset.x?l.offset.x:0,S=void 0!==l.offset.y?l.offset.y:0),Y)f=document.createElement("canvas"),f.width=l.width,f.height=l.height;else{var M=n(2),k=M.createCanvas;f=new k(l.width,l.height)}if(p=f.getContext("2d"),""!==l.back_img){var P=f.width,I=f.height;"#"===l.back_img.substr(0,1)?(p.fillStyle=l.back_img,p.fillRect(0,0,f.width,f.height)):(Y?g=e["canvas-"+r+"-back_img"]:(g=new(0,n(2).Image),g.src=w+"_canvas-"+r+"-back_img.png"),p.drawImage(g,0,0,P,I))}if(u(!1),void 0!==l.mask_img&&""!==l.mask_img){var E=f.width,O=f.height;Y?v=e["canvas-"+r+"-mask_img"]:(v=new(0,n(2).Image),v.src=w+"_canvas-0-mask_img.png"),p.drawImage(v,0,0,E,O)}if(u(!0),void 0!==l.cylinderize&&""!==l.cylinderize){var A={width:c.width,height:c.height,input:[{canvas:f,width:f.width,height:f.height,cylinderize:{r:l.cylinderize.r,l:l.cylinderize.l,w:l.cylinderize.w,a:-l.cylinderize.a,o_x:l.cylinderize.o_x,o_y:l.cylinderize.o_y,p:l.cylinderize.p,n:l.cylinderize.n,e:l.cylinderize.e}}]},T=new s(A),R=T.render(),C=(c.width-R.width)/2+l.cylinderize.o_x,z=(c.height-R.height)/2+l.cylinderize.o_y;d.drawImage(R,C,z)}else if(void 0!==l.transformation&&""!==l.transformation){var D={width:c.width,height:c.height,input:[{canvas:f,vertices:{nww:l.transformation.nww,nwh:l.transformation.nwh,new:l.transformation.new,neh:l.transformation.neh,sew:l.transformation.sew,seh:l.transformation.seh,sww:l.transformation.sww,swh:l.transformation.swh}}]},B=new a(D),j=B.render();d.drawImage(j,0,0)}else{var U=f.width-(m+y),L=f.height-(x+b);d.drawImage(f,m,x,U,L,_,S,U,L)}}}(E);if(void 0!==e[y+"opacity_mask"]&&""!==e[y+"opacity_mask"]){var O=void 0,A=void 0,T=void 0;if(Y)O=document.createElement("canvas"),O.width=t.width,O.height=t.height,T=e.opacity_mask;else{var R=n(2),C=R.createCanvas,z=R.Image;O=C(t.width,t.height),T=new z,T.src=w+"_opacity_mask.png"}A=O.getContext("2d"),A.imageSmoothingEnabled=!1,A.drawImage(f,0,0),A.globalCompositeOperation="destination-out",A.drawImage(x(T,t),0,0),l.drawImage(O,0,0)}else l.drawImage(f,0,0);return void 0!==e[y+"overlay_img"]&&""!==e[y+"overlay_img"]&&(Y?m=e.overlay_img:(m=new(0,n(2).Image),m.src=w+"_overlay_img.png"),l.drawImage(m,0,0)),c}function x(t,e){var r=void 0,i=void 0,o=void 0,a=void 0,s={r:0,g:0,b:0,a:0};Y?(r=document.createElement("canvas"),r.width=e.width,r.height=e.height):r=(0,n(2).createCanvas)(e.width,e.height),i=r.getContext("2d"),i.drawImage(t,0,0),o=i.getImageData(0,0,r.width,r.height),a=o.data;for(var u=0,h=a.length;u<h;u+=4){var c=a[u],l=a[u+1],f=a[u+2];0===a[u+3]?(a[u]=255,a[u+1]=255,a[u+2]=255,a[u+3]=255):c>0&&l>0&&f>0&&(a[u]=s.r,a[u+1]=s.g,a[u+2]=s.b,a[u+3]=255-(c+l+f)/3)}return i.putImageData(o,0,0),r}var b="1",_=function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",r=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],i=[],o="",a="";u()||(a=l+"_",o=n+"_"+f+"_"),t.overlay_img&&(i[o+"overlay_img"]=t.overlay_img+"?v="+b),t.opacity_mask&&(i[o+"opacity_mask"]=t.opacity_mask+"?v="+b),t.background_img&&(i[o+"background_img"]=t.background_img+"?v="+b);for(var s in t.canvases)if(t.canvases.hasOwnProperty(s)){var h=t.canvases[s];""!==h.mask_img&&(i[o+"canvas-"+s+"-mask_img"]=h.mask_img+"?v="+b),""!==h.back_img&&"#"!==h.back_img.substr(0,1)&&(i[o+"canvas-"+s+"-back_img"]=h.back_img+"?v="+b);for(var c in h.cells)if(h.cells.hasOwnProperty(c)){var d=h.cells[c];d.hasOwnProperty("cell_img")&&""!==d.cell_img&&(void 0!==h.cells[c].usrImg||void 0!==h.cells[c].t?(h.cells[c].usrImg||1===h.cells[c].t&&r)&&(i[a+"canvas-"+s+"-cell-"+c+"-cell_img"]=y(d,h.width,h.height,e)):i[o+"canvas-"+s+"-cell-"+c+"-cell_img"]=y(d,h.width,h.height,e))}}return i}(t,U.env,U.orientation,U.textEnabled),S=function(t){try{var e={background:t.background_img||"",opacity:t.opacity_mask||"",overlay:t.overlay_img||""};e=JSON.parse(JSON.stringify(e).replace(/(http|https)\:\/\/[^\/]+\/[^\/]+\/((beta|prod|stage|dev)\/)?/g,""));var n="sprites/sprite.png?"+Object.keys(e).map(function(t){return encodeURIComponent(t)+"="+encodeURIComponent(e[t])}).join("&");return("prod"===U.env?"https://d3bxvfv74xf01g.cloudfront.net/":"stage"===U.env?"https://d2dzaswbxnu25q.cloudfront.net/":"https://magicapi"+("prod"!==U.env?"-"+U.env:"")+".photoccino.com/assets/")+n}catch(t){return console.error(t),""}}(_),M=[];if(S&&""!==S){var k=Object.keys(_);M=["background_img","opacity_mask","overlay_img"].filter(function(t){return-1!==k.indexOf(t)}),M.length>0&&(_.sprite_img=S,S=m("sprite_img",S,1e4,c.replace(new RegExp("/","g"),"_"),0))}var P=[],I=[];S instanceof Promise?S.then(g).catch(function(t){p(),v()}):(p(),v());var E=D}}var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},o=n(39),a=n(83),s=n(85),u=o.isBrowser,h=o.getHomePath();if(u()&&console.log("starting MgThumbGenerator v"+n(86).version),(u()?window.CanvasRenderingContext2D:e.CanvasRenderingContext2D)&&CanvasRenderingContext2D.prototype.getImageData){var c={destX:0,destY:0,sourceX:0,sourceY:0,width:"auto",height:"auto"};CanvasRenderingContext2D.prototype.blendOnto=function(t,e,n){var r={};for(var i in c)c.hasOwnProperty(i)&&(r[i]=n&&n[i]||c[i]);"auto"===r.width&&(r.width=(void 0).canvas.width),"auto"===r.height&&(r.height=(void 0).canvas.height),r.width=Math.min(r.width,(void 0).canvas.width-r.sourceX,t.canvas.width-r.destX),r.height=Math.min(r.height,(void 0).canvas.height-r.sourceY,t.canvas.height-r.destY);for(var o=(void 0).getImageData(r.sourceX,r.sourceY,r.width,r.height),a=t.getImageData(r.destX,r.destY,r.width,r.height),s=o.data,u=a.data,h=void 0,l=void 0,f=u.length,d=void 0,p=void 0,g=void 0,v=void 0,m=void 0,y=void 0,w=void 0,x=void 0,b=0;b<f;b+=4)switch(h=s[b+3]/255,l=u[b+3]/255,w=h+l-h*l,u[b+3]=255*w,d=s[b]/255*h,v=u[b]/255*l,p=s[b+1]/255*h,m=u[b+1]/255*l,g=s[b+2]/255*h,y=u[b+2]/255*l,x=255/w,e){case"normal":case"src-over":u[b]=(d+v-v*h)*x,u[b+1]=(p+m-m*h)*x,u[b+2]=(g+y-y*h)*x;break;case"screen":u[b]=(d+v-d*v)*x,u[b+1]=(p+m-p*m)*x,u[b+2]=(g+y-g*y)*x;break;case"multiply":u[b]=(d*v+d*(1-l)+v*(1-h))*x,u[b+1]=(p*m+p*(1-l)+m*(1-h))*x,u[b+2]=(g*y+g*(1-l)+y*(1-h))*x;break;case"difference":u[b]=(d+v-2*Math.min(d*l,v*h))*x,u[b+1]=(p+m-2*Math.min(p*l,m*h))*x,u[b+2]=(g+y-2*Math.min(g*l,y*h))*x;break;default:u[b]=u[b+3]=255,u[b+1]=b%8==0?255:0,u[b+2]=b%8==0?0:255}t.putImageData(a,r.destX,r.destY)};for(var l=CanvasRenderingContext2D.prototype.blendOnto.supportedBlendModes="normal src-over screen multiply difference src-in plus add overlay hardlight colordodge dodge colorburn burn darken lighten exclusion".split(" "),f=CanvasRenderingContext2D.prototype.blendOnto.supports={},d=0,p=l.length;d<p;++d)f[l[d]]=!0}t.exports=r}).call(e,n(38))},function(t,e,n){"use strict";(function(t){function r(){return o.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function i(t,e){if(r()<e)throw new RangeError("Invalid typed array length");return o.TYPED_ARRAY_SUPPORT?(t=new Uint8Array(e),t.__proto__=o.prototype):(null===t&&(t=new o(e)),t.length=e),t}function o(t,e,n){if(!(o.TYPED_ARRAY_SUPPORT||this instanceof o))return new o(t,e,n);if("number"==typeof t){if("string"==typeof e)throw new Error("If encoding is specified then the first argument must be a string");return h(this,t)}return a(this,t,e,n)}function a(t,e,n,r){if("number"==typeof e)throw new TypeError('"value" argument must not be a number');return"undefined"!=typeof ArrayBuffer&&e instanceof ArrayBuffer?f(t,e,n,r):"string"==typeof e?c(t,e,n):d(t,e)}function s(t){if("number"!=typeof t)throw new TypeError('"size" argument must be a number');if(t<0)throw new RangeError('"size" argument must not be negative')}function u(t,e,n,r){return s(e),e<=0?i(t,e):void 0!==n?"string"==typeof r?i(t,e).fill(n,r):i(t,e).fill(n):i(t,e)}function h(t,e){if(s(e),t=i(t,e<0?0:0|p(e)),!o.TYPED_ARRAY_SUPPORT)for(var n=0;n<e;++n)t[n]=0;return t}function c(t,e,n){if("string"==typeof n&&""!==n||(n="utf8"),!o.isEncoding(n))throw new TypeError('"encoding" must be a valid string encoding');var r=0|v(e,n);t=i(t,r);var a=t.write(e,n);return a!==r&&(t=t.slice(0,a)),t}function l(t,e){var n=e.length<0?0:0|p(e.length);t=i(t,n);for(var r=0;r<n;r+=1)t[r]=255&e[r];return t}function f(t,e,n,r){if(e.byteLength,n<0||e.byteLength<n)throw new RangeError("'offset' is out of bounds");if(e.byteLength<n+(r||0))throw new RangeError("'length' is out of bounds");return e=void 0===n&&void 0===r?new Uint8Array(e):void 0===r?new Uint8Array(e,n):new Uint8Array(e,n,r),o.TYPED_ARRAY_SUPPORT?(t=e,t.__proto__=o.prototype):t=l(t,e),t}function d(t,e){if(o.isBuffer(e)){var n=0|p(e.length);return t=i(t,n),0===t.length?t:(e.copy(t,0,0,n),t)}if(e){if("undefined"!=typeof ArrayBuffer&&e.buffer instanceof ArrayBuffer||"length"in e)return"number"!=typeof e.length||V(e.length)?i(t,0):l(t,e);if("Buffer"===e.type&&$(e.data))return l(t,e.data)}throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")}function p(t){if(t>=r())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+r().toString(16)+" bytes");return 0|t}function g(t){return+t!=t&&(t=0),o.alloc(+t)}function v(t,e){if(o.isBuffer(t))return t.length;if("undefined"!=typeof ArrayBuffer&&"function"==typeof ArrayBuffer.isView&&(ArrayBuffer.isView(t)||t instanceof ArrayBuffer))return t.byteLength;"string"!=typeof t&&(t=""+t);var n=t.length;if(0===n)return 0;for(var r=!1;;)switch(e){case"ascii":case"latin1":case"binary":return n;case"utf8":case"utf-8":case void 0:return X(t).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*n;case"hex":return n>>>1;case"base64":return H(t).length;default:if(r)return X(t).length;e=(""+e).toLowerCase(),r=!0}}function m(t,e,n){var r=!1;if((void 0===e||e<0)&&(e=0),e>this.length)return"";if((void 0===n||n>this.length)&&(n=this.length),n<=0)return"";if(n>>>=0,e>>>=0,n<=e)return"";for(t||(t="utf8");;)switch(t){case"hex":return R(this,e,n);case"utf8":case"utf-8":return E(this,e,n);case"ascii":return A(this,e,n);case"latin1":case"binary":return T(this,e,n);case"base64":return I(this,e,n);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return C(this,e,n);default:if(r)throw new TypeError("Unknown encoding: "+t);t=(t+"").toLowerCase(),r=!0}}function y(t,e,n){var r=t[e];t[e]=t[n],t[n]=r}function w(t,e,n,r,i){if(0===t.length)return-1;if("string"==typeof n?(r=n,n=0):n>2147483647?n=2147483647:n<-2147483648&&(n=-2147483648),n=+n,isNaN(n)&&(n=i?0:t.length-1),n<0&&(n=t.length+n),n>=t.length){if(i)return-1;n=t.length-1}else if(n<0){if(!i)return-1;n=0}if("string"==typeof e&&(e=o.from(e,r)),o.isBuffer(e))return 0===e.length?-1:x(t,e,n,r,i);if("number"==typeof e)return e&=255,o.TYPED_ARRAY_SUPPORT&&"function"==typeof Uint8Array.prototype.indexOf?i?Uint8Array.prototype.indexOf.call(t,e,n):Uint8Array.prototype.lastIndexOf.call(t,e,n):x(t,[e],n,r,i);throw new TypeError("val must be string, number or Buffer")}function x(t,e,n,r,i){function o(t,e){return 1===a?t[e]:t.readUInt16BE(e*a)}var a=1,s=t.length,u=e.length;if(void 0!==r&&("ucs2"===(r=String(r).toLowerCase())||"ucs-2"===r||"utf16le"===r||"utf-16le"===r)){if(t.length<2||e.length<2)return-1;a=2,s/=2,u/=2,n/=2}var h;if(i){var c=-1;for(h=n;h<s;h++)if(o(t,h)===o(e,-1===c?0:h-c)){if(-1===c&&(c=h),h-c+1===u)return c*a}else-1!==c&&(h-=h-c),c=-1}else for(n+u>s&&(n=s-u),h=n;h>=0;h--){for(var l=!0,f=0;f<u;f++)if(o(t,h+f)!==o(e,f)){l=!1;break}if(l)return h}return-1}function b(t,e,n,r){n=Number(n)||0;var i=t.length-n;r?(r=Number(r))>i&&(r=i):r=i;var o=e.length;if(o%2!=0)throw new TypeError("Invalid hex string");r>o/2&&(r=o/2);for(var a=0;a<r;++a){var s=parseInt(e.substr(2*a,2),16);if(isNaN(s))return a;t[n+a]=s}return a}function _(t,e,n,r){return G(X(e,t.length-n),t,n,r)}function S(t,e,n,r){return G(W(e),t,n,r)}function M(t,e,n,r){return S(t,e,n,r)}function k(t,e,n,r){return G(H(e),t,n,r)}function P(t,e,n,r){return G(q(e,t.length-n),t,n,r)}function I(t,e,n){return 0===e&&n===t.length?Z.fromByteArray(t):Z.fromByteArray(t.slice(e,n))}function E(t,e,n){n=Math.min(t.length,n);for(var r=[],i=e;i<n;){var o=t[i],a=null,s=o>239?4:o>223?3:o>191?2:1;if(i+s<=n){var u,h,c,l;switch(s){case 1:o<128&&(a=o);break;case 2:128==(192&(u=t[i+1]))&&(l=(31&o)<<6|63&u)>127&&(a=l);break;case 3:u=t[i+1],h=t[i+2],128==(192&u)&&128==(192&h)&&(l=(15&o)<<12|(63&u)<<6|63&h)>2047&&(l<55296||l>57343)&&(a=l);break;case 4:u=t[i+1],h=t[i+2],c=t[i+3],128==(192&u)&&128==(192&h)&&128==(192&c)&&(l=(15&o)<<18|(63&u)<<12|(63&h)<<6|63&c)>65535&&l<1114112&&(a=l)}}null===a?(a=65533,s=1):a>65535&&(a-=65536,r.push(a>>>10&1023|55296),a=56320|1023&a),r.push(a),i+=s}return O(r)}function O(t){var e=t.length;if(e<=Q)return String.fromCharCode.apply(String,t);for(var n="",r=0;r<e;)n+=String.fromCharCode.apply(String,t.slice(r,r+=Q));return n}function A(t,e,n){var r="";n=Math.min(t.length,n);for(var i=e;i<n;++i)r+=String.fromCharCode(127&t[i]);return r}function T(t,e,n){var r="";n=Math.min(t.length,n);for(var i=e;i<n;++i)r+=String.fromCharCode(t[i]);return r}function R(t,e,n){var r=t.length;(!e||e<0)&&(e=0),(!n||n<0||n>r)&&(n=r);for(var i="",o=e;o<n;++o)i+=F(t[o]);return i}function C(t,e,n){for(var r=t.slice(e,n),i="",o=0;o<r.length;o+=2)i+=String.fromCharCode(r[o]+256*r[o+1]);return i}function z(t,e,n){if(t%1!=0||t<0)throw new RangeError("offset is not uint");if(t+e>n)throw new RangeError("Trying to access beyond buffer length")}function D(t,e,n,r,i,a){if(!o.isBuffer(t))throw new TypeError('"buffer" argument must be a Buffer instance');if(e>i||e<a)throw new RangeError('"value" argument is out of bounds');if(n+r>t.length)throw new RangeError("Index out of range")}function B(t,e,n,r){e<0&&(e=65535+e+1);for(var i=0,o=Math.min(t.length-n,2);i<o;++i)t[n+i]=(e&255<<8*(r?i:1-i))>>>8*(r?i:1-i)}function j(t,e,n,r){e<0&&(e=4294967295+e+1);for(var i=0,o=Math.min(t.length-n,4);i<o;++i)t[n+i]=e>>>8*(r?i:3-i)&255}function U(t,e,n,r,i,o){if(n+r>t.length)throw new RangeError("Index out of range");if(n<0)throw new RangeError("Index out of range")}function L(t,e,n,r,i){return i||U(t,e,n,4,3.4028234663852886e38,-3.4028234663852886e38),K.write(t,e,n,r,23,4),n+4}function N(t,e,n,r,i){return i||U(t,e,n,8,1.7976931348623157e308,-1.7976931348623157e308),K.write(t,e,n,r,52,8),n+8}function Y(t){if(t=J(t).replace(tt,""),t.length<2)return"";for(;t.length%4!=0;)t+="=";return t}function J(t){return t.trim?t.trim():t.replace(/^\s+|\s+$/g,"")}function F(t){return t<16?"0"+t.toString(16):t.toString(16)}function X(t,e){e=e||1/0;for(var n,r=t.length,i=null,o=[],a=0;a<r;++a){if((n=t.charCodeAt(a))>55295&&n<57344){if(!i){if(n>56319){(e-=3)>-1&&o.push(239,191,189);continue}if(a+1===r){(e-=3)>-1&&o.push(239,191,189);continue}i=n;continue}if(n<56320){(e-=3)>-1&&o.push(239,191,189),i=n;continue}n=65536+(i-55296<<10|n-56320)}else i&&(e-=3)>-1&&o.push(239,191,189);if(i=null,n<128){if((e-=1)<0)break;o.push(n)}else if(n<2048){if((e-=2)<0)break;o.push(n>>6|192,63&n|128)}else if(n<65536){if((e-=3)<0)break;o.push(n>>12|224,n>>6&63|128,63&n|128)}else{if(!(n<1114112))throw new Error("Invalid code point");if((e-=4)<0)break;o.push(n>>18|240,n>>12&63|128,n>>6&63|128,63&n|128)}}return o}function W(t){for(var e=[],n=0;n<t.length;++n)e.push(255&t.charCodeAt(n));return e}function q(t,e){for(var n,r,i,o=[],a=0;a<t.length&&!((e-=2)<0);++a)n=t.charCodeAt(a),r=n>>8,i=n%256,o.push(i),o.push(r);return o}function H(t){return Z.toByteArray(Y(t))}function G(t,e,n,r){for(var i=0;i<r&&!(i+n>=e.length||i>=t.length);++i)e[i+n]=t[i];return i}function V(t){return t!==t}var Z=n(77),K=n(78),$=n(79);e.Buffer=o,e.SlowBuffer=g,e.INSPECT_MAX_BYTES=50,o.TYPED_ARRAY_SUPPORT=void 0!==t.TYPED_ARRAY_SUPPORT?t.TYPED_ARRAY_SUPPORT:function(){try{var t=new Uint8Array(1);return t.__proto__={__proto__:Uint8Array.prototype,foo:function(){return 42}},42===t.foo()&&"function"==typeof t.subarray&&0===t.subarray(1,1).byteLength}catch(t){return!1}}(),e.kMaxLength=r(),o.poolSize=8192,o._augment=function(t){return t.__proto__=o.prototype,t},o.from=function(t,e,n){return a(null,t,e,n)},o.TYPED_ARRAY_SUPPORT&&(o.prototype.__proto__=Uint8Array.prototype,o.__proto__=Uint8Array,"undefined"!=typeof Symbol&&Symbol.species&&o[Symbol.species]===o&&Object.defineProperty(o,Symbol.species,{value:null,configurable:!0})),o.alloc=function(t,e,n){return u(null,t,e,n)},o.allocUnsafe=function(t){return h(null,t)},o.allocUnsafeSlow=function(t){return h(null,t)},o.isBuffer=function(t){return!(null==t||!t._isBuffer)},o.compare=function(t,e){if(!o.isBuffer(t)||!o.isBuffer(e))throw new TypeError("Arguments must be Buffers");if(t===e)return 0;for(var n=t.length,r=e.length,i=0,a=Math.min(n,r);i<a;++i)if(t[i]!==e[i]){n=t[i],r=e[i];break}return n<r?-1:r<n?1:0},o.isEncoding=function(t){switch(String(t).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},o.concat=function(t,e){if(!$(t))throw new TypeError('"list" argument must be an Array of Buffers');if(0===t.length)return o.alloc(0);var n;if(void 0===e)for(e=0,n=0;n<t.length;++n)e+=t[n].length;var r=o.allocUnsafe(e),i=0;for(n=0;n<t.length;++n){var a=t[n];if(!o.isBuffer(a))throw new TypeError('"list" argument must be an Array of Buffers');a.copy(r,i),i+=a.length}return r},o.byteLength=v,o.prototype._isBuffer=!0,o.prototype.swap16=function(){var t=this.length;if(t%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var e=0;e<t;e+=2)y(this,e,e+1);return this},o.prototype.swap32=function(){var t=this.length;if(t%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var e=0;e<t;e+=4)y(this,e,e+3),y(this,e+1,e+2);return this},o.prototype.swap64=function(){var t=this.length;if(t%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var e=0;e<t;e+=8)y(this,e,e+7),y(this,e+1,e+6),y(this,e+2,e+5),y(this,e+3,e+4);return this},o.prototype.toString=function(){var t=0|this.length;return 0===t?"":0===arguments.length?E(this,0,t):m.apply(this,arguments)},o.prototype.equals=function(t){if(!o.isBuffer(t))throw new TypeError("Argument must be a Buffer");return this===t||0===o.compare(this,t)},o.prototype.inspect=function(){var t="",n=e.INSPECT_MAX_BYTES;return this.length>0&&(t=this.toString("hex",0,n).match(/.{2}/g).join(" "),this.length>n&&(t+=" ... ")),"<Buffer "+t+">"},o.prototype.compare=function(t,e,n,r,i){if(!o.isBuffer(t))throw new TypeError("Argument must be a Buffer");if(void 0===e&&(e=0),void 0===n&&(n=t?t.length:0),void 0===r&&(r=0),void 0===i&&(i=this.length),e<0||n>t.length||r<0||i>this.length)throw new RangeError("out of range index");if(r>=i&&e>=n)return 0;if(r>=i)return-1;if(e>=n)return 1;if(e>>>=0,n>>>=0,r>>>=0,i>>>=0,this===t)return 0;for(var a=i-r,s=n-e,u=Math.min(a,s),h=this.slice(r,i),c=t.slice(e,n),l=0;l<u;++l)if(h[l]!==c[l]){a=h[l],s=c[l];break}return a<s?-1:s<a?1:0},o.prototype.includes=function(t,e,n){return-1!==this.indexOf(t,e,n)},o.prototype.indexOf=function(t,e,n){return w(this,t,e,n,!0)},o.prototype.lastIndexOf=function(t,e,n){return w(this,t,e,n,!1)},o.prototype.write=function(t,e,n,r){if(void 0===e)r="utf8",n=this.length,e=0;else if(void 0===n&&"string"==typeof e)r=e,n=this.length,e=0;else{if(!isFinite(e))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");e|=0,isFinite(n)?(n|=0,void 0===r&&(r="utf8")):(r=n,n=void 0)}var i=this.length-e;if((void 0===n||n>i)&&(n=i),t.length>0&&(n<0||e<0)||e>this.length)throw new RangeError("Attempt to write outside buffer bounds");r||(r="utf8");for(var o=!1;;)switch(r){case"hex":return b(this,t,e,n);case"utf8":case"utf-8":return _(this,t,e,n);case"ascii":return S(this,t,e,n);case"latin1":case"binary":return M(this,t,e,n);case"base64":return k(this,t,e,n);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return P(this,t,e,n);default:if(o)throw new TypeError("Unknown encoding: "+r);r=(""+r).toLowerCase(),o=!0}},o.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var Q=4096;o.prototype.slice=function(t,e){var n=this.length;t=~~t,e=void 0===e?n:~~e,t<0?(t+=n)<0&&(t=0):t>n&&(t=n),e<0?(e+=n)<0&&(e=0):e>n&&(e=n),e<t&&(e=t);var r;if(o.TYPED_ARRAY_SUPPORT)r=this.subarray(t,e),r.__proto__=o.prototype;else{var i=e-t;r=new o(i,void 0);for(var a=0;a<i;++a)r[a]=this[a+t]}return r},o.prototype.readUIntLE=function(t,e,n){t|=0,e|=0,n||z(t,e,this.length);for(var r=this[t],i=1,o=0;++o<e&&(i*=256);)r+=this[t+o]*i;return r},o.prototype.readUIntBE=function(t,e,n){t|=0,e|=0,n||z(t,e,this.length);for(var r=this[t+--e],i=1;e>0&&(i*=256);)r+=this[t+--e]*i;return r},o.prototype.readUInt8=function(t,e){return e||z(t,1,this.length),this[t]},o.prototype.readUInt16LE=function(t,e){return e||z(t,2,this.length),this[t]|this[t+1]<<8},o.prototype.readUInt16BE=function(t,e){return e||z(t,2,this.length),this[t]<<8|this[t+1]},o.prototype.readUInt32LE=function(t,e){return e||z(t,4,this.length),(this[t]|this[t+1]<<8|this[t+2]<<16)+16777216*this[t+3]},o.prototype.readUInt32BE=function(t,e){return e||z(t,4,this.length),16777216*this[t]+(this[t+1]<<16|this[t+2]<<8|this[t+3])},o.prototype.readIntLE=function(t,e,n){t|=0,e|=0,n||z(t,e,this.length);for(var r=this[t],i=1,o=0;++o<e&&(i*=256);)r+=this[t+o]*i;return i*=128,r>=i&&(r-=Math.pow(2,8*e)),r},o.prototype.readIntBE=function(t,e,n){t|=0,e|=0,n||z(t,e,this.length);for(var r=e,i=1,o=this[t+--r];r>0&&(i*=256);)o+=this[t+--r]*i;return i*=128,o>=i&&(o-=Math.pow(2,8*e)),o},o.prototype.readInt8=function(t,e){return e||z(t,1,this.length),128&this[t]?-1*(255-this[t]+1):this[t]},o.prototype.readInt16LE=function(t,e){e||z(t,2,this.length);var n=this[t]|this[t+1]<<8;return 32768&n?4294901760|n:n},o.prototype.readInt16BE=function(t,e){e||z(t,2,this.length);var n=this[t+1]|this[t]<<8;return 32768&n?4294901760|n:n},o.prototype.readInt32LE=function(t,e){return e||z(t,4,this.length),this[t]|this[t+1]<<8|this[t+2]<<16|this[t+3]<<24},o.prototype.readInt32BE=function(t,e){return e||z(t,4,this.length),this[t]<<24|this[t+1]<<16|this[t+2]<<8|this[t+3]},o.prototype.readFloatLE=function(t,e){return e||z(t,4,this.length),K.read(this,t,!0,23,4)},o.prototype.readFloatBE=function(t,e){return e||z(t,4,this.length),K.read(this,t,!1,23,4)},o.prototype.readDoubleLE=function(t,e){return e||z(t,8,this.length),K.read(this,t,!0,52,8)},o.prototype.readDoubleBE=function(t,e){return e||z(t,8,this.length),K.read(this,t,!1,52,8)},o.prototype.writeUIntLE=function(t,e,n,r){t=+t,e|=0,n|=0,r||D(this,t,e,n,Math.pow(2,8*n)-1,0);var i=1,o=0;for(this[e]=255&t;++o<n&&(i*=256);)this[e+o]=t/i&255;return e+n},o.prototype.writeUIntBE=function(t,e,n,r){t=+t,e|=0,n|=0,r||D(this,t,e,n,Math.pow(2,8*n)-1,0);var i=n-1,o=1;for(this[e+i]=255&t;--i>=0&&(o*=256);)this[e+i]=t/o&255;return e+n},o.prototype.writeUInt8=function(t,e,n){return t=+t,e|=0,n||D(this,t,e,1,255,0),o.TYPED_ARRAY_SUPPORT||(t=Math.floor(t)),this[e]=255&t,e+1},o.prototype.writeUInt16LE=function(t,e,n){return t=+t,e|=0,n||D(this,t,e,2,65535,0),o.TYPED_ARRAY_SUPPORT?(this[e]=255&t,this[e+1]=t>>>8):B(this,t,e,!0),e+2},o.prototype.writeUInt16BE=function(t,e,n){return t=+t,e|=0,n||D(this,t,e,2,65535,0),o.TYPED_ARRAY_SUPPORT?(this[e]=t>>>8,this[e+1]=255&t):B(this,t,e,!1),e+2},o.prototype.writeUInt32LE=function(t,e,n){return t=+t,e|=0,n||D(this,t,e,4,4294967295,0),o.TYPED_ARRAY_SUPPORT?(this[e+3]=t>>>24,this[e+2]=t>>>16,this[e+1]=t>>>8,this[e]=255&t):j(this,t,e,!0),e+4},o.prototype.writeUInt32BE=function(t,e,n){return t=+t,e|=0,n||D(this,t,e,4,4294967295,0),o.TYPED_ARRAY_SUPPORT?(this[e]=t>>>24,this[e+1]=t>>>16,this[e+2]=t>>>8,this[e+3]=255&t):j(this,t,e,!1),e+4},o.prototype.writeIntLE=function(t,e,n,r){if(t=+t,e|=0,!r){var i=Math.pow(2,8*n-1);D(this,t,e,n,i-1,-i)}var o=0,a=1,s=0;for(this[e]=255&t;++o<n&&(a*=256);)t<0&&0===s&&0!==this[e+o-1]&&(s=1),this[e+o]=(t/a>>0)-s&255;return e+n},o.prototype.writeIntBE=function(t,e,n,r){if(t=+t,e|=0,!r){var i=Math.pow(2,8*n-1);D(this,t,e,n,i-1,-i)}var o=n-1,a=1,s=0;for(this[e+o]=255&t;--o>=0&&(a*=256);)t<0&&0===s&&0!==this[e+o+1]&&(s=1),this[e+o]=(t/a>>0)-s&255;return e+n},o.prototype.writeInt8=function(t,e,n){return t=+t,e|=0,n||D(this,t,e,1,127,-128),o.TYPED_ARRAY_SUPPORT||(t=Math.floor(t)),t<0&&(t=255+t+1),this[e]=255&t,e+1},o.prototype.writeInt16LE=function(t,e,n){return t=+t,e|=0,n||D(this,t,e,2,32767,-32768),o.TYPED_ARRAY_SUPPORT?(this[e]=255&t,this[e+1]=t>>>8):B(this,t,e,!0),e+2},o.prototype.writeInt16BE=function(t,e,n){return t=+t,e|=0,n||D(this,t,e,2,32767,-32768),o.TYPED_ARRAY_SUPPORT?(this[e]=t>>>8,this[e+1]=255&t):B(this,t,e,!1),e+2},o.prototype.writeInt32LE=function(t,e,n){return t=+t,e|=0,n||D(this,t,e,4,2147483647,-2147483648),o.TYPED_ARRAY_SUPPORT?(this[e]=255&t,this[e+1]=t>>>8,this[e+2]=t>>>16,this[e+3]=t>>>24):j(this,t,e,!0),e+4},o.prototype.writeInt32BE=function(t,e,n){return t=+t,e|=0,n||D(this,t,e,4,2147483647,-2147483648),t<0&&(t=4294967295+t+1),o.TYPED_ARRAY_SUPPORT?(this[e]=t>>>24,this[e+1]=t>>>16,this[e+2]=t>>>8,this[e+3]=255&t):j(this,t,e,!1),e+4},o.prototype.writeFloatLE=function(t,e,n){return L(this,t,e,!0,n)},o.prototype.writeFloatBE=function(t,e,n){return L(this,t,e,!1,n)},o.prototype.writeDoubleLE=function(t,e,n){return N(this,t,e,!0,n)},o.prototype.writeDoubleBE=function(t,e,n){return N(this,t,e,!1,n)},o.prototype.copy=function(t,e,n,r){if(n||(n=0),r||0===r||(r=this.length),e>=t.length&&(e=t.length),e||(e=0),r>0&&r<n&&(r=n),r===n)return 0;if(0===t.length||0===this.length)return 0;if(e<0)throw new RangeError("targetStart out of bounds");if(n<0||n>=this.length)throw new RangeError("sourceStart out of bounds");if(r<0)throw new RangeError("sourceEnd out of bounds");r>this.length&&(r=this.length),t.length-e<r-n&&(r=t.length-e+n);var i,a=r-n;if(this===t&&n<e&&e<r)for(i=a-1;i>=0;--i)t[i+e]=this[i+n];else if(a<1e3||!o.TYPED_ARRAY_SUPPORT)for(i=0;i<a;++i)t[i+e]=this[i+n];else Uint8Array.prototype.set.call(t,this.subarray(n,n+a),e);return a},o.prototype.fill=function(t,e,n,r){if("string"==typeof t){if("string"==typeof e?(r=e,e=0,n=this.length):"string"==typeof n&&(r=n,n=this.length),1===t.length){var i=t.charCodeAt(0);i<256&&(t=i)}if(void 0!==r&&"string"!=typeof r)throw new TypeError("encoding must be a string");if("string"==typeof r&&!o.isEncoding(r))throw new TypeError("Unknown encoding: "+r)}else"number"==typeof t&&(t&=255);if(e<0||this.length<e||this.length<n)throw new RangeError("Out of range index");if(n<=e)return this;e>>>=0,n=void 0===n?this.length:n>>>0,t||(t=0);var a;if("number"==typeof t)for(a=e;a<n;++a)this[a]=t;else{var s=o.isBuffer(t)?t:X(new o(t,r).toString()),u=s.length;for(a=0;a<n-e;++a)this[a+e]=s[a%u]}return this};var tt=/[^+\/0-9A-Za-z-_]/g}).call(e,n(38))},function(t,e,n){"use strict";function r(t){var e=t.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var n=t.indexOf("=");return-1===n&&(n=e),[n,n===e?0:4-n%4]}function i(t){var e=r(t),n=e[0],i=e[1];return 3*(n+i)/4-i}function o(t,e,n){return 3*(e+n)/4-n}function a(t){for(var e,n=r(t),i=n[0],a=n[1],s=new f(o(t,i,a)),u=0,h=a>0?i-4:i,c=0;c<h;c+=4)e=l[t.charCodeAt(c)]<<18|l[t.charCodeAt(c+1)]<<12|l[t.charCodeAt(c+2)]<<6|l[t.charCodeAt(c+3)],s[u++]=e>>16&255,s[u++]=e>>8&255,s[u++]=255&e;return 2===a&&(e=l[t.charCodeAt(c)]<<2|l[t.charCodeAt(c+1)]>>4,s[u++]=255&e),1===a&&(e=l[t.charCodeAt(c)]<<10|l[t.charCodeAt(c+1)]<<4|l[t.charCodeAt(c+2)]>>2,s[u++]=e>>8&255,s[u++]=255&e),s}function s(t){return c[t>>18&63]+c[t>>12&63]+c[t>>6&63]+c[63&t]}function u(t,e,n){for(var r,i=[],o=e;o<n;o+=3)r=(t[o]<<16&16711680)+(t[o+1]<<8&65280)+(255&t[o+2]),i.push(s(r));return i.join("")}function h(t){for(var e,n=t.length,r=n%3,i=[],o=0,a=n-r;o<a;o+=16383)i.push(u(t,o,o+16383>a?a:o+16383));return 1===r?(e=t[n-1],i.push(c[e>>2]+c[e<<4&63]+"==")):2===r&&(e=(t[n-2]<<8)+t[n-1],i.push(c[e>>10]+c[e>>4&63]+c[e<<2&63]+"=")),i.join("")}e.byteLength=i,e.toByteArray=a,e.fromByteArray=h;for(var c=[],l=[],f="undefined"!=typeof Uint8Array?Uint8Array:Array,d="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",p=0,g=d.length;p<g;++p)c[p]=d[p],l[d.charCodeAt(p)]=p;l["-".charCodeAt(0)]=62,l["_".charCodeAt(0)]=63},function(t,e){e.read=function(t,e,n,r,i){var o,a,s=8*i-r-1,u=(1<<s)-1,h=u>>1,c=-7,l=n?i-1:0,f=n?-1:1,d=t[e+l];for(l+=f,o=d&(1<<-c)-1,d>>=-c,c+=s;c>0;o=256*o+t[e+l],l+=f,c-=8);for(a=o&(1<<-c)-1,o>>=-c,c+=r;c>0;a=256*a+t[e+l],l+=f,c-=8);if(0===o)o=1-h;else{if(o===u)return a?NaN:1/0*(d?-1:1);a+=Math.pow(2,r),o-=h}return(d?-1:1)*a*Math.pow(2,o-r)},e.write=function(t,e,n,r,i,o){var a,s,u,h=8*o-i-1,c=(1<<h)-1,l=c>>1,f=23===i?Math.pow(2,-24)-Math.pow(2,-77):0,d=r?0:o-1,p=r?1:-1,g=e<0||0===e&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(s=isNaN(e)?1:0,a=c):(a=Math.floor(Math.log(e)/Math.LN2),e*(u=Math.pow(2,-a))<1&&(a--,u*=2),e+=a+l>=1?f/u:f*Math.pow(2,1-l),e*u>=2&&(a++,u/=2),a+l>=c?(s=0,a=c):a+l>=1?(s=(e*u-1)*Math.pow(2,i),a+=l):(s=e*Math.pow(2,l-1)*Math.pow(2,i),a=0));i>=8;t[n+d]=255&s,d+=p,s/=256,i-=8);for(a=a<<i|s,h+=i;h>0;t[n+d]=255&a,d+=p,a/=256,h-=8);t[n+d-p]|=128*g}},function(t,e){var n={}.toString;t.exports=Array.isArray||function(t){return"[object Array]"==n.call(t)}},function(t,e){},function(t,e){},function(t,e){},function(t,e,n){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var i=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),o=n(40),a=n(84),s=a.Matrix.create,u=o.Creators,h=o.Computations,c=new h,l=new u,f=function(){function t(e){r(this,t),this.source=e,this.canvasSize=this.getCanvasSize(),this.planes=e.input,this.canvas=l.createCanvas(this.canvasSize.width,this.canvasSize.height),this.ctx=l.getContext(this.canvas)}return i(t,[{key:"getCanvasSize",value:function(){return{width:this.source.width,height:this.source.height}}},{key:"translateInput",value:function(t){var e=this.getCanvasSize();return{nww:t.nww,nwh:t.nwh,new:e.width-t.new,neh:t.neh,sww:t.sww,swh:e.height-t.swh,seh:e.height-t.seh,sew:e.width-t.sew}}},{key:"cleanCanvas",value:function(){this.ctx.setTransform(1,0,0,1,0,0),this.ctx.rotate(0),this.ctx.fillStyle="#FFFFFF",this.ctx.fillRect(0,0,this.canvasSize.width,this.canvasSize.height)}},{key:"drawOnCanvas",value:function(t,e,n,r){var i=c.targetDimensions(r);this.ctx.drawImage(t,e,n,i.width,i.height)}},{key:"renderImage",value:function(t,e){var n=this.createTransformationMatrix(e);this.ctx.setTransform(n.e(1,1),n.e(2,1),n.e(1,2),n.e(2,2),n.e(1,3),n.e(2,3)),this.drawOnCanvas(t,0,0,e)}},{key:"createTransformationMatrix",value:function(t){var e=c.targetDimensions(t),n=e.width,r=e.height,i=s([[0,n,n,0],[0,0,r,r],[1,1,1,1]]),o=s([[t.nww,t.new,t.sew,t.sww],[t.nwh,t.neh,t.seh,t.swh],[1,1,1,1]]),a=i.x(i.transpose()).inverse();return o.x(i.transpose().x(a))}},{key:"render",value:function(){for(var t,e=0;e<this.planes.length;e++)t=this.planes[e],this.renderImage(t.canvas,this.translateInput(t.vertices));return this.canvas}}]),t}();t.exports=f},function(t,e,n){"use strict";var r={precision:1e-6};r.Matrix=function(){},r.Matrix.create=function(t){return(new r.Matrix).setElements(t)},r.Matrix.create,r.Matrix.I=function(t){for(var e,n=[],i=t;i--;)for(e=t,n[i]=[];e--;)n[i][e]=i===e?1:0;return r.Matrix.create(n)},r.Matrix.Diagonal=function(t){for(var e=t.length,n=r.Matrix.I(e);e--;)n.elements[e][e]=t[e];return n},r.Matrix.Rotation=function(t,e){if(!e)return r.Matrix.create([[Math.cos(t),-Math.sin(t)],[Math.sin(t),Math.cos(t)]]);var n=e.dup();if(3!==n.elements.length)return null;var i=n.modulus(),o=n.elements[0]/i,a=n.elements[1]/i,s=n.elements[2]/i,u=Math.sin(t),h=Math.cos(t),c=1-h;return r.Matrix.create([[c*o*o+h,c*o*a-u*s,c*o*s+u*a],[c*o*a+u*s,c*a*a+h,c*a*s-u*o],[c*o*s-u*a,c*a*s+u*o,c*s*s+h]])},r.Matrix.RotationX=function(t){var e=Math.cos(t),n=Math.sin(t);return r.Matrix.create([[1,0,0],[0,e,-n],[0,n,e]])},r.Matrix.RotationY=function(t){var e=Math.cos(t),n=Math.sin(t);return r.Matrix.create([[e,0,n],[0,1,0],[-n,0,e]])},r.Matrix.RotationZ=function(t){var e=Math.cos(t),n=Math.sin(t);return r.Matrix.create([[e,-n,0],[n,e,0],[0,0,1]])},r.Matrix.Random=function(t,e){return r.Matrix.Zero(t,e).map(function(){return Math.random()})},r.Matrix.Zero=function(t,e){for(var n,i=[],o=t;o--;)for(n=e,i[o]=[];n--;)i[o][n]=0;return r.Matrix.create(i)},r.Matrix.prototype={e:function(t,e){return t<1||t>this.elements.length||e<1||e>this.elements[0].length?null:this.elements[t-1][e-1]},row:function(t){return t>this.elements.length?null:r.Vector.create(this.elements[t-1])},col:function(t){if(0===this.elements.length)return null;if(t>this.elements[0].length)return null;for(var e=[],n=this.elements.length,i=0;i<n;i++)e.push(this.elements[i][t-1]);return r.Vector.create(e)},dimensions:function(){var t=0===this.elements.length?0:this.elements[0].length;return{rows:this.elements.length,cols:t}},rows:function(){return this.elements.length},cols:function(){return 0===this.elements.length?0:this.elements[0].length},eql:function(t){var e=t.elements||t;if(e[0]&&void 0!==e[0][0]||(e=r.Matrix.create(e).elements),0===this.elements.length||0===e.length)return this.elements.length===e.length;if(this.elements.length!==e.length)return!1;if(this.elements[0].length!==e[0].length)return!1;for(var n,i=this.elements.length,o=this.elements[0].length;i--;)for(n=o;n--;)if(Math.abs(this.elements[i][n]-e[i][n])>r.precision)return!1;return!0},dup:function(){return r.Matrix.create(this.elements)},map:function(t,e){if(0===this.elements.length)return r.Matrix.create([]);for(var n,i=[],o=this.elements.length,a=this.elements[0].length;o--;)for(n=a,i[o]=[];n--;)i[o][n]=t.call(e,this.elements[o][n],o+1,n+1);return r.Matrix.create(i)},isSameSizeAs:function(t){var e=t.elements||t;return void 0===e[0][0]&&(e=r.Matrix.create(e).elements),0===this.elements.length?0===e.length:this.elements.length===e.length&&this.elements[0].length===e[0].length},add:function(t){if(0===this.elements.length)return this.map(function(t){return t});var e=t.elements||t;return void 0===e[0][0]&&(e=r.Matrix.create(e).elements),this.isSameSizeAs(e)?this.map(function(t,n,r){return t+e[n-1][r-1]}):null},subtract:function(t){if(0===this.elements.length)return this.map(function(t){return t});var e=t.elements||t;return void 0===e[0][0]&&(e=r.Matrix.create(e).elements),this.isSameSizeAs(e)?this.map(function(t,n,r){return t-e[n-1][r-1]}):null},canMultiplyFromLeft:function(t){if(0===this.elements.length)return!1;var e=t.elements||t;return void 0===e[0][0]&&(e=r.Matrix.create(e).elements),this.elements[0].length===e.length},multiply:function(t){if(0===this.elements.length)return null;if(!t.elements)return this.map(function(e){return e*t});var e=!!t.modulus,n=t.elements||t;if(void 0===n[0][0]&&(n=r.Matrix.create(n).elements),!this.canMultiplyFromLeft(n))return null;for(var i,o,a,s=this.elements.length,u=n[0].length,h=this.elements[0].length,c=[];s--;)for(i=u,c[s]=[];i--;){for(o=h,a=0;o--;)a+=this.elements[s][o]*n[o][i];c[s][i]=a}var n=r.Matrix.create(c);return e?n.col(1):n},minor:function(t,e,n,i){if(0===this.elements.length)return null;for(var o,a,s,u=[],h=n,c=this.elements.length,l=this.elements[0].length;h--;)for(o=n-h-1,u[o]=[],a=i;a--;)s=i-a-1,u[o][s]=this.elements[(t+o-1)%c][(e+s-1)%l];return r.Matrix.create(u)},transpose:function(){if(0===this.elements.length)return r.Matrix.create([]);for(var t,e,n=this.elements.length,i=this.elements[0].length,o=[],t=i;t--;)for(e=n,o[t]=[];e--;)o[t][e]=this.elements[e][t];return r.Matrix.create(o)},isSquare:function(){var t=0===this.elements.length?0:this.elements[0].length;return this.elements.length===t},max:function(){if(0===this.elements.length)return null;for(var t,e=0,n=this.elements.length,r=this.elements[0].length;n--;)for(t=r;t--;)Math.abs(this.elements[n][t])>Math.abs(e)&&(e=this.elements[n][t]);return e},indexOf:function(t){if(0===this.elements.length)return null;var e,n,r=this.elements.length,i=this.elements[0].length;for(e=0;e<r;e++)for(n=0;n<i;n++)if(this.elements[e][n]===t)return{i:e+1,j:n+1};return null},diagonal:function(){if(!this.isSquare)return null;for(var t=[],e=this.elements.length,n=0;n<e;n++)t.push(this.elements[n][n]);return r.Vector.create(t)},toRightTriangular:function(){if(0===this.elements.length)return r.Matrix.create([]);var t,e,n,i,o=this.dup(),a=this.elements.length,s=this.elements[0].length;for(e=0;e<a;e++){if(0===o.elements[e][e])for(n=e+1;n<a;n++)if(0!==o.elements[n][e]){for(t=[],i=0;i<s;i++)t.push(o.elements[e][i]+o.elements[n][i]);o.elements[e]=t;break}if(0!==o.elements[e][e])for(n=e+1;n<a;n++){var u=o.elements[n][e]/o.elements[e][e];for(t=[],i=0;i<s;i++)t.push(i<=e?0:o.elements[n][i]-o.elements[e][i]*u);o.elements[n]=t}}return o},determinant:function(){if(0===this.elements.length)return 1;if(!this.isSquare())return null;for(var t=this.toRightTriangular(),e=t.elements[0][0],n=t.elements.length,r=1;r<n;r++)e*=t.elements[r][r];return e},isSingular:function(){return this.isSquare()&&0===this.determinant()},trace:function(){if(0===this.elements.length)return 0;if(!this.isSquare())return null;for(var t=this.elements[0][0],e=this.elements.length,n=1;n<e;n++)t+=this.elements[n][n];return t},rank:function(){if(0===this.elements.length)return 0;for(var t,e=this.toRightTriangular(),n=0,i=this.elements.length,o=this.elements[0].length;i--;)for(t=o;t--;)if(Math.abs(e.elements[i][t])>r.precision){n++;break}return n},augment:function(t){if(0===this.elements.length)return this.dup();var e=t.elements||t;void 0===e[0][0]&&(e=r.Matrix.create(e).elements);var n,i=this.dup(),o=i.elements[0].length,a=i.elements.length,s=e[0].length;if(a!==e.length)return null;for(;a--;)for(n=s;n--;)i.elements[a][o+n]=e[a][n];return i},inverse:function(){if(0===this.elements.length)return null;if(!this.isSquare()||this.isSingular())return null;for(var t,e,n,i,o,a=this.elements.length,s=a,u=this.augment(r.Matrix.I(a)).toRightTriangular(),h=u.elements[0].length,c=[];s--;){for(n=[],c[s]=[],i=u.elements[s][s],e=0;e<h;e++)o=u.elements[s][e]/i,n.push(o),e>=a&&c[s].push(o);for(u.elements[s]=n,t=s;t--;){for(n=[],e=0;e<h;e++)n.push(u.elements[t][e]-u.elements[s][e]*u.elements[t][s]);u.elements[t]=n}}return r.Matrix.create(c)},round:function(){return this.map(function(t){return Math.round(t)})},snapTo:function(t){return this.map(function(e){return Math.abs(e-t)<=r.precision?t:e})},inspect:function(){var t=[],e=this.elements.length;if(0===e)return"[]";for(var n=0;n<e;n++)t.push(r.Vector.create(this.elements[n]).inspect());return t.join("\n")},setElements:function(t){var e,n,r=t.elements||t;if(r[0]&&void 0!==r[0][0]){for(e=r.length,this.elements=[];e--;)for(n=r[e].length,this.elements[e]=[];n--;)this.elements[e][n]=r[e][n];return this}var i=r.length;for(this.elements=[],e=0;e<i;e++)this.elements.push([r[e]]);return this}},r.Matrix.prototype.toUpperTriangular=r.Matrix.prototype.toRightTriangular,r.Matrix.prototype.det=r.Matrix.prototype.determinant,r.Matrix.prototype.tr=r.Matrix.prototype.trace,r.Matrix.prototype.rk=r.Matrix.prototype.rank,r.Matrix.prototype.inv=r.Matrix.prototype.inverse,r.Matrix.prototype.x=r.Matrix.prototype.multiply,t.exports=r},function(t,e,n){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var i=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),o=n(40),a=o.Creators,s=o.Computations,u=new s,h=new a,c=function(){function t(e){r(this,t),this.source=e,this.sliceSize=1,this.source=e,this.planes=e.input,this.canvasSize=this.getCanvasSize(),this.thumbSize=this.getThumbSize(),this.printSize=this.getPrintSize(),this.ratio=this.printSize.height/this.thumbSize.height,this.gapSize=(1-this.printSize.ratio)*this.thumbSize.width,this.fullWidth=this.thumbSize.width+this.gapSize,this.scaleSctxRatio=this.printSize.height/this.planes[0].canvas.height;var n=parseInt(this.scaleSctxRatio*this.planes[0].canvas.width),i=parseInt(this.scaleSctxRatio*this.planes[0].canvas.height);this.sctxa=h.createCanvas(n,i),this.sctx=h.getContext(this.sctxa),this.sctx.drawImage(this.planes[0].canvas,0,0,this.planes[0].canvas.width,this.planes[0].canvas.height,0,0,n,i),this.imgData=this.sctx.getImageData(0,0,this.sctx.canvas.width,this.sctx.canvas.height),this.previosTargetX=null,this.previosX=null,this.previosTargetY=null,this.arrX=[],this.targetSize=this.defineSize(),this.numOfSlices=Math.round(Math.abs(this.targetSize.end-this.targetSize.start)/this.sliceSize),this.canvas=h.createCanvas(this.canvasSize.width,this.canvasSize.height),this.ctx=h.getContext(this.canvas)}return i(t,[{key:"getCanvasSize",value:function(){return{width:2*this.planes[0].cylinderize.r,height:this.planes[0].cylinderize.l+2*Math.sin(.5*Math.PI)*Math.tan(u.degToRad(this.planes[0].cylinderize.p))*this.planes[0].cylinderize.r}}},{key:"getThumbSize",value:function(){return{width:this.planes[0].width,height:this.planes[0].height}}},{key:"getPrintSize",value:function(){var t=this.planes[0].cylinderize,e=t.w/100;return{width:Math.round(2*Math.PI*t.r*e),height:t.l,gap:Math.round(2*Math.PI*t.r*(1-e)),ratio:e}}},{key:"defineSize",value:function(){var t=this.planes[0].cylinderize,e=this.thumbSize.width/this.printSize.ratio,n=e/2,r=t.a/360*e,i=this.thumbSize.width/2+r;return{start:i-n/2,end:i+n/2}}},{key:"putSlice",value:function(t){var e=t/this.numOfSlices,n=Math.sin(Math.PI*e),r=n*Math.tan(u.degToRad(this.planes[0].cylinderize.p))*this.planes[0].cylinderize.r,i=t*Math.PI/this.numOfSlices,o=(t+1)*Math.PI/this.numOfSlices,a=this.planes[0].cylinderize.r*(Math.cos(i)-Math.cos(o)),s=t*this.sliceSize,h=(s+this.targetSize.start+this.fullWidth)%this.fullWidth,c=0,l=!1;if(h<this.thumbSize.width?c=(s+this.fullWidth+this.targetSize.start)%this.fullWidth:h>=this.thumbSize.width+this.gapSize?c=(s+this.fullWidth-this.gapSize)%this.fullWidth:l=!0,!l){var f=c*this.scaleSctxRatio,d=this.loc;if(Math.floor(this.previosTargetX)!=Math.floor(d)&&this.previosTargetX){this.arrX.push(f);var p,g;for(p=0;p<this.imgData.height;p++){var v=p*(4*this.imgData.width)+0,m=0,y=0,w=0,x=0;for(g=0;g<this.arrX.length-1;g++){var b=Math.floor(this.arrX[g]),_=Math.floor(this.arrX[g+1]);if(b==_){var S=this.arrX[g+1]-this.arrX[g],M=p*(4*this.imgData.width)+4*b;m+=S*this.imgData.data[M+0],y+=S*this.imgData.data[M+1],w+=S*this.imgData.data[M+2],x+=S*this.imgData.data[M+3]}else{var S=b+1-this.arrX[g],M=p*(4*this.imgData.width)+4*b,k=this.arrX[g+1]-_,P=p*(4*this.imgData.width)+4*_;m+=S*this.imgData.data[M+0]+k*this.imgData.data[P+0],y+=S*this.imgData.data[M+1]+k*this.imgData.data[P+1],w+=S*this.imgData.data[M+2]+k*this.imgData.data[P+2],x+=S*this.imgData.data[M+3]+k*this.imgData.data[P+3]}}var I=this.arrX[this.arrX.length-1]-this.arrX[0];this.imgData.data[v+0]=Math.round(m/I),this.imgData.data[v+1]=Math.round(y/I),this.imgData.data[v+2]=Math.round(w/I),this.imgData.data[v+3]=Math.round(x/I)}this.arrX=[],this.arrX.push(f);var E=Math.floor(r),O=r-E,A=1-O;for(p=this.imgData.height-1;p>0;p--){var v=p*(4*this.imgData.width)+0,T=p*(4*this.imgData.width)+0,R=(p-1)*(4*this.imgData.width)+0,C=A*this.imgData.data[T+0]+O*this.imgData.data[R+0],z=A*this.imgData.data[T+1]+O*this.imgData.data[R+1],D=A*this.imgData.data[T+2]+O*this.imgData.data[R+2],B=A*this.imgData.data[T+3]+O*this.imgData.data[R+3];this.imgData.data[v+0]=Math.round(C),this.imgData.data[v+1]=Math.round(z),this.imgData.data[v+2]=Math.round(D),this.imgData.data[v+3]=Math.round(B)}this.ctx.putImageData(this.imgData,Math.floor(d-0),Math.floor(r),0,0,Math.ceil(a),this.printSize.height)}else this.arrX.push(f);this.previosTargetX=d,this.previosTargetY=r,this.previosX=f}this.loc+=a}},{key:"clean",value:function(){this.sctx=null,this.sctxa=null}},{key:"render",value:function(){this.loc=0;for(var t=0;t<this.numOfSlices;t++)this.putSlice(t);return this.clean(),this.canvas}}]),t}();t.exports=c},function(t,e){t.exports={name:"@pc/thumbnailsdk",version:"1.0.15",description:"",main:"src/ThumbGenerator.js",dependencies:{canvas:"^2.0.1",request:"^2.88.0"},devDependencies:{babel:"^6.23.0","babel-core":"^6.26.0","babel-loader":"^6.2.8","babel-preset-es2015":"^6.18.0",webpack:"^3.10.0","webpack-bundle-analyzer":"^2.9.2"},browser:{fs:!1,os:!1,canvas:!1,request:!1},scripts:{build:"webpack -p",test:'echo "Error: no test specified" && exit 1'},publishConfig:{registry:"http://npm.photoccino.com:4873"},author:"dbrauner",license:"ISC"}}]);
//# sourceMappingURL=MgThumbGenerator.js.map
;
define("mgthumb", (function (global) {
    return function () {
        var ret, fn;
        return ret || global.mgthumb;
    };
}(this)));



/*
MagicSelectBox - An HTML Select Custom multiple choice JS script

    @param selectId : the Select box ID to custom design
    @param timeout  : If a timeout has been defined, after 'timeout' time the 'callback' will be called
    @param callback : The callback will be called on 'Apply' button click or timeout.

    The callback will be called with an array of values selected.
 */

var MagicSelectBox = function(selectId, timeout, multichoice, callback, onOpenCallback, closeOnClickContainerId) {

    this.MAX_VALUE_CHARS        = 23;
    this.SHORT_MAX_VALUE_CHARS  = 21;

    /* === Variables === */

    this.selectId           = selectId;
    this.multiSelect        = multichoice;
    this.timeOut            = null;
    this.timeoutTime        = timeout;
    this.callback           = callback;
    this.onOpenCallback     = onOpenCallback;
    this.created            = false;
    this.menuOpen           = false;
    this.latestState        = [];
    this.closeIfClickedOut  = typeof closeOnClickContainerId !== 'undefined' ? closeOnClickContainerId : null;




    /* === Private Methods === */

    this._tmplSelect = "<div class='msb_wrapper'>" +
        "<div class='msb_facade'>" +
        "<span class='msb_curr_value'>Select Album</span><div class='msb_arrow'>&nbsp;</div>" +
        "</div>" +
        "<div class='msb_divider'>&nbsp;</div>" +
        "<div class='msb_options_wrapper'></div>" +
        "</div>";

    this._tmplOption = "<div class='msb_option'>" +
        "<div class='msb_checkbox' data-value='{{ value }}' data-text='{{ full_display }}'></div><span class='msb_option_value' title='{{ full_display }}'>{{ display }}</span>"
    "</div>"

    this._tmplApplyButton = "<div class='msb_btn_apply_wrapper'><div class='msb_btn_apply'><a href='javascript:void(0);'>{{ text }}</a></div></div>";

    this._getElement = function(elemId) {
        var elm = $('#' + elemId);
        if (elm.length) {
            return elm;
        } else {
            console.log('[ERROR] Element not found');
            return null;
        }
    };

    this._initBindings = function() {
        var _that = this;
        this.msb.children('.msb_facade').on('click', function(e) {
            e.stopPropagation();
            _that.closeOpen();
        });
    };

    this._shortenText = function(text) {
        return text.length > this.MAX_VALUE_CHARS ? text.substr(0,this.MAX_VALUE_CHARS-3) + "..." : text;
    };

    this._fillOptions = function() {
        var options = this.msb.children('.msb_options_wrapper')[0];
        $(options).html('');

        var _that = this;

        this.elem.children().each(function(idx, val) {
            var text = _that._shortenText(val.text);
            var opt = $(_that._tmplOption.replace('{{ full_display }}', val.text).replace('{{ display }}', text).replace('{{ value }}', val.value).replace('{{ full_display }}', val.text));
            $(options).append(opt).append('<br/>');

            $(opt).on('click', function(e) {
                e.stopPropagation();

                // Don't allow making Zero selection
                if ($(this).children('.msb_checkbox').hasClass('msb_selected') && $(options).find('.msb_selected').length == 1) {
                    return;
                }

                if (!$(this).children('.msb_checkbox').hasClass('msb_selected') && !_that.multiSelect) {
                    $(options).find('.msb_checkbox').removeClass('msb_selected');
                }

                $(this).children('.msb_checkbox').toggleClass('msb_selected');
                _that._setSelectedCaption();

               if (_that.timeOut) {
                   clearTimeout(_that.timeOut);
               }

                if (_that.timeoutTime > 0) {
                    _that.timeOut = setTimeout(function() {
                        if (typeof(_that.callback) != 'undefined' && _that.callback != null) {
                            _that.callback(_that._getSelected(false));
                        }
                        _that._setSelectedCaption();
                    }, _that.timeoutTime);
                }
            });
        });

        this._addApplyButton(this.msb.find('.msb_options_wrapper').first());

        this.msb.find('.msb_options_wrapper').first().on('click', function(e) {
            e.stopPropagation();
        });
    };

    this._getSelected = function(returnValue) {
        var selected = this.msb.find('.msb_selected');

        var values = [];

        selected.each(function(idx, val) {
            if (returnValue) {
                values.push($(val).attr('data-value'));
            } else {
                values.push($(val).attr('data-text'));
            }
        });

        return values;
    };

    this._setSelectedCaption = function() {
        var titles = this._getSelected(false);

        var value       = "Select Album";
        var short_val   = "Select Album";

        if (titles.length == 1) {
            value = titles[0];
            short_val = value.length > this.SHORT_MAX_VALUE_CHARS ? value.substr(0, this.SHORT_MAX_VALUE_CHARS-3) + "..." : value;
        } else if (titles.length > 1) {
            value = titles.length + ' Selected';
            short_val = value;
        }

        this.msb.find('.msb_curr_value').first().html(short_val).attr('title', value);
    };

    this._addApplyButton = function(elemToAddTo) {
        var applyBtn = $(this._tmplApplyButton.replace('{{ text }}', 'Apply'));
        $(elemToAddTo).append(applyBtn);

        var _that = this;

        applyBtn.on('click', function() {
            if (typeof(_that.callback) != 'undefined' && _that.callback != null) {
                var currState = _that.getValues();
                if (_that._isStateChanged(currState)) {
                    _that.callback(_that._getSelected(false));
                }
            }
            _that._setSelectedCaption();
            _that.closeOpen(true);
        });
    };

    this._loadLastState = function() {
        this.clearAllSelected();
        var _that = this;
        this.latestState.forEach(function(idx, val) {
            _that.addSelectedValue(idx);
        });
    };

    this._isStateChanged = function(newState) {
        // This is the most Naive approach for comapring two arrays. As those are short, we don't care.
        var found = 0;
        var target = newState.length > this.latestState.length ? newState.length : this.latestState.length;
        var _that = this;
        newState.forEach(function(v1, idx) {
           _that.latestState.forEach(function(v2, idx) {
                if (v1 == v2) {
                    found += 1;
                }
            });
        });

        return found != target;
    };

    this._createOuterClickContainer = function() {
        var container = $(this.closeIfClickedOut);
        var _that = this;
        if (container == null) {
            return;
        }

        $(container).append('<div class="msb_bg_click_catcher"></div>');

        $(container).children('.msb_bg_click_catcher').on('click', function() {
            _that.closeOpen();
        })
    };

    this._removeOuterClickContainer = function() {
        var container = $(this.closeIfClickedOut);
        if (container == null) {
            return;
        }

        $(container).children('.msb_bg_click_catcher').remove();
    };


    /* === Public Methods === */

    this.closeOpen = function(forceClose) {
        // Give forceClose a default value of 'false'
        forceClose = typeof forceClose !== 'undefined' ? forceClose : false;

        this.menuOpen = !this.menuOpen;
        if (forceClose)
            this.menuOpen = false;

        if (this.menuOpen) {
            if (typeof this.onOpenCallback != 'undefined') {
                onOpenCallback();
            }

            this.msb.find('.msb_arrow').addClass('msb_arrow_up');
            this.msb.find('.msb_divider').show();
            this.msb.find('.msb_facade').addClass('msb_facade_open');
            this.msb.children('.msb_options_wrapper').slideDown();

            if (this.closeIfClickedOut != null) {
                this._createOuterClickContainer();
            }

            this.latestState = this.getValues();
        } else {
            this.msb.find('.msb_arrow').removeClass('msb_arrow_up');
            this.msb.find('.msb_divider').hide();
            this.msb.find('.msb_facade').removeClass('msb_facade_open');
            this.msb.children('.msb_options_wrapper').slideUp(100);

            if (!forceClose){
                this._loadLastState();
            }

            if (this.closeIfClickedOut != null) {
                this._removeOuterClickContainer();
            }
        }

        if (this.timeOut) {
            clearTimeout(this.timeOut);
        }
    };

    this.getValues = function() {
        return this._getSelected(true);
    };

    this.addSelectedValue = function(id) {
        this.msb.find('.msb_checkbox[data-value=' + id + ']').addClass('msb_selected');
        this._setSelectedCaption();
    };

    this.clearAllSelected = function() {
        this.msb.find('.msb_checkbox').removeClass('msb_selected');
        this._setSelectedCaption();
    };

    this.changeTextById = function(id, newText) {
        var elem = this.msb.find('.msb_checkbox[data-value=' + id + ']').parent();
        elem.children('.msb_checkbox').first().attr('data-text', newText);
        elem.children('.msb_option_value').first().attr('title', newText).html(this._shortenText(newText));
    };

    this.makeBox = function(callback) {
        this.elem = this._getElement(this.selectId);
        if (this.elem == null || this.created) {
            return false;
        }

        this.msb = $(this._tmplSelect);
        this.elem.hide().after(this.msb);

        this._initBindings();
        this._fillOptions();

        this.created = true;

        return true;
    };
};
define("magicselect", (function (global) {
    return function () {
        var ret, fn;
        return ret || global.magicselect;
    };
}(this)));

define('app/album_switch', ['underscore', 'app/cache_module'], function(_, cache) {
    var URL_GET_FOLDERS = "https://www{{env}}.shutterfly.com/services/user-media/{{userid}}/folders?access_token={{token}}&pageSize=1000000";
    var URL_GET_ALBUMS  = "https://www{{env}}.shutterfly.com/services/user-media/{{userid}}/folders/{{folderid}}/albums/?access_token={{token}}&pageSize=1000000";
    var URL_GET_PHOTOS  = "https://www{{env}}.shutterfly.com/services/user-media/{{userid}}/folders/{{folderid}}/albums/{{albumid}}/images?access_token={{token}}&pageSize=1000000";
    var MAX_ALBUMS      = 10;

    /*
    Will get a list of folder ids for the given user
    @param int userId
    @param string token
    @param function callback - will be called with the list of Ids
     */
    function getUserFolderIds(userId, token, callback) {
        var env = cache.get('env') != 'prod' ? '.' + cache.get('env') : '';
        var url = URL_GET_FOLDERS.replace('{{userid}}', userId).replace('{{token}}', token).replace('{{env}}', env);

        $.getJSON(url, function(response) {
            var folders = response.items;
            var folderIds = _.map(folders, function(folder) { return folder.id });

            callback(folderIds);
        });
    }

    /*
    Will get a list of albums in the given folder
    @param int folderId
    @param int userId
    @param string token
    @param function callback - will be called with a list of albums in the folder
    @return deffered promise
     */
    function getAlbumsInFolder(folderId, userId, token, callback) {
        var env = cache.get('env') != 'prod' ? '.' + cache.get('env') : '';
        var url = URL_GET_ALBUMS.replace('{{userid}}', userId).replace('{{token}}', token).replace('{{env}}', env).replace('{{folderid}}', folderId);

        var deffered = $.Deferred();

        $.getJSON(url)
            .done(function(response) {
                var albums = response.items;
                var albumStructs = _.map(albums, function (album) {
                    return { id: album.id, title: album.title, folder_id: folderId, mod_date: (new Date(album.updtime)).getTime() / 1000 };
                });

                callback(albumStructs);
                deffered.resolve();
            })
            .fail(function() {
                deffered.reject();
            });

        return deffered.promise();
    }

    /*
    Will get a list of photos in the given album
    @param int folderId
    @param int albumId
    @param function callback - will be called with the list of the photos
     */
    function getPhotosForSingleAlbum(userId, token, folderId, albumId, callback) {

        // Check if the photos are in the cache
        var photos = cache.getUserAlbumPhotos(albumId);
        if (typeof photos !== 'undefined' && photos != null) {
            callback(photos);
            return;
        }

        var env = cache.get('env') != 'prod' ? '.' + cache.get('env') : '';
        var url = URL_GET_PHOTOS.replace('{{userid}}', userId).replace('{{token}}', token).replace('{{env}}', env).replace('{{folderid}}', folderId).replace('{{albumid}}', albumId);

        $.getJSON(url)
        .done(function(response) {
            var photos = _.map(response.items, function (photo) {
                var dateTaken;
                try {
                    dateTaken = (new Date(photo.instime)).getTime() / 1000;
                } catch(exc) {
                    dateTaken = Date.now();
                }
                return {
                    id: photo.id,
                    dateTaken: dateTaken,
                    url: photo.url,
                    origHeight: photo.image_def.primary_height,
                    origWidth: photo.image_def.primary_width
                }
            });

            callback({ albumId: albumId, photos: photos, numPhotos: photos.length });
            cache.saveUserAlbumPhotos(albumId, { albumId: albumId, photos: photos, numPhotos: photos.length });
        })
        .fail(function() {
            callback(null);
        });
    }

    /*
    Will return the requested number of albums from the given albums
    @param array albums - list of current albums
    @param array mustIncludeAlbums - list of albums that must be in the final result
    @param int maxAlbums - maximum albums to return
    @return array - return subset of the albums requested
     */
    function getRelevantAlbums(albums, mustIncludeAlbums, maxAlbums) {
        // Sometimes its strings and sometimes INTs - just make it INT.
        mustIncludeAlbums           = _.map(mustIncludeAlbums, function(album) { return parseInt(album); });

        var listOfAlbums            = _.sortBy(albums, function(album) { return album.mod_date * -1; });
        var listOfAlbumsSliced      = listOfAlbums.slice(0, maxAlbums);
        var listOfMustInclude       = _.filter(albums, function(album) { return mustIncludeAlbums.indexOf(parseInt(album.id)) > -1 });

        listOfMustInclude.forEach(function(album) {
            if (listOfAlbumsSliced.indexOf(album) < 0) {
                // The required album is not present, add it but remove a non-needed  album
                if (listOfAlbumsSliced.length >= maxAlbums) {
                    listOfAlbumsSliced.pop();
                }
                listOfAlbumsSliced.push(album);
            }
        });

        return listOfAlbumsSliced;
    }

    return {
        /*
        Will return a list of Albums {id, title} for the current user
        @param function callback - will be called with the list of albums
        @param array mustIncludeAlbums - a list of albums that MUST be included in the final list
         */
        getAlbums: function(mustIncludeAlbums, callback) {
            var userId  = cache.get('partner_user_id');
            var token   = cache.get('token');

            // Check if the data is in the cache
            var albums = cache.getUserAlbums(userId);
            if (typeof albums !== 'undefined' && albums != null) {
                callback(albums);
                return;
            }

            getUserFolderIds(userId, token, function(folderIds) {
                var albumPromises = [];
                var albums = [];

                function _getAlbumIds(albumStructs) {
                    if (albumStructs != null) {
                        albums = albums.concat(albumStructs);
                    }
                }

                _.each(folderIds, function(folderId) {
                    albumPromises.push(getAlbumsInFolder(folderId, userId, token, _getAlbumIds));
                });

                $.when.apply(undefined, albumPromises).then(function() {
                    albums = getRelevantAlbums(albums, mustIncludeAlbums, MAX_ALBUMS);
                    cache.saveUserAlbums(userId, albums);
                    callback(albums);
                });
            });
        },

        /*
        Will get the photos for each of the albums. Will call the callback with each albums photos
        @param array albums - a list of albums to get photos for
        @param function callback - callback that will be called with the photos of each album
         */
        getPhotos: function(albums, callback) {
            var userId  = cache.get('partner_user_id');
            var token   = cache.get('token');

            _.each(albums, function(album) {
                getPhotosForSingleAlbum(userId, token, album.folder_id, album.id, callback);
            });
        },

        /*
        Will return the photos associated with the given album
        @param int albumId
        @return array - list of photos
         */
        getPhotosForAlbum: function(albumId, callback) {
            var photos = cache.getUserAlbumPhotos(albumId);
            if (typeof photos !== 'undefined' && photos != null) {
                callback(photos);
            } else {
                // Assumption: If user got here, we already loaded the albums and folder info and have it in the cache
                var userId  = cache.get('partner_user_id');
                var token   = cache.get('token');

                // find the requested album (per the assumption above)
                var albums = cache.getUserAlbums(userId);
                var album  = _.find(albums, function(alb) { if (alb.id == albumId) return alb; });

                // Request the photos though they might be coming already in another request.
                getPhotosForSingleAlbum(userId, token, album.folder_id, album.id, callback);
            }
        }
    }
});
/*
 This module will include shared parts of the modal windows
 */

define('app/view_engine/modals/shared', ['underscore', 'app/view_engine/widgets/common', 'app/album_switch', 'app/templates', 'app/cache_module', 'app/utils'], function(_, view_common, albumSwitch, templates, cache, utils) {
    return {
        // Set the correct pages count based on the current spread
        setPagesCount: function(container, currPage, totalPages) {
            currPage = currPage >= 99 ? totalPages-1 : currPage;

            if (currPage == totalPages-1) {
                currPage = currPage * 2 - 2;
                $(container).find('.sfly-wgt-pages').html(currPage);
            } else if (currPage == 1) {
                $(container).find('.sfly-wgt-pages').html('1');
            } else if (currPage > 1) {
                currPage = currPage * 2 - 2;
                $(container).find('.sfly-wgt-pages').html(currPage + '-' + (currPage+1));
            } else {
                $(container).find('.sfly-wgt-pages').html('Cover');
            }
        },

        // Will set the arrow classes - if on cover will disable first arrow, if on last page - will disable last arrow
        setArrowPagingClass: function(container, currPage, lastPage) {
            if (currPage == 0 && currPage == lastPage) {
                $(container).find('#sfly_wgt_sideopen_arrow_left').addClass('nonactive-arrow');
                $(container).find('#sfly_wgt_sideopen_arrow_right').addClass('nonactive-arrow');
            } else if (currPage == 0) {
                $(container).find('#sfly_wgt_sideopen_arrow_left').addClass('nonactive-arrow');
                $(container).find('#sfly_wgt_sideopen_arrow_right').removeClass('nonactive-arrow');
            } else if (currPage == lastPage) {
                $(container).find('#sfly_wgt_sideopen_arrow_right').addClass('nonactive-arrow');
                $(container).find('#sfly_wgt_sideopen_arrow_left').removeClass('nonactive-arrow');
            } else {
                $(container).find('#sfly_wgt_sideopen_arrow_right').removeClass('nonactive-arrow');
                $(container).find('#sfly_wgt_sideopen_arrow_left').removeClass('nonactive-arrow');
            }
        },

        /*
         Will wrap a callback and if the callback is not define, will define a function instead.
         This is some kind of sanitization method.
         @param function callback - callback to be called
         @return function - the callback OR an empty function
         */
        callbackWrapper: function(callback) {
            if (_.isFunction(callback)) {
                return callback;
            } else {
                return function() {};
            }
        },

        /**
         * Convert SFLY mPath to ID
         * @param mPath
         * @returns {string}
         */
        convertSFLYmPathToId: function(mPath) {
            var g = 1999;
            var b = 17;
            var k = mPath.split("/");
            var l = parseInt(k[k.length - 1]);
            var h = parseInt(k[k.length - 2]);
            var m = parseInt(k[k.length - 3]);
            var q = parseInt(k[k.length - 4]);
            var p = k[k.length - 8];
            var n = 1 << 30 | 12 * (q - g) + m - 1 << b + 5 | h << b | l;
            return n.toString();
        },

        /*
         Will add an album switch dropdown to the given container. Will call the callback when an album is changed.
         @param object container - container where to put the dropdown
         @param array loadedAlbums - an array of albums initially loaded
         @param int currAlbumId - The currently used album
         @param function callback - callback that will be called with the new chosen albumId
         */
        addAlbumSwitch: function(container, loadedAlbums, currAlbumId, callback) {
            var mappedLoadedAlbums = [currAlbumId];//_.map(loadedAlbums, function(album) { return album.albumId });

            albumSwitch.getAlbums(mappedLoadedAlbums, function(albums) {
                $(container).find('#sfly_wgt_album_switch_select').remove();
                $(container).append(view_common.renderTemplate(templates.side_albumswitch, { albums: albums }));
                var msb     = new MagicSelectBox('sfly_wgt_albumswitch', 0, false, onAlbumChange, undefined, container);
                var succ    = msb.makeBox();

                if (!succ) {
                    // Failed to load the album switch. remove it.
                    console.log('[Product Widget] Failed to create the Album Switch dropdown');
                    $(container).find('#sfly_wgt_album_switch_select').remove();
                } else {
                    albumSwitch.getPhotos(albums, function(photoObject) {
                        if (photoObject != null) {
                            // Find the album that was found and get its Title to show
                            var currAlbum = _.find(albums, function (alb)
                            {
                                if (alb.id == photoObject.albumId) return alb
                            });
                            msb.changeTextById(photoObject.albumId, currAlbum.title + ' (' + photoObject.numPhotos + ')');
                        }
                    });

                    // Select the current Album
                    if (typeof currAlbumId !== 'undefined') {
                        msb.addSelectedValue(currAlbumId);
                    }
                }

                function onAlbumChange() {
                    var selectedAlbumId = msb.getValues()[0];
                    if (typeof selectedAlbumId !== 'undefined' && typeof callback !== 'undefined') {
                        callback(selectedAlbumId, msb);
                    }
                }
            });
        },

        /**
         * show upp window
         * @param function onOKCallback - callback on done button
         * @param function onCancelCallback - callback on cancel button
         */
        showUPP: function(onOKCallback, onCancelCallback){

            var that = this;

            function showUPPwindow() {
                var startTimeCheckShrLoaded = Date.now();
                var checkShrLoaded = setInterval(function() {
                    if(Date.now() - startTimeCheckShrLoaded <= 5*1000) {
                        if (typeof window.Shr !== "undefined" && typeof window.Shr.Score !== "undefined"  &&  window.Shr.Score.state == window.Shr.Score.State.loaded && typeof window.Shr.U !== "undefined"  && ( window.Shr.U.status == window.Shr.U.Status.signedIn ||  window.Shr.U.status == window.Shr.U.Status.signedOut)) {
                            clearInterval(checkShrLoaded);


                            if(cache.get('partner_user_id') != '009085953279' && typeof window.Shr.U.migrated === "undefined" && typeof cache.get('superfly_user') !== 'undefined'){
                                window.Shr.Dialogs.UniversalPicker.superfly = true;
                                window.Shr.U.migrated = true;
                            }

                            var uppOptions = {
                                bgMask:"#464646",
                                maxCount: 1000,
                                L10N: {
                                    cannotSelect: {
                                        title: "Can't select more than 1000 photos"
                                    },
                                    cannotSelectAll: {
                                        title: "Can't select more than 1000 photos",
                                        shiftTitle: "Can't select more than 1000 photos"
                                    }
                                },
                                /*sources: { stockphotos: { hide: false } },*/
                                onOk: function(c, imageIds, items) {

                                    // support external sources
                                    var fixedItems = new Array();
                                    var sourcesToReplaceIds = ["myComputer", "device", "fb", "instagram", "flickr"];
                                    var isThisLife = false;
                                    var mixedSources = false;
                                    var firstSource = null;

                                    $.each(items, function(i, item){

                                        // check mixed sources
                                        if(typeof item['source'] !== "undefined"){
                                            if(firstSource === null){
                                                firstSource = item['source'];
                                            } else if(firstSource != item['source']){
                                                mixedSources = true;
                                            }
                                        }

                                        // replace photoIds
                                        if(typeof Shr.U.migrated !== "undefined" && Shr.U.migrated == true) {
                                            if (typeof item['source'] !== "undefined" && sourcesToReplaceIds.indexOf(item['source']) != -1) {
                                                item['id'] = (imageIds[i]).replace("Image:", "");
                                            }
                                        } else {
                                            // check if is this life
                                            if (typeof item['source'] !== "undefined" && item['source'] == "thisLife") {
                                                item['sfly_id'] = that.convertSFLYmPathToId(imageIds[i]);
                                                isThisLife = true;
                                            } else if (typeof item['source'] !== "undefined" && sourcesToReplaceIds.indexOf(item['source']) != -1) {  // for external soruces update the ids with the sfly ids
                                                item['id'] = that.convertSFLYmPathToId(imageIds[i]);
                                            }
                                        }

                                        // fix url
                                        if(typeof item['url'] === "undefined"){
                                            item['url'] = item.getThumbnailUrl().replace("x-large", "medium").replace("fit3600x3600","fit1000x1000");
                                            if(item['url'].indexOf("http:") == -1 && item['url'].indexOf("https:") == -1){
                                                item['url'] = window.location.protocol + item['url'];
                                            }
                                        }

                                        // fix needed data
                                        if(typeof item['origWidth'] === "undefined" && typeof item['width'] !== "undefined"){
                                            item['origWidth'] = item['width'];
                                        }
                                        if(typeof item['origHeight'] === "undefined" && typeof item['height'] !== "undefined"){
                                            item['origHeight'] = item['height'];
                                        }
                                        if(typeof item['dateTaken'] === "undefined" && typeof item['date'] !== "undefined"){
                                            item['dateTaken'] = item['date'] / 1000;
                                        }

                                        // if we have not necessary data set them to null
                                        if(typeof item['data'] !== "undefined"){
                                            item['data'] = null;
                                        }

                                        fixedItems.push(item);
                                    });

                                    var uniqid = String.fromCharCode(65 + Math.floor(Math.random() * 26)) + Date.now();
                                    var groupPhotos = {
                                        'albumId' : uniqid,
                                        'photos' : fixedItems
                                    };

                                    // be sure that we set the real user on ok action
                                    if(typeof Shr.U.uid !== "undefined") {

                                        // set a flag that we switched to the real user if we were the model user
                                        if(cache.get('partner_user_id') == '009085953279') {
                                            cache.set('switched_to_real_user', true);
                                        }

                                        cache.set('partner_user_id', Shr.U.uid);
                                        //cache.set('partner_user_id', Shr.U.uid, true);
                                        cache.set('token', Shr.U.oauthToken);
                                        if (typeof Shr.U.migrated !== "undefined" && Shr.U.migrated) {
                                            cache.set('superfly_user', true);
                                        }
                                    }

                                    onOKCallback(groupPhotos, isThisLife, mixedSources);
                                },
                                onCancel: function(){
                                    onCancelCallback()
                                },
                                onSignin: function(){
                                }
                            };

                            if(cache.get('partner_user_id') == '009085953279' && (typeof Shr.U.uid === "undefined" || Shr.U.uid == '' || Shr.U.uid == '009085953279')){
                                uppOptions['sources'] = utils.isMobile ? { device: { requiresSignin: true } }: { myComputer: { requiresSignin: true } };
                            }

                            Shr.Dialog.zIndex = 6100;
                            Shr.Dialog.show("UniversalPicker", uppOptions);
                        }
                    } else {
                        clearInterval(checkShrLoaded);
                    }
                }, 100); // check every 100ms
            }

            // Load Shr Core library if needed
            if (typeof window.Shr === "undefined") {
                var js = document.createElement("script");
                js.type = "text/javascript";
                if (js.readyState) {
                    js.onreadystatechange = function ()
                    {
                        if (js.readyState == "loaded" || js.readyState == "complete") {
                            delete js.onreadystatechange;
                            Shr.Score.load();
                            Shr.Score.getUserInfo();
                            showUPPwindow();
                        }
                    }
                }
                else {
                    js.onload = function ()
                    {
                        delete js.onload;
                        Shr.Score.load();
                        Shr.Score.getUserInfo();
                        showUPPwindow();
                    }
                }
                var env = cache.get('env') != "prod" ? cache.get('env') + "." : "";
                js.src = 'https://www.' + env + 'shutterfly.com/score/bootstrap.js';
                document.body.appendChild(js);
            } else if (typeof window.Shr.Score !== "undefined"  &&  window.Shr.Score.state != window.Shr.Score.State.loaded) {
                Shr.Score.load();
                Shr.Score.getUserInfo();
                showUPPwindow();
            } else {
                showUPPwindow();
            }

        },

        /**
         * Replace in the ProjectJson the SFLY Id in the Photostrip
         * @param Object groupPhotos
         * @param Array pJson
         * @returns {*}
         */
        replaceIdWithSFLYId: function(groupPhotos, pJson){
            var pType = "noType";
            if(typeof pJson !== "undefined" && typeof pJson[0] !== "undefined"){
                pType = Object.keys(pJson[0])[0];
            }
            $.each(pJson, function (i, singlePJson) {
                if (typeof singlePJson !== "undefined"
                    && typeof singlePJson[pType] !== "undefined"
                    && typeof singlePJson[pType].photoStrip !== "undefined"
                ) {
                    $.each(singlePJson[pType].photoStrip, function (j, photoInStrip) {
                        $.each(groupPhotos.photos, function (k, photoInGroup) {
                            if (photoInStrip.photoId == photoInGroup.id && typeof photoInGroup.sfly_id !== "undefined") {
                                photoInStrip.photoId = photoInGroup.sfly_id;
                            }
                        })
                    });
                }
            });
            return pJson
        },

        /**
         Will get a photosObject and replace it's photo urls to the correct size
         @param Object photosObject
         @return none
         */
        setPhotoSizeForAlbumSwitch: function(photosObject) {
            var TARGET_SIZE = 1000;

            photosObject.photos = photosObject.photos.map(function(photoObj) {
                var url         = photoObj.url;
                var size        = url.substr(url.indexOf('rendersize') + 'rendersize='.length).substr(3); // Remove the 'fit' prefix
                //var sizeParts   = size.split('x');
                var newSize     = [TARGET_SIZE, TARGET_SIZE];
                //var ratio       = 1;

                // roman: Seems this logic breaks the API.
                //if (parseInt(sizeParts[0]) > parseInt(sizeParts[1])) {
                //    ratio   = TARGET_SIZE / sizeParts[0];
                //    newSize = [TARGET_SIZE, Math.round(sizeParts[1] * ratio)];
                //} else if (parseInt(sizeParts[0]) < parseInt(sizeParts[1])) {
                //    ratio   = TARGET_SIZE / sizeParts[1];
                //    newSize = [Math.round(sizeParts[0] * ratio), TARGET_SIZE];
                //}

                photoObj.url = url.substr(0, url.indexOf('rendersize')) + 'rendersize=fit' + newSize.join('x');

                return photoObj;
            });
        },

        removeLoader: function(target) {
            $(target).children('.sfly_wgt_throbber').remove();
        },

        removeOverlay: function(target) {
            $(target).children('.sfly_wgt_throbber_overlay').remove();
        },

        showBackgroundLoading: function(target) {
            $(target).find('.sfly_wgt_bg_throbber').show();
        },

        hideBackgroundLoading: function(target) {
            $(target).find('.sfly_wgt_bg_throbber').hide();
        }
    }
});
/*
A module that defines the click through actions.
 */

define("app/click_through", ['app/cache_module', 'app/templates', 'app/settings', 'app/utils'], function(cache, templates, settings, utils) {
    // var noPhotosProduct = ["mason", "wineglass", "pilsner", "decanter", "glassjar", "trumpet", "growler"];

    /*
    Will return the correct url for adding products
    @return string - url to products
     */
    function getProductsUrl() {
        var env = (typeof cache.get('env') !== 'undefined') ? cache.get('env') : 'beta';
        if (env != 'prod') {
            return '//www.' + env + '.shutterfly.com/orderpictures/start.sfly?cid=';
        } else {
            return '//www.shutterfly.com/orderpictures/start.sfly?cid=';
        }
    }

    function getNxgenUrl() {
        var env = (typeof cache.get('env') !== 'undefined') ? cache.get('env') : 'beta';
        var userId = cache.get('partner_user_id');

        if (env != 'prod') {
            return '//media.' + env + '.shutterfly.com/services/media/' + userId + '/copy/bulk?access_token=' + cache.get('token');
        } else {
            return '//media.shutterfly.com/services/media/' + userId + '/copy/bulk?access_token='+ cache.get('token');
        }
    }

    /*
    Will return a URL for calling the magicshop api to save a JSON
     */
    function getMagicCSUrl() {
        var env    = (typeof cache.get('env') !== 'undefined') ? cache.get('env') : 'beta';
        var url = '//magic.photoccino.com/';
        if (env != 'prod') {
            url = '//' + env + '-magic.photoccino.com/';
        }

        return url + 'SaveProjectJson';
    }

    // Will augment the given projectJson with the ownerId and return it.
    function addOwnerIdToProjectJson(productType, projectJson) {
        var ownerId = cache.get('partner_user_id');
        var newJson = $.extend(true, {}, projectJson);

        if (productType == "prints") {
            _.forEach(newJson.prints.photoStrip, function (photo) {
                photo.photoId = ownerId + ':' + photo.photoId;
            });
        } else if (productType == "book" || productType == "photobook") {
            _.forEach(newJson.book.photoStrip, function (photo) {
                photo.photoId = ownerId + ':' + photo.photoId;
            });
        } else {
            _.forEach(newJson.product.photoStrip, function (photo) {
                photo.photoId = ownerId + ':' + photo.photoId;
            });
        }

        return newJson;
    }

    function getInterceptSourceSuffix(model) {
        var testId='201811';
        var interceptSourceSuffix = "";

        if (model && model.get('instance')) {
            interceptSourceSuffix= window.MAGICCATALOG ? "/MCDelayed" : "/MCPrefetch";
        }
        else {

            //var abTestGroup = MagicShop.abTestGroup;
            var abTestGroup = cache.get('cohort');

            if (abTestGroup === 'GroupA' || abTestGroup === 'Group_A') {
                interceptSourceSuffix = "/" + testId + "_A";
            } else if (abTestGroup === 'GroupB' || abTestGroup === 'Group_B') {
                interceptSourceSuffix = "/" + testId + "_B";
            } else if (abTestGroup === 'GroupC' || abTestGroup === 'Group_C') {
                interceptSourceSuffix = "/" + testId + "_C";
            } else if (abTestGroup === 'GroupD' || abTestGroup === 'Group_D') {
                interceptSourceSuffix = "/" + testId + "_D";
            } else if (abTestGroup === 'GroupE' || abTestGroup === 'Group_E') {
                interceptSourceSuffix = "/" + testId + "_E";
            } else if (abTestGroup === 'control') {
                interceptSourceSuffix = "/" + testId + "_control";
            } else if (abTestGroup === 'badCohort') {
                interceptSourceSuffix = "/" + testId + "_badCohort";
            }
        }

        return interceptSourceSuffix;
    }

    /*
    Will return the correct url to redirect to the creation path. It depends on the product type and the env.
    @productType string     - type of the current product clicked
    @projectJsonId string   - id returned from the WSAPI after successful API call
    @isSeeAll boolean       - true is redirecting to "see all" page, false otherwise
    @return string          - url to redirect to
     */
    function getCreationPathUrl(productType, projectJsonId, isSeeAll, model, sbStyle, sbSize) {
        var url = 'https://www.shutterfly.com/';
        //var url = 'http://beta.shutterfly.com/';
        if (typeof cache.get('env') !== 'undefined' && cache.get('env') != "") {
            if (cache.get('env') != 'prod') {
                url = 'https://www.' + cache.get('env') + '.shutterfly.com/';
            }
        }


        //if (typeof instanceSettings == 'undefined') {
        //    instanceSettings = settings;
        //}
        var interceptSourceSuffix = getInterceptSourceSuffix(model);
        var interceptSource = model.get("interceptSource");

        // TODO: remove this HACK - that fixes autoselect to manualselect (when it's really manual...)
        if (model.get('instance') && model.get('ismanualselect')) {
            interceptSource = interceptSource.replace('/autoselect','/manualselect')
        }

        // If we're using a See All link - we just go to the page of those products
        if (isSeeAll) {
            return url.concat(productType + '?pictureSource=ThisLife&interceptSource=' + interceptSource + interceptSourceSuffix +'&');
        }

        if (isComingFromTP() && interceptSource.indexOf('cross_sell') > -1) {
            interceptSource = interceptSource.replace('cross_sell', 'cross_sell_tp');
        }

        switch (productType) {
            case 'photobook':
            case 'book':
                return url.concat('pb/#/?fromLocation=ThisLife&uid=' + cache.get('partner_user_id') + '&initProjectGUID=' + projectJsonId + '&reportingSrc=' + interceptSource + interceptSourceSuffix  + '&');
            case 'book-style':
                return url.concat('pb/#/?fromLocation=ThisLife&startupTab=style&uid=' + cache.get('partner_user_id') + '&initProjectGUID=' + projectJsonId + '&reportingSrc=' + interceptSource + interceptSourceSuffix  + '&');
            case 'story-book':
                return url.concat('sb/#/?styleId='+sbStyle+'&coverSpecId='+sbSize+'_bk_hard' + '&reportingSrc=' + interceptSource + interceptSourceSuffix  + '&');
            case 'cns':
                return url.concat('cards-stationery' + '?pictureSource=ThisLife&interceptSource=' + interceptSource + interceptSourceSuffix  + '&');
            case 'prints':
                return url.concat('orderpictures/start.sfly?pictureSource=ThisLife&interceptSource=' + interceptSource + interceptSourceSuffix  + '&');
            case 'calendar':
                return url.concat('gc/#/?fromLocation=ThisLife&uid=' + cache.get('partner_user_id') + '&initProjectGUID=' + projectJsonId + '&reportingSrc=' + interceptSource + interceptSourceSuffix  + '&');
            case 'calendar_styles':
                return url.concat('gc/#/?fromLocation=ThisLife&startupTab=style&uid=' + cache.get('partner_user_id') + '&initProjectGUID=' + projectJsonId + '&reportingSrc=' + interceptSource + interceptSourceSuffix  + '&');
            case 'deskcalendar':
                return url.concat('calendar/start.sfly?pictureSource=ThisLife&startupTab=style&projectJSONID=' + projectJsonId + '&interceptSource=' + interceptSource + interceptSourceSuffix  + '&');
            default:
                var useProcSimple = "&useProcSimple=true";
                return url.concat('creationPath/from/auth/magic/' + projectJsonId + '?pictureSource=ThisLife'+useProcSimple+'&interceptSource=' + interceptSource + interceptSourceSuffix  + '&');
        }
    }

    function isComingFromTP(){
        return (
            typeof window.s !== 'undefined' &&
            typeof window.s.eVar55 !== 'undefined' &&
            window.s.eVar55.indexOf('brand=TP') > -1
        )
    }


    /*
    Will show the transfer animation modal
     */

    function showTransferingModal() {
        var tplCompiled = _.template(templates.click_through_modal);

        $('body').append(tplCompiled());
    }

    /*
    Will hide the transfer animation modal
     */
    function hideTransferingModal() {
        $('body').find('.sfly_wgt_modal_wrapper').fadeOut().remove();
    }

    /*
    Will show the transfer animation in the given window handler
    @winHandler - window handler to put the animation in
     */
    function showLoadingInRedirect(winHandler) {
        if (typeof winHandler !== 'undefined' && winHandler != null) {
            var tplCompiled = _.template(templates.click_through_anim);

            winHandler.document.write(tplCompiled());
            return true;
        }

        return false;
    }

    function getSeeAllRedirectWithNoProductJson(productType) {
        var env = (typeof cache.get('env') !== 'undefined') ? cache.get('env') : 'beta';
        var redirect;
        switch(productType) {
            case 'photobook':
            case 'book':
            case 'photobook_share':
                redirect = "https://www{env}.shutterfly.com/photo-books";
                break;
            case 'mug':
            case 'magnet':
            case 'iphone':
            case 'mouse':
            case 'travelmug':
            case 'ipad':
            case 'portable':
            case 'galaxy':
            case 'shoppingbag':
            case 'puzzle':
            case 'waterbottle':
            case 'playingcards':
            case 'photogifts':
                redirect = "https://www{env}.shutterfly.com/photo-gifts";
                break;
            case 'plaque':
            case 'canvas':
            case 'blanket':
            case 'acrylicprint':
            case 'pillow':
            case 'metalwallart':
            case 'wallart':
            case 'quilt':
            case 'curvedglass':
            case 'flatglass':
            case 'acrylicblock':
            case 'woven':
            case 'homedecor':
                redirect = "https://www{env}.shutterfly.com/home-decor";
                break;
            case 'card':
            case 'cns':
                redirect = "https://www{env}.shutterfly.com/cards-stationery";
                break;
            case 'prints':
            case 'prints_share':
            case 'collage':
                redirect = "https://www{env}.shutterfly.com/prints";
                break;
            case 'calendar':
                redirect = "https://www{env}.shutterfly.com/calendars";
                break;
            default:
                redirect = "";
        }

        env         = (env !== 'prod') ? '.' + env : '';
        redirect    = redirect.replace('{env}', env);

        return redirect;
    }
    /*
        Returns the url of the page specified on shutterfly site
    */
    function getRedirectUrl(page) {
        var env = (typeof cache.get('env') !== 'undefined') ? cache.get('env') : 'beta';
        var urlString = "https://www{0}.shutterfly.com/{1}";
        env = (env !== 'prod') ? '.' + env : '';
        return utils.formatString(urlString, env, page);
    }

    /*
    Will check if the photos in the album need to be copied to nxgen.
    After finishing, will call callback.
     */
    function sendToNxgen(album, callback) {
        if (typeof album === 'undefined' || !album.hasOwnProperty('photos')) {
            callback(true);
            return;
        }

        var photosToSend = _.filter(album.photos, function(photo) {
            return photo.shouldCopyToNxgen;
        });

        var photosFormatted = _.map(photosToSend, function(photo) {
            return {
                'userId' : photo.comboId.split(':')[0],
                'mediaId': photo.id
            }
        });

        var createPhotosMap = function(newPhotos) {
            var mapping = {};
            newPhotos.forEach(function(photo) {
                mapping[photo["mediaId"]] = photo["mspPath"].split(':')[1];
            });
            return mapping;
        };

        if (photosFormatted.length > 0) {
            console.log('[Product Widget] Transfering to Nxgen ' + photosFormatted.length + ' photos');

            $.ajax({
                url: getNxgenUrl(),
                type: 'POST',
                crossDomain: true,
                data: JSON.stringify(photosFormatted),
                dataType: 'json',
                contentType: 'application/json',
                success: function(response) {
                    if (_.isFunction(callback)) {
                        callback(createPhotosMap(response));
                    }
                }
            }).fail(function() {
                callback(null);
                console.log('[Product Widget] Failed to transfer to Nxgen');
            });
        } else {
            if (_.isFunction(callback)) {
                callback({});
            }
        }
    }

    function replacePhotoIdsInProjectJson(projectJson, idsMapping) {

        function doReplace(property) {
            projectJson[property].photoStrip.forEach(function (photo)
            {
                if (typeof idsMapping[photo.photoId] !== 'undefined') {
                    photo.photoId = idsMapping[photo.photoId];
                }
            });
        }

        if (projectJson.hasOwnProperty('product')) {
            doReplace('product');
        }

        if (projectJson.hasOwnProperty('book')) {
            doReplace('book');
        }

        return projectJson;
    }

    function replacePhotoIdsInPrints(momentIds, idsMapping) {
        var ids = momentIds.split(',');
        var newIds = [];
        ids.forEach(function(id) {
            if (typeof idsMapping[id] !== 'undefined') {
                newIds.push(idsMapping[id]);
            } else {
                newIds.push(id);
            }
        });

        return newIds.join(',');
    }

    function logClickToAthena(model, productType) {
        model.get('athenaLogger').logProductClick({"productType": productType});
    }

    return {
        /*
        Do the clickthrough submission and redirect the user to the product page.
        @param object projectJson - projectJson to submit for the click through
        @param string productType - the type of the product
        @param function callbackStart - callback before starting
        @param function callbackFinish - callback after finishing
         */
        sendToClickThrough: function(projectJson, productType, callbackStart, callbackFinish, album, winHandler, model, personalizeUrl, sbStyle, sbSize) {

            // if (typeof personalizeUrl !== 'undefined' && noPhotosProduct.indexOf(productType) !== -1) {
            //     var personUrl = personalizeUrl + "&pictureSource=ThisLife&interceptSource=" +model.get("interceptSource");
            //     if (winHandler !== null && typeof winHandler !== 'undefined') {
            //         winHandler.location.href = personUrl;
            //     } else {
            //         window.location.href = personUrl;
            //     }
            //     return;
            // }


            if (_.isFunction(callbackStart)) {
                callbackStart();
            }

            var openedInNewWindow = showLoadingInRedirect(winHandler);

            var url         = getMagicCSUrl();
            var ownerId     = cache.get('partner_user_id');
            var token       = cache.get('token');

            logClickToAthena(model, productType);

            sendToNxgen(album, function(success) {

               function addHeadersBeforeRedirect(CPUrl, mode) {
                   if(mode !== "instance") {
                       $.ajax({
                           method: 'POST',
                           url: CPUrl,
                           beforeSend: function (xhr) {
                               xhr.setRequestHeader("userstate", "LoggedIn");
                               xhr.setRequestHeader("Authorization", "Bearer " + token);
                           }
                       }).done(function () {
                           window.location.href = CPUrl;
                       });
                   } else {
                       window.location.href = CPUrl;
                   }
                }

                if (success !== null) {

                    projectJson = replacePhotoIdsInProjectJson(projectJson, success);

                    var request = {
                        userId: ownerId,
                        token: token,
                        projectJsonStr: JSON.stringify(projectJson)
                    };

                    $.ajax({
                        url: url,
                        type: "POST",
                        crossDomain: true,
                        data: JSON.stringify(request),
                        contentType: "application/x-www-form-urlencoded; charset=UTF-8",
                        dataType: "text",
                        success: function (response)
                        {
                            var resp = JSON.parse(response);
                            var CPUrl = getCreationPathUrl(productType, resp.productId, false, model, sbStyle, sbSize);
                            if (resp.success === 1) {
                                if (openedInNewWindow && winHandler !== null && typeof winHandler !== 'undefined' && !winHandler.closed) {
                                    addHeadersBeforeRedirect(CPUrl, model.get('mode'));
                                    winHandler.focus();
                                    if (_.isFunction(callbackFinish)) {
                                        callbackFinish();
                                    }
                                } else {
                                    window.location = getCreationPathUrl(productType, resp.productId, false, model, sbStyle, sbSize);
                                }
                            }
                            else {
                                console.log('[Products Widget] Error from creation path server');
                            }
                        }
                    }).always(function ()
                    {
                        //hideTransferingModal();
                    }).fail(function ()
                    {
                        if (winHandler != null && typeof winHandler !== 'undefined' && !winHandler.closed) {
                            winHandler.close();

                            if (_.isFunction(callbackFinish)) {
                                callbackFinish();
                            }
                        }
                        console.log('[Products Widget] Failed to transfer to creation path');
                    });
                } else {
                    hideTransferingModal();
                }
            });
        },

        /*
        Will send the moments to a See All action and will redirect to that page, using the given window handler.
        @productType        - the product type clicked on
        @moments            - moment to use for the click through
        @isSeeAll           - is this a "See All" click
        @winHandler         - window handler to use for redirection
        @callbackStart      - A callback to call before starting
        @callbackFinish     - A callback to call after finishing the redirection
         */
        sendForSeeAll: function(moments, callbackStart, callbackFinish, album, winHandler, model, forceSendPrintsParam) {
            var action = 'ADD_TO_ORDER';
            var momentIds = moments.join(',');
            var forceSendPrints = forceSendPrintsParam || false;

            if (_.isFunction(callbackStart)) {
                callbackStart();
            }

            // Send prints only if is Manual or Automatic and not instance mode. Using double NOT for clarity
            var sendPrints = model.get('isManualSelect') || (!model.get('isManualSelect') && model.get('mode') != 'instance') || forceSendPrints;

            // showTransferingModal();
            var openedInNewWindow = showLoadingInRedirect(winHandler);

            logClickToAthena(model, "prints");

            sendToNxgen(album, function(success) {
                if (success != null) {

                    momentIds = replacePhotoIdsInPrints(momentIds, success);

                    // Create a form to simulate a real form submission
                    var cnsForm = document.createElement('form');
                    cnsForm.setAttribute('action', getProductsUrl());
                    cnsForm.setAttribute('method', 'post');
                    cnsForm.setAttribute('style', 'display:none;');
                    var cidField = document.createElement('input');
                    cidField.setAttribute('type', 'text');
                    cidField.setAttribute('name', 'cid');
                    cidField.setAttribute('value', '');
                    var uidField = document.createElement('input');
                    uidField.setAttribute('type', 'text');
                    uidField.setAttribute('name', 'uid');
                    uidField.setAttribute('value', cache.get('partner_user_id'));

                    var printsSizeValue = model.get('printSize') || '4x6';
                    // TODO: @Vadim: ugly patch for server bug

                    if (printsSizeValue != '4x6') {
                        var printSize = document.createElement('input');
                        printSize.setAttribute('type', 'text');
                        printSize.setAttribute('name', 'printSize');
                        printSize.setAttribute('value', printsSizeValue);
                        cnsForm.appendChild(printSize);
                    }


                    var cnsCombs = document.createElement('input');
                    cnsCombs.setAttribute('type','text');
                    cnsCombs.setAttribute('value', sendPrints ? momentIds : '');
                    cnsCombs.setAttribute('name', 'shareIds');
                    var interceptSource = document.createElement("input");
                    interceptSource.setAttribute('type',"text");
                    interceptSource.setAttribute('name',"interceptSource");
                    var interceptSourceSuffix = getInterceptSourceSuffix(model);
                    var interceptSourceValue = model.get("interceptSource") + interceptSourceSuffix;
                    interceptSource.setAttribute('value', interceptSourceValue);
                    //interceptSource.setAttribute('value', "Web/magicshop");
                    cnsForm.appendChild(cnsCombs);
                    cnsForm.appendChild(cidField);
                    cnsForm.appendChild(uidField);
                    cnsForm.appendChild(interceptSource);

                    if (openedInNewWindow && winHandler != null && typeof winHandler !== 'undefined' && !winHandler.closed) {
                        cnsForm.setAttribute('target', winHandler.name);
                    }

                    $(cnsForm).appendTo('body').submit();
                }

                if (_.isFunction(callbackFinish)) {
                    callbackFinish();
                }
            });
        },

        sendForSeeAllGeneric: function(productType, moments, album, winHandler, callbackStart, callbackFinish, model) {
            var action = 'ADD_TO_CREATE';
            var momentIds = moments.join(',');

            if (_.isFunction(callbackStart)) {
                callbackStart();
            }

            //if (typeof instanceSettings == 'undefined') {
            //    instanceSettings = settings;
            //}

            var openedInNewWindow = showLoadingInRedirect(winHandler);

            logClickToAthena(model, productType);

            sendToNxgen(album, function(success) {
                if (success != null) {

                    momentIds = replacePhotoIdsInPrints(momentIds, success);

                    // Create a form to simulate a real form submission
                    var cnsForm = document.createElement('form');
                    cnsForm.setAttribute('action', getProductsUrl());
                    cnsForm.setAttribute('method', 'post');
                    cnsForm.setAttribute('target', 'iframe_cns');
                    cnsForm.setAttribute('style', 'display:none;');
                    var cidField = document.createElement('input');
                    cidField.setAttribute('type', 'text');
                    cidField.setAttribute('name', 'cid');
                    cidField.setAttribute('value', '');
                    var uidField = document.createElement('input');
                    uidField.setAttribute('type', 'text');
                    uidField.setAttribute('name', 'uid');
                    uidField.setAttribute('value', cache.get('partner_user_id'));
                    var cnsCombs = document.createElement('input');
                    cnsCombs.setAttribute('type','text');
                    cnsCombs.setAttribute('value', momentIds);
                    cnsCombs.setAttribute('name', 'shareIds');
                    var interceptSource = document.createElement("input");
                    interceptSource.setAttribute('type',"text");
                    interceptSource.setAttribute('name',"interceptSource");
                    var interceptSourceSuffix = getInterceptSourceSuffix(model);
                    var interceptSourceValue = model.get("interceptSource") + interceptSourceSuffix;
                    interceptSource.setAttribute('value', interceptSourceValue);
                    //interceptSource.setAttribute('value', "Web/magicshop");
                    cnsForm.appendChild(cnsCombs);
                    cnsForm.appendChild(cidField);
                    cnsForm.appendChild(uidField);
                    cnsForm.appendChild(interceptSource);

                    $(cnsForm).appendTo('body').submit();

                    // As the iframe messaging doesn't work - we need to use a timeout.
                    setTimeout(function() {
                        if (openedInNewWindow && winHandler != null && typeof winHandler !== 'undefined' && !winHandler.closed) {
                            if (_.isFunction(callbackFinish)) {
                                callbackFinish();
                            }

                            winHandler.location.href = getSeeAllRedirectWithNoProductJson(productType);
                            winHandler.focus();
                        } else {
                            window.location = getSeeAllRedirectWithNoProductJson(productType);
                        }

                    }, 1000);
                } else {
                    if (_.isFunction(callbackFinish)) {
                        callbackFinish();
                    }
                }
            });
        },

        redirectTo: function(page) {
            window.location = getRedirectUrl(page);
        },

        redirectToProduct: function(productType) {
            window.location = getSeeAllRedirectWithNoProductJson(productType);
        }
    }
});
/*
This module will include the minimal version of the modal window
 */

define('app/view_engine/modals/minimal/modal',
    ['underscore', 'app/templates', 'mgthumb', 'app/asset_mapper', 'app/tracking', 'magicselect', 'app/album_switch', 'app/product_proxy', 'app/view_engine/widgets/common', 'app/config_manager', 'app/view_engine/modals/shared', 'app/click_through'],
    function(_, templates, mgthumb, AssetMapper, tracking, magicselect, albumSwitch, productProxy, view_common, config, modal_common, clickThrough) {

    return function(){
        var CURRENT_OPEN_PAGE       = 0;
        var IS_WIDGET_OPEN          = false;
        var SLIDE_PROD_HEIGHT       = 250;
        var SLIDE_PRINT_HEIGHT      = 290;
        var SLIDE_CAL_HEIGHT        = 230;
        var SLIDE_CAL_12x12_HEIGHT  = 270;
        var SLIDE_CAL_DSK_HEIGHT    = 270;
        var PREV_PROD_PID           = 0;

        var widgetWidth             = 0;
        var widgetHeight            = 0;
        var openWidgetWidth         = 0;
        var horizontalGap           = 0;

        // Call before doing any work
        var init = function () {
            var widgetPosition      = config.getWidgetPosition();

            widgetWidth             = widgetPosition.width;
            widgetHeight            = widgetPosition.height;
            openWidgetWidth         = widgetPosition.openwidth;
            horizontalGap           = widgetPosition.horizontal;
        };

        // GETTER AND SETTER OF PRIVATE PROPRIETIES
        this.getCurrentOpenPage = function(){
            return CURRENT_OPEN_PAGE;
        };

        this.setCurrentOpenPage = function(currentOpenPage){
            CURRENT_OPEN_PAGE = currentOpenPage;
        };

        this.getIsWidgetOpen = function(){
            return IS_WIDGET_OPEN;
        };

        this.setIsWidgetOpen = function(isWidgetOpen){
            IS_WIDGET_OPEN = isWidgetOpen;
        };

        this.getSlideProdHeight = function(){
            return SLIDE_PROD_HEIGHT;
        };

        this.getPrintHeight = function() {
            return SLIDE_PRINT_HEIGHT;
        };

        this.getCalendarHeight = function(calType) {
            if (typeof calType !== 'undefined' && calType == 'deskcalendar') {
                return SLIDE_CAL_DSK_HEIGHT;
            } else if(typeof calType !== 'undefined' && calType == 'calendar12x12') {
                return SLIDE_CAL_12x12_HEIGHT;
            }

            return SLIDE_CAL_HEIGHT;
        };

        this.getOpenWidgetWidth = function(){
            return openWidgetWidth;
        };

        this.removeKeyHandler = function() {
            $('body').off('.pwidget');
        };

        this.closeModalAction = function() {
            var openwinContainer = $('#sfly_wgt_openwin_container');
            openwinContainer
                .animate({ width: '0px' }, 200, function() {
                    $(this).hide();
                    $('.sfly_wgt_product').removeClass('not-selected');
                    view_common.removeLoading($('#sfly_wgt_openwin_container'));
                    modal_common.hideBackgroundLoading($('#sfly_wgt_openwin_container'));
                });
        };

        this.openModalAction = function(pId, content, openCallBack, forcedClose){
            var openwinContainer = $('#sfly_wgt_openwin_container');
            if (openwinContainer.css('display') != 'block' || forcedClose) {
                openwinContainer
                    .html(content)
                    .css('width', '0px')
                    .css('display', 'block')
                    .attr('data-pid', pId)
                    .animate({width: openWidgetWidth + 'px'}, 200, openCallBack);
            } else {
                openwinContainer
                    .html(content);
                openCallBack();
            }
        };

        this.showNotEnoughPhotosPopup = function(closeButtonCallback) {
            $('#sfly_wgt_no_enough_photos_popup').show();
            $('#sfly_wgt_no_enough_photos_button .sfly-wgt-orange-btn-sfly').off().on('click', function() {
                if (_.isFunction(closeButtonCallback)) {
                    closeButtonCallback();
                }
                $('#sfly_wgt_no_enough_photos_popup').hide();
            })
        };

        // Will update the product size by the given targetHeight, maintaing the ratio.
        this.updateProductSizeByContainer = function(elem, containerWidth, containerHeight, pId, productJson) {
            var container           = $(elem).find('.sfly_wgt_product_inner');
            var canvas              = container.children('canvas');
            var size                = view_common.getProductRealSize(productJson, pId);
            var ratioWidth          = containerWidth / size.width;
            var ratioHeight         = containerHeight / size.realHeight;
            var ratio               = Math.min(ratioWidth, ratioHeight);
            var targetRealHeight    = size.height * ratio;
            var targetRealWidth     = size.origWidth * ratio;
            var prodTop             = size.top*ratio;
            var prodBottom          = size.bottom*ratio;
            var prodLeft            = size.left*ratio;
            var prodRight           = size.right*ratio;
            var prodWidth           = size.width*ratio;
            var prodHeight          = size.realHeight*ratio;

            var marginTop  = (containerHeight - size.height*ratio)/2   + ((size.top + size.bottom)/2 -size.top )*ratio;
            var marginLeft = (containerWidth - size.origWidth*ratio)/2 + ((size.left + size.right)/2 -size.left)*ratio;

            var imageWidth = size.origWidth*ratio;
            var imageHeight = size.height*ratio;


            container
                .height(imageHeight)
                .width(imageWidth)
                .css('margin-top',  parseInt(marginTop) + 'px')
                // .css('margin-left', parseInt(marginLeft) + 'px')
                .attr('data-height',        targetRealHeight)
                .attr('data-width',         targetRealWidth)
                .attr('data-top',           prodTop)
                .attr('data-bottom',        prodBottom)
                .attr('data-left',          prodLeft)
                .attr('data-right',         prodRight)
                .attr('data-prod-width',    prodWidth)
                .attr('data-prod-height',   prodHeight);

            // container.parent().width(containerWidth);
            return targetRealWidth;
        };

        // Will update the product size by the given targetHeight, maintaing the ratio.
        this.updateProductSizeByHeight = function(elem, targetHeight, pId, productJson, isFullView) {
            var container           = $(elem).find('.sfly_wgt_product_inner');
            var canvas              = container.children('canvas');
            var size                = view_common.getProductRealSize(productJson, pId);
            var ratio               = targetHeight / size.realHeight;
            var targetRealHeight    = targetHeight + (size.bottom + size.top) * ratio;
            var targetRealWidth     = size.origWidth * ratio;
            var prodTop             = size.top * ratio;
            var prodBottom          = size.bottom * ratio;
            var prodLeft            = size.left * ratio;
            var prodRight           = size.right * ratio;
            var prodOrigWidth       = size.width * ratio;

            var product = view_common.getProduct(pId);

            if (product.type == 'photobook') {
                var prodSize = pId.split('_')[1];
                var sizes = config.getProductSizes()['photobook'][prodSize + '_sprite']; // Get the full spread size

                targetRealWidth = sizes.width * ratio; // Zoom the width with same ratio as height
                prodTop         = sizes.top*ratio;
                prodBottom      = sizes.bottom*ratio;
                prodLeft        = sizes.left*ratio;
                prodRight       = sizes.right*ratio;
                prodOrigWidth   = (sizes.width - sizes.left - sizes.right)*ratio;
            }

            container
                .height(targetRealHeight)
                .width(targetRealWidth)
                .attr('data-height',        targetRealHeight)
                .attr('data-width',         targetRealWidth)
                .attr('data-real-height',   targetHeight)
                .attr('data-real-width',    size.origWidth * ratio)
                .attr('data-orig-width',    prodOrigWidth)
                .attr('data-top-size',      prodTop)
                .attr('data-bottom',        prodBottom)
                .attr('data-left',          prodLeft)
                .attr('data-right',         prodRight);

            return targetRealWidth;
        };

        // Will position the little arrow that shows the currently selected book
        this.positionSelectedArrow = function(pId) {
            var selectedProduct     = $(this.Model.get('container')).find('.sfly_wgt_product[data-pid="' + pId + '"]');
            var ProductCenter       = selectedProduct.position().top + Math.floor($(selectedProduct).height()/2);
            var prevProductCenter   = 10;

            if (PREV_PROD_PID !== null) {
                var prevProduct    = $(this.Model.get('container')).find('.sfly_wgt_product[data-pid="' + PREV_PROD_PID + '"]');
                // This is a fix for books. When a style is chosen the PREV_PROD_PID will be that style, though it will not be found
                if (prevProduct.length > 0) {
                    prevProductCenter = prevProduct.position().top + Math.floor($(selectedProduct).height() / 2);
                }
            }

            $('#sfly_wgt_openwin_container').find('.sfly_wgt_arrow_book').css('top', prevProductCenter+'px').animate({ top: ProductCenter }, 500);
        };

        // Will handle the functionalities of the window
        this.showProductsWindowFeatures = function(pId, album, albums, prodStyles, prodOptions, forceCloseExternal, takeLockCallback, releaseLockCallback, closeButtonCallback, changeOpenStatusCallback, handleCurrentPidCallback, viewDisableCallback, productCallBack) {

            var forceClose = IS_WIDGET_OPEN;
            var self = this;

            if (typeof forceCloseExternal !== 'undefined' && forceCloseExternal) {
                forceClose = true;
            } else if (handleCurrentPidCallback() != pId) {
                // Clicked on another book, Just replace the contents and don't close
                modal_common.hideBackgroundLoading($('#sfly_wgt_openwin_container'));
                view_common.showLoading($('#sfly_wgt_openwin_container'));
                forceClose = false;
            }

            if (forceClose) {
                // Close the button
                var btn = $('.sfly-wgt-btn-sidemodule');
                closeButtonCallback(btn, 'wgt_force_close');

                // Close the window
                changeOpenStatusCallback(false, self.closeModalAction);

                // All animations take 200ms - for the state to propogate it will take 200+ms. We want to wait for the status to propogate.
                setTimeout(releaseLockCallback, 200);
                $('#sfly-wgt-background-overlay').off().remove();

                self.removeKeyHandler();

                return;
            }

            // Show the background
            $('#sfly-wgt-background-overlay').off().remove();
            $('body').append('<div id="sfly-wgt-background-overlay"></div>');
            $('#sfly-wgt-background-overlay').on('click', function() {
                // Close the button
                var btn = $('.sfly-wgt-btn-sidemodule');
                closeButtonCallback(btn, 'wgt_force_close');

                // Close the window
                changeOpenStatusCallback(false, self.closeModalAction);

                // All animations take 200ms - for the state to propogate it will take 200+ms. We want to wait for the status to propogate.
                setTimeout(releaseLockCallback, 200);
                $('#sfly-wgt-background-overlay').off().remove();

                self.removeKeyHandler();
            });
            productCallBack(forceClose);
        };

        // this is the main function for show a product modal (has to be override in each product modal)
        this.showProductsWindow = function(pId, album, albums, prodStyles, prodOptions, forceCloseExternal, takeLockCallback, releaseLockCallback, closeButtonCallback, changeOpenStatusCallback, handleCurrentPidCallback) {
            throw 'modal minimal not implemented.';
        };

        this.show = function(params) {
            init();
            IS_WIDGET_OPEN  = params.widgetIsOpen;
            PREV_PROD_PID   = params.currPid;
            this.Model      = params.model;
            this.showProductsWindow(params.pId, params.currAlbum, params.albums, params.prodStyles, params.prodOptions, params.forceCloseExternal, modal_common.callbackWrapper(params.callbacks.takeLock), modal_common.callbackWrapper(params.callbacks.releaseLock), modal_common.callbackWrapper(params.callbacks.animateControlButton), modal_common.callbackWrapper(params.callbacks.changeState), modal_common.callbackWrapper(params.callbacks.handleCurrentPid), modal_common.callbackWrapper(params.callbacks.toggleViewDisable));
        };

        this.close = function(forceCloseExternal, widgetIsOpen, callbacks) {
            init();
            this.removeKeyHandler();
            $('#sfly-wgt-background-overlay').off().remove();
            IS_WIDGET_OPEN = widgetIsOpen;
            this.showProductsWindowFeatures(null, null, null, null, null, forceCloseExternal, modal_common.callbackWrapper(callbacks.takeLock), modal_common.callbackWrapper(callbacks.releaseLock), modal_common.callbackWrapper(callbacks.animateControlButton), modal_common.callbackWrapper(callbacks.changeState), modal_common.callbackWrapper(callbacks.handleCurrentPid));
        };
    };
});
/*
 This module will include the minimal version of the modal window for photobook
 */

define('app/view_engine/modals/minimal/modal_photobook',
    ['underscore', 'app/templates', 'mgthumb', 'app/asset_mapper', 'app/tracking', 'magicselect', 'app/album_switch', 'app/product_proxy', 'app/view_engine/widgets/common', 'app/config_manager', 'app/view_engine/modals/shared', 'app/click_through', 'app/view_engine/modals/minimal/modal', 'app/thumbgen_wrapper', 'app/time_monitor', 'app/cache_module'],
    function(_, templates, mgthumb, AssetMapper, tracking, magicselect, albumSwitch, productProxy, view_common, config, modal_common, clickThrough, modal, thumbGenWrapper, monitor, cache) {

        // Will render all pages for a book in the given container
        var renderBookAndPrints = function(pId, productType, container, mgThumbGen, productJson, pageToShow, self, renderCallBack, wrapCoverCallback) {

            if (typeof pageToShow === 'undefined') {
                pageToShow = 0;
            }

            // We need this function to keep the right order inside the generate function
            function _generate(order, showBookCallBack) {
                // Check if page already generated
                if ($(container).children('canvas[data-order="' + order + '"]').length > 0) {
                    showBookCallBack();
                    return;
                }

                mgThumbGen.generate(parseInt(order), pId, true, function(canvas) {
                    $(canvas).attr('data-order', order).hide();
                    $(container).append(canvas);

                    if (order == 0 && _.isFunction(wrapCoverCallback)) {
                        wrapCoverCallback();
                    }

                    if (pageToShow == order || self.getCurrentOpenPage() == order) {
                        $(container).find('canvas').hide();
                        $(canvas).show();
                    }
                    showBookCallBack();
                }, true);
            }

            if (!$(container).attr('data-rendered')) {
                // Put this first - to block more attempts to render
                $(container).attr('data-rendered', true);

                var product = view_common.findProjectJsonProduct(productJson, pId);
                var numOfPages;
                if (productType == "book") {
                    numOfPages = Math.floor((product.book.pages.length) / 2) + 2;
                } else {
                    numOfPages = parseInt(product.prints.pages.length);
                }

                $(container).attr('data-pages', numOfPages);

                var numRenderedPages = 0;
                var PAGES_TO_GENERATE_IN_QUEUE = 5;
                var showBook = function(){
                    numRenderedPages++;
                    if(numRenderedPages == numOfPages){
                        renderCallBack();
                    } else if(numRenderedPages < numOfPages) {
                        showGenerate(numRenderedPages + PAGES_TO_GENERATE_IN_QUEUE - 1);
                    }
                };

                function showGenerate(i) {
                    if(i == pageToShow){
                        showBook();
                        return;
                    }
                    if(i <= numOfPages-1) {
                        _generate((i == numOfPages-1 && productType == "book") ? 99 : i, showBook);
                    }
                }

                for(var j=0; j<PAGES_TO_GENERATE_IN_QUEUE; j++){
                    showGenerate(j);
                }
            }
        };

        // Render the navigation template for the calendar product
        var renderBookAndPrintsNavigation = function(pId, productType, container, productJson, position, pageToShow) {
            var MAX_BOOK_NAV    = 400;
            var MAX_BOOK_BOX    = 40;
            var MAX_PRINTS_NAV  = 230;
            var MAX_PRINTS_BOX  = 30;
            var MIN_PAGES       = 5;

            if (typeof pageToShow === 'undefined') {
                pageToShow = -1;
            }

            if ($(container).find('.sfly-wgt-book-nav').length == 0) {
                var product = view_common.findProjectJsonProduct(productJson, pId);
                var numOfPages;
                if (productType == "book") {
                    numOfPages = Math.floor((product.book.pages.length) / 2) + 2;
                } else {
                    numOfPages = parseInt(product.prints.pages.length);
                }

                // Calculate the boxes size
                var boxSize;
                if (productType == "book") {
                    boxSize = MAX_BOOK_NAV / numOfPages > MAX_BOOK_BOX ? MAX_BOOK_BOX : MAX_BOOK_NAV / numOfPages;
                } else {
                    boxSize = MAX_PRINTS_NAV / numOfPages > MAX_PRINTS_BOX ? MAX_PRINTS_BOX : MAX_PRINTS_NAV / numOfPages;
                }

                var display = 'block';
                var nav     = view_common.renderTemplate(templates.book_nav, { pages: numOfPages, type: productType, currPage: pageToShow });
                var paging  = view_common.renderTemplate(templates.side_book_paging, { pages: numOfPages });
                $(container).append(paging).append(nav);

                var totalspace = boxSize*(numOfPages - 1) + 61;
                var leftFix = totalspace / 2;

                $(container).find('.sfly-wgt-book-nav')
                    .css('left', (position.left - leftFix)+'px')
                    .css('top', (position.top + 35)+'px')
                    .css('width', totalspace +'px')
                    .attr('data-width', totalspace)
                    .attr('data-show-nav', display == 'block' ? 'true' : 'false')
                    .find('li > div').css('width', boxSize + 'px');

                $(container).find('.sfly-wgt-book-paging')
                    .css('top', (position.top + 50)+'px')
                    .css('left', (position.left - 56) + 'px'); // width = 112px

                // Add a new pricing for the navigation
                /*
                var prod            = view_common.getProduct(pId);
                var noPagesInPrice  = prod.type == 'calendar' || prod.type == 'cns';
                var navPrice        = view_common.renderTemplate(templates.prod_price_nav, { title: prod['title'], price: config.getPrice(prod['sfly_sku']), pages: productType == "book" ? numOfPages*2 : numOfPages, noPages: noPagesInPrice, ptype: prod.type});
                $(container).append(navPrice);

                var navPriceWidth = leftFix*2 < 250 ? 250 : leftFix*2; // If we have a very small book (3-4 pages) the nav bar is too small. This is a fix for the price display

                $(container).find('.sfly_wgt_product_price_nav')
                    .css('position', 'absolute')
                    .css('left', (position.left - navPriceWidth/2)+'px')
                    .css('top', (position.top+13)+'px')
                    .css('width', navPriceWidth+'px')
                    .css('display', 'none')
                    .attr('data-width', navPriceWidth);
                    */
            }
        };

        // Slide the book window into view and render the view
        var openSlideAndRenderBook = function(pId, productJson, prodStyles, forcedClose, loadedAlbums, currAlbum, takeLockCallback, releaseLockCallback, buttonCloseCallback, changeOpenStatusCallback, handleCurrentPidCallback, viewDisableCallback, self) {

            // Will render book styles
            function getPhotobookRender(pId, productJson, callback) {
                var prod = view_common.getProduct(pId);

                var elem = $(view_common.renderTemplate(templates.side_style_product, { pid: pId, sku: prod['sflySku'], ptype: 'book', title: prod["styleName"] }));
                var wrapper = $('<div class="sfly-wgt-prod-style"></div>');
                elem.children('.sfly_wgt_product_inner').html('<img src="' + prod['static'] + '" class="sfly-img-spread" />');
                elem.css('width', '100px');
                wrapper.html(elem);

                if (_.isFunction(callback)) {
                    callback(wrapper);
                }
            }

            function renderThumb(pId, useCurrentPage, callbackOnFinish, productType, partnerId, product, layoutJson, designJson, layoutMasks) {
                var useCDN = cache.get('env') != 'beta' && cache.get('env') != 'dev';
                var mgThumbGen  = new MgThumbGenerator(cache.get('env'),useCDN);

                mgThumbGen.init(productType, partnerId, product, layoutJson, designJson, self.Model.get('monitoring').reportEvent, cache.get('env'));

                var currPage = useCurrentPage ? self.getCurrentOpenPage() : 0;
                mgThumbGen.generate(currPage, pId, true, function(canvas) {
                    var elem = $(view_common.renderTemplate(templates.fullview_product, { pid: pId, sku: view_common.getProduct(pId)['sflySku'], ptype: productType }));
                    $(canvas).attr('data-order', currPage);
                    elem.children('.sfly_wgt_product_inner').html(canvas);
                    $(sideopen).find('#sfly_wgt_sideopen_products').html(elem);

                    var pTargetSize = self.updateProductSizeByHeight(elem, self.getSlideProdHeight(), pId, productJson);

                    // Center the product
                    var bookWidth = elem.children('.sfly_wgt_product_inner').attr('data-width');
                    var hostWidth = $(sideopen).parent().width();
                    var bookLeftPos = Math.floor(hostWidth/2) - Math.floor(bookWidth/2);
                    $(sideopen).find('#sfly_wgt_sideopen_products').css('left', bookLeftPos+'px');

                    var wrapped = false;
                    var wrapCoverAndCenter = function(){
                        if (!wrapped) {
                            var widthCover = elem.children('.sfly_wgt_product_inner').attr('data-real-width');
                            var heightCover = elem.children('.sfly_wgt_product_inner').attr('data-height');
                            var coverLeft = pTargetSize / 2 - widthCover / 2 - 37; // The 20px is a temp fix for aligning the cover
                            elem.children('.sfly_wgt_product_inner').find("canvas[data-order='0']").wrap('<div class="sfly-wgt-book-cover-wrapper" style="width:' + widthCover + 'px;height:' + heightCover + 'px;overflow:hidden;position:absolute;top:0;left:' + coverLeft + 'px;" data-width="' + widthCover + '" data-height="' + heightCover + '"></div>');
                            wrapped = true;
                        }
                    };

                    if (currPage == 0 && productType == "book") {
                        wrapCoverAndCenter();
                    }

                    var showBookRendered = function(){
                        wrapCoverAndCenter();
                        $(sideopen).find('#sfly_wgt_sideopen_products').show();
                        if (_.isFunction(callbackOnFinish)) {
                            callbackOnFinish();
                        }
                    };

                    renderBookAndPrints(pId, 'book', elem.children('.sfly_wgt_product_inner'), mgThumbGen, productJson, currPage, self, showBookRendered, wrapCoverAndCenter);
                    renderBookAndPrintsNavigation(pId, 'book', $(sideopen).find('#sfly_wgt_sideopen_products'), productJson, { left: pTargetSize/2, top: self.getSlideProdHeight() }, useCurrentPage ? self.getCurrentOpenPage() : -1);

                    if (!useCurrentPage) {
                        self.setCurrentOpenPage(0);
                    } else {
                        var bookPages = Math.floor((product.book.pages.length-1)/2) + 2;
                        modal_common.setPagesCount(sideopen, self.getCurrentOpenPage(), bookPages);
                    }

                    modal_common.setArrowPagingClass(sideopen, self.getCurrentOpenPage(), 99);
                    view_common.removeLoading($('#sfly_wgt_openwin_container'));
                    modal_common.showBackgroundLoading($('#sfly_wgt_openwin_container'));

                    var isClickAfterDrag = false;

                    var sflySku = view_common.getProduct(pId)['sflySku'];

                    $('#sfly_wgt_sideopen_products').on('mousemove', function(event) {
                        var inner           = $(this).find('.sfly_wgt_product_inner');
                        var innerPosition   = inner.position();
                        var clickRange     = {
                            left: parseInt(innerPosition.left) + parseInt(inner.attr('data-left')),
                            right: parseInt(innerPosition.left) + parseInt(inner.attr('data-left')) + parseInt(inner.attr('data-orig-width')),
                            top: parseInt(innerPosition.top) + parseInt(inner.attr('data-top-size')),
                            bottom: parseInt(innerPosition.top) + parseInt(inner.attr('data-top-size')) + parseInt(inner.attr('data-real-height')) + 15
                        };

                        // Calc real position
                        var targetPos       = $(event.currentTarget).offset();
                        var mousePos        = { top: event.pageY, left: event.pageX };
                        var realPos         = { top: mousePos.top - targetPos.top, left: mousePos.left - targetPos.left };

                        if (realPos.left >= clickRange.left && realPos.left <= clickRange.right && realPos.top >= clickRange.top && realPos.top <= clickRange.bottom) {
                            $(this).css('cursor', 'pointer');
                        } else {
                            $(this).css('cursor', 'default');
                        }
                    })
                        .on('mouseenter', function() {
                            var prodJson = view_common.getProduct(handleCurrentPidCallback());
                        })
                        .off('click').on('click', function(event) {
                            if ($(event.target).hasClass('sfly-wgt-arrow') || $(event.target).hasClass('sfly-wgt-book-paging') || $(event.target).hasClass('sfly-wgt-page-curr-right') || $(event.target).hasClass('sfly-wgt-page-curr-left') || $(event.target).hasClass('sfly-wgt-pages') ) {
                                return;
                            }

                            var inner           = $(this).find('.sfly_wgt_product_inner');
                            var innerPosition   = inner.position();

                            var clickRange     = {
                                left: parseInt(innerPosition.left) + parseInt(inner.attr('data-left')),
                                right: parseInt(innerPosition.left) + parseInt(inner.attr('data-left')) + parseInt(inner.attr('data-orig-width')),
                                top: parseInt(innerPosition.top) + parseInt(inner.attr('data-top-size')),
                                bottom: parseInt(innerPosition.top) + parseInt(inner.attr('data-top-size')) + parseInt(inner.attr('data-real-height')) + 15
                            };

                            // Calc real position
                            var targetPos       = $(event.currentTarget).offset();
                            var mousePos        = { top: event.pageY, left: event.pageX };
                            var realPos         = { top: mousePos.top - targetPos.top, left: mousePos.left - targetPos.left };
                            var center          = (clickRange.left + clickRange.right) / 2;

                            if (realPos.left >= clickRange.left && realPos.left <= clickRange.right && realPos.top >= clickRange.top && realPos.top <= clickRange.bottom && !isClickAfterDrag) {
                                var nextPage    = self.getCurrentOpenPage() + (realPos.left < center ? (-1) : 1);
                                var totalPages  = Math.floor((product.book.pages.length-1)/2) + 2; // +1 for the cover

                                tracking.track('open', 'flip_book', { sku: sflySku, page: self.getCurrentOpenPage() });

                                if (nextPage < 0) {
                                    nextPage = 0;
                                } else if (nextPage == 98) {
                                    nextPage = totalPages-2;
                                } else if (nextPage >= totalPages-1) {
                                    nextPage = 99;
                                }

                                $(sideopen).find('canvas').hide();
                                $(sideopen).find('canvas[data-order=' + nextPage + ']').show();

                                $(sideopen).find('.sfly-wgt-book-nav li').removeClass('wgt-nav-selected');
                                $(sideopen).find('.sfly-wgt-page_' + nextPage).addClass('wgt-nav-selected');

                                self.setCurrentOpenPage(nextPage);

                                modal_common.setPagesCount(sideopen, nextPage, totalPages);
                                modal_common.setArrowPagingClass(sideopen, nextPage, 99);

                                /*
                                 var product = view_common.findProjectJsonProduct(productJson, handleCurrentPidCallback());
                                 clickThrough.sendToClickThrough(product, 'book');

                                 var prodJson = view_common.getProduct(handleCurrentPidCallback());
                                 tracking.track('open', 'personalize', {
                                 sku: prodJson.sfly_sku,
                                 page: self.getCurrentOpenPage()
                                 });
                                 */
                            }
                        });

                    $(sideopen).find('.sfly-wgt-arrow').on('mousedown', function() {
                        // This will prevent a selection on double click. why? no idea...
                        return false;
                    });

                    // todo: remove the duplicate code from arrow/key navigation

                    $(sideopen).find('.sfly-wgt-arrow').on('click', function() {
                        var dir         = $(this).attr('data-dir');
                        var totalPages  = Math.floor((product.book.pages.length-1)/2) + 2; // +1 for the cover
                        var currPage    = self.getCurrentOpenPage();
                        var nextPage    = dir == 'left' ? currPage -= 1 : currPage += 1;

                        tracking.track('open', 'flip_book', { sku: sflySku, page: currPage });

                        // don't allow to move too left or too right
                        if (nextPage < 0) {
                            nextPage = 0;
                        } else if (nextPage == 98) {
                            nextPage = totalPages-2;
                        } else if (nextPage >= totalPages-1) {
                            nextPage = 99;
                        }

                        if (isNaN(nextPage)) {
                            nextPage = 0;
                        }

                        $(sideopen).find('canvas').hide();
                        $(sideopen).find('canvas[data-order=' + nextPage + ']').show();

                        $(sideopen).find('.sfly-wgt-book-nav li').removeClass('wgt-nav-selected');
                        $(sideopen).find('.sfly-wgt-page_' + nextPage).addClass('wgt-nav-selected');

                        self.setCurrentOpenPage(nextPage);

                        modal_common.setPagesCount(sideopen, nextPage, totalPages);
                        modal_common.setArrowPagingClass(sideopen, nextPage, 99);
                    });

                    $('body').off('.pwidget').on('keydown.pwidget', function(e) {
                        e.preventDefault();

                        var nextPage    = self.getCurrentOpenPage();
                        var totalPages  = Math.floor((product.book.pages.length-1)/2) + 2; // +1 for the cover

                        switch(e.keyCode) {
                            case 37: //left
                                nextPage -= 1;
                                break;
                            case 39: //right
                            case 32: //space
                                nextPage += 1;
                                break;
                        }

                        if (isNaN(nextPage)) {
                            nextPage = 0;
                        }

                        if (nextPage < 0) {
                            nextPage = 0;
                        } else if (nextPage == 98) {
                            nextPage = totalPages-2;
                        } else if (nextPage >= totalPages-1) {
                            nextPage = 99;
                        }

                        tracking.track('open', 'flip_book', { sku: sflySku, page: self.getCurrentOpenPage() });

                        $(sideopen).find('canvas').hide();
                        $(sideopen).find('canvas[data-order=' + nextPage + ']').show();

                        $(sideopen).find('.sfly-wgt-book-nav li').removeClass('wgt-nav-selected');
                        $(sideopen).find('.sfly-wgt-page_' + nextPage).addClass('wgt-nav-selected');

                        self.setCurrentOpenPage(nextPage);

                        modal_common.setPagesCount(sideopen, nextPage, totalPages);
                        modal_common.setArrowPagingClass(sideopen, nextPage, 99);
                    });

                    $(sideopen).find('.sfly-wgt-book-nav li')
                        .on('mousedown', function() {
                            if(!$(this).hasClass('wgt-nav-selected')){
                                return;
                            }

                            isClickAfterDrag = true;
                            $(this).parent().addClass('draggable');

                            $('#sfly_wgt_openwin_container')
                                .on('mousemove', function(event){

                                    $(this).css('cursor','pointer');

                                    var elem        = $(this).find('.sfly_wgt_product_inner');
                                    var pages       = elem.attr('data-pages');
                                    var navPosition = $(this).find('.sfly-wgt-book-nav').position();
                                    var navPosRange = { left: navPosition.left, right: navPosition.left + $(this).find('.sfly-wgt-book-nav').width() };

                                    // Calc real position
                                    var targetPos   = $(event.currentTarget).offset();
                                    var mousePos    = { top: event.pageY, left: event.pageX };
                                    var realPos     = { top: mousePos.top - targetPos.top, left: mousePos.left - targetPos.left - ($(this).width() - elem.width())/2 };

                                    var currPage;
                                    var canNavigate = $(this).find('#sfly_wgt_sideopen_products').children('.sfly-wgt-book-nav').attr('data-show-nav') == 'true';

                                    if (!canNavigate) {
                                        return;
                                    }

                                    var navWidth    = $(this).find('#sfly_wgt_sideopen_products').children('.sfly-wgt-book-nav').attr('data-width');
                                    var navStart    = navPosRange.left;
                                    var navEnd      = navPosRange.right;

                                    if (realPos.left < navStart || realPos.left > navEnd) {
                                        return;
                                    }
                                    if (realPos.left < navStart) {
                                        currPage = 0;
                                    } else if (realPos.left > navEnd) {
                                        currPage = 99;
                                    } else {
                                        currPage = Math.floor((realPos.left-navStart) * pages / navWidth);
                                        if (currPage >= pages-1) // Last page in book is 99
                                            currPage = 99;
                                    }

                                    tracking.track('open', 'flip_book', { sku: sflySku, page: self.getCurrentOpenPage() });

                                    $(sideopen).find('canvas').hide();
                                    $(sideopen).find('canvas[data-order=' + currPage + ']').show();

                                    $(sideopen).find('.sfly-wgt-book-nav li').removeClass('wgt-nav-selected');
                                    $(sideopen).find('.sfly-wgt-page_' + currPage).addClass('wgt-nav-selected');

                                    self.setCurrentOpenPage(currPage);

                                    var totalPages  = Math.floor((product.book.pages.length-1)/2) + 2; // +1 for the cover
                                    modal_common.setPagesCount(sideopen, currPage, totalPages);
                                    modal_common.setArrowPagingClass(sideopen, currPage, 99);
                                })
                                .on('mouseup', function(){
                                    $(this).css('cursor','default');
                                    $(this).off('mousemove');
                                    $('.draggable').removeClass('draggable');
                                    setTimeout(function(){isClickAfterDrag = false;}, 200);
                                });
                        })
                        .on('click', function(){
                            if($(this).hasClass('wgt-nav-selected')){
                                return;
                            }
                            var totalPages  = Math.floor((product.book.pages.length-1)/2) + 2; // +1 for the cover
                            var nextPage    = parseInt($(this).attr('class').replace("sfly-wgt-page_","").trim());

                            // don't allow to move too left or too right
                            if (nextPage < 0) {
                                nextPage = 0;
                            } else if (nextPage == 98) {
                                nextPage = totalPages-2;
                            } else if (nextPage >= totalPages-1) {
                                nextPage = 99;
                            }

                            if (isNaN(nextPage)) {
                                nextPage = 0;
                            }

                            tracking.track('open', 'flip_book', { sku: sflySku, page: self.getCurrentOpenPage() });

                            $(sideopen).find('canvas').hide();
                            $(sideopen).find('canvas[data-order=' + nextPage + ']').show();

                            $(sideopen).find('.sfly-wgt-book-nav li').removeClass('wgt-nav-selected');
                            $(sideopen).find('.sfly-wgt-page_' + nextPage).addClass('wgt-nav-selected');

                            self.setCurrentOpenPage(nextPage);

                            modal_common.setPagesCount(sideopen, nextPage, totalPages);
                            modal_common.setArrowPagingClass(sideopen, nextPage, 99);
                        });
                }, true, { masks: layoutMasks });
            }

            // Will render the main book
            function renderBook(pId, productJson, useCurrentPage, callbackOnFinish) {
                var product     = view_common.findProjectJsonProduct(productJson, pId);
                var productType = AssetMapper.GetProductType(product);
                var partnerId   = AssetMapper.GetPartnerId(product, productType);
                useCurrentPage  = (typeof useCurrentPage !== 'undefined' && useCurrentPage == true);
                var prodSku     = view_common.getProduct(pId)['style'] + '_' + view_common.getProduct(pId)['size'];

                thumbGenWrapper.prepareThumbGenAssets(prodSku, pId, 'medium', productType, product, function (result)
                {
                    if (result == null || typeof result.layoutJson === 'undefined' || typeof result.designJson === 'undefined') {
                        console.log('[Product Widget] missing layout / design json');
                        return;
                    }

                    var layoutJson = JSON.stringify(result.layoutJson[pId]);
                    var designJson = JSON.stringify(result.designJson);

                    //renderThumb(pId, productType, partnerId, product, layoutJson, designJson, result.layoutMasks);
                    renderThumb(pId, useCurrentPage, callbackOnFinish, productType, partnerId, product, layoutJson, designJson, result.layoutMasks);
                });

                //renderThumb(pId, useCurrentPage, callbackOnFinish, productType, partnerId, product, layoutJson, designJson);

                handleCurrentPidCallback(pId);
            }

            function updateWindowTitle(productJson, prodId) {
                var product         = view_common.findProjectJsonProduct(productJson, prodId);
                var pages           = product.book.pages.length - 1;
                var origProduct     = view_common.getProduct(prodId);
                var title           = pages + ' Pages, ' + origProduct['title'];
                $('#sfly_wgt_openwin_container #sfly_wgt_sideopen_title h3').html(title);
            }

            // Will stop loading, release the global lock and show the product styles.
            function releaseLockAndStopLoading(isAfterAlbumSwitch) {
                modal_common.hideBackgroundLoading($('#sfly_wgt_openwin_container'));
                view_common.showLoading($('#sfly_wgt_openwin_container'));

                if (typeof isAfterAlbumSwitch === 'undefined') {
                    isAfterAlbumSwitch = false;
                }
                releaseLockCallback();

                view_common.removeLoading($('#sfly_wgt_container')); // remove from the side widget

                $(self.Model.get('container')).find('.sfly_wgt_product[data-pid="' + pId + '"]').removeClass('not-selected');
                self.positionSelectedArrow(pId);

                self.setIsWidgetOpen(true);

                renderBook(handleCurrentPidCallback(), productJson, false, function() {
                    view_common.removeLoading($('#sfly_wgt_openwin_container'));
                    modal_common.showBackgroundLoading($('#sfly_wgt_openwin_container'));
                });

                if (isAfterAlbumSwitch) {
                    updateWindowTitle(productJson, handleCurrentPidCallback());
                }

                // Render the styles at the bottom
                $('#sfly_wgt_openwin_container #sfly_wgt_sideopen_styles').empty();
                _.each(prodStyles, function (style) {
                    getPhotobookRender(style, productJson, function (styleRender) {
                        if (style == handleCurrentPidCallback()) {
                            $(styleRender).addClass('sfly-bookstyle-selected');
                        }
                        $('#sfly_wgt_openwin_container').find('#sfly_wgt_sideopen_styles[data-pid="' + pId + '"]').append(styleRender);
                        $(styleRender).children('.sfly_wgt_product').on('click', function () {
                            var prodId = $(this).attr('data-pid');
                            // Same style. Do nothing.
                            if (prodId == handleCurrentPidCallback()) {
                                return;
                            }

                            tracking.track('open', 'change_style', {sku: $(this).attr('data-sku')});

                            modal_common.hideBackgroundLoading($('#sfly_wgt_openwin_container'));
                            view_common.showLoading($('#sfly_wgt_openwin_container'));
                            updateWindowTitle(productJson, prodId);

                            $('#sfly_wgt_openwin_container #sfly_wgt_sideopen_styles .sfly-wgt-prod-style').removeClass('sfly-bookstyle-selected');
                            $(this).parent().addClass('sfly-bookstyle-selected');
                            renderBook($(this).attr('data-pid'), productJson, true, function() {
                                view_common.removeLoading($('#sfly_wgt_openwin_container'));
                                modal_common.showBackgroundLoading($('#sfly_wgt_openwin_container'));
                            });
                        })
                    });
                });

                // Bind the click through button
                $('#sfly_wgt_sideopen_buttons .sfly-wgt-orange-btn-sfly').off('click').on('click', function() {
                    var product = view_common.findProjectJsonProduct(productJson, handleCurrentPidCallback());
                    clickThrough.sendToClickThrough(product, 'book', undefined, undefined, undefined, undefined, self.Model);

                    var prodJson = view_common.getProduct(handleCurrentPidCallback());
                    tracking.track('open', 'personalize', { sku: prodJson.sflySku, page: self.getCurrentOpenPage() });
                });
            }

            var product         = view_common.findProjectJsonProduct(productJson, pId);
            var pages           = product.book.pages.length - 1;
            var origProduct     = view_common.getProduct(pId);
            var bookName        = origProduct['title'];
            var bookSize        = origProduct['size'];
            handleCurrentPidCallback(pId);

            var sideopen = $(view_common.renderTemplate(templates.side_booksmodal, {
                    title: pages + ' Pages' + ', ' + bookName,
                    price: config.getPrice(config.getBooks()[pId].sku),
                    products: '',
                    pid: pId,
                    size: bookSize,
                    see_all: origProduct.seeMoreUrl,
                    coupon: typeof cache.getCoupon() !== "undefined" ? cache.getCoupon().name : false
                }
            ));

            var openwinContainer = $('#sfly_wgt_openwin_container');

            changeOpenStatusCallback(true, self.closeModalAction, function(){ self.openModalAction(pId, sideopen, releaseLockAndStopLoading, forcedClose) });

            // UPP
            $('#sfly_wgt_upp_select').on('click', function(){
                function onOK(groupPhotos, isThisLife, mixedSources) {
                    if (groupPhotos.photos.length < 20){
                        modal_common.removeLoader(openwinContainer);
                        viewDisableCallback();
                        self.showNotEnoughPhotosPopup(function() {
                            modal_common.removeOverlay(openwinContainer);
                            viewDisableCallback();
                        });
                        releaseLockCallback();
                        return;
                    }

                    productJson = [];
                    function _getProductJson(pJson) {
                        if (pJson != null) {
                            // if is This Life replace photoIds in the strip with SFLY Ids
                            if(isThisLife) {
                                pJson = modal_common.replaceIdWithSFLYId(groupPhotos, pJson);
                            }
                            productJson = productJson.concat(pJson);
                        } else {
                            view_common.removeLoading(openwinContainer);
                            modal_common.showBackgroundLoading(openwinContainer);
                        }
                    }

                    $.when(
                        productProxy.getPhotobook(groupPhotos, 40, _getProductJson, false, true, prodStyles, isThisLife, mixedSources, true))
                        .then(function() {
                            currAlbum = groupPhotos;
                            releaseLockAndStopLoading(true);
                        })
                        .fail(function() {
                            releaseLockCallback();
                            view_common.removeLoading(openwinContainer);
                            modal_common.showBackgroundLoading(openwinContainer);
                        });

                    tracking.track('open', 'upp', { action: 'ok', sku: origProduct['sflySku'] });
                }

                function onCancel() {
                    releaseLockCallback();
                    view_common.removeLoading(openwinContainer);
                    tracking.track('open', 'upp', { action: 'cancel', sku: origProduct['sflySku'] });
                }

                tracking.track('open', 'upp', { action: 'open', sku: origProduct['sflySku'] });

                view_common.showLoading(openwinContainer);
                takeLockCallback();
                modal_common.showUPP(onOK, onCancel);
            });

            /* DISABLE ALBUM SWITCH
            modal_common.addAlbumSwitch(openwinContainer, loadedAlbums, currAlbum.albumId, function(albumId, magicSelectBox) {
                modal_common.hideBackgroundLoading(openwinContainer);
                view_common.showLoading(openwinContainer);
                takeLockCallback();

                albumSwitch.getPhotosForAlbum(albumId, function(photos) {

                    if (photos.numPhotos < 20){
                        view_common.removeLoader(openwinContainer);
                        viewDisableCallback();
                        self.showNotEnoughPhotosPopup(function() {
                            magicSelectBox.clearAllSelected();
                            view_common.removeOverlay(openwinContainer);
                            viewDisableCallback();
                        });
                        releaseLockCallback();
                        return;
                    }

                    productJson = [];
                    function _getProductJson(pJson) {
                        if (pJson != null) {
                            productJson = productJson.concat(pJson);
                        } else {
                            view_common.removeLoading(openwinContainer);
                            modal_common.showBackgroundLoading(openwinContainer);
                        }
                    }

                    // If this is the first album, don't use cache as it's the same ID as the combo-album from server on getMgSource
                    var dontUseCache    = albumId == currAlbum.albumId;

                    // on album switch - isManual = true
                    $.when(
                        productProxy.getPhotobook(photos, 40, _getProductJson, false, true, prodStyles, false, false, dontUseCache))
                        .then(function() {
                            releaseLockAndStopLoading(true);
                        })
                        .fail(function() {
                            releaseLockCallback();
                            view_common.removeLoading(openwinContainer);
                            modal_common.showBackgroundLoading(openwinContainer);
                        });
                });
            });
            */

            // Position the open/close button in the right place
            var btn = $('.sfly-wgt-btn-sidemodule');

            // When the window is just refreshed and re-rendered
            if (!self.getIsWidgetOpen()) {
                buttonCloseCallback(btn, 'prod_clicked');
            }
        };

        return function(){
            modal.call(this);

            // helper for private functions
            var self = this;

            // Will open the sliding window with the given products
            this.showProductsWindow = function(pId, album, albums, prodStyles, prodOptions, forceCloseExternal, takeLockCallback, releaseLockCallback, closeButtonCallback, changeOpenStatusCallback, handleCurrentPidCallback, viewDisableCallback) {

                function showTheBook(forceClose) {
                    var productJson = [];
                    function _getProductJson(pJson) {
                        productJson = productJson.concat(pJson);
                    }

                    $.when(
                        productProxy.getPhotobook(album, 40, _getProductJson, false, false, prodStyles[pId]))
                        .then(function() {
                            openSlideAndRenderBook(pId, productJson, prodStyles[pId], forceClose, albums, album, takeLockCallback, releaseLockCallback, closeButtonCallback, changeOpenStatusCallback, handleCurrentPidCallback, viewDisableCallback, self);
                        });
                }
                this.showProductsWindowFeatures(pId, album, albums, prodStyles, prodOptions, forceCloseExternal, takeLockCallback, releaseLockCallback, closeButtonCallback, changeOpenStatusCallback, handleCurrentPidCallback, viewDisableCallback, showTheBook);
            };
        };

        this.prototype = Object.create(modal.prototype);
    }
);

/*
 This module will include the minimal version of the modal window for products
 */

define('app/view_engine/modals/minimal/modal_product',
    ['underscore', 'app/templates', 'mgthumb', 'app/asset_mapper', 'app/tracking', 'magicselect', 'app/album_switch', 'app/product_proxy', 'app/view_engine/widgets/common', 'app/config_manager', 'app/view_engine/modals/shared', 'app/click_through', 'app/view_engine/modals/minimal/modal', 'app/thumbgen_wrapper', 'app/time_monitor', 'app/cache_module'],
    function(_, templates, mgthumb, AssetMapper, tracking, magicselect, albumSwitch, productProxy, view_common, config, modal_common, clickThrough, modal, thumbGenWrapper, monitor, cache) {

        var didAlbumSwitch = false;

        // Will render all pages for a product in the given container
        var renderProducts = function(pId, productType, container, mgThumbGen, layoutMasks) {

            var PRODUCT_PROJECTIONS = 5;

            // We need this function to keep the right order inside the generate function
            function _generate(order) {
                mgThumbGen.generate(parseInt(order), pId, true, function(canvas) {
                    $(canvas).attr('data-order', order).hide();
                    $(container).append(canvas);
                }, true, { masks: layoutMasks });
            }

            if (!$(container).attr('data-rendered')) {
                // Put this first - to block more attempts to render
                $(container).attr('data-rendered', true);

                var width   = $(container).attr('data-real-width');
                var height  = $(container).attr('data-height');

                var numOfPages = PRODUCT_PROJECTIONS;

                $(container).attr('data-pages', PRODUCT_PROJECTIONS);

                function generateWithTimeout(i) {
                    setTimeout(function(){_generate(i);},i*50);
                }

                for(var i = 1; i < numOfPages; i++) {
                    generateWithTimeout(i);
                }
            }
        };

        function doClickThrough(pId, productJson, productType, handleCurrentPidCallback, model) {
            var product = view_common.findProjectJsonProduct(productJson, handleCurrentPidCallback(pId), didAlbumSwitch);
            var that = this;
            var prod = view_common.getProduct(pId);

            product.product.info.productCode = prod["productCode"];
            product.product.info.sku = prod["sku"];
            clickThrough.sendToClickThrough(product, productType, undefined, undefined, undefined, that.winHandler, model, prod.personalizeUrl);



            var prodJson = view_common.getProduct(handleCurrentPidCallback());
            tracking.track('side', 'personalize', { sku: prodJson.sflySku });
        }

        // Slide the modal window into view and render the view
            var openSlideAndRenderProduct = function(pId, productJson, prodStyles, prodOptions, forcedClose, loadedAlbums, currAlbum, takeLockCallback, releaseLockCallback, buttonCloseCallback, changeOpenStatusCallback, handleCurrentPidCallback, viewDisableCallback, self) {

            function renderThumb(pId, index, productType, partnerId, product, layoutJson, designJson, layoutMasks, totNumOfProducs, removeLoaderCallBack) {
                var useCDN = cache.get('env') != 'beta' && cache.get('env') != 'dev';
                var mgThumbGen  = new MgThumbGenerator(cache.get('env'),useCDN);

                mgThumbGen.init(productType, partnerId, product, layoutJson, designJson, self.Model.get('monitoring').reportEvent, cache.get('env'));

                mgThumbGen.generate(parseInt(0), pId, true, function(canvas) {
                    var elem = $(view_common.renderTemplate(templates.side_product_price, { pid: pId, sku: view_common.getProduct(pId)['sflySku'], ptype: productType, title: view_common.getProduct(pId)['shortName'], price: config.getPrice(view_common.getProduct(pId)['sku']), isMobile: false }));

                    $(canvas).attr('data-order', 0);
                    // the position of the product in the row (if second row subctract the num of products in the first row)
                    var prodPositionInLine = index > totNumOfProducs/2 ? index - totNumOfProducs/2 : index;
                    elem.attr('data-position', prodPositionInLine);
                    elem.children('.sfly_wgt_product_inner').html(canvas);
                    var prodContainer = totNumOfProducs > 1 ? $(sideopen).find('#sfly_wgt_sideopen_products_'+(index <= totNumOfProducs/2 ? 1 : 2)) : $(sideopen).find('#sfly_wgt_sideopen_products_1');

                    prodContainer.hide();
                    var productContBox = prodContainer.find('.sfly_wgt_product[data-position="'+prodPositionInLine+'"]');

                    if (productContBox.length == 0) {
                        prodContainer.append(elem);
                    } else {
                        productContBox.replaceWith(elem);
                    }

                    // Resize by height and give them 5px of margin
                    var zoom = (totNumOfProducs == 1) ? 1.8 : 1;
                    // self.updateProductSizeByHeight(elem, ((self.getSlideProdHeight() / 2))*zoom, pId, productJson);
                    self.updateProductSizeByContainer(elem, (self.getOpenWidgetWidth()/3)*zoom, (self.getSlideProdHeight() / 2)*zoom, pId, productJson);


                    // Center the product
                    var productRealWidth        = Math.floor(elem.children('.sfly_wgt_product_inner').attr('data-width')) - Math.floor(elem.children('.sfly_wgt_product_inner').attr('data-right')) - Math.floor(elem.children('.sfly_wgt_product_inner').attr('data-left'));
                    var hostWidth               = $(sideopen).parent().width();
                    var remainingSpace          = hostWidth - productRealWidth*totNumOfProducs/2;
                    var spaceBetweenProducts    = remainingSpace / (totNumOfProducs/2 + 1);

                    var productLeftPos = -1 * Math.floor(elem.children('.sfly_wgt_product_inner').attr('data-left'));
                    if (prodPositionInLine > 1) {
                        productLeftPos += prodPositionInLine * spaceBetweenProducts + productRealWidth * (prodPositionInLine - 1);
                    } else {
                        productLeftPos += spaceBetweenProducts;
                    }

                    //if one product - put the element in the middle of the modal
                    productLeftPos = totNumOfProducs == 1 ? (hostWidth/2 - productRealWidth/2 -  Math.floor(elem.children('.sfly_wgt_product_inner').attr('data-left')))  : productLeftPos;
                    if(totNumOfProducs == 1) {
                        var hostHeight          = $(sideopen).parent().height();
                        var productRealHeight   = Math.floor(elem.children('.sfly_wgt_product_inner').attr('data-height'));
                        var productTopPos       = (hostHeight/2 - productRealHeight/2 -  Math.floor(elem.children('.sfly_wgt_product_inner').attr('data-top-size')));
                        elem.css('top', productTopPos+'px');
                    }

                    elem.css('left', productLeftPos+'px')
                        .mouseover(function() { $(this).find("#sfly_wgt_product_buttons").css('visibility','visible'); })
                        .mouseout(function() { $(this).find("#sfly_wgt_product_buttons").css('visibility','hidden'); });

                    // Bind the click through button
                    elem.children('.sfly_wgt_product_inner').off('click').on('click', function() {
                        var pId = $(this).parent().attr('data-pid');
                        doClickThrough(pId, productJson, productType, handleCurrentPidCallback, self.Model);
                    });

                    elem.find('#sfly_wgt_product_buttons > .sfly-wgt-orange-btn-sfly').off('click').on('click', function() {
                        var pId = $(this).parent().parent().parent().attr('data-pid');
                        doClickThrough(pId, productJson, productType, handleCurrentPidCallback, self.Model);
                    });

                    elem.find('.sfly_wgt_product_price > strong').off('click').on('click', function() {
                        var pId = $(this).parent().parent().parent().attr('data-pid');
                        doClickThrough(pId, productJson, productType, handleCurrentPidCallback, self.Model);
                    });

                    // Center the actions
                    //elem.find(".sfly_wgt_product_inner_action").css('left', actionLeftPos+'px' );

                    // show the product
                    prodContainer.show();

                    var actionSize      = Math.floor($(elem).children(".sfly_wgt_product_inner_action")[0].offsetWidth);
                    var prodSize        = Math.floor(elem.children('.sfly_wgt_product_inner').attr('data-orig-width'));
                    var actionLeftPos   = (prodSize - actionSize)/2 + Math.floor(elem.children('.sfly_wgt_product_inner').attr('data-left'));
                    var prodBottomPad   = Math.floor(elem.children('.sfly_wgt_product_inner').attr('data-bottom')) - 15;


                    elem.find(".sfly_wgt_product_inner_action").css('left', actionLeftPos+'px').css('bottom', prodBottomPad+'px');

                    // if is a rotatable render it and bind mousemove action
                    if(view_common.isProductRotatable(productType)) {
                        renderProducts(pId, productType, elem.children('.sfly_wgt_product_inner'), mgThumbGen, layoutMasks);

                        elem.children('.sfly_wgt_product_inner').on('mousemove', function (event) {
                            if ($(this).parent().parent().hasClass('sfly-wgt-dont-act')) { // Not yet ready for action.
                                return;
                            }

                            var pages = $(this).attr('data-pages');
                            var prodWidth = $(this).width();

                            // Calc real position
                            var targetPos = $(event.currentTarget).offset();
                            var mousePos = {top: event.pageY, left: event.pageX};
                            var realPos = {top: mousePos.top - targetPos.top, left: mousePos.left - targetPos.left};

                            var currPage = Math.floor((realPos.left) * pages / prodWidth);

                            if (currPage < 0) {
                                currPage = 0;
                            } else if (currPage >= pages - 1) {
                                currPage = pages - 1;
                            }

                            $(this).find('canvas').hide();
                            $(this).find('canvas[data-order=' + currPage + ']').show();
                        });
                    }

                    removeLoaderCallBack();

                }, true, { masks: layoutMasks, textEnabled:(productType !== "book") });
            }

            // Will render the products
            function renderProduct(pId, index, productJson, totNumOfProducs, removeLoaderCallBack) {
                var prodType    = view_common.getProduct(pId).type;
                var productId   = config.parseProductId(view_common.getProduct(pId));
                var product     = view_common.findProjectJsonProduct(productJson, pId, didAlbumSwitch);
                var partnerId   = AssetMapper.GetPartnerId(product, prodType);

                thumbGenWrapper.prepareThumbGenAssets(pId, productId, 'medium', prodType, product, function (result)
                {
                    if (result == null || typeof result.layoutJson === 'undefined' || typeof result.designJson === 'undefined') {
                        console.log('>>> [Product Widget] Missing layout / design json');
                        return;
                    }

                    if (result.hasOwnProperty('productInfo') && result.productInfo.sku != pId) {
                        self.Model.get('monitoring').reportEvent('GotFallbackProd');
                    }

                    var layoutJson = JSON.stringify(result.layoutJson);
                    var designJson = JSON.stringify(result.designJson);

                    renderThumb(pId, index, prodType, partnerId, product, layoutJson, designJson, result.layoutMasks, totNumOfProducs, removeLoaderCallBack);
                });
            }

            // Will stop loading, release the global lock and show the product styles.
            function releaseLockAndStopLoading() {
                releaseLockCallback();
                view_common.removeLoading($('#sfly_wgt_container'));
                $(self.Model.get('container')).find('.sfly_wgt_product[data-pid="' + pId + '"]').removeClass('not-selected');
                self.positionSelectedArrow(pId);
                self.setIsWidgetOpen(true);

                var numOfProds = prodStyles.length;
                var numRenderedProducs = 0;
                var removeLoader = function(){
                    numRenderedProducs++;
                    if(numRenderedProducs == numOfProds){
                        view_common.removeLoading($('#sfly_wgt_openwin_container'));
                    }
                };

                _.each(prodStyles, function (style, index) {
                    renderProduct(style, (index + 1), productJson, numOfProds, removeLoader);
                });
            }

            didAlbumSwitch      = false;
            var product         = view_common.findProjectJsonProduct(productJson, pId, didAlbumSwitch);
            var origProduct     = view_common.getProduct(pId);

            handleCurrentPidCallback(pId);

            var sideopen = $(view_common.renderTemplate(templates.side_productsmodal, {
                    title: typeof prodOptions !== "undefined" && typeof prodOptions['title-modal'] !== "undefined" ? prodOptions['title-modal'] : origProduct.title,
                    price: config.getPrice(origProduct.sku),
                    pid: pId,
                    size: 1,
                    see_all: origProduct.seeMoreUrl,
                    per_text: origProduct.type == 'card' ? ' per card' : '',
                    coupon: typeof cache.getCoupon() !== "undefined" ? cache.getCoupon().name : false
                }
            ));

            changeOpenStatusCallback(true, self.closeModalAction, function(){ self.openModalAction(pId, sideopen, releaseLockAndStopLoading, forcedClose) });

            var openwinContainer = $('#sfly_wgt_openwin_container');

            // UPP
            $('#sfly_wgt_upp_select').on('click', function(){
                function onOK(groupPhotos, isThisLife, mixedSources) {
                    productJson = [];
                    function _getProductJson(pJson) {
                        if (pJson != null) {
                            // if is This Life replace photoIds in the strip with SFLY Ids
                            if(isThisLife) {
                                pJson = modal_common.replaceIdWithSFLYId(groupPhotos, pJson);
                            }
                            productJson = productJson.concat(pJson);
                        } else {
                            releaseLockCallback();
                            view_common.removeLoading(openwinContainer);
                        }
                    }

                    $.when(
                        productProxy.getProducts(groupPhotos, _getProductJson, false, prodStyles, true, isThisLife, mixedSources, true))
                        .then(function () {
                            didAlbumSwitch = true;
                            releaseLockAndStopLoading();
                        })
                        .fail(function () {
                            releaseLockCallback();
                            view_common.removeLoading(openwinContainer);
                        });

                    tracking.track('open', 'upp', { action: 'ok', sku: origProduct['sflySku'] });
                }

                function onCancel() {
                    releaseLockCallback();
                    view_common.removeLoading(openwinContainer);
                    tracking.track('open', 'upp', { action: 'cancel', sku: origProduct['sflySku'] });
                }

                tracking.track('open', 'upp', { action: 'open', sku: origProduct['sflySku'] });

                view_common.showLoading(openwinContainer);
                takeLockCallback();
                modal_common.showUPP(onOK, onCancel);
            });

            /*
            modal_common.addAlbumSwitch(openwinContainer, loadedAlbums, currAlbum.albumId, function(albumId, magicSelectBox) {
                view_common.showLoading(openwinContainer);
                takeLockCallback();

                albumSwitch.getPhotosForAlbum(albumId, function(photos) {
                    if (photos.numPhotos < 1){
                        view_common.removeLoader(openwinContainer);
                        viewDisableCallback();
                        self.showNotEnoughPhotosPopup(function() {
                            magicSelectBox.clearAllSelected();
                            view_common.removeOverlay(openwinContainer);
                            viewDisableCallback();
                        });
                        releaseLockCallback();
                        return;
                    }

                    modal_common.setPhotoSizeForAlbumSwitch(photos);

                    productJson = [];
                    function _getProductJson(pJson) {
                        if (pJson != null) {
                            productJson = productJson.concat(pJson);
                        } else {
                            releaseLockCallback();
                            view_common.removeLoading(openwinContainer);
                        }
                    }

                    var dontUseCache = albumId == currAlbum.albumId;

                    $.when(
                        productProxy.getProducts(photos, _getProductJson, true, prodStyles, true, false, false, dontUseCache))
                        .then(function() {
                            didAlbumSwitch = true;
                            releaseLockAndStopLoading();
                        })
                        .fail(function() {
                            releaseLockCallback();
                            view_common.removeLoading(openwinContainer);
                        });
                });
            });
            */

            // Position the open/close button in the right place
            var btn = $('.sfly-wgt-btn-sidemodule');

            // When the window is just refreshed and re-rendered
            if (!self.getIsWidgetOpen()) {
                buttonCloseCallback(btn, 'prod_clicked');
            }
        };

        return function(){
            modal.call(this);

            // helper for private functions
            var self = this;

            // Will open the sliding window with the given products
            this.showProductsWindow = function(pId, album, albums, prodStyles, prodOptions, forceCloseExternal, takeLockCallback, releaseLockCallback, closeButtonCallback, changeOpenStatusCallback, handleCurrentPidCallback, viewDisableCallback) {

                function showProducts(forceClose) {
                    var productJson = [];
                    function _getProductJson(pJson) {
                        productJson = productJson.concat(pJson);
                    }

                    $.when(
                        productProxy.getProducts(album, _getProductJson, false, prodStyles[pId], true))
                        .then(function() {
                            openSlideAndRenderProduct(pId, productJson, prodStyles[pId], typeof prodOptions !== "undefined" ? prodOptions[pId]: undefined, forceClose, albums, album, takeLockCallback, releaseLockCallback, closeButtonCallback, changeOpenStatusCallback, handleCurrentPidCallback, viewDisableCallback, self);
                        });

                    // First step - load all product SKUs Jsons
                    /*
                    var promises = [];
                    _.each(prodStyles[pId], function(sku) {
                        var deffered = $.Deferred();
                        promises.push(deffered);
                        thumbGenWrapper.loadProductSKU(sku, 'medium', function() {
                            deffered.resolve();
                        })
                    });


                    $.when.apply($, promises).then(function() {
                        $.when(
                            productProxy.getProducts(album, _getProductJson, false, prodStyles[pId], true))
                            .then(function() {
                                openSlideAndRenderProduct(pId, productJson, prodStyles[pId], forceClose, albums, album, takeLockCallback, releaseLockCallback, closeButtonCallback, changeOpenStatusCallback, handleCurrentPidCallback, viewDisableCallback, self);
                            });
                    });

                     */
                }

                this.showProductsWindowFeatures(pId, album, albums, prodStyles, prodOptions, forceCloseExternal, takeLockCallback, releaseLockCallback, closeButtonCallback, changeOpenStatusCallback, handleCurrentPidCallback, viewDisableCallback, showProducts);
            };
        };

        this.prototype = Object.create(modal.prototype);
    }
);

/*
 This module will include the minimal version of the modal window for photobook
 */

define('app/view_engine/modals/minimal/modal_prints',
    ['underscore', 'app/templates', 'mgthumb', 'app/asset_mapper', 'app/tracking', 'magicselect', 'app/album_switch', 'app/product_proxy', 'app/view_engine/widgets/common', 'app/config_manager', 'app/view_engine/modals/shared', 'app/click_through', 'app/view_engine/modals/minimal/modal', 'app/time_monitor', 'app/cache_module'],
    function(_, templates, mgthumb, AssetMapper, tracking, magicselect, albumSwitch, productProxy, view_common, config, modal_common, clickThrough, modal, monitor, cache) {

        var MAX_PRINTS      = 40; // An arbitarary number based on observation
        var didAlbumSwitch  = false;

        // Will render all pages for a book in the given container
        var renderBookAndPrints = function(pId, productType, container, mgThumbGen, productJson, pageToShow, self) {

            // This is code from book rendering. Need this to start from beginning.
            pageToShow = -1;

            // We need this function to keep the right order inside the generate function
            function _generate(order) {
                mgThumbGen.generate(parseInt(order), pId, true, function(canvas) {
                    $(canvas).attr('data-order', order).hide();
                    $(container).append(canvas);

                    if (pageToShow == order || self.getCurrentOpenPage() == order) {
                        $(container).find('canvas').hide();
                        $(canvas).show();
                    }
                }, true);
            }

            if (!$(container).attr('data-rendered')) {
                // Put this first - to block more attempts to render
                $(container).attr('data-rendered', true);

                var width   = $(container).attr('data-real-width');
                var height  = $(container).attr('data-height');

                var product = view_common.findProjectJsonProduct(productJson, pId, didAlbumSwitch);
                var numOfPages;
                numOfPages = parseInt(product.prints.pages.length);
                numOfPages = numOfPages > MAX_PRINTS ? MAX_PRINTS : numOfPages;

                $(container).attr('data-pages', numOfPages);

                for(var i = 1; i < numOfPages; i++) {
                    _generate((i == numOfPages-1 && productType == "book") ? 99 : i);
                }
            }
        };

        // Render the navigation template for the calendar product
        var renderBookAndPrintsNavigation = function(pId, productType, container, productJson, position, pageToShow, self) {
            var MAX_BOOK_NAV    = 400;
            var MAX_BOOK_BOX    = 40;
            var MAX_PRINTS_NAV  = 400;
            var MAX_PRINTS_BOX  = 40;
            var MIN_PAGES       = 5;

            if (typeof pageToShow === 'undefined') {
                pageToShow = -1;
            }

            if ($(container).find('.sfly-wgt-book-nav').length == 0) {
                var product = view_common.findProjectJsonProduct(productJson, pId, didAlbumSwitch);
                var numOfPages;
                if (productType == "book") {
                    numOfPages = Math.floor((product.book.pages.length) / 2) + 2;
                } else {
                    numOfPages = parseInt(product.prints.pages.length);
                    numOfPages = numOfPages > MAX_PRINTS ? MAX_PRINTS : numOfPages;
                }

                // Calculate the boxes size
                var boxSize = MAX_PRINTS_NAV / numOfPages > MAX_PRINTS_BOX ? MAX_PRINTS_BOX : MAX_PRINTS_NAV / numOfPages;

                var display = 'block';
                var paging  = view_common.renderTemplate(templates.side_prints_paging, { pages: numOfPages });
                $(container).append(paging);
                var positionTopPagining = 80;

                if(numOfPages > 2) {
                    var nav = view_common.renderTemplate(templates.book_nav, {pages: numOfPages, type: productType, currPage: pageToShow});
                    $(container).append(nav);

                    var totalspace = boxSize * (numOfPages - 1) + 61;
                    var leftFix = totalspace / 2;

                    $(container).find('.sfly-wgt-book-nav')
                        .css('left', (position.left - leftFix) + 'px')
                        .css('top', (position.top + 85) + 'px')
                        .css('width', totalspace + 'px')
                        .attr('data-width', totalspace)
                        .attr('data-show-nav', display == 'block' ? 'true' : 'false')
                        .find('li > div').css('width', boxSize + 'px');

                    positionTopPagining = 100;
                }

                $(container).find('.sfly-wgt-book-paging')
                    .css('top', (position.top + positionTopPagining)+'px')
                    .css('left', (position.left - 54) + 'px');
            }
        };

        // Slide the book window into view and render the view
        var openSlideAndRenderBook = function(pId, productJson, prodStyles, forcedClose, loadedAlbums, currAlbum, takeLockCallback, releaseLockCallback, buttonCloseCallback, changeOpenStatusCallback, handleCurrentPidCallback, viewDisableCallback, self) {

            var currPhotos = currAlbum.photos;

            // Will render the main book
            function renderBook(pId, productJson, useCurrentPage, callbackOnFinish) {
                var product     = view_common.findProjectJsonProduct(productJson, pId, didAlbumSwitch);
                var productType = AssetMapper.GetProductType(product);
                var partnerId   = AssetMapper.GetPartnerId(product, productType);
                var layoutJson  = JSON.stringify(config.getRecipeLayout()[partnerId]);
                var designJson  = JSON.stringify(config.getRecipeDesign()[partnerId]);
                useCurrentPage  = (typeof useCurrentPage !== 'undefined' && useCurrentPage == true);
                var useCDN = cache.get('env') != 'beta' && cache.get('env') != 'dev';
                var mgThumbGen  = new MgThumbGenerator(cache.get('env'),useCDN);

                mgThumbGen.init(productType, partnerId, product, layoutJson, designJson, self.Model.get('monitoring').reportEvent, cache.get('env'));

                mgThumbGen.generate(parseInt(0), pId, true, function(canvas) {
                    var elem = $(view_common.renderTemplate(templates.fullview_product, { pid: pId, sku: view_common.getProduct(pId)['sflySku'], ptype: productType }));
                    $(canvas).attr('data-order', 0);
                    elem.children('.sfly_wgt_product_inner').html(canvas);
                    $(sideopen).find('#sfly_wgt_sideopen_products').hide().html(elem);

                    var pTargetSize = self.updateProductSizeByHeight(elem, self.getPrintHeight(), pId, productJson);

                    // Center the product
                    var bookWidth = elem.children('.sfly_wgt_product_inner').attr('data-width');
                    var hostWidth = $(sideopen).parent().width();
                    var bookLeftPos = Math.floor(hostWidth/2) - Math.floor(bookWidth/2);

                    $(sideopen).find('#sfly_wgt_sideopen_products').css('left', bookLeftPos+'px').show();

                    renderBookAndPrints(pId, 'prints', elem.children('.sfly_wgt_product_inner'), mgThumbGen, productJson, useCurrentPage ? self.getCurrentOpenPage() : -1, self);
                    renderBookAndPrintsNavigation(pId, 'prints', $(sideopen).find('#sfly_wgt_sideopen_products'), productJson, { left: pTargetSize/2, top: self.getSlideProdHeight() }, useCurrentPage ? self.getCurrentOpenPage() : -1, self);

                    // scale the cover page wrapper as well
                    var bookCoverSize   = $(sideopen).find('.sfly-wgt-book-cover-wrapper').attr('data-width');
                    var coverLeft       = pTargetSize/2 - bookCoverSize/2 - 37; // The 20px is a temp fix for aligning the cover
                    $(sideopen).find('#sfly_wgt_sideopen_products').find('.sfly-wgt-book-cover-wrapper').css('left', coverLeft+'px');

                    if (!useCurrentPage) {
                        self.setCurrentOpenPage(0);
                    } else {
                        $(sideopen).find('.sfly-wgt-pages').html((parseInt(self.getCurrentOpenPage()) + 1));
                    }
                    modal_common.setArrowPagingClass(sideopen, parseInt(self.getCurrentOpenPage()), elem.children('.sfly_wgt_product_inner').attr('data-pages') - 1);

                    if (_.isFunction(callbackOnFinish)) {
                        callbackOnFinish();
                    }

                    var isClickAfterDrag = false;

                    $('#sfly_wgt_sideopen_products')
                        .off('click')
                        .on('click', function(event) {
                            var inner           = $(this).find('.sfly_wgt_product_inner');
                            var innerPosition   = inner.position();

                            var clickRange     = {
                                left: parseInt(innerPosition.left) + parseInt(inner.attr('data-left')),
                                right: parseInt(innerPosition.left) + parseInt(inner.attr('data-left')) + parseInt(inner.attr('data-orig-width')),
                                top: parseInt(innerPosition.top) + parseInt(inner.attr('data-top-size')) - 15,
                                bottom: parseInt(innerPosition.top) + parseInt(inner.attr('data-top-size')) + parseInt(inner.attr('data-real-height'))
                            };

                            // Calc real position
                            var targetPos       = $(event.currentTarget).offset();
                            var mousePos        = { top: event.pageY, left: event.pageX };
                            var realPos         = { top: mousePos.top - targetPos.top, left: mousePos.left - targetPos.left };

                            if (realPos.left >= clickRange.left && realPos.left <= clickRange.right && realPos.top >= clickRange.top && realPos.top <= clickRange.bottom && !isClickAfterDrag) {
                                var nextPage    = self.getCurrentOpenPage() + 1;
                                var totalPages  = Math.floor(product.prints.pages.length);
                                if (totalPages > MAX_PRINTS) {
                                    totalPages = MAX_PRINTS;
                                }

                                if (nextPage >= totalPages) {
                                    nextPage = totalPages - 1;
                                }

                                tracking.track('open', 'flip_prints', { page: self.getCurrentOpenPage() });

                                $(sideopen).find('canvas').hide();
                                $(sideopen).find('canvas[data-order=' + nextPage + ']').show();

                                $(sideopen).find('.sfly-wgt-book-nav li').removeClass('wgt-nav-selected');
                                $(sideopen).find('.sfly-wgt-page_' + nextPage).addClass('wgt-nav-selected');

                                self.setCurrentOpenPage(nextPage);

                                $(sideopen).find('.sfly-wgt-pages').html((parseInt(nextPage) + 1));
                                modal_common.setArrowPagingClass(sideopen, parseInt(nextPage), totalPages - 1);


                                /*
                                var prodJson = view_common.getProduct(handleCurrentPidCallback());
                                clickThrough.sendForSeeAll(currPhotos);
                                tracking.track('open', 'personalize', { sku: prodJson.sfly_sku, page: self.getCurrentOpenPage() });
                                */
                            }
                        })
                        .on('mousemove', function(event) {
                            var inner           = $(this).find('.sfly_wgt_product_inner');
                            var innerPosition   = inner.position();
                            var clickRange     = {
                                left: parseInt(innerPosition.left) + parseInt(inner.attr('data-left')),
                                right: parseInt(innerPosition.left) + parseInt(inner.attr('data-left')) + parseInt(inner.attr('data-orig-width')),
                                top: parseInt(innerPosition.top) + parseInt(inner.attr('data-top-size')) - 15,
                                bottom: parseInt(innerPosition.top) + parseInt(inner.attr('data-top-size')) + parseInt(inner.attr('data-real-height'))
                            };

                            // Calc real position
                            var targetPos       = $(event.currentTarget).offset();
                            var mousePos        = { top: event.pageY, left: event.pageX };
                            var realPos         = { top: mousePos.top - targetPos.top, left: mousePos.left - targetPos.left };

                            if (realPos.left >= clickRange.left && realPos.left <= clickRange.right && realPos.top >= clickRange.top && realPos.top <= clickRange.bottom) {
                                $(this).css('cursor', 'pointer');
                            } else {
                                $(this).css('cursor', 'default');
                            }
                    });

                    $(sideopen).find('.sfly-wgt-arrow').on('mousedown', function() {
                        // This will prevent a selection on double click. why? no idea...
                        return false;
                    });

                    //todo: remove duplicate code from arrow/key navigation

                    $('body').off('.pwidget').on('keydown.pwidget', function(e) {
                        e.preventDefault();

                        var nextPage    = self.getCurrentOpenPage();
                        var totalPages  = Math.floor(product.prints.pages.length);
                        if (totalPages > MAX_PRINTS) {
                            totalPages = MAX_PRINTS;
                        }

                        tracking.track('open', 'prints-flip', { page: self.getCurrentOpenPage() });

                        switch(e.keyCode) {
                            case 37: //left
                                nextPage -= 1;
                                break;
                            case 39: //right
                            case 32: //space
                                nextPage += 1;
                                break;
                        }

                        if (isNaN(nextPage)) {
                            nextPage = 0;
                        }

                        if (nextPage < 0) {
                            nextPage = 0;
                        } else if (nextPage >= totalPages) {
                            nextPage = totalPages - 1;
                        }

                        $(sideopen).find('canvas').hide();
                        $(sideopen).find('canvas[data-order=' + nextPage + ']').show();

                        $(sideopen).find('.sfly-wgt-book-nav li').removeClass('wgt-nav-selected');
                        $(sideopen).find('.sfly-wgt-page_' + nextPage).addClass('wgt-nav-selected');

                        self.setCurrentOpenPage(nextPage);

                        $(sideopen).find('.sfly-wgt-pages').html((parseInt(nextPage) + 1));
                        modal_common.setArrowPagingClass(sideopen, parseInt(nextPage), totalPages - 1);
                    });

                    $(sideopen).find('.sfly-wgt-arrow').on('click', function() {
                        var dir = $(this).attr('data-dir');
                        var totalPages = Math.floor(product.prints.pages.length);
                        if (totalPages > MAX_PRINTS) {
                            totalPages = MAX_PRINTS;
                        }
                        var currPage = self.getCurrentOpenPage();
                        var nextPage = dir == 'left' ? currPage -= 1 : currPage += 1;

                        // don't allow to move too left or too right
                        if (nextPage < 0) {
                            nextPage = 0;
                        } else if (nextPage >= totalPages) {
                            nextPage = totalPages - 1;
                        }

                        if (isNaN(nextPage)) {
                            nextPage = 0;
                        }

                        tracking.track('open', 'flip_prints', { page: self.getCurrentOpenPage() });

                        $(sideopen).find('canvas').hide();
                        $(sideopen).find('canvas[data-order=' + nextPage + ']').show();

                        $(sideopen).find('.sfly-wgt-book-nav li').removeClass('wgt-nav-selected');
                        $(sideopen).find('.sfly-wgt-page_' + nextPage).addClass('wgt-nav-selected');

                        self.setCurrentOpenPage(nextPage);

                        $(sideopen).find('.sfly-wgt-pages').html((parseInt(nextPage) + 1));
                        modal_common.setArrowPagingClass(sideopen, parseInt(nextPage), totalPages - 1);
                    });

                    $(sideopen).find('.sfly-wgt-book-nav li')
                        .on('mousedown', function() {
                            if(!$(this).hasClass('wgt-nav-selected')){
                                return;
                            }
                            isClickAfterDrag = true;
                            $(this).parent().addClass('draggable');

                            $('#sfly_wgt_openwin_container')
                                .on('mousemove', function(event){

                                    $(this).css('cursor','pointer');

                                    var totalPages = Math.floor(product.prints.pages.length);
                                    if(totalPages > MAX_PRINTS){
                                        totalPages = MAX_PRINTS;
                                    }

                                    var elem        = $(this).find('.sfly_wgt_product_inner');
                                    var pages       = elem.attr('data-pages');
                                    var navPosition = $(this).find('.sfly-wgt-book-nav').position();
                                    var navPosRange = { left: navPosition.left, right: navPosition.left + $(this).find('.sfly-wgt-book-nav').width() };

                                    // Calc real position
                                    var targetPos   = $(event.currentTarget).offset();
                                    var mousePos    = { top: event.pageY, left: event.pageX };
                                    var realPos     = { top: mousePos.top - targetPos.top, left: mousePos.left - targetPos.left - ($(this).width() - elem.width())/2  };

                                    var currPage;
                                    var canNavigate = $(this).find('#sfly_wgt_sideopen_products').children('.sfly-wgt-book-nav').attr('data-show-nav') == 'true';

                                    if (!canNavigate) {
                                        return;
                                    }

                                    var navWidth    = $(this).find('#sfly_wgt_sideopen_products').children('.sfly-wgt-book-nav').attr('data-width');
                                    var navStart    = navPosRange.left;
                                    var navEnd      = navPosRange.right;

                                    if (realPos.left < navStart || realPos.left > navEnd) {
                                        return;
                                    }

                                    if (realPos.left < navStart) {
                                        currPage = 0;
                                    } else if (realPos.left > navEnd) {
                                        currPage = (pages > MAX_PRINTS ? MAX_PRINTS : pages) - 1;
                                    } else {
                                        currPage = Math.floor((realPos.left-navStart) * pages / navWidth);
                                        if (currPage >= pages)
                                            currPage = (pages > MAX_PRINTS ? MAX_PRINTS : pages) -1;
                                    }

                                    tracking.track('open', 'flip_prints', { page: self.getCurrentOpenPage() });

                                    $(sideopen).find('canvas').hide();
                                    $(sideopen).find('canvas[data-order=' + currPage + ']').show();

                                    $(sideopen).find('.sfly-wgt-book-nav li').removeClass('wgt-nav-selected');
                                    $(sideopen).find('.sfly-wgt-page_' + currPage).addClass('wgt-nav-selected');

                                    self.setCurrentOpenPage(currPage);

                                    $(sideopen).find('.sfly-wgt-pages').html((parseInt(currPage) + 1));
                                    modal_common.setArrowPagingClass(sideopen, parseInt(currPage), totalPages - 1);
                                })
                                .on('mouseup', function(){
                                    $(this).css('cursor','default');
                                    $(this).off('mousemove');
                                    $('.draggable').removeClass('draggable');
                                    setTimeout(function(){ isClickAfterDrag = false; }, 200);
                                });
                        })
                        .on('click', function(){
                            if($(this).hasClass('wgt-nav-selected')){
                                return;
                            }

                            var totalPages = Math.floor(product.prints.pages.length);
                            if(totalPages > MAX_PRINTS){
                                totalPages = MAX_PRINTS;
                            }
                            var nextPage = parseInt($(this).attr('class').replace("sfly-wgt-page_","").trim());

                            // don't allow to move too left or too right
                            if (nextPage < 0) {
                                nextPage = 0;
                            } else if (nextPage >= totalPages) {
                                nextPage = totalPages - 1;
                            }

                            if (isNaN(nextPage)) {
                                nextPage = 0;
                            }

                            tracking.track('open', 'flip_prints', { page: self.getCurrentOpenPage() });

                            $(sideopen).find('canvas').hide();
                            $(sideopen).find('canvas[data-order=' + nextPage + ']').show();

                            $(sideopen).find('.sfly-wgt-book-nav li').removeClass('wgt-nav-selected');
                            $(sideopen).find('.sfly-wgt-page_' + nextPage).addClass('wgt-nav-selected');

                            self.setCurrentOpenPage(nextPage);

                            $(sideopen).find('.sfly-wgt-pages').html((parseInt(nextPage) + 1));
                            modal_common.setArrowPagingClass(sideopen, parseInt(nextPage), totalPages - 1);
                        });
                }, true);

                handleCurrentPidCallback(pId);
            }

            function updateWindowTitle(productJson, prodId) {
                var product         = view_common.findProjectJsonProduct(productJson, prodId, didAlbumSwitch);
                var pages           = product.prints.pages.length > MAX_PRINTS ? MAX_PRINTS : product.prints.pages.length;
                var origProduct     = view_common.getProduct(prodId);
                var title           = pages + ' Photos, ' + origProduct['title'];
                $('#sfly_wgt_openwin_container #sfly_wgt_sideopen_title h3').html(title);
            }

            // Will stop loading, release the global lock and show the product styles.
            function releaseLockAndStopLoading(isAfterAlbumSwitch) {
                if (typeof isAfterAlbumSwitch === 'undefined') {
                    isAfterAlbumSwitch = false;
                }
                releaseLockCallback();
                view_common.removeLoading($('#sfly_wgt_container'));
                modal_common.hideBackgroundLoading($('#sfly_wgt_openwin_container'));
                view_common.showLoading($('#sfly_wgt_openwin_container'));
                $(self.Model.get('container')).find('.sfly_wgt_product[data-pid="' + pId + '"]').removeClass('not-selected');
                self.positionSelectedArrow(pId);

                self.setIsWidgetOpen(true);

                renderBook(pId, productJson, false, function() {
                    view_common.removeLoading($('#sfly_wgt_openwin_container'));
                    modal_common.showBackgroundLoading($('#sfly_wgt_openwin_container'));
                });

                if (isAfterAlbumSwitch) {
                    updateWindowTitle(productJson, handleCurrentPidCallback());
                }

                // Bind the click through button
                $('#sfly_wgt_sideopen_buttons .sfly-wgt-orange-btn-sfly').off('click').on('click', function() {
                    var prodJson = view_common.getProduct(handleCurrentPidCallback());
                    tracking.track('open', 'personalize', { sku: prodJson.sflySku, page: self.getCurrentOpenPage() });

                    var photoIds = new Array();
                    if(!didAlbumSwitch) {
                        var product = view_common.findProjectJsonProduct(productJson, handleCurrentPidCallback(), didAlbumSwitch);
                        var photosRefIds = new Array();
                        $.each(product.prints.pages, function(i, cPage){
                            $.each(cPage.canvas.layout.photos, function(j, cPhoto) {
                                photosRefIds[cPhoto.photoRefId] = 1;
                            });
                        });

                        if(photosRefIds.length > 0) {
                            $.each(product.prints.photoStrip, function(i, cPhotoStrip) {
                                if(typeof photosRefIds[cPhotoStrip.photoRefId] !== "undefined") {
                                    photoIds.push(cPhotoStrip.photoId);
                                }
                            });
                        }

                        photoIds = _.first(photoIds,MAX_PRINTS);
                    } else {
                        photoIds = currPhotos;
                    }
                    clickThrough.sendForSeeAll(photoIds, undefined, undefined, undefined, undefined, self.Model);
                });
            }

            var product         = view_common.findProjectJsonProduct(productJson, pId, didAlbumSwitch);
            var pages           = product.prints.pages.length > MAX_PRINTS ? MAX_PRINTS : product.prints.pages.length;
            var origProduct     = view_common.getProduct(pId);
            var bookName        = origProduct['title'];
            var bookSize        = origProduct['size'];
            handleCurrentPidCallback(pId);

            var sideopen = $(view_common.renderTemplate(templates.side_printsmodal, {
                    title: pages + ' Photos' + ', ' + bookName,
                    price: config.getPrice(config.getPrints()[pId].sflySku),
                    products: '',
                    pid: pId,
                    size: bookSize,
                    coupon: typeof cache.getCoupon() !== "undefined" ? cache.getCoupon().name : false
                }
            ));

            var openwinContainer = $('#sfly_wgt_openwin_container');

            changeOpenStatusCallback(true, self.closeModalAction, function() {
                self.openModalAction(pId, sideopen, releaseLockAndStopLoading, forcedClose)
            });

            // UPP
            $('#sfly_wgt_upp_select').on('click', function(){
                function onOK(groupPhotos, isThisLife, mixedSources) {
                    productJson = [];
                    function _getProductJson(pJson) {
                        if (pJson != null) {
                            // if is This Life replace photoIds in the strip with SFLY Ids
                            if(isThisLife) {
                                pJson = modal_common.replaceIdWithSFLYId(groupPhotos, pJson);
                            }
                            productJson = productJson.concat(pJson);
                        } else {
                            releaseLockCallback();
                            view_common.removeLoading(openwinContainer);
                        }
                    }

                    var isManual = true;
                    currPhotos   = groupPhotos.photos.map(function(p) { return parseInt(p.id) });
                    currAlbum    = groupPhotos;

                    $.when(
                        productProxy.getPrints(groupPhotos, _getProductJson, isManual, undefined, isThisLife, mixedSources, true))
                        .then(function() {
                            releaseLockAndStopLoading(true);
                        })
                        .fail(function() {
                            releaseLockCallback();
                            view_common.removeLoading(openwinContainer);
                        });

                    tracking.track('open', 'upp', { action: 'ok', sku: origProduct['sflySku'] });
                }

                function onCancel() {
                    releaseLockCallback();
                    view_common.removeLoading(openwinContainer);
                    tracking.track('open', 'upp', { action: 'cancel', sku: origProduct['sflySku'] });
                }

                tracking.track('open', 'upp', { action: 'open', sku: origProduct['sflySku'] });

                view_common.showLoading(openwinContainer);
                takeLockCallback();
                modal_common.showUPP(onOK, onCancel);
            });

            /* DISABLE ALBUM SWITCH
            modal_common.addAlbumSwitch(openwinContainer, loadedAlbums, currAlbum.albumId, function(albumId, magicSelectBox) {
                view_common.showLoading(openwinContainer);
                takeLockCallback();

                albumSwitch.getPhotosForAlbum(albumId, function(photos) {

                    if (photos.numPhotos < 1){
                        view_common.removeLoader(openwinContainer);
                        viewDisableCallback();
                        self.showNotEnoughPhotosPopup(function() {
                            magicSelectBox.clearAllSelected();
                            view_common.removeOverlay(openwinContainer);
                            viewDisableCallback();
                        });
                        releaseLockCallback();
                        return;
                    }

                    productJson = [];
                    function _getProductJson(pJson) {
                        if (pJson != null) {
                            productJson = productJson.concat(pJson);
                        } else {
                            releaseLockCallback();
                            view_common.removeLoading(openwinContainer);
                        }
                    }

                    var isManual        = photos.photos.length <= 200;
                    var dontUseCache    = albumId == currAlbum.albumId;
                    currPhotos          = photos.photos.map(function(p) { return parseInt(p.id) });

                    $.when(
                        productProxy.getPrints(photos, _getProductJson, isManual, undefined, false, false, dontUseCache))
                        .then(function() {
                            didAlbumSwitch = true;
                            releaseLockAndStopLoading(true);
                        })
                        .fail(function() {
                            releaseLockCallback();
                            view_common.removeLoading(openwinContainer);
                        });
                });
            });
            */

            // Position the open/close button in the right place
            var btn = $('.sfly-wgt-btn-sidemodule');

            // When the window is just refreshed and re-rendered
            if (!self.getIsWidgetOpen()) {
                buttonCloseCallback(btn, 'prod_clicked');
            }
        };

        return function()
        {
            modal.call(this);

            // helper for private functions
            var self = this;

            // Will open the sliding window with the given products
            this.showProductsWindow = function(pId, album, albums, prodStyles, prodOptions, forceCloseExternal, takeLockCallback, releaseLockCallback, closeButtonCallback, changeOpenStatusCallback, handleCurrentPidCallback, viewDisableCallback) {

                function showTheBook(forceClose) {
                    var productJson = [];
                    function _getProductJson(pJson) {
                        productJson = productJson.concat(pJson);
                    }

                    $.when(
                        productProxy.getPrints(album, _getProductJson, false, undefined))
                        .then(function() {
                            openSlideAndRenderBook(pId, productJson, prodStyles[pId], forceClose, albums, album, takeLockCallback, releaseLockCallback, closeButtonCallback, changeOpenStatusCallback, handleCurrentPidCallback, viewDisableCallback, self);
                        });
                }
                this.showProductsWindowFeatures(pId, album, albums, prodStyles, prodOptions, forceCloseExternal, takeLockCallback, releaseLockCallback, closeButtonCallback, changeOpenStatusCallback, handleCurrentPidCallback, viewDisableCallback, showTheBook);
            };
        };

        this.prototype = Object.create(modal.prototype);
    }
);

/*
 This module will include the minimal version of the modal window for photobook
 */

define('app/view_engine/modals/minimal/modal_calendar',
    ['underscore', 'app/templates', 'mgthumb', 'app/asset_mapper', 'app/tracking', 'magicselect', 'app/album_switch', 'app/product_proxy', 'app/view_engine/widgets/common', 'app/config_manager', 'app/view_engine/modals/shared', 'app/click_through', 'app/view_engine/modals/minimal/modal', 'app/thumbgen_wrapper', 'app/time_monitor', 'app/cache_module'],
    function(_, templates, mgthumb, AssetMapper, tracking, magicselect, albumSwitch, productProxy, view_common, config, modal_common, clickThrough, modal, thumbGenWrapper, monitor, cache) {

        // Slide the book window into view and render the view
        var openSlideAndRenderBook = function(pId, productJson, prodStyles, forcedClose, loadedAlbums, currAlbum, takeLockCallback, releaseLockCallback, buttonCloseCallback, changeOpenStatusCallback, handleCurrentPidCallback, viewDisableCallback, self) {
            function renderCalendarPages(pId, container, mgThumbGen, masks) {
                var product = view_common.findProjectJsonProduct(productJson, pId);
                var pages   = typeof product.product.pages !== "undefined" ? (parseInt(product.product.pages.length) + 1) / 2 : parseInt(product.product.surfaces.length);

                // We need this function to keep the right order inside the generate function
                function _generate(order) {
                    mgThumbGen.generate(parseInt(order), pId, true, function(canvas) {
                        $(canvas).attr('data-order', order).hide();
                        $(container).append(canvas);

                        if (self.getCurrentOpenPage() == order) {
                            $(container).find('canvas').hide();
                            $(canvas).show();
                        }

                    }, true, { masks: masks });
                }

                if (!$(container).attr('data-rendered')) {
                    // Put this first - to block more attempts to render
                    $(container).attr('data-rendered', true);

                    var width   = $(container).attr('data-real-width');
                    var height  = $(container).attr('data-height');

                    var numOfPages = pages;

                    $(container).attr('data-pages', pages);

                    // generate and show the selected page, then render all else
                    if (self.getCurrentOpenPage() >= numOfPages) {
                        self.setCurrentOpenPage(numOfPages-1);
                    }

                    _generate(self.getCurrentOpenPage());

                    for(var i = 0; i < numOfPages; i++) {
                        if (i != self.getCurrentOpenPage()) {
                            _generate(i);
                        }
                    }
                }
            }

            // Render the navigation template for the calendar product
            function renderCalendarNavigation(pId, container, rightFix) {
                var MIN_MONTH_TO_SHOW   = 6;

                if ($(container).find('.sfly-wgt-cal-nav').length == 0) {
                    var product     = view_common.findProjectJsonProduct(productJson, pId);
                    var numOfPages  = typeof product.product.pages !== "undefined" ? (parseInt(product.product.pages.length) + 1) / 2 : parseInt(product.product.surfaces.length);

                    var nav = view_common.renderTemplate(templates.calendar_nav, { numOfMonths: numOfPages, currMonth: self.getCurrentOpenPage() });
                    $(container).append(nav);

                    if (numOfPages < MIN_MONTH_TO_SHOW) {
                        $(container).find('.sfly-wgt-cal-nav').css('display', 'none').attr('data-hide-nav', 'true');
                    } else {
                        var calNav = $(container).find('.sfly-wgt-cal-nav');
                        calNav.css('display', 'block').attr('data-hide-nav', 'false');
                        var navWidth = calNav.width();
                        var right = rightFix - navWidth - 20;
                        calNav.css('right', right + 'px');

                        if (view_common.getProduct(pId)['type'] == 'deskcalendar') {
                            calNav.css('top', '7px');
                        }

                    }
                }
            }

            // Will render book styles
            function getPhotobookRender(pId, productJson, callback) {
                var prod = cache.get('calendars_map')[pId];

                if(typeof prod === "undefined"){
                    console.log('[Product Widget] Calendar not defined in the map: '+pId);
                    return;
                }

                var elem = $(view_common.renderTemplate(templates.side_style_product, { pid: pId, sku: pId, ptype: 'calendar', title: prod["styleName"] }));
                var wrapper = $('<div class="sfly-wgt-prod-style"></div>');
                elem.children('.sfly_wgt_product_inner').html('<img src="' + prod['static'] + '" class="sfly-img-spread" />');
                elem.css('width', '100px');
                wrapper.html(elem);

                if (_.isFunction(callback)) {
                    callback(wrapper);
                }
            }

            function renderThumb(pId, useCurrentPage, callbackOnFinish, productType, partnerId, product, layoutJson, designJson, layoutMasks){
                var useCDN = cache.get('env') != 'beta' && cache.get('env') != 'dev';
                var mgThumbGen  = new MgThumbGenerator(cache.get('env'),useCDN);

                mgThumbGen.init(productType, partnerId, product, layoutJson, designJson, self.Model.get('monitoring').reportEvent, cache.get('env'));

                var elem = $(view_common.renderTemplate(templates.fullview_product, { pid: pId, sku: view_common.getProduct(pId)['sflySku'], ptype: productType }));
                $(sideopen).find('#sfly_wgt_sideopen_products').html(elem);

                var pTargetSize = self.updateProductSizeByHeight(elem, self.getCalendarHeight(bookSize == 195 ? 'calendar12x12' : productType), pId, productJson);

                // Center the product
                var calWidth  = elem.children('.sfly_wgt_product_inner').attr('data-width');
                var hostWidth = $(sideopen).parent().width();
                var bookLeftPos = Math.floor(hostWidth/2) - Math.floor(calWidth/2);
                $(sideopen).find('#sfly_wgt_sideopen_products').css('left', bookLeftPos+'px');

                renderCalendarPages(pId, elem.children('.sfly_wgt_product_inner'), mgThumbGen), layoutMasks;
                renderCalendarNavigation(pId, elem, parseInt($(elem.children('.sfly_wgt_product_inner')[0]).attr('data-right')));

                view_common.removeLoading($('#sfly_wgt_openwin_container'));
                modal_common.showBackgroundLoading($('#sfly_wgt_openwin_container'));
                if(typeof callbackOnFinish == "function"){
                    callbackOnFinish();
                }
                var prodType = view_common.getProduct(pId)['type'];

                $('#sfly_wgt_sideopen_products').off('click').on('mousemove', function(event) {
                    var inner           = $(this).find('.sfly_wgt_product_inner');
                    var innerPosition   = inner.position();
                    var clickRange     = {
                        left:   parseInt(innerPosition.left) + parseInt(inner.attr('data-left')),
                        right:  parseInt(innerPosition.left) + parseInt(inner.attr('data-left')) + parseInt(inner.attr('data-orig-width')),
                        top:    parseInt(innerPosition.top) + parseInt(inner.attr('data-top-size')),
                        bottom: parseInt(innerPosition.top) + parseInt(inner.attr('data-top-size')) + parseInt(inner.attr('data-real-height')) + 15
                    };

                    // Calc real position
                    var targetPos       = $(event.currentTarget).offset();
                    var mousePos        = { top: event.pageY, left: event.pageX };
                    var topBonus        = prodType == 'deskcalendar' ? 10 : 0; // the nav has been moved 10px down
                    var realPos         = { top: mousePos.top - targetPos.top - topBonus, left: mousePos.left - targetPos.left };

                    if (realPos.left >= clickRange.left && realPos.left <= clickRange.right && realPos.top >= clickRange.top && realPos.top <= clickRange.bottom) {
                        $(this).css('cursor', 'pointer');
                    } else {
                        $(this).css('cursor', 'default');
                    }

                    var calNav = $(this).find('.sfly-wgt-cal-nav');
                    // Don't allow to navigate
                    if (calNav.attr('data-hide-nav') == 'true') {
                        return;
                    }
                    var navHeight   = calNav.height();
                    var navStart    = 10;
                    var navEnd      = navStart + parseInt(navHeight);
                    var currPage    = 0;
                    var navPages    = typeof product.product.pages !== "undefined" ? (parseInt(product.product.pages.length) + 1) / 2 : parseInt(product.product.surfaces.length);

                    if (realPos.top < navStart) {
                        currPage = 0;
                    } else if (realPos.top >= navEnd) {
                        currPage = navPages - 1;
                    } else {
                        currPage = Math.floor((realPos.top - navStart) * navPages / navHeight);
                    }

                    // Nav
                    $(this).find('.sfly-wgt-cal-nav li').removeClass('wgt-nav-selected');
                    $(this).find('.sfly-wgt-cal-nav li.sfly-wgt-month_' + currPage).addClass('wgt-nav-selected');
                    // Pages
                    $(this).find('.sfly_wgt_product_inner canvas').hide().removeClass('selected');
                    $(this).find('.sfly_wgt_product_inner canvas[data-order="' + currPage + '"]').addClass('selected').show();

                    self.setCurrentOpenPage(currPage);
                })
                    .on('mouseenter', function() {
                        var prodJson = view_common.getProduct(handleCurrentPidCallback());
                    })
                    .on('click', function(event) {
                        if ($(event.target).hasClass('sfly-wgt-arrow') || $(event.target).hasClass('sfly-wgt-book-paging') || $(event.target).hasClass('sfly-wgt-page-curr-right') || $(event.target).hasClass('sfly-wgt-page-curr-left') || $(event.target).hasClass('sfly-wgt-pages') ) {
                            return;
                        }

                        var inner           = $(this).find('.sfly_wgt_product_inner');
                        var innerPosition   = inner.position();

                        var clickRange     = {
                            left: parseInt(innerPosition.left) + parseInt(inner.attr('data-left')),
                            right: parseInt(innerPosition.left) + parseInt(inner.attr('data-left')) + parseInt(inner.attr('data-orig-width')),
                            top: parseInt(innerPosition.top) + parseInt(inner.attr('data-top-size')),
                            bottom: parseInt(innerPosition.top) + parseInt(inner.attr('data-top-size')) + parseInt(inner.attr('data-real-height')) + 15
                        };

                        // Calc real position
                        var targetPos       = $(event.currentTarget).offset();
                        var mousePos        = { top: event.pageY, left: event.pageX };
                        var realPos         = { top: mousePos.top - targetPos.top, left: mousePos.left - targetPos.left };

                        if (realPos.left >= clickRange.left && realPos.left <= clickRange.right && realPos.top >= clickRange.top && realPos.top <= clickRange.bottom) {
                            var product = view_common.findProjectJsonProduct(productJson, handleCurrentPidCallback());
                            clickThrough.sendToClickThrough(product, view_common.getProduct(pId)["type"], undefined, undefined, undefined, undefined, self.Model);

                            var prodJson = view_common.getProduct(handleCurrentPidCallback());
                            tracking.track('open', 'personalize', {
                                sku: prodJson.sflySku,
                                page: self.getCurrentOpenPage()
                            });
                        }
                    });
            }

            // Will render the main book
            function renderCalendar(pId, productJson, useCurrentPage, callbackOnFinish) {
                var product     = view_common.findProjectJsonProduct(productJson, pId);
                var productType = AssetMapper.GetProductType(product);
                var partnerId   = AssetMapper.GetPartnerId(product, productType);
                handleCurrentPidCallback(pId)

                thumbGenWrapper.prepareThumbGenAssets(pId, pId, 'medium', productType, product, function (result)
                {
                    if (result == null || typeof result.layoutJson === 'undefined' || typeof result.designJson === 'undefined') {
                        console.log('>>> [Product Widget] missing layout / design json');
                        return;
                    }

                    var layoutJson = JSON.stringify(result.layoutJson);
                    var designJson = JSON.stringify(result.designJson);

                    renderThumb(pId, useCurrentPage, callbackOnFinish, productType, partnerId, product, layoutJson, designJson, result.layoutMasks);
                });
            }

            function updateWindowTitle(productJson, prodId) {
                var product         = view_common.findProjectJsonProduct(productJson, prodId);
                var pages           = typeof product.product.pages !== "undefined" ? (parseInt(product.product.pages.length) + 1) / 2 : parseInt(product.product.surfaces.length);
                var bookName        = cache.get('calendars_map')[prodId]['styleName'];
                var title           = (pages-1) + ' Months, ' + bookName;
                $('#sfly_wgt_openwin_container #sfly_wgt_sideopen_title h3').html(title);
            }

            // Will stop loading, release the global lock and show the product styles.
            function releaseLockAndStopLoading(isAfterAlbumSwitch) {
                modal_common.hideBackgroundLoading($('#sfly_wgt_openwin_container'));
                view_common.showLoading($('#sfly_wgt_openwin_container'));

                if (typeof isAfterAlbumSwitch === 'undefined') {
                    isAfterAlbumSwitch = false;
                }
                releaseLockCallback();

                view_common.removeLoading($('#sfly_wgt_container')); // remove from the side widget

                $(self.Model.get('container')).find('.sfly_wgt_product[data-pid="' + pId + '"]').removeClass('not-selected');
                self.positionSelectedArrow(pId);

                self.setIsWidgetOpen(true);

                renderCalendar(handleCurrentPidCallback(), productJson, false, function() {
                    view_common.removeLoading($('#sfly_wgt_openwin_container'));
                    modal_common.showBackgroundLoading($('#sfly_wgt_openwin_container'));
                });

                if (isAfterAlbumSwitch) {
                    updateWindowTitle(productJson, handleCurrentPidCallback());
                }

                // Render the styles at the bottom
                $('#sfly_wgt_openwin_container #sfly_wgt_sideopen_styles').empty();
                _.each(prodStyles, function (style) {
                    getPhotobookRender(style, productJson, function (styleRender) {
                        if (style == handleCurrentPidCallback()) {
                            $(styleRender).addClass('sfly-calstyle-selected');
                        }
                        $('#sfly_wgt_openwin_container').find('#sfly_wgt_sideopen_styles[data-pid="' + pId + '"]').append(styleRender);
                        $(styleRender).children('.sfly_wgt_product').on('click', function () {
                            var prodId = $(this).attr('data-pid');
                            // Same style. Do nothing.
                            if (prodId == handleCurrentPidCallback()) {
                                return;
                            }

                            modal_common.hideBackgroundLoading($('#sfly_wgt_openwin_container'));
                            view_common.showLoading($('#sfly_wgt_openwin_container'));

                            $('#sfly_wgt_openwin_container #sfly_wgt_sideopen_styles .sfly-wgt-prod-style').removeClass('sfly-calstyle-selected');
                            $(this).parent().addClass('sfly-calstyle-selected');
                            renderCalendar($(this).attr('data-pid'), productJson, true, function() {
                                updateWindowTitle(productJson, prodId);
                                view_common.removeLoading($('#sfly_wgt_openwin_container'));
                                modal_common.showBackgroundLoading($('#sfly_wgt_openwin_container'));
                            });

                            tracking.track('open', 'change_style', { sku: $(this).attr('data-sku') });
                        })
                    });
                });

                // Bind the click through button
                $('#sfly_wgt_sideopen_buttons .sfly-wgt-orange-btn-sfly').off('click').on('click', function() {
                    var product = view_common.findProjectJsonProduct(productJson, handleCurrentPidCallback());
                    clickThrough.sendToClickThrough(product, view_common.getProduct(pId)["type"], undefined, undefined, undefined, undefined, self.Model);

                    var prodJson = view_common.getProduct(handleCurrentPidCallback());
                    tracking.track('open', 'personalize', { sku: prodJson.sflySku, page: self.getCurrentOpenPage() });
                });
            }

            var product         = view_common.findProjectJsonProduct(productJson, pId);
            var pages           = typeof product.product.pages !== "undefined" ? (parseInt(product.product.pages.length) + 1) / 2 : parseInt(product.product.surfaces.length);
            var origProduct     = view_common.getProduct(pId);
            var bookName        = cache.get('calendars_map')[pId]['styleName'];
            var bookSize        = origProduct['size'];
            handleCurrentPidCallback(pId);

            var sideopen = $(view_common.renderTemplate(templates.side_calendarmodal, {
                    title: (pages-1) + ' Months' + ', ' + bookName,
                    price: config.getPrice(origProduct.sflySku),
                    products: '',
                    pid: pId,
                    size: bookSize,
                    see_all: origProduct.seeMoreUrl,
                    coupon: typeof cache.getCoupon() !== "undefined" ? cache.getCoupon().name : false
                }
            ));

            var openwinContainer = $('#sfly_wgt_openwin_container');

            changeOpenStatusCallback(true, self.closeModalAction, function(){ self.openModalAction(pId, sideopen, releaseLockAndStopLoading, forcedClose) });

            // UPP
            $('#sfly_wgt_upp_select').on('click', function(){
                function onOK(groupPhotos, isThisLife, mixedSources) {
                    if (groupPhotos.photos.length < 12){
                        modal_common.removeLoader(openwinContainer);
                        viewDisableCallback();
                        self.showNotEnoughPhotosPopup(function() {
                            modal_common.removeOverlay(openwinContainer);
                            viewDisableCallback();
                        });
                        releaseLockCallback();
                        return;
                    }

                    productJson = [];
                    function _getProductJson(pJson) {
                        if (pJson != null) {
                            // if is This Life replace photoIds in the strip with SFLY Ids
                            if(isThisLife) {
                                pJson = modal_common.replaceIdWithSFLYId(groupPhotos, pJson);
                            }
                            productJson = productJson.concat(pJson);
                        } else {
                            view_common.removeLoading(openwinContainer);
                            modal_common.showBackgroundLoading(openwinContainer);
                        }
                    }

                    $.when(
                        productProxy.getCalendar(groupPhotos, _getProductJson, true, prodStyles, isThisLife, mixedSources, true))
                        .then(function() {
                            currAlbum = groupPhotos;
                            releaseLockAndStopLoading(true);
                        })
                        .fail(function() {
                            releaseLockCallback();
                            view_common.removeLoading(openwinContainer);
                            modal_common.showBackgroundLoading(openwinContainer);
                        });

                    tracking.track('open', 'upp', { action: 'ok', sku: origProduct['sflySku'] });
                }

                function onCancel() {
                    releaseLockCallback();
                    view_common.removeLoading(openwinContainer);

                    tracking.track('open', 'upp', { action: 'cancel', sku: origProduct['sflySku'] });
                }

                tracking.track('open', 'upp', { action: 'open', sku: origProduct['sflySku'] });

                view_common.showLoading(openwinContainer);
                takeLockCallback();
                modal_common.showUPP(onOK, onCancel);
            });

            /* DISABLE ALBUM SWITCH
            modal_common.addAlbumSwitch(openwinContainer, loadedAlbums, currAlbum.albumId, function(albumId, magicSelectBox) {
                modal_common.hideBackgroundLoading(openwinContainer);
                view_common.showLoading(openwinContainer);
                takeLockCallback();

                albumSwitch.getPhotosForAlbum(albumId, function(photos) {

                    if (photos.numPhotos < 12){
                        view_common.removeLoader(openwinContainer);
                        viewDisableCallback();
                        self.showNotEnoughPhotosPopup(function() {
                            magicSelectBox.clearAllSelected();
                            view_common.removeOverlay(openwinContainer);
                            viewDisableCallback();
                        });
                        releaseLockCallback();
                        return;
                    }

                    productJson = [];
                    function _getProductJson(pJson) {
                        if (pJson != null) {
                            productJson = productJson.concat(pJson);
                        } else {
                            view_common.removeLoading(openwinContainer);
                            modal_common.showBackgroundLoading(openwinContainer);
                        }
                    }

                    var dontUseCache = albumId == currAlbum.albumId;

                    // on album switch - isManual = true

                    $.when(
                        productProxy.getCalendar(photos, _getProductJson, true, prodStyles, false, false, dontUseCache))
                        .then(function() {
                            releaseLockAndStopLoading(true);
                        })
                        .fail(function() {
                            releaseLockCallback();
                            view_common.removeLoading(openwinContainer);
                            modal_common.showBackgroundLoading(openwinContainer);
                        });
                });
            });
            */

            // Position the open/close button in the right place
            var btn = $('.sfly-wgt-btn-sidemodule');

            // When the window is just refreshed and re-rendered
            if (!self.getIsWidgetOpen()) {
                buttonCloseCallback(btn, 'prod_clicked');
            }
        };

        return function(){
            modal.call(this);

            // helper for private functions
            var self = this;

            // Will open the sliding window with the given products
            this.showProductsWindow = function(pId, album, albums, prodStyles, prodOptions, forceCloseExternal, takeLockCallback, releaseLockCallback, closeButtonCallback, changeOpenStatusCallback, handleCurrentPidCallback, viewDisableCallback) {

                function showTheCalendar(forceClose) {
                    self.setCurrentOpenPage(0);
                    var productJson = [];
                    function _getProductJson(pJson) {
                        productJson = productJson.concat(pJson);
                    }

                    $.when(
                        productProxy.getCalendar([album], _getProductJson, false, prodStyles[pId]))
                        .then(function() {
                            openSlideAndRenderBook(pId, productJson, prodStyles[pId], forceClose, albums, album, takeLockCallback, releaseLockCallback, closeButtonCallback, changeOpenStatusCallback, handleCurrentPidCallback, viewDisableCallback, self);
                        });
                }

                this.showProductsWindowFeatures(pId, album, albums, prodStyles, prodOptions, forceCloseExternal, takeLockCallback, releaseLockCallback, closeButtonCallback, changeOpenStatusCallback, handleCurrentPidCallback, viewDisableCallback, showTheCalendar);
            };
        };

        this.prototype = Object.create(modal.prototype);
    }
);

/*
 This module will be responsible to load the modal in according the product
 */

define('app/view_engine/modals/minimal/modal_manager',
    ['app/view_engine/widgets/common', 'app/view_engine/modals/minimal/modal_photobook', 'app/view_engine/modals/minimal/modal_product', 'app/view_engine/modals/minimal/modal_prints', 'app/view_engine/modals/minimal/modal_calendar'],
    function(view_common, modal_photobook, modal_product, modal_prints, modal_calendar) {

        /**
         * return the modal window of the product
         * @param boolean isClose - if is close action
         * @param string pId - pId of the product
         */
        var getProductModal = (function(){

            // defined modals
            var definedModals = {
                'photobook'     : modal_photobook,
                'product'       : modal_product,
                'calendar'      : modal_calendar,
                'deskcalendar'  : modal_calendar,
                'prints'        : modal_prints
            };

            // holder of modals per product
            var productModal = new Array();

            return function(isClose, pId){

                var productType     = isClose ? 'photobook' : view_common.getProduct(pId)['type'];
                productType         = (typeof definedModals[productType] === "undefined") ? 'product' : productType;
                var modal           = null;
                var modalObj        = definedModals[productType];

                if (modalObj !== null) {
                    if (typeof productModal[productType] === "undefined") {
                        modal = new modalObj();
                        productModal[productType] = modal;
                    } else {
                        modal = productModal[productType];
                    }
                } else {
                    throw 'modal minimal for ' + productType + ' not implemented.';
                }

                return modal;
            }
        })();

        return {
            show : function(params) {
                var modal = getProductModal(false, params.pId);
                modal.show(params);
            },

            close : function(forceCloseExternal, widgetIsOpen, callbacks) {
                var modal = getProductModal(true);
                modal.close(forceCloseExternal, widgetIsOpen, callbacks);
            }
        }
    }
);
/*
This module will include the minimal version of the modal window
 */

define('app/view_engine/modals/full/modal',
    ['underscore', 'app/templates', 'mgthumb', 'app/asset_mapper', 'app/tracking', 'magicselect', 'app/album_switch', 'app/view_engine/widgets/common', 'app/config_manager', 'app/view_engine/modals/shared', 'app/click_through', 'app/utils', 'app/cookies', 'app/cache_module','app/product_proxy'],
    function(_, templates, mgthumb, AssetMapper, tracking, magicselect, albumSwitch, view_common, config, modal_common, clickThrough, utils, cookie, cache, productProxy) {

    return function(){
        var CURRENT_OPEN_PAGE       = 0;
        var IS_WIDGET_OPEN          = false;
        var SLIDE_PROD_HEIGHT       = 300;
        var SLIDE_PRINT_HEIGHT      = 290;
        var SLIDE_CAL_HEIGHT        = 220;
        var SLIDE_CAL_12x12_HEIGHT  = 295;
        var SLIDE_CAL_DSK_HEIGHT    = 220;
        var PREV_PROD_PID           = 0;
        var MODAL_WIDTH             = 980;
        var MODAL_HEIGHT            = 640;
        var MOBILE_THRESHOLD        = 992;

        var widgetWidth             = 0;
        var widgetHeight            = 0;
        var openWidgetWidth         = 0;
        var horizontalGap           = 0;
        var winHandler              = null;
        var isMobile                = false;
        var useNewStyleGuide        = false;
        var doNotResizeImages       = false;
        var tooltipItems            = undefined;
        var textualStructure        = undefined;

        var SERVER_URL_POSTFIX      = 'productswidget/Shutterfly/sidewidget/product_maps/{0}.json';
        var SERVER_PREFIX_S3        = '//s3.amazonaws.com/magicshopfiles/';
        var SERVER_PREFIX_CDN       = 'https://d22bbwxztp2lry.cloudfront.net/';

        // Call before doing any work
        var init = function () {
            var widgetPosition      = config.getWidgetPosition();

            widgetWidth             = widgetPosition.width;
            widgetHeight            = widgetPosition.height;
            openWidgetWidth         = widgetPosition.openwidth;
            horizontalGap           = widgetPosition.horizontal;
        };

        // GETTER AND SETTER OF PRIVATE PROPRIETIES
        this.getCurrentOpenPage = function(){
            return CURRENT_OPEN_PAGE;
        };

        this.setCurrentOpenPage = function(currentOpenPage){
            CURRENT_OPEN_PAGE = currentOpenPage;
        };

        this.getIsWidgetOpen = function(){
            return IS_WIDGET_OPEN;
        };

        this.setIsWidgetOpen = function(isWidgetOpen){
            IS_WIDGET_OPEN = isWidgetOpen;
        };

        this.getSlideProdHeight = function(){
            return SLIDE_PROD_HEIGHT;
        };

        this.getPrintHeight = function() {
            return SLIDE_PRINT_HEIGHT;
        };

        this.getOpenWidgetWidth = function(){
            return openWidgetWidth;
        };
        this.getCalendarHeight = function(calType) {
            if (typeof calType !== 'undefined' && calType == 'deskcalendar') {
                return SLIDE_CAL_DSK_HEIGHT;
            } else if(typeof calType !== 'undefined' && calType == 'calendar12x12') {
                return SLIDE_CAL_12x12_HEIGHT;
            }
            return SLIDE_CAL_HEIGHT;
        };

        this.removeKeyHandler = function() {
            $('body').off('.pwidget');
        };

        this.updateIsMobile = function() {
            isMobile = $(window).width() < MOBILE_THRESHOLD;
        };

        this.bindResize = function() {
            $(window).on('resize.mg_modal', _.debounce(this.updateIsMobile.bind(this), 200));
        };

        this.unbindResize = function() {
            $(window).off('resize.mg_modal');
        };

        this.showOverlay = function() {
            if (!this.menuContainerPresent) {
                $("#sfly_wgt_full_overlay").fadeIn(200);
            }
        };

        this.hideOverlay = function() {
            if (!this.menuContainerPresent) {
                $("#sfly_wgt_full_overlay").fadeOut(200);
            }
        };

        this.showModalContainer = function() {
            if (this.menuContainerPresent) {
                $(this.Model.get('modalcontainer')).addClass('visible');
            }
        };

        /*
         Will return a random Id for use to open a new tab. Assumption: the space for 14 alphanumerics is so large we won't get collides
         @return string
         */
        this.getWindowHandlerId = function() {
            // This is a trick to get easily an alphanumeric string
            return Math.random().toString(36).substring(7) + Math.random().toString(36).substring(7);
        };

        this.openNewWindow = function(handler) {
            if (typeof handler !== 'undefined' && handler != null && !handler.closed) {
                handler.close();
            }

            return handler = window.open("","sfly_redirect_" + this.getWindowHandlerId());
        };

        this.showContainer = function(callback) {
            var openwinContainer = $('#sfly_wgt_full_openwin_container');

            openwinContainer.addClass('visible');

            if (_.isFunction(callback)) {
                callback();
            }

            this.showModalContainer();
        };

        this.hideContainer = function(callback) {
            var openwinContainer = $('#sfly_wgt_full_openwin_container');

            openwinContainer.removeClass('visible');

            if (_.isFunction(callback)) {
                callback();
            }
        };

        this.closeModalAction = function() {
            var openwinContainer = $('#sfly_wgt_full_openwin_container');

            this.hideContainer(function() {
                $('.sfly_wgt_product').removeClass('not-selected');
                view_common.removeLoading(openwinContainer);
                modal_common.hideBackgroundLoading(openwinContainer);
            });

            //openwinContainer
            //    .hide(500, function() {
            //        $('.sfly_wgt_product').removeClass('not-selected');
            //        view_common.removeLoading(openwinContainer);
            //        modal_common.hideBackgroundLoading(openwinContainer);
            //    });
            this.hideOverlay();
            this.removeLoadingFromWidget();
            utils.enableScrollBody();

            // if we switched to the real user in the modal go back to the models user
            if(cache.get('switched_to_real_user') != undefined && cache.get('switched_to_real_user')){
                cache.set('partner_user_id', '009085953279');
                //cache.set('partner_user_id', '009085953279', true);
                cache.remove('switched_to_real_user');
            }
        };

        this.removeLoadingFromWidget = function() {
            view_common.removeLoading('.sfly_wgt_listview_container');
        };

        this.reshowModalAction = function(callback) {
            var openwinContainer = $('#sfly_wgt_full_openwin_container');
            modal_common.showBackgroundLoading(openwinContainer);
            view_common.showLoading(openwinContainer);
            //openwinContainer.show(500, _.isFunction(callback) ? callback : function () {});
            this.showContainer(callback);
            this.showOverlay();

            // no need to add loading spinner on cancellation
            // view_common.showLoading('.sfly_wgt_listview_container');
            utils.disableScrollBody();
        };

        this.calcModalWidth = function(maxWidth) {
            var minWidth = 400;
            var effectiveWindowWidth = window.innerWidth < 600 ? window.innerWidth : 0.9 * window.innerWidth;
            return Math.min(Math.max(Math.floor(effectiveWindowWidth), minWidth), maxWidth);
        };

        this.isMobile = function() {
            if (typeof ThisLife !== "undefined" && ThisLife.hasOwnProperty('app') && ThisLife.app.hasOwnProperty('isMobile')) {
                return ThisLife.app.isMobile;
            }
            return false;
        };

        this.openModalAction = function(pId, content, openCallBack, forcedClose) {
            var openwinContainer = $('#sfly_wgt_full_openwin_container');

            if (utils.isMobile) {
                openwinContainer.css('width', "100%");
                var topMargin = $("#tl_primary_bar").height() + 1; // + $("#tl_secondary_bar").height();
                openwinContainer.css('top', topMargin + "px");
                openwinContainer.css('height', "calc( 100% - " + topMargin + "px )");
            } else {
                var modalWidth;
                var modalHeight;
                if (this.menuContainerPresent) {
                    openwinContainer.css('width','100%','height','100%');
                } else {
                    modalWidth = this.calcModalWidth(MODAL_WIDTH);
                    modalHeight = MODAL_HEIGHT;
                    openwinContainer.width(modalWidth).height(modalHeight);
                }


                openwinContainer.removeClass('sfly-wgt-modal-small-titles sfly-wgt-modal-x-small-titles');
                if (modalWidth < 600) {
                    openwinContainer.addClass('sfly-wgt-modal-x-small-titles');
                } else if (modalWidth < 800) {
                    openwinContainer.addClass('sfly-wgt-modal-small-titles');
                }
                this.showOverlay();
            }


            if (!openwinContainer.hasClass('visible') || forcedClose) {
                openwinContainer
                    .html(content)
                    .attr('data-pid', pId);
                this.showContainer(openCallBack);
            } else {
                openwinContainer
                    .html(content)
                    .attr('data-pid', pId);
                openCallBack();
            }

            if(utils.isMobile){
                content.find('#sfly_wg_sideopen_close > .sfly-wgt-qst-mark').css({"width": "20px", "height": "20px", "background-position": "25%"});
            }

            utils.disableScrollBody();

            // TEMP STORE FIX
            if (cache.get('mode') == 'store') {
                this.hideUppButton();
            }
        };

        this.renderAndOpenModalAction = function(pId, content, openCallBack, forcedClose){
            var openwinContainer = $('#sfly_wgt_full_openwin_container');
            var that = this;
            //openwinContainer.css('height','80%').css('top','10%').css('margin-top','auto');
            if (utils.isMobile) {
                openwinContainer.css('width',"100%");
                var topMargin = $("#tl_primary_bar").height() + 1; // + $("#tl_secondary_bar").height();
                openwinContainer.css('top',topMargin+"px");
                openwinContainer.css('height',"calc( 100% - " + topMargin + "px )");
            } else {
                var containerWidth;
                var containerHeight;
                if (this.menuContainerPresent) {
                    openwinContainer.css('width','100%','height','100%');
                } else {
                    var minModalWidth = 320;
                    containerWidth = this.calcModalWidth(1400);
                    containerHeight = MODAL_HEIGHT;
                    openwinContainer.css('width',containerWidth+"px");
                    openwinContainer.css('height',containerHeight+"px");
                }

                openwinContainer.removeClass('sfly-wgt-modal-small-titles sfly-wgt-modal-x-small-titles');
                if (containerWidth < 600) {
                    openwinContainer.addClass('sfly-wgt-modal-x-small-titles');
                } else if (containerWidth < 800) {
                    openwinContainer.addClass('sfly-wgt-modal-small-titles');
                }
                this.showOverlay();
            }


            if (!openwinContainer.hasClass('visible') || forcedClose) {
                openCallBack(function(renderProductsCallBack){
                    openwinContainer
                        .html(content)
                        .attr('data-pid', pId);

                    that.showContainer(function() {
                        if(utils.isMobile){
                            content.find('#sfly_wg_sideopen_close > .sfly-wgt-qst-mark').css({"width": "20px", "height": "20px", "background-position": "25%"});
                        }
                        if(_.isFunction(renderProductsCallBack)){
                            renderProductsCallBack();
                        }
                    });
                });
            } else {
                openCallBack(function(renderProductsCallBack){
                    openwinContainer
                        .html(content);
                    if(utils.isMobile){
                        content.find('#sfly_wg_sideopen_close > .sfly-wgt-qst-mark').css({"width": "20px", "height": "20px", "background-position": "25%"});
                    }
                    if(_.isFunction(renderProductsCallBack)){
                        renderProductsCallBack();
                    }
                });

            }
            utils.disableScrollBody();

            // TEMP STORE FIX
            if (cache.get('mode') == 'store') {
                this.hideUppButton();
            }
        };

        this.showNotEnoughPhotosPopup = function(closeButtonCallback) {
            $('#sfly-wgt-popup-disable-overlay, #sfly_wgt_no_enough_photos_bubble').show();
            //$('#sfly_wgt_upp_select').removeClass('sfly-wgt-gray-btn-sfly').addClass('sfly-wgt-gray-dark-btn-sfly');
            /*
            $('#sfly_wgt_no_enough_photos_button .sfly-wgt-orange-btn-sfly').off().on('click', function() {
                if (_.isFunction(closeButtonCallback)) {
                    closeButtonCallback();
                }
                $('#sfly_wgt_no_enough_photos_popup').hide();
            })
            */
        };

        this.hideNotEnoughPhotosPopup = function() {
            $('#sfly-wgt-popup-disable-overlay, #sfly_wgt_no_enough_photos_bubble').hide();
            //$('#sfly_wgt_upp_select').removeClass('sfly-wgt-gray-dark-btn-sfly').addClass('sfly-wgt-gray-btn-sfly');
        };

        this.isNotEnoughPhotosPopup = function(){
            return $('#sfly-wgt-popup-disable-overlay').is(':visible');
        };

        // show new upp bubble if we don't have a cookie
        this.showNewBubblePop = function(sideopen, prodType) {
            var prodType = prodType || 'products';
            return;
            // todo: remove this. temp fix to remove the pop for the store
            if (cache.get('partner_user_id') == '009085953279' || (!cookie.cookieExists("sfly_wgt_new_upp") && cache.get('mode') != 'store' && cache.get('mode') != 'instance')) {
                var hideNewBobblePopup = function () {
                    if(cache.get('partner_user_id') != '009085953279'){
                        cookie.setCookie("sfly_wgt_new_upp", 1, 26280);
                    }
                    //$('#sfly_wgt_upp_select').removeClass('sfly-wgt-gray-dark-btn-sfly').addClass('sfly-wgt-gray-btn-sfly');
                    $('.sfly_wgt_bubble_new_upp').hide();
                };
                var popup = $(view_common.renderTemplate(templates.new_upp_bubble));
                var rightMargin = {
                    "book": 375,
                    "calendar": 355,
                    "prints": 275
                }
                if (typeof rightMargin[prodType] !== "undefined") {
                    popup.css('right', rightMargin[prodType] + "px");
                }
                //remove popup when in gifting mode
                if(cache.get('mode') != 'gifting') {
                    sideopen.append(popup);
                }
                //sideopen.find('#sfly_wgt_upp_select').on('click', hideNewBobblePopup).removeClass('sfly-wgt-gray-btn-sfly').addClass('sfly-wgt-gray-dark-btn-sfly');
                popup.find('.sfly-wgt-orange-btn-sfly').on('click', hideNewBobblePopup);
            }
        };

        // Will update the product size by the given targetHeight, maintaing the ratio.
        this.updateProductSizeByHeight = function(elem, targetHeight, pId, productJson, isFullView) {
            var isFullView          = isFullView || false;
            var container           = $(elem).find('.sfly_wgt_product_inner');
            var canvas              = container.children('canvas');
            var size                = view_common.getProductRealSize(productJson, pId);
            var ratio               = isFullView ? 1 : targetHeight / size.realHeight;
            var targetRealHeight    = isFullView ? size.origHeight : targetHeight + (size.bottom + size.top) * ratio;
            var targetRealWidth     = size.origWidth * ratio;
            var prodTop             = size.top * ratio;
            var prodBottom          = size.bottom * ratio;
            var prodLeft            = size.left * ratio;
            var prodRight           = size.right * ratio;
            var prodOrigWidth       = size.width * ratio;

            var product = view_common.getProduct(pId);

            if (product.type == 'photobook') {
                var prodSize = pId.split('_')[1];
                var sizes = config.getProductSizes()['photobook'][prodSize + '_sprite']; // Get the full spread size

                targetRealWidth = sizes.width * ratio; // Zoom the width with same ratio as height

                prodTop         = sizes.top*ratio;
                prodBottom      = sizes.bottom*ratio;
                prodLeft        = sizes.left*ratio;
                prodRight       = sizes.right*ratio;
                prodOrigWidth   = (sizes.width - sizes.left - sizes.right)*ratio;
            }

            container
                .height(targetRealHeight)
                .width(targetRealWidth)
                .attr('data-height',        targetRealHeight)
                .attr('data-width',         targetRealWidth)
                .attr('data-real-height',   targetHeight)
                .attr('data-real-width',    size.origWidth * ratio)
                .attr('data-orig-width',    prodOrigWidth)
                .attr('data-top-size',      prodTop)
                .attr('data-bottom',        prodBottom)
                .attr('data-left',          prodLeft)
                .attr('data-right',         prodRight);

            return targetRealWidth;
        };

        // Will update the product size by the given targetHeight, maintaing the ratio.
        this.updateProductSizeByContainer = function(elem, containerWidth, containerHeight, pId, productJson) {
            var container           = $(elem).find('.sfly_wgt_product_inner');
            var canvas              = container.children('canvas');
            var size                = view_common.getProductRealSize(productJson, pId);
            var ratioWidth          = containerWidth / size.origWidth;
            var ratioHeight         = containerHeight / size.height;
            var ratio               = Math.min(ratioWidth, ratioHeight);
            var targetRealHeight    = size.height * ratio;
            var targetRealWidth     = size.origWidth * ratio;
            var prodTop             = size.top*ratio;
            var prodBottom          = size.bottom*ratio;
            var prodLeft            = size.left*ratio;
            var prodRight           = size.right*ratio;
            var prodWidth           = size.width*ratio;
            var prodHeight          = size.realHeight*ratio;

            container
                .height(targetRealHeight)
                .width(targetRealWidth)
                .attr('data-height',        targetRealHeight)
                .attr('data-width',         targetRealWidth)
                .attr('data-top',           prodTop)
                .attr('data-bottom',        prodBottom)
                .attr('data-left',          prodLeft)
                .attr('data-right',         prodRight)
                .attr('data-prod-width',    prodWidth)
                .attr('data-prod-height',   prodHeight);

            return targetRealWidth;
        };

        this.hideUppButton = function() {
            $('#sfly_wgt_full_openwin_container #sfly_wgt_upp_select').hide();
        };

        // Will position the little arrow that shows the currently selected book
        this.positionSelectedArrow = function(pId) {
            var selectedProduct     = $(this.Model.get('container')).find('.sfly_wgt_product[data-pid="' + pId + '"]');

            if (selectedProduct.length > 0) {

                var ProductCenter = selectedProduct.position().top + Math.floor($(selectedProduct).height() / 2);
                var prevProductCenter = 10;

                if (PREV_PROD_PID !== null) {
                    var prevProduct = $(this.Model.get('container')).find('.sfly_wgt_product[data-pid="' + PREV_PROD_PID + '"]');
                    // This is a fix for books. When a style is chosen the PREV_PROD_PID will be that style, though it will not be found
                    if (prevProduct.length > 0) {
                        prevProductCenter = prevProduct.position().top + Math.floor($(selectedProduct).height() / 2);
                    }
                }

                $('#sfly_wgt_openwin_container').find('.sfly_wgt_arrow_book').css('top', prevProductCenter + 'px').animate({top: ProductCenter}, 500);
            }
        };

        this.enableTabSwitching = function () {
            $(".sfly_wgt_sideopen_bottompart_tab").on('click', function () {
                var clickedTab = this;

                if (!$(clickedTab).hasClass('sfly_wgt_tab_active')) {
                    var activeClassStr = 'sfly_wgt_tab_active';
                    $('.sfly_wgt_sideopen_bottompart_tab').removeClass(activeClassStr);
                    $('.sfly_wgt_sideopen_bottompart_tab_content').removeClass(activeClassStr);
                    $("#" + clickedTab.id).addClass(activeClassStr);
                    $("#" + clickedTab.id + "_content").addClass(activeClassStr);
                }

            });
        };

        this.initTooltip = function (tooltipContainer) {
            var tooltipContainerBackground = $('#sfly_wgt_tooltip_container_background');
            var tooltipHoverArea = $('.sfly_wgt_tooltip_hover_area');

            var showTooltip = function() {
                tooltipContainer.css('display', 'inline-block');
                tooltipContainerBackground.show();
                tooltipHoverArea.addClass('force-hover');
            };

            var hideTooltip = function() {
                tooltipContainer.hide();
                tooltipContainerBackground.hide();
                tooltipHoverArea.removeClass('force-hover');
            };

            tooltipContainerBackground.on('click', function(e){
                e.stopPropagation();
                hideTooltip();
            });

            tooltipHoverArea.on('click', function(e) {
                e.stopPropagation();
                if (tooltipContainer.is(":visible")) {
                    hideTooltip();
                } else {
                    showTooltip();
                }

            });



        };

        this.setPromo = function(containerElement) {
            var renderPromo = function(response) {
                if (typeof response !== 'undefined') {
                    $(containerElement).html(response);
                    var aTag = $( "a" );
                    $(containerElement).find(aTag).on('click', function (e) {
                        e.preventDefault();
                        clickThrough.redirectTo('special-offers');
                    });
                }
            };

            productProxy.getSflyPromos(this.Model.get('prod_type'), false).then(function(response){
                if (response && response !== "") {
                    renderPromo(response);
                } else {
                    // hide promo container if no promo returned
                    $(".magicshop_modal_promo_bar").hide();
                    $(".magicshop_modal_content_wrapper").css("height","100%");
                }

            });
        };

        // Will handle the functionalities of the window
        this.showProductsWindowFeatures = function(pId, album, albums, prodStyles, prodOptions, forceCloseExternal, takeLockCallback, releaseLockCallback, closeButtonCallback, changeOpenStatusCallback, handleCurrentPidCallback, viewDisableCallback, productCallBack) {
            var forceClose = IS_WIDGET_OPEN;
            var self = this;
            var fullWinContainer = $('#sfly_wgt_full_openwin_container'); // for caching

            if (typeof forceCloseExternal !== 'undefined' && forceCloseExternal) {
                forceClose = true;
            } else if (handleCurrentPidCallback() != pId) {
                // Clicked on another book, Just replace the contents and don't close
                modal_common.hideBackgroundLoading(fullWinContainer);
                view_common.showLoading(fullWinContainer);
                forceClose = false;
            }

            function cleanMySlate() {
                $(fullWinContainer).find('#sfly_wgt_sideopen_container > #sfly_wgt_sideopen_products').empty();
                $(fullWinContainer).find('#sfly_wgt_sideopen_container > #sfly_wgt_sideopen_products_container').empty();
            }

            if (forceClose) {
                // Close the button
                var btn = $('.sfly-wgt-btn-sidemodule');
                closeButtonCallback(btn, 'wgt_force_close');

                // Close the window
                changeOpenStatusCallback(false, self.closeModalAction.bind(self));

                // All animations take 200ms - for the state to propagate it will take 200+ms. We want to wait for the status to propagate.
                setTimeout(releaseLockCallback, 200);

                self.removeKeyHandler();

                return;
            }

            // Show the background
            $('#sfly_wgt_full_overlay').off().on('click', function() {
                // Close the button
                var btn = $('.sfly-wgt-btn-sidemodule');
                closeButtonCallback(btn, 'wgt_force_close');

                self.removeKeyHandler();

                // Close the window
                changeOpenStatusCallback(false, self.closeModalAction.bind(self));

                // All animations take 200ms - for the state to propagate it will take 200+ms. We want to wait for the status to propagate.
                setTimeout(releaseLockCallback, 200);
                $(this).fadeOut(200);

                cleanMySlate();

                if (self.isAfterUPP && _.isFunction(self.Model.get('Callback'))) {
                    self.Model.get('Callback')({action: 'close_modal'});
                }
            });

            // close button in popup
            fullWinContainer.off().on('click', '#sfly_wg_sideopen_close', function(){
                // Close the button
                var btn = $('.sfly-wgt-btn-sidemodule');
                closeButtonCallback(btn, 'wgt_force_close');

                self.removeKeyHandler();

                // Close the window
                changeOpenStatusCallback(false, self.closeModalAction.bind(self));

                // All animations take 200ms - for the state to propagate it will take 200+ms. We want to wait for the status to propagate.
                setTimeout(releaseLockCallback, 200);
                self.hideOverlay();

                cleanMySlate();

                if (self.isAfterUPP && _.isFunction(self.Model.get('Callback'))) {
                    self.Model.get('Callback')({action: 'close_modal'});
                }
            });

            productCallBack(forceClose);
        };

        this.augmentTracking = function(baseParams, model) {
            var params = _.clone(baseParams);
            if (model.get('prod_type') !== null) {
                params = _.extend(params, {
                    "mode": cache.get('mode'),
                    "prod_type": model.get('prod_type')
                });
            }
            return params;
        };

        this.getAssociationSkus = function(params) {
            var env = (typeof cache.get('env') !== 'undefined') ? cache.get('env') : 'beta';
            var SERVER_PREFIX = ((env == 'prod' || env == 'stage') ? SERVER_PREFIX_CDN : SERVER_PREFIX_S3);
            var FILE_URL = SERVER_PREFIX + utils.formatString(SERVER_URL_POSTFIX, params.prodType);

            $.ajax({
                dataType: "json",
                url: FILE_URL,
                success: function(response) {
                    if (_.isFunction(params.callback)) {
                        params.callback(response);
                    }
                },
                error : function(jqXHR, textStatus, errorThrown ) {
                    console.log('[Product Widget] Error loading more SKUs for Modal');
                    if (_.isFunction(params.failCallback)) {
                        params.failCallback();
                    }
                }
            });
        };

        // this is the main function for show a product modal (has to be override in each product modal)
        this.showProductsWindow = function(pId, album, albums, prodStyles, prodOptions, forceCloseExternal, isThisLife, mixedSources, takeLockCallback, releaseLockCallback, closeButtonCallback, changeOpenStatusCallback, handleCurrentPidCallback) {
            throw 'modal full not implemented.';
        };

        this.show = function(params) {
            try{init()}catch (e){}
            IS_WIDGET_OPEN  = params.widgetIsOpen;
            PREV_PROD_PID   = params.currPid;
            useNewStyleGuide = params.useNewStyleGuide || useNewStyleGuide;
            doNotResizeImages = params.doNotResizeImages || doNotResizeImages;
            tooltipItems = params.tooltipItems || tooltipItems;
            textualStructure = params.textualStructure || textualStructure;

            //this.settingsInstance = typeof params.instance !== 'undefined' ? params.instance.settings : settings;
            this.Model = params.model;
            this.sessionToken = params.sessionToken;
            this.menuContainerPresent = (typeof this.Model.get('modalcontainer') !== 'undefined' && this.Model.get('modalcontainer') != null);

            if (this.menuContainerPresent) {
                // allow reopening/reloading the same product in the modal
                if (IS_WIDGET_OPEN) {
                    IS_WIDGET_OPEN = false;
                }
                var promoElement = this.Model.get('modalContainerPromoElement');
                this.setPromo(promoElement);
                var openwinContainer = $('#sfly_wgt_full_openwin_container');
                view_common.showLoading(openwinContainer);
                this.showContainer();
            }

            // this.bindResize();
            //this.removeLoadingFromWidget();
            this.showProductsWindow(params.pId, params.currAlbum, params.albums, params.prodStyles, params.prodOptions, params.forceCloseExternal, params.isThisLife, useNewStyleGuide, doNotResizeImages, tooltipItems, textualStructure, params.mixedSources, modal_common.callbackWrapper(params.callbacks.takeLock), modal_common.callbackWrapper(params.callbacks.releaseLock), modal_common.callbackWrapper(params.callbacks.animateControlButton), modal_common.callbackWrapper(params.callbacks.changeState), modal_common.callbackWrapper(params.callbacks.handleCurrentPid), modal_common.callbackWrapper(params.callbacks.toggleViewDisable));
        };

        this.close = function(forceCloseExternal, widgetIsOpen, callbacks) {
            try{init()}catch (e){}
            this.removeKeyHandler();
            IS_WIDGET_OPEN = widgetIsOpen;

            // this.unbindResize();
            this.showProductsWindowFeatures(null, null, null, null, forceCloseExternal, modal_common.callbackWrapper(callbacks.takeLock), modal_common.callbackWrapper(callbacks.releaseLock), modal_common.callbackWrapper(callbacks.animateControlButton), modal_common.callbackWrapper(callbacks.changeState), modal_common.callbackWrapper(callbacks.handleCurrentPid));
        };
    };
});
/*
 This module will include the full version of the modal window for photobook
 */

define('app/view_engine/modals/full/modal_photobook',
    ['underscore', 'app/templates', 'mgthumb', 'app/asset_mapper', 'app/tracking', 'magicselect', 'app/product_proxy', 'app/view_engine/widgets/common', 'app/config_manager', 'app/view_engine/modals/shared', 'app/click_through', 'app/cache_module', 'app/view_engine/modals/full/modal', 'app/thumbgen_wrapper', 'app/time_monitor', 'app/utils', 'app/globals'],
    function(_, templates, mgthumb, AssetMapper, tracking, magicselect, productProxy, view_common, config, modal_common, clickThrough, cache, modal, thumbGenWrapper, monitor, utils, globals) {

        var isThisLifeGeneral = false;
        var mixedSourcesGeneral = false;
        var thisLifePhotoMapping;
        var useNewStyleGuide;
        var doNotResizeImages;
        var manualSelect = false;
        var isStoryBook = false;
        var manualSelectEnter = manualSelect;
        var mobileRenderingOnMenuContainer = false;
        var currentOpenPid = null;

        // Will render all pages for a book in the given container
        var renderBookAndPrints = function(pId, productType, container, mgThumbGen, productJson, pageToShow, masks, self, renderCallBack, wrapCoverCallback) {

            if (typeof pageToShow === 'undefined') {
                pageToShow = 0;
            }

            // We need this function to keep the right order inside the generate function
            function _generate(order, showBookCallBack) {
                // Check if page already generated
                if ($(container).children('canvas[data-order="' + order + '"]').length > 0) {
                    showBookCallBack();
                    return;
                }

                mgThumbGen.generate(parseInt(order), pId, true, function(canvas) {
                    $(canvas).attr('data-order', order).hide();
                    $(container).append(canvas);

                    if (order == 0 && _.isFunction(wrapCoverCallback)) {
                        wrapCoverCallback();
                    }

                    if (pageToShow == order || self.getCurrentOpenPage() == order) {
                        $(container).find('canvas').hide();
                        $(canvas).show();
                    }
                    showBookCallBack();
                }, true, { masks: masks, textEnabled:(productType !== "book") });
            }

            if (!$(container).attr('data-rendered')) {
                // Put this first - to block more attempts to render
                $(container).attr('data-rendered', true);

                var product = view_common.findProjectJsonProduct(productJson, pId);
                var numOfPages;
                if (productType == "book") {
                    numOfPages = Math.floor((product.book.pages.length) / 2) + 2;
                } else {
                    numOfPages = parseInt(product.prints.pages.length);
                }

                $(container).attr('data-pages', numOfPages);

                var numRenderedPages = 0;
                var showBook = function(){
                    numRenderedPages++;
                    if(numRenderedPages == numOfPages-1){
                        renderCallBack();
                    }
                };

                if (utils.isMobile || mobileRenderingOnMenuContainer) {
                    _generate(0, showBook);
                } else {
                    for(var i = 0; i < numOfPages; i++) {
                        if(i == pageToShow){
                            view_common.removeLoading($('#sfly_wgt_full_openwin_container'));
                            modal_common.showBackgroundLoading($('#sfly_wgt_full_openwin_container'));
                            continue;
                        }
                        _generate((i == numOfPages-1 && productType == "book") ? 99 : i, showBook);
                    }
                }

            }
        };

        // Render the navigation template for the calendar product
        var renderBookAndPrintsNavigation = function(pId, productType, container, productJson, position, containerExtraTop, pageToShow, calcFixedPos) {
            var MAX_BOOK_NAV    = 400;
            var MAX_BOOK_BOX    = 40;
            var MAX_PRINTS_NAV  = 230;
            var MAX_PRINTS_BOX  = 30;
            var MIN_PAGES       = 5;

            if (typeof pageToShow === 'undefined') {
                pageToShow = -1;
            }

            if ($(container).find('.sfly-wgt-book-nav').length == 0) {
                var product = view_common.findProjectJsonProduct(productJson, pId);
                var numOfPages;
                if (productType == "book") {
                    numOfPages = Math.floor((product.book.pages.length) / 2) + 2;
                } else {
                    numOfPages = parseInt(product.prints.pages.length);
                }

                // Calculate the boxes size
                var boxSize;
                if (productType == "book") {
                    boxSize = MAX_BOOK_NAV / numOfPages > MAX_BOOK_BOX ? MAX_BOOK_BOX : MAX_BOOK_NAV / numOfPages;
                } else {
                    boxSize = MAX_PRINTS_NAV / numOfPages > MAX_PRINTS_BOX ? MAX_PRINTS_BOX : MAX_PRINTS_NAV / numOfPages;
                }

                var display = 'block';
                var nav     = view_common.renderTemplate(templates.book_nav, { pages: numOfPages, type: productType, currPage: pageToShow });
                var paging  = view_common.renderTemplate(templates.side_book_paging, { pages: numOfPages });
                $(container).append(paging).append(nav);

                var totalspace = boxSize*(numOfPages - 1) + 61;
                var leftFix = totalspace / 2;

                $(container).find('.sfly-wgt-book-nav')
                    .css('width', totalspace +'px')
                    .attr('data-width', totalspace)
                    .attr('data-show-nav', display == 'block' ? 'true' : 'false')
                    .find('li > div').css('width', boxSize + 'px');

                if (calcFixedPos) {
                    $(container).find('.sfly-wgt-book-nav')
                        .css('left', (position.left - leftFix)+'px')
                        .css('top', (position.top + 35)+'px');

                    $(container).find('.sfly-wgt-book-paging')
                        .css('top', (position.top + 50)+'px')
                        .css('left', (position.left - 56) + 'px'); // width = 112px
                }


                if (containerExtraTop > 0) {
                    var origTop = parseInt($(container).css('top'));
                    var newTop = origTop + containerExtraTop;
                    $(container).css('top', newTop + 'px');
                }
            }
        };

        // Slide the book window into view and render the view
        var openSlideAndRenderBook = function(pId, productJson, prodStyles, prodOptions, forcedClose, loadedAlbums, currAlbum, takeLockCallback, releaseLockCallback, buttonCloseCallback, changeOpenStatusCallback, handleCurrentPidCallback, viewDisableCallback, self, setCurrentPage) {

            // Will render book styles
            function getPhotobookRender(pId, productJson, callback) {
                var prod = view_common.getProduct(pId);

                var elem = $(view_common.renderTemplate(templates.side_style_product, { pid: pId, sku: prod['sfly_sku'], ptype: 'book', title: prod["styleName"] }));
                var wrapper = $('<div class="sfly-wgt-prod-style"></div>');
                elem.children('.sfly_wgt_product_inner').html('<img src="' + prod['static'] + '" class="sfly-img-spread" />');
                elem.css('width', '100px');
                wrapper.html(elem);


                // respnsive calculations
                var newStyleContainerWidth = $("#sfly_wgt_sideopen_styles_container").width();

                var baseWidth = wrapper.width() || 110;
                var baseMargin = parseInt(wrapper.css('margin-right')) || 15;
                var numOfElements = Math.floor(newStyleContainerWidth / (baseWidth + baseMargin));

                if (utils.isMobile) {
                    newStyleContainerWidth -=20;
                    numOfElements = Math.ceil(newStyleContainerWidth / (baseWidth + baseMargin)) - 1 + 0.5;
                }
                var newMargin =  Math.floor((newStyleContainerWidth - numOfElements * (baseWidth+baseMargin)) / numOfElements + baseMargin);
                wrapper.css('margin-right', newMargin + "px");

                if (_.isFunction(callback)) {
                    callback(wrapper);
                }
            }

            function renderThumb(pId, useCurrentPage, callbackOnFinish, productType, partnerId, product, layoutJson, designJson, layoutMasks) {
                var useCDN = cache.get('env') != 'beta' && cache.get('env') != 'dev';
                var mgThumbGen  = new MgThumbGenerator(cache.get('env'),useCDN);

                mgThumbGen.init(productType, partnerId, product, layoutJson, designJson, self.Model.get('monitoring').reportEvent, cache.get('env'), doNotResizeImages);

                useCurrentPage  = self.Model.attributes.isStoryBook ? 0 : useCurrentPage;
                var currPage = useCurrentPage ? self.getCurrentOpenPage() : 0;
                mgThumbGen.generate(currPage, pId, true, function(canvas) {
                    var elem = $(view_common.renderTemplate(templates.fullview_product, { pid: pId, sku: view_common.getProduct(pId)['sfly_sku'], ptype: productType }));
                    $(canvas).attr('data-order', currPage);
                    elem.children('.sfly_wgt_product_inner').html(canvas);
                    $(sideopen).find('#sfly_wgt_sideopen_products').html(elem);

                    var origHeight = self.getSlideProdHeight();
                    var targetHeight =  origHeight;

                    var modalWidth = $("#sfly_wgt_sideopen_container").width();
                    if (modalWidth && modalWidth < 980) {
                        targetHeight = Math.floor(targetHeight * modalWidth / 980);
                    }

                    var pTargetSize;

                    if (utils.isMobile || mobileRenderingOnMenuContainer) {
                        pTargetSize = self.updateProductSizeByContainer(elem, modalWidth, modalWidth, pId, productJson);
                    } else {
                        pTargetSize = self.updateProductSizeByHeight(elem, targetHeight, pId, productJson);
                    }

                    if (utils.isMobile || mobileRenderingOnMenuContainer) {
                        // Center the product
                        var bookRight = elem.children('.sfly_wgt_product_inner').attr('data-right');
                        var bookLeft = elem.children('.sfly_wgt_product_inner').attr('data-left');

                        var bookLeftPos = Math.floor((bookRight - bookLeft)/2);

                        var bookTop = elem.children('.sfly_wgt_product_inner').attr('data-top');
                        var bookBottom = elem.children('.sfly_wgt_product_inner').attr('data-bottom');
                        var hostHeight = $(sideopen).find('#sfly_wgt_sideopen_products').height();
                        var bookHeight = parseFloat(elem.children('.sfly_wgt_product_inner').attr('data-height'));
                        var topPosFactor = 0.5;
                        var bookTopPos = topPosFactor * (Math.floor((hostHeight-bookHeight)/2) + Math.floor((bookBottom-bookTop)/2));

                        if (mobileRenderingOnMenuContainer) {
                            elem.children('.sfly_wgt_product_inner').css('left', bookLeftPos+'px');
                        } else {
                            elem.children('.sfly_wgt_product_inner').css('left', bookLeftPos+'px').css('top', bookTopPos+'px');
                        }

                        // adjust 'Personalize' button:
                        var spaceBelowBook = hostHeight - bookTopPos - bookHeight ;
                        var buttonTopPos;
                        if (mobileRenderingOnMenuContainer) {
                            buttonTopPos = bookTopPos + bookHeight + spaceBelowBook/2 - 100;
                            buttonTopPos = Math.round(100*buttonTopPos / hostHeight) + 10;
                            //$(sideopen).find('#sfly_wgt_upp').css('top', buttonTopPos+'%');
                            // fix for mobile catalog
                            $(sideopen).find('#sfly_wgt_upp').css('bottom', '100px');
                        } else {
                            buttonTopPos = $(sideopen).find('#sfly_wgt_sideopen_title').height() + bookTopPos + bookHeight + spaceBelowBook/2 ;
                            $(sideopen).find('#sfly_wgt_upp').css('top', buttonTopPos+'px');
                        }

                        $(sideopen).find('#sfly_wgt_upp .sfly-wgt-orange-btn-sfly').show();
                    } else if (self.menuContainerPresent) {
                        // use css positioning
                    } else {
                        // Center the product
                        var bookWidth = elem.children('.sfly_wgt_product_inner').attr('data-width');
                        var hostWidth = $(sideopen).parent().width();
                        var bookLeftPos = Math.floor(hostWidth/2) - Math.floor(bookWidth/2);
                        $(sideopen).find('#sfly_wgt_sideopen_products').css('left', bookLeftPos+'px');
                    }


                    var wrapped = false;
                    var wrapCoverAndCenter = function(){
                        if (!wrapped) {
                            var widthCover = elem.children('.sfly_wgt_product_inner').attr('data-real-width');
                            var heightCover = elem.children('.sfly_wgt_product_inner').attr('data-height');
                            var topHeight = 0;

                            if(bookSize == "11x14")
                            {
                                widthCover *= 1.05;
                                heightCover *= 1.05;
                                topHeight = -1*heightCover*5/100;
                            }

                            var coverLeft = pTargetSize / 2 - widthCover / 2 - 37; // The 20px is a temp fix for aligning the cover
                            elem.children('.sfly_wgt_product_inner').find("canvas[data-order='0']").wrap('<div class="sfly-wgt-book-cover-wrapper" style="width:' + widthCover + 'px;height:' + heightCover + 'px;overflow:hidden;position:absolute;top:'+topHeight+'px;left:' + coverLeft + 'px;" data-width="' + widthCover + '" data-height="' + heightCover + '"></div>');
                            wrapped = true;
                        }
                    };

                    if (currPage == 0 && productType == "book") {
                        wrapCoverAndCenter();
                    }

                    var showBookRendered = function(){
                        wrapCoverAndCenter();
                        $(sideopen).find('#sfly_wgt_sideopen_products').show();
                        modal_common.hideBackgroundLoading($('#sfly_wgt_full_openwin_container'));
                        /* disabled callback on finish in order to avoid remove loading not wanted
                        if (_.isFunction(callbackOnFinish)) {
                            callbackOnFinish();
                        }
                        */
                    };

                    var containerExtraTop = Math.floor((origHeight - targetHeight) / 2);
                    var calcFixedPositioning = true;
                    var scrollAndClickEnabled = true;
                    if (self.menuContainerPresent) {
                        containerExtraTop = 0;
                        calcFixedPositioning = false;
                        scrollAndClickEnabled = false;
                    }
                    renderBookAndPrints(pId, 'book', elem.children('.sfly_wgt_product_inner'), mgThumbGen, productJson, currPage, layoutMasks, self, showBookRendered, wrapCoverAndCenter);
                    if (utils.isMobile) {
                        view_common.removeLoading($('#sfly_wgt_full_openwin_container'));
                        return;
                    }
                    renderBookAndPrintsNavigation(pId, 'book', $(sideopen).find('#sfly_wgt_sideopen_products'), productJson, { left: pTargetSize/2, top: targetHeight }, containerExtraTop, useCurrentPage ? self.getCurrentOpenPage() : -1, calcFixedPositioning);

                    if (!useCurrentPage) {
                        self.setCurrentOpenPage(0);
                    } else {
                        var bookPages = Math.floor((product.book.pages.length-1)/2) + 2;
                        modal_common.setPagesCount(sideopen, self.getCurrentOpenPage(), bookPages);
                    }

                    modal_common.setArrowPagingClass(sideopen, self.getCurrentOpenPage(), 99);
                    view_common.removeLoading($('#sfly_wgt_full_openwin_container'));
                    modal_common.showBackgroundLoading($('#sfly_wgt_full_openwin_container'));

                    var isClickAfterDrag = false;
                    var inner = elem.children('.sfly_wgt_product_inner');
                    var sflySku = view_common.getProduct(pId)['sflySku'];


                    inner.on('mousemove', function(event) {
                        var innerPosition   = inner.position();
                        var clickRange     = {
                            left: parseInt(innerPosition.left) + parseInt(inner.attr('data-left')),
                            right: parseInt(innerPosition.left) + parseInt(inner.attr('data-left')) + parseInt(inner.attr('data-orig-width')),
                            top: parseInt(innerPosition.top) + parseInt(inner.attr('data-top-size')),
                            bottom: parseInt(innerPosition.top) + parseInt(inner.attr('data-top-size')) + parseInt(inner.attr('data-real-height')) + 15
                        };

                        // Calc real position
                        var targetPos       = $(event.currentTarget).offset();
                        var mousePos        = { top: event.pageY, left: event.pageX };
                        var realPos         = { top: mousePos.top - targetPos.top, left: mousePos.left - targetPos.left };

                        if (scrollAndClickEnabled && realPos.left >= clickRange.left && realPos.left <= clickRange.right && realPos.top >= clickRange.top && realPos.top <= clickRange.bottom) {
                            // if is cover put pointer cursor only on the right half otherwise all the time
                            if(self.getCurrentOpenPage() === 0){
                                var center = (clickRange.left + clickRange.right) / 2;
                                $(this).css('cursor', realPos.left < center ? 'default' : 'pointer');
                            } else {
                                $(this).css('cursor', 'pointer');
                            }
                        } else {
                            $(this).css('cursor', 'default');
                        }
                    })
                        .on('mouseenter', function() {
                            var prodJson = view_common.getProduct(handleCurrentPidCallback());
                        });
                    if (scrollAndClickEnabled) {
                        $("#sfly_wgt_sideopen_container")
                            .off('click')
                            .on('click', function(event) {
                            if (
                                self.isNotEnoughPhotosPopup() ||
                                $(event.target).hasClass('sfly-wgt-arrow') ||
                                $(event.target).hasClass('sfly-wgt-book-paging') ||
                                $(event.target).hasClass('sfly-wgt-page-curr-right') ||
                                $(event.target).hasClass('sfly-wgt-page-curr-left') ||
                                $(event.target).hasClass('sfly-wgt-pages') ||
                                $(event.target).hasClass('sfly-img-spread') ||
                                $(event.target).hasClass('sfly_wgt_product_style_title') ||
                                $(event.target).hasClass('sfly-wgt-book-choose-size-square') ||
                                $(event.target).hasClass('sfly-wgt-book-choose-size-title') ||
                                $(event.target).hasClass('sfly-wgt-book-choose-size') ||
                                $(event.target).hasClass('see-more-styles') ||
                                $(event.target)[0].id == "sfly_wgt_sideopen_buttons" ||
                                $(event.target)[0].id == "sfly_wgt_sideopen_styles_left" ||
                                $(event.target)[0].id == "sfly_wgt_sideopen_styles_right" ||
                                $(event.target)[0].id == "sfly-wgt-book-choose-hightlights" ||
                                $(event.target)[0].name == "highlights" ||
                                $(event.target).hasClass('sfly-wgt-gray-btn-sfly') ||
                                $(event.target).hasClass('sfly-wgt-orange-btn-sfly') ||
                                $(event.target).hasClass('sfly-wgt-qst-mark') ||
                                $(event.target).hasClass('sfly_wgt_sideopen_bottompart_tab')
                            ) {
                                return;
                            }

                            event.preventDefault();

                            var innerParentPosition = inner.parent().parent().position();
                            var clickRange     = {
                                left: parseInt(innerParentPosition.left) + parseInt(inner.attr('data-left')),
                                right: parseInt(innerParentPosition.left) + parseInt(inner.attr('data-left')) + parseInt(inner.attr('data-orig-width')),
                                top: parseInt(innerParentPosition.top) + parseInt(inner.attr('data-top-size')),
                                bottom: parseInt(innerParentPosition.top) + parseInt(inner.attr('data-top-size')) + parseInt(inner.attr('data-real-height')) + 15
                            };

                            // Calc real position
                            var targetPos       = $(event.currentTarget).offset();
                            var mousePos        = { top: event.pageY, left: event.pageX };
                            var realPos         = { top: mousePos.top - targetPos.top, left: mousePos.left - targetPos.left };
                            var center          = (clickRange.left + clickRange.right) / 2;

                            if(!isClickAfterDrag){
                                if (realPos.left >= clickRange.left && realPos.left <= clickRange.right && realPos.top >= clickRange.top && realPos.top <= clickRange.bottom) {

                                    var nextPage    = self.getCurrentOpenPage() + (realPos.left < center ? (-1) : 1);
                                    var totalPages  = Math.floor((product.book.pages.length-1)/2) + 2; // +1 for the cover

                                    var trackingOption = self.augmentTracking({ sku: sflySku, page: self.getCurrentOpenPage() }, self.Model);
                                    tracking.track('open', 'flip_book',trackingOption);

                                    if (nextPage < 0) {
                                        nextPage = 0;
                                    } else if (nextPage == 98) {
                                        nextPage = totalPages-2;
                                    } else if (nextPage >= totalPages-1) {
                                        nextPage = 99;
                                    }

                                    $(sideopen).find('canvas').hide();
                                    $(sideopen).find('canvas[data-order=' + nextPage + ']').show();

                                    $(sideopen).find('.sfly-wgt-book-nav li').removeClass('wgt-nav-selected');
                                    $(sideopen).find('.sfly-wgt-page_' + nextPage).addClass('wgt-nav-selected');

                                    self.setCurrentOpenPage(nextPage);

                                    modal_common.setPagesCount(sideopen, nextPage, totalPages);
                                    modal_common.setArrowPagingClass(sideopen, nextPage, 99);
                                } else {
                                    $(sideopen).find('.sfly-wgt-book-nav .sfly-wgt-page_0').click();
                                }
                            }
                        });
                    }
                    var scrollHandler = function(event){
                        var nextPage    = self.getCurrentOpenPage();
                        var totalPages  = Math.floor((product.book.pages.length-1)/2) + 2; // +1 for the cover

                        if (event.deltaX == 0) {
                            nextPage-= event.deltaY > 0 ? 1 : -1;
                        } else {
                            nextPage += event.deltaX > 0 ? 1 : -1;
                        }

                        if (isNaN(nextPage)) {
                            nextPage = 0;
                        }

                        if (nextPage < 0) {
                            nextPage = 0;
                        } else if (nextPage > totalPages+1 && nextPage< 99) {
                            nextPage = totalPages-2;
                        } else if (nextPage >= totalPages-1) {
                            nextPage = 99;
                        }

                        $(sideopen).find('canvas').hide();
                        $(sideopen).find('canvas[data-order=' + nextPage + ']').show();

                        $(sideopen).find('.sfly-wgt-book-nav li').removeClass('wgt-nav-selected');
                        $(sideopen).find('.sfly-wgt-page_' + nextPage).addClass('wgt-nav-selected');

                        self.setCurrentOpenPage(nextPage);

                        modal_common.setPagesCount(sideopen, nextPage, totalPages);
                        modal_common.setArrowPagingClass(sideopen, nextPage, 99);
                    };

                    function Interval(fn, time) {
                        var timer = false;
                        this.start = function () {
                            if (!this.isRunning())
                                timer = setInterval(fn, time);
                        };
                        this.stop = function () {
                            clearInterval(timer);
                            timer = false;
                        };
                        this.isRunning = function () {
                            return timer !== false;
                        };
                    }

                    var scrollHappened = false;
                    var scrollTimeout;
                    var eventTop;
                    var scrollInterval = new Interval(function(){
                        if(scrollHappened){
                            scrollHandler(eventTop);
                            scrollHappened = false;
                        }
                    }, 200);

                    if (scrollAndClickEnabled) {
                        $(sideopen).find("#sfly_wgt_sideopen_products").off('mousewheel').on('mousewheel', function(event){
                            event.preventDefault();
                            eventTop = event;
                            scrollHappened = true;
                            if(!scrollInterval.isRunning()){
                                scrollInterval.start();
                                clearTimeout(scrollTimeout)
                                scrollTimeout = setTimeout(function(){
                                    scrollInterval.stop();
                                    scrollHappened = false;
                                }, 10000);
                            }
                        });
                    }


                    $(sideopen).find('.sfly-wgt-arrow').on('mousedown', function() {
                        // This will prevent a selection on double click. why? no idea...
                        return false;
                    });

                    // todo: remove the duplicate code from arrow/key navigation

                    $(sideopen).find('.sfly-wgt-arrow').on('click', function() {
                        var dir         = $(this).attr('data-dir');
                        var totalPages  = Math.floor((product.book.pages.length-1)/2) + 2; // +1 for the cover
                        var currPage    = self.getCurrentOpenPage();
                        var nextPage    = currPage + (dir == 'left' ? -1 : 1);

                        var trackingOption = self.augmentTracking({ sku: sflySku, page: currPage }, self.Model);
                        tracking.track('open', 'flip_book', trackingOption);

                        // don't allow to move too left or too right
                        if (nextPage < 0) {
                            nextPage = 0;
                        } else if (nextPage == 98) {
                            nextPage = totalPages-2;
                        } else if (nextPage >= totalPages-1) {
                            nextPage = 99;
                        }

                        if (isNaN(nextPage)) {
                            nextPage = 0;
                        }

                        $(sideopen).find('canvas').hide();
                        $(sideopen).find('canvas[data-order=' + nextPage + ']').show();

                        $(sideopen).find('.sfly-wgt-book-nav li').removeClass('wgt-nav-selected');
                        $(sideopen).find('.sfly-wgt-page_' + nextPage).addClass('wgt-nav-selected');

                        self.setCurrentOpenPage(nextPage);

                        modal_common.setPagesCount(sideopen, nextPage, totalPages);
                        modal_common.setArrowPagingClass(sideopen, nextPage, 99);
                    });

                    if(scrollAndClickEnabled) {
                        $('body').off('.pwidget').on('keydown.pwidget', function (e) {
                            e.preventDefault();

                            var nextPage = self.getCurrentOpenPage();
                            var totalPages = Math.floor((product.book.pages.length - 1) / 2) + 2; // +1 for the cover

                            var trackingOption = self.augmentTracking({
                                sku: sflySku,
                                page: self.getCurrentOpenPage()
                            }, self.Model);
                            tracking.track('open', 'flip_book', trackingOption);

                            switch (e.keyCode) {
                                case 37: //left
                                    nextPage -= 1;
                                    break;
                                case 39: //right
                                case 32: //space
                                    nextPage += 1;
                                    break;
                            }

                            if (isNaN(nextPage)) {
                                nextPage = 0;
                            }

                            if (nextPage < 0) {
                                nextPage = 0;
                            } else if (nextPage == 98) {
                                nextPage = totalPages - 2;
                            } else if (nextPage >= totalPages - 1) {
                                nextPage = 99;
                            }

                            $(sideopen).find('canvas').hide();
                            $(sideopen).find('canvas[data-order=' + nextPage + ']').show();

                            $(sideopen).find('.sfly-wgt-book-nav li').removeClass('wgt-nav-selected');
                            $(sideopen).find('.sfly-wgt-page_' + nextPage).addClass('wgt-nav-selected');

                            self.setCurrentOpenPage(nextPage);

                            modal_common.setPagesCount(sideopen, nextPage, totalPages);
                            modal_common.setArrowPagingClass(sideopen, nextPage, 99);
                        });
                    }

                    $(sideopen).find('.sfly-wgt-book-nav li')
                        .on('mousedown', function() {
                            if(!$(this).hasClass('wgt-nav-selected')){
                                return;
                            }

                            isClickAfterDrag = true;
                            $(this).parent().addClass('draggable');

                            $('#sfly_wgt_full_openwin_container')
                                .on('mousemove', function(event){

                                    $(this).css('cursor','pointer');

                                    var elem        = $(this).find('.sfly_wgt_product_inner');
                                    var pages       = elem.attr('data-pages');
                                    var navPosition = $(this).find('.sfly-wgt-book-nav').position();
                                    var navPosRange = { left: navPosition.left, right: navPosition.left + $(this).find('.sfly-wgt-book-nav').width() };

                                    // Calc real position
                                    var targetPos   = $(event.currentTarget).offset();
                                    var mousePos    = { top: event.pageY, left: event.pageX };
                                    var realPos     = { top: mousePos.top - targetPos.top, left: mousePos.left - targetPos.left - ($(this).width() - elem.width())/2 };

                                    var currPage;
                                    var canNavigate = $(this).find('#sfly_wgt_sideopen_products').children('.sfly-wgt-book-nav').attr('data-show-nav') == 'true';

                                    if (!canNavigate) {
                                        return;
                                    }

                                    var navWidth    = $(this).find('#sfly_wgt_sideopen_products').children('.sfly-wgt-book-nav').attr('data-width');
                                    var navStart    = navPosRange.left;
                                    var navEnd      = navPosRange.right;

                                    if (realPos.left < navStart || realPos.left > navEnd) {
                                        return;
                                    }
                                    if (realPos.left < navStart) {
                                        currPage = 0;
                                    } else if (realPos.left > navEnd) {
                                        currPage = 99;
                                    } else {
                                        currPage = Math.floor((realPos.left-navStart) * pages / navWidth);
                                        if (currPage >= pages-1) // Last page in book is 99
                                            currPage = 99;
                                    }

                                    var trackingOption = self.augmentTracking({ sku: sflySku, page: self.getCurrentOpenPage() }, self.Model);
                                    tracking.track('open', 'flip_book', trackingOption);

                                    $(sideopen).find('canvas').hide();
                                    $(sideopen).find('canvas[data-order=' + currPage + ']').show();

                                    $(sideopen).find('.sfly-wgt-book-nav li').removeClass('wgt-nav-selected');
                                    $(sideopen).find('.sfly-wgt-page_' + currPage).addClass('wgt-nav-selected');

                                    self.setCurrentOpenPage(currPage);

                                    var totalPages  = Math.floor((product.book.pages.length-1)/2) + 2; // +1 for the cover
                                    modal_common.setPagesCount(sideopen, currPage, totalPages);
                                    modal_common.setArrowPagingClass(sideopen, currPage, 99);
                                })
                                .on('mouseup', function(){
                                    $(this).css('cursor','default');
                                    $(this).off('mousemove');
                                    $('.draggable').removeClass('draggable');
                                    setTimeout(function() { isClickAfterDrag = false; }, 200);
                                });
                        })
                        .off('click')
                        .on('click', function(e){
                            e.stopPropagation();
                            if($(this).hasClass('wgt-nav-selected')){
                                return;
                            }
                            var totalPages  = Math.floor((product.book.pages.length-1)/2) + 2; // +1 for the cover
                            var nextPage    = parseInt($(this).attr('class').replace("sfly-wgt-page_","").trim());

                            var trackingOption = self.augmentTracking({ sku: sflySku, page: self.getCurrentOpenPage() }, self.Model);
                            tracking.track('open', 'flip_book', trackingOption);

                            // don't allow to move too left or too right
                            if (nextPage < 0) {
                                nextPage = 0;
                            } else if (nextPage == 98) {
                                nextPage = totalPages-2;
                            } else if (nextPage >= totalPages-1) {
                                nextPage = 99;
                            }

                            if (isNaN(nextPage)) {
                                nextPage = 0;
                            }

                            $(sideopen).find('canvas').hide();
                            $(sideopen).find('canvas[data-order=' + nextPage + ']').show();

                            $(sideopen).find('.sfly-wgt-book-nav li').removeClass('wgt-nav-selected');
                            $(sideopen).find('.sfly-wgt-page_' + nextPage).addClass('wgt-nav-selected');

                            self.setCurrentOpenPage(nextPage);

                            modal_common.setPagesCount(sideopen, nextPage, totalPages);
                            modal_common.setArrowPagingClass(sideopen, nextPage, 99);
                        });

                }, true, { masks: layoutMasks, textEnabled:(productType !== "book") });
            }

            // Will render the main book
            function renderBook(pId, productJson, useCurrentPage, callbackOnFinish) {
                var product     = view_common.findProjectJsonProduct(productJson, pId);
                var productType = AssetMapper.GetProductType(product);
                var partnerId   = AssetMapper.GetPartnerId(product, productType);
                useCurrentPage  = (typeof useCurrentPage !== 'undefined' && useCurrentPage == true);
                var prodSku     = view_common.getProduct(pId)['style'] + '_' + view_common.getProduct(pId)['size'];

                var pricePromises   = [];
                var deferred        = $.Deferred();
                pricePromises.push(deferred);

                thumbGenWrapper.prepareThumbGenAssets(prodSku, pId, 'medium', productType, product, function (result)
                {
                    deferred.resolve();
                    if (result == null || typeof result.layoutJson === 'undefined' || typeof result.designJson === 'undefined') {
                        console.log('>>> [Product Widget] missing layout / design json');
                        return;
                    }

                    var layoutJson = JSON.stringify(result.layoutJson[pId]);
                    var designJson = JSON.stringify(result.designJson);

                    //renderThumb(pId, productType, partnerId, product, layoutJson, designJson, result.layoutMasks);
                    renderThumb(pId, useCurrentPage, callbackOnFinish, productType, partnerId, product, layoutJson, designJson, result.layoutMasks);
                });

                var highlightBubbleText = "";
                var highlightsCheckbox = openwinContainer.find('#sfly-wgt-book-choose-hightlights input[type=checkbox][name=highlights]');
                if(currAlbum.photos.length <= 500){
                    openwinContainer.find('#sfly-wgt-book-choose-hightlights').removeClass("disabled");
                    highlightsCheckbox.removeAttr("disabled");
                    if(manualSelect) {
                        highlightsCheckbox.removeAttr("checked");
                        highlightBubbleText = "<strong>Check to curate</strong><br/>We will automatically select the best photos for your photo book.";
                    } else if(!manualSelectEnter){
                        highlightBubbleText = "<strong>Uncheck to disable curation</strong><br/>We will use all your selected photos in your photo book.";
                    } else {
                        highlightBubbleText = "We've automatically selected the best photos for your photo book.<br/><strong>Uncheck to disable curation</strong>:<br/>We will use all your selected photos in your photo book.";
                    }
                } else {
                    highlightsCheckbox.attr("checked", "checked");
                    openwinContainer.find('#sfly-wgt-book-choose-hightlights').addClass("disabled");
                    highlightsCheckbox.attr("disabled", "disabled");
                    if(manualSelect) {
                        highlightBubbleText = "You've selected more than 500 photos, we've automatically selected the best photos for your photo book.";
                    } else {
                        highlightBubbleText = "Your photo book has more than 500 photos, we've automatically selected the best photos.";
                    }
                }
                openwinContainer.find(".sfly_wgt_highlight_bubble_txt").html(highlightBubbleText);

                $.when.apply(undefined, pricePromises).then(function() {
                    productProxy.loadPrices(function() {
                        // Prices are loaded, update the divs
                        updateWindowTitle(productJson, pId);
                    });
                });

                handleCurrentPidCallback(pId);
            }

            function updateWindowTitle(productJson, prodId) {
                var product         = view_common.findProjectJsonProduct(productJson, prodId);
                var pages           = product.book.pages.length - 1;
                var origProduct     = view_common.getProduct(prodId);
                $('#sfly_wgt_sideopen_container #sfly_wgt_sideopen_title').html(view_common.renderTemplate(templates.popup_booksmodal_title, {
                    pages: pages,
                    isStoryBook: isStoryBook,
                    price: config.getPrice(origProduct['sfly_sku']),
                    size: origProduct['size'],
                    style: origProduct['styleName'],
                    coupon: typeof cache.getCoupon() !== "undefined" ? cache.getCoupon().name
                                                                     : false,
                    isMobile: utils.isMobile,
                    hasModalMenu: self.menuContainerPresent
                }));
            }

            // Will stop loading, release the global lock and show the product styles.
            function releaseLockAndStopLoading(isAfterAlbumSwitch) {
                // if less than 20 photos show not enough photo popup
                if (currAlbum.photos.length < 20 && !isStoryBook){
                    self.showNotEnoughPhotosPopup(function() {
                        //viewDisableCallback();
                    });
                    if (!self.menuContainerPresent) {
                        if (self.calcModalWidth() < 800) {
                            $("#sfly_wgt_no_enough_photos_bubble").css('right', '315px');
                        } else {
                            $("#sfly_wgt_no_enough_photos_bubble").css('right', useNewStyleGuide ? '425px' :'432px');
                            if (!isThisLifeGeneral) {
                                $("#sfly_wgt_no_enough_photos_bubble").css('top', '25px');
                            }
                        }
                    }
                } else {
                    // show new upp bubble if we don't have a cookie
                    self.showNewBubblePop(sideopen,'book');
                }

                // We activated the modal
                if (_.isFunction(self.Model.get('callback')) && !utils.isMobile) { self.Model.get('callback')({action: 'showing_product', productType: 'photobook'}); }

                self.removeLoadingFromWidget();
                modal_common.hideBackgroundLoading($('#sfly_wgt_full_openwin_container'));
                view_common.showLoading($('#sfly_wgt_full_openwin_container'));

                if (typeof isAfterAlbumSwitch === 'undefined') {
                    isAfterAlbumSwitch = false;
                }
                releaseLockCallback();

                view_common.removeLoading($('#sfly_wgt_container')); // remove from the side widget

                $(self.Model.get('container')).find('.sfly_wgt_product[data-pid="' + pId + '"]').removeClass('not-selected');

                self.setIsWidgetOpen(true);

                renderBook(handleCurrentPidCallback(), productJson, setCurrentPage > 0, function() {
                    view_common.removeLoading($('#sfly_wgt_full_openwin_container'));
                    modal_common.showBackgroundLoading($('#sfly_wgt_full_openwin_container'));
                });

                if (isAfterAlbumSwitch) {
                    updateWindowTitle(productJson, handleCurrentPidCallback());
                }

                var renderBottomStyles = function(prodStylesToRender) {

                    var prodStylesToRender = prodStylesToRender || prodStyles;

                    //if its storybook, filter styles according to the sku(size) json file with storyBook @BOOL flag
                    if (isStoryBook && self.Model.attributes.hasOwnProperty("styles")
                        && typeof self.Model.attributes.styles === "object" && Object.keys(
                            self.Model.attributes.styles).length > 0) {

                        prodStylesToRender = _.filter(prodStylesToRender, function (style) {
                            var styleId = style.split("_")[0];
                            return self.Model.attributes.styles.hasOwnProperty(styleId)
                                   && typeof self.Model.attributes.styles[styleId] === "object"
                                   && self.Model.attributes.styles[styleId].storyBook === true;
                        });

                    }

                    // Adjustments for responsive modal
                    var styleContainer = $("#sfly_wgt_sideopen_styles_container");
                    var baseStyleContainerWidth = styleContainer.width();
                    if (utils.isMobile) {
                        styleContainer.width(openwinContainer.width());
                    } else {
                        if (baseStyleContainerWidth > openwinContainer.width() - 100 ) { // need to reduce
                            styleContainer.width(openwinContainer.width() - 100);
                        }
                    }


                    // Render the styles at the bottom
                    var stylesContainer = sideopen.find('#sfly_wgt_sideopen_styles');
                    stylesContainer.empty();
                    stylesContainer.width(100);

                    _.each(prodStylesToRender, function (style) {
                        getPhotobookRender(style, productJson, function (styleRender) {
                            if (style == handleCurrentPidCallback()) {
                                $(styleRender).addClass('sfly-bookstyle-selected');
                            }
                            stylesContainer.append(styleRender);
                            var origWidth = stylesContainer.width();
                            stylesContainer.width(origWidth + styleRender.outerWidth() + parseInt(styleRender.css('margin-right')));
                            $(styleRender).children('.sfly_wgt_product').on('click', function () {
                                var prodId = $(this).attr('data-pid');
                                // Same style. Do nothing.
                                if (prodId == handleCurrentPidCallback()) {
                                    return;
                                }

                                modal_common.hideBackgroundLoading($('#sfly_wgt_full_openwin_container'));
                                view_common.showLoading($('#sfly_wgt_full_openwin_container'));

                                function _getProductJson(pJson) {
                                    if (pJson != null) {
                                        // if is This Life replace photoIds in the strip with SFLY Ids
                                        if(isThisLifeGeneral) {
                                            pJson = modal_common.replaceIdWithSFLYId(currAlbum, pJson);
                                        }
                                        productJson = productJson.concat(pJson);
                                    } else {
                                        view_common.removeLoading(openwinContainer);
                                        modal_common.showBackgroundLoading(openwinContainer);
                                    }
                                }

                                $('#sfly_wgt_full_openwin_container #sfly_wgt_sideopen_styles .sfly-wgt-prod-style').removeClass('sfly-bookstyle-selected');
                                $(this).parent().addClass('sfly-bookstyle-selected');

                                $.when(
                                    productProxy.getPhotobook(currAlbum, 40, _getProductJson, false, manualSelect, [prodId], isThisLifeGeneral, mixedSourcesGeneral))
                                    .then(function() {
                                        updateWindowTitle(productJson, prodId);
                                        renderBook(prodId, productJson, true, function () {
                                            view_common.removeLoading($('#sfly_wgt_full_openwin_container'));
                                            modal_common.showBackgroundLoading($('#sfly_wgt_full_openwin_container'));
                                        });

                                        var trackingOption = self.augmentTracking({sku: $(this).attr('data-sku')}, self.Model);
                                        tracking.track('open', 'change_style', trackingOption);
                                    })
                                    .fail(function() {
                                        releaseLockCallback();
                                        view_common.removeLoading(openwinContainer);
                                        modal_common.showBackgroundLoading(openwinContainer);
                                    });
                            })
                        });
                    });



                    var $linkSeeMoreStyles =  $('<div id="sfly_wgt_sideopen_buttons"><a href="#" class="sfly-wgt-lightlink see-more-styles">See more<br/>styles ></a></div>');
                    $linkSeeMoreStyles.off('click').on('click', function () {
                        if(isStoryBook){
                            var env = cache.get('env');
                            window.location = "https://www." + (env !== "prod" ? env + "." : "") +"shutterfly.com/personalized-stories/books";
                        } else {
                            forwardToPersonalizeBook("book-style");
                        }
                    });
                    stylesContainer.append($linkSeeMoreStyles);
                    if (!utils.isMobile) {
                        var styleRightArrow = sideopen.find("#sfly_wgt_sideopen_styles_right");
                        var styleLeftArrow = sideopen.find("#sfly_wgt_sideopen_styles_left");
                        var styleContainerMainWidth = parseInt(styleContainer.width());

                        var moveLeft = function(){
                            var currentOffset = parseInt(stylesContainer.css('transform').indexOf('matrix3d') > 0 ? 0 : stylesContainer.css('transform').replace('matrix(','').replace(')','').split(",")[4].trim());
                            var nextOffset = currentOffset + styleContainerMainWidth;
                            if(nextOffset >= 0){
                                nextOffset = 0;
                            }
                            stylesContainer.css('transform', 'translateX('+nextOffset+'px)');
                            if(currentOffset + styleContainerMainWidth >= 0){
                                styleLeftArrow.hide();
                            } else {
                                styleLeftArrow.show();
                            }
                            if(nextOffset - styleContainerMainWidth <= -1*stylesContainer.width()){
                                styleRightArrow.hide();
                            } else {
                                styleRightArrow.show();
                            }
                        };

                        var moveRight = function(){
                            var currentOffset = parseInt(stylesContainer.css('transform').indexOf('matrix3d') > 0 ? 0 : stylesContainer.css('transform').replace('matrix(','').replace(')','').split(",")[4].trim());
                            var nextOffset = currentOffset - styleContainerMainWidth
                            if(nextOffset <= -1*stylesContainer.width()){
                                return true;
                            }
                            stylesContainer.css('transform', 'translateX('+nextOffset+'px)');
                            if(nextOffset - styleContainerMainWidth <= -1*stylesContainer.width()){
                                styleRightArrow.hide();
                            } else {
                                styleRightArrow.show();
                            }
                            if(currentOffset - styleContainerMainWidth >= -1*stylesContainer.width()){
                                styleLeftArrow.show();
                            } else {
                                styleLeftArrow.hide();
                            }
                        };

                        styleLeftArrow.off('click').on('click', _.throttle(moveLeft, 750));
                        styleRightArrow.off('click').on('click', _.throttle(moveRight, 750));

                        if(stylesContainer.width() > styleContainerMainWidth){

                            if(isStoryBook && $(".sfly-wgt-prod-style").length <= 7){
                             return;
                            }

                            styleRightArrow.show();
                        }
                    }
                };

                if (!isAfterAlbumSwitch) {
                    renderBottomStyles();
                }

                function forwardToPersonalizeBook(prodType) {
                    var product = view_common.findProjectJsonProduct(productJson, handleCurrentPidCallback());

                    if(isStoryBook) {
                        var _pId = $(".sfly-wgt-prod-style.sfly-bookstyle-selected .sfly_wgt_product");
                        if(typeof _pId !== "undefined") _pId = _pId.attr('data-pid');
                        if(typeof _pId !== "undefined" && _pId !== "") pId = _pId;
                    }

                    var style = view_common.getProduct(pId).style;
                    var env = cache.get('env');


                    if (cache.get("partner_user_id") == "009085953279") {
                        if (isStoryBook) {
                            window.location = env === 'prod' ? "https://www.shutterfly.com/sb/#/?styleId="+ style :  "https://www." + env + ".shutterfly.com/sb/#/?styleId="+ style;
                        } else {
                            window.location = env === 'prod' ? "https://www.shutterfly.com/pb/#/?styleId="+ style :  "https://www." + env + ".shutterfly.com/pb/#/?styleId="+ style;
                        }
                    }
                     else if (isStoryBook){
                            product.book.info.userid = cache.get("partner_user_id");
                            prodType = 'story-book';
                            clickThrough.sendToClickThrough(product, prodType, view_common.showLoading.bind(this, $('#sfly_wgt_full_openwin_container')), view_common.removeLoading.bind(this, $('#sfly_wgt_full_openwin_container')), currAlbum, self.winHandler, self.Model, "",  style, product.book.info.size);
                            // window.location = "https://www." + (env !== "prod" ? env + "." : "") +"shutterfly.com/sb/#/?styleId="+style+"&coverSpecId="+product.book.info.size+"_bk_hard&reportingSrc=Web%2Fmagicshop";
                        } else {
                        if (self.Model.get('openInNewTab')) {
                            self.winHandler = self.openNewWindow(self.winHandler);
                        } else {
                            self.winHandler = null;
                        }
                        clickThrough.sendToClickThrough(product, prodType, view_common.showLoading.bind(this, $('#sfly_wgt_full_openwin_container')), view_common.removeLoading.bind(this, $('#sfly_wgt_full_openwin_container')), currAlbum, self.winHandler, self.Model);
                    }
                    var prodJson = view_common.getProduct(handleCurrentPidCallback());
                    var trackingOption = self.augmentTracking({ sku: prodJson.sflySku, page: self.getCurrentOpenPage() }, self.Model);

                    var selectedBook = $(".sfly-wgt-prod-style.sfly-bookstyle-selected .sfly_wgt_product");
                    if (cache.get('mode') === 'instance') {
                        tracking.track('tl', 'click-product', {
                            sku: selectedBook.attr('data-sku'),
                            pid: selectedBook.attr('data-pid'),
                            prod_type: self.Model.get('prod_type')
                        });
                    } else {
                        tracking.track('open', 'personalize', trackingOption);
                    }
                }
                // Bind the click through button
                $('#sfly_wgt_upp .sfly-wgt-orange-btn-sfly').off('click').on('click', function() {
                    forwardToPersonalizeBook("book");
                });
            }

            var product         = view_common.findProjectJsonProduct(productJson, pId);
            var pages           = product.book.pages.length - 1;
            var origProduct     = view_common.getProduct(pId);
            var bookName        = origProduct['styleName'];
            var bookSize        = origProduct['size'];
            handleCurrentPidCallback(pId);

            var hideSelectButton = self.isThisLife ? self.Model.get('ismanualselect') : false;

            //hide selection for storybooks
            if(isStoryBook){
                hideSelectButton = true;
            }

            var sideopen = $(view_common.renderTemplate(templates.popup_booksmodal, {
                    pages: pages,
                    price: config.getPrice(config.getBooks()[pId].sfly_sku),
                    products: '',
                    pid: pId,
                    size: bookSize,
                    see_all: origProduct.seeMoreUrl,
                    coupon: typeof cache.getCoupon() !== "undefined" ? cache.getCoupon().name : false,
                    useNewStyleGuide: useNewStyleGuide,
                    title_template: _.template(templates.popup_booksmodal_title),
                    pages: pages,
                    style: bookName,
                    hideSelectButton: hideSelectButton,
                    //hideSelectButton: self.Model.get('ismanualselect'),
                    responsiveBtns: self.calcModalWidth() < 800,
                    isMobile: utils.isMobile || $(window).width() < globals.MOBILE_THRESHOLD,
                    hasModalMenu: self.menuContainerPresent,
                    isStoryBook: isStoryBook
                }
            ));

            if (cache.get('mode') == 'gifting') {
                $(sideopen).find('#sfly_wgt_upp_select').hide();
            }

            var openwinContainer = $('#sfly_wgt_full_openwin_container');


            // set current page
            var setCurrentPage  = setCurrentPage || 0;
            if(setCurrentPage > 0){
                self.setCurrentOpenPage(setCurrentPage);
            }

            changeOpenStatusCallback(true, self.closeModalAction, function(){ self.openModalAction(pId, sideopen, releaseLockAndStopLoading, forcedClose) });

            // UPP
            $('#sfly_wgt_upp_select').on('click', function(){
                function onOK(groupPhotos, isThisLife, mixedSources) {
                    //self.Model.set('currAlbum', groupPhotos);
                    window.MagicShopCurrAlbum = groupPhotos;

                    if (groupPhotos.photos.length < 20){
                        view_common.removeLoading(openwinContainer);
                        viewDisableCallback();
                        self.showNotEnoughPhotosPopup(function() {
                            modal_common.showBackgroundLoading(openwinContainer);
                            //viewDisableCallback();
                        });

                        if (self.calcModalWidth() < 800) {
                            $("#sfly_wgt_no_enough_photos_bubble").css('right', '315px');
                        } else {
                            $("#sfly_wgt_no_enough_photos_bubble").css('right', useNewStyleGuide ? '425px' :'432px');
                            if (!isThisLifeGeneral) {
                                $("#sfly_wgt_no_enough_photos_bubble").css('top', '25px');
                            }

                        }
                        releaseLockCallback();
                        releaseLockAndStopLoading(true);
                        return;
                    }

                    self.hideNotEnoughPhotosPopup();

                    manualSelect            = true;
                    isThisLifeGeneral       = isThisLife;
                    mixedSourcesGeneral     = mixedSources;
                    thisLifePhotoMapping    = groupPhotos;

                    productJson = [];
                    function _getProductJson(pJson) {
                        if (pJson != null) {
                            // if is This Life replace photoIds in the strip with SFLY Ids
                            if(isThisLifeGeneral) {
                                pJson = modal_common.replaceIdWithSFLYId(thisLifePhotoMapping, pJson);
                            }
                            productJson = productJson.concat(pJson);
                        } else {
                            view_common.removeLoading(openwinContainer);
                            modal_common.showBackgroundLoading(openwinContainer);
                        }
                    }

                    $.when(
                        productProxy.getPhotobook(groupPhotos, 40, _getProductJson, false, manualSelect, [handleCurrentPidCallback()], isThisLife, mixedSources, true))
                        .then(function() {
                            currAlbum = groupPhotos;
                            releaseLockAndStopLoading(true);
                        })
                        .fail(function() {
                            releaseLockCallback();
                            view_common.removeLoading(openwinContainer);
                            modal_common.showBackgroundLoading(openwinContainer);
                        });

                    var trackingOption = self.augmentTracking({ action: 'ok', sku: origProduct['sflySku'] }, self.Model);
                    tracking.track('open', 'upp', trackingOption);
                }

                function onCancel() {
                    releaseLockCallback();
                    view_common.removeLoading(openwinContainer);
                    var trackingOption = self.augmentTracking({ action: 'cancel', sku: origProduct['sflySku'] }, self.Model);
                    tracking.track('open', 'upp', trackingOption);
                }

                function onCancelInstace() {
                    self.Model.set('ismanualselect', false);
                    window.MagicShopCurrAlbum = undefined;
                    self.reshowModalAction(function(){releaseLockAndStopLoading(true)});
                }

                var trackingOption = self.augmentTracking({ action: 'open', sku: origProduct['sflySku'] }, self.Model);
                tracking.track('open', 'upp', trackingOption);

                if (_.isFunction(self.Model.get('callback'))) {
                    var renderModalWithPhotos = function(selectedPhotos){
                        var groupPhotos = {
                            'albumId' : String.fromCharCode(65 + Math.floor(Math.random() * 26)) + Date.now(),
                            'photos' : selectedPhotos
                        };
                        self.reshowModalAction(function(){onOK(groupPhotos, true, false)});
                    };

                    self.Model.get('callback')({action: 'select_photos', onSuccess: renderModalWithPhotos, onFail: onCancelInstace, productType: 'photobook'});
                    self.closeModalAction();
                } else {
                    view_common.showLoading(openwinContainer);
                    takeLockCallback();
                    modal_common.showUPP(onOK, onCancel);
                }
            });

            openwinContainer.find('#sfly-wgt-book-choose-hightlights').off( "mouseenter mouseleave" ).hover(function () {
                curateTooltip.show();
            }, function () {
                curateTooltip.hide();
            });

            $('input[type=checkbox][name=highlights]').change(function() {
                view_common.showLoading(openwinContainer);
                takeLockCallback();

                manualSelect = !$(this).is(":checked");
                productJson = [];
                function _getProductJson(pJson) {
                    if (pJson != null) {
                        // if is This Life replace photoIds in the strip with SFLY Ids
                        if(isThisLifeGeneral) {
                            pJson = modal_common.replaceIdWithSFLYId(currAlbum, pJson);
                        }
                        productJson = productJson.concat(pJson);
                    } else {
                        view_common.removeLoading(openwinContainer);
                        modal_common.showBackgroundLoading(openwinContainer);
                    }
                }

                $.when(
                    productProxy.getPhotobook(currAlbum, 40, _getProductJson, false, manualSelect, [handleCurrentPidCallback()], isThisLifeGeneral, mixedSourcesGeneral))
                    .then(function() {
                        renderBook(handleCurrentPidCallback(), productJson, false, function () {
                            view_common.removeLoading($('#sfly_wgt_full_openwin_container'));
                            modal_common.showBackgroundLoading($('#sfly_wgt_full_openwin_container'));
                        });
                    })
                    .fail(function() {
                        releaseLockCallback();
                        view_common.removeLoading(openwinContainer);
                        modal_common.showBackgroundLoading(openwinContainer);
                    });
            });


            var changeSizeCallback = function(i, e){
                e.stopPropagation();
                var pId = handleCurrentPidCallback().replace(bookSize, bookSizesCode[i]);

                //if the same product do not do anything
                if(pId == handleCurrentPidCallback()){
                    return true;
                }

                var trackingOption = self.augmentTracking({ sku: origProduct['sflySku'] }, self.Model);
                tracking.track('open', 'book_size_change', trackingOption);

                modal_common.hideBackgroundLoading($('#sfly_wgt_full_openwin_container'));
                view_common.showLoading($('#sfly_wgt_full_openwin_container'));
                $('#sfly_wgt_full_openwin_container .sfly-wgt-book-choose-size').removeClass('sfly-wgt-book-choose-size-selected');
                $('#sfly_wgt_full_openwin_container .sfly-wgt-book-choose-size[data-code="'+bookSizesCode[i]+'"]').addClass('sfly-wgt-book-choose-size-selected');

                function _getProductJson(pJson) {
                    if (pJson != null) {
                        // if is This Life replace photoIds in the strip with SFLY Ids
                        if(isThisLifeGeneral) {
                            pJson = modal_common.replaceIdWithSFLYId(currAlbum, pJson);
                        }
                        productJson = productJson.concat(pJson);
                    } else {
                        view_common.removeLoading(openwinContainer);
                        modal_common.showBackgroundLoading(openwinContainer);
                    }
                }

                $.each($('.sfly-wgt-prod-style').children(), function(j, styleDiv){
                    $(styleDiv).attr('data-pid', $(styleDiv).attr('data-pid').replace(bookSize, bookSizesCode[i]));
                });

                $.when(
                    productProxy.getPhotobook(currAlbum, 40, _getProductJson, false, manualSelect, [pId], isThisLifeGeneral, mixedSourcesGeneral))
                    .then(function() {
                        $('.sfly-wgt-lightlink')[0].href = $('.sfly-wgt-lightlink')[0].href.replace(bookSize, bookSizesCode[i]);
                        bookSize = bookSizesCode[i];
                        renderBook(pId, productJson, true, function () {
                            view_common.removeLoading($('#sfly_wgt_full_openwin_container'));
                            modal_common.showBackgroundLoading($('#sfly_wgt_full_openwin_container'));
                        });
                    })
                    .fail(function() {
                        releaseLockCallback();
                        view_common.removeLoading(openwinContainer);
                        modal_common.showBackgroundLoading(openwinContainer);
                    });
            };

            var getPhotobookPrice = function(pId) {
                var origProduct     = view_common.getProduct(pId);
                var price           = config.getPrice(origProduct['sfly_sku']);
                var priceText = "";
                if (price.originalPrice > 0) {
                    if(price.salePrice > -1){
                        priceText = "from <span class='price-old'>$"+parseFloat(price.originalPrice).toFixed(2)+"</span> <span class='price-sale'>$"+parseFloat(price.salePrice).toFixed(2);
                        priceText += "</span>";
                    } else {
                        priceText       = "from $"+parseFloat(price.originalPrice).toFixed(2);
                    }
                }
                return priceText;
            };

            var loadMissingPrice = function(pId, size) {
                var origProduct = view_common.getProduct(pId);
                var prodType       = origProduct['type'];

                var pricePromises   = [];
                var deferred        = $.Deferred();
                pricePromises.push(deferred);

                thumbGenWrapper.loadProductSKU(pId, pId, prodType, 'medium', function() {
                    deferred.resolve();
                });

                $.when.apply(undefined, pricePromises).then(function() {
                    productProxy.loadPrices(function() {
                        // Prices are loaded, update the divs
                        var price = getPhotobookPrice(pId);
                        $(size).find('.sfly-wgt-book-icon-price').html(price);
                    });
                });

            };

            var bookSizes = $(openwinContainer).find('.sfly-wgt-book-choose-size');
            var bookSizesCode = ["8x8", "8x11", "11x14"];

            if(isStoryBook){
                $("#sfly_wgt_sideopen_bottompart").addClass("isStoryBook");
                $("#sfly_wgt_sideopen_bottompart_tab_choose_style").text("Story Book Titles");
            } else {
                $("#sfly_wgt_sideopen_bottompart_tab_choose_size").show();
                $.each(bookSizes, function(i, size){
                    var bookSize = bookSizesCode[i];
                    var pId = handleCurrentPidCallback();
                    pId = pId.split("_")[0] + "_" + bookSize;
                    var price = getPhotobookPrice(pId);
                    var bookIconTemplate = view_common.renderTemplate(templates.popup_photobook_icon, {
                        bookSize: bookSize,
                        priceText: price
                    });
                    $(size).append(bookIconTemplate);

                    if (!price) {
                        // if the price of this photobook not loaded yet
                        loadMissingPrice(pId, size);
                    }
                    $(size).on('click', changeSizeCallback.bind(undefined,i));
                });

                self.enableTabSwitching();
            }

            var curateTooltipModal = (function () {
                var visible = false;
                var isOnBubble = false;
                var highlightTooltip = openwinContainer.find("#sfly_wgt_highlight_bubble");
                var whenVisible = Date.now();
                return function(){
                    this.show = function(){
                        if(!visible) {
                            var that = this;
                            whenVisible = Date.now();
                            highlightTooltip.fadeIn(200, function () {
                                visible = true;
                                highlightTooltip.hover(function () {
                                    isOnBubble = true;
                                }, function () {
                                    isOnBubble = false;
                                    that.hide();
                                })
                            });
                        }
                    };
                    this.hide = function () {
                        if(Date.now() - whenVisible > 50){
                            setTimeout(function () {
                                if(visible && !isOnBubble) {
                                    highlightTooltip.off("mouseenter mouseleave").fadeOut(200, function () {
                                        visible = false;
                                    });
                                }
                            }, 500);
                        }
                    };
                    this.fadeInOut = function(){
                        if(!visible) {
                            var that = this;
                            this.show();
                            setTimeout(function () { that.hide(); }, 5000);
                        }
                    };
                }
            })();

            if (!utils.isMobile) {
                var curateTooltip = new curateTooltipModal();
                curateTooltip.fadeInOut();
            }
            // Position the open/close button in the right place
            var btn = $('.sfly-wgt-btn-sidemodule');

            // When the window is just refreshed and re-rendered
            if (!self.getIsWidgetOpen()) {
                buttonCloseCallback(btn, 'prod_clicked');
            }
        };

        return function(){
            modal.call(this);

            // helper for private functions
            var self = this;

            // Will open the sliding window with the given products
            this.showProductsWindow = function(pId, album, albums, prodStyles, prodOptions, forceCloseExternal, isThisLife, useNewStyleGuideFlag, doNotResizeImagesFlag, tooltipItems, textualStructure, mixedSources, takeLockCallback, releaseLockCallback, closeButtonCallback, changeOpenStatusCallback, handleCurrentPidCallback, viewDisableCallback) {
                useNewStyleGuide = useNewStyleGuideFlag;
                doNotResizeImages = doNotResizeImagesFlag;
                self.isThisLife = isThisLife;

                var origPid = pId;
                var changedPid = false;

                if (this.menuContainerPresent) {
                    album = typeof window.MagicShopCurrAlbum !== 'undefined' && window.MagicShopCurrAlbum !== null ? window.MagicShopCurrAlbum : album;

                    // if we're coming from a different style of pb, we want to current one to be that one
                    var prevPid = handleCurrentPidCallback();
                    if (prevPid !== null && typeof prevPid !== 'undefined') {
                        var styleId = prevPid.split('_')[0];
                        var sizeId = pId.split('_')[1];
                        pId = styleId + '_' + sizeId;
                        changedPid = true;
                    }
                }

                mobileRenderingOnMenuContainer = $(window).width() < globals.TABLET_THRESHOLD && self.menuContainerPresent;
                function showTheBook(forceClose) {
                    var productJson = [];
                    function _getProductJson(pJson) {
                        if (pJson != null) {
                            // if is This Life replace photoIds in the strip with SFLY Ids
                            if(isThisLife) {
                                pJson = modal_common.replaceIdWithSFLYId(album, pJson);
                            }
                            productJson = productJson.concat(pJson);
                        }
                    }

                    manualSelectEnter = manualSelect = self.Model.get('isManualSelect') ? true : false;
                    var styleToGet = changedPid ? pId : prodStyles[pId][0];

                    $.when(
                        productProxy.getPhotobook(album, 40, _getProductJson, false, manualSelect, [styleToGet], isThisLife, mixedSources))
                        .then(function() {
                            currentOpenPid = pId;
                            openSlideAndRenderBook(pId, productJson, prodStyles[origPid], prodOptions[origPid], forceClose, albums, album, takeLockCallback, releaseLockCallback, closeButtonCallback, changeOpenStatusCallback, handleCurrentPidCallback, viewDisableCallback, self);
                        })
                        .fail(function(){
                            self.removeLoadingFromWidget();
                            changeOpenStatusCallback(false, self.closeModalAction);
                            setTimeout(releaseLockCallback, 200);
                        });
                }
                isThisLifeGeneral = isThisLife;
                mixedSourcesGeneral = mixedSources;

                isStoryBook = (typeof self.Model === "object" && self.Model.hasOwnProperty(
                    "attributes")
                               && typeof self.Model.attributes === "object"
                               && self.Model.attributes.hasOwnProperty("isStoryBook")
                               && self.Model.attributes.isStoryBook === true);

                this.showProductsWindowFeatures(pId, album, albums, prodStyles, prodOptions, forceCloseExternal, takeLockCallback, releaseLockCallback, closeButtonCallback, changeOpenStatusCallback, handleCurrentPidCallback, viewDisableCallback, showTheBook);
            };
        };

        this.prototype = Object.create(modal.prototype);
    }
);

/*
 Code from here: https://github.com/jquery/jquery-mousewheel
 */

define('app/mousewheel.plugin', [], function() {

    var toFix  = ['wheel', 'mousewheel', 'DOMMouseScroll', 'MozMousePixelScroll'],
        toBind = ( 'onwheel' in document || document.documentMode >= 9 ) ?
            ['wheel'] : ['mousewheel', 'DomMouseScroll', 'MozMousePixelScroll'],
        slice  = Array.prototype.slice,
        nullLowestDeltaTimeout, lowestDelta;

    if ( $.event.fixHooks ) {
        for ( var i = toFix.length; i; ) {
            $.event.fixHooks[ toFix[--i] ] = $.event.mouseHooks;
        }
    }

    var special = $.event.special.mousewheel = {
        version: '3.1.12',

        setup: function() {
            if ( this.addEventListener ) {
                for ( var i = toBind.length; i; ) {
                    this.addEventListener( toBind[--i], handler, false );
                }
            } else {
                this.onmousewheel = handler;
            }
            // Store the line height and page height for this particular element
            $.data(this, 'mousewheel-line-height', special.getLineHeight(this));
            $.data(this, 'mousewheel-page-height', special.getPageHeight(this));
        },

        teardown: function() {
            if ( this.removeEventListener ) {
                for ( var i = toBind.length; i; ) {
                    this.removeEventListener( toBind[--i], handler, false );
                }
            } else {
                this.onmousewheel = null;
            }
            // Clean up the data we added to the element
            $.removeData(this, 'mousewheel-line-height');
            $.removeData(this, 'mousewheel-page-height');
        },

        getLineHeight: function(elem) {
            var $elem = $(elem),
                $parent = $elem['offsetParent' in $.fn ? 'offsetParent' : 'parent']();
            if (!$parent.length) {
                $parent = $('body');
            }
            return parseInt($parent.css('fontSize'), 10) || parseInt($elem.css('fontSize'), 10) || 16;
        },

        getPageHeight: function(elem) {
            return $(elem).height();
        },

        settings: {
            adjustOldDeltas: true, // see shouldAdjustOldDeltas() below
            normalizeOffset: true  // calls getBoundingClientRect for each event
        }
    };

    $.fn.extend({
        mousewheel: function(fn) {
            return fn ? this.bind('mousewheel', fn) : this.trigger('mousewheel');
        },

        unmousewheel: function(fn) {
            return this.unbind('mousewheel', fn);
        }
    });


    function handler(event) {
        var orgEvent   = event || window.event,
            args       = slice.call(arguments, 1),
            delta      = 0,
            deltaX     = 0,
            deltaY     = 0,
            absDelta   = 0,
            offsetX    = 0,
            offsetY    = 0;
        event = $.event.fix(orgEvent);
        event.type = 'mousewheel';

        // Old school scrollwheel delta
        if ( 'detail'      in orgEvent ) { deltaY = orgEvent.detail * -1;      }
        if ( 'wheelDelta'  in orgEvent ) { deltaY = orgEvent.wheelDelta;       }
        if ( 'wheelDeltaY' in orgEvent ) { deltaY = orgEvent.wheelDeltaY;      }
        if ( 'wheelDeltaX' in orgEvent ) { deltaX = orgEvent.wheelDeltaX * -1; }

        // Firefox < 17 horizontal scrolling related to DOMMouseScroll event
        if ( 'axis' in orgEvent && orgEvent.axis === orgEvent.HORIZONTAL_AXIS ) {
            deltaX = deltaY * -1;
            deltaY = 0;
        }

        // Set delta to be deltaY or deltaX if deltaY is 0 for backwards compatabilitiy
        delta = deltaY === 0 ? deltaX : deltaY;

        // New school wheel delta (wheel event)
        if ( 'deltaY' in orgEvent ) {
            deltaY = orgEvent.deltaY * -1;
            delta  = deltaY;
        }
        if ( 'deltaX' in orgEvent ) {
            deltaX = orgEvent.deltaX;
            if ( deltaY === 0 ) { delta  = deltaX * -1; }
        }

        // No change actually happened, no reason to go any further
        if ( deltaY === 0 && deltaX === 0 ) { return; }

        // Need to convert lines and pages to pixels if we aren't already in pixels
        // There are three delta modes:
        //   * deltaMode 0 is by pixels, nothing to do
        //   * deltaMode 1 is by lines
        //   * deltaMode 2 is by pages
        if ( orgEvent.deltaMode === 1 ) {
            var lineHeight = $.data(this, 'mousewheel-line-height');
            delta  *= lineHeight;
            deltaY *= lineHeight;
            deltaX *= lineHeight;
        } else if ( orgEvent.deltaMode === 2 ) {
            var pageHeight = $.data(this, 'mousewheel-page-height');
            delta  *= pageHeight;
            deltaY *= pageHeight;
            deltaX *= pageHeight;
        }

        // Store lowest absolute delta to normalize the delta values
        absDelta = Math.max( Math.abs(deltaY), Math.abs(deltaX) );

        if ( !lowestDelta || absDelta < lowestDelta ) {
            lowestDelta = absDelta;

            // Adjust older deltas if necessary
            if ( shouldAdjustOldDeltas(orgEvent, absDelta) ) {
                lowestDelta /= 40;
            }
        }

        // Adjust older deltas if necessary
        if ( shouldAdjustOldDeltas(orgEvent, absDelta) ) {
            // Divide all the things by 40!
            delta  /= 40;
            deltaX /= 40;
            deltaY /= 40;
        }

        // Get a whole, normalized value for the deltas
        delta  = Math[ delta  >= 1 ? 'floor' : 'ceil' ](delta  / lowestDelta);
        deltaX = Math[ deltaX >= 1 ? 'floor' : 'ceil' ](deltaX / lowestDelta);
        deltaY = Math[ deltaY >= 1 ? 'floor' : 'ceil' ](deltaY / lowestDelta);

        // Normalise offsetX and offsetY properties
        if ( special.settings.normalizeOffset && this.getBoundingClientRect ) {
            var boundingRect = this.getBoundingClientRect();
            offsetX = event.clientX - boundingRect.left;
            offsetY = event.clientY - boundingRect.top;
        }

        // Add information to the event object
        event.deltaX = deltaX;
        event.deltaY = deltaY;
        event.deltaFactor = lowestDelta;
        event.offsetX = offsetX;
        event.offsetY = offsetY;
        // Go ahead and set deltaMode to 0 since we converted to pixels
        // Although this is a little odd since we overwrite the deltaX/Y
        // properties with normalized deltas.
        event.deltaMode = 0;

        // Add event and delta to the front of the arguments
        args.unshift(event, delta, deltaX, deltaY);

        // Clearout lowestDelta after sometime to better
        // handle multiple device types that give different
        // a different lowestDelta
        // Ex: trackpad = 3 and mouse wheel = 120
        if (nullLowestDeltaTimeout) { clearTimeout(nullLowestDeltaTimeout); }
        nullLowestDeltaTimeout = setTimeout(nullLowestDelta, 200);

        return ($.event.dispatch || $.event.handle).apply(this, args);
    }

    function nullLowestDelta() {
        lowestDelta = null;
    }

    function shouldAdjustOldDeltas(orgEvent, absDelta) {
        // If this is an older event and the delta is divisable by 120,
        // then we are assuming that the browser is treating this as an
        // older mouse wheel event and that we should divide the deltas
        // by 40 to try and get a more usable deltaFactor.
        // Side note, this actually impacts the reported scroll distance
        // in older browsers and can cause scrolling to be slower than native.
        // Turn this off by setting $.event.special.mousewheel.settings.adjustOldDeltas to false.
        return special.settings.adjustOldDeltas && orgEvent.type === 'mousewheel' && absDelta % 120 === 0;
    }

});
define('app/scroller', ['underscore', 'app/templates', 'app/mousewheel.plugin', 'app/view_engine/widgets/common'], function(_, templates, mousewheel, view_common) {

    var self = function(targetContainer, scrollableElement, scrollArrowsOptions, options)
    {
        var actual = _.defaults(options || {}, {
            orientation : 'vertical',
            color:        '#f05323',
            marginTop:    0,
            locationChangeX: 0,
            locationChangeY: 0,
            SPEED_FACTOR: 10
        });

        var scrollArrows = _.defaults(scrollArrowsOptions || {}, {
            left: null,
            right: null,
            scroll: 0,
            disabledClass: ''
        });

        // Reasonable defaults
        var PIXEL_STEP  = 40;
        var LINE_HEIGHT = 100;
        var PAGE_HEIGHT = 800;
        var SPEED_FACTOR = actual.SPEED_FACTOR || 10;

        // generate unique id for container
        var uniqueIdContainer = '';
        if( typeof $(targetContainer).attr('unique-id') !== "undefined" ){
            uniqueIdContainer = $(targetContainer).attr('unique-id');
        } else {
            uniqueIdContainer = Math.floor(Math.random() * 26) + Date.now();
            $(targetContainer).attr('unique-id', uniqueIdContainer);
        }
        // bind resize function
        $(window)
            .off('resize.'+uniqueIdContainer)
            .on('resize.'+uniqueIdContainer, function(){_.debounce( self(targetContainer, scrollableElement, scrollArrows, actual), 200) });

        var lastLocation = {
            x: 0,
            y: 0
        };
        var locationChange = {
            x: actual.locationChangeX,
            y: actual.locationChangeY
        };
        var stopLocation = {
            x: 0,
            y: 0
        };

        var scrollAreaSize      = 0,
            moveableAreaSize    = 0,
            thumbSize           = 0,
            tplCompiled         = _.template(templates.scroller),
            scroller            = tplCompiled({orientation: actual.orientation});

        if (actual.orientation == 'horizontal') {
            scrollAreaSize      = $(targetContainer).width(); // Width of scrolling area
            moveableAreaSize    = $(scrollableElement).width(); // Width of visible area
            thumbSize           = Math.pow(scrollAreaSize, 2) / moveableAreaSize; // maxWidth * maxWidth/totalSize
        } else if (actual.orientation == 'vertical') {
            scrollAreaSize      = $(targetContainer).height(); // Height of scrolling area
            moveableAreaSize    = $(scrollableElement).height() + actual.marginTop; // Height of visible area
            thumbSize           = Math.pow(scrollAreaSize, 2) / moveableAreaSize; // maxHeight * maxHeight / totalSize
        }

        // if scroll not needed return
        if(thumbSize >= moveableAreaSize){
            $(targetContainer).parent().find(".sfly_wgt_listview_scroll_arrows").hide();
            return;
        } else {
            if($(targetContainer).parent().find(".sfly_wgt_listview_scroll_arrows").length == 0){
                $(targetContainer).parent().append(view_common.renderTemplate(templates.listview_arrows));
                scrollArrows.left = $(targetContainer).parent().find('.sfly_wgt_listview_scroll_left_arrow');
                scrollArrows.right = $(targetContainer).parent().find('.sfly_wgt_listview_scroll_right_arrow');
            }
        }


        if($(targetContainer).find('.sfly-wgt-listview-scrollbar-'+actual.orientation).length > 0){
            $(targetContainer).find('.sfly-wgt-listview-scrollbar-'+actual.orientation).remove();
        }

        $(targetContainer).append(scroller);

        var thumb = $(targetContainer).find('.sfly-wgt-scroll-thumb');
        if (actual.orientation == 'horizontal') {
            thumb.css('width', thumbSize);
        }
        else if (actual.orientation == 'vertical') {
            thumb.css('height', thumbSize);
        }
        thumb.css('background-color', actual.color);

        // totalSize => Minus ScrollAreaSize - we don't want to move it all outside, but leave it at the edge.
        var totalSize = moveableAreaSize - scrollAreaSize; // size of area to scroll.
        var moveRatio = totalSize / (scrollAreaSize - thumbSize); // how much the movement of the scroller will affect the scrollable area

        thumb
            .off()
            .on('mousedown', onMouseDown);

        $(targetContainer)
            .off()
            .on('mousewheel DOMMouseScroll', _.throttle(onScroll, 20))
            .on('touchstart', touchStart)
            .on('touchend', touchEnd);

        $(targetContainer)
            .find('.sfly-wgt-scroll-track')
            .off()
            .on('click', onScrollerClick);

        if (scrollArrows.left != null && scrollArrows.right != null && scrollArrows.scroll > 0) {
            bindArrowsNav(scrollArrows.left, scrollArrows.right, scrollArrows.scroll, scrollArrows.disabledClass);
        }

        // do one time move to reset the position (if re-rendered)
        doTheMove();

        function doTheMove(withAnimation, howLong)
        {
            if (typeof withAnimation === 'undefined') {
                withAnimation = false;
            }

            howLong = howLong || 0.2;

            $(scrollArrows.right).removeClass(scrollArrows.disabledClass);
            $(scrollArrows.left).removeClass(scrollArrows.disabledClass);

            if (locationChange.x <= 0) {
                locationChange.x = 0;
                $(scrollArrows.left).addClass(scrollArrows.disabledClass);
            } else if (locationChange.x + thumbSize >= scrollAreaSize) {
                locationChange.x = scrollAreaSize - thumbSize;
                $(scrollArrows.right).addClass(scrollArrows.disabledClass);
            }

            if (locationChange.y + thumbSize > scrollAreaSize) {
                locationChange.y = scrollAreaSize - thumbSize;
            } else if (locationChange.y < 0) {
                locationChange.y = 0;
            }

            //if (locationChange.y + thumbSize + scrollAreaSize >= moveableAreaSize) {
            //    locationChange.y = moveableAreaSize - thumbSize - scrollAreaSize;
            //}

            // add back 'thumbSize' that we removed in previous close
            var endOfVerticalScroll     = actual.orientation == 'vertical' && locationChange.y * moveRatio + scrollAreaSize >= moveableAreaSize;
            var endOfHorizontalScroll   = actual.orientation == 'horizontal' && locationChange.x * moveRatio + scrollAreaSize >= moveableAreaSize;

            if (endOfHorizontalScroll || endOfVerticalScroll) {
                doEndOfScrollCallback();
            }

            actual.locationChangeX = locationChange.x;
            actual.locationChangeY = locationChange.y;

            if (actual.orientation == 'horizontal') {
                changeScrollLocationHorizontal(locationChange.x, withAnimation, howLong);
                scrollElementHorizontal(-1 * locationChange.x * moveRatio, withAnimation, howLong);
            }
            else if (actual.orientation == 'vertical') {
                changeScrollLocationVertical(locationChange.y, withAnimation, howLong);
                scrollElementVertical(-1 * locationChange.y * moveRatio, withAnimation, howLong);
            }
        }

        function onMouseDown(event)
        {
            $(window)
                .on('mousemove.sfly_scroller', onMouseMove)
                .on('mouseup.sfly_scroller', onMouseUp);

            lastLocation.x = event.clientX;
            lastLocation.y = event.clientY;
        }

        function onMouseUp(event)
        {
            $(window)
                .off('mousemove.sfly_scroller')
                .off('mouseup.sfly_scroller');

            stopLocation = {
                x: locationChange.x,
                y: locationChange.y
            }
        }

        function onMouseMove(event)
        {
            event.preventDefault();

            locationChange = {
                x: event.clientX - lastLocation.x + stopLocation.x,
                y: event.clientY - lastLocation.y + stopLocation.y
            };

            doTheMove();
        }

        function normalizeWheel(/*object*/ event) /*object*/ {
            var sX = 0, sY = 0,       // spinX, spinY
                pX = 0, pY = 0;       // pixelX, pixelY

            // Legacy
            if ('detail'      in event) { sY = event.detail; }
            if ('wheelDelta'  in event) { sY = -event.wheelDelta / 120; }
            if ('wheelDeltaY' in event) { sY = -event.wheelDeltaY / 120; }
            if ('wheelDeltaX' in event) { sX = -event.wheelDeltaX / 120; }

            // side scrolling on FF with DOMMouseScroll
            if ( 'axis' in event && event.axis === event.HORIZONTAL_AXIS ) {
                sX = sY;
                sY = 0;
            }

            pX = sX * PIXEL_STEP;
            pY = sY * PIXEL_STEP;

            if ('deltaY' in event) { pY = event.deltaY; }
            if ('deltaX' in event) { pX = event.deltaX; }

            if ((pX || pY) && event.deltaMode) {
                if (event.deltaMode == 1) {          // delta in LINE units
                    pX *= LINE_HEIGHT;
                    pY *= LINE_HEIGHT;
                } else {                             // delta in PAGE units
                    pX *= PAGE_HEIGHT;
                    pY *= PAGE_HEIGHT;
                }
            }

            // Fall-back if spin cannot be determined
            if (pX && !sX) { sX = (pX < 1) ? -1 : 1; }
            if (pY && !sY) { sY = (pY < 1) ? -1 : 1; }

            return {
                spinX  : sX * SPEED_FACTOR,
                spinY  : sY * SPEED_FACTOR,
                pixelX : pX,
                pixelY : pY
            };
        }

        function onScroll(event)
        {
            // for vertical look only vertical scroll
            if (actual.orientation == "vertical")
            {
                var normalizedWheel = normalizeWheel(event);
                locationChange.x -= normalizedWheel.spinY;
                locationChange.y -= normalizedWheel.spinY;
            }
            else
            {
                if (typeof event.deltaY !== "undefined" && event.deltaY==0) {
                    event.preventDefault();
                }
                locationChange.x += typeof event.deltaX !== "undefined" ? event.deltaX : 0;
                locationChange.y += typeof event.deltaX !== "undefined" ? event.deltaX : 0;
            }

            stopLocation = {
                x: locationChange.x,
                y: locationChange.y
            };

            doTheMove();
        }

        // touch initial vars
        var initialPosX = 0;
        var initialPosY = 0;
        var lastMovmentX = 0;
        var lastMovmentY = 0;
        var initialTime = 0;
        var targetOffSetLeft = $(targetContainer).offset().left;
        var targetOffSetTop = $(targetContainer).offset().top;

        function touchStart(evt) {
            initialPosX = evt.originalEvent.touches[0].pageX - targetOffSetLeft - thumbSize/2;
            initialPosY = evt.originalEvent.touches[0].pageY - targetOffSetTop - thumbSize/2;
            lastMovmentX = locationChange.x;
            lastMovmentY = locationChange.y;
            initialTime  = evt.timeStamp;

            $(this).on('touchmove', touchMove);
        }

        function touchEnd(evt) {
            $(this).off('touchmove');

            // do some little animation for horizontal bar
            if(actual.orientation == "horizontal")
            {
                var speedConst = 150;
                locationChange.x -= (speedConst/(evt.timeStamp-initialTime)) * (lastMovmentX - locationChange.x);
                stopLocation = {
                    x: locationChange.x
                };
                doTheMove(true, (evt.timeStamp-initialTime)/500);
            }
        }

        function touchMove(evt) {
            if(actual.orientation == "horizontal")
            {
                if(evt.originalEvent.touches[0].pageX != 0){
                    evt.preventDefault();
                }
                var xUp = -1 * (evt.originalEvent.touches[0].pageX - targetOffSetLeft - thumbSize/2 - initialPosX) / moveRatio;
                locationChange.x = lastMovmentX + xUp;
                locationChange.y = lastMovmentX + xUp;
            }
            else if(actual.orientation == "vertical")
            {
                var yUp = -1 * (evt.originalEvent.touches[0].pageY - targetOffSetTop - thumbSize/2 - initialPosY) / moveRatio;
                locationChange.x = lastMovmentY + yUp;
                locationChange.y = lastMovmentY + yUp;
            }

            stopLocation = {
                x: locationChange.x,
                y: locationChange.y
            };

            doTheMove();
        }

        function onScrollerClick(event)
        {
            //return if you click on the scrollbar
            if($(event.target).hasClass("sfly-wgt-scroll-thumb")){
                return;
            }

            locationChange = {
                x: event.offsetX - thumbSize/2,
                y: event.offsetY - thumbSize/2
            };

            stopLocation = {
                x: locationChange.x,
                y: locationChange.y
            };

            doTheMove(true);
        }

        function bindArrowsNav(leftArrow, rightArrow, howMuchToScroll, disabledClass) {
            $(leftArrow).on('click', function(event) {
                event.preventDefault();

                if (locationChange.x == 0) {
                    doBudgeAnimation();
                    return;
                }

                locationChange.x -= howMuchToScroll;
                if (locationChange.x < 0) {
                    locationChange.x = 0;
                }

                stopLocation = {
                    x: locationChange.x,
                    y: locationChange.y
                };

                doTheMove(true);
            });

            $(rightArrow).on('click', function(event) {
                event.preventDefault();

                if (locationChange.x == scrollAreaSize - thumbSize) {
                    doBudgeAnimation();
                    return;
                }

                locationChange.x += howMuchToScroll;
                if (locationChange.x + thumbSize > scrollAreaSize) {
                    locationChange.x = scrollAreaSize - thumbSize;
                }

                stopLocation = {
                    x: locationChange.x,
                    y: locationChange.y
                };

                doTheMove(true);
            });
        }

        function addTransition(elem, howLong) {
            howLong = howLong || 0.2;
            $(elem).css({
                "transition": "all "+howLong+"s ease"
            });
        }

        function removeTransition(elem, finishCallback) {
            setTimeout(function() {
                $(elem).css({
                    "transition": ""
                });

                if (_.isFunction(finishCallback)) {
                    finishCallback();
                }
            }, 200);
        }

        function doBudgeAnimation(howLong) {
            howLong = howLong || 0.2;
            var factor = 0;

            if (actual.orientation == 'horizontal') {
                if (locationChange.x == 0) {
                    factor = 10;
                } else {
                    factor = -10;
                }

                scrollElementHorizontal(-1 * locationChange.x * moveRatio + factor, true, howLong, function() {
                    scrollElementHorizontal(-1 * locationChange.x * moveRatio, true, howLong);
                });
            }
            else if (actual.orientation == 'vertical') {
                if (locationChange.y == 0) {
                    factor = 30;
                } else {
                    factor = -30;
                }

                scrollElementVertical(-1 * locationChange.y * moveRatio + factor, true, howLong, function() {
                    scrollElementVertical(-1 * locationChange.y * moveRatio + factor, true, howLong);
                });
            }
        }

        function changeScrollLocationHorizontal(howMuch, withAnimation, howLong, finishCallback)
        {
            if (typeof withAnimation !== 'undefined' && withAnimation) {
                addTransition(thumb, howLong);
            }

            thumb
                .css({
                    "webkitTransform": "translateX(" + howMuch + "px) translateZ(0px)",
                    "transform": "translateX(" + howMuch + "px) translateZ(0px)"
                }).attr('data-transform', Math.abs(parseInt(howMuch)));


            // Remove transition, but only after it's over
            removeTransition(thumb, finishCallback);

            doMovedCallback();
        }

        function changeScrollLocationVertical(howMuch, withAnimation, howLong, finishCallback)
        {
            if (typeof withAnimation !== 'undefined' && withAnimation) {
                addTransition(thumb, howLong);
            }

            thumb.css({
                "webkitTransform": "translateY(" + howMuch + "px) translateZ(0px)",
                "transform": "translateY(" + howMuch + "px) translateZ(0px)"
            }).attr('data-transform', Math.abs(parseInt(howMuch)));

            // Remove transition, but only after it's over
            removeTransition(thumb, finishCallback);

            doMovedCallback();
        }

        function scrollElementHorizontal(howMuch, withAnimation, howLong, finishCallback) {
            if (typeof withAnimation !== 'undefined' && withAnimation) {
                addTransition(scrollableElement, howLong);
            }

            $(scrollableElement).css({
                "webkitTransform": "translateX(" + howMuch + "px) translateZ(0px)",
                "transform": "translateX(" + howMuch + "px) translateZ(0px)"
            }).attr('data-transform', Math.abs(parseInt(howMuch)));

            // Remove transition, but only after it's over
            removeTransition(scrollableElement, finishCallback);
        }

        function scrollElementVertical(howMuch, withAnimation, howLong, finishCallback) {
            if (typeof withAnimation !== 'undefined' && withAnimation) {
                addTransition(scrollableElement, parseInt(howMuch));
            }

            $(scrollableElement).css({
                "webkitTransform": "translateY(" + howMuch + "px) translateZ(0px)",
                "transform": "translateY(" + howMuch + "px) translateZ(0px)"
            }).attr('data-transform', Math.abs(parseInt(howMuch)));

            removeTransition(scrollableElement, finishCallback);
        }

        function doMovedCallback() {
            if (_.isFunction(actual.movedCallback)) {
                actual.movedCallback();
            }
        }

        function doEndOfScrollCallback() {
            if (_.isFunction(actual.endOfScrollVerticalCallback)) {
                actual.endOfScrollVerticalCallback(actual.locationChangeY);
            }
            if (_.isFunction(actual.endOfScrollHorizontanCallback)) {
                actual.endOfScrollHorizontanCallback(actual.locationChangeX);
            }
        }

        this.reload = function(){
            $('div.sfly_wgt_listview_spread_container').resize();
        };

        this.getCurrentLocation = function() {
            return {
                "locationChangeX": actual.locationChangeX,
                "locationChangeY": actual.locationChangeY
            }
        };

        return this;
    };

    return self;
});
define('app/view_engine/lazy_loader', ['underscore'], function(_) {

    function LazyLoader(params) {
        this.productPosition = {};
        this.PRODUCT_HEIGHT = params.prodHeight;
        
        this.addProductPosition = function(sku, top, elem, position) {
            top = parseInt(top);
            if (!this.productPosition.hasOwnProperty(top)) {
                this.productPosition[top] = [];
            }

            this.productPosition[top].push({
                "elem": elem,
                "sku": sku,
                "position": position
            });
        };

        this.getElementsInViewArea = function(viewArea) {
            var elems = [];
            var that = this;
            Object.keys(this.productPosition).forEach(function(pos) {
                pos = parseInt(pos);
                if (pos + that.PRODUCT_HEIGHT > viewArea.top && pos <= viewArea.bottom) {
                    elems = elems.concat(that.productPosition[pos]);
                }

                if (pos > viewArea.bottom) {
                    return elems;
                }
            });

            return elems;
        };

        this.getCurrentViewArea = function(padding, container, scrollTop) {
            padding = padding || 0;
            try {
                scrollTop = Number.isNaN(Number(scrollTop)) ? 0 : scrollTop;
            } catch(e) {
                //support for IE and other browsers which doesnot support Number.isNan
                scrollTop =  (typeof(Number(scrollTop)) === 'number' && isNaN(Number(scrollTop))) ? 0 : scrollTop;
            }
            
            //var ctr = $(container).find('.sfly_wgt_listview_container');
            return {
                "top": scrollTop - padding,
                "bottom": scrollTop + $(container).height() + padding
            }
        };

        this.showVisibleProducts = function(visibleElems, renderCallback) {
            visibleElems.forEach(function(elem) {
                // use deffering to release the ui thread
                if (typeof elem !== 'undefined' && elem !== null) { // happens in IE11
                    setTimeout(function ()
                    {
                        renderCallback(elem.sku, elem.position);
                    }, 0)
                }
            });
        };

        this.reset = function() {
            this.productPosition = {};
        }
    }

    return LazyLoader;

});
define('app/view_engine/helpers', ['underscore', 'app/product_proxy'], function(_, productProxy) {
    function ImageQueue() {
        this.MAX_CONCURRENT = 5;
        this.PRIORITY = {
            "HIGH": 8,
            "MEDIUM": 4,
            "LOW": 2
        };
        this.freeDownloadSpots = this.MAX_CONCURRENT;
        this.totalWaiting = 0;
        this.queue = {};

        initQueues.call(this);

        function initQueues() {
            var that = this;
            Object.keys(this.PRIORITY).forEach(function(priority) {
                that.queue[that.PRIORITY[priority]] = new MGSet();
            })
        }

        function getPhotoRefIdsFromProduct(product) {
            if (!product[Object.keys(product)[0]].hasOwnProperty('surfaces')) {
                return [];
            }
            var surfaces = product[Object.keys(product)[0]].surfaces;

            // gather photo references - so we download only photos that are actually used
            var photoRefIds = [];
            Object.keys(surfaces).forEach(function(surfId) {
                var photos = surfaces[surfId].canvas.layout.photos;
                photoRefIds = photoRefIds.concat(_.map(Object.keys(photos), function(pId) { return photos[pId].photoRefId; }))
            });

            return photoRefIds;
        }

        function getPhotoUrlsByPhotoRefIds(product, photoRefIds) {
            var photoUrls = {}; // Using an object to avoid duplicates
            photoRefIds.forEach(function(refId) {
                var photoRef = getPhotoByPhotoRefIds(product[Object.keys(product)[0]].photoStrip, refId);
                photoUrls[photoRef.url] = true;
            });

            return Object.keys(photoUrls);
        }

        function getPhotoByPhotoRefIds(photoStrip, photoRefId) {
            for(var i=0; i<photoStrip.length; i++){
                if(photoStrip[i].photoRefId == photoRefId) {
                    return photoStrip[i];
                }
            }
            return null;
        }

        function photoUrlsFromProduct(product) {
            return getPhotoUrlsByPhotoRefIds(product, getPhotoRefIdsFromProduct(product));
        }

        this.addUrl = function(priority, url, startDownload) {
            priority = priority || this.PRIORITY.LOW;
            this.queue[priority].add(url, new QueuableImage(url, priority, this.removeUrl.bind(this), this.removeUrl.bind(this)));
            this.totalWaiting++;
            if (startDownload) {
                this.startDownload();
            }
        };

        this.removeUrl = function(url) {
            var that = this;
            Object.keys(this.queue).forEach(function(queueName) {
                that.queue[queueName].remove(url);
            });
            this.freeDownloadSpots++;
            this.startDownload();
        };

        this.addProduct = function(product, priority) {
            photoUrlsFromProduct(product).forEach(this.addUrl.bind(this, priority));
        };

        this.startDownload = function() {
            var that = this;
            if (this.totalWaiting > 0 && this.freeDownloadSpots > 0) {
                // Running through the priorities will start with the highest and go down...
                Object.keys(this.PRIORITY).forEach(function(priority)
                {
                    that.queue[that.PRIORITY[priority]].iterate(function(img)
                    {
                        if (that.freeDownloadSpots > 0) {
                            if (img.download()) {
                                that.freeDownloadSpots--;
                                that.totalWaiting--;
                            }
                        }
                    });
                });
            }
        };
    }

    function QueuableImage(url, priority, completeCallback, failCallback) {
        this.src = url;
        this._retries = 0;
        this._isDownloading = false;
        this._priority = priority;

        this._onerror = function() {
            if (this._retries < 3) {
                setTimeout(this.download, 1000);
            } else if (_.isFunction(failCallback)) {
                this._isDownloading = false;
                console.log('[Product Widget] Failed to download image - ', url);
                failCallback(this.src);
            }

            this._retries++;
        };

        this._onload = function() {
            console.log('[Product Widget] Image downloaded successfuly');
            this._isDownloading = false;
            if (_.isFunction(completeCallback)) {
                completeCallback(this.src);
            }
        };

        this.getPriority = function() {
            return this._priority;
        };

        this.download = function() {
            if (!this._isDownloading) {
                var img = new Image();
                if (typeof this._onload !== 'undefined') {
                    img.onload = this._onload.bind(this);
                }
                if (typeof this._onerror !== 'undefined') {
                    img.onerror = this._onerror.bind(this);
                }
                img.src = this.src;
                this._isDownloading = true;
                return true;
            }

            return false;
        };
    }

    function MGSet() {
        this.set = {};

        this.add = function(key, val) {
            if (typeof key !== 'undefined' && key.length > 0) {
                this.set[key] = val;
            }
            return this;
        };

        this.remove = function(key) {
            if (key in this.set) {
                delete this.set[key];
            }

            return this;
        };

        this.includes = function(key) {
            return key in this.set;
        };

        this.iterate = function(callback) {
            var that = this;
            Object.keys(this.set).forEach(function(key) { callback(that.set[key]); });
            return this;
        };
    }

    var Utils = {
        "removeUnsupportedProducts": function(skus, numOfPhotos) {
            var skusToUse = [];
            skus.forEach(function(sku) {
                if (productProxy.getMinimalNumOfSupportedPhotos(sku) <= numOfPhotos) {
                    skusToUse.push(sku);
                }
            });
            return skusToUse;
        },

        "productHasSuitableLayout": function(sku, numOfPhotos) {
            return productProxy.getMinimalNumOfSupportedPhotos(sku) <= numOfPhotos;
        }
    };

    return {
        "ImageQueue": ImageQueue,
        "Set": MGSet,
        "Utils": Utils
    }
});
/*
 This module will include the minimal version of the modal window for products
 */

define('app/view_engine/modals/full/modal_product',
    ['underscore', 'app/templates', 'mgthumb', 'app/asset_mapper', 'app/tracking', 'magicselect', 'app/product_proxy', 'app/view_engine/widgets/common', 'app/config_manager', 'app/view_engine/modals/shared', 'app/click_through', 'app/scroller', 'app/view_engine/modals/full/modal', 'app/thumbgen_wrapper', 'app/time_monitor', 'app/cache_module', 'app/view_engine/lazy_loader', 'app/view_engine/helpers', 'app/utils'],
    function (_, templates, mgthumb, AssetMapper, tracking, magicselect, productProxy, view_common, config, modal_common, clickThrough, scroller, modal, thumbGenWrapper, monitor, cache, LazyLoader, helpers, utils) {

        var isAfterUPP = false;
        var isThisLifeGeneral = false;
        var mixedSourcesGeneral = false;
        var self = this;
        var renderedProds = null;
        var PROD_HEIGHT = 307;
        var lazyLoader = new LazyLoader({"prodHeight": PROD_HEIGHT});
        var renderCallback = null;
        var productsContainer = null;
        var VIEW_PORT_PAD = 150;
        var PRODS_IN_PAGE = 18;
        var CURR_PAGE = 0;
        var TOTAL_PAGES = 0;
        var sideopen = null;
        var numRenderedProducts = 0;
        var numProdPerLine = 0;
        var renderBatchClb = null;
        var scrollPosition = 0;
        var pagingScrollPosition = 0;
        var scrollSpeedFactor = 10;
        var useNewStyleGuide;
        var doNotResizeImages;
        var tooltipProducts;
        var leftPaneProducts;
        var showTooltip = false;
        var showLeftPane = false;
        var stylesOriginal;
        var productMaxHeight = 0;
        var productMinHeight = Number.MAX_VALUE;
        var productMaxWidth = 0;
        var productMinWidth = Number.MAX_VALUE;
        var productMinTop = Number.MAX_VALUE;
        var productMinRealHeight = Number.MAX_VALUE;
        var numOfProductsInLine = 3;
        var productMaxRatio = 1;
        var productMinRatio = 1;
        var productMinHeight = 300;
        var MOBILE_PRODUCT_PADDING = 10;
        var MOBILE_HEIGHT_BONUS = 1.2;

        // Will render all pages for a product in the given container
        var renderProducts = function (pId, productType, container, mgThumbGen, masks, onRenderedCallback) {

            var PRODUCT_PROJECTIONS = 5;

            // We need this function to keep the right order inside the generate function
            var generated = 0;

            function _generate(order) {
                mgThumbGen.generate(parseInt(order), pId, true, function (canvas) {
                    $(canvas).attr('data-order', order).hide();
                    $(container).append(canvas);
                    generated++;

                    if (typeof(onRenderedCallback) !== "undefined" && _.isFunction(onRenderedCallback)) {
                        if (generated == PRODUCT_PROJECTIONS - 1) {
                            onRenderedCallback();
                        }
                    }
                }, true, {masks: masks});
            }

            if (!$(container).attr('data-rendered')) {
                // Put this first - to block more attempts to render
                $(container).attr('data-rendered', true);
                var numOfPages = PRODUCT_PROJECTIONS;
                $(container).attr('data-pages', PRODUCT_PROJECTIONS);

                function generateWithTimeout(i) {
                    setTimeout(function () {
                        _generate(i);
                    }, i * 50);
                }

                for (var i = 1; i < numOfPages; i++) {
                    generateWithTimeout(i);
                }
            }
        };

        function doClickThrough(pId, sku, productJson, productType, handleCurrentPidCallback, album) {
            var product = view_common.findProjectJsonProduct(productJson, handleCurrentPidCallback(pId), self.isAfterUPP);

            if (cache.get("partner_user_id") == "009085953279") {
                window.location = typeof view_common.getProduct(pId).personalizeUrl !== "undefined" ? view_common.getProduct(pId).personalizeUrl : view_common.getProduct(pId).seeMoreUrl;
            } else {
                if (self.Model.get('openInNewTab')) {
                    self.winHandler = self.openNewWindow(self.winHandler);
                } else {
                    self.winHandler = null;
                }

                var prod = view_common.getProduct(pId);
                product.product.info.productCode = prod["productCode"];
                product.product.info.sku = prod["sku"];
                clickThrough.sendToClickThrough(product, productType, view_common.showLoading.bind(this, $('#sfly_wgt_full_openwin_container')), view_common.removeLoading.bind(this, $('#sfly_wgt_full_openwin_container')), album, self.winHandler, self.Model, prod.personalizeUrl);

            }

            var prodJson = view_common.getProduct(handleCurrentPidCallback());
            var prodPositionInModal = $('#sfly_wgt_full_openwin_container .sfly_wgt_product[data-pid="' + pId + '"]').attr('data-position');
            var trackingOption = self.augmentTracking({sku: prodJson.sflySku, order: prodPositionInModal}, self.Model);
            var title = $('#sfly_wgt_sideopen_title>h2>.sfly_wgt_tooltip_hover_area').text().replace(",", "");
            var trackingSku = title ? title : sku;
            if (cache.get('mode') === 'instance') {
                tracking.track('tl', 'click-product', {
                    sku: trackingSku,
                    pid: sku,
                    prod_type: self.Model.get('prod_type')
                });
            } else {
                tracking.track('open', 'personalize', trackingOption);
            }

        }

        function onScroll(renderCallback, container) {
            var innerContainer = $(container).find('#sfly_wgt_sideopen_products_inner_container');
            scrollPosition = parseInt($(container).scrollTop());
            lazyLoader.showVisibleProducts(lazyLoader.getElementsInViewArea(lazyLoader.getCurrentViewArea(VIEW_PORT_PAD, container, scrollPosition)), renderCallback);
            var totalScroll = scrollPosition + container.height();

            if (totalScroll > innerContainer.height() - 200) {
                onScrollEnd(scrollPosition);
            }

        }

        function onScrollEnd(position) {
            CURR_PAGE++;
            pagingScrollPosition = position - 50;
            if (CURR_PAGE < TOTAL_PAGES) {
                setTimeout(function () {
                    renderBatchClb(CURR_PAGE);
                }, 1200);
            }
        }

        function addLoadMore(prodContainer) {
            $(prodContainer).append(view_common.renderTemplate(templates.popup_loadmore));
        }

        function calcProductDimensions(containerWidth, productWidth, productHeight, prodSpace, useGlobalHeight) {
            var MIN_HEIGHT = 200;
            var VERTICAL_PROD = 'vertical';
            var HORIZONTAL_PROD = 'horizontal';
            useGlobalHeight = typeof useGlobalHeight !== 'undefined' ? useGlobalHeight : true;

            var productOrientation = (productHeight / productWidth > 2 ? VERTICAL_PROD : HORIZONTAL_PROD); // very "tall"
            var targetProdInLine = useNewStyleGuide ? 4 : 3; // horizontal product
            if (productOrientation == VERTICAL_PROD) {
                targetProdInLine = 4; // vertical product
            }

            var results = {};
            var availableWidth = containerWidth / targetProdInLine;
            if (utils.isMobile) {
                targetProdInLine = 2;
                containerWidth = $(sideopen).find('#sfly_wgt_sideopen_products_inner_container').outerWidth();
                prodSpace = productWidth > productHeight ? productWidth : productHeight;

                availableWidth = containerWidth / targetProdInLine - MOBILE_PRODUCT_PADDING * 2;
                results.resizeFactor = availableWidth / prodSpace;
                results.newProductWidth = Math.floor(productWidth * results.resizeFactor);
                results.newProductHeight = Math.floor(productHeight * results.resizeFactor);
                results.newProdSpace = availableWidth + 8; //artificial fix for border margins
                return results;
            }


            results.newProductWidth = productWidth;
            results.newProductHeight = productHeight;
            results.newProdSpace = prodSpace;
            results.resizeFactor = 1;

            if (useGlobalHeight) {
                var ratio = productMinHeight / productHeight;
                results.newProductHeight = productMinHeight;
                results.newProductWidth = productWidth * ratio;
                results.newProdSpace = Math.floor(prodSpace * ratio);
                results.resizeFactor = ratio;
            } else {
                while (targetProdInLine > 0) {
                    availableWidth = containerWidth / targetProdInLine;

                    if (availableWidth > prodSpace) {
                        results.newProdSpace = Math.floor(availableWidth);
                        results.newProductWidth = productWidth;
                        results.newProductHeight = productHeight;
                        results.resizeFactor = 1;
                    } else { // we need to resize
                        results.resizeFactor = availableWidth / prodSpace;
                        results.newProductWidth = Math.floor(availableWidth * results.resizeFactor);
                        results.newProductHeight = Math.floor(productHeight * results.resizeFactor);
                        results.newProdSpace = Math.floor(prodSpace * results.resizeFactor);
                    }

                    if (results.newProductHeight > Math.min(MIN_HEIGHT, productHeight)) {
                        break;
                    } else {
                        targetProdInLine--;
                    }
                }
            }

            return results;
        }

        function calcCommonSize(products, productJson) {
            var containerWidth = $(sideopen).find('#sfly_wgt_sideopen_products_container').width();
            productMaxRatio = 1;
            productMinRatio = 1;

            _.first(products, PRODS_IN_PAGE).forEach(function (sku) {
                var product = view_common.getProduct(sku);
                var size = view_common.getProductRealSize(productJson, sku);
                var isMug = product['type'] == 'mug';
                var prodNoSpaceWidth = size.width;
                var prodSpace = prodNoSpaceWidth + 4 * 2 + (isMug ? 124 : 100);
                var productWidth = size.width;
                var productHeight = size.height;
                var productTop = size.top;

                var productRealWidth = size.width;
                var productRealHeight = size.realHeight;

                productMaxRatio = productRealWidth / productRealHeight > productMaxRatio ? productRealWidth / productRealHeight : productMaxRatio;
                productMinRatio = productRealWidth / productRealHeight < productMinRatio ? productRealWidth / productRealHeight : productMinRatio;

                // if((productMaxRatio > 2 && productMinRatio < 0.5) || (productMaxRatio < 2 && productMinRatio > 0.5)){
                //     numOfProductsInLine = 3;
                // }
                // else if(productMaxRatio > 2){
                //     numOfProductsInLine = 2
                // }
                // else{
                //     numOfProductsInLine = 4;
                // }

                var res = calcProductDimensions(containerWidth, productWidth, productHeight, prodSpace, false);
                var productFinalRealHeight = Math.floor(res.resizeFactor * size.realHeight);

                productMaxHeight = res.newProductHeight > productMaxHeight ? res.newProductHeight : productMaxHeight;
                productMinHeight = res.newProductHeight < productMinHeight ? res.newProductHeight : productMinHeight;
                productMaxWidth = res.newProdSpace > productMaxWidth ? res.newProdSpace : productMaxWidth;
                productMinWidth = res.newProdSpace < productMinWidth ? res.newProdSpace : productMinWidth;
                productMinTop = productTop < productMinTop ? productTop : productMinTop;
                productMinRealHeight = productFinalRealHeight < productMinRealHeight ? productFinalRealHeight : productMinRealHeight;

            });
        }

        function calcNumOfProductsInLine(){
            if(window.innerWidth < 639){
                numOfProductsInLine = 1;
                return;
            }

            if((productMaxRatio > 1.6 && productMinRatio < 0.5) || (productMaxRatio < 1.6 && productMinRatio > 0.5)){

                numOfProductsInLine = 3;
            }
            else if(productMaxRatio > 1.6){
                numOfProductsInLine = 2;
            }
            else{
                numOfProductsInLine = 4;
            }

            if(window.innerWidth < 767){
                numOfProductsInLine--;
            }
        }

        function calcProdunctMinHeight(productWidth) {
            if(numOfProductsInLine == 1){
                productMinHeight = Math.min(productWidth, 350);
            }
            else if(numOfProductsInLine == 4){
                productMinHeight = productWidth / productMinRatio;
            }
            else if(numOfProductsInLine == 2){
                productMinHeight = productWidth / productMaxRatio;
            }
            else{
                productMinHeight = productWidth;
            }

            productMinHeight = Math.min(productMinHeight, 350);
        }

        function renderProductsBatch(prodStyles, productJson, currAlbum, handleCurrentPidCallback, page) {
            var localSku = prodStyles[0];
            var origProduct = view_common.getProduct(localSku);
            var size = view_common.getProductRealSize(productJson, prodStyles[0]);
            var isMug = origProduct['type'] == 'mug';
            var prodNoSpaceWidth = size.width;
            var prodSpace = prodNoSpaceWidth + 4 * 2 + (isMug ? 124 : 100);
            var prodRange = {start: page * PRODS_IN_PAGE, end: page * PRODS_IN_PAGE + PRODS_IN_PAGE};

            if (prodRange.end > prodStyles.length) {
                prodRange.end = prodStyles.length;
            }

            var prodContainer = $(sideopen).find('#sfly_wgt_sideopen_products_inner_container');
            var prodContainerNumEl = prodContainer.find('.sfly_wgt_product');
            var placeholderTemplate = view_common.renderTemplate(templates.popup_placeholder);
            var containerWidth = prodContainer.width();
            var productWidth = size.width;
            var productHeight = size.height;

            calcCommonSize(prodStyles, productJson);
            var res = calcProductDimensions(containerWidth, productWidth, productHeight, prodSpace);

            calcNumOfProductsInLine();
            calcProdunctMinHeight(containerWidth/numOfProductsInLine);

            // Remove "Load more" if there
            $(prodContainer).find('.sfly-wgt-modal-load-more').remove();

            // Allow to scroll before everything is rendered.
            renderCallback = renderProduct.bind(undefined, productJson, prodStyles.length, removeLoader.bind(undefined, prodStyles.length), handleCurrentPidCallback, numProdPerLine, currAlbum);
            if (prodContainerNumEl.length == 0 || page > 0) {
                for (var k = prodRange.start; k < prodRange.end; k++) {
                    var prodType = view_common.getProduct(prodStyles[k]).type;
                    var elem = $('<div class="sfly_wgt_product sfy_wgt_product_border" data-position="' + k + '" data-ptype="' + prodType + '" data-pid="' + prodStyles[k] + '" data-page="' + page + '">' + placeholderTemplate + '</div>');
                    $(prodContainer).append(elem);
                }

                $(prodContainer).append('<div id="sfly_wgt_more_styles_produts"><a href="' + origProduct.seeMoreUrl + '" class="sfly-wgt-lightlink">See more styles ></a> </div>');
                // Make them take the right places - as if they were the actual products
                var conWidth, conHeight;

                if (utils.isMobile) {
                    conWidth = Math.max((res.newProdSpace - 2 * 4), res.newProductHeight) + 2 * MOBILE_PRODUCT_PADDING;
                    conHeight = Math.max(conWidth, productMaxHeight * MOBILE_HEIGHT_BONUS) + 2 * MOBILE_PRODUCT_PADDING;

                } else {
                    conWidth = res.newProductWidth;
                    conHeight = res.newProductHeight;
                }

                $(prodContainer).find('.sfly_wgt_product[data-page="' + page + '"]').css({
                    width: conWidth + 'px',
                    height: conHeight + 'px',
                    'margin-right': ((res.newProdSpace - res.newProductWidth) / 2 - 4) + 'px', // leave 4px for the border
                    'margin-left': ((res.newProdSpace - res.newProductWidth) / 2 - 4) + 'px' // leave 4px for the border
                });


                // Need it here only after the CSS's are applied
                $.each($(prodContainer).find('.sfly_wgt_product'), function (i, elem) {
                    if ($(elem).attr('data-added-pos') != 'true') {
                        lazyLoader.addProductPosition($(elem).attr('data-pid'), $(elem).position().top, $(elem), parseInt($(elem).attr('data-position')));
                        $(elem).attr('data-added-pos', 'true');
                    }
                });

                //if (prodRange.end < prodStyles.length) {
                //    addLoadMore(prodContainer);
                //}

                productsContainer.off().on('scroll', _.debounce(onScroll.bind(undefined, renderCallback, productsContainer), 300));
                //scroller(
                //    $('#sfly_wgt_sideopen_products_container'),
                //    $('#sfly_wgt_sideopen_products_inner_container'),
                //    {},
                //    {
                //        orientation: "vertical",
                //        color:       "gray",
                //        marginTop:   10,
                //        movedCallback: _.debounce(onScroll.bind(undefined, renderCallback, productsContainer), 300),
                //        endOfScrollVerticalCallback: _.debounce(onScrollEnd, 1000, true),
                //        locationChangeY: pagingScrollPosition,
                //        SPEED_FACTOR: scrollSpeedFactor
                //    }
                //);
            }

            _.each(prodStyles, function (style) {
                //self.Model.get('downloadQueue').addProduct(view_common.findProjectJsonProduct(productJson, style, self.isAfterUPP), self.Model.get('downloadQueue').PRIORITY.HIGH);
                if (!renderedProds.hasOwnProperty(style)) {
                    renderedProds[style] = false;
                }
            });

            onScroll(renderCallback, productsContainer);
        }

        // Will render the products
        function renderProduct(productJson, totNumOfProducs, removeLoaderCallBack, handleCurrentPidCallback, numProdPerLine, currAlbum, pId, index) {
            // if product already was rendered, no need to do anything here
            if (renderedProds[pId]) {
                return;
            }

            var product = view_common.findProjectJsonProduct(productJson, pId, self.isAfterUPP);
            var prodType = view_common.getProduct(pId).type;
            var productId = config.parseProductId(view_common.getProduct(pId));
            var partnerId = AssetMapper.GetPartnerId(product, prodType);

            thumbGenWrapper.prepareThumbGenAssets(pId, productId, 'medium', prodType, product, function (result) {
                if (result == null || typeof result.layoutJson === 'undefined' || typeof result.designJson === 'undefined') {
                    console.log('[Product Widget] missing layout / design json');
                    return;
                }

                if (result.hasOwnProperty('productInfo') && result.productInfo.sku != pId) {
                    self.Model.get('monitoring').reportEvent('GotFallbackProd');
                }

                var layoutJson = JSON.stringify(result.layoutJson);
                var designJson = JSON.stringify(result.designJson);

                renderThumb(productJson, pId, index, prodType, partnerId, product, layoutJson, designJson, result.layoutMasks, totNumOfProducs, numProdPerLine, removeLoaderCallBack, handleCurrentPidCallback, currAlbum);
            });
        }

        function renderThumb(productJson, pId, index, productType, partnerId, product, layoutJson, designJson, layoutMasks, totNumOfProducs, numProdPerLine, removeLoaderCallBack, handleCurrentPidCallback, currAlbum) {
            if (renderedProds[pId]) {
                return;
            }

            renderedProds[pId] = true;

            var useCDN = cache.get('env') != 'beta' && cache.get('env') != 'dev';
            var mgThumbGen  = new MgThumbGenerator(cache.get('env'),useCDN);

            mgThumbGen.init(productType, partnerId, product, layoutJson, designJson, self.Model.get('monitoring').reportEvent, cache.get('env'), doNotResizeImages);

            mgThumbGen.generate(parseInt(0), pId, true, function (canvas) {
                var elem = $(view_common.renderTemplate(templates.fullview_product_price, {
                    pid: pId,
                    sku: view_common.getProduct(pId)['sfly_sku'],
                    ptype: productType,
                    title: view_common.getProduct(pId)['shortName'],
                    price: utils.isMobile ? config.getPrice(view_common.getProduct(pId)['sku']) : null,
                    isMobile: utils.isMobile
                }));
                $(canvas).attr('data-order', 0);

                // the position of the product in the row (if second row subctract the num of products in the first row)
                var prodPositionInLine = index;
                elem.attr('data-position', prodPositionInLine);
                elem.addClass("sfy_wgt_product_border");
                var prodInner = elem.children('.sfly_wgt_product_inner');
                prodInner.html(canvas);
                var prodContainer = $(sideopen).find('#sfly_wgt_sideopen_products_inner_container');
                //var prodContainerWrapper = $(sideopen).find('#sfly_wgt_sideopen_products_container');

                //prodContainer.hide();
                prodContainer.css('visibility', 'hidden');
                elem.css('visibility', 'hidden');
                var productContBox = prodContainer.find('.sfly_wgt_product[data-position="' + prodPositionInLine + '"][data-ptype="' + productType + '"]');
                var resizeRenderCallback = function (productContBox, prodContainer, elem) {
                    if (productContBox.length == 0) {
                        //prodContainer.append(elem);
                    } else {
                        productContBox.replaceWith(elem);
                    }
                    elem.css('visibility', 'visible');
                };


                // Resize by height and width
                var addLeftPadding = prodPositionInLine == 1 || (prodPositionInLine - 1) % numProdPerLine == 0;
                var throttledScroller = _.throttle(scroller.bind(
                    undefined,
                    $('#sfly_wgt_sideopen_products_container'),
                    $('#sfly_wgt_sideopen_products_inner_container'),
                    {},
                    {
                        orientation: "vertical",
                        color: "gray",
                        marginTop: 10,
                        movedCallback: _.debounce(onScroll.bind(undefined, renderCallback, productsContainer), 300),
                        locationChangeY: pagingScrollPosition - $(elem).height(), // move a little back for a better scroll feel
                        endOfScrollVerticalCallback: _.debounce(onScrollEnd, 1000, true),
                        SPEED_FACTOR: scrollSpeedFactor
                    }
                ), 1000);
                _.defer(updateProductCenteringContainer.bind(undefined, elem, pId, productJson, addLeftPadding, throttledScroller, resizeRenderCallback.bind(undefined, productContBox, prodContainer, elem)));

                // Bind the click through button
                prodInner.off('click').on('click', function () {
                    var pId = $(this).parent().attr('data-pid');
                    var sku = $(this).parent().attr('data-sku');
                    doClickThrough(pId, sku, productJson, productType, handleCurrentPidCallback, currAlbum);
                });

                elem.find('#sfly_wgt_product_buttons > .sfly-wgt-orange-btn-sfly').off('click').on('click', function () {
                    var pId = $(this).parent().parent().parent().attr('data-pid');
                    var sku = $(this).parent().parent().parent().attr('data-sku');
                    doClickThrough(pId, sku, productJson, productType, handleCurrentPidCallback, currAlbum);
                });

                elem.find('.sfly_wgt_product_price > strong').off('click').on('click', function () {
                    var pId = $(this).parent().parent().parent().attr('data-pid');
                    var sku = $(this).parent().parent().parent().attr('data-sku');
                    doClickThrough(pId, sku, productJson, productType, handleCurrentPidCallback, currAlbum);
                });

                // show the product
                //prodContainer.show();
                prodContainer.css('visibility', 'visible');

                // if is a rotatable and not on mobile, render it and bind mousemove action
                if (view_common.isProductRotatable(productType) && !utils.isMobile) {
                    function enableMove() {
                        prodInner.on('mousemove', function (event) {
                            if ($(this).parent().parent().hasClass('sfly-wgt-dont-act')) { // Not yet ready for action.
                                return;
                            }

                            var pages = $(this).attr('data-pages');
                            var boxWidth = $(this).parent().width();
                            var leftPadding = parseFloat(($(this).css('left')).replace("px", ""));

                            // Calc real position
                            var targetPos = $(event.currentTarget).offset();
                            var mousePos = {top: event.pageY, left: event.pageX};
                            var realPos = {top: mousePos.top - targetPos.top, left: mousePos.left - targetPos.left};

                            var currPage = Math.floor((realPos.left + leftPadding) * pages / boxWidth);

                            if (currPage < 0) {
                                currPage = 0;
                            } else if (currPage >= pages - 1) {
                                currPage = pages - 1;
                            }

                            $(this).find('canvas').hide();
                            $(this).find('canvas[data-order=' + currPage + ']').show();
                        });
                    }

                    renderProducts(pId, productType, prodInner, mgThumbGen, layoutMasks, enableMove);
                }

                removeLoaderCallBack();

            }, true, {masks: layoutMasks, textEnabled:(productType !== "book")});
        }

        function updateProductCenteringContainer(elem, pId, productJson, addLeftPadding, scrollerCallback, renderCallback) {
            var container = $(elem).find('.sfly_wgt_product_inner');
            var canvas = container.children('canvas');
            var size = view_common.getProductRealSize(productJson, pId, undefined, undefined, self.isAfterUPP);

            var prodContainer = $(sideopen).find('#sfly_wgt_sideopen_products_inner_container');
            var containerWidth = prodContainer.width() - 2*numOfProductsInLine;
            var containerHeight = $(sideopen).find('#sfly_wgt_sideopen_products_container').height();
            var productWidth = size.width;
            var productHeight = size.height;
            var prodNoSpaceWidth = size.width;
            var isMug = view_common.getProduct(pId)['type'] == 'mug';
            var isBag = view_common.getProduct(pId)['type'] == 'shoppingbag';
            var prodSpace = prodNoSpaceWidth + 4 * 2 + 100;

            if (isBag) {
                size.top = 20;
            }

            var res = calcProductDimensions(containerWidth, productWidth, productHeight, prodSpace);
            var resizeFactor = res.resizeFactor;
            var mobileTargetRatio = 1;

            if (utils.isMobile) {
                resizeFactor = mobileTargetRatio = size.origWidth > size.height ? (res.newProductWidth / size.origWidth) : (res.newProductHeight / size.height);
            }

            var resize = function (x) {
                return Math.floor(x * resizeFactor);
            };

            var targetRealHeight = resize(size.height);
            var targetRealWidth = resize(size.origWidth);
            var prodTop = resize(size.top);
            var prodBottom = resize(size.bottom);
            var prodLeft = resize(size.left);
            var prodRight = resize(size.right);
            var prodWidth = resize(size.width);
            var prodHeight = resize(size.realHeight);
            var prodMinTop = resize(productMinTop);
            prodSpace = resize(prodSpace);
            var extraSpacing = (res.newProdSpace > prodSpace ? (res.newProdSpace - prodSpace) / 2 : 0);
            var boxSize, boxHeight;

            var verticalPadding = Math.max(prodTop, 15);

            // The whole area where the product is placed
            var elementWidth, elementHeight;

            if (utils.isMobile) {
                targetRealHeight = Math.floor(mobileTargetRatio * size.height);
                targetRealWidth = Math.floor(mobileTargetRatio * size.origWidth);

                boxSize = Math.max((res.newProdSpace - 2 * 4), res.newProductHeight);
                boxHeight = Math.max(boxSize, productMaxHeight * MOBILE_HEIGHT_BONUS);

                elementWidth = boxSize + 2 * MOBILE_PRODUCT_PADDING;
                elementHeight = boxHeight + 2 * MOBILE_PRODUCT_PADDING;
            } else {
                elementWidth = res.newProdSpace - 2 * 4;
                var adjustedVerticalPadding = Math.min(20, verticalPadding);
                elementHeight = prodHeight + (productMinRealHeight - prodHeight) + 60;
            }

            function getNumOfProductsInLine(productHeight, productWidth) {

                var productProportion = (productHeight / productWidth > 2 ? 'tall' :
                                         productWidth / productHeight > 2 ? 'wide' :
                                                                            'normal');

                var targetProdInLine = 3; //useNewStyleGuide ? 4 : 3; // horizontal product

                if (productProportion == 'tall') {
                    targetProdInLine = 4;
                }

                if (productProportion == 'wide') {
                    targetProdInLine = 2;
                }

                return targetProdInLine;
            }

            // var numOfProductsInLine = getNumOfProductsInLine(size.height, size.width);
            var paddingHorizontal = 20;
            var paddingVerticalBottom = 80;

            var minHeight = productMinHeight;//containerWidth/3+70; //300;

            /* The wanted width of the product so there will be 3 products in a row: */
            var elemWidth = containerWidth / numOfProductsInLine;
            /* he wanted height of the product so all will be same height: */
            var elemHeight = containerHeight / 2; //minHeight;

            /* Maximise the width and height in the given space */
            var widthRatio = (elemWidth - paddingHorizontal) / size.width;
            var heightRatio = (elemHeight - paddingVerticalBottom) / size.realHeight;

            /* Take the maximum ratio possible so that both width and height won't exceed the wanted space */
            var minRatio = Math.min(widthRatio, heightRatio);

            var newHeight = minRatio * size.height;
            var newWidth = minRatio * size.origWidth;
            var newLeftP = minRatio * ((size.left + size.right) / 2 - size.left) + ((elemWidth - newWidth) / 2);
            var newTopP = minRatio * ((size.top + size.bottom) / 2 - size.top) + ((elemHeight - paddingVerticalBottom/2 - newHeight) / 2);

            /* Set the style of the li containing element */
            $(elem).height(elemHeight);//newHeight + 65 - minRatio*size.bottom); //padding from bottom of the product itself will be 65px
            $(elem).width(elemWidth);

            // Position the actual product inside the containing cell
            var leftPos, topPos, innerActionBtm;
            if (utils.isMobile) {
                // leftPos = Math.ceil((boxSize - targetRealWidth) / 2) + Math.ceil((prodRight - prodLeft) / 2);
                // topPos = Math.ceil((boxSize - targetRealHeight) / 2) + Math.ceil((prodBottom - prodTop) / 2) - MOBILE_PRODUCT_PADDING;
                // // adjust by mobile padding
                // leftPos += MOBILE_PRODUCT_PADDING;
                // topPos += MOBILE_PRODUCT_PADDING;
                // innerActionBtm = MOBILE_PRODUCT_PADDING;
            } else {
                // leftPos = -1 * (Math.floor(prodLeft) - resize(50)) + extraSpacing;
                // topPos = verticalPadding - prodTop;
                // innerActionBtm = Math.floor(prodBottom - verticalPadding - (verticalPadding - prodTop) - 1);
            }
            //
            // container
            //     .height(targetRealHeight)
            //     .width(targetRealWidth)
            //     .css('left', leftPos + 'px')
            //     .css('top', 10 - prodTop + 'px');

            container.height(newHeight);
            container.width(newWidth);
            container.css('left', newLeftP + 'px');
            container.css('top', newTopP + 'px');

            // if (targetRealHeight < 180 && targetRealWidth > 180) { //patch to fix "Catch All Trays"
            //     container
            //         .css('top', '0');
            // }
            // .css('margin-top', topPos + 'px');

            // $(elem).find(".sfly_wgt_product_inner_action").css('bottom', innerActionBtm + 'px');


            container
                .attr('data-height', targetRealHeight)
                .attr('data-width', targetRealWidth)
                .attr('data-top', prodTop)
                .attr('data-bottom', prodBottom)
                .attr('data-left', prodLeft)
                .attr('data-right', prodRight)
                .attr('data-prod-width', prodWidth)
                .attr('data-prod-height', prodHeight);

            // if (res.newProdSpace < productMaxWidth) {
            //     var padding = Math.floor((productMaxWidth - res.newProdSpace) / 2); // do the / 2 * 2 trick to clean any small discrepanices
            //     $(elem).css({
            //         // 'margin-left': padding+'px',
            //         // 'margin-right': padding+'px'
            //     });
            // }
            // text position
            // var verticalExtraPadding = 10;
            // var calculatedBottom = (Math.floor(prodBottom - verticalPadding - (verticalPadding - prodTop) - 1) - verticalExtraPadding);
            // $(elem).find(".sfly_wgt_product_inner_action").css('bottom', calculatedBottom + 'px');
            //
            // //_.defer(scrollerCallback);

            _.defer(function () {
                if (_.isFunction(renderCallback)) {
                    renderCallback();
                }
            });

            return targetRealWidth;
        }

        function removeLoader(numOfProds) {
            numRenderedProducts++;
            if (numRenderedProducts == numOfProds) {
                view_common.removeLoading($('#sfly_wgt_full_openwin_container'));

                // We need to run this again - as the size of the container might have changed after everything laoded
                // When in thislife, the size should not change
                if (!self.isAfterUPP) {
                    // The defer is because the container is sometimes being resized while calling the scroller and the scroller is with a wrong scroll
                    //_.defer(
                    //    scroller.bind(
                    //        undefined,
                    //        $('#sfly_wgt_sideopen_products_container'),
                    //        $('#sfly_wgt_sideopen_products_inner_container'),
                    //        {},
                    //        {
                    //            orientation: "vertical",
                    //            color: "gray",
                    //            marginTop: 10,
                    //            movedCallback: _.debounce(onScroll.bind(undefined, renderCallback, productsContainer), 300),
                    //            locationChangeY: pagingScrollPosition,
                    //            endOfScrollVerticalCallback: _.debounce(onScrollEnd, 1000, true),
                    //            SPEED_FACTOR: scrollSpeedFactor
                    //        }
                    //    )
                    //);
                }
            }
        }

        // Slide the modal window into view and render the view
        var openSlideAndRenderProduct = function (pId, productJson, prodStyles, prodOptions, forcedClose, loadedAlbums, currAlbum, takeLockCallback, releaseLockCallback, buttonCloseCallback, changeOpenStatusCallback, handleCurrentPidCallback, viewDisableCallback, self) {
            var openwinContainer = $('#sfly_wgt_full_openwin_container');

            var currSelection = {
                currAlbum: currAlbum
            };
            // Center the product and add sizes as data attributes
            numProdPerLine = 0;
            TOTAL_PAGES = Math.ceil(prodStyles.length / PRODS_IN_PAGE);
            CURR_PAGE = 0;
            scrollPosition = 0;
            pagingScrollPosition = 0;
            numRenderedProducts = 0;
            renderedProds = {};
            scrollSpeedFactor = TOTAL_PAGES > 1 ? 15 : 20;
            productMaxHeight = 0;
            productMinHeight = Number.MAX_VALUE;
            productMaxWidth = 0;
            productMinWidth = Number.MAX_VALUE;
            productMinTop = Number.MAX_VALUE;
            productMinRealHeight = Number.MAX_VALUE;

            openwinContainer.find('#sfly_wgt_sideopen_products_inner_container').empty();
            lazyLoader.reset();

            // Will stop loading, release the global lock and show the product styles.
            function releaseLockAndStopLoading(callBackOpenWindow, dontRender) {
                releaseLockCallback();
                view_common.removeLoading(openwinContainer);
                $(self.Model.get('container')).find('.sfly_wgt_product[data-pid="' + pId + '"]').removeClass('not-selected');
                self.setIsWidgetOpen(true);
                self.removeLoadingFromWidget();

                // On mobile, don't call this - as we want the MG to remain open in the Background
                if (_.isFunction(self.Model.get('Callback')) && !utils.isMobile) {
                    self.Model.get('Callback')({action: 'showing_product', productType: 'products'});
                }

                if (dontRender) {
                    return;
                }

                /* calculate the popup size */
                numProdPerLine = 0;
                var size = view_common.getProductRealSize(productJson, prodStyles[0]);
                var isMug = view_common.getProduct(pId)['type'] == 'mug';
                var prodNoSpaceWidth = size.width;
                var prodSpace = prodNoSpaceWidth + 4 * 2 + (isMug ? 124 : 100);
                var popupSize = 27 * 2;
                for (var i = 0; i < 4; i++) {
                    popupSize += prodSpace;
                    if (numProdPerLine >= 4 || (popupSize > 980 && numProdPerLine >= 3) || popupSize > 1080) {
                        popupSize -= prodSpace;
                        break;
                    }
                    numProdPerLine++;
                }

                var renderProductsFunction = function () {
                    if (showLeftPane) {
                        if (openwinContainer.width() > 800) {
                            $('#sfly_wgt_sideopen_left_pane').show();
                            $('#sfly_wgt_sideopen_container').addClass('left-pane-visible');
                        } else {
                            $('#sfly_wgt_sideopen_left_pane').hide();
                            $('#sfly_wgt_sideopen_container').removeClass('left-pane-visible');
                        }
                    }
                    // show new upp bubble if we don't have a cookie
                    self.showNewBubblePop(sideopen, 'products');
                    renderBatchClb = renderProductsBatch.bind(undefined, prodStyles, productJson, currSelection.currAlbum, handleCurrentPidCallback);
                    renderBatchClb(CURR_PAGE);
                };

                //$(openwinContainer).css('width', popupSize+'px').css('margin-left', '-'+(popupSize/2)+'px');
                if (_.isFunction(callBackOpenWindow)) {
                    callBackOpenWindow(function () {
                        _.defer(function () {
                            renderProductsFunction()
                        })
                    });
                } else {
                    _.defer(function () {
                        renderProductsFunction()
                    });
                }

            }

            var origProduct = view_common.getProduct(pId);
            handleCurrentPidCallback(pId);

            var getTitle = function (prodOptions, pId) {
                return typeof prodOptions !== 'undefined' && prodOptions.hasOwnProperty('title') ? prodOptions['title'] : config.getProducts()[pId].title
            };

            sideopen = $(view_common.renderTemplate(templates.popup_productsmodal, {
                    title: getTitle(prodOptions, pId),
                    titleModal: typeof prodOptions['title-modal'] !== "undefined" ? prodOptions['title-modal'] : config.getProducts()[pId].title,
                    price: config.getPrice(config.getProducts()[pId].sku),
                    pid: pId,
                    size: 1,
                    see_all: origProduct.seeMoreUrl,
                    per_text: origProduct.type == 'card' ? ' per card' : '',
                    coupon: typeof cache.getCoupon() !== "undefined" ? cache.getCoupon().name : false,
                    showTooltip: showTooltip,
                    useNewStyleGuide: useNewStyleGuide,
                    // always shows for shutterfly mode
                    hideSelectButton: self.isThisLife ? self.Model.get('ismanualselect') : false,
                    //hideSelectButton:   self.Model.get('ismanualselect'),
                    isMobile: utils.isMobile,
                    hasModalMenu: self.menuContainerPresent
                }
            ));
            productsContainer = $(sideopen).find('#sfly_wgt_sideopen_products_container');

            if (cache.get('mode') == 'gifting') {
                $(sideopen).find('#sfly_wgt_upp_select').hide();
            }

            changeOpenStatusCallback(true, self.closeModalAction, function () {
                self.renderAndOpenModalAction(pId, sideopen, releaseLockAndStopLoading, forcedClose)
            });

            if (showTooltip) {
                var tooltipContainer = $('#sfly_wgt_tooltip_container');
                // append tooltip content
                var productCollection = _.sortBy(_.values(tooltipProducts), function (product) {
                    return product.order
                });

                // filter out unsupported tooltip products
                productCollection = _.filter(productCollection, function (product) {
                    return (product.sku !== 'prints_4x6');
                });

                var tooltipContentTemplate = view_common.renderTemplate(templates.popup_products_tooltip, {
                    products: productCollection,
                    currentProduct: getTitle(prodOptions, pId),
                    getTitle: getTitle
                });
                tooltipContainer.html(tooltipContentTemplate);
                self.initTooltip(tooltipContainer);
            }

            if (showLeftPane) {
                var leftPaneContainer = $('#sfly_wgt_sideopen_left_pane_product_container');
                leftPaneContainer.empty();
                var leftPaneContentTemplate = view_common.renderTemplate(templates.popup_products_left_pane, {
                    products: leftPaneProducts,
                    currentProduct: getTitle(prodOptions, pId)
                });
                leftPaneContainer.html(leftPaneContentTemplate);
            }

            // UPP
            $('#sfly_wgt_upp_select').on('click', function () {
                function onOK(groupPhotos, isThisLife, mixedSources) {
                    productJson = [];

                    function _getProductJson(pJson) {
                        if (pJson != null) {
                            // if is This Life replace photoIds in the strip with SFLY Ids
                            if (isThisLife) {
                                pJson = modal_common.replaceIdWithSFLYId(groupPhotos, pJson);
                            }
                            productJson = productJson.concat(pJson);
                        } else {
                            releaseLockCallback();
                            view_common.removeLoading(openwinContainer);
                        }
                    }

                    currSelection.currAlbum = groupPhotos;
                    self.Model.set('currAlbum', groupPhotos);
                    window.MagicShopCurrAlbum = groupPhotos;

                    isThisLifeGeneral = isThisLife;
                    mixedSourcesGeneral = mixedSources;

                    $.when(
                        productProxy.getProducts(groupPhotos, _getProductJson, true, stylesOriginal, true, isThisLife, mixedSources, true))
                        .then(function () {
                            self.isAfterUPP = true;
                            scrollPosition = 0;
                            pagingScrollPosition = 0;
                            numRenderedProducts = 0;
                            renderedProds = {};
                            prodStyles = helpers.Utils.removeUnsupportedProducts(stylesOriginal, groupPhotos.photos.length);
                            TOTAL_PAGES = Math.ceil(prodStyles.length / PRODS_IN_PAGE);
                            CURR_PAGE = 0;
                            scrollSpeedFactor = TOTAL_PAGES > 1 ? 15 : 20;

                            $(openwinContainer).find('.sfly_wgt_product').remove();
                            $(openwinContainer).find('.sfly_wgt_more_styles_produts').remove();
                            productsContainer.off();
                            lazyLoader.reset();
                            self.Model.set('ismanualselect', true);
                            releaseLockAndStopLoading();
                        })
                        .fail(function () {
                            releaseLockCallback();
                            view_common.removeLoading(openwinContainer);
                        });

                    var trackingOption = self.augmentTracking({action: 'ok', sku: origProduct['sflySku']}, self.Model);
                    tracking.track('open', 'upp', trackingOption);
                }

                function onCancel() {
                    releaseLockCallback();
                    view_common.removeLoading(openwinContainer);
                    var trackingOption = self.augmentTracking({
                        action: 'cancel',
                        sku: origProduct['sflySku']
                    }, self.Model);
                    tracking.track('open', 'upp', trackingOption);
                }

                function onCancelInstace() {
                    // Pass `dontRender` as we don't need to re-render the window
                    self.Model.set('ismanualselect', false);
                    window.MagicShopCurrAlbum = undefined;
                    self.reshowModalAction(releaseLockAndStopLoading.bind(undefined, undefined, true));
                }

                var trackingOption = self.augmentTracking({action: 'open', sku: origProduct['sflySku']}, self.Model);
                tracking.track('open', 'upp', trackingOption);

                if (_.isFunction(self.Model.get('callback'))) {
                    var renderModalWithPhotos = function (selectedPhotos) {
                        var groupPhotos = {
                            'albumId': String.fromCharCode(65 + Math.floor(Math.random() * 26)) + Date.now(),
                            'photos': selectedPhotos
                        };
                        if (selectedPhotos && selectedPhotos.length > 0) {
                            self.Model.set('ismanualselect', true);
                            self.Model.set('currentAlbum', _.clone(groupPhotos));

                        }
                        window.MagicShopCurrAlbum = groupPhotos;

                        self.reshowModalAction(function () {
                            onOK(groupPhotos, true, false);
                        });
                    };

                    self.Model.get('callback')({
                        action: 'select_photos',
                        onSuccess: renderModalWithPhotos,
                        onFail: onCancelInstace,
                        productType: 'products'
                    });
                    self.closeModalAction();
                } else {
                    view_common.showLoading(openwinContainer);
                    takeLockCallback();
                    modal_common.showUPP(onOK, onCancel);
                }
            });

            // Position the open/close button in the right place
            var btn = $('.sfly-wgt-btn-sidemodule');

            // When the window is just refreshed and re-rendered
            if (!self.getIsWidgetOpen()) {
                buttonCloseCallback(btn, 'prod_clicked');
            }
            var changeProductCallback = function (newPId, currSelection, clickedCategory) {
                // tracking params
                if (clickedCategory) {
                    var title = clickedCategory.innerText.replace(/(\r\n|\n|\r)/gm, "");

                    tracking.track('tl', 'modal-click-category', {
                        sku: title,
                        pid: newPId,
                        mode: 'instance',
                        prod_type: self.Model.get('prod_type')
                    });
                }


                var renderData = tooltipProducts[newPId].renderData;

                var pId = newPId;
                var productJson = [];
                var album = currSelection.currAlbum;
                var albums = [currSelection.currAlbum];
                var prodStyles = renderData.prodStyles;
                var prodOptions = renderData.prodOptions;
                var forceClose = renderData.forceCloseExternal;

                modal_common.hideBackgroundLoading(openwinContainer);
                view_common.showLoading(openwinContainer);

                function _getProductJson(pJson) {
                    if (pJson != null) {
                        // if is This Life replace photoIds in the strip with SFLY Ids
                        if (isThisLifeGeneral) {
                            pJson = modal_common.replaceIdWithSFLYId(album, pJson);
                        }
                        productJson = productJson.concat(pJson);
                    }
                }

                loadProductMap.call(self, pId, prodStyles[pId], function (stylesToUse) {
                    stylesOriginal = stylesToUse.slice(); //copy the array for future reference
                    stylesToUse = helpers.Utils.removeUnsupportedProducts(stylesToUse, album.photos.length);

                    $.when(
                        productProxy.getProducts(album, _getProductJson, self.isAfterUPP, stylesToUse, true, isThisLifeGeneral, mixedSourcesGeneral))
                        .then(function () {
                            openSlideAndRenderProduct(pId, productJson, stylesToUse, typeof prodOptions[pId] !== "undefined" ? prodOptions[pId] : {}, forceClose, albums, album, modal_common.callbackWrapper(renderData.callbacks.takeLock), modal_common.callbackWrapper(renderData.callbacks.releaseLock), modal_common.callbackWrapper(renderData.callbacks.animateControlButton), modal_common.callbackWrapper(renderData.callbacks.changeState), modal_common.callbackWrapper(renderData.callbacks.handleCurrentPid), modal_common.callbackWrapper(renderData.callbacks.toggleViewDisable), self);
                            _.defer(function () {
                                view_common.removeLoading(openwinContainer);
                                modal_common.showBackgroundLoading(openwinContainer);
                            });

                        })
                        .fail(function () {
                            changeOpenStatusCallback(false, self.closeModalAction);
                            setTimeout(releaseLockCallback, 200);
                        });
                });
            };

            if (showTooltip) {
                var productList = $(openwinContainer).find('#sfly_wgt_tooltip_container .sfly-wgt-book-choose-size');
                $.each(productList, function (i, product) {
                    var pId = $(product).attr('data-code');
                    $(product).on('click', changeProductCallback.bind(undefined, pId, currSelection));
                });
            }

            if (showLeftPane) {
                var leftPaneProductList = $(openwinContainer).find('#sfly_wgt_sideopen_left_pane .sfly-wgt-left-pane-category-product');
                $.each(leftPaneProductList, function (i, product) {
                    var pId = $(product).attr('data-code');
                    $(product).on('click', changeProductCallback.bind(undefined, pId, currSelection, this));
                });
            }
        };

        function loadProductMap(sku, prodStyles, callback) {
            var prod = view_common.getProduct(sku);

            if (!config.isProductMapSaved(prod.type)) {
                /* do not load product map
                this.getAssociationSkus({
                    "prodType": prod.type,
                    "callback": function (prodJson)
                    {
                        config.parseProductsFromServer(prodJson, prod.type);
                        if (_.isFunction(callback)) {
                            callback(prodStyles);
                        }
                    },
                    "failCallback": function ()
                    {
                        // We failed bringing the skus, remove anything we don't have
                        prodStyles = removedFailedSkus(prodStyles);

                        if (_.isFunction(callback)) {
                            callback(prodStyles);
                        }
                    }
                });*/
                prodStyles = removedFailedSkus(prodStyles);
                if (_.isFunction(callback)) {
                    callback(prodStyles);
                }
            } else {
                if (_.isFunction(callback)) {
                    callback(prodStyles);
                }
            }
        }

        function removedFailedSkus(prodStyles) {
            var result = [];
            _.each(prodStyles, function (sku) {
                if (typeof view_common.getProduct(sku) !== 'undefined') {
                    result.push(sku);
                }
            });

            return result;
        }

        return function () {
            modal.call(this);

            // helper for private functions
            self = this;

            // Will open the sliding window with the given products
            this.showProductsWindow = function (pId, album, albums, prodStyles, prodOptions, forceCloseExternal, isThisLife, useNewStyleGuideFlag, doNotResizeImagesFlag, tooltipItems, textualStructure, mixedSources, takeLockCallback, releaseLockCallback, closeButtonCallback, changeOpenStatusCallback, handleCurrentPidCallback, viewDisableCallback) {
                useNewStyleGuide = useNewStyleGuideFlag;
                doNotResizeImages = doNotResizeImagesFlag;
                tooltipProducts = tooltipItems || null;
                leftPaneProducts = textualStructure || null;
                showTooltip = false; //(typeof tooltipProducts != 'undefined' && tooltipProducts != null && tooltipItems.length > 0);
                showLeftPane = (typeof textualStructure !== 'undefined' && textualStructure != null && !self.menuContainerPresent);
                self.isAfterUPP = false;
                self.isThisLife = isThisLife;

                // if we have photo selected from another product
                if (this.menuContainerPresent) {
                    album = typeof window.MagicShopCurrAlbum !== 'undefined' && window.MagicShopCurrAlbum !== null ? window.MagicShopCurrAlbum : album;
                    self.isAfterUPP = true; // avoid caching
                }

                function showProducts(forceClose) {
                    var productJson = [];

                    function _getProductJson(pJson) {
                        if (pJson != null) {
                            // if is This Life replace photoIds in the strip with SFLY Ids
                            if (isThisLife) {
                                pJson = modal_common.replaceIdWithSFLYId(album, pJson);
                            }
                            productJson = productJson.concat(pJson);
                        }
                    }

                    isThisLifeGeneral = isThisLife;
                    mixedSourcesGeneral = mixedSources;

                    loadProductMap.call(self, pId, prodStyles[pId], function (stylesToUse) {
                        stylesOriginal = stylesToUse.slice(); //copy the array for future reference
                        stylesToUse = helpers.Utils.removeUnsupportedProducts(stylesToUse, album.photos.length);

                        $.when(
                            productProxy.getProducts(album, _getProductJson, self.Model.get('ismanualselect'), stylesToUse, true, isThisLife, mixedSources))
                            .then(function () {
                                openSlideAndRenderProduct(pId, productJson, stylesToUse, typeof prodOptions[pId] !== "undefined" ? prodOptions[pId] : {}, forceClose, albums, album, takeLockCallback, releaseLockCallback, closeButtonCallback, changeOpenStatusCallback, handleCurrentPidCallback, viewDisableCallback, self);
                            })
                            .fail(function () {
                                self.removeLoadingFromWidget();
                                changeOpenStatusCallback(false, self.closeModalAction);
                                setTimeout(releaseLockCallback, 200);
                            });
                    });
                }

                this.showProductsWindowFeatures(pId, album, albums, prodStyles, prodOptions, forceCloseExternal, takeLockCallback, releaseLockCallback, closeButtonCallback, changeOpenStatusCallback, handleCurrentPidCallback, viewDisableCallback, showProducts);
            };
        };

        //this.prototype = Object.create(modal.prototype);
        utils.inheritPrototype(this, modal);
    }
);

/**
 * Created by vribak on 06/06/2017.
 */
var send_link_widget = (function() {
    var validationHelper;
    return {
        getInstance: getInstance
    };

    function getInstance($template, phoneNumber, action, validator) {
        return new widget($template, phoneNumber, action, validator);
    }
    // Implements
    ///////////////

    function widget($template, phoneNumber, action, validator) {
        validationHelper = validator;
        var self = this;
        //initialize($template, phoneNumber);

        this.$template = $template;
        this.phoneNumber = phoneNumber;
        this.$input = $template.find('input');
        this.$input.val(phoneNumber || '');
        this.$sendLinkForm = this.$template.find('.send-link-form');
        this.$wrapper = this.$template.find('.send-to-phone');
        this.$toolTip = this.$template.find('.warning-tooltip');
        this.$overlay = this.$template.find('.success-overlay');
        this.errorState = false;

        this.$input.off('keyup').on('keyup', function (e) {
            if (e.keyCode === 13) {
                update(this.value);
                return;
            }
            if (self.errorState) {
                self.$toolTip.hide();
            }
        });

        // reset (x) button
        this.$template.find('.warning-icon').off('click').on('click', function() {
            self.$input.val('');
            reset();
        });

        this.$template.find("#sendPhone").off('click').on('click', function() {
            update(self.$input.val());
        });

        this.$template.find(".wrong-number").off('click').on('click', function() {
            reset();
        });


        if (self.phoneNumber) {
            onSuccess(self.phoneNumber);
        }

        return {
            show: _show,
            hide: _hide
        };

        function reset() {
            self.errorState = false;
            self.$input.removeAttr('disabled');
            self.$input.removeClass('success');
            self.$wrapper.removeClass('invalid');
            self.$sendLinkForm.removeClass('success');
            self.$sendLinkForm.show();
            self.$toolTip.hide();
            self.$wrapper.show();
            self.$overlay.hide();
        }

        function onSuccess(phoneNumber) {
            reset();
            self.$sendLinkForm.addClass('success');
            self.$sendLinkForm.hide();
            self.$overlay.show();
            self.$wrapper.hide();
            return self.$overlay.find('.phone-number').text(phoneNumber);
        }

        function onError(message) {
            var text = (message) ? message : 'Invalid number, try again';
            reset();
            self.errorState = true;
            self.$toolTip.show();
            self.$wrapper.addClass('invalid');
            return self.$toolTip.text(text);
        }

        function update(phoneNumber) {

            if (!validationHelper.phone(phoneNumber)) {
                onError();
                return;
            }
            action(phoneNumber).then(onSuccess, onError);
        }

        function _show() {
            self.$template.show();
        }

        function _hide() {
            self.$template.hide();
        }
    }

})();


define("app/view_engine/widgets/send_link", function(){});

/*
 This module will include the minimal version of the modal window for photobook
 */

define('app/view_engine/modals/full/modal_prints',
    ['underscore', 'app/templates', 'mgthumb', 'app/asset_mapper', 'app/tracking', 'magicselect', 'app/product_proxy', 'app/view_engine/widgets/common', 'app/config_manager', 'app/view_engine/modals/shared', 'app/click_through', 'app/view_engine/modals/full/modal', 'app/time_monitor', 'app/cache_module', 'app/view_engine/widgets/send_link'],
    function(_, templates, mgthumb, AssetMapper, tracking, magicselect, productProxy, view_common, config, modal_common, clickThrough, modal, monitor, cache) {

        var MAX_PRINTS      = 40; // An arbitarary number based on observation
        var didAlbumSwitch  = false;
        var isThisLifeGeneral = false;
        var mixedSourcesGeneral = false;
        var useNewStyleGuide;
        var doNotResizeImages;
        var inManualSelect = false;

        // Will render all pages for a book in the given container
        var renderBookAndPrints = function(pId, productType, container, mgThumbGen, productJson, pageToShow, self) {

            // This is code from book rendering. Need this to start from beginning.
            pageToShow = -1;

            // We need this function to keep the right order inside the generate function
            function _generate(order) {
                mgThumbGen.generate(parseInt(order), pId, true, function(canvas) {
                    $(canvas).attr('data-order', order).hide();
                    $(container).append(canvas);

                    if (pageToShow == order || self.getCurrentOpenPage() == order) {
                        $(container).find('canvas').hide();
                        $(canvas).show();
                    }
                }, true);
            }

            if (!$(container).attr('data-rendered')) {
                // Put this first - to block more attempts to render
                $(container).attr('data-rendered', true);

                var width   = $(container).attr('data-real-width');
                var height  = $(container).attr('data-height');

                var product = view_common.findProjectJsonProduct(productJson, pId, didAlbumSwitch);
                var numOfPages;
                numOfPages = parseInt(product.prints.pages.length);
                numOfPages = numOfPages > MAX_PRINTS ? MAX_PRINTS : numOfPages;

                $(container).attr('data-pages', numOfPages);

                for(var i = 1; i < numOfPages; i++) {
                    _generate((i == numOfPages-1 && productType == "book") ? 99 : i);
                }
            }
        };

        // Render the navigation template for the calendar product
        var renderBookAndPrintsNavigation = function(pId, productType, container, productJson, position, pageToShow, self) {
            var MAX_BOOK_NAV    = 400;
            var MAX_BOOK_BOX    = 40;
            var MAX_PRINTS_NAV  = 400;
            var MAX_PRINTS_BOX  = 40;
            var MIN_PAGES       = 5;

            if (typeof pageToShow === 'undefined') {
                pageToShow = -1;
            }

            if ($(container).find('.sfly-wgt-book-nav').length == 0) {
                var product = view_common.findProjectJsonProduct(productJson, pId, didAlbumSwitch);
                var numOfPages;
                if (productType == "book") {
                    numOfPages = Math.floor((product.book.pages.length) / 2) + 2;
                } else {
                    numOfPages = parseInt(product.prints.pages.length);
                    numOfPages = numOfPages > MAX_PRINTS ? MAX_PRINTS : numOfPages;
                }

                // Calculate the boxes size
                var boxSize = MAX_PRINTS_NAV / numOfPages > MAX_PRINTS_BOX ? MAX_PRINTS_BOX : MAX_PRINTS_NAV / numOfPages;

                var display = 'block';
                var paging  = view_common.renderTemplate(templates.side_prints_paging, { pages: numOfPages });
                $(container).append(paging);
                var positionTopPagining = 80;

                if(numOfPages > 2) {
                    var nav = view_common.renderTemplate(templates.book_nav, {pages: numOfPages, type: productType, currPage: pageToShow});
                    $(container).append(nav);

                    var totalspace = boxSize * (numOfPages - 1) + 61;
                    var leftFix = totalspace / 2;

                    $(container).find('.sfly-wgt-book-nav')
                        .css('left', (position.left - leftFix) + 'px')
                        .css('top', (position.top + 50) + 'px')
                        .css('width', totalspace + 'px')
                        .attr('data-width', totalspace)
                        .attr('data-show-nav', display == 'block' ? 'true' : 'false')
                        .find('li > div').css('width', boxSize + 'px');

                    positionTopPagining = 65;
                }

                $(container).find('.sfly-wgt-book-paging')
                    .css('top', (position.top + positionTopPagining)+'px')
                    .css('left', (position.left - 54) + 'px');
            }
        };

        // Slide the book window into view and render the view
        var openSlideAndRenderBook = function(pId, productJson, prodStyles, prodOptions, forcedClose, loadedAlbums, currAlbum, takeLockCallback, releaseLockCallback, buttonCloseCallback, changeOpenStatusCallback, handleCurrentPidCallback, viewDisableCallback, self) {

            var currPhotos = currAlbum.photos;

            // Will render the main book
            function renderBook(pId, productJson, useCurrentPage, callbackOnFinish) {
                var product     = view_common.findProjectJsonProduct(productJson, pId, didAlbumSwitch);
                var productType = AssetMapper.GetProductType(product);
                var partnerId   = AssetMapper.GetPartnerId(product, productType);
                var layoutJson  = JSON.stringify(config.getRecipeLayout()[partnerId]);
                var designJson  = JSON.stringify(config.getRecipeDesign()[partnerId]);
                useCurrentPage  = (typeof useCurrentPage !== 'undefined' && useCurrentPage == true);

                var useCDN = cache.get('env') != 'beta' && cache.get('env') != 'dev';
                var mgThumbGen  = new MgThumbGenerator(cache.get('env'),useCDN);

                mgThumbGen.init(productType, partnerId, product, layoutJson, designJson, self.Model.get('monitoring').reportEvent, cache.get('env'), doNotResizeImages);

                mgThumbGen.generate(parseInt(0), pId, true, function(canvas) {
                    var inManualSelect = self.Model.get('ismanualselect');

                    var photosHolderTemplate = inManualSelect ? templates.fullview_product : templates.fullview_no_photos;
                    var elem = $(view_common.renderTemplate(photosHolderTemplate, { pid: pId, sku: view_common.getProduct(pId)['sflySku'], ptype: productType }));

                    var banner = $(getBanner());
                    if  (banner) {
                        if (!inManualSelect){
                            banner.addClass('no_photos');
                        }
                        elem.append(banner);
                    }

                    $(canvas).attr('data-order', 0);
                    elem.children('.sfly_wgt_product_inner').html(canvas).css('top', '30px');
                    $(sideopen).find('#sfly_wgt_sideopen_products').hide().html(elem);
                    var pTargetSize = self.updateProductSizeByHeight(elem, self.getPrintHeight(), pId, productJson, true);
                    // Center the product
                    var bookWidth = elem.children('.sfly_wgt_product_inner').attr('data-width');
                    var hostWidth = $(sideopen).parent().width();
                    var bookLeftPos = Math.floor(hostWidth/2) - Math.floor(bookWidth/2);

                    var scrollAndClickEnabled = true;
                    if (self.menuContainerPresent) {
                        var productContainerHeight = parseInt($(sideopen).height() - $(sideopen).find('#sfly_wgt_sideopen_products_header').height());
                        $(sideopen).find('#sfly_wgt_sideopen_products').height(productContainerHeight).show();
                        scrollAndClickEnabled = false;
                    } else {
                        $(sideopen).find('#sfly_wgt_sideopen_products').css('left', bookLeftPos+'px').show();
                    }

                    renderBookAndPrints(pId, 'prints', elem.children('.sfly_wgt_product_inner'), mgThumbGen, productJson, useCurrentPage ? self.getCurrentOpenPage() : -1, self);
                    //renderBookAndPrintsNavigation(pId, 'prints', $(sideopen).find('#sfly_wgt_sideopen_products'), productJson, { left: pTargetSize/2, top: self.getSlideProdHeight() }, useCurrentPage ? self.getCurrentOpenPage() : -1, self);

                    // scale the cover page wrapper as well
                    var bookCoverSize   = $(sideopen).find('.sfly-wgt-book-cover-wrapper').attr('data-width');
                    var coverLeft       = pTargetSize/2 - bookCoverSize/2 - 37; // The 20px is a temp fix for aligning the cover
                    $(sideopen).find('#sfly_wgt_sideopen_products').find('.sfly-wgt-book-cover-wrapper').css('left', coverLeft+'px');

                    if (!useCurrentPage) {
                        self.setCurrentOpenPage(0);
                    } else {
                        $(sideopen).find('.sfly-wgt-pages').html((parseInt(self.getCurrentOpenPage()) + 1));
                    }
                    modal_common.setArrowPagingClass(sideopen, parseInt(self.getCurrentOpenPage()), elem.children('.sfly_wgt_product_inner').attr('data-pages') - 1);

                    if (_.isFunction(callbackOnFinish)) {
                        callbackOnFinish();
                    }

                    if(!scrollAndClickEnabled) {
                        return;
                        // no clicks and scroll events at all
                    }

                    var isClickAfterDrag = false;

                    $('#sfly_wgt_sideopen_products')
                        .off('click')
                        .on('click', function(event) {
                            var inner           = $(this).find('.sfly_wgt_product_inner');
                            var innerPosition   = inner.position();

                            var trackingOption = self.augmentTracking({ page: self.getCurrentOpenPage() }, self.Model);
                            tracking.track('open', 'flip_prints', trackingOption);

                            var clickRange     = {
                                left: parseInt(innerPosition.left) + parseInt(inner.attr('data-left')),
                                right: parseInt(innerPosition.left) + parseInt(inner.attr('data-left')) + parseInt(inner.attr('data-orig-width')),
                                top: parseInt(innerPosition.top) + parseInt(inner.attr('data-top-size')) - 15,
                                bottom: parseInt(innerPosition.top) + parseInt(inner.attr('data-top-size')) + parseInt(inner.attr('data-real-height'))
                            };

                            // Calc real position
                            var targetPos       = $(event.currentTarget).offset();
                            var mousePos        = { top: event.pageY, left: event.pageX };
                            var realPos         = { top: mousePos.top - targetPos.top, left: mousePos.left - targetPos.left };

                            if (realPos.left >= clickRange.left && realPos.left <= clickRange.right && realPos.top >= clickRange.top && realPos.top <= clickRange.bottom && !isClickAfterDrag) {
                                var nextPage    = self.getCurrentOpenPage() + 1;
                                var totalPages  = Math.floor(product.prints.pages.length);
                                if (totalPages > MAX_PRINTS) {
                                    totalPages = MAX_PRINTS;
                                }

                                if (nextPage >= totalPages) {
                                    nextPage = totalPages - 1;
                                }

                                $(sideopen).find('canvas').hide();
                                $(sideopen).find('canvas[data-order=' + nextPage + ']').show();

                                $(sideopen).find('.sfly-wgt-book-nav li').removeClass('wgt-nav-selected');
                                $(sideopen).find('.sfly-wgt-page_' + nextPage).addClass('wgt-nav-selected');

                                self.setCurrentOpenPage(nextPage);

                                $(sideopen).find('.sfly-wgt-pages').html((parseInt(nextPage) + 1));
                                modal_common.setArrowPagingClass(sideopen, parseInt(nextPage), totalPages - 1);
                                /*
                                var prodJson = view_common.getProduct(handleCurrentPidCallback());
                                clickThrough.sendForSeeAll(currPhotos);
                                tracking.track('open', 'personalize', { sku: prodJson.sflySku, page: self.getCurrentOpenPage() });
                                */
                            }
                        })
                        .on('mousemove', function(event) {
                            var inner           = $(this).find('.sfly_wgt_product_inner');
                            var innerPosition   = inner.position();
                            var clickRange     = {
                                left: parseInt(innerPosition.left) + parseInt(inner.attr('data-left')),
                                right: parseInt(innerPosition.left) + parseInt(inner.attr('data-left')) + parseInt(inner.attr('data-orig-width')),
                                top: parseInt(innerPosition.top) + parseInt(inner.attr('data-top-size')) - 15,
                                bottom: parseInt(innerPosition.top) + parseInt(inner.attr('data-top-size')) + parseInt(inner.attr('data-real-height'))
                            };

                            // Calc real position
                            var targetPos       = $(event.currentTarget).offset();
                            var mousePos        = { top: event.pageY, left: event.pageX };
                            var realPos         = { top: mousePos.top - targetPos.top, left: mousePos.left - targetPos.left };

                            if (realPos.left >= clickRange.left && realPos.left <= clickRange.right && realPos.top >= clickRange.top && realPos.top <= clickRange.bottom) {
                                $(this).css('cursor', 'pointer');
                            } else {
                                $(this).css('cursor', 'default');
                            }
                    });

                    var scrollHandler = function(event){
                        var nextPage    = self.getCurrentOpenPage();
                        var totalPages  = Math.floor(product.prints.pages.length);
                        if (totalPages > MAX_PRINTS) {
                            totalPages = MAX_PRINTS;
                        }

                        var trackingOption = self.augmentTracking({ page: self.getCurrentOpenPage() }, self.Model);
                        tracking.track('open', 'flip_prints', trackingOption);

                        if (event.deltaX == 0) {
                            nextPage-= event.deltaY > 0 ? 1 : -1;
                        }
                        else {
                            nextPage += event.deltaX > 0 ? 1 : -1;
                        }

                        if (isNaN(nextPage)) {
                            nextPage = 0;
                        }

                        if (nextPage < 0) {
                            nextPage = 0;
                        } else if (nextPage >= totalPages) {
                            nextPage = totalPages - 1;
                        }

                        $(sideopen).find('canvas').hide();
                        $(sideopen).find('canvas[data-order=' + nextPage + ']').show();

                        $(sideopen).find('.sfly-wgt-book-nav li').removeClass('wgt-nav-selected');
                        $(sideopen).find('.sfly-wgt-page_' + nextPage).addClass('wgt-nav-selected');

                        self.setCurrentOpenPage(nextPage);

                        $(sideopen).find('.sfly-wgt-pages').html((parseInt(nextPage) + 1));
                        modal_common.setArrowPagingClass(sideopen, parseInt(nextPage), totalPages - 1);
                    };

                    function Interval(fn, time) {
                        var timer = false;
                        this.start = function () {
                            if (!this.isRunning())
                                timer = setInterval(fn, time);
                        };
                        this.stop = function () {
                            clearInterval(timer);
                            timer = false;
                        };
                        this.isRunning = function () {
                            return timer !== false;
                        };
                    }

                    var scrollHappened = false;
                    var scrollTimeout;
                    var eventTop;
                    var scrollInterval = new Interval(function(){
                        if(scrollHappened){
                            scrollHandler(eventTop);
                            scrollHappened = false;
                        }
                    }, 200);

                    $(sideopen).find("#sfly_wgt_sideopen_products").off('mousewheel').on('mousewheel', function(event){
                        event.preventDefault();
                        eventTop = event;
                        scrollHappened = true;
                        if(!scrollInterval.isRunning()){
                            scrollInterval.start();
                            clearTimeout(scrollTimeout)
                            scrollTimeout = setTimeout(function(){
                                scrollInterval.stop();
                                scrollHappened = false;
                            }, 10000);
                        }
                    });

                    $('body').off('.pwidget').on('keydown.pwidget', function(e) {
                        e.preventDefault();

                        var nextPage    = self.getCurrentOpenPage();
                        var totalPages  = Math.floor(product.prints.pages.length);
                        if (totalPages > MAX_PRINTS) {
                            totalPages = MAX_PRINTS;
                        }

                        var trackingOption = self.augmentTracking({ page: self.getCurrentOpenPage() }, self.Model);
                        tracking.track('open', 'flip_prints', trackingOption);

                        switch(e.keyCode) {
                            case 37: //left
                                nextPage -= 1;
                                break;
                            case 39: //right
                            case 32: //space
                                nextPage += 1;
                                break;
                        }

                        if (isNaN(nextPage)) {
                            nextPage = 0;
                        }

                        if (nextPage < 0) {
                            nextPage = 0;
                        } else if (nextPage >= totalPages) {
                            nextPage = totalPages - 1;
                        }

                        $(sideopen).find('canvas').hide();
                        $(sideopen).find('canvas[data-order=' + nextPage + ']').show();

                        $(sideopen).find('.sfly-wgt-book-nav li').removeClass('wgt-nav-selected');
                        $(sideopen).find('.sfly-wgt-page_' + nextPage).addClass('wgt-nav-selected');

                        self.setCurrentOpenPage(nextPage);

                        $(sideopen).find('.sfly-wgt-pages').html((parseInt(nextPage) + 1));
                        modal_common.setArrowPagingClass(sideopen, parseInt(nextPage), totalPages - 1);
                    });


                    $(sideopen).find('.sfly-wgt-arrow').on('mousedown', function() {
                        // This will prevent a selection on double click. why? no idea...
                        return false;
                    });

                    $(sideopen).find('.sfly-wgt-arrow').on('click', function() {
                        var dir = $(this).attr('data-dir');
                        var totalPages = Math.floor(product.prints.pages.length);
                        if (totalPages > MAX_PRINTS) {
                            totalPages = MAX_PRINTS;
                        }

                        var trackingOption = self.augmentTracking({ page: self.getCurrentOpenPage() }, self.Model);
                        tracking.track('open', 'flip_prints', trackingOption);

                        var currPage = self.getCurrentOpenPage();
                        var nextPage = dir == 'left' ? currPage -= 1 : currPage += 1;

                        // don't allow to move too left or too right
                        if (nextPage < 0) {
                            nextPage = 0;
                        } else if (nextPage >= totalPages) {
                            nextPage = totalPages - 1;
                        }

                        if (isNaN(nextPage)) {
                            nextPage = 0;
                        }

                        $(sideopen).find('canvas').hide();
                        $(sideopen).find('canvas[data-order=' + nextPage + ']').show();

                        $(sideopen).find('.sfly-wgt-book-nav li').removeClass('wgt-nav-selected');
                        $(sideopen).find('.sfly-wgt-page_' + nextPage).addClass('wgt-nav-selected');

                        self.setCurrentOpenPage(nextPage);

                        $(sideopen).find('.sfly-wgt-pages').html((parseInt(nextPage) + 1));
                        modal_common.setArrowPagingClass(sideopen, parseInt(nextPage), totalPages - 1);
                    });


                    $(sideopen).find('.sfly-wgt-book-nav li')
                        .on('mousedown', function() {
                            if(!$(this).hasClass('wgt-nav-selected')){
                                return;
                            }
                            isClickAfterDrag = true;
                            $(this).parent().addClass('draggable');

                            $('#sfly_wgt_full_openwin_container')
                                .on('mousemove', function(event){

                                    $(this).css('cursor','pointer');

                                    var totalPages = Math.floor(product.prints.pages.length);
                                    if(totalPages > MAX_PRINTS){
                                        totalPages = MAX_PRINTS;
                                    }

                                    var elem        = $(this).find('.sfly_wgt_product_inner');
                                    var pages       = elem.attr('data-pages');
                                    var navPosition = $(this).find('.sfly-wgt-book-nav').position();
                                    var navPosRange = { left: navPosition.left, right: navPosition.left + $(this).find('.sfly-wgt-book-nav').width() };

                                    // Calc real position
                                    var targetPos   = $(event.currentTarget).offset();
                                    var mousePos    = { top: event.pageY, left: event.pageX };
                                    var realPos     = { top: mousePos.top - targetPos.top, left: mousePos.left - targetPos.left - ($(this).width() - elem.width())/2  };

                                    var currPage;
                                    var canNavigate = $(this).find('#sfly_wgt_sideopen_products').children('.sfly-wgt-book-nav').attr('data-show-nav') == 'true';

                                    if (!canNavigate) {
                                        return;
                                    }

                                    var navWidth    = $(this).find('#sfly_wgt_sideopen_products').children('.sfly-wgt-book-nav').attr('data-width');
                                    var navStart    = navPosRange.left;
                                    var navEnd      = navPosRange.right;

                                    if (realPos.left < navStart || realPos.left > navEnd) {
                                        return;
                                    }

                                    if (realPos.left < navStart) {
                                        currPage = 0;
                                    } else if (realPos.left > navEnd) {
                                        currPage = (pages > MAX_PRINTS ? MAX_PRINTS : pages) - 1;
                                    } else {
                                        currPage = Math.floor((realPos.left-navStart) * pages / navWidth);
                                        if (currPage >= pages)
                                            currPage = (pages > MAX_PRINTS ? MAX_PRINTS : pages) -1;
                                    }

                                    var trackingOption = self.augmentTracking({ page: self.getCurrentOpenPage() }, self.Model);
                                    tracking.track('open', 'flip_prints', trackingOption);

                                    $(sideopen).find('canvas').hide();
                                    $(sideopen).find('canvas[data-order=' + currPage + ']').show();

                                    $(sideopen).find('.sfly-wgt-book-nav li').removeClass('wgt-nav-selected');
                                    $(sideopen).find('.sfly-wgt-page_' + currPage).addClass('wgt-nav-selected');

                                    self.setCurrentOpenPage(currPage);

                                    $(sideopen).find('.sfly-wgt-pages').html((parseInt(currPage) + 1));
                                    modal_common.setArrowPagingClass(sideopen, parseInt(currPage), totalPages - 1);
                                })
                                .on('mouseup', function(){
                                    $(this).css('cursor','default');
                                    $(this).off('mousemove');
                                    $('.draggable').removeClass('draggable');
                                    setTimeout(function(){ isClickAfterDrag = false; }, 200);
                                });
                        })
                        .on('click', function(){
                            if($(this).hasClass('wgt-nav-selected')){
                                return;
                            }

                            var totalPages = Math.floor(product.prints.pages.length);
                            if(totalPages > MAX_PRINTS){
                                totalPages = MAX_PRINTS;
                            }
                            var nextPage = parseInt($(this).attr('class').replace("sfly-wgt-page_","").trim());

                            // don't allow to move too left or too right
                            if (nextPage < 0) {
                                nextPage = 0;
                            } else if (nextPage >= totalPages) {
                                nextPage = totalPages - 1;
                            }

                            if (isNaN(nextPage)) {
                                nextPage = 0;
                            }

                            var trackingOption = self.augmentTracking({ page: self.getCurrentOpenPage() }, self.Model);
                            tracking.track('open', 'flip_prints', trackingOption);

                            $(sideopen).find('canvas').hide();
                            $(sideopen).find('canvas[data-order=' + nextPage + ']').show();

                            $(sideopen).find('.sfly-wgt-book-nav li').removeClass('wgt-nav-selected');
                            $(sideopen).find('.sfly-wgt-page_' + nextPage).addClass('wgt-nav-selected');

                            self.setCurrentOpenPage(nextPage);

                            $(sideopen).find('.sfly-wgt-pages').html((parseInt(nextPage) + 1));
                            modal_common.setArrowPagingClass(sideopen, parseInt(nextPage), totalPages - 1);
                        });

                }, true);

                handleCurrentPidCallback(pId);
            }

            function updateWindowTitle(productJson, prodId) {
                var product         = view_common.findProjectJsonProduct(productJson, prodId, didAlbumSwitch);
                var pages           = product.prints.pages.length > MAX_PRINTS ? MAX_PRINTS : product.prints.pages.length;
                var origProduct     = view_common.getProduct(prodId);
                var title           = (didAlbumSwitch ? 'Preview '  : "" ) +pages + ' photos' + (didAlbumSwitch ? ' out of '+ currPhotos.length  : "" ) + ', ' + origProduct['title'];
                $('#sfly_wgt_full_openwin_container #sfly_wgt_sideopen_title h4 span').html(title);
            }

            function uppOnOK(groupPhotos, isThisLife, mixedSources) {
                productJson = [];
                function _getProductJson(pJson) {
                    if (pJson != null) {
                        // if is This Life replace photoIds in the strip with SFLY Ids
                        if(isThisLife) {
                            pJson = modal_common.replaceIdWithSFLYId(groupPhotos, pJson);
                        }
                        productJson = productJson.concat(pJson);
                    } else {
                        releaseLockCallback();
                        view_common.removeLoading(openwinContainer);
                    }
                }

                var isManual = true;
                inManualSelect = true;
                self.Model.set('ismanualselect', inManualSelect);
                currPhotos   = groupPhotos.photos.map(function(p) { return parseInt(p.id) });
                currAlbum    = groupPhotos;
                // todo: @Vadim: find other solution
                window.MagicShopCurrAlbum = Object.assign({}, groupPhotos);
                self.Model.set('currentAlbum', window.MagicShopCurrAlbum);


                isThisLifeGeneral = isThisLife;
                mixedSourcesGeneral = mixedSources;
                $.when(
                    productProxy.getPrints(groupPhotos, _getProductJson, isManual, undefined, isThisLife, mixedSources, true))
                    .then(function() {
                        didAlbumSwitch = true;
                        releaseLockAndStopLoading(true);
                    })
                    .fail(function() {
                        releaseLockCallback();
                        view_common.removeLoading(openwinContainer);
                    });

                var trackingOption = self.augmentTracking({ action: 'ok', sku: origProduct['sflySku'] }, self.Model);
                tracking.track('open', 'upp', trackingOption);
            }

            function uppOnCancel() {
                releaseLockCallback();
                view_common.removeLoading(openwinContainer);
                var trackingOption = self.augmentTracking({ action: 'cancel', sku: origProduct['sflySku'] }, self.Model);
                tracking.track('open', 'upp', trackingOption);
                self.closeModalAction();
            }

            // Will stop loading, release the global lock and show the product styles.
            function printsSizeSelector(printSize, model) {
                var selectorName = '.sfly-wgt-prints-info .size-selector .selector-item';
                var $selector = $(selectorName);
                $selector.find('.radio').removeClass('selected');
                $(selectorName + '#' + printSize).find('.radio').addClass('selected');

                $('.sfly-wgt-prints-info .size-selector .selector-item').off('click').on('click', function () {
                    $selector.find('.radio').removeClass('selected');
                    printSize = this.id; // set new size
                    model.set('printSize', printSize);
                    $(this).find('.radio').addClass('selected');
                })
            }

            function addSendLinkWidget(phoneNumber) {
                if (!ThisLife) {
                    return;
                }

                var $container = $('.sfly-wgt-send-link-container');
                var widgetTemplate = view_common.renderTemplate(templates.send_link_widget, {phoneNumber: phoneNumber});
                $container.html(widgetTemplate);

                var widget = send_link_widget.getInstance($container, phoneNumber, sendAppLinkRequest, ThisLife.Helper.Validate);
                widget.show();
            }

            function sendAppLinkRequest(phoneNumber) {
                var q = $.Deferred();
                productProxy.requestToAppLink(self.sessionToken, phoneNumber).then(
                    function(result) {
                        if (result.success) {
                            self.Model.set('phoneNumber', phoneNumber);
                            return q.resolve(phoneNumber)
                        }
                        q.reject(result.message);
                    },
                    function () {
                        // print log
                        return q.reject();
                    }
                );
                return q.promise();
            }

            function getBanner() {
                var date = new Date();
                var day = date.getDate();
                var month = date.getMonth() + 1; // months are between 0 and 11
                var year = date.getFullYear();

                if ((day >= 27 && day <= 29) && month === 5 && year === 2018) {
                    return templates.fullview_prints_banner;
                }
               return '';
            }


            function releaseLockAndStopLoading(isAfterAlbumSwitch) {
                var phoneNumber = self.Model.get('phoneNumber');
                var printsSize =  self.Model.get('printSize') || '4x6'; // 4x6, hack for default value

                printsSizeSelector(printsSize, self.Model);

                if (self.sessionToken) {
                    addSendLinkWidget(phoneNumber);
                }

                // show new upp bubble if we don't have a cookie
                self.showNewBubblePop(sideopen, 'prints');
                if (_.isFunction(self.Model.get('callback'))) { self.Model.get('callback')({action: 'showing_product', productType: 'prints'}); }

                if (typeof isAfterAlbumSwitch === 'undefined') {
                    isAfterAlbumSwitch = false;
                }
                releaseLockCallback();
                view_common.removeLoading($('#sfly_wgt_container'));
                modal_common.hideBackgroundLoading($('#sfly_wgt_openwin_container'));
                view_common.showLoading($('#sfly_wgt_openwin_container'));
                $(self.Model.get('container')).find('.sfly_wgt_product[data-pid="' + pId + '"]').removeClass('not-selected');

                self.setIsWidgetOpen(true);

                renderBook(pId, productJson, false, function() {
                    view_common.removeLoading($('#sfly_wgt_full_openwin_container'));
                    modal_common.showBackgroundLoading($('#sfly_wgt_openwin_container'));
                });

                if (isAfterAlbumSwitch) {
                    updateWindowTitle(productJson, handleCurrentPidCallback());
                }
                // Bind the click through button
                $('#sfly_wgt_sideopen_container .sfly-wgt-order-prints').off('click').on('click', function() {
                    // if not in manual mode, go to selection
                    var currButton = this;

                    if (inManualSelect) {
                        var prodJson = view_common.getProduct(handleCurrentPidCallback());
                        var trackingOption = self.augmentTracking({ sku: prodJson.sflySku, page: self.getCurrentOpenPage() }, self.Model);
                        tracking.track('open', 'personalize', trackingOption);

                        var photoIds = new Array();
                        if (!didAlbumSwitch) {
                            var product = view_common.findProjectJsonProduct(productJson, handleCurrentPidCallback(), didAlbumSwitch);
                            var photosRefIds = new Array();
                            $.each(product.prints.pages, function(i, cPage){
                                $.each(cPage.canvas.layout.photos, function(j, cPhoto) {
                                    photosRefIds[cPhoto.photoRefId] = 1;
                                });
                            });

                            if(photosRefIds.length > 0) {
                                $.each(product.prints.photoStrip, function(i, cPhotoStrip) {
                                    if(typeof photosRefIds[cPhotoStrip.photoRefId] !== "undefined") {
                                        photoIds.push(cPhotoStrip.photoId);
                                    }
                                });
                            }
                            // @Vadim: removed max photos limitation
                            //photoIds = _.first(photoIds,MAX_PRINTS);
                        } else {
                            photoIds = currPhotos;
                        }

                        if (self.Model.get('openInNewTab')) {
                            self.winHandler = self.openNewWindow(self.winHandler);
                        } else {
                            self.winHandler = null;
                        }

                        clickThrough.sendForSeeAll(photoIds, view_common.showLoading.bind(this, $('#sfly_wgt_full_openwin_container')), view_common.removeLoading.bind(this, $('#sfly_wgt_full_openwin_container')), currAlbum, self.winHandler, self.Model, inManualSelect);
                    } else {
                        if (_.isFunction(self.Model.get('Callback'))) {
                            var renderModalWithPhotos = function(selectedPhotos){
                                var groupPhotos = {
                                    'albumId' : String.fromCharCode(65 + Math.floor(Math.random() * 26)) + Date.now(),
                                    'photos' : selectedPhotos
                                };
                                window.MagicShopCurrAlbum = groupPhotos;
                                self.reshowModalAction(function(){ uppOnOK(groupPhotos, true, false); });
                                $(currButton).html('ORDER PRINTS');
                            };

                            self.Model.get('Callback')({action: 'select_photos', onSuccess: renderModalWithPhotos, onFail: uppOnCancel, productType: 'prints'});
                            self.closeModalAction();
                        }
                    }
                });
            }

            var product         = view_common.findProjectJsonProduct(productJson, pId, didAlbumSwitch);
            var pages           = product.prints.pages.length > MAX_PRINTS ? MAX_PRINTS : product.prints.pages.length;
            var origProduct     = view_common.getProduct(pId);
            var bookName        = origProduct['title'];
            var bookSize        = origProduct['size'];
            handleCurrentPidCallback(pId);

            var sideopen = $(view_common.renderTemplate(templates.popup_printsmodal, {
                    title: (didAlbumSwitch ? 'Preview '  : "" ) +pages + ' photos' + (didAlbumSwitch ? ' out of '+ currPhotos.length  : "" ) + ', ' + bookName,
                    price: config.getPrice(config.getPrints()[pId].sku),
                    products: '',
                    pid: pId,
                    size: bookSize,
                    coupon: typeof cache.getCoupon() !== "undefined" ? cache.getCoupon().name : false,
                    useNewStyleGuide: useNewStyleGuide,
                    orderButton: inManualSelect ? 'ORDER PRINTS' : 'CHOOSE PHOTOS'
                }
            ));

            if (cache.get('mode') == 'gifting') {
                $(sideopen).find('#sfly_wgt_upp_select').hide();
            }

            var openwinContainer = $('#sfly_wgt_full_openwin_container');

            changeOpenStatusCallback(true, self.closeModalAction, function(){
                self.openModalAction(pId, sideopen, releaseLockAndStopLoading, forcedClose)
            });

            // UPP
            $('#sfly_wgt_upp_select').on('click', function(){
                var trackingOption = self.augmentTracking({ action: 'open', sku: origProduct['sflySku'] }, self.Model);
                tracking.track('open', 'upp', trackingOption);

                if (_.isFunction(self.Model.get('Callback'))) {
                    var renderModalWithPhotos = function(selectedPhotos){
                        var groupPhotos = {
                            'albumId' : String.fromCharCode(65 + Math.floor(Math.random() * 26)) + Date.now(),
                            'photos' : selectedPhotos
                        };
                        self.reshowModalAction(function(){uppOnOK(groupPhotos, true, false);});
                    };
                    self.Model.get('Callback')({action: 'select_photos', onSuccess: renderModalWithPhotos, onFail: uppOnCancel, productType: 'prints'});
                    self.closeModalAction();
                } else {
                    view_common.showLoading(openwinContainer);
                    takeLockCallback();
                    modal_common.showUPP(uppOnOK, uppOnCancel);
                }
            });

            // highlights
            /*
            $('input[type=radio][name=highlights]').change(function() {
                view_common.showLoading(openwinContainer);
                takeLockCallback();

                var isManual = this.value == '0';

                productJson = [];
                function _getProductJson(pJson) {
                    if (pJson != null) {
                        // if is This Life replace photoIds in the strip with SFLY Ids
                        productJson = productJson.concat(pJson);
                    } else {
                        releaseLockCallback();
                        view_common.removeLoading(openwinContainer);
                    }
                }

                $.when(
                    productProxy.getPrints(currAlbum, _getProductJson, isManual, undefined, isThisLifeGeneral, mixedSourcesGeneral))
                    .then(function() {
                        didAlbumSwitch = true;
                        releaseLockAndStopLoading(true);
                    })
                    .fail(function() {
                        releaseLockCallback();
                        view_common.removeLoading(openwinContainer);
                    });
            });
            */

            // Position the open/close button in the right place
            var btn = $('.sfly-wgt-btn-sidemodule');

            // When the window is just refreshed and re-rendered
            if (!self.getIsWidgetOpen()) {
                buttonCloseCallback(btn, 'prod_clicked');
            }
        };

        return function()
        {
            modal.call(this);

            // helper for private functions
            var self = this;

            // Will open the sliding window with the given products
            this.showProductsWindow = function(pId, album, albums, prodStyles, prodOptions, forceCloseExternal, isThisLife, useNewStyleGuideFlag, doNotResizeImagesFlag, tooltipItems, textualStructure, mixedSources, takeLockCallback, releaseLockCallback, closeButtonCallback, changeOpenStatusCallback, handleCurrentPidCallback, viewDisableCallback) {
                useNewStyleGuide = useNewStyleGuideFlag;
                doNotResizeImages = doNotResizeImagesFlag;
                function showTheBook(forceClose) {
                    var productJson = [];
                    function _getProductJson(pJson) {
                        if (pJson != null) {
                            // if is This Life replace photoIds in the strip with SFLY Ids
                            if(isThisLife) {
                                pJson = modal_common.replaceIdWithSFLYId(album, pJson);
                            }
                            productJson = productJson.concat(pJson);
                        }
                    }

                    $.when(
                        productProxy.getPrints(album, _getProductJson, self.Model.get('ismanualselect'), undefined, isThisLife, mixedSources))
                        .then(function() {
                            inManualSelect = self.Model.get('ismanualselect');
                            openSlideAndRenderBook(pId, productJson, prodStyles[pId], prodOptions[pId], forceClose, albums, album, takeLockCallback, releaseLockCallback, closeButtonCallback, changeOpenStatusCallback, handleCurrentPidCallback, viewDisableCallback, self);
                        })
                        .fail(function(){
                            changeOpenStatusCallback(false, self.closeModalAction);
                            setTimeout(releaseLockCallback, 200);
                        });
                }
                isThisLifeGeneral = isThisLife;
                mixedSourcesGeneral = mixedSources;
                didAlbumSwitch = false;
                this.showProductsWindowFeatures(pId, album, albums, prodStyles, prodOptions, forceCloseExternal, takeLockCallback, releaseLockCallback, closeButtonCallback, changeOpenStatusCallback, handleCurrentPidCallback, viewDisableCallback, showTheBook);
            };
        };

        this.prototype = Object.create(modal.prototype);
    }
);

/*
 This module will include the minimal version of the modal window for photobook
 */

define('app/view_engine/modals/full/modal_calendar',
    ['underscore', 'app/templates', 'mgthumb', 'app/asset_mapper', 'app/tracking', 'magicselect', 'app/product_proxy', 'app/view_engine/widgets/common', 'app/config_manager', 'app/view_engine/modals/shared', 'app/click_through', 'app/view_engine/modals/full/modal', 'app/thumbgen_wrapper', 'app/time_monitor', 'app/cache_module', 'app/utils', 'app/globals'],
    function(_, templates, mgthumb, AssetMapper, tracking, magicselect, productProxy, view_common, config, modal_common, clickThrough, modal, thumbGenWrapper, monitor, cache, utils, globals) {
        var isThisLifeGeneral = false;
        var mixedSourcesGeneral = false;
        var thisLifePhotoMapping;
        var useNewStyleGuide;
        var doNotResizeImages;
        var manualSelect = false;
        var productStylesRecipe;
        var renderBottomStyles;
        var mobileRenderingOnMenuContainer = false;


        var findFirstProductRecipeBySize = function(size) {
            var firstProductsBySize = {};
            _.each(Object.keys(productStylesRecipe), function(pId){
                // do this only for calendars
                if (pId.split("_").length == 3) {
                    firstProductsBySize[pId.split("_")[2]] = pId;
                }
            });
            return firstProductsBySize[size];
        };

        // Slide the book window into view and render the view
        var openSlideAndRenderBook = function(pId, productJson, prodStyles, prodOptions, forcedClose, loadedAlbums, currAlbum, takeLockCallback, releaseLockCallback, buttonCloseCallback, changeOpenStatusCallback, handleCurrentPidCallback, viewDisableCallback, self) {
            function renderCalendarPages(pId, container, mgThumbGen, masks) {
                var product = view_common.findProjectJsonProduct(productJson, pId);
                var pages   = typeof product.product.pages !== "undefined" ? (parseInt(product.product.pages.length) + 1) / 2 : parseInt(product.product.surfaces.length);

                // We need this function to keep the right order inside the generate function
                function _generate(order) {
                    mgThumbGen.generate(parseInt(order), pId, true, function(canvas) {
                        $(canvas).attr('data-order', order).hide();
                        $(container).append(canvas);

                        if (self.getCurrentOpenPage() == order) {
                            $(container).find('canvas').hide();
                            $(canvas).show();
                        }

                    }, true, { masks: masks});
                }

                if (!$(container).attr('data-rendered')) {
                    // Put this first - to block more attempts to render
                    $(container).attr('data-rendered', true);

                    var width   = $(container).attr('data-real-width');
                    var height  = $(container).attr('data-height');

                    var numOfPages = pages;

                    $(container).attr('data-pages', pages);


                    if (utils.isMobile || mobileRenderingOnMenuContainer) {
                        _generate(0);
                    } else {
                        // generate and show the selected page, then render all else
                        if (self.getCurrentOpenPage() >= numOfPages) {
                            self.setCurrentOpenPage(numOfPages - 1);
                        }

                        _generate(self.getCurrentOpenPage());

                        for (var i = 0; i < numOfPages; i++) {
                            if (i != self.getCurrentOpenPage()) {
                                _generate(i);
                            }
                        }
                    }
                }
            }

            // Render the navigation template for the calendar product
            function renderCalendarNavigation(pId, container, rightFix) {
                var MIN_MONTH_TO_SHOW   = 6;

                var paging  = $(view_common.renderTemplate(templates.side_calendar_paging));
                $(container).prepend(paging);

                if ($(container).find('.sfly-wgt-cal-nav-horiz').length == 0) {
                    var product     = view_common.findProjectJsonProduct(productJson, pId);
                    var numOfPages  = typeof product.product.pages !== "undefined" ? (parseInt(product.product.pages.length) + 1) / 2 : parseInt(product.product.surfaces.length);
                    var nav = $(view_common.renderTemplate(templates.calendar_nav_horiz, { numOfMonths: numOfPages, currMonth: self.getCurrentOpenPage() }));
                    $(container).prepend(nav);

                    if (numOfPages < MIN_MONTH_TO_SHOW || mobileRenderingOnMenuContainer) {
                        nav.css('display', 'none').attr('data-hide-nav', 'true');
                    } else {
                        nav.css('display', 'inline-block').attr('data-hide-nav', 'false');

                        var navWidth = nav.width();
                        var paginingWidth = paging.width();
                        var containerWidth = container.find('.sfly_wgt_product_inner').width();
                        var leftFix = (containerWidth - navWidth - paginingWidth - 44) / 3;
                        if (view_common.getProduct(pId)['type'] == 'deskcalendar') {
                            leftFix = 12.1;
                        } else if(bookSize == "12x12") {
                            leftFix = (containerWidth - navWidth - paginingWidth - 33) / 3;
                        }
                        if (self.menuContainerPresent) {

                        } else {
                            nav.css('left', leftFix+'px');
                            paging.css('left', leftFix+'px');
                        }

                    }
                    return nav;
                }
            }

            // Will render book styles
            function getPhotobookRender(pId, productJson, callback) {
                var prod = cache.get('calendars_map')[pId];
                // TODO: improve this hack
                var sfly_sku = view_common.getProduct($("#sfly_wgt_full_openwin_container").attr('data-pid'))['sfly_sku'];

                if(typeof prod === "undefined"){
                    console.log('[Product Widget] Calendar not defined in the map: '+pId);
                    return;
                }
                var elem = $(view_common.renderTemplate(templates.side_style_product, { pid: pId, sku: sfly_sku, ptype: 'calendar', title: prod["styleName"] }));
                var wrapper = $('<div class="sfly-wgt-prod-style"></div>');
                elem.children('.sfly_wgt_product_inner').html('<img src="' + prod['static'] + '" class="sfly-img-spread" style="width: 92px; height: 45px;"/>');
                elem.css('width', '100px');
                wrapper.html(elem);

                // respnsive calculations
                var newStyleContainerWidth = $("#sfly_wgt_sideopen_styles_container").width();

                var baseWidth = wrapper.width() || 110;
                var baseMargin = parseInt(wrapper.css('margin-right')) || 15;
                var numOfElements = Math.floor(newStyleContainerWidth / (baseWidth + baseMargin));
                var newMargin =  Math.floor((newStyleContainerWidth - numOfElements * (baseWidth+baseMargin)) / numOfElements + baseMargin);
                wrapper.css('margin-right', newMargin + "px");
                wrapper.width(baseWidth - 2*5); //total of 10px for padding

                if (_.isFunction(callback)) {
                    callback(wrapper);
                }
            }


            function renderThumb(pId, useCurrentPage, callbackOnFinish, productType, partnerId, product, layoutJson, designJson, layoutMasks){
                var useCDN = cache.get('env') != 'beta' && cache.get('env') != 'dev';
                var mgThumbGen  = new MgThumbGenerator(cache.get('env'),useCDN);

                mgThumbGen.init(productType, partnerId, product, layoutJson, designJson, self.Model.get('monitoring').reportEvent, cache.get('env'), doNotResizeImages);

                var elem = $(view_common.renderTemplate(templates.fullview_product, { pid: pId, sku: view_common.getProduct(pId)['sflySku'], ptype: productType }));
                $(sideopen).find('#sfly_wgt_sideopen_products').html(elem);

                var pTargetSize = self.updateProductSizeByHeight(elem, self.getCalendarHeight(bookSize == "12x12" ? 'calendar12x12' : productType), pId, productJson);

                if(productType == 'deskcalendar')
                {
                    elem.children('.sfly_wgt_product_inner').css('top','15px');
                }

                // Center the product
                var calWidth  = elem.children('.sfly_wgt_product_inner').attr('data-width');
                var hostWidth = $(sideopen).parent().width();

                var scrollAndClickEnabled = true;
                if (self.menuContainerPresent) {
                    $(sideopen).find('#sfly_wgt_sideopen_products').css('left', 'auto');
                    scrollAndClickEnabled = false;
                    $(sideopen).find('#sfly_wgt_upp .sfly-wgt-orange-btn-sfly').show();
                } else {
                    var bookLeftPos = Math.floor(hostWidth/2) - Math.floor(calWidth/2);
                    $(sideopen).find('#sfly_wgt_sideopen_products').css('left', bookLeftPos+'px');
                }

                if (mobileRenderingOnMenuContainer) {
                    $(sideopen).find('#sfly_wgt_upp.sfly-wgt-calendars .sfly-wgt-orange-btn-sfly').css('top', '70vh');
                }

                renderCalendarPages(pId, elem.children('.sfly_wgt_product_inner'), mgThumbGen, layoutMasks);
                var nav = renderCalendarNavigation(pId, elem, parseInt($(elem.children('.sfly_wgt_product_inner')[0]).attr('data-right')));

                modal_common.setArrowPagingClass(sideopen, parseInt(self.getCurrentOpenPage()), elem.children('.sfly_wgt_product_inner').attr('data-pages') - 1);

                view_common.removeLoading($('#sfly_wgt_full_openwin_container'));
                modal_common.showBackgroundLoading($('#sfly_wgt_full_openwin_container'));
                var oridProduct = view_common.getProduct(pId);
                var prodType    = oridProduct['type'];

                if (scrollAndClickEnabled) {
                    $(sideopen).find('#sfly_wgt_sideopen_products').find('.sfly_wgt_product_inner').on('mousemove', function (event) {
                        var inner = $(this);
                        var innerPosition = inner.position();
                        var clickRange = {
                            left: parseInt(innerPosition.left) + parseInt(inner.attr('data-left')),
                            right: parseInt(innerPosition.left) + parseInt(inner.attr('data-left')) + parseInt(inner.attr('data-orig-width')),
                            top: parseInt(innerPosition.top) + parseInt(inner.attr('data-top-size')),
                            bottom: parseInt(innerPosition.top) + parseInt(inner.attr('data-top-size')) + parseInt(inner.attr('data-real-height')) + 15
                        };

                        // Calc real position
                        var targetPos = $(event.currentTarget).offset();
                        var mousePos = {top: event.pageY, left: event.pageX};
                        var realPos = {top: mousePos.top - targetPos.top, left: mousePos.left - targetPos.left};

                        if (realPos.left >= clickRange.left && realPos.left <= clickRange.right && realPos.top >= clickRange.top && realPos.top <= clickRange.bottom) {
                            $(this).css('cursor', 'pointer');
                        } else {
                            $(this).css('cursor', 'default');
                        }
                    }).off('click')
                        .on('click', function (event) {
                            if ($(event.target).hasClass('sfly-wgt-arrow') || $(event.target).hasClass('sfly-wgt-book-paging') || $(event.target).hasClass('sfly-wgt-page-curr-right') || $(event.target).hasClass('sfly-wgt-page-curr-left') || $(event.target).hasClass('sfly-wgt-pages')) {
                                return;
                            }
                            $("#sfly_wgt_sideopen_arrow_right").click();
                        });
                }
                var scrollHandler = function(event){

                    var nextPage    = self.getCurrentOpenPage();
                    var totalPages = typeof product.product.pages !== "undefined" ? (parseInt(product.product.pages.length) + 1) / 2 : parseInt(product.product.surfaces.length);

                    if (event.deltaX == 0) {
                        nextPage-= event.deltaY > 0 ? 1 : -1;
                    } else {
                        nextPage += event.deltaX > 0 ? 1 : -1;
                    }

                    if (isNaN(nextPage)) {
                        nextPage = 0;
                    }

                    if (nextPage < 0) {
                        nextPage = 0;
                    } else if (nextPage >= totalPages) {
                        nextPage = totalPages - 1;
                    }

                    $(sideopen).find('canvas').hide();
                    $(sideopen).find('canvas[data-order=' + nextPage + ']').show();

                    $(sideopen).find('.sfly-wgt-cal-nav-horiz li').removeClass('wgt-nav-selected');
                    $(sideopen).find('.sfly-wgt-month_' + nextPage).addClass('wgt-nav-selected');

                    self.setCurrentOpenPage(nextPage);

                    modal_common.setArrowPagingClass(sideopen, parseInt(nextPage), totalPages - 1);
                };

                function Interval(fn, time) {
                    var timer = false;
                    this.start = function () {
                        if (!this.isRunning())
                            timer = setInterval(fn, time);
                    };
                    this.stop = function () {
                        clearInterval(timer);
                        timer = false;
                    };
                    this.isRunning = function () {
                        return timer !== false;
                    };
                }

                var scrollHappened = false;
                var scrollTimeout;
                var eventTop;
                var scrollInterval = new Interval(function(){
                    if(scrollHappened){
                        scrollHandler(eventTop);
                        scrollHappened = false;
                    }
                }, 200);

                // bind scroll action
                if (scrollAndClickEnabled) {
                    $(sideopen).find("#sfly_wgt_sideopen_products").off('mousewheel').on('mousewheel', function(event){
                        event.preventDefault();
                        eventTop = event;
                        scrollHappened = true;
                        if(!scrollInterval.isRunning()){
                            scrollInterval.start();
                            clearTimeout(scrollTimeout)
                            scrollTimeout = setTimeout(function(){
                                scrollInterval.stop();
                                scrollHappened = false;
                            }, 10000);
                        }
                    });
                }

                if (scrollAndClickEnabled) {
                    $('body').off('.pwidget').on('keydown.pwidget', function(e) {
                    e.preventDefault();

                    var nextPage    = self.getCurrentOpenPage();
                    var totalPages = typeof product.product.pages !== "undefined" ? (parseInt(product.product.pages.length) + 1) / 2 : parseInt(product.product.surfaces.length);

                    switch(e.keyCode) {
                        case 37: //left
                            nextPage -= 1;
                            break;
                        case 39: //right
                        case 32: //space
                            nextPage += 1;
                            break;
                    }

                    if (isNaN(nextPage)) {
                        nextPage = 0;
                    }

                    if (nextPage < 0) {
                        nextPage = 0;
                    } else if (nextPage >= totalPages) {
                        nextPage = totalPages - 1;
                    }

                    var trackingOption = self.augmentTracking({ sku: oridProduct['sflySku'], page: self.getCurrentOpenPage() }, self.Model);
                    tracking.track('open', 'flip_cal', trackingOption);

                    $(sideopen).find('canvas').hide();
                    $(sideopen).find('canvas[data-order=' + nextPage + ']').show();

                    $(sideopen).find('.sfly-wgt-cal-nav-horiz li').removeClass('wgt-nav-selected');
                    $(sideopen).find('.sfly-wgt-month_' + nextPage).addClass('wgt-nav-selected');

                    self.setCurrentOpenPage(nextPage);

                    modal_common.setArrowPagingClass(sideopen, parseInt(nextPage), totalPages - 1);
                });
                }

                $(sideopen).find('.sfly-wgt-arrow').on('mousedown', function() {
                    // This will prevent a selection on double click. why? no idea...
                    return false;
                });

                $(sideopen).find('.sfly-wgt-arrow').on('click', function() {
                    var totalPages = typeof product.product.pages !== "undefined" ? (parseInt(product.product.pages.length) + 1) / 2 : parseInt(product.product.surfaces.length);
                    var dir = $(this).attr('data-dir');
                    var currPage = self.getCurrentOpenPage();
                    var nextPage = dir == 'left' ? currPage -= 1 : currPage += 1;

                    // don't allow to move too left or too right
                    if (nextPage < 0) {
                        nextPage = 0;
                    } else if (nextPage >= totalPages) {
                        nextPage = totalPages - 1;
                    }

                    if (isNaN(nextPage)) {
                        nextPage = 0;
                    }

                    var trackingOption = self.augmentTracking({ sku: oridProduct['sflySku'], page: self.getCurrentOpenPage() }, self.Model);
                    tracking.track('open', 'flip_cal', trackingOption);

                    $(sideopen).find('canvas').hide();
                    $(sideopen).find('canvas[data-order=' + nextPage + ']').show();

                    $(sideopen).find('.sfly-wgt-cal-nav-horiz li').removeClass('wgt-nav-selected');
                    $(sideopen).find('.sfly-wgt-month_' + nextPage).addClass('wgt-nav-selected');

                    self.setCurrentOpenPage(nextPage);

                    modal_common.setArrowPagingClass(sideopen, parseInt(nextPage), totalPages - 1);
                });

                nav.find('li').on('mousedown', function() {
                    if(!$(this).hasClass('wgt-nav-selected')){
                        return;
                    }

                    $(this).parent().addClass('draggable');

                    $('#sfly_wgt_full_openwin_container').on('mousemove', function(event){

                        var elem        = $(this).find('.sfly_wgt_product_inner');
                        var pages       = elem.attr('data-pages');
                        var navPosition = $(this).find('.sfly-wgt-cal-nav-horiz').position();
                        var navWidth    = $(this).find('.sfly-wgt-cal-nav-horiz').width();
                        var navPosRange = { left: navPosition.left, right: navPosition.left + navWidth };

                        // Calc real position
                        var targetPos   = $(event.currentTarget).offset();
                        var mousePos    = { top: event.pageY, left: event.pageX };
                        var realPos     = { top: mousePos.top - targetPos.top, left: mousePos.left - targetPos.left - ($(this).width() - elem.width())/2  };

                        var currPage;
                        var navStart    = navPosRange.left;
                        var navEnd      = navPosRange.right;

                        if (realPos.left < navStart || realPos.left > navEnd) {
                            return;
                        }

                        if (realPos.left < navStart) {
                            currPage = 0;
                        } else if (realPos.left > navEnd) {
                            currPage = pages - 1;
                        } else {
                            currPage = Math.floor((realPos.left-navStart) * pages / navWidth);
                            if (currPage >= pages)
                                currPage = pages -1;
                        }

                        var trackingOption = self.augmentTracking({ sku: oridProduct['sflySku'], page: self.getCurrentOpenPage() }, self.Model);
                        tracking.track('open', 'flip_cal', trackingOption);

                        $(sideopen).find('canvas').hide();
                        $(sideopen).find('canvas[data-order=' + currPage + ']').show();

                        $(sideopen).find('.sfly-wgt-cal-nav-horiz li').removeClass('wgt-nav-selected');
                        $(sideopen).find('.sfly-wgt-month_' + currPage).addClass('wgt-nav-selected');

                        self.setCurrentOpenPage(currPage);

                        modal_common.setArrowPagingClass(sideopen, parseInt(currPage), pages - 1);
                    })
                        .on('mouseup', function(){
                            $(this).off('mousemove');
                            $('.draggable').removeClass('draggable');
                        });
                })
                    .on('click', function(){
                        if($(this).hasClass('wgt-nav-selected')){
                            return;
                        }

                        var totalPages = typeof product.product.pages !== "undefined" ? (parseInt(product.product.pages.length) + 1) / 2 : parseInt(product.product.surfaces.length);
                        var nextPage = parseInt($(this).attr('class').replace("sfly-wgt-month_","").trim());

                        // don't allow to move too left or too right
                        if (nextPage < 0) {
                            nextPage = 0;
                        } else if (nextPage >= totalPages) {
                            nextPage = totalPages - 1;
                        }

                        if (isNaN(nextPage)) {
                            nextPage = 0;
                        }

                        var trackingOption = self.augmentTracking({ sku: oridProduct['sflySku'], page: self.getCurrentOpenPage() }, self.Model);
                        tracking.track('open', 'flip_cal', trackingOption);

                        $(sideopen).find('canvas').hide();
                        $(sideopen).find('canvas[data-order=' + nextPage + ']').show();

                        // Nav
                        $(this).parent().find('li').removeClass('wgt-nav-selected');
                        $(this).addClass('wgt-nav-selected');

                        self.setCurrentOpenPage(nextPage);

                        modal_common.setArrowPagingClass(sideopen, parseInt(nextPage), totalPages - 1);
                    });
            }

            // Will render the main book
            function renderCalendar(pId, productJson, useCurrentPage, callbackOnFinish) {
                var product     = view_common.findProjectJsonProduct(productJson, pId);
                var productType = AssetMapper.GetProductType(product);
                var partnerId   = AssetMapper.GetPartnerId(product, productType);
                bookStyle       = pId.split("_")[1];

                var pricePromises   = [];
                var deferred        = $.Deferred();
                pricePromises.push(deferred);

                thumbGenWrapper.prepareThumbGenAssets(pId, pId, 'medium', productType, product, function (result)
                {
                    deferred.resolve();
                    if (result == null || typeof result.layoutJson === 'undefined' || typeof result.designJson === 'undefined') {
                        console.log('>>> [Product Widget] missing layout / design json');
                        return;
                    }

                    var layoutJson = JSON.stringify(result.layoutJson);
                    var designJson = JSON.stringify(result.designJson);

                    renderThumb(pId, useCurrentPage, callbackOnFinish, productType, partnerId, product, layoutJson, designJson, result.layoutMasks);
                });

                $.when.apply(undefined, pricePromises).then(function() {
                    productProxy.loadPrices(function() {
                        // Prices are loaded, update the divs
                        updateWindowTitle(productJson, pId);
                    });
                });

                handleCurrentPidCallback(pId);
            }

            function updateWindowTitle(productJson, prodId) {

                var product         = view_common.findProjectJsonProduct(productJson, prodId);
                var pages           = typeof product.product.pages !== "undefined" ? (parseInt(product.product.pages.length) + 1) / 2 : parseInt(product.product.surfaces.length);
                var origProduct     = view_common.getProduct(prodId);
                $('#sfly_wgt_sideopen_container #sfly_wgt_sideopen_title').html(view_common.renderTemplate(templates.popup_calendarmodal_title, {
                    months: pages-1,
                    price: config.getPrice(origProduct['sflySku']),
                    sizeTitle: origProduct['size'] == '33' ? "5x11" : origProduct['size'],
                    style: origProduct['styleName'],
                    coupon: typeof cache.getCoupon() !== "undefined" ? cache.getCoupon().name : false,
                    isMobile: utils.isMobile || $(window).width() < globals.MOBILE_THRESHOLD,
                    hasModalMenu: self.menuContainerPresent
                }));
            }

            // Will stop loading, release the global lock and show the product styles.
            function releaseLockAndStopLoading(isAfterAlbumSwitch) {
                // var product         = productJson;
                var pages           = typeof productJson[0].product.pages !== "undefined" ? (parseInt(productJson[0].product.pages.length) + 1) / 2 : parseInt(productJson[0].product.surfaces.length);

                // show new upp bubble if we don't have a cookie
                self.showNewBubblePop(sideopen, 'calendar');

                self.removeLoadingFromWidget();
                modal_common.hideBackgroundLoading($('#sfly_wgt_full_openwin_container'));
                view_common.showLoading($('#sfly_wgt_full_openwin_container'));

                // if less than 12 photos show not enough photo popup
                if (currAlbum.photos.length < 12 || pages < 12){
                    self.showNotEnoughPhotosPopup(function() {
                        //viewDisableCallback();
                    });
                    if (!self.menuContainerPresent) {
                        if (self.calcModalWidth() < 800) {
                            $("#sfly_wgt_no_enough_photos_bubble").css('right', '315px');
                        } else {
                            $("#sfly_wgt_no_enough_photos_bubble").css('right',useNewStyleGuide? '413px' :'413px');
                        }
                    }

                }

                if (_.isFunction(self.Model.get('callback'))) { self.Model.get('callback')({action: 'showing_product', productType: 'calendar'}); }

                if (typeof isAfterAlbumSwitch === 'undefined') {
                    isAfterAlbumSwitch = false;
                }
                releaseLockCallback();

                view_common.removeLoading($('#sfly_wgt_container')); // remove from the side widget

                $(self.Model.get('container')).find('.sfly_wgt_product[data-pid="' + pId + '"]').removeClass('not-selected');
                //self.positionSelectedArrow(pId);

                self.setIsWidgetOpen(true);

                renderCalendar(handleCurrentPidCallback(), productJson, false, function() {
                    view_common.removeLoading($('#sfly_wgt_full_openwin_container'));
                    modal_common.showBackgroundLoading($('#sfly_wgt_full_openwin_container'));
                });

                if (isAfterAlbumSwitch) {
                    updateWindowTitle(productJson, handleCurrentPidCallback());
                }

                renderBottomStyles = function(prodStylesToRender) {

                    var prodStylesToRender = prodStylesToRender || prodStyles;

                    // Adjustments for responsive modal
                    var styleContainer = $("#sfly_wgt_sideopen_styles_container");
                    var baseStyleContainerWidth = styleContainer.width();
                    if (baseStyleContainerWidth > openwinContainer.width() - 100 ) { // need to reduce
                        var newStyleContainerWidth = openwinContainer.width() - 100;
                        styleContainer.width(newStyleContainerWidth);
                    }

                    // Render the styles at the bottom
                    $('#sfly_wgt_full_openwin_container #sfly_wgt_sideopen_styles').empty();
                    var stylesContainer = openwinContainer.find('#sfly_wgt_sideopen_styles');
                    stylesContainer.width(100);
                    _.each(prodStylesToRender, function (style) {
                        getPhotobookRender(style, productJson, function (styleRender) {
                            if (style == handleCurrentPidCallback()) {
                                $(styleRender).addClass('sfly-calstyle-selected');
                            }
                            stylesContainer.append(styleRender);
                            var origWidth = stylesContainer.width();
                            stylesContainer.width(origWidth + styleRender.outerWidth() + parseInt(styleRender.css('margin-right')));
                            $(styleRender).children('.sfly_wgt_product').on('click', function () {
                                var prodId = $(this).attr('data-pid');
                                // Same style. Do nothing.
                                if (prodId == handleCurrentPidCallback()) {
                                    return;
                                }

                                modal_common.hideBackgroundLoading($('#sfly_wgt_full_openwin_container'));
                                view_common.showLoading($('#sfly_wgt_full_openwin_container'));

                                function _getProductJson(pJson) {
                                    if (pJson != null) {
                                        if(isThisLifeGeneral) {
                                            pJson = modal_common.replaceIdWithSFLYId(currAlbum, pJson);
                                        }

                                        productJson = productJson.concat(pJson);
                                    } else {
                                        view_common.removeLoading(openwinContainer);
                                        modal_common.showBackgroundLoading(openwinContainer);
                                    }
                                }

                                $('#sfly_wgt_full_openwin_container #sfly_wgt_sideopen_styles .sfly-wgt-prod-style').removeClass('sfly-calstyle-selected');
                                $(this).parent().addClass('sfly-calstyle-selected');

                                $.when(
                                    productProxy.getCalendar(currAlbum, _getProductJson, manualSelect, [prodId], isThisLifeGeneral, mixedSourcesGeneral))
                                    .then(function() {
                                        renderCalendar(prodId, productJson, true, function() {
                                            view_common.removeLoading($('#sfly_wgt_full_openwin_container'));
                                            modal_common.showBackgroundLoading($('#sfly_wgt_full_openwin_container'));
                                        });

                                        var trackingOption = self.augmentTracking({sku: $(this).attr('data-sku')}, self.Model);
                                        tracking.track('open', 'change_style', trackingOption);
                                    })
                                    .fail(function() {
                                        releaseLockCallback();
                                        view_common.removeLoading(openwinContainer);
                                        modal_common.showBackgroundLoading(openwinContainer);
                                    });
                            })
                        });
                    });
                    stylesContainer.append('<div id="sfly_wgt_sideopen_buttons"><a href="#" class="sfly-wgt-lightlink see-more-styles">See more<br/>styles ></a></div>');
                    var styleRightArrow = openwinContainer.find("#sfly_wgt_sideopen_styles_right");
                    var styleLeftArrow = openwinContainer.find("#sfly_wgt_sideopen_styles_left");
                    var styleContainerMainWidth = styleContainer.width();
                    // reset
                    stylesContainer.css('transform', 'translateX(0)');
                    styleLeftArrow.hide();


                    var moveLeft = function(){
                        var currentOffset = parseInt(stylesContainer.css('transform').indexOf('matrix3d') > 0 ? 0 : stylesContainer.css('transform').replace('matrix(','').replace(')','').split(",")[4].trim());
                        var nextOffset = currentOffset + styleContainerMainWidth;
                        if(nextOffset >= 0){
                            nextOffset = 0;
                        }
                        stylesContainer.css('transform', 'translateX('+nextOffset+'px)');
                        if(nextOffset + styleContainerMainWidth > 0){
                            styleLeftArrow.hide();
                        } else {
                            styleLeftArrow.show();
                        }
                        if(nextOffset - styleContainerMainWidth <= -1*stylesContainer.width()){
                            styleRightArrow.hide();
                        } else {
                            styleRightArrow.show();
                        }
                    };

                    var moveRight = function(){
                        var currentOffset = parseInt(stylesContainer.css('transform').indexOf('matrix3d') > 0 ? 0 : stylesContainer.css('transform').replace('matrix(','').replace(')','').split(",")[4].trim());
                        var nextOffset = currentOffset - styleContainerMainWidth;
                        if(nextOffset <= -1*stylesContainer.width()){
                            return true;
                        }
                        stylesContainer.css('transform', 'translateX('+nextOffset+'px)');
                        if(nextOffset - styleContainerMainWidth <= -1*stylesContainer.width()){
                            styleRightArrow.hide();
                        } else {
                            styleRightArrow.show();
                        }
                        if(currentOffset + styleContainerMainWidth >= 0){
                            styleLeftArrow.show();
                        } else {
                            styleLeftArrow.hide();
                        }
                    };

                    styleLeftArrow.off('click').on('click', _.throttle(moveLeft, 750));
                    styleRightArrow.off('click').on('click', _.throttle(moveRight, 750));

                    if(stylesContainer.width() > styleContainerMainWidth){
                        styleRightArrow.show();
                    } else {
                        styleRightArrow.hide();
                    }
                };

                if (!isAfterAlbumSwitch) {
                    renderBottomStyles();
                }

                // Bind the click through button
                $('#sfly_wgt_upp .sfly-wgt-orange-btn-sfly, .sfly-wgt-lightlink.see-more-styles').off('click').on('click', function() {
                    var product = view_common.findProjectJsonProduct(productJson, handleCurrentPidCallback());

                    var env = cache.get('env');
                    if ((utils.isMobile || $(window).width() < globals.MOBILE_THRESHOLD) && $(this).hasClass('see-more-styles')) {
                        console.log(">> mobile device, skipping creation-path & redirecting to the calendar page...");
                        window.location.replace(env === 'prod' ? "https://www.shutterfly.com/calendars" :  "https://www." + env + ".shutterfly.com/calendars");
                        return;
                    }

                    if(cache.get("partner_user_id") === "009085953279") {
                        var style   = view_common.getProduct(pId).style;
                        var sizeId  = view_common.getProduct(pId).sizeId;
                        window.location = env === 'prod' ? "https://www.shutterfly.com/gc/#/?styleId=" + style +'&sizeId=' + sizeId :  "https://www." + env + ".shutterfly.com/gc/#/?styleId=" + style +'&sizeId=' + sizeId;
                    } else {
                        if (self.Model.get('openInNewTab')) {
                            self.winHandler = self.openNewWindow(self.winHandler);
                        } else {
                            self.winHandler = null;
                        }
                        var prodType = view_common.getProduct(handleCurrentPidCallback())["type"];
                        if (typeof this.text !== "undefined") {
                            prodType = "calendar_styles";
                        }

                        clickThrough.sendToClickThrough(product, prodType, view_common.showLoading.bind(this, $('#sfly_wgt_full_openwin_container')), view_common.removeLoading.bind(this, $('#sfly_wgt_full_openwin_container')), currAlbum, self.winHandler, self.Model);
                    }

                    var prodJson = view_common.getProduct(handleCurrentPidCallback());
                    var trackingOption = self.augmentTracking({ sku: prodJson.sflySku, page: self.getCurrentOpenPage() }, self.Model);
                    var selectedCal = $(".sfly-wgt-prod-style.sfly-calstyle-selected .sfly_wgt_product");
                    if (cache.get('mode') === 'instance') {
                        tracking.track('tl', 'click-product', {
                            sku: view_common.getTrackingSku(selectedCal.attr('data-sku'), selectedCal.attr('data-pid'), self.Model.get('prod_type')),
                            pid: selectedCal.attr('data-pid'),
                            prod_type: self.Model.get('prod_type')
                        });
                    } else {
                        tracking.track('open', 'personalize', trackingOption);
                    }
                });
            }

            var product         = view_common.findProjectJsonProduct(productJson, pId);
            var pages           = typeof product.product.pages !== "undefined" ? (parseInt(product.product.pages.length) + 1) / 2 : parseInt(product.product.surfaces.length);
            var origProduct     = view_common.getProduct(pId);
            var bookName        = origProduct['styleName'];
            var bookSize        = origProduct['size'];
            var bookStyle       = origProduct['style'];
            handleCurrentPidCallback(pId);

            var sideopen = $(view_common.renderTemplate(templates.popup_calendarmodal, {
                    price: config.getPrice(config.getCalendar()[pId].sflySku),
                    products: '',
                    pid: pId,
                    size: bookSize,
                    sizeTitle: bookSize == '33' ? "5x11" : bookSize,
                    showSizes: true,
                    see_all: origProduct.seeMoreUrl,
                    coupon: typeof cache.getCoupon() !== "undefined" ? cache.getCoupon().name : false,
                    useNewStyleGuide: useNewStyleGuide,
                    title_template: _.template(templates.popup_calendarmodal_title),
                    style: bookName,
                    months: pages-1,
                    hideSelectButton: self.isThisLife ? self.Model.get('ismanualselect') : false,
                    responsiveBtns: self.calcModalWidth() < 800,
                    isMobile: utils.isMobile || $(window).width() < globals.MOBILE_THRESHOLD,
                    hasModalMenu: self.menuContainerPresent
                }
            ));

            if (cache.get('mode') == 'gifting') {
                $(sideopen).find('#sfly_wgt_upp_select').hide();
            }

            var openwinContainer = $('#sfly_wgt_full_openwin_container');

            changeOpenStatusCallback(true, self.closeModalAction, function(){ self.openModalAction(pId, sideopen, releaseLockAndStopLoading, forcedClose) });

            // UPP
            $('#sfly_wgt_upp_select').on('click', function(){
                function onOK(groupPhotos, isThisLife, mixedSources) {
                    //self.Model.set('currAlbum', groupPhotos);
                    window.MagicShopCurrAlbum = groupPhotos;

                    if (groupPhotos.photos.length < 12){
                        view_common.removeLoading(openwinContainer);
                        viewDisableCallback();
                        self.showNotEnoughPhotosPopup(function() {
                            modal_common.showBackgroundLoading(openwinContainer);
                            //viewDisableCallback();
                        });
                        if (self.calcModalWidth() < 800) {
                            $("#sfly_wgt_no_enough_photos_bubble").css('right', '315px');
                        } else {
                            $("#sfly_wgt_no_enough_photos_bubble").css('right',useNewStyleGuide? '405px' :'405px');
                        }
                        //releaseLockCallback();
                        releaseLockAndStopLoading(true);
                        return;
                    }

                    self.hideNotEnoughPhotosPopup();

                    isThisLifeGeneral       = isThisLife;
                    mixedSourcesGeneral     = mixedSources;
                    thisLifePhotoMapping    = groupPhotos;

                    productJson = [];
                    function _getProductJson(pJson) {
                        if (pJson != null) {
                            // if is This Life replace photoIds in the strip with SFLY Ids
                            if(isThisLifeGeneral) {
                                pJson = modal_common.replaceIdWithSFLYId(groupPhotos, pJson);
                            }
                            productJson = productJson.concat(pJson);
                        } else {
                            view_common.removeLoading(openwinContainer);
                            modal_common.showBackgroundLoading(openwinContainer);
                        }
                    }

                    manualSelect = true;

                    $.when(
                        productProxy.getCalendar(groupPhotos, _getProductJson, manualSelect, [handleCurrentPidCallback()], isThisLife, mixedSources, true))
                        .then(function() {
                            currAlbum = groupPhotos;
                            releaseLockAndStopLoading(true);
                        })
                        .fail(function() {
                            releaseLockCallback();
                            view_common.removeLoading(openwinContainer);
                            modal_common.showBackgroundLoading(openwinContainer);
                        });

                    var trackingOption =  self.augmentTracking({ action: 'ok', sku: origProduct['sflySku'] }, self.Model);
                    tracking.track('open', 'upp', trackingOption);
                }

                function onCancel() {
                    releaseLockCallback();
                    view_common.removeLoading(openwinContainer);
                    var trackingOption = self.augmentTracking({ action: 'cancel', sku: origProduct['sflySku'] }, self.Model);
                    tracking.track('open', 'upp', trackingOption);
                }

                function onCancelInstace() {
                    self.Model.set('ismanualselect', false);
                    window.MagicShopCurrAlbum = undefined;
                    self.reshowModalAction(function(){releaseLockAndStopLoading(true)});
                }

                var trackingOption = self.augmentTracking({ action: 'open', sku: origProduct['sflySku'] }, self.Model);
                tracking.track('open', 'upp', trackingOption);

                if (_.isFunction(self.Model.get('callback'))) {
                    var renderModalWithPhotos = function(selectedPhotos){
                        var groupPhotos = {
                            'albumId' : String.fromCharCode(65 + Math.floor(Math.random() * 26)) + Date.now(),
                            'photos' : selectedPhotos
                        };
                        self.reshowModalAction(function(){onOK(groupPhotos, true, false)});
                    };

                    self.Model.get('callback')({action: 'select_photos', onSuccess: renderModalWithPhotos, onFail: onCancelInstace, productType: 'calendar'});
                    self.closeModalAction();
                } else {
                    view_common.showLoading(openwinContainer);
                    takeLockCallback();
                    modal_common.showUPP(onOK, onCancel);
                }

            });

            // change sizes
            var changeSizeCallback = function (calCode) {
                //if the same product do not do anything
                if (bookSize == calCode) {
                    return true;
                }

                var calendarSize = calCode;

                modal_common.hideBackgroundLoading($('#sfly_wgt_full_openwin_container'));
                view_common.showLoading($('#sfly_wgt_full_openwin_container'));

                var newStyleSku = "cal_" + bookStyle + "_" + calCode;
                if (calCode == "33" || bookSize == "33") {
                    newStyleSku = findFirstProductRecipeBySize(calCode);
                }

                $('#sfly_wgt_full_openwin_container .sfly-wgt-book-choose-size').removeClass('sfly-wgt-book-choose-size-selected');
                $('#sfly_wgt_full_openwin_container .sfly-wgt-book-choose-size[data-code="'+calCode+'"]').addClass('sfly-wgt-book-choose-size-selected');

                function _getProductJson(pJson) {
                    if (pJson != null) {
                        if(isThisLifeGeneral) {
                            pJson = modal_common.replaceIdWithSFLYId(currAlbum, pJson);
                        }
                        productJson = productJson.concat(pJson);
                    } else {
                        view_common.removeLoading(openwinContainer);
                        modal_common.showBackgroundLoading(openwinContainer);
                    }

                }

                var trackingOption = self.augmentTracking({ sku: $(this).attr('data-sku') }, self.Model);
                tracking.track('open', 'cal_size_change', trackingOption);

                $.each($('.sfly-wgt-prod-style').children(), function(j, styleDiv){
                    var attrPid = $(styleDiv).attr('data-pid');
                    var styleSkuMapped = attrPid.replace(bookSize, calCode);
                    $(styleDiv).attr('data-pid', styleSkuMapped).attr('data-sku', styleSkuMapped);
                });

                $.when(
                    productProxy.getCalendar(currAlbum, _getProductJson, manualSelect, [newStyleSku], isThisLifeGeneral, mixedSourcesGeneral))
                    .then(function() {
                        var needRenderBottomStyles = calCode == "33" || bookSize == "33";
                        bookSize = calCode;
                        renderCalendar(newStyleSku, productJson, true, function() {
                            view_common.removeLoading($('#sfly_wgt_full_openwin_container'));
                            modal_common.showBackgroundLoading($('#sfly_wgt_full_openwin_container'));
                        });
                        if(needRenderBottomStyles){
                            handleCurrentPidCallback(newStyleSku);
                            renderBottomStyles(productStylesRecipe[newStyleSku]);
                        }
                    })
                    .fail(function() {
                        releaseLockCallback();
                        view_common.removeLoading(openwinContainer);
                        modal_common.showBackgroundLoading(openwinContainer);
                    });
            };

            var getCalendarPrice = function(pId) {
                var priceText = "";
                if (pId) {
                    var origProduct = view_common.getProduct(pId);
                    var price = config.getPrice(origProduct['sflySku']);
                    if (price.originalPrice > 0) {
                        if (price.salePrice > -1) {
                            priceText = "from <span class='price-old'>$" + parseFloat(price.originalPrice).toFixed(2) + "</span> <span class='price-sale'>$" + parseFloat(price.salePrice).toFixed(2);
                            priceText += "</span>";
                        } else {
                            priceText = "from $" + parseFloat(price.originalPrice).toFixed(2);
                        }
                    }
                }
                return priceText;
            };

            var calendarSizes = $(openwinContainer).find('#sfly-wgt-calendar-options .sfly-wgt-book-choose-size');

            var loadMissingPrice = function(calCode, size, pId) {
                var origProduct = view_common.getProduct(pId);
                var bookStyle      = origProduct['styleId'];
                var prodType       = origProduct['type'];
                var newStyleSku = "cal_" + bookStyle + "_" + calCode;
                if (calCode == "33") {
                    newStyleSku = findFirstProductRecipeBySize("33");
                }

                var pricePromises   = [];
                var deferred        = $.Deferred();
                pricePromises.push(deferred);

                thumbGenWrapper.loadProductSKU(newStyleSku, pId, prodType, 'medium', function() {
                    deferred.resolve();
                });

                $.when.apply(undefined, pricePromises).then(function() {
                    productProxy.loadPrices(function() {
                        // Prices are loaded, update the divs
                        var price = getCalendarPrice(pId);
                        $(size).find('.sfly-wgt-book-icon-price').html(price);
                    });
                });

            };

            $.each(calendarSizes, function (i, size) {
                var calCode = $(size).attr('data-code');
                var pId = findFirstProductRecipeBySize(calCode);
                var price = getCalendarPrice(pId);
                if (price) {
                    $(size).find('.sfly-wgt-book-icon-price').html(price);
                } else {
                    // if the price of this calendar not loaded yet
                    loadMissingPrice(calCode, size, pId);
                }

                $(size).on('click', changeSizeCallback.bind(undefined, calCode));
            });


            self.enableTabSwitching();

            // Position the open/close button in the right place
            var btn = $('.sfly-wgt-btn-sidemodule');

            // When the window is just refreshed and re-rendered
            if (!self.getIsWidgetOpen()) {
                buttonCloseCallback(btn, 'prod_clicked');
            }
        };

        return function(){
            modal.call(this);

            // helper for private functions
            var self = this;

            // Will open the sliding window with the given products
            this.showProductsWindow = function(pId, album, albums, prodStyles, prodOptions, forceCloseExternal, isThisLife, useNewStyleGuideFlag, doNotResizeImagesFlag, tooltipItems, textualStructure, mixedSources, takeLockCallback, releaseLockCallback, closeButtonCallback, changeOpenStatusCallback, handleCurrentPidCallback, viewDisableCallback) {
                useNewStyleGuide = useNewStyleGuideFlag;
                doNotResizeImages = doNotResizeImagesFlag;
                productStylesRecipe = prodStyles;

                var origPid = pId;
                var changedPid = false;

                if (this.menuContainerPresent) {
                    //album = self.Model.get('currAlbum') !== null ? self.Model.get('currAlbum') : album;
                    album = typeof window.MagicShopCurrAlbum !== 'undefined' && window.MagicShopCurrAlbum !== null ? window.MagicShopCurrAlbum : album;

                    // if we're coming from a different style of calendar, we want to current one to be that one
                    var prevPid = handleCurrentPidCallback();
                    // for desk calendar, don't do this
                    if (prevPid !== null && typeof prevPid !== 'undefined' && pId.split('_')[0] == 'cal' && prevPid.split('_')[0] == 'cal') {
                        var styleId = prevPid.split('_')[1];
                        var sizeId = pId.split('_')[2];
                        pId = 'cal_' + styleId + '_' + sizeId;
                        changedPid = true;
                    }
                }

                mobileRenderingOnMenuContainer = $(window).width() < globals.TABLET_THRESHOLD && self.menuContainerPresent;
                function showTheCalendar(forceClose) {
                    self.setCurrentOpenPage(0);
                    var productJson = [];
                    function _getProductJson(pJson) {
                        if (pJson != null) {
                            // if is This Life replace photoIds in the strip with SFLY Ids
                            if(isThisLife) {
                                pJson = modal_common.replaceIdWithSFLYId(album, pJson);
                            }
                            productJson = productJson.concat(pJson);
                        }
                    }

                    isThisLifeGeneral = isThisLife;
                    mixedSourcesGeneral = mixedSources;
                    manualSelect = self.Model.get('isManualSelect') ? true : false;
                    var styleToGet = changedPid ? pId : prodStyles[pId][0];

                    $.when(
                        productProxy.getCalendar(album, _getProductJson, manualSelect, [styleToGet], isThisLife, mixedSources))
                        .then(function() {
                            openSlideAndRenderBook(pId, productJson, prodStyles[origPid], prodOptions[origPid], forceClose, albums, album, takeLockCallback, releaseLockCallback, closeButtonCallback, changeOpenStatusCallback, handleCurrentPidCallback, viewDisableCallback, self);
                        })
                        .fail(function(){
                            changeOpenStatusCallback(false, self.closeModalAction);
                            setTimeout(releaseLockCallback, 200);
                        });
                }

                this.showProductsWindowFeatures(pId, album, albums, prodStyles, prodOptions, forceCloseExternal, takeLockCallback, releaseLockCallback, closeButtonCallback, changeOpenStatusCallback, handleCurrentPidCallback, viewDisableCallback, showTheCalendar);
            };
        };

        this.prototype = Object.create(modal.prototype);
    }
);

/*
 This module will be responsible to load the modal in according the product
 */

define('app/view_engine/modals/full/modal_manager',
    ['app/view_engine/widgets/common', 'app/view_engine/modals/full/modal_photobook', 'app/view_engine/modals/full/modal_product', 'app/view_engine/modals/full/modal_prints', 'app/view_engine/modals/full/modal_calendar'],
    function(view_common, modal_photobook, modal_product, modal_prints, modal_calendar) {

        /**
         * return the modal window of the product
         * @param boolean isClose - if is close action
         * @param string pId - pId of the product
         */
        var getProductModal = (function(){

            // defined modals
            var definedModals = {
                'photobook'     : modal_photobook,
                'product'       : modal_product,
                'calendar'      : modal_calendar,
                'deskcalendar'  : modal_calendar,
                'prints'        : modal_prints
            };

            // holder of modals per product
            var productModal = new Array();

            return function(isClose, pId){

                var productType     = isClose ? 'photobook' : view_common.getProduct(pId)['type'];
                productType         = (typeof definedModals[productType] === "undefined") ? 'product' : productType;
                var modal           = null;
                var modalObj        = definedModals[productType];

                if (modalObj !== null) {
                    if (typeof productModal[productType] === "undefined") {
                        modal = new modalObj();
                        productModal[productType] = modal;
                    } else {
                        modal = productModal[productType];
                    }
                } else {
                    throw 'modal minimal for ' + productType + ' not implemented.';
                }

                return modal;
            }
        })();

        return {
            show : function(params) {
                var modal = getProductModal(false, params.pId);
                modal.show(params);
            },

            close : function(forceCloseExternal, widgetIsOpen, callbacks) {
                var modal = getProductModal(true);
                modal.close(forceCloseExternal, widgetIsOpen, callbacks);
            }
        }
    }
);
/* Module for monitoring times and sending the results to an end-point */

define('app/athena_logger', ['underscore', 'app/cache_module', 'app/utils'], function(_, cache, utils) {
    function Logger(prodType, cohort) {
        var env,
            serverUrl;

        function init() {
            env = cache.get('env');
            serverUrl = getServerUrl(env);
            //cohort = MagicShop.abTestGroup || "";
        }

        function getServerUrl(env) {
            switch (env) {
                case 'beta':
                    return '';
                case 'stage':
                    return 'https://9fcsuu2kjl.execute-api.us-east-1.amazonaws.com/stage/putrecord';
                case 'prod':
                default:
                    return 'https://rnqsnkjjbj.execute-api.us-east-1.amazonaws.com/prod/putrecord';
            }
        }

        function buildMessageObject(params) {
            if (!params || Object.keys(params).length === 0) {
                return {};
            }

            var mObj = {
                "category": "userActivity",
                "placement": prodType,
                "event": params.event,
                "date": Math.floor(Date.now() / 1000),
                "userId": cache.get('partner_user_id'),
                "cohort": cohort,
                "browserName": utils.browserInfo.name,
                "browserVersion": utils.browserInfo.version,
                "os": utils.browserInfo.os
            };

            if (params.hasOwnProperty("sku")) {
                mObj['sku'] = params.sku;
            }

            if (params.hasOwnProperty("productType")) {
                mObj['productType'] = params.productType;
            }

            if (params.hasOwnProperty("adobeSku")) {
                mObj['adobeSku'] = params.adobeSku;
            }

            if (params.hasOwnProperty("usedSku")) {
                mObj['usedSku'] = params.usedSku;
            }

            return mObj;
        }

        this.logEvent = function(params) {
            if (prodType !== 'mysfly' && prodType !== 'cross_sell') {
                //console.log("logEvent rejected. Not logging event from "  + prodType);
                return;
            }

            $.ajax({
                url: serverUrl,
                dataType: 'text',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(buildMessageObject(params)),
                success: function (data, textStatus, jQxhr) {
                    //$('#response pre').html( data );
                    //console.debug("Athena Logger::logEvent - successfully logged event to Athena");
                },
                error: function (jqXhr, textStatus, errorThrown) {
                    console.log("Athena Logger::logEvent - ERROR!");
                    console.log(errorThrown);
                }
            });
        };

        this.logModuleInit = function(options) {
            this.logEvent({
                "event": "module_init"
            });
        };


        this.logModuleDisplayed = function(options) {
            this.logEvent({
                "event": "module_displayed"
            });
        };

        this.logProductClick = function(options) {
            var productType = options.productType || "";
            this.logEvent({
                "event": "product_clicked",
                "productType": productType
            })
        };

        init();
    }

    return Logger;
});
define('app/view_engine/widgets/engines/EngineBase', ['underscore', 'app/view_engine/widgets/common', 'app/templates', 'app/time_monitor', 'app/tracking', 'app/product_proxy', 'app/cache_module', 'app/config_manager', 'app/view_engine/helpers'], function(_, view_common, templates, monitor, tracking, productProxy, cache, config, helpers) {
    function EngineBase(params) {
        this.params     = params;
        this.Model      = params.model;
    }

    EngineBase.prototype = {
        init: function() {},

        // Very simple implementation of a lock. As this is a single instance widget, we can use this simple scheme
        takeLock: function() {
            if (!this.DISABLE_CLICK) {
                this.DISABLE_CLICK = true;
            }

            return this.DISABLE_CLICK;
        },

        // Will release the global lock
        releaseLock: function() {
            this.DISABLE_CLICK = false;
        },

        // Check if global lock is free or taken
        isLocked: function() {
            return this.DISABLE_CLICK;
        },

        calTotalProductsHeightByBoundingBox: function(products, productJson, getBoundingBox, prodSizes) {
            var size,
                ratio,
                zoomLevel,
                boundingBox,
                getBoundingBoxisFunc = _.isFunction(getBoundingBox),
                totalHeight = 0,
                totalWidth = 0;

            var sizes = {};

            try {
                _.each(products, function(pId) {
                    if (getBoundingBoxisFunc) {
                        boundingBox = getBoundingBox(pId);
                    }

                    size        = view_common.getProductRealSize(productJson, pId);
                    zoomLevel   = typeof prodSizes[pId] !== 'undefined' ? prodSizes[pId] : 1;

                    // Decide by the larger side
                    if (size.realHeight > size.width) {
                        // Resize by height
                        ratio = boundingBox.height / size.realHeight
                    } else {
                        // Resize by width
                        ratio = boundingBox.width / size.width;
                    }

                    ratio *= zoomLevel;

                    sizes[pId] = {
                        width: size.width * ratio,
                        height: size.realHeight * ratio,
                        ratio: ratio
                    };

                    totalHeight += size.realHeight * ratio;
                    totalWidth += size.width * ratio;
                });

                return {
                    totalHeight: Math.floor(totalHeight),
                    totalWidth: Math.floor(totalWidth),
                    sizes: sizes
                };
            } catch (e) {
                return { "error" : {msg: e.message } };
            }
        },

        //getBoundingBox is a method provided by the engine if it wants to provide separate bounding boxes for different products like in TLVEngine
        // we need smaller shopping bag
        calTotalProductsHeightByBoundingBoxAsync: function(products, productJson, getBoundingBox, prodSizes, callback) {
            var size,
                ratio,
                zoomLevel,
                boundingBox,
                getBoundingBoxisFunc = _.isFunction(getBoundingBox),
                totalHeight = 0,
                totalWidth = 0;

            var sizes = {};

            function updateTotalSizes(pId, deferred) {
                if (getBoundingBoxisFunc) {
                    boundingBox = getBoundingBox(pId);
                }
                size        = view_common.getProductRealSize(productJson, pId);
                zoomLevel   = typeof prodSizes[pId] !== 'undefined' ? prodSizes[pId] : 1;

                // Decide by the larger side
                if (size.realHeight > size.width) {
                    // Resize by height
                    ratio = boundingBox.height / size.realHeight
                } else {
                    // Resize by width
                    ratio = boundingBox.width / size.width;
                }

                ratio *= zoomLevel;

                sizes[pId] = {
                    width: size.width * ratio,
                    height: size.realHeight * ratio,
                    ratio: ratio
                };

                totalHeight += size.realHeight * ratio;
                totalWidth += size.width * ratio;

                deferred.resolve();
            }

            try {
                var promises = [];
                _.each(products, function(pId) {
                    var deferred = $.Deferred();
                    promises.push(deferred);
                    _.defer(updateTotalSizes.bind(undefined, pId, deferred));
                });

                $.when.apply(undefined, promises).then(function() {
                    callback({
                        totalHeight: Math.floor(totalHeight),
                        totalWidth: Math.floor(totalWidth),
                        sizes: sizes
                    })
                });
            } catch (e) {
                callback({ "error" : { msg: e.message } });
            }
        },

        cleanSourceWithAlbums: function(source, albums, numOfProducts, useZeroPhotos) {
            var product;
            var cleanSource = [];
            useZeroPhotos = typeof useZeroPhotos !== 'undefined' ? useZeroPhotos : false;
            // Remove product we don't have albums or layouts for
            _.each(source, function(sku) {
                product = view_common.getProduct(sku);

                switch(product.type) {
                    case 'photobook':
                        if (albums.photobook.length > 0) {
                            cleanSource.push(sku);
                        }
                        break;
                    case 'prints':
                        if (albums.prints.length > 0) {
                            cleanSource.push(sku);
                        }
                        break;
                    case 'calendar':
                    case 'deskcalendar':
                        if (albums.calendars.length > 0) {
                            cleanSource.push(sku);
                        }
                        break;
                    default:
                        // for all other products
                        // if in gifting - we can use zero photos
                        if ((albums.products.length > 0 && helpers.Utils.productHasSuitableLayout(sku, albums.products[0].photos.length)) || (useZeroPhotos && albums.products.length > 0 && albums.products[0].photos.length == 0)) {
                            cleanSource.push(sku);
                        }
                        break;
                }
            });

            // Make sure the size of the new source is max the required size
            if (cleanSource.length > numOfProducts) {
                cleanSource = _.first(cleanSource, numOfProducts);
            }

            return cleanSource;
        },

        getCurrentAlbum: function(pId, albums) {
            var product = view_common.getProduct(pId);
            var currAlbums;
            switch(product.type) {
                case 'prints':
                    currAlbums = albums.prints;
                    break;
                case 'photobook':
                    currAlbums = albums.photobook;
                    break;
                case 'calendar':
                case 'deskcalendar':
                    currAlbums = albums.calendars;
                    break;
                default:
                    currAlbums = albums.products;
            }
            return { currAlbum: currAlbums[0], currAlbums: currAlbums };
        },

        removeHoverStates: function(container) {
            $(container).find('.sfly_wgt_product').removeClass('on-hover-other').removeClass('on-hover');
        },

        addDisableOverlay: function(target) {
            if ($(target).children('.sfly_wgt_disable_overlay').length == 0) {
                $(target).addClass('sfly-wgt-disabled').append('<div class="sfly_wgt_disable_overlay"></div>');
            }
        },

        removeDisableOverlay: function(target) {
            $(target).removeClass('sfly-wgt-disabled').find('.sfly_wgt_disable_overlay').remove();
        },

        toggleViewDisable: function(isViewDisabled) {
            if (isViewDisabled.state) {
                this.removeDisableOverlay($('#sfly_wgt_container'));
            } else {
                this.addDisableOverlay($('#sfly_wgt_container'));
            }

            isViewDisabled.state = !isViewDisabled.state;
        },

        horizontalOverlayMessage: function(msgType, isViewDisabled) {
            // 1. overlay the view
            this.toggleViewDisable(isViewDisabled);

            // 2. display correct message
            var env = cache.get('env');
            env = env != 'prod' ? '.' + env : '';

            switch(msgType) {
                case 'signin':
                    $('.sfly_wgt_listview_container').append(view_common.renderTemplate(templates.side_signin_msg, { env: env }));
                    break;
                case 'upload':
                    var isSuperflyUser = typeof Shr !== "undefined" && typeof Shr.U !== "undefined" && typeof Shr.U.migrated !== "undefined" && Shr.U.migrated == true;
                    $('.sfly_wgt_listview_container').append(view_common.renderTemplate(templates.side_upload_msg_popup, { env: env, superfly: isSuperflyUser }));
                    break;
            }
        },

        horizontalShowOverlayView: function(msgType, isViewDisabled) {
            if (this.Model.get('instance')) {
                tracking.track('tl', 'on_load_static', {mode: 'instance', prod_type: this.Model.get('prod_type')});
                this.Model.get('monitoring').eventStart('tl:on_load_static');
                this.Model.get('monitoring').eventEnd('tl:on_load_static');
            } else {
                tracking.track('mg', 'on_load');
                this.Model.get('monitoring').eventStart('mgv3:on_load');
                this.Model.get('monitoring').eventEnd('mgv3:on_load');
            }

            // show overlay
            this.horizontalOverlayMessage(msgType, isViewDisabled);

            // Stop and show only static assets
            var staticAsset = $(view_common.renderTemplate(templates.side_static_mg, { env: cache.get('env') }));

            var mainContainer = $('.sfly_wgt_listview_container');
            mainContainer.append(staticAsset);
            this.removeLoader(mainContainer);

            mainContainer.find('.sfly-wgt-overlay-message').animate({left:'0px'},500);

        },

        changeWidgetOpenState: function(isWidgetOpen, newState, closeAction, openAction) {
            isWidgetOpen.state = newState;
            if(newState) {
                openAction();
            } else {
                closeAction();
            }
        },

        updateCssForSpreads: function(containerElement, typeOfView, direction, widgetHeight) {
            if (typeof direction !== 'undefined' && direction == 'vertical') {
                $(containerElement).find('.sfly_wgt_' + typeOfView + '_spread:not(.sfly_wgt_' + typeOfView + '_spread_0)').css('top', ((-1)*widgetHeight)+'px');
            } else {
                $(containerElement).find('.sfly_wgt_' + typeOfView + '_spread:not(.sfly_wgt_' + typeOfView + '_spread_0)').css('left', ((-1)*$(containerElement).width())+'px');
            }
        },

        prepareSpreads: function(products, typeOfView, prodsPerSpread, direction) {
            var count           = 0;
            var spreads         = [];
            var currSpreadId    = -1;
            var skus            = '';
            var selSpreadCls    = '';
            var result          = '';
            direction = (typeof direction !== 'undefined') ? direction : 'horizontal';

            _.each(products, function(sku) {
                // Every 'prodsPerSpread' - open a new spread
                if (count % prodsPerSpread == 0) {
                    // If we finished a spread, write down its products in a comfortable list
                    if (currSpreadId > -1) {
                        spreads[currSpreadId].attr('data-pids', skus);
                    }
                    currSpreadId = count / prodsPerSpread;
                    selSpreadCls = currSpreadId == 0 ? 'curr-spread' : '';
                    if (direction == 'vertical') {
                        spreads[currSpreadId] = $('<div class="sfly_wgt_' + typeOfView + '_spread sfly_wgt_' + typeOfView + '_spread_' + currSpreadId + ' ' + selSpreadCls + '" data-order="' + currSpreadId + '"></div>');
                    } else {
                        spreads[currSpreadId] = $('<div class="sfly_wgt_spread_mg sfly_wgt_' + typeOfView + '_spread sfly_wgt_' + typeOfView + '_spread_' + currSpreadId + ' ' + selSpreadCls + '" data-order="' + currSpreadId + '"></div>');
                    }
                    skus = sku;
                } else {
                    skus += ',' + sku;
                }

                $(spreads[currSpreadId]).addClass('p_' + sku);
                count++;
            });
            spreads[currSpreadId].attr('data-pids', skus);

            if (direction == 'vertical') {
                result = $('<div class="sfly_wgt_listview_spread_container"><div class="sfly-wgt-lv-arrow-up"></div><div class="sfly-wgt-lv-arrow-down"></div></div>');
            } else {
                result = $(view_common.renderTemplate(templates.side_spread_cont));
            }

            var prev = 0;
            var next = 0;
            spreads.forEach(function(elem, idx, array) {
                // Add paging only if having more than one
                if (spreads.length > 1) {
                    // calculate next/prev spreads
                    if (idx == 0) { // This is the first
                        prev = spreads.length-1;
                        next = idx + 1;
                    } else if (idx == spreads.length-1) { // This is the last
                        prev = idx-1;
                        next = 0;
                    } else { // Somewhere in the middle
                        prev = idx-1;
                        next = idx+1;
                    }
                }

                result.append(elem);
            });

            $(result).attr('data-total-spreads', currSpreadId).attr('data-curr-spread', 0);

            return { spreads: result, total: currSpreadId };
        },

        getPhotoIdsForPrints: function(productJson, pId, isAfterUpp, currAlbum, isManual) {
            var product = view_common.findProjectJsonProduct(productJson, $(this).attr('data-pid'), isAfterUpp);
            var photoIds = new Array();
            if (!isAfterUpp) {
                var photosRefIds = new Array();
                $.each(product.prints.pages, function (i, cPage) {
                    $.each(cPage.canvas.layout.photos, function (j, cPhoto) {
                        photosRefIds[cPhoto.photoRefId] = 1;
                    });
                });

                if (photosRefIds.length > 0) {
                    $.each(product.prints.photoStrip, function (i, cPhotoStrip) {
                        if (typeof photosRefIds[cPhotoStrip.photoRefId] !== "undefined") {
                            photoIds.push(cPhotoStrip.photoId);
                        }
                    });
                }
            } else {
                photoIds = currAlbum.photos.map(function (p) {
                    return parseInt(p.id)
                });
            }

            if(!isManual) {
                photoIds = _.first(photoIds, 200);
            }

            return photoIds;
        },

        // ProdHeight is optional. User for horizontal views.
        findPositionProductsInSpreads: function(params) {
            var prodPos = {};
            var prodSizes = {};
            var totalWidth = 0;
            var err = undefined;

            $(params.spreads).children('.sfly_wgt_' + params.typeOfView + '_spread').each(function(idx, elem) {
                var pos = params.calcElemPositionFunc({
                    containerElement: params.container,
                    container: elem,
                    productJson: params.productJson,
                    targetHeight: params.targetHeight,
                    targetWidth: params.targetWidth,
                    maxSpaceBetweenProds: params.maxSpaceBetweenProds,
                    sidePadding: params.sidePadding,
                    prodSizes: params.prodSizeZoomLevels,
                    prodHeight: params.prodHeight
                });

                if (typeof pos.error !== 'undefined') {
                    err = pos;
                    return;
                }

                $.extend(prodPos, pos.positions); // copy the new position into the existing one
                $.extend(prodSizes, pos.sizes);
                totalWidth += pos.totalWidth;

                // For horizontal views
                if (typeof params.prodHeight !== 'undefined') {
                    $(this).css('width', pos.totalWidth);
                }
            });

            if (typeof err !== 'undefined') {
                return err;
            } else {
                return {
                    positions: prodPos,
                    sizes: prodSizes,
                    width: totalWidth
                };
            }

        },

        findPositionProductsInSpreadsAsync: function(params) {
            var prodPos = {};
            var prodSizes = {};
            var totalWidth = 0;
            var err = undefined;
            var promises = [];

            $(params.spreads).children('.sfly_wgt_' + params.typeOfView + '_spread').each(function(idx, elem) {
                function clb(promise, pos) {
                    if (typeof pos.error !== 'undefined') {
                        err = pos;
                        promise.resolve();
                        return;
                    }

                    $.extend(prodPos, pos.positions); // copy the new position into the existing one
                    $.extend(prodSizes, pos.sizes);
                    totalWidth += pos.totalWidth;

                    // For horizontal views
                    if (typeof params.prodHeight !== 'undefined') {
                        $(this).css('width', pos.totalWidth);
                    }

                    promise.resolve();
                }

                var deferred = $.Deferred();
                promises.push(deferred);

                params.calcElemPositionFunc({
                    containerElement: params.container,
                    container: elem,
                    productJson: params.productJson,
                    targetHeight: params.targetHeight,
                    targetWidth: params.targetWidth,
                    maxSpaceBetweenProds: params.maxSpaceBetweenProds,
                    sidePadding: params.sidePadding,
                    prodSizes: prodSizes,
                    prodSizeZoomLevels: params.prodSizeZoomLevels,
                    prodHeight: params.prodHeight,
                    callback: clb.bind(this, deferred)
                });
            });

            $.when.apply(undefined, promises).then(function() {
                if (typeof err !== 'undefined') {
                    params.callback(err);
                } else {
                    params.callback({
                        positions: prodPos,
                        sizes: prodSizes,
                        width: totalWidth,
                        zoomLevels: params.prodSizeZoomLevels
                    });
                }
            });
        },

        failWidget: function(mode, trackPrefix, monitorPrefix, removeTheIframe) {
            var that = this;

            $('#sfly_wgt_full_overlay').remove();
            $('#sfly_wgt_full_openwin_container').remove();
            this.Model.get('container').animate({ height: '0px' }, 200, function() {
                that.Model.get('container').remove();
            });

            this.Model.get('monitoring').addCounter(monitorPrefix + ':on_load_fail');
            cache.set('full_load', true);

            var trackingOptions = this.Model.get('instance') ? { mode: mode, prod_type: this.Model.get('prod_type') } : {};
            tracking.track(trackPrefix, 'on_load_fail', trackingOptions );

            if (typeof removeTheIframe !== 'undefined' && removeTheIframe) {
                $('#iframe_cns').remove();
            }
        },

        updateProductPrice: function(params) {
            function augmentVerticalTop(origTop, size, productType) {
                var top = origTop - size.top*ratio;

                if (productType == 'mug' || productType == 'travelmug' || productType == 'ceramicTile') {
                    top += 13;
                }

                if (productType == 'glassor') {
                    top += 27;
                }

                return top;
            }

            var MOVE_DOWN_PX        = params.widgetType == 'vertical' ? 17 : 25;
            var ZOOM_LEVEL          = 1.05;
            var zoomLevelDownsize   = 0.6;
            var product             = view_common.getProduct(params.pId);
            var size                = view_common.getProductRealSize(params.productJson, params.pId);
            var hoverCenter         = 0;
            var title               = '';
            var priceSku            = (product.type === "calendar" || product.type === "photobook") && product.sflySku ? product.sflySku : product.sku;
            var price               = config.isPricesLoaded() ? config.getPrice(priceSku) : null;
            var hover               = '';

            // if we have title for the recipe use it otherwise use the one from the sku file
            if(typeof params.prodOptions !== "undefined" && typeof params.prodOptions[params.pId] !== "undefined" && typeof params.prodOptions[params.pId]['title'] !== "undefined") {
                title = params.prodOptions[params.pId]['title'];
            } else {
                title = product['type'] == 'photobook' ? product['size'] + ' Photo book' : product['title'];
                title = product['type'] == 'calendar' ? product['size'] + " " + title : title;
            }

            var elem                = $(view_common.renderTemplate(templates.listview_prod_price, {
                title: title,
                price: price,
                price_template: _.template(templates.listview_pprice_inr),
                coupon: typeof cache.getCoupon() !== "undefined" ? cache.getCoupon().name : false
            }));
            var ratio               = params.targetSize.ratio;
            var productCenter       = (size.left + (size.width)/2);
            var priceCenter         = 80;   //size.width/2;   <--- The price has a fixed size of 160px
            var move_x              = (productCenter*ratio - priceCenter);
            var move_x_zoomedout    = (productCenter*ratio*zoomLevelDownsize - priceCenter);
            var move_x_zoomedin     = (productCenter*ratio*ZOOM_LEVEL - priceCenter);
            var top                 = params.targetSize.height + size.top*ratio + MOVE_DOWN_PX;

            if (params.widgetType == 'vertical' && (price == null || price.originalPrice == -1)) {
                this.waitForPrices(elem, product['sflySku'], params.pId);
            }

            if (params.widgetType == 'vertical') { top = augmentVerticalTop(top, size, product['type']) }

            if (typeof cache.getCoupon() !== "undefined") { top -= 6; }

            var topZoomedIn = top + size.height * ratio * (ZOOM_LEVEL-1)/2;

            elem
                // .css('position', 'absolute')
                // .css('top', top + 'px')
                // .css('left', move_x + 'px')
                // .css('margin', '0')
                .attr('data-top', top)
                .attr('data-left', move_x)
                .attr('data-price-center', move_x)
                .attr('data-price-zoom-center', move_x_zoomedout)
                .attr('data-price-zoomin-center', move_x_zoomedin)
                .attr('data-price-top-zoomin', topZoomedIn);

            $(params.container).append(elem);

            if (params.widgetType == 'horizontal' || params.widgetType == 'tl_horizontal') {
                switch(params.widgetType) {
                    case 'tl_horizontal':
                        hover = $(view_common.renderTemplate(templates.fullview_prod_hover_tl, { productType: product['type'], clickthroughNoModal: params.clickthroughNoModal }));
                        hoverCenter = 70;
                        break;
                    case 'horizontal':
                        hover = $(view_common.renderTemplate(templates.fullview_prod_hover));
                        hoverCenter = 59;
                        break;
                }

                // add hover box
                var MOVE_HOVER_UP_PX = 40;
                var topHover = params.targetSize.height + size.top * ratio - MOVE_HOVER_UP_PX + size.height * ratio * (ZOOM_LEVEL - 1) / 2;
                var leftHover = productCenter * ratio * ZOOM_LEVEL - hoverCenter;

                hover
                    .css('top', topHover + 'px')
                    .css('left', leftHover + 'px');

                $(params.container).append(hover);
            }

            return top;
        },

        globalWidgetInit: function() {},

        loadPrices: function(containerElement, products) {
            var that = this;
            productProxy.loadPrices(function() {
                // Prices are loaded, update the divs
                _.each(products, function(sku) {
                    var pDiv        = $(containerElement).find('.sfly_wgt_product[data-pid="' + sku + '"]')[0];
                    var priceArea   = $(pDiv).find('.price-wrapper');
                    var product     = view_common.getProduct(sku);

                    that.updatePriceForProduct(priceArea, product);
                });
            });
        },

        thumbRenderPreparePhotoIds: function(product, currAlbum, isAfterUPP, isManual) {
            var photoIds = new Array();
            if (!isAfterUPP) {
                var photosRefIds = new Array();
                $.each(product.prints.pages, function (i, cPage) {
                    $.each(cPage.canvas.layout.photos, function (j, cPhoto) {
                        photosRefIds[cPhoto.photoRefId] = 1;
                    });
                });

                if (photosRefIds.length > 0) {
                    $.each(product.prints.photoStrip, function (i, cPhotoStrip) {
                        if (typeof photosRefIds[cPhotoStrip.photoRefId] !== "undefined") {
                            photoIds.push(cPhotoStrip.photoId);
                        }
                    });
                }
            } else {
                photoIds = currAlbum.photos.map(function (p) {
                    return parseInt(p.id)
                });
            }

            if(!isManual) {
                photoIds = _.first(photoIds, 200);
            }

            return photoIds;
        },

        openBookModal: function(params) {
            var currItemOrder = params.elem.attr('data-order') - 1; // order is "1" based, albums is "0" based
            var currAlbums = params.albums.photobook;
            var currAlbum = currAlbums[0];

            // Add Opacity to other products
            $('.sfly_wgt_product').addClass('not-selected');
            this.removeHoverStates(params.containerElement);

            if (!params.widgetState) {
                view_common.showLoading($('.sfly_wgt_listview_container'));
            }

            // tracking.track('tl', 'click', {
            //     sku: params.elem.attr('data-sku'),
            //     order: currItemOrder,
            //     mode: params.widgetType,
            //     prod_type: this.Model.get('prod_type')
            // });
            // tracking.track('tl', 'hover', {
            //     sku: params.elem.attr('data-sku'),
            //     order: currItemOrder,
            //     mode: params.widgetType,
            //     prod_type: this.Model.get('prod_type')
            // });
            tracking.track('tl', 'click-category', {
                sku: params.elem.attr('data-sku'),
                order: currItemOrder,
                mode: params.widgetType,
                prod_type: this.Model.get('prod_type')
            });



            if (params.clickthroughNoModal) {
                if (this.Model.get('openInNewTab')) {
                    params.winHandler = view_common.openNewWindow(params.winHandler);

                    if (!params.widgetState) {
                        this.removeLoading($('.sfly_wgt_listview_container'));
                    }
                } else {
                    params.winHandler = null;
                }

                var pJson = view_common.findProjectJsonProduct(params.productJson, params.pId);
                params.clickThrough.sendToClickThrough(pJson, params.productType, null, null, currAlbum, params.winHandler, this.Model);
            } else {
                if (_.isFunction(params.modalCallback)) {
                    params.modalCallback();
                }
            }
        },

        formatAllAlbums: function(albums, retry) {
            var albumsPhotobook = albums.photobooks || [];
            var albumsProducts = albums.products || [];
            var albumsPrints = albums.prints || [];
            var albumsCalendars = albums.calendars || [];

            retry = retry || false;

            return {
                'photobook': albumsPhotobook.length > 1 && retry ? [_.rest(albumsPhotobook, 1)[0]] : _.first(albumsPhotobook,1),
                'products': albumsProducts.length > 1 && retry ? [_.rest(albumsProducts, 1)[0]] : _.first(albumsProducts,1),
                'prints': albumsPrints.length > 1 && retry ? [_.rest(albumsPrints, 1)[0]] : _.first(albumsPrints,1),
                'calendars': albumsCalendars.length > 1 && retry ? [_.rest(albumsCalendars, 1)[0]] : _.first(albumsCalendars,1)
            }
        },

        isPriceLoaded: function() {
            return (typeof cache.get('prices_loaded') !== 'undefined' && cache.get('prices_loaded'));
        },

        waitForPrices: function(container, sku, pId) {
            var self = this;
            var productsToGetPricesFor = [];
            var priceTimeoutHandler;

            var pElem = {
                container: container,
                sku: sku,
                pid: pId
            };

            function onTimeout() {
                clearTimeout(priceTimeoutHandler);

                priceTimeoutHandler = setTimeout(function() {
                    if (self.isPriceLoaded()) {
                        // Run through all requested prices
                        productsToGetPricesFor.forEach(function(prod) {
                            var elem = $(prod.container).find('.price-wrapper').first();
                            if (typeof elem !== 'undefined') {
                                var priceSku = (prod.type === "photobook" || prod.type === "calendar") && prod.sflySku ? prod.sflySku : prod.sku;
                                elem.html(view_common.renderTemplate(templates.listview_pprice_inr, { price: config.getPrice(priceSku) }));
                                self.addCouponHtml(elem);
                            }
                        });

                        // Clear the array
                        productsToGetPricesFor.length = 0;
                    } else {
                        onTimeout();
                    }
                }, 1000);
            }

            productsToGetPricesFor.push(pElem);

            onTimeout();
        },

        updatePriceForProduct: function(priceElem, product, viewType) {
            viewType = (typeof viewType !== 'undefined') ? viewType : 'all';

            var viewTypes = {
                'replacement': function(priceElem, price) {
                    $(priceElem).html('<span class="listPrice"></span><span class="salePrice"></span>');
                    $(priceElem).children('.listPrice').html('$'+parseFloat(price.originalPrice).toFixed(2));
                    $(priceElem).children('.salePrice').html('$'+parseFloat(price.salePrice).toFixed(2));
                },

                'all': function(priceElem, price) {
                    if(price.salePrice === 0) {
                        $(priceElem).html('<span class="price-old"></span> <span class="price-sale"><span class="price-sale-save"> FREE! </span></span>');
                    }else {
                        $(priceElem).html('<span class="price-old">$' + parseFloat(price.originalPrice).toFixed(2) + '</span> <span class="price-sale">$' + parseFloat(price.salePrice).toFixed(2) + '<span class="price-sale-save"> Save ' + Math.round((1 - price.salePrice / price.originalPrice) * 100) + '%</span></span>');
                    }
                }
            };

            if (typeof product !== 'undefined') {
                var priceSku = (product.type === "photobook" || product.type === "calendar") && product.sflySku ? product.sflySku : product.sku;
                var price = config.getPrice(priceSku);
                if (price.salePrice > -1) {
                    viewTypes[viewType](priceElem, price);
                }
                else {
                    if (price.originalPrice > 0) {
                        var f = 'from';
                        if(typeof this.newTitlePricingFormat !== 'undefined' && this.newTitlePricingFormat) {
                            f = 'From';
                        }
                        $(priceElem).html(f +' $' + parseFloat(price.originalPrice).toFixed(2));
                    }
                    else {
                        $(priceElem).html('&nbsp;');
                    }
                }
            }

            this.addCouponHtml(priceElem);
        },

        addCouponHtml: function(element) {
            if(typeof cache.getCoupon() !== "undefined" && $(element).parent().find('.sfly_wgt_product_price_coupon').length == 0) {
                $(element).parent().append('<div class="sfly_wgt_product_price_coupon">Code: '+cache.getCoupon().name +'</div>');
            }
        },

        removeLoader: function(target) {
            $(target).children('.sfly_wgt_throbber').remove();
        }
    };

    return EngineBase;
});

define('app/view_engine/widgets/engines/EngineVertical', ['underscore', 'app/view_engine/widgets/engines/EngineBase', 'app/utils', 'app/templates', 'app/view_engine/widgets/common', 'app/cache_module'], function(_, EngineBase, utils, templates, view_common, cache) {
    function EngineVertical(params) {
        EngineBase.call(this, params);
    }

    utils.inheritPrototype(EngineVertical, EngineBase);

    EngineVertical.prototype.failWidgetStandalone = function() {
        $('#iframe_cns').remove();
        $('#sfly_wgt_container').remove();
        $('#sfly_wgt_openwin_container').remove();
        $('.sfly-wgt-btn-sidemodule').remove();
        cache.set('full_load', true);
    };

    return EngineVertical;
});
/*
 * Require-CSS RequireJS css! loader plugin
 * 0.1.2
 * Guy Bedford 2013
 * MIT
 */

/*
 *
 * Usage:
 *  require(['css!./mycssFile']);
 *
 * Tested and working in (up to latest versions as of March 2013):
 * Android
 * iOS 6
 * IE 6 - 10
 * Chome 3 - 26
 * Firefox 3.5 - 19
 * Opera 10 - 12
 * 
 * browserling.com used for virtual testing environment
 *
 * Credit to B Cavalier & J Hann for the IE 6 - 9 method,
 * refined with help from Martin Cermak
 * 
 * Sources that helped along the way:
 * - https://developer.mozilla.org/en-US/docs/Browser_detection_using_the_user_agent
 * - http://www.phpied.com/when-is-a-stylesheet-really-loaded/
 * - https://github.com/cujojs/curl/blob/master/src/curl/plugin/css.js
 *
 */

define('lib/require.css',[],function() {
    if (typeof window == 'undefined')
        return { load: function(n, r, load){ load() } };

    var head = document.getElementsByTagName('head')[0];

    var engine = window.navigator.userAgent.match(/Trident\/([^ ;]*)|AppleWebKit\/([^ ;]*)|Opera\/([^ ;]*)|rv\:([^ ;]*)(.*?)Gecko\/([^ ;]*)|MSIE\s([^ ;]*)/) || 0;

    // use <style> @import load method (IE < 9, Firefox < 18)
    var useImportLoad = false;

    // set to false for explicit <link> load checking when onload doesn't work perfectly (webkit)
    var useOnload = true;

    // trident / msie
    if (engine[1] || engine[7])
        useImportLoad = parseInt(engine[1]) < 6 || parseInt(engine[7]) <= 9;
    // webkit
    else if (engine[2])
        useOnload = false;
    // gecko
    else if (engine[4])
        useImportLoad = parseInt(engine[4]) < 18;

    //main api object
    var cssAPI = {};

    cssAPI.pluginBuilder = './css-builder';

    // <style> @import load method
    var curStyle, curSheet;
    var createStyle = function () {
        curStyle = document.createElement('style');
        head.appendChild(curStyle);
        curSheet = curStyle.styleSheet || curStyle.sheet;
    }
    var ieCnt = 0;
    var ieLoads = [];
    var ieCurCallback;

    var createIeLoad = function(url) {
        ieCnt++;
        if (ieCnt == 32) {
            createStyle();
            ieCnt = 0;
        }
        curSheet.addImport(url);
        curStyle.onload = function(){ processIeLoad() };
    }
    var processIeLoad = function() {
        ieCurCallback();

        var nextLoad = ieLoads.shift();

        if (!nextLoad) {
            ieCurCallback = null;
            return;
        }

        ieCurCallback = nextLoad[1];
        createIeLoad(nextLoad[0]);
    }
    var importLoad = function(url, callback) {
        if (!curSheet || !curSheet.addImport)
            createStyle();

        if (curSheet && curSheet.addImport) {
            // old IE
            if (ieCurCallback) {
                ieLoads.push([url, callback]);
            }
            else {
                createIeLoad(url);
                ieCurCallback = callback;
            }
        }
        else {
            // old Firefox
            curStyle.textContent = '@import "' + url + '";';

            var loadInterval = setInterval(function() {
                try {
                    curStyle.sheet.cssRules;
                    clearInterval(loadInterval);
                    callback();
                } catch(e) {}
            }, 10);
        }
    }

    // <link> load method
    var linkLoad = function(url, callback) {
        var link = document.createElement('link');
        link.type = 'text/css';
        link.rel = 'stylesheet';
        if (useOnload)
            link.onload = function() {
                link.onload = function() {};
                // for style dimensions queries, a short delay can still be necessary
                setTimeout(callback, 7);
            }
        else
            var loadInterval = setInterval(function() {
                for (var i = 0; i < document.styleSheets.length; i++) {
                    var sheet = document.styleSheets[i];
                    if (sheet.href == link.href) {
                        clearInterval(loadInterval);
                        return callback();
                    }
                }
            }, 10);
        link.href = url;
        head.appendChild(link);
    }

    cssAPI.normalize = function(name, normalize) {
        if (name.substr(name.length - 4, 4) == '.css')
            name = name.substr(0, name.length - 4);

        return normalize(name);
    }

    cssAPI.load = function(cssId, req, load, config) {

        (useImportLoad ? importLoad : linkLoad)(req.toUrl(cssId + '.css'), load);

    }

    return cssAPI;
});

define('lib/require.css!app/css/widget',[],function(){});

define('lib/require.css!app/css/MagicSelectBox',[],function(){});
define('app/view_engine/widgets/engines/vertical/Engine',
    ['underscore', 'app/templates', 'app/settings', 'mgthumb', 'app/asset_mapper', 'app/config_manager', 'app/click_through', 'app/tracking', 'app/cookies', 'magicselect', 'app/album_switch', 'app/product_proxy', 'app/utils', 'app/cache_module', 'app/view_engine/widgets/common', 'app/thumbgen_wrapper', 'app/time_monitor', 'app/view_engine/widgets/engines/EngineVertical', 'css!./../../../../css/widget.css', 'css!./../../../../css/MagicSelectBox.css'],
    function(_, templates, settings, mgthumb, AssetMapper, config, clickThrough, tracking, cookies, magicselect, albumSwitch, productProxy, utils, cache, view_common, thumbGenWrapper, monitor, EngineVertical, css1, css2)
    {

        function VerticalViewEngine(params) {
            EngineVertical.call(this, params);

            this.LV_PROD_WIDTH           = 110;
            this.MAX_LV_PRODS            = 3;
            this.navDisabled             = false;
            this.PB_NUM_ALBUMS           = 3;
            this.PROD_NUM_ALBUMS         = 1;
            this.PRINTS_NUM_ALBUMS       = 1;
            this.CAL_NUM_ALBUMS          = 3;
            this.DISABLE_CLICK           = false;
            this.IS_WIDGET_OPEN          = {state:false};
            this.CURRENT_OPEN_PID        = null;
            this.COOKIE_STATE_NAME       = 'prodwidget.state';
            this.IS_VIEW_DISABLED        = {state: false};

            this.widgetWidth             = 0;
            this.widgetHeight            = 0;
            this.openWidgetWidth         = 0;
            this.horizontalGap           = 0;

            this.boundingBox             = null;

            this.init = function() {
                var widgetPosition      = config.getWidgetPosition();

                this.widgetWidth             = widgetPosition.width;
                this.widgetHeight            = widgetPosition.height;
                this.openWidgetWidth         = widgetPosition.openwidth;
                this.horizontalGap           = widgetPosition.horizontal;
            };

            // Get the widget state from the state cookie
            this.getWidgetState = function() {
                // if in homepage we have the Prospect load it as closed
                if(cache.get('prod_type') == "homepage" && $('.signupForm-wrapper').length > 0 && $('.signupForm-wrapper').is(':visible')){
                    return 'closed';
                }

                var cookie = cookies.getCookie(this.COOKIE_STATE_NAME);
                if (cookie != null) {
                    return cookie;
                } else {
                    return 'open';
                }
            };

            // Update the widget state cookie
            this.setWidgetState = function(state) {
                if (state != 'open' && state != 'closed') {
                    return;
                }

                cookies.setCookie(this.COOKIE_STATE_NAME, state, 6);
            };

            // Will return the next state of the button
            // Uses a simplified use of a state machine
            this.getOpenCloseSideButtonNextState = function(button, action) {
                var currState = $(button).attr('data-state');

                if (action == 'btn_clicked') {
                    switch (currState) {
                        case 'closed':
                            return 'open';
                        case 'open':
                            return 'full';
                        case 'full':
                            return 'open';
                        default:
                            return 'open';
                    }
                } else {
                    switch (currState) {
                        case 'closed':
                            return 'open';
                        case 'open':
                            return 'full';
                        case 'full':
                            return 'open';
                        default:
                            return 'open';
                    }
                }
            };

            /**
             * set or get the current opend pid
             * @param currentOpenPid
             * @returns {*}
             */
            this.handleCurrentPid = function(currentOpenPid){
                if(typeof currentOpenPid !== "undefined")
                {
                    this.CURRENT_OPEN_PID = currentOpenPid;
                }
                return this.CURRENT_OPEN_PID;
            };

            // Will animate the Close/Open button according the new state
            this.animateOpenCloseSideButton = function(button, targetState, callback) {
                var origRight = parseInt($(button).attr('orig-right'));

                function finishAnimation() {
                    if (!$(button).is(":visible")) {
                        $('.sfly-wgt-btn-sidemodule').fadeIn(200);
                    }

                    $(button).attr('data-state', targetState);
                    $(button).children('.sfly-wgt-arrow').attr('data-state', targetState);

                    if (_.isFunction(callback)) {
                        callback();
                    }
                }

                switch (targetState) {
                    case 'closed':
                        $(button).animate({ right: this.horizontalGap + 'px' }, 200, finishAnimation);
                        tracking.track('side', 'close_button');
                        break;
                    case 'open':
                        $(button).animate({ right: origRight + 'px' }, 200, finishAnimation);
                        tracking.track('side', 'open_button');

                        if (this.IS_VIEW_DISABLED.state) {
                            this.removeDisableOverlay($('#sfly_wgt_container'));
                            this.IS_VIEW_DISABLED.state = false;
                        }

                        break;
                    case 'full':
                        $(button).animate({ right: origRight + this.openWidgetWidth + 'px' }, 200, finishAnimation);
                        break;
                    default:
                        return;
                }

                this.setWidgetState(targetState);
            };

            this.animateOpenCloseSideButtonWrapper = function(button, currState) {
                var nextState = this.getOpenCloseSideButtonNextState(button, currState);
                this.animateOpenCloseSideButton(button, nextState);
            };

            // Disable / Enable navigation using Arrows
            this.disableNav = function() {
                this.navDisabled = true;
            };

            this.enableNav = function() {
                this.navDisabled = false;
            };

            this.isNavDisabled = function() {
                return this.navDisabled || this.isLocked();
            };

            this.overlayMessage = function(msgType) {
                // 1. overlay the view
                this.toggleViewDisable(this.IS_VIEW_DISABLED);
                // 2. display correct message

                var env = cache.get('env');
                env = env != 'prod' ? '.' + env : '';

                switch(msgType) {
                    case 'signin':
                        // $('#sfly_wgt_container').append(view_common.renderTemplate(templates.side_signin_msg, { env: env }));
                        break;
                    case 'upload':
                        $('#sfly_wgt_container').append(view_common.renderTemplate(templates.side_upload_msg, { env: env }));
                        break;
                }
            };

            this.showOverlayView = function(msgType) {
                // show overlay
                this.overlayMessage(msgType);

                // Stop and show only static assets
                var staticAsset;
                if (cache.get('prod_type') == 'photobook') {
                    staticAsset = $(view_common.renderTemplate(templates.side_static_books, { env: cache.get('env') }));
                } else if (cache.get('prod_type') == 'calendar') {

                    // staticAsset = $(view_common.renderTemplate(templates.side_static_cal, { env: cache.get('env') }));
                } else if (cache.get('prod_type') == 'cns') {
                    staticAsset = $(view_common.renderTemplate(templates.side_static_cns, { env: cache.get('env') }));
                } else {
                    staticAsset = $(view_common.renderTemplate(templates.side_static_prods, { env: cache.get('env') }));
                }

                var mainContainer = $('#sfly_wgt_container');
                if(cache.get('prod_type') === 'calendar') {
                    document.getElementById('sfly_wgt_container').setAttribute('style', "display:none !important");
                }
                var sideModuleBtn = $('.sfly-wgt-btn-sidemodule');
                mainContainer
                    .append(staticAsset)
                    .append(view_common.renderTemplate(templates.side_help_title)).css('width', '0px')
                    .show()
                    .find('.sfly_wgt_loading')
                    .remove();


                var closeButton = mainContainer.find('.sfly_wgt_side_widget_title .sfly-wgt-qst-mark');
                mainContainer.find('.sfly_wgt_side_widget_title').css('z-index', '1002');

                closeButton.on('click', function() {
                    $(mainContainer).animate({width: '0px'}, 200, function () {
                        $(this).hide().removeClass('sfly-wgt-side-open');
                        $('.sfy_wgt_messageBox').fadeOut(100);
                        that.animateOpenCloseSideButton(sideModuleBtn, 'closed');
                        utils.enableScroll();
                    });
                });

                // start without round button
                sideModuleBtn.hide();
                var that = this;

                $(sideModuleBtn).on('click', function() {
                    var self = this;
                    that.hideShowProductsWindow();
                    // This is to prevent removing the disabled overlay
                    that.IS_VIEW_DISABLED.state = false;
                    that.animateOpenCloseSideButton(this, 'open', function() {
                        $(self).hide();
                        that.IS_VIEW_DISABLED.state = true;
                    });
                });

                if (that.getWidgetState() != 'open') {
                    $(mainContainer).hide().removeClass('sfly-wgt-side-open').css('width', '0px');
                    that.animateOpenCloseSideButton(sideModuleBtn, 'closed');
                } else {
                    mainContainer.find('.sfly-wgt-overlay-message').css('left', '-161px');
                    mainContainer.animate({ 'width': this.widgetWidth+'px' }, 200, function() {
                        mainContainer.find('.sfly-wgt-overlay-message').animate({'left': '0px'}, 500);
                    });
                }
            };

            this.chooseFirstProductInSpread = function() {
                var currSpread          = $('.sfly_wgt_listview_spread_container .curr-spread');
                var spreadOrder         = $(currSpread).attr('data-order');
                var firstProductOrder   = spreadOrder * 3 + 1;

                if ($(currSpread).children('.order_' + firstProductOrder).length > 0) {
                    $(currSpread).children('.order_' + firstProductOrder)[0].click();
                }
            };

            // Will return the fix to top position according to the white space around products
            this.augmentProductPosition = function(sku, productJson, targetWidth) {
                var widgetCenter    = Math.floor(this.widgetWidth/2);
                var size            = view_common.getProductRealSize(productJson, sku);
                var ratio           = targetWidth / size.width;

                return widgetCenter - ((size.width) / 2 + size.left) * ratio;
            };

            // Will calculate the right position of each product in the given container
            this.calcElementsPosition = function(params) {
                var product,
                    size,
                    ratio;

                var products            = $(params.container).attr('data-pids').split(',');
                var contHeightFull      = $(params.containerElement).height();
                var contHeight          = contHeightFull - params.sidePadding*2;
                var numProds            = products.length > this.MAX_LV_PRODS ? this.MAX_LV_PRODS : products.length;

                // Rational: We have a bounding box with Max height and max width. Resize each product to fit in the box.
                // Then, position the top and bottom products to top and bottom and position the center one to create even padding
                // todo: The 50px padding is for testing. Make is calculated.
                var numberOfProd = 3; // We want all products be the same size on all pages. 3 is the number for now.
                var spaceBetweenProds = 50;
                if(typeof cache.getCoupon() !== "undefined"){
                    spaceBetweenProds = 60;
                }

                this.boundingBox = {
                    width: this.widgetWidth - 70,
                    height: ((contHeight - ( spaceBetweenProds * (numberOfProd - 1))) / numberOfProd)
                };

                var productSizes        = this.calTotalProductsHeightByBoundingBox(products, params.productJson, this.getBoundingBox.bind(this), params.prodSizes);
                var totalProdHeight     = productSizes.totalHeight;
                var pad                 = numProds > 1 ? ((contHeight - totalProdHeight) / (numProds - 1)) : 0;

                // The padding between product is bound by a max value
                pad                     = pad > params.maxSpaceBetweenProds ? params.maxSpaceBetweenProds : pad;

                var prodPos             = {};
                var heightCounter       = 0;
                var pCount              = 0;
                var computedSize        = 0;

                _.each(products, function(sku) {
                    size            = view_common.getProductRealSize(params.productJson, sku);
                    computedSize    = productSizes.sizes[sku];
                    // todo: get the size from the productSizes and don't compute again
                    ratio           = computedSize.ratio; //;targetWidth / size.width;

                    //console.log('>', pId, size, computedSize);

                    // Product position: Number of previous paddings + width of prev products - left empty part of the product
                    // Each product can have some empty padding parts. We don't want to count them.
                    prodPos[sku] = heightCounter + pCount*pad - (size.top * ratio);

                    pCount++;

                    heightCounter += computedSize.height;
                });

                // After we know the real space the products take - we can pad them.
                var totalProductsHeight = heightCounter + (pCount-1)*pad; // Don't count the last pad
                var sidePad             = (contHeightFull - totalProductsHeight)/2;

                // Move all products to create the side padding
                // We also have a price on the last product, so need to move up a little
                var priceFix = 15;
                _.each(products, function(sku) {
                    prodPos[sku] += sidePad - priceFix;
                });

                return {
                    positions: prodPos,
                    sizes: productSizes.sizes
                };
            };

            // Define this function if you want custom bounding box for specific product
            this.getBoundingBox = function(pId) {
                return this.boundingBox;
            };

            // Will navigate to the requested spread
            this.navigateSpreads = function(container, spreads, navTo, forceDirection, typeOfView) {
                var currSpread      = parseInt($(spreads).attr('data-curr-spread'));
                var totalSpreads    = parseInt($(spreads).attr('data-total-spreads'));
                var that            = this;

                // Helpers to animate the spread moving Left/Right
                function _finishAnimation() {
                    that.enableNav();
                    that.releaseLock();
                    if (that.IS_WIDGET_OPEN.state) {
                        that.chooseFirstProductInSpread();
                    }
                }

                function _moveLeft() {
                    spreads.children('.sfly_wgt_' + typeOfView + '_spread_' + currSpread).removeClass('curr-spread').animate({top: ((-1)*that.widgetHeight)+'px'}, 600);
                    spreads.children('.sfly_wgt_' + typeOfView + '_spread_' + navTo).addClass('curr-spread').css('top', that.widgetHeight+'px').animate({top: "0px"}, 600, _finishAnimation);
                }

                function _moveRight() {
                    spreads.children('.sfly_wgt_' + typeOfView + '_spread_' + currSpread).removeClass('curr-spread').animate({top: that.widgetHeight+'px'}, 600);
                    spreads.children('.sfly_wgt_' + typeOfView + '_spread_' + navTo).addClass('curr-spread').css('top', ((-1)*that.widgetHeight)+'px').animate({top: "0px"}, 600, _finishAnimation);
                }

                // When using arrows we always need to keep the same direction
                if (typeof forceDirection != 'undefined' && forceDirection == 'right') {
                    _moveLeft();
                } else
                if (typeof forceDirection != 'undefined' && forceDirection == 'left') {
                    _moveRight();
                } else {
                    if (navTo > currSpread) {
                        if (currSpread == 0 && navTo == totalSpreads) {
                            _moveRight();
                        } else {
                            _moveLeft();
                        }
                    } else if (navTo < currSpread) {
                        if (navTo == 0 && currSpread == totalSpreads) {
                            _moveLeft();
                        } else {
                            _moveRight();
                        }
                    }
                }

                //currSpread = navTo;
                $(spreads).attr('data-curr-spread', navTo);
                $(container).find('.sfly_wgt_' + typeOfView + '_paging_elem').removeClass('selected');
                $(container).find('.sfly_wgt_' + typeOfView + '_page_' + navTo).addClass('selected');
            };

            // Render and bind spreads paging navigation
            this.prepareSpreadPaging = function(container, spreadsContainer, typeOfView) {
                var numOfSpreads    = $(spreadsContainer).children('.sfly_wgt_' + typeOfView + '_spread').length;
                var spreadsNav      = view_common.renderTemplate(templates.listview_spread_nav, { numOfSpreads: numOfSpreads, typeOfView: typeOfView });
                var that            = this;

                $(container).append(spreadsNav);
                $(container).find('.sfly_wgt_' + typeOfView + '_page_0').addClass('selected');

                var elem_height          = $(container).children('.sfly_wgt_' + typeOfView + '_paging_wrapper').height();
                var container_height     = $(container).height();
                var loc                  = container_height/2 - elem_height/2;

                $(container).children('.sfly_wgt_' + typeOfView + '_paging_wrapper').css('top', loc+'px');

                $(container).find('.sfly_wgt_' + typeOfView + '_paging_elem').on('click', function() {
                    if (!that.isNavDisabled()) {
                        var targetPageId = $(this).attr('data-page');
                        that.disableNav();
                        that.navigateSpreads(container, spreadsContainer, targetPageId, undefined, typeOfView);
                    }
                });
            };

            // Creates the functionality of the spread navigation
            this.bindSpreadsNavigation = function(container, spreads, typeOfView) {
                var that = this;

                function _navTo(navTo, direction) {
                    if (!that.isNavDisabled()) {
                        that.disableNav();
                        that.takeLock();
                        that.navigateSpreads(container, spreads, parseInt(navTo), direction, typeOfView);
                    }
                }

                var totalSpreads    = parseInt($(spreads).attr('data-total-spreads'));

                if (totalSpreads > 0) {
                    // Arrow up click
                    spreads.children('.sfly-wgt-lv-arrow-up').on('click', function () {
                        var currSpread = parseInt($(spreads).attr('data-curr-spread'));
                        var move_to = currSpread == 0 ? totalSpreads : currSpread - 1;
                        _navTo(move_to, 'left');
                    });
                    // Arrow down click
                    spreads.children('.sfly-wgt-lv-arrow-down').on('click', function () {
                        var currSpread = parseInt($(spreads).attr('data-curr-spread'));
                        var move_to = currSpread == totalSpreads ? 0 : currSpread + 1;
                        _navTo(move_to, 'right');
                    });
                } else {
                    spreads.children('.sfly-wgt-lv-arrow-up').remove();
                    spreads.children('.sfly-wgt-lv-arrow-down').remove();
                }
            };

            // Will hide the main book window
            this.hideShowProductsWindow = function() {
                var that = this;
                var ctr = $('#sfly_wgt_container');
                if (that.takeLock()) {
                    if (ctr.hasClass('sfly-wgt-side-open')) {
                        $(ctr).animate({width: '0px'}, 200, function () {
                            $(this).hide().removeClass('sfly-wgt-side-open');
                            $('.sfy_wgt_messageBox').fadeOut(100);
                            that.releaseLock();
                        });
                    } else {
                        $(ctr).show().animate({width: this.widgetWidth + 'px'}, 200, function () {
                            $(this).addClass('sfly-wgt-side-open');
                            that.releaseLock();
                        });
                    }
                }
            }

            // Will render the ListView products in the given @containerElement
            this.renderView = function(containerElement, products, productJson, albums, prodStyles, prodSizes, prodOptions, modal) {
                var SIDE_PAD                    = 65;
                var SIDE_PAD_SMALL              = 50;
                var NUM_PRODUCTS_PER_SPREAD     = this.MAX_LV_PRODS;
                var MAX_SPACE_BETWEEN_PRODUCTS  = 80;
                var zoomLevel                   = 0.4;
                var that                        = this;

                /* === HELPER ==== */

                // Bind the click event on the OpenClose button.
                function bindOpenCloseSideButton(button) {
                    $(button).on('click', function() {
                        if (!that.isLocked()) {
                            var currState = $(button).attr('data-state');
                            var nextState = that.getOpenCloseSideButtonNextState(button, 'btn_clicked');

                            if (that.IS_VIEW_DISABLED.state) {
                                that.removeDisableOverlay($('#sfly_wgt_container'));
                                that.IS_VIEW_DISABLED.state = false;
                            }

                            if ((currState == 'closed' && nextState == 'open') || nextState == 'closed') {
                                that.hideShowProductsWindow();
                                that.animateOpenCloseSideButton(button, nextState);
                            } else if (currState == 'full' && nextState == 'open') {
                                var callbacks = {
                                    takeLock: that.takeLock.bind(that),
                                    releaseLock: that.releaseLock.bind(that),
                                    animateControlButton: that.animateOpenCloseSideButtonWrapper.bind(that),
                                    changeState: that.changeWidgetOpenState.bind(that, that.IS_WIDGET_OPEN),
                                    handleCurrentPid: that.handleCurrentPid.bind(that)
                                };
                                modal.close(true, that.IS_WIDGET_OPEN.state, callbacks);
                            } else if (currState == 'open' && nextState == 'full') {
                                // open the first product in the current spread
                                that.chooseFirstProductInSpread();
                            }
                        }
                    });
                }

                // Bind the click event to the info button in the widget
                function bindSideInfoButton(button) {
                    var sideModuleBtn = $('.sfly-wgt-btn-sidemodule');

                    $(button).on('click', function(e) {
                        // Close the side widget (if modal open, close as well)

                        function releaseCallback() {
                            that.hideShowProductsWindow();
                            that.animateOpenCloseSideButton(sideModuleBtn, 'closed');
                            that.releaseLock.bind(that)();
                        }

                        if (that.IS_WIDGET_OPEN.state) {
                            var callbacks = {
                                takeLock: that.takeLock.bind(that),
                                releaseLock: releaseCallback,
                                animateControlButton: that.animateOpenCloseSideButtonWrapper.bind(that),
                                changeState: that.changeWidgetOpenState.bind(that, that.IS_WIDGET_OPEN),
                                handleCurrentPid: that.handleCurrentPid.bind(that)
                            };
                            modal.close(true, that.IS_WIDGET_OPEN.state, callbacks);
                        } else {
                            that.hideShowProductsWindow();
                            that.animateOpenCloseSideButton(sideModuleBtn, 'closed');
                        }
                    });
                }

                // this will return order in spread by the product type
                function getItemOrderInSpread(item) {
                    var itemSpread  = $(item).attr('data-spread-order');
                    var itemType    = $(item).attr('data-ptype');
                    var itemOrder   = $(item).attr('data-order');
                    var allSpreadItems;

                    if (
                        itemType    == 'calendar'
                        || itemType == 'deskcalendar'
                        || itemType == 'prints'
                        || itemType == 'book'
                    ) {
                        allSpreadItems = $(containerElement).find('div.sfly_wgt_product[data-spread-order="' + itemSpread + '"][data-ptype="' + itemType + '"]');
                    } else { // Products
                        allSpreadItems = $(containerElement).find('div.sfly_wgt_product[data-spread-order="' + itemSpread + '"][data-ptype!="calendar"][data-ptype!="deskcalendar"][data-ptype!="prints"][data-ptype!="book"]');
                    }

                    // find position of the item in the right items
                    var sortedItems = _.sortBy(allSpreadItems, function(sItem) {
                        return parseInt($(sItem).attr('data-order'));
                    });

                    // find position of the item in spread
                    var pos = 0;
                    var foundPos = -1;
                    _.each(sortedItems, function(sItem) {
                        if ($(sItem).attr('data-order') == itemOrder) {
                            foundPos = pos;
                        }
                        pos++;
                    });

                    return foundPos;
                }

                function renderThumb(pId, productType, partnerId, product, layoutJson, designJson, layoutMasks, count, promiseOnFinish) {
                    var useCDN = cache.get('env') != 'beta' && cache.get('env') != 'dev';
                    var mgThumbGen  = new MgThumbGenerator(cache.get('env'),useCDN);

                    mgThumbGen.init(productType, partnerId, product, layoutJson, designJson, that.Model.get('monitoring').reportEvent, cache.get('env'));

                    var j = count;

                    that.Model.get('monitoring').eventStart('sideWidget:Generate:' + config.parseProductId(config.getProductBySku(pId)));
                    mgThumbGen.generate(parseInt(0), pId, true, function(canvas) {
                        that.Model.get('monitoring').eventEnd('sideWidget:Generate:' + config.parseProductId(config.getProductBySku(pId)));
                        var elem = $(view_common.renderTemplate(templates.fullview_product, { pid: pId, sku: view_common.getProduct(pId)['sflySku'], ptype: productType }));
                        $(canvas).attr('data-order', 0);
                        elem
                            .addClass('order_' + j)
                            .attr('data-order', j)
                            .children('.sfly_wgt_product_inner')
                            .html(canvas)
                            .addClass('order_' + j);

                        $(containerElement).find('.sfly_wgt_item_placeholder.p_' + pId).css('visibility', 'hidden');
                        var spread = $(containerElement).find('.sfly_wgt_listview_spread.p_' + pId);
                        elem.attr('data-spread-order', $(spread).attr('data-order'));
                        spread.append(elem);

                        promiseOnFinish.resolve();

                        // Remove the placeholder
                        // view_common.updateProductSize(elem, commonWidth, pId, productJson, prodPosAndSize.sizes);
                        var priceTop = that.updateProductPrice({
                            widgetType: 'vertical',
                            container: elem,
                            productJson: productJson,
                            pId: pId,
                            targetSize: prodPosAndSize.sizes[pId],
                            prodOptions: prodOptions,
                            coupon: typeof cache.getCoupon() !== "undefined" ? cache.getCoupon().name : false,
                        });

                        var size = view_common.getProductRealSize(productJson, pId);

                        fixProductSize(elem, priceTop, size, 180, 180, 0.8, 1, {heightFix: 30});



                        // var leftPos     = that.augmentProductPosition(pId, productJson, prodPosAndSize.sizes[pId].width);
                        //
                        // // Set position
                        // // We want to shift all products down
                        // // var shiftDown = (productType == 'travelmug') ? 10 : 8;
                        // // elem.css('position',    'absolute')
                        // //     .css('left', leftPos+'px')
                        // //     .css('top', prodPos[pId]+shiftDown+'px')
                        // //     .attr('data-left',  10)
                        // //     .attr('data-top',   prodPos[pId]+shiftDown)
                        // //     .attr('data-subleft', leftPos)
                        // //     .attr('data-subtop', leftPos);
                        // elem.children('.sfly_wgt_product_inner').attr('data-pricetop', priceTop);
                        //
                        // // Calculate target position and size of the product
                        // var pTargetSize = elem.width()*(1+zoomLevel);
                        //
                        // // Sometimes, in ThisLife, the widget will get a bad size - we want to mark it
                        // if (pTargetSize == 0) {
                        //     $(containerElement).parent().attr('data-renderfor', 0);
                        // }

                        // If all products in place, we can show them
                        renderedCount++;
                        if (renderedCount == products.length) {
                            $(containerElement).find('.sfly_wgt_loading').remove();

                            if(cache.get('token') != ""){
                                productProxy.getMGSources(null, true);
                            }
                            productProxy.getCoupon();
                            cache.set('full_load', true);

                            //$(containerElement).find('.sfly_wgt_listview_spread_container').show();
                        }

                        elem
                            .on('click', function() {
                                if (!that.isLocked()) {
                                    that.takeLock();

                                    var currItemOrder   = getItemOrderInSpread(this);//$(this).attr('data-order') - 1; // order is "1" based, albums is "0" based
                                    var product         = view_common.getProduct(pId);
                                    var currAlbums;
                                    if (product.type == 'prints') {
                                        currAlbums = albums.prints;
                                    } else if (product.type == 'photobook') {
                                        currAlbums = albums.photobook;
                                    } else if (product.type == 'calendar' || product.type == 'deskcalendar') {
                                        currAlbums = albums.calendars;
                                    } else {
                                        currAlbums = albums.products;
                                    }
                                    // If several product types, we want order from the same type only
                                    var currAlbum  = currAlbums[currItemOrder % currAlbums.length];

                                    // Add Opacity to other products
                                    $('.sfly_wgt_product').addClass('not-selected');
                                    that.removeHoverStates(containerElement);

                                    if (!that.IS_WIDGET_OPEN.state) {
                                        view_common.showLoading($('#sfly_wgt_container'));
                                    }

                                    // tracking.track('side', 'click', { sku: $(this).attr('data-sku'), order: currItemOrder });
                                    tracking.track('side', 'hover', { sku: $(this).attr('data-sku'), order: currItemOrder });

                                    var callbacks = {
                                        takeLock: that.takeLock.bind(that),
                                        releaseLock: that.releaseLock.bind(that),
                                        animateControlButton: that.animateOpenCloseSideButtonWrapper.bind(that),
                                        changeState: that.changeWidgetOpenState.bind(that, that.IS_WIDGET_OPEN),
                                        handleCurrentPid: that.handleCurrentPid.bind(that),
                                        toggleViewDisable: that.toggleViewDisable.bind(that, that.IS_VIEW_DISABLED)
                                    };

                                    modal.show({
                                        pId: $(this).attr('data-pid'),
                                        currPid: that.CURRENT_OPEN_PID,
                                        currAlbum: currAlbum,
                                        albums: currAlbums,
                                        prodStyles: prodStyles,
                                        prodOptions: prodOptions,
                                        forceCloseExternal: false,
                                        widgetIsOpen: that.IS_WIDGET_OPEN.state,
                                        callbacks: callbacks,
                                        model: that.Model
                                    });
                                }
                            })
                            .on('mouseenter', function() {
                                // Check that a product is not selected
                                if (!that.IS_WIDGET_OPEN.state) {
                                    $(this).parent().children().addClass('on-hover-other');
                                    $(this).removeClass('on-hover-other').addClass('on-hover');
                                }
                            });
                    }, true, { masks: layoutMasks, textEnabled:(productType !== "book") });
                }

                /* === END HELPER ==== */

                var commonWidth         = this.LV_PROD_WIDTH;
                var spreadResult        = that.prepareSpreads(products, 'listview', NUM_PRODUCTS_PER_SPREAD, 'vertical');
                var spreads             = spreadResult.spreads;
                var side_padding        = spreads.children('.sfly_wgt_listview_spread').length > 1 ? SIDE_PAD : SIDE_PAD_SMALL;
                var prodPosAndSize      = this.findPositionProductsInSpreads({
                    container: containerElement,
                    spreads: spreads,
                    productJson: productJson,
                    targetWidth: commonWidth,
                    typeOfView: 'listview',
                    maxSpaceBetweenProds: MAX_SPACE_BETWEEN_PRODUCTS,
                    sidePadding: side_padding,
                    prodSizeZoomLevels: prodSizes,
                    calcElemPositionFunc: this.calcElementsPosition.bind(this)
                });
                var prodPos             = prodPosAndSize.positions;

                $(containerElement)
                    .append(spreads)
                    .parent()
                    .attr('data-renderfor', $(containerElement).width());

                var closeButton = $(containerElement).find('.sfly_wgt_side_widget_title .sfly-wgt-qst-mark');
                bindSideInfoButton(closeButton);
                this.updateCssForSpreads(containerElement, 'listview', 'vertical', this.widgetHeight);
                this.prepareSpreadPaging(containerElement, spreads, 'listview');
                this.bindSpreadsNavigation(containerElement, spreads, 'listview');
                bindOpenCloseSideButton($('.sfly-wgt-btn-sidemodule'));


                if (this.getWidgetState() != 'open') {
                    // close the widget gracefully. Can this be done better? Cleaner?
                    $('.sfly-wgt-btn-sidemodule')
                        .css('right', this.horizontalGap + 'px')
                        .attr('data-state', 'closed')
                        .children('.sfly-wgt-arrow').attr('data-state', 'closed');
                    $('#sfly_wgt_container').css('width', '0px').hide().removeClass('sfly-wgt-side-open');
                }

                var count = 1;
                var renderedCount = 1;
                var pricePromises = [];

                _.each(products, function(pId) {
                    var product     = view_common.findProjectJsonProduct(productJson, pId);
                    var productType = AssetMapper.GetProductType(product);
                    var partnerId   = AssetMapper.GetPartnerId(product, productType);
                    var origProduct = view_common.getProduct(pId);

                    var prodSku     = productType != 'book' ? origProduct['sku'] : origProduct['style'] + '_' + origProduct['size'];

                    var j = count;
                    var deferred = $.Deferred();
                    pricePromises.push(deferred);

                    // Prints will still be using the embedded JSONs. Also anything that is not supported now.
                    if (productType == 'prints') {
                        var layoutJson  = JSON.stringify(config.getRecipeLayout()[partnerId]);
                        var designJson  = JSON.stringify(config.getRecipeDesign()[partnerId]);

                        renderThumb(pId, productType, partnerId, product, layoutJson, designJson, null, j, deferred);
                    } else {
                        that.Model.get('monitoring').eventStart('sideWidget:prepareThumbGenAssets:' + prodSku);
                        thumbGenWrapper.prepareThumbGenAssets(prodSku, pId, 'medium', productType, product, function (result)
                        {
                            that.Model.get('monitoring').eventEnd('sideWidget:prepareThumbGenAssets:' + prodSku);
                            //deferred.resolve();
                            if (result == null || typeof result.layoutJson === 'undefined' || typeof result.designJson === 'undefined') {
                                console.log('[Product Widget] Missing layout / design json');
                                return;
                            }

                            var layoutJson;
                            if (productType == 'book') {
                                layoutJson = JSON.stringify(result.layoutJson[pId]);
                            } else {
                                layoutJson = JSON.stringify(result.layoutJson);
                            }

                            designJson = JSON.stringify(result.designJson);

                            renderThumb(pId, productType, partnerId, product, layoutJson, designJson, result.layoutMasks, j, deferred);
                        });
                    }

                    count++;

                }, this);

                $.when.apply(undefined, pricePromises).then(function() {
                    that.Model.get('monitoring').eventEnd('sideWidget:Start');
                    productProxy.loadPrices();
                });

                // coupon fix arrow down
                if(typeof cache.getCoupon() !== "undefined"){
                    spreads.children('.sfly-wgt-lv-arrow-down').css("bottom","1px");
                }
            }
        }

        utils.inheritPrototype(VerticalViewEngine, EngineVertical);

        VerticalViewEngine.prototype.render = function(params) {
            this.init();

            var source          = params.source;
            var prodStyles      = params.prodStyles;
            var prodSizes       = params.prodSizes;
            var prodOptions     = params.prodOptions;
            var showMessage     = params.showMessage;
            var numOfProducts   = params.numOfProducts;
            var modal_view      = params.modalView;
            var ctr             = this.Model.get('container');
            var isManual        = false;
            var that            = this;

            that.Model.get('monitoring').eventStart('sideWidget:Start');

            // Animate the appearance of the temp boxes
            var boxes = $(ctr).find('.sfly_wgt_item_placeholder');
            var itr = 0;
            _.each(boxes, function(box) {
                setTimeout(function() {
                    $(box).css('display', 'block');
                }, itr*300);
                itr++;
            });

            if (typeof showMessage !== 'undefined' && showMessage != null) {
                this.showOverlayView(showMessage);
                return;
            }

            var productJson = [];
            function _getProductJson(pJson) {
                if (pJson != null) {
                    productJson = productJson.concat(pJson);
                }
            }

            // Check what kind of products is this and ask for MG Source accordingly
            var getPrints   = 0;
            var getProducts = 0;
            var getBooks    = 0;
            var getCalendar = 0;
            var that        = this;

            _.each(source, function(sku) {
                //var product = view_common.getProduct(pId);
                var product = view_common.getProduct(sku);

                switch(product.type) {
                    case 'prints':
                        getPrints = that.PRINTS_NUM_ALBUMS;
                        break;
                    case 'photobook':
                        getBooks = that.PB_NUM_ALBUMS;
                        break;
                    case 'calendar':
                    case 'deskcalendar':
                        getCalendar = that.CAL_NUM_ALBUMS;
                        break;
                    default:
                        getProducts = that.PROD_NUM_ALBUMS;
                        break;
                }
            });


            // we have a 2 step process for displaying the widget
            // 1. Get the photos and albums for the user
            // 2. Get the covers for the albums
            that.Model.get('monitoring').eventStart('sideWidget:getMgSource');
            productProxy.getMGSources(function(albums) {
                that.Model.get('monitoring').eventEnd('sideWidget:getMgSource');
                if (albums != null) {
                    if (albums.length == 0) {
                        // Not enough sources. Show overlay and exit.
                        that.showOverlayView('upload');
                        return;
                    }

                    var albumsPhotobook = albums.photobooks || [];
                    var albumsProducts  = albums.products || [];
                    var albumsPrints    = albums.prints || [];
                    var albumsCalendars = albums.calendars || [];
                    var allAlbums = {
                        'photobook': albumsPhotobook,
                        'products': albumsProducts,
                        'prints': albumsPrints,
                        'calendars': albumsCalendars
                    };

                    // Check if we have enough products to create using the albums we got.
                    var cleanSource = that.cleanSourceWithAlbums(source, allAlbums, numOfProducts);

                    // if less than 3 products do not show the widget
                    if (cleanSource.length < 3) {
                        console.log('[Product Widget]> Not enough resources for render. Aborting.');
                        that.showOverlayView('upload');
                        return;
                    }

                    that.Model.get('monitoring').eventStart('sideWidget:getRankService');
                    $.when(
                        productProxy.getPhotobook(albumsPhotobook, 40, _getProductJson, true, isManual, cleanSource),
                        productProxy.getProducts(albumsProducts, _getProductJson, isManual, cleanSource, true),
                        productProxy.getPrints(albumsPrints, _getProductJson, isManual, cleanSource),
                        productProxy.getCalendar(albumsCalendars, _getProductJson, isManual, cleanSource)
                    )
                        .then(function() {
                            that.Model.get('monitoring').eventEnd('sideWidget:getRankService');
                            // Show the loading window
                            $('.sfly-wgt-btn-sidemodule').fadeIn(200);
                            $('#sfly_wgt_container').fadeIn(200);

                            // Do tracking for loading
                            tracking.track('side', 'on_load');

                            that.renderView($(ctr).find('.sfly_wgt_listview_container'), cleanSource, productJson, allAlbums, prodStyles, prodSizes, prodOptions, modal_view);
                        })
                        .fail(function() {
                            console.log('[Product Widget]> Failed loading resources. Aborting.');
                            that.failWidgetStandalone();
                        });
                } else {
                    console.log('[Product Widget]> Failed loading resources. Aborting.');
                    that.failWidgetStandalone();
                }
            });
        };

        return VerticalViewEngine;
    });


function fixProductSize(elem, priceTop, pSize, width, height, prc, zoomLevel, params){

    var zoom = zoomLevel || 1;
    var productInner = elem.children('.sfly_wgt_product_inner');
    var priceElem = elem.children('.sfly_wgt_product_price');
    var hoverElem = elem.find(".sfly_wgt_product_hover");
    productInner.attr('data-pricetop', priceTop);
    var heightFix = (typeof params !== 'undefined' && params.hasOwnProperty('heightFix') ? params['heightFix'] : 0);

    // Center the thumbnail inside the cell
    var containerWidth = width||180;
    var containerHeight =  height||180;
    var requiredPrc = prc||0.8;

    //the required width and height of product itself without margins:
    var maxWidth  = containerWidth * requiredPrc;
    var maxHeight = containerHeight * requiredPrc - heightFix;

    var containerMarginLeft = ( containerWidth  - maxWidth  ) / 2;
    var containerMarginTop  = ( containerHeight - maxHeight ) / 2;

    //ratio of required size from sku size
    var widthRatio  = maxWidth  / (pSize.origWidth  - pSize.left - pSize.right );
    var heightRatio = maxHeight / (pSize.height     - pSize.top  - pSize.bottom);

    var ratio = Math.min(widthRatio,heightRatio);
    //this ratio will be used to turn every sku size to display size


    var newImgWidth = pSize.origWidth*ratio;
    var newImgHeight = pSize.height*ratio;

    var newProductWidth = (pSize.origWidth - pSize.left - pSize.right)*ratio;
    var newProductHeight = (pSize.height - pSize.top - pSize.bottom)*ratio;

    //calculate extra margin required to center the product
    var productMarginLeft = ( maxWidth  - newProductWidth  ) / 2;
    var productMarginTop  = ( maxHeight - newProductHeight ) / 2;

    var marginLeft =  (containerMarginLeft + (productMarginLeft - pSize.left * ratio)) + 'px';
    var marginTop  =  (containerMarginTop + (productMarginTop - pSize.top  * ratio)) + 'px';

    var theCanvas = productInner.find('canvas');
    theCanvas.css('left', marginLeft);
    theCanvas.css('top', marginTop);
    theCanvas.css('max-width', newImgWidth + 'px');
    theCanvas.css('max-height', newImgHeight + 'px');
    theCanvas.css('transform', 'scale('+zoom + ')');
    theCanvas.css('width', 'auto');
    theCanvas.css('height', 'auto');

}
;
define('app/view_engine/widgets/engines/EngineHorizontal', ['underscore', 'app/view_engine/widgets/engines/EngineBase', 'app/utils', 'app/templates', 'app/view_engine/widgets/common', 'app/settings'], function(_, EngineBase, utils, templates, view_common, settings) {
    function EngineHorizontal(params) {
        EngineBase.call(this, params);
    }

    utils.inheritPrototype(EngineHorizontal, EngineBase);

    EngineHorizontal.prototype.horizontalCalcElementsPosition = function(params) {
        var size,
            ratio,
            that = this;

        var products            = $(params.container).attr('data-pids').split(',');
        var productSizes        = this.calcTotalProductsSizeByTargetHeight(products, params.productJson, params.prodHeight, params.prodSizes);
        var pad                 = params.maxSpaceBetweenProds;

        // The padding between product is bound by a max value
        //pad                     = pad > maxSpaceBetweenProds ? maxSpaceBetweenProds : pad;

        var prodPos             = {};
        var widthCounter        = 0;
        var pCount              = 1;

        _.each(products, function(pId) {
            size            = view_common.getProductRealSize(params.productJson, pId);
            ratio           = params.targetHeight / size.realHeight;

            // Product position: Number of previous paddings + width of prev products - left empty part of the product
            // Each product can have some empty padding parts. We don't want to count them.
            prodPos[pId] = pCount*pad + widthCounter - (size.left * ratio);

            pCount++;

            widthCounter += size.width * ratio;
        });

        return {
            positions: prodPos,
            sizes: productSizes.sizes,
            totalWidth: widthCounter + pCount*pad
        };
    };

    EngineHorizontal.prototype.getScrollerArrows = function(containerElement) {
        var spreadToMove = $(containerElement).find('.sfly_wgt_spread_mg');
        var scrollerArrows = {
            left: $(containerElement).find('.sfly_wgt_listview_scroll_left_arrow'),
            right: $(containerElement).find('.sfly_wgt_listview_scroll_right_arrow'),
            scroll: $(containerElement).width()/4 - 50,
            disabledClass: 'sfly_wgt_arrow_disabled'
        };
        return {spreadToMove: spreadToMove, scrollerArrows: scrollerArrows};
    };

    EngineHorizontal.prototype.thumbRenderPlaceElement = function(containerElement, canvas, pId, productType, page, order) {
        view_common.removeLoading(this.Model.get('container'));
        var elem = $(view_common.renderTemplate(templates.fullview_product, { pid: pId, sku: view_common.getProduct(pId)['sflySku'], ptype: productType }));
        $(canvas).attr('data-order', page);
        elem
            .addClass('order_' + order)
            .attr('data-order', order)
            .children('.sfly_wgt_product_inner')
            .html(canvas)
            .addClass('order_' + order);

        $(containerElement).find('.sfly_wgt_item_placeholder.p_' + pId).css('visibility', 'hidden');
        var spread = $(containerElement).find('.sfly_wgt_listview_spread.p_' + pId);
        elem.attr('data-spread-order', $(spread).attr('data-order'));
        if(spread.find('.sfly_wgt_product.order_' + order).length > 0){
            spread.find('.sfly_wgt_product.order_' + order).replaceWith(elem);
        } else {
            spread.append(elem);
        }

        return elem;
    };

    EngineHorizontal.prototype.horizontalItemMouseEnter = function(context, isWidgetOpen, priceElem, productInner, hoverElem) {
        var ZOOM_LEVEL = 1.05;

        if (!isWidgetOpen) {
            $(context).parent().children().addClass('on-hover-other');
            $(context).removeClass('on-hover-other').addClass('on-hover');
        }

        // enlarge the element
        var targetWidth = productInner.attr('data-width') * ZOOM_LEVEL;
        var targetHeight = productInner.attr('data-height') * ZOOM_LEVEL;
        var moveLeft = (targetWidth - productInner.attr('data-width')) / 2;
        var moveTop = (targetHeight - productInner.attr('data-height')) / 2;
        productInner.animate({
            width: targetWidth + 'px',
            height: targetHeight + 'px'
        }, 100);

        $(context).animate({
                left: ($(context).attr('data-left') - moveLeft) + 'px',
                top: ($(context).attr('data-top') - moveTop) + 'px'
            },
            {
                duration: 100,
                complete: function () {
                    hoverElem.show();
                }
            }
        );

        priceElem.animate({
            left: (parseFloat(priceElem.attr('data-price-center')) + parseFloat(moveLeft)) + 'px',
            top: priceElem.attr('data-price-top-zoomin') + 'px'
        }, 100);
    };

    EngineHorizontal.prototype.horizontalItemMouseOut = function(context, productInner, hoverElem, priceElem) {
        hoverElem.hide();

        productInner.animate({
            width: productInner.attr('data-width') + 'px',
            height: productInner.attr('data-height') + 'px'
        }, 100);

        $(context).animate({
            left: $(context).attr('data-left') + 'px',
            top: $(context).attr('data-top') + 'px'
        }, {
            duration: 100, complete: function () {
                hoverElem.hide();
            }
        });

        priceElem.animate({
            left: priceElem.attr('data-price-center') + 'px',
            top: priceElem.attr('data-top') + 'px'
        }, 100);
    };

    EngineHorizontal.prototype.calcTotalProductsSizeByTargetHeight = function(products, productJson, targetHeight, prodSizes) {
        var size,
            ratio,
            zoomLevel,
            totalHeight = 0,
            totalWidth = 0;

        var sizes = {};

        _.each(products, function(pId) {
            size        = view_common.getProductRealSize(productJson, pId);
            zoomLevel   = typeof prodSizes[pId] !== 'undefined' ? prodSizes[pId] : 1;

            ratio = zoomLevel * (targetHeight / size.realHeight);

            sizes[pId] = {
                width:  size.width * ratio,
                height: size.realHeight * ratio,
                ratio:  ratio
            };

            totalHeight += size.realHeight * ratio;
            totalWidth  += size.width * ratio;
        });

        return {
            totalHeight: Math.floor(totalHeight),
            totalWidth: Math.floor(totalWidth),
            sizes: sizes
        };
    };

    EngineHorizontal.prototype.extractUserNameData = function() {
        if (typeof ThisLife !== "undefined" && ThisLife.hasOwnProperty('Model') && ThisLife.Model.hasOwnProperty('User')) {
            var firstName = ThisLife.Model.User.get('first_name');
            var lastName = ThisLife.Model.User.get('last_name');

            if (firstName && lastName) {
                window.MagicShop.AddressLabel = { first : firstName, last : lastName };
            }
        }
    };

    EngineHorizontal.prototype.updateModalMenuSelection = function(menuContainer, pId) {
        var selectedProduct = $(menuContainer).find('li[data-sku="' + pId + '"]');
        var modalContainer = this.Model.get('modalcontainer');

        // remove the class from any other product
        $(modalContainer).find('li.sfly-wgt-left-pane-category-product').removeClass('sfly-wgt-left-pane-category-product-selected');
        selectedProduct.addClass('sfly-wgt-left-pane-category-product-selected');

        $(modalContainer).find('li.modal_category_btn').removeClass('selected-category');
        var selectedCategory = selectedProduct.closest('li.modal_category_btn');
        selectedCategory.addClass('selected-category');

        this.Model.get('callback')({action: 'update_modal_menu', category: selectedCategory.attr('data-cat'), pId: pId});

        // if we are on mobile in photos
        if ($('html').hasClass('mobile')) {
            //$(modalContainer).find('li.modal_category_btn.selected-category').trigger('mouseleave');
            $(modalContainer).find('li.modal_category_btn.selected-category').removeClass('hover-active');
            $(modalContainer).find('ul.modal_category_list').removeClass('hide-selected');

            // perform 'hover' on touch actions
            $(modalContainer).find('li.modal_category_btn.selected-category').on('touchstart', function(e) {
                $(modalContainer).find('.modal_category_btn').removeClass('hover-active');
                if (!$(this).hasClass('hover-active')) {
                    $(this).addClass('hover-active');
                }
            });
            //$(modalContainer).find('div.magicshop_modal_right_section #sfly_wgt_sideopen_products_header').click();
        }
    };

    return EngineHorizontal;
});
define('app/view_engine/widgets/engines/horizontal/Engine',
    ['underscore', 'app/templates',  'mgthumb', 'app/asset_mapper', 'app/config_manager', 'app/click_through', 'app/tracking', 'app/cookies', 'magicselect', 'app/album_switch', 'app/product_proxy', 'app/utils', 'app/cache_module', 'app/scroller', 'app/view_engine/widgets/common', 'app/thumbgen_wrapper', 'app/time_monitor', 'app/view_engine/modals/shared', 'app/view_engine/widgets/engines/EngineHorizontal', 'css!./../../../../css/widget.css', 'css!./../../../../css/MagicSelectBox.css'],

    function(_, templates, mgthumb, AssetMapper, config, clickThrough, tracking, cookies, magicselect, albumSwitch, productProxy, utils, cache, scroller, view_common, thumbGenWrapper, monitor, modal_common, EngineHorizontal, css1, css2)
    {
        function HorizontalViewEngine(params)
        {
            EngineHorizontal.call(this, params);

            this.LV_PROD_WIDTH = 110;
            this.LV_PROD_HEIGHT = 135;
            this.PB_NUM_ALBUMS = 2;
            this.PROD_NUM_ALBUMS = 2;
            this.PRINTS_NUM_ALBUMS = 2;
            this.CAL_NUM_ALBUMS = 2;
            this.DISABLE_CLICK = false;
            this.IS_WIDGET_OPEN = {state: false};
            this.CURRENT_OPEN_PID = null;
            this.IS_VIEW_DISABLED = {state: false};
            this.ZOOM_LEVEL = 1.05;
            this.SCROLLER = null;
            this.isAfterUPP = false;
            this.isThisLifeGeneral = false;
            this.mixedSourcesGeneral = false;
            this.upload_photos = false; //Flag if the user doesn't have enough photos

            /**
             * set or get the current opend pid
             * @param currentOpenPid
             * @returns {*}
             */
            this.handleCurrentPid = function (currentOpenPid)
            {
                if (typeof currentOpenPid !== "undefined") {
                    this.CURRENT_OPEN_PID = currentOpenPid;
                }
                return this.CURRENT_OPEN_PID;
            };

            // Will render the ListView products in the given @containerElement
            this.renderView = function (containerElement, products, productJson, albums, prodStyles, prodSizes, prodOptions, modal)
            {
                var SIDE_PAD                    = 65;
                var SIDE_PAD_SMALL              = 50;
                var MAX_SPACE_BETWEEN_PRODUCTS  = 80;
                var SPACE_FROM_TOP              = 80;
                var NUM_OF_PRODUCT_TO_SHOW      = 5;
                var that                        = this;

                this.preloadedAll = false;
                this.productJson = productJson;
                this.products = products;

                if (cache.get('prod_type') === "homepage") {
                    $(containerElement.prevObject).css("overflow", "hidden").css("width", "100%");
                    NUM_OF_PRODUCT_TO_SHOW = Math.ceil(window.innerWidth / 250);
                    if (NUM_OF_PRODUCT_TO_SHOW > products.length) {
                        NUM_OF_PRODUCT_TO_SHOW = products.length;
                    }
                }
                /* === HELPER ==== */
                // should be request to banner service
                function getBanner() {
                    var date = new Date();
                    var day = date.getDate();
                    var month = date.getMonth() + 1; // months are between 0 and 11
                    var year = date.getFullYear();

                    if ((day >= 27 && day <= 29) && month === 5 && year === 2018) {
                        var printTemplate = $(templates.fullview_prints_banner);
                        printTemplate.addClass('horizontal_magic');
                        return printTemplate;
                    }
                    return '';
                }


                function renderThumb(pId, productType, partnerId, product, layoutJson, designJson, position, productGenerateCallBack, layoutMasks, promiseToResolve)
                {
                    var useCDN = cache.get('env') != 'beta' && cache.get('env') != 'dev';
                    var mgThumbGen  = new MgThumbGenerator(cache.get('env'),useCDN);

                    mgThumbGen.init(productType, partnerId, product, layoutJson, designJson, that.Model.get('monitoring').reportEvent, cache.get('env'));

                    var j = position;

                    that.Model.get('monitoring').eventStart('mgv3:Generate:' + pId);
                    mgThumbGen.generate(parseInt(0), pId, true, function (canvas)
                    {
                        that.Model.get('monitoring').eventEnd('mgv3:Generate:' + pId);
                        var elem = that.thumbRenderPlaceElement(containerElement, canvas, pId, productType, 0, j);
                        view_common.updateProductSize(elem, commonWidth, pId, productJson, prodPosAndSize.sizes);
                        var pSize = view_common.getProductRealSize(productJson, pId);
                        var priceTop = that.updateProductPrice({
                            widgetType: 'horizontal',
                            container: elem,
                            productJson: productJson,
                            pId: pId,
                            targetSize: prodPosAndSize.sizes[pId],
                            prodOptions: prodOptions,
                            coupon: typeof cache.getCoupon() !== "undefined" ? cache.getCoupon().name : false
                        });
                        var topPos = SPACE_FROM_TOP - pSize.top * prodPosAndSize.sizes[pId].ratio;

                        // Set position
                        // We want to shift all products down
                        elem.css('position', 'absolute')
                            .css('top', topPos + 'px')
                            .css('left', prodPos[pId] + 'px')
                            .css('height', (300 - topPos - 30) + "px")
                            .attr('data-top', topPos)
                            .attr('data-left', prodPos[pId])
                            .attr('data-subleft', topPos)
                            .attr('data-subtop', topPos);
                        var productInner = elem.children('.sfly_wgt_product_inner');
                        var priceElem = elem.children('.sfly_wgt_product_price');
                        var hoverElem = elem.find(".sfly_wgt_product_hover");
                        productInner.attr('data-pricetop', priceTop);

                        // Calculate target position and size of the product
                        var pTargetSize = elem.width() * that.ZOOM_LEVEL;

                        if (pId === "prints_4x6") {
                            var banner = getBanner();
                            if  (banner) {
                                elem.append(banner);
                            }
                        }

                        // Sometimes, in ThisLife, the widget will get a bad size - we want to mark it
                        if (pTargetSize == 0) {
                            $(containerElement).parent().attr('data-renderfor', 0);
                        }

                        if (typeof promiseToResolve !== 'undefined') {
                            promiseToResolve.resolve();
                        }

                        elem
                            .on('click', function ()
                            {
                                if (!that.isLocked()) {
                                    that.takeLock();

                                    var currItemOrder = $(this).attr('data-order') - 1; // order is "1" based, albums is "0" based
                                    var product = view_common.getProduct(pId);
                                    var currAlbums;
                                    if (product.type == 'prints') {
                                        currAlbums = albums.prints;
                                    }
                                    else if (product.type == 'photobook') {
                                        currAlbums = albums.photobook;
                                    }
                                    else if (product.type == 'calendar' || product.type == 'deskcalendar') {
                                        currAlbums = albums.calendars;
                                    }
                                    else {
                                        currAlbums = albums.products;
                                    }
                                    var currAlbum = currAlbums[0]; //currAlbums[currItemOrder % currAlbums.length];

                                    // Add Opacity to other products
                                    $('.sfly_wgt_product').addClass('not-selected');
                                    that.removeHoverStates(containerElement);

                                    if (!that.IS_WIDGET_OPEN.state) {
                                        view_common.showLoading($('.sfly_wgt_listview_container'));
                                    }

                                    // tracking.track('mg', 'click', {
                                    //     sku: $(this).attr('data-sku'),
                                    //     order: currItemOrder
                                    // });
                                        tracking.track('mg', 'hover', {
                                            sku: $(this).attr('data-sku'),
                                            order: currItemOrder
                                        });
                                        // tracking.track('mg', 'static-hover', {
                                        //     sku: $(this).attr('data-sku'),
                                        //     order: currItemOrder
                                        // });
                                        //

                                    var callbacks = {
                                        takeLock: that.takeLock.bind(that),
                                        releaseLock: that.releaseLock.bind(that),
                                        animateControlButton: undefined,
                                        changeState: that.changeWidgetOpenState.bind(that, that.IS_WIDGET_OPEN),
                                        handleCurrentPid: that.handleCurrentPid.bind(that),
                                        toggleViewDisable: that.toggleViewDisable.bind(that, that.IS_VIEW_DISABLED)
                                    };

                                    //redirect prints and coasters onclick
                                    if ($(this).attr('data-pid') === 'prints_4x6') {
                                        var product = view_common.findProjectJsonProduct(productJson, $(this).attr('data-pid'), that.isAfterUPP);
                                        var photoIds = $(this).attr('data-pid') === 'prints_4x6' ? that.thumbRenderPreparePhotoIds(product, currAlbum, that.isAfterUPP, false) :  that.thumbRenderPreparePhotoIds(product, currAlbum, true, false);

                                        if (cache.get("partner_user_id") === "009085953279") {
                                            window.location = typeof view_common.getProduct(pId).personalizeUrl !== "undefined" ? view_common.getProduct(pId).personalizeUrl : view_common.getProduct(pId).seeMoreUrl;
                                        }
                                        else {
                                            clickThrough.sendForSeeAll(photoIds, undefined, undefined, undefined, undefined, that.Model);
                                        }
                                    }
                                    // else if ($(this).attr('data-ptype') == 'coaster') { //if coaster - go directly to creation path
                                    //     var projectJson = view_common.findProjectJsonProduct(productJson, pId, that.isAfterUPP);
                                    //
                                    //
                                    //     if (cache.get("partner_user_id") == "009085953279") {
                                    //         window.location = typeof view_common.getProduct(pId).personalizeUrl !== "undefined" ? view_common.getProduct(pId).personalizeUrl : view_common.getProduct(pId).seeMoreUrl;
                                    //     } else {
                                    //         clickThrough.sendToClickThrough(projectJson, $(this).attr('data-ptype'), undefined, undefined, undefined, undefined, that.Model);
                                    //     }
                                    // }
                                    else {
                                        modal.show({
                                            pId: elem.attr('data-pid'),
                                            currPid: that.CURRENT_OPEN_PID,
                                            currAlbum: currAlbum,
                                            albums: currAlbums,
                                            prodStyles: prodStyles,
                                            prodOptions: prodOptions,
                                            forceCloseExternal: false,
                                            widgetIsOpen: that.IS_WIDGET_OPEN.state,
                                            isThisLife: that.isThisLifeGeneral,
                                            mixedSources: that.mixedSourcesGeneral,
                                            callbacks: callbacks,
                                            model: that.Model
                                        });
                                    }
                                }
                            })
                            .on('mouseenter', function ()
                            {
                                return;
                                that.horizontalItemMouseEnter(this, that.IS_WIDGET_OPEN.state, priceElem, productInner, hoverElem);
                            })
                            .on('mouseleave', function ()
                            {
                                return;
                                that.horizontalItemMouseOut(this, productInner, hoverElem, priceElem);
                            });

                        if (_.isFunction(productGenerateCallBack)) {
                            productGenerateCallBack(j);
                        }
                    }, true, {masks: layoutMasks, textEnabled:(productType !== "book")});
                }

                /* === END HELPER ==== */

                var commonWidth = that.LV_PROD_WIDTH;
                var commonHeight = that.LV_PROD_HEIGHT;
                var spreadResult = that.prepareSpreads(products, 'listview', products.length);
                var spreads = spreadResult.spreads;
                var side_padding = spreads.children('.sfly_wgt_listview_spread').length > 1 ? SIDE_PAD : SIDE_PAD_SMALL;
                var prodPosAndSize = that.findPositionProductsInSpreads({
                    container: containerElement,
                    spreads: spreads,
                    productJson: productJson,
                    targetHeight: commonHeight,
                    typeOfView: 'listview',
                    maxSpaceBetweenProds: MAX_SPACE_BETWEEN_PRODUCTS,
                    sidePadding: side_padding,
                    prodSizeZoomLevels: prodSizes,
                    calcElemPositionFunc: that.horizontalCalcElementsPosition.bind(that),
                    prodHeight: that.LV_PROD_HEIGHT
                });
                var prodPos = prodPosAndSize.positions;

                if ($('.sfly_wgt_listview_spread_container').length == 0) {
                    $(containerElement)
                        //.html(spreads)
                        .append(spreads)
                        .parent()
                        .attr('data-renderfor', $(containerElement).width());
                }
                else {
                    //update the width
                    $(containerElement).find('.sfly_wgt_listview_spread').width(prodPosAndSize.width);

                    //reload scroller
                    that.SCROLLER.reload();
                }

                //var TITLE_THEME = "holiday";
                //var TITLE_THEME = "";
                //var TITLE_THEME = "valentine";
                var TITLE_THEME = "president";
                if ($('.sfly_wgt_listview_embedded_title').length == 0) {
                    var source = cache.get('prod_type');
                    if (cache.get('partner_user_id') == '009085953279') {
                        var env = cache.get('env');
                        env = env != 'prod' ? '.' + env : '';

                        if (that.upload_photos) {
                            if (source == 'mysfly') {
                                $(containerElement).append(view_common.renderTemplate(templates.mg_embd_title, {theme: TITLE_THEME}));
                                view_common.showNewBubblePop(containerElement);
                                $('.sfly_wgt_bubble_new_upp_arrow').addClass('sfly_wgt_bubble_new_upp_arrow_hp');
                                $('.sfly_wgt_bubble_new_upp').addClass('sfly_wgt_bubble_new_upp_hp');
                            }
                            else {
                                $(containerElement).append(view_common.renderTemplate(templates.mg_homepage_no_photos, {env: env}));
                            }

                        }
                        else if (source == 'homepage') {
                            $(containerElement).append(view_common.renderTemplate(templates.mg_embd_signout_title, {env: env}));
                        }
                    }
                    else {
                        if (source == 'homepage') {
                            $(containerElement).append(view_common.renderTemplate(templates.mg_homepage_no_title));
                        }
                        else {
                            $(containerElement).append(view_common.renderTemplate(templates.mg_embd_title, {theme: TITLE_THEME}));
                        }

                    }
                }
                if ($('.sfly_wgt_listview_scroll_arrows').length == 0) {
                    $(containerElement).append(view_common.renderTemplate(templates.listview_arrows));
                }

                that.updateCssForSpreads(containerElement, 'listview');

                $(containerElement).find('.sfly_wgt_upp_select_main').off('click').on('click', function (e)
                {

                    e.preventDefault();

                    // Using UPP
                    function onOK(groupPhotos, isThisLife, mixedSources)
                    {
                        // forget that we are coming from the models user
                        cache.remove('switched_to_real_user');

                        view_common.showLoading($('.sfly_wgt_listview_container'));
                        var productJson = [];

                        function _getProductJson(pJson)
                        {
                            if (pJson != null) {
                                // if is This Life replace photoIds in the strip with SFLY Ids
                                if (isThisLife) {
                                    pJson = modal_common.replaceIdWithSFLYId(groupPhotos, pJson);
                                }
                                productJson = productJson.concat(pJson);
                            }
                            else {
                            }
                        }


                        that.Model.get('monitoring').eventStart('mgv3:getRankService_AfterUpp');
                        $.when(
                            productProxy.getPhotobook(groupPhotos, 40, _getProductJson, true, true, products, isThisLife, mixedSources, true),
                            productProxy.getProducts(groupPhotos, _getProductJson, true, products, true, isThisLife, mixedSources, true),
                            productProxy.getPrints(groupPhotos, _getProductJson, true, products, isThisLife, mixedSources, true),
                            productProxy.getCalendar(groupPhotos, _getProductJson, true, products, isThisLife, mixedSources, true)
                        )
                            .then(function () {
                                that.isThisLifeGeneral = isThisLife;
                                that.mixedSourcesGeneral = mixedSources;
                                that.Model.get('monitoring').eventEnd('mgv3:getRankService_AfterUpp');
                                cache.removeProductsAll();
                                var newalbums = new Object();
                                $.each(albums, function (type, album)
                                {
                                    if (album.length > 0) {
                                        $.each(album, function (i, albumObj)
                                        {
                                            if (typeof newalbums[type] === "undefined") {
                                                newalbums[type] = new Array();
                                            }
                                            newalbums[type].push(groupPhotos);
                                        });
                                    }
                                });
                                that.isAfterUPP = true;
                                that.renderView(containerElement, products, productJson, newalbums, prodStyles, prodSizes, prodOptions, modal);
                            })
                            .fail(function ()
                            {
                                view_common.removeLoading($('.sfly_wgt_listview_container'));
                            });

                        tracking.track('mg', 'upp', {action: 'ok', sku: 'main'});
                    }

                    function onCancel()
                    {
                        tracking.track('mg', 'upp', {action: 'cancel', sku: 'main'});
                    }

                    tracking.track('mg', 'upp', {action: 'open', sku: 'main'});
                    modal_common.showUPP(onOK, onCancel);

                });

                var renderedProds = 0;

                var afterProductRendered = function () {
                    renderedProds++;
                    if (renderedProds === NUM_OF_PRODUCT_TO_SHOW) {
                        if (cache.get('token') !== "") {
                            productProxy.getMGSources(null, true);
                        }
                        cache.set('full_load', true);
                    }
                };

                function enableScrollAfterFourProds() {
                    var elems = that.getScrollerArrows(containerElement);
                    if (that.SCROLLER === null) {
                        // Do tracking for loading
                        if(cache.get('partner_user_id') !== "009085953279"){
                            tracking.track('mg', 'on_load');
                            that.Model.get('monitoring').eventEnd('mgv3:Start');
                            that.Model.get('athenaLogger').logModuleDisplayed();
                        }
                        that.SCROLLER = scroller(spreads, elems.spreadToMove, elems.scrollerArrows, {orientation: 'horizontal'});
                        $(containerElement).on('mousewheel DOMMouseScroll', _.throttle(loadRestProducts, 50));
                        $(containerElement).find('.sfly-wgt-scroll-track').on('mousedown', _.throttle(loadRestProducts, 200));
                    }
                }

                function loadRestProducts() {
                    if (!that.preloadedAll) {
                        if (that.products.length - NUM_OF_PRODUCT_TO_SHOW > 0) {
                            var productsList = _.last(that.products, that.products.length - NUM_OF_PRODUCT_TO_SHOW);
                            loadProducts(that.productJson, productsList, NUM_OF_PRODUCT_TO_SHOW + 1);
                        }
                        that.preloadedAll = true;
                    }
                }

                function addTracking()
                {
                    // For tracking
                    $(containerElement).find('.sfly_wgt_listview_scroll_left_arrow').on('click', function () {
                        tracking.track('mg', 'mg_arrow', {dir: 'left'});
                    });

                    $(containerElement).find('.sfly_wgt_listview_scroll_right_arrow').on('click', function () {
                        loadRestProducts();
                        tracking.track('mg', 'mg_arrow', {dir: 'right'});
                    });// End tracking
                }

                view_common.removeLoading($('.sfly_wgt_listview_container'));
                addTracking();

                var newProdList = _.first(that.products, NUM_OF_PRODUCT_TO_SHOW);
                if (this.SCROLLER !== null) {
                    newProdList = that.products;
                    that.preloadedAll = true;
                }
                loadProducts(that.productJson, newProdList, 1);

                function loadProducts(productJson, productsList, startIndex) {
                    var promises = renderProducts(productJson, productsList, afterProductRendered, startIndex);
                    $.when.apply($, promises).then(function () {
                            enableScrollAfterFourProds();
                            that.loadPrices(containerElement, products);
                    });
                }

                function getProductInfo(productJson, sku) {
                    var product = view_common.findProjectJsonProduct(productJson, sku, true);
                    var productType = AssetMapper.GetProductType(product);
                    return  {
                        sku: sku,
                        product: product,
                        productType:  productType,
                        partnerId: AssetMapper.GetPartnerId(product, productType),
                        prodSku: productType != 'book' ? view_common.getProduct(sku)['sku'] : view_common.getProduct(sku)['style'] + '_' + view_common.getProduct(sku)['size']
                    }
                }
                function renderProducts(productsData, productsList, callback, startPosition) {
                    var promises= [];
                    _.each(productsList, function (sku, index) {
                        var prodInfo = getProductInfo(productsData, sku);
                        promises.push(renderProductItem(prodInfo, startPosition + index, callback));
                    }, that);
                    return promises;
                }

                function renderProductItem(productInfo, position, callback) {

                    if (productInfo.productType === 'prints') {
                        var layoutJson = JSON.stringify(config.getRecipeLayout()[productInfo.partnerId]);
                        var designJson = JSON.stringify(config.getRecipeDesign()[productInfo.partnerId]);
                        return renderThumb(productInfo.sku, productInfo.productType, productInfo.partnerId, productInfo.product, layoutJson, designJson, position, callback);
                    }
                    var deferred = $.Deferred();
                    // todo if thumb already was requested before - don't request again!
                    var theEventName = 'mgv3:prepareThumbGenAssets:' + productInfo.sku;
                    that.Model.get('monitoring').eventStart(theEventName);

                    thumbGenWrapper.prepareThumbGenAssets(productInfo.prodSku, productInfo.sku, 'medium', productInfo.productType,productInfo.product,
                        function (result)  {
                            that.Model.get('monitoring').eventEnd(theEventName);
                            deferred.resolve();
                            if (result === null || typeof result.layoutJson === 'undefined' || typeof result.designJson === 'undefined') {
                                products.sku = null;
                                console.log('[Product Widget] Missing Layout / Design json');
                                return;
                            }
                            var layout = productInfo.productType === 'book' ? result.layoutJson[productInfo.sku] : result.layoutJson;
                            layoutJson =  JSON.stringify(layout);
                            designJson = JSON.stringify(result.designJson);

                            renderThumb(productInfo.sku, productInfo.productType, productInfo.partnerId, productInfo.product, layoutJson, designJson, position, callback, result.layoutMasks, deferred);
                        }
                    );
                    return deferred;
                }
            };
        }

        utils.inheritPrototype(HorizontalViewEngine, EngineHorizontal);

        HorizontalViewEngine.prototype.render = function(params) {
            var that            = this;
            var source          = params.source;
            var prodStyles      = params.prodStyles;
            var prodSizes       = params.prodSizes;
            var prodOptions     = params.prodOptions;
            var showMessage     = params.showMessage;
            var numOfProducts   = params.numOfProducts;
            var modal_view      = params.modalView;
            var isCrossSell     = params.isCrossSell;

            if (!utils.browserSupported()){
                that.failWidget('horizontal', 'mg', 'mgv3', true);
                return;
            }

            that.Model.get('monitoring').eventStart('mgv3:Start');
            //that.Model.get('monitoring').eventStart('mgv3:on_first_product_load_Start');

            var ctr         = this.Model.get('container');
            var isManual    = false;
            that.globalWidgetInit();

            // do not render template until we have mgsources
            //$(ctr).html(view_common.renderTemplate(templates.listview_cont_horiz));
            function renderMainTemplate(showLoader, fromSource){
                fromSource = fromSource || [];
                $(ctr).html(view_common.renderTemplate(templates.listview_cont_horiz, { products: fromSource }));
                showLoader = typeof showLoader !== "undefined" ? showLoader : true;
                $(ctr).find('.sfly_wgt_listview_container').addClass('horiz-style');
                if(showLoader) {
                    // Animate the appearance of the temp boxes
                    var boxes = $(ctr).find('.sfly_wgt_item_placeholder');
                    var itr = 0;
                    _.each(boxes, function (box) {
                        setTimeout(function () {
                            $(box).css('display', 'inline-block');
                        }, itr * 300);
                        itr++;
                    });
                }
            }

            // Remove classes added on hover on product
            $(ctr).on('mouseleave', function() {
                that.removeHoverStates(this);
            });

            if (typeof showMessage !== 'undefined' && showMessage != null) {
                renderMainTemplate(false);
                that.horizontalShowOverlayView(showMessage, that.IS_VIEW_DISABLED.state);
                return;
            }

            var failId = 0;
            var currCallId = 1;
            var productJson = [];
            function _getProductJson(callId, pJson) {
                if (pJson != null && callId != failId) {
                    productJson = productJson.concat(pJson);
                }
            }

            // Check what kind of products is this and ask for MG Source accordingly
            var getPrints   = 0;
            var getProducts = 0;
            var getBooks    = 0;
            var getCalendar = 0;

            _.each(source, function(pId) {
                var product = view_common.getProduct(pId);
                switch(product.type) {
                    case 'prints':
                        getPrints = that.PRINTS_NUM_ALBUMS;
                        break;
                    case 'photobook':
                        getBooks = that.PB_NUM_ALBUMS;
                        break;
                    case 'calendar':
                        getCalendar = that.CAL_NUM_ALBUMS;
                        break;
                    default:
                        getProducts = that.PROD_NUM_ALBUMS;
                        break;
                }
            });

            // we have a 2 step process for displaying the widget
            // 1. Get the photos and albums for the user
            // 2. Get the covers for the albums
            that.Model.get('monitoring').eventStart('mgv3:getMgSource');
            productProxy.getMGSources(function(albums) {
                that.Model.get('monitoring').eventEnd('mgv3:getMgSource');
                if (albums !== null) {
                    if (_.isEmpty(albums)) {
                        //if the user doesn't have enough photos use the default user = 009085953279
                        if(cache.get('partner_user_id') !== "009085953279") {
                            cache.set("partner_user_id", "009085953279");
                            that.upload_photos = true;
                            if (that.Model.get('instance')) {
                                tracking.track('tl', 'on_load_static', {mode: 'instance', prod_type: that.Model.get('prod_type')});
                                that.Model.get('monitoring').eventStart('tl:on_load_static');
                                that.Model.get('monitoring').eventEnd('tl:on_load_static');
                            } else {
                                tracking.track('mg', 'on_load');
                                that.Model.get('monitoring').eventStart('mgv3:on_load');
                                that.Model.get('monitoring').eventEnd('mgv3:on_load');
                            }
                            that.render(params);
                            return;
                        }
                    }

                    that.Model.get('monitoring').eventStart('mgv3:getRankService');
                    var getProductsFromRank = function(retry) {

                        var d = $.Deferred();

                        var allAlbums = that.formatAllAlbums(albums, retry);

                        // Check if we have enough products to create using the albums we got.
                        // We pass 100 as num of photos as we don't want to cut it
                        var cleanSource = that.cleanSourceWithAlbums(source, allAlbums, 100);

                        // if the user doesn't have enough photos use the default user = 009085953279
                        // if less than 4 products do not render mg
                        if (cleanSource.length < 4) {
                            if(cache.get('partner_user_id') !== "009085953279") {
                                cache.set("partner_user_id", "009085953279");
                                if (that.Model.get('instance')) {
                                    tracking.track('tl', 'on_load_static', {mode: 'instance', prod_type: that.Model.get('prod_type')});
                                    that.Model.get('monitoring').eventStart('tl:on_load_static');
                                    that.Model.get('monitoring').eventEnd('tl:on_load_static');
                                } else {
                                    tracking.track('mg', 'on_load');
                                    that.Model.get('monitoring').eventStart('mgv3:on_load');
                                    that.Model.get('monitoring').eventEnd('mgv3:on_load');
                                }
                                that.render(params);
                                d.reject();
                                return;
                            }
                        }

                        $.when(
                            productProxy.getPhotobook(allAlbums['photobook'], 40, _getProductJson.bind(this, currCallId), true, isManual, cleanSource),
                            productProxy.getProducts(allAlbums['products'], _getProductJson.bind(this, currCallId), isManual, cleanSource, true),
                            productProxy.getPrints(allAlbums['prints'], _getProductJson.bind(this, currCallId), isManual, cleanSource),
                            productProxy.getCalendar(allAlbums['calendars'], _getProductJson.bind(this, currCallId), isManual, cleanSource)
                        )
                            .then(function () {
                                that.Model.get('monitoring').eventEnd('mgv3:getRankService');
                                renderMainTemplate(true, cleanSource);
                                that.renderView($(ctr).find('.sfly_wgt_listview_container'), cleanSource, productJson, allAlbums, prodStyles, prodSizes, prodOptions, modal_view);

                             //if cross_sell - change title
                            if(isCrossSell) {
                                var recArea = $('#recommendationsArea');
                                var mgTitleAre = $('.sfly_wgt_listview_embedded_caption');
                                recArea.css('width', '980px');
                                recArea.css('height', '300px');
                                recArea.css('background-color', '#fff');
                                recArea.css('position', 'absolute');
                                //Change mg title
                                mgTitleAre.empty();
                                //mgTitleAre.text('Recommended for you');
                                //mgTitleAre.css('text-align', 'left');
                            }
                                d.resolve(true);
                            })
                            .fail(function () {
                                if(retry) {
                                    console.log('[Product Widget]> Failed loading resources (Api). Aborting.');
                                    productProxy.MgFail();
                                    renderMainTemplate();
                                    that.failWidget('horizontal', 'mg', 'mgv3', true);
                                } else {
                                    console.log('[Product Widget]> Failed loading resources (Api). Retrying with different source.');
                                }
                                d.reject();
                            });
                        return d.promise();
                    };

                    // get products from api. If fails the first time retry with a second source.
                    $.when(getProductsFromRank())
                        .fail(function(){
                            failId = currCallId;
                            currCallId++;
                            productJson = [];
                            getProductsFromRank(true);
                        });

                } else {
                    console.log('[Product Widget]> Failed loading resources. Aborting.');

                    productProxy.MgFail();
                    renderMainTemplate();
                    that.failWidget('horizontal', 'mg', 'mgv3', true);
                }
            });
        };

        return HorizontalViewEngine;
    });

define('app/view_engine/widgets/engines/horizontal_flex/Engine',
    ['underscore', 'app/templates',  'mgthumb', 'app/asset_mapper', 'app/config_manager', 'app/click_through', 'app/tracking', 'app/cookies', 'magicselect', 'app/album_switch', 'app/product_proxy', 'app/utils', 'app/cache_module', 'app/scroller', 'app/view_engine/widgets/common', 'app/thumbgen_wrapper', 'app/time_monitor', 'app/view_engine/modals/shared', 'app/view_engine/widgets/engines/EngineHorizontal', 'css!./../../../../css/widget.css', 'css!./../../../../css/MagicSelectBox.css'],

    function(_, templates, mgthumb, AssetMapper, config, clickThrough, tracking, cookies, magicselect, albumSwitch, productProxy, utils, cache, scroller, view_common, thumbGenWrapper, monitor, modal_common, EngineHorizontal, css1, css2)
    {
        function HorizontalFlexViewEngine(params)
        {
            EngineHorizontal.call(this, params);

            this.LV_PROD_WIDTH = 110;
            this.LV_PROD_HEIGHT = 135;
            this.PB_NUM_ALBUMS = 2;
            this.PROD_NUM_ALBUMS = 2;
            this.PRINTS_NUM_ALBUMS = 2;
            this.CAL_NUM_ALBUMS = 2;
            this.DISABLE_CLICK = false;
            this.IS_WIDGET_OPEN = {state: false};
            this.CURRENT_OPEN_PID = null;
            this.IS_VIEW_DISABLED = {state: false};
            this.ZOOM_LEVEL = 1.05;
            this.SCROLLER = null;
            this.isAfterUPP = false;
            this.isThisLifeGeneral = false;
            this.mixedSourcesGeneral = false;
            this.upload_photos = false; //Flag if the user doesn't have enough photos


            //var TITLE_THEME = "holiday";
            //var TITLE_THEME = "";
            //var TITLE_THEME = "valentine";
            // var TITLE_THEME = "president";
            //this.TITLE_THEME = "father-day";
            // this.TITLE_THEME = "summer";
            // this.TITLE_THEME = "school";
            // this.TITLE_THEME = "summer";
            this.TITLE_THEME = "made-just";

            /**
             * set or get the current opend pid
             * @param currentOpenPid
             * @returns {*}
             */
            this.handleCurrentPid = function (currentOpenPid)
            {
                if (typeof currentOpenPid !== "undefined") {
                    this.CURRENT_OPEN_PID = currentOpenPid;
                }
                return this.CURRENT_OPEN_PID;
            };

            // Will render the ListView products in the given @containerElement
            this.renderView = function (containerElement, products, productJson, albums, prodStyles, prodSizes, prodOptions, modal)
            {
                var SIDE_PAD                    = 65;
                var SIDE_PAD_SMALL              = 50;
                var MAX_SPACE_BETWEEN_PRODUCTS  = 80;
                var SPACE_FROM_TOP              = 80;
                // TODO: calc this
                var NUM_OF_PRODUCT_TO_SHOW      = 10;
                var that                        = this;

                this.preloadedAll = false;
                this.productJson = productJson;
                this.products = products;

                if (cache.get('prod_type') === "homepage") {
                    $(containerElement.prevObject).css("overflow", "hidden").css("width", "100%");
                    NUM_OF_PRODUCT_TO_SHOW = Math.ceil(window.innerWidth / 250);
                    if (NUM_OF_PRODUCT_TO_SHOW > products.length) {
                        NUM_OF_PRODUCT_TO_SHOW = products.length;
                    }
                }
                /* === HELPER ==== */
                // should be request to banner service
                function getBanner() {
                    var date = new Date();
                    var day = date.getDate();
                    var month = date.getMonth() + 1; // months are between 0 and 11
                    var year = date.getFullYear();

                    if ((day >= 27 && day <= 29) && month === 5 && year === 2018) {
                        var printTemplate = $(templates.fullview_prints_banner);
                        printTemplate.addClass('horizontal_magic');
                        return printTemplate;
                    }
                    return '';
                }


                function renderThumb(pId, productType, partnerId, product, layoutJson, designJson, position, productGenerateCallBack, layoutMasks, promiseToResolve, showMock, styles)
                {
                    var showMock = showMock || false;

                    var generateCallback = function (canvas)
                    {
                        that.Model.get('monitoring').eventEnd('mgv3:Generate:' + pId);
                        // TODO: replace this renderer
                        var elem = that.thumbRenderPlaceElement(containerElement, canvas, pId, productType, 0, j);
                        //view_common.updateProductSize(elem, commonWidth, pId, productJson, prodPosAndSize.sizes);
                        var pSize = view_common.getProductRealSize(productJson, pId);
                        var priceTop = that.updateProductPrice({
                            widgetType: 'horizontal',
                            container: elem,
                            productJson: productJson,
                            pId: pId,
                            targetSize: prodPosAndSize.sizes[pId],
                            prodOptions: prodOptions,
                            coupon: typeof cache.getCoupon() !== "undefined" ? cache.getCoupon().name : false
                        });
                        var topPos = SPACE_FROM_TOP - pSize.top * prodPosAndSize.sizes[pId].ratio;

                        // Set position
                        // We want to shift all products down
                        elem.css('position', 'relative')
                            .css('top', 'auto')
                            .css('left', 'auto')
                            .css('height', 'auto')
                            .css('width', 'auto')
                            .attr('data-top', topPos)
                            .attr('data-left', prodPos[pId])
                            .attr('data-subleft', topPos)
                            .attr('data-subtop', topPos);

                        elem[0].style.order =  j; // flex order

                        var productInner = elem.children('.sfly_wgt_product_inner');
                        var priceElem = elem.children('.sfly_wgt_product_price');
                        var hoverElem = elem.find(".sfly_wgt_product_hover");
                        productInner.attr('data-pricetop', priceTop);

                        // Center the thumbnail inside the cell
                        var containerWidth = 180;
                        var containerHeight =  180;
                        var requiredPrc = 0.8;

                        //the required width and height of product itself without margins:
                        var maxWidth  = containerWidth * requiredPrc;
                        var maxHeight = containerHeight * requiredPrc;

                        var containerMarginLeft = ( containerWidth  - maxWidth  ) / 2;
                        var containerMarginTop  = ( containerHeight - maxHeight ) / 2;

                        //ratio of required size from sku size
                        var widthRatio  = maxWidth  / (pSize.origWidth  - pSize.left - pSize.right );
                        var heightRatio = maxHeight / (pSize.height     - pSize.top  - pSize.bottom);

                        var ratio = Math.min(widthRatio,heightRatio);
                        //this ratio will be used to turn every sku size to display size


                        var newImgWidth = pSize.origWidth*ratio;
                        var newImgHeight = pSize.height*ratio;

                        var newProductWidth = (pSize.origWidth - pSize.left - pSize.right)*ratio;
                        var newProductHeight = (pSize.height - pSize.top - pSize.bottom)*ratio;

                        //calculate extra margin required to center the product
                        var productMarginLeft = ( maxWidth  - newProductWidth  ) / 2;
                        var productMarginTop  = ( maxHeight - newProductHeight ) / 2;

                        var marginLeft =  (containerMarginLeft + (productMarginLeft - pSize.left * ratio)) + 'px';
                        var marginTop  =  (containerMarginTop  + (productMarginTop  - pSize.top  * ratio)) + 'px';

                        var theCanvas = productInner.find('canvas');
                        theCanvas.css('left', marginLeft);
                        theCanvas.css('top', marginTop);
                        theCanvas.css('max-width', newImgWidth + 'px');
                        theCanvas.css('max-height', newImgHeight + 'px');

                        priceElem.css('position', 'static')
                            .css('top', 'auto')
                            .css('left', 'auto')
                            .css('height', 'auto')
                            .css('width', 'auto');

                        // Calculate target position and size of the product
                        var pTargetSize = elem.width() * that.ZOOM_LEVEL;

                        if (pId === "prints_4x6") {
                            var banner = getBanner();
                            if  (banner) {
                                elem.append(banner);
                            }
                        }

                        var isStorybook = false;

                        if (!showMock && productType === "book" && pId.toString().endsWith("_8x8")
                            && typeof styles === "object" && Object.keys(styles).length > 0
                            && typeof product === "object" && product.hasOwnProperty("book")
                            && product.book.hasOwnProperty("info") && product.book.info.hasOwnProperty("size") && styles.hasOwnProperty(
                                product.book.info.style)) {
                            isStorybook = true;
                        }

                        if(isStorybook){

                            //add "NEW" badge
                            var printTemplate = $(templates.fullview_new_banner_badge);
                            printTemplate.addClass('horizontal_magic');
                            elem.append(printTemplate);

                            //scale the canvas
                            elem.addClass("storyBook");

                            //add title
                            var title = $("<div class='title'></div>");
                            title.text("Personalized story books");
                            elem.append(title);

                            //add sub-title
                            var subTitle = $("<div class='subTitle'></div>");
                            subTitle.text("Make your child the star of their own adventure");
                            elem.append(subTitle);

                            //set inline style for price
                            elem.find(".sfly_wgt_product_price").addClass("marginTopM30")


                        }

                        // Sometimes, in ThisLife, the widget will get a bad size - we want to mark it
                        if (pTargetSize == 0) {
                            $(containerElement).parent().attr('data-renderfor', 0);
                        }

                        if (typeof promiseToResolve !== 'undefined') {
                            promiseToResolve.resolve();
                        }

                        elem
                            .on('click', function ()
                            {
                                if (!that.isLocked()) {
                                    that.takeLock();

                                    var currItemOrder = $(this).attr('data-order') - 1; // order is "1" based, albums is "0" based
                                    var product = view_common.getProduct(pId);
                                    var currAlbums;
                                    if (product.type == 'prints') {
                                        currAlbums = albums.prints;
                                    }
                                    else if (product.type == 'photobook') {
                                        currAlbums = albums.photobook;
                                    }
                                    else if (product.type == 'calendar' || product.type == 'deskcalendar') {
                                        currAlbums = albums.calendars;
                                    }
                                    else {
                                        currAlbums = albums.products;
                                    }
                                    var currAlbum = currAlbums[0]; //currAlbums[currItemOrder % currAlbums.length];

                                    // Add Opacity to other products
                                    $('.sfly_wgt_product').addClass('not-selected');
                                    that.removeHoverStates(containerElement);

                                    if (!that.IS_WIDGET_OPEN.state) {
                                        view_common.showLoading($('.sfly_wgt_listview_container'));
                                    }

                                    // tracking.track('mg', 'click', {
                                    //     sku: $(this).attr('data-sku'),
                                    //     order: currItemOrder
                                    // });

                                        tracking.track('mg', 'hover', {
                                            sku: $(this).attr('data-sku'),
                                            order: currItemOrder
                                        });


                                    var callbacks = {
                                        takeLock: that.takeLock.bind(that),
                                        releaseLock: that.releaseLock.bind(that),
                                        animateControlButton: undefined,
                                        changeState: that.changeWidgetOpenState.bind(that, that.IS_WIDGET_OPEN),
                                        handleCurrentPid: that.handleCurrentPid.bind(that),
                                        toggleViewDisable: that.toggleViewDisable.bind(that, that.IS_VIEW_DISABLED)
                                    };

                                    //redirect prints and coasters onclick
                                    if ($(this).attr('data-pid') == 'prints_4x6') {
                                        var product = view_common.findProjectJsonProduct(productJson, $(this).attr('data-pid'), that.isAfterUPP);
                                        var photoIds = $(this).attr('data-pid') == 'prints_4x6' ? that.thumbRenderPreparePhotoIds(product, currAlbum, that.isAfterUPP, false) :  that.thumbRenderPreparePhotoIds(product, currAlbum, true, false);

                                        if (cache.get("partner_user_id") == "009085953279") {
                                            window.location = typeof view_common.getProduct(pId).personalizeUrl !== "undefined" ? view_common.getProduct(pId).personalizeUrl : view_common.getProduct(pId).seeMoreUrl;
                                        }
                                        else {
                                            clickThrough.sendForSeeAll(photoIds, undefined, undefined, undefined, undefined, that.Model);
                                        }
                                    }
                                    // else if ($(this).attr('data-ptype') == 'coaster') { //if coaster - go directly to creation path
                                    //     var projectJson = view_common.findProjectJsonProduct(productJson, pId, that.isAfterUPP);
                                    //
                                    //
                                    //     if (cache.get("partner_user_id") == "009085953279") {
                                    //         window.location = typeof view_common.getProduct(pId).personalizeUrl !== "undefined" ? view_common.getProduct(pId).personalizeUrl : view_common.getProduct(pId).seeMoreUrl;
                                    //     } else {
                                    //         clickThrough.sendToClickThrough(projectJson, $(this).attr('data-ptype'), undefined, undefined, undefined, undefined, that.Model);
                                    //     }
                                    // }
                                    else {

                                        that.Model.attributes.isStoryBook = isStorybook;
                                        that.Model.attributes.styles = styles;

                                        modal.show({
                                            pId: elem.attr('data-pid'),
                                            currPid: that.CURRENT_OPEN_PID,
                                            currAlbum: currAlbum,
                                            albums: currAlbums,
                                            prodStyles: prodStyles,
                                            prodOptions: prodOptions,
                                            forceCloseExternal: false,
                                            widgetIsOpen: that.IS_WIDGET_OPEN.state,
                                            isThisLife: that.isThisLifeGeneral,
                                            mixedSources: that.mixedSourcesGeneral,
                                            callbacks: callbacks,
                                            model: that.Model
                                        });
                                    }
                                }
                            });
                        //.on('mouseenter', function ()
                        //{
                        //    that.horizontalItemMouseEnter(this, that.IS_WIDGET_OPEN.state, priceElem, productInner, hoverElem);
                        //})
                        //.on('mouseleave', function ()
                        //{
                        //    that.horizontalItemMouseOut(this, productInner, hoverElem, priceElem);
                        //});

                        if (_.isFunction(productGenerateCallBack)) {
                            productGenerateCallBack(j);
                        }
                    };

                    var j = position;

                    if (showMock) {
                        var spinnerCanvas = "<img src='https://container.photoccino.com/v1/assets/spinner.gif'/>";
                        generateCallback(spinnerCanvas);
                    } else {
                        var useCDN = cache.get('env') != 'beta' && cache.get('env') != 'dev';
                        var mgThumbGen  = new MgThumbGenerator(cache.get('env'),useCDN);

                        mgThumbGen.init(productType, partnerId, product, layoutJson, designJson, that.Model.get('monitoring').reportEvent, cache.get('env'));

                        var projectionNum = 0;
                        if (productType === 'mug') {
                            projectionNum = 3;
                        }
                        that.Model.get('monitoring').eventStart('mgv3:Generate:' + pId);
                        mgThumbGen.generate(projectionNum, pId, true, generateCallback, true, {masks: layoutMasks, textEnabled:(productType !== "book")});
                    }
                }

                /* === END HELPER ==== */

                var commonWidth = that.LV_PROD_WIDTH;
                var commonHeight = that.LV_PROD_HEIGHT;
                var spreadResult = that.prepareSpreads(products, 'listview', products.length);
                var spreads = spreadResult.spreads;
                var side_padding = spreads.children('.sfly_wgt_listview_spread').length > 1 ? SIDE_PAD : SIDE_PAD_SMALL;
                var prodPosAndSize = that.findPositionProductsInSpreads({
                    container: containerElement,
                    spreads: spreads,
                    productJson: productJson,
                    targetHeight: commonHeight,
                    typeOfView: 'listview',
                    maxSpaceBetweenProds: MAX_SPACE_BETWEEN_PRODUCTS,
                    sidePadding: side_padding,
                    prodSizeZoomLevels: prodSizes,
                    calcElemPositionFunc: that.horizontalCalcElementsPosition.bind(that),
                    prodHeight: that.LV_PROD_HEIGHT
                });
                var prodPos = prodPosAndSize.positions;

                if ($('.sfly_wgt_listview_spread_container').length == 0) {
                    $(containerElement)
                        //.html(spreads)
                        .append(spreads)
                        .parent()
                        .attr('data-renderfor', $(containerElement).width());
                }
                else {
                    //update the width
                    //$(containerElement).find('.sfly_wgt_listview_spread').width(prodPosAndSize.width);


                    //reload scroller
                    if (that.SCROLLER) {
                        that.SCROLLER.reload();
                    }
                }
                var itemWidth = 182 + 10;
                var itemsPerLine = shouldUseSingleLine() ? products.length : Math.ceil(products.length / 2);
                var totalWidth = itemWidth * itemsPerLine;
                $(containerElement).find('.sfly_wgt_listview_spread').width(totalWidth);
                //$(containerElement).find('.sfly_wgt_listview_spread').width('auto');

                if ($('.sfly_wgt_listview_embedded_title').length == 0) {
                    var source = cache.get('prod_type');
                    if (cache.get('partner_user_id') == '009085953279') {
                        var env = cache.get('env');
                        env = env != 'prod' ? '.' + env : '';

                        if (that.upload_photos) {
                            if (source == 'mysfly') {
                                $(containerElement).append(view_common.renderTemplate(templates.mg_embd_title_flex,{theme: that.TITLE_THEME}));
                                view_common.showNewBubblePop(containerElement);
                                $('.sfly_wgt_bubble_new_upp_arrow').addClass('sfly_wgt_bubble_new_upp_arrow_hp');
                                $('.sfly_wgt_bubble_new_upp').addClass('sfly_wgt_bubble_new_upp_hp');
                            }
                            else {
                                $(containerElement).append(view_common.renderTemplate(templates.mg_homepage_no_photos, {env: env}));
                            }

                        }
                        else if (source == 'homepage') {
                            $(containerElement).append(view_common.renderTemplate(templates.mg_embd_signout_title, {env: env}));
                        }
                    }
                    else {
                        if (source == 'homepage') {
                            $(containerElement).append(view_common.renderTemplate(templates.mg_homepage_no_title));
                        }
                        else {
                            $(containerElement).append(view_common.renderTemplate(templates.mg_embd_title_flex,{theme: that.TITLE_THEME}));
                        }

                    }
                }
                if ($('.sfly_wgt_listview_scroll_arrows').length == 0) {
                    $(containerElement).append(view_common.renderTemplate(templates.listview_arrows,{theme: that.TITLE_THEME}));
                }

                //texts changer - made just for you
                var titlesDiv = document.getElementsByClassName("sfly-wgt-subtitle-text");
                if (titlesDiv && titlesDiv.length > 0) {
                    titlesDiv = titlesDiv[0];
                }
                if(that.TITLE_THEME === "made-just" && titlesDiv){
                    try {
                        var baseURL = (cache.get('env') === "prod" ? "https://d22bbwxztp2lry.cloudfront.net/productswidget/Shutterfly/sidewidget/recipes/" : "https://s3.amazonaws.com/magicshopfiles/productswidget/Shutterfly/sidewidget/recipes/");
                        $.getJSON(
                            baseURL + cache.get('env') + "/unified-recipe.json",
                            function (data) {
                                if(typeof data === "object"){
                                    if(data.hasOwnProperty("mysfly") && Object.keys(data.mysfly).length > 0){
                                        var titles = Object.keys(data.mysfly).map(function (i) {
                                            return data.mysfly[i]
                                        }).filter(
                                            function (title) {
                                                return title && title !== "";
                                            });
                                        if(titles.length > 0){
                                            titlesDiv.innerHTML = titles.join(" | ");
                                        } else {
                                            throw new Error("no titles found!")
                                        }
                                    } else {
                                        throw new Error("mysfly titles not found!")
                                    }
                                } else {
                                    throw new Error("unified recipe is not an object!")
                                }
                            });
                    } catch (e){
                        console.warn('failed to init texts changer - ' + e.message.toString())
                    }
                }

                //eof text changer

                that.updateCssForSpreads(containerElement, 'listview');

                $(containerElement).find('.sfly_wgt_upp_select_main').off('click').on('click', function (e)
                {

                    e.preventDefault();

                    // Using UPP
                    function onOK(groupPhotos, isThisLife, mixedSources)
                    {

                        // forget that we are coming from the models user
                        cache.remove('switched_to_real_user');

                        view_common.showLoading($('.sfly_wgt_listview_container'));
                        var productJson = [];

                        function _getProductJson(pJson)
                        {
                            if (pJson != null) {
                                // if is This Life replace photoIds in the strip with SFLY Ids
                                if (isThisLife) {
                                    pJson = modal_common.replaceIdWithSFLYId(groupPhotos, pJson);
                                }
                                productJson = productJson.concat(pJson);
                            }
                            else {
                            }
                        }


                        that.Model.get('monitoring').eventStart('mgv3:getRankService_AfterUpp');
                        $.when(
                            productProxy.getPhotobook(groupPhotos, 40, _getProductJson, true, true, products, isThisLife, mixedSources, true),
                            productProxy.getProducts(groupPhotos, _getProductJson, true, products, true, isThisLife, mixedSources, true),
                            productProxy.getPrints(groupPhotos, _getProductJson, true, products, isThisLife, mixedSources, true),
                            productProxy.getCalendar(groupPhotos, _getProductJson, true, products, isThisLife, mixedSources, true)
                        )
                            .then(function () {
                                that.isThisLifeGeneral = isThisLife;
                                that.mixedSourcesGeneral = mixedSources;
                                that.Model.get('monitoring').eventEnd('mgv3:getRankService_AfterUpp');
                                cache.removeProductsAll();
                                var newalbums = new Object();
                                $.each(albums, function (type, album)
                                {
                                    if (album.length > 0) {
                                        $.each(album, function (i, albumObj)
                                        {
                                            if (typeof newalbums[type] === "undefined") {
                                                newalbums[type] = new Array();
                                            }
                                            newalbums[type].push(groupPhotos);
                                        });
                                    }
                                });
                                that.isAfterUPP = true;
                                that.renderView(containerElement, products, productJson, newalbums, prodStyles, prodSizes, prodOptions, modal);
                            })
                            .fail(function ()
                            {
                                view_common.removeLoading($('.sfly_wgt_listview_container'));
                            });

                        tracking.track('mg', 'upp', {action: 'ok', sku: 'main'});
                    }

                    function onCancel()
                    {
                        tracking.track('mg', 'upp', {action: 'cancel', sku: 'main'});
                    }

                    tracking.track('mg', 'upp', {action: 'open', sku: 'main'});
                    modal_common.showUPP(onOK, onCancel);

                });

                var renderedProds = 0;

                var afterProductRendered = function () {
                    renderedProds++;
                    if (renderedProds === NUM_OF_PRODUCT_TO_SHOW) {
                        if (cache.get('token') !== "") {
                            productProxy.getMGSources(null, true);
                        }
                        cache.set('full_load', true);
                    }
                };

                function enableScrollAfterFourProds() {
                    var elems = that.getScrollerArrows(containerElement);
                    if (that.SCROLLER === null) {
                        // Do tracking for loading
                        if(cache.get('partner_user_id') !== "009085953279"){
                            tracking.track('mg', 'on_load');
                            that.Model.get('monitoring').eventEnd('mgv3:Start');
                            that.Model.get('athenaLogger').logModuleDisplayed();
                        }
                        that.SCROLLER = scroller(spreads, elems.spreadToMove, elems.scrollerArrows, {orientation: 'horizontal', color: '#bf2829'});
                        $(containerElement).on('mousewheel DOMMouseScroll', _.throttle(loadRestProducts, 50));
                        $(containerElement).find('.sfly-wgt-scroll-track').on('mousedown', _.throttle(loadRestProducts, 200));
                    }
                }

                function loadRestProducts() {
                    if (!that.preloadedAll) {
                        if (that.products.length - NUM_OF_PRODUCT_TO_SHOW > 0) {
                            var productsList = _.last(that.products, that.products.length - NUM_OF_PRODUCT_TO_SHOW);
                            loadProducts(that.productJson, productsList, NUM_OF_PRODUCT_TO_SHOW + 1);
                        }
                        that.preloadedAll = true;
                    }
                }

                function addTracking()
                {
                    // For tracking
                    $(containerElement).find('.sfly_wgt_listview_scroll_left_arrow').on('click', function () {
                        tracking.track('mg', 'mg_arrow', {dir: 'left'});
                    });

                    $(containerElement).find('.sfly_wgt_listview_scroll_right_arrow').on('click', function () {
                        loadRestProducts();
                        tracking.track('mg', 'mg_arrow', {dir: 'right'});
                    });// End tracking
                }

                view_common.removeLoading($('.sfly_wgt_listview_container'));
                addTracking();


                var newProdList = _.first(that.products, NUM_OF_PRODUCT_TO_SHOW);
                if (this.SCROLLER !== null) {
                    newProdList = that.products;
                    that.preloadedAll = true;
                }

                loadProducts(that.productJson, newProdList, 1);

                function loadProducts(productJson, productsList, startIndex) {
                    renderMockView(productsList, productJson, startIndex);
                    var promises = renderProducts(productJson, productsList, afterProductRendered, startIndex);
                    $.when.apply($, promises).then(function () {
                            enableScrollAfterFourProds();
                            that.loadPrices(containerElement, products);
                    });
                }

                function getProductInfo(productJson, sku) {
                    var product = view_common.findProjectJsonProduct(productJson, sku, true);
                    var productType = AssetMapper.GetProductType(product);
                    return  {
                        sku: sku,
                        product: product,
                        productType:  productType,
                        partnerId: AssetMapper.GetPartnerId(product, productType),
                        prodSku: productType != 'book' ? view_common.getProduct(sku)['sku'] : view_common.getProduct(sku)['style'] + '_' + view_common.getProduct(sku)['size']
                    }
                }
                function renderProducts(productsData, productsList, callback, startPosition) {
                    var promises= [];
                    _.each(productsList, function (sku, index) {
                        var prodInfo = getProductInfo(productsData, sku);
                        promises.push(renderProductItem(prodInfo, startPosition + index, callback));
                    }, that);
                    return promises;
                }

                function renderProductItem(productInfo, position, callback, showMock) {
                    var showMock = showMock || false;
                    if (showMock) {
                        return renderThumb(productInfo.sku, productInfo.productType, productInfo.partnerId, productInfo.product, null, null, position, callback, null, undefined, showMock);
                    }

                    if (productInfo.productType === 'prints') {
                        var layoutJson = JSON.stringify(config.getRecipeLayout()[productInfo.partnerId]);
                        var designJson = JSON.stringify(config.getRecipeDesign()[productInfo.partnerId]);
                        return renderThumb(productInfo.sku, productInfo.productType, productInfo.partnerId, productInfo.product, layoutJson, designJson, position, callback);
                    }
                    var deferred = $.Deferred();
                    // todo if thumb already was requested before - don't request again!
                    var theEventName = 'mgv3:prepareThumbGenAssets:' + productInfo.sku;
                    that.Model.get('monitoring').eventStart(theEventName);

                    thumbGenWrapper.prepareThumbGenAssets(productInfo.prodSku, productInfo.sku, 'medium', productInfo.productType,productInfo.product,
                        function (result)  {
                            that.Model.get('monitoring').eventEnd(theEventName);
                            deferred.resolve();
                            if (result === null || typeof result.layoutJson === 'undefined' || typeof result.designJson === 'undefined') {
                                products.sku = null;
                                console.log('[Product Widget] Missing Layout / Design json');
                                return;
                            }
                            var layout = productInfo.productType === 'book' ? result.layoutJson[productInfo.sku] : result.layoutJson;
                            layoutJson =  JSON.stringify(layout);
                            designJson = JSON.stringify(result.designJson);

                            renderThumb(productInfo.sku, productInfo.productType, productInfo.partnerId, productInfo.product, layoutJson, designJson, position, callback, result.layoutMasks, deferred, false, result.styles);
                        }
                    );
                    return deferred;
                }

                function renderMockView(productsList, productsData, startPosition) {
                    _.each(productsList, function (sku, index) {
                        var prodInfo = getProductInfo(productsData, sku);
                        renderProductItem(prodInfo, startPosition + index, null, true);
                    }, that);
                }

                function shouldUseSingleLine() {
                    return (
                        $(document.getElementById('MagicShopFull')).hasClass('calendars-cat-page') ||
                        $(document.getElementById('MagicShopFull')).hasClass('specialoffers-cat-page') ||
                        $(document.getElementById('MagicShopFull')).hasClass('one-line')
                    );
                }
            };
        }

        utils.inheritPrototype(HorizontalFlexViewEngine, EngineHorizontal);

        HorizontalFlexViewEngine.prototype.render = function(params) {
            var that            = this;
            var source          = params.source;
            var prodStyles      = params.prodStyles;
            var prodSizes       = params.prodSizes;
            var prodOptions     = params.prodOptions;
            var showMessage     = params.showMessage;
            var numOfProducts   = params.numOfProducts;
            var modal_view      = params.modalView;
            var isCrossSell     = params.isCrossSell;

            if (!utils.browserSupported()){
                that.failWidget('horizontal', 'mg', 'mgv3', true);
                return;
            }

            that.Model.get('monitoring').eventStart('mgv3:Start');
            //that.Model.get('monitoring').eventStart('mgv3:on_first_product_load_Start');

            var ctr         = this.Model.get('container');
            var isManual    = false;
            that.globalWidgetInit();

            ctr.addClass('horizontal-flex');
            ctr.addClass(that.TITLE_THEME);

            // do not render template until we have mgsources
            //$(ctr).html(view_common.renderTemplate(templates.listview_cont_horiz));
            function renderMainTemplate(showLoader, fromSource){
                fromSource = fromSource || [];
                $(ctr).html(view_common.renderTemplate(templates.listview_cont_horiz, { products: fromSource }));
                showLoader = typeof showLoader !== "undefined" ? showLoader : true;
                if(showLoader) {
                    // Animate the appearance of the temp boxes
                    var boxes = $(ctr).find('.sfly_wgt_item_placeholder');
                    var itr = 0;
                    _.each(boxes, function (box) {
                        setTimeout(function () {
                            $(box).css('display', 'inline-block');
                        }, itr * 300);
                        itr++;
                    });
                }
            }

            // Remove classes added on hover on product
            $(ctr).on('mouseleave', function() {
                that.removeHoverStates(this);
            });

            if (typeof showMessage !== 'undefined' && showMessage != null) {
                renderMainTemplate(false);
                that.horizontalShowOverlayView(showMessage, that.IS_VIEW_DISABLED.state);
                return;
            }

            var failId = 0;
            var currCallId = 1;
            var productJson = [];
            function _getProductJson(callId, pJson) {
                if (pJson != null && callId != failId) {
                    productJson = productJson.concat(pJson);
                }
            }

            // Check what kind of products is this and ask for MG Source accordingly
            var getPrints   = 0;
            var getProducts = 0;
            var getBooks    = 0;
            var getCalendar = 0;

            _.each(source, function(pId) {
                var product = view_common.getProduct(pId);
                switch(product.type) {
                    case 'prints':
                        getPrints = that.PRINTS_NUM_ALBUMS;
                        break;
                    case 'photobook':
                        getBooks = that.PB_NUM_ALBUMS;
                        break;
                    case 'calendar':
                        getCalendar = that.CAL_NUM_ALBUMS;
                        break;
                    default:
                        getProducts = that.PROD_NUM_ALBUMS;
                        break;
                }
            });

            // we have a 2 step process for displaying the widget
            // 1. Get the photos and albums for the user
            // 2. Get the covers for the albums
            that.Model.get('monitoring').eventStart('mgv3:getMgSource');
            productProxy.getMGSources(function(albums) {
                that.Model.get('monitoring').eventEnd('mgv3:getMgSource');
                if (albums !== null) {
                    if (_.isEmpty(albums)) {
                        //if the user doesn't have enough photos use the default user = 009085953279

                        if(cache.get('partner_user_id') !== "009085953279") {
                            cache.set("partner_user_id", "009085953279");
                            $(ctr).addClass('mg-static-data');
                            that.upload_photos = true;
                            //todo: do not sent tracking on static view

                            that.Model.get('monitoring').addCounter('mgv3:on_load_static');

                            // if (that.Model.get('instance')) {
                            //     tracking.track('tl', 'on_load_static', {mode: 'instance', prod_type: that.Model.get('prod_type')});
                            //     that.Model.get('monitoring').eventStart('tl:on_load_static');
                            //     that.Model.get('monitoring').eventEnd('tl:on_load_static');
                            // } else {
                            //     tracking.track('mg', 'on_load');
                            //     that.Model.get('monitoring').eventStart('mgv3:on_load');
                            //     that.Model.get('monitoring').eventEnd('mgv3:on_load');
                            // }
                            that.render(params);
                            return;
                        }
                    }

                    that.Model.get('monitoring').eventStart('mgv3:getRankService');
                    var getProductsFromRank = function(retry) {

                        var d = $.Deferred();

                        var allAlbums = that.formatAllAlbums(albums, retry);

                        // Check if we have enough products to create using the albums we got.
                        // We pass 100 as num of photos as we don't want to cut it
                        var cleanSource = that.cleanSourceWithAlbums(source, allAlbums, 100);

                        // if the user doesn't have enough photos use the default user = 009085953279
                        // if less than 4 products do not render mg
                        if (cleanSource.length < 4) {
                            if(cache.get('partner_user_id') !== "009085953279") {
                                cache.set("partner_user_id", "009085953279");
                                $(ctr).addClass('mg-static-data');
                                if (that.Model.get('instance')) {

                                    //todo: do not sent tracking on static view
                                    // tracking.track('tl', 'on_load_static', {mode: 'instance', prod_type: that.Model.get('prod_type')});
                                    // that.Model.get('monitoring').eventStart('tl:on_load_static');
                                    // that.Model.get('monitoring').eventEnd('tl:on_load_static');
                                }
                                // else {
                                //     tracking.track('mg', 'on_load');
                                //     that.Model.get('monitoring').eventStart('mgv3:on_load');
                                //     that.Model.get('monitoring').eventEnd('mgv3:on_load');
                                // }
                                that.render(params);
                                d.reject();
                                return;
                            }
                        }

                        $.when(
                            productProxy.getPhotobook(allAlbums['photobook'], 40, _getProductJson.bind(this, currCallId), true, isManual, cleanSource),
                            productProxy.getProducts(allAlbums['products'], _getProductJson.bind(this, currCallId), isManual, cleanSource, true),
                            productProxy.getPrints(allAlbums['prints'], _getProductJson.bind(this, currCallId), isManual, cleanSource),
                            productProxy.getCalendar(allAlbums['calendars'], _getProductJson.bind(this, currCallId), isManual, cleanSource)
                        )
                            .then(function () {
                                that.Model.get('monitoring').eventEnd('mgv3:getRankService');
                                renderMainTemplate(false, cleanSource);
                                that.renderView($(ctr).find('.sfly_wgt_listview_container'), cleanSource, productJson, allAlbums, prodStyles, prodSizes, prodOptions, modal_view);

                             //if cross_sell - change title
                            if(isCrossSell) {
                                var recArea = $('#recommendationsArea');
                                var mgTitleAre = $('.sfly_wgt_listview_embedded_caption');
                                recArea.css('width', '980px');
                                recArea.css('height', '300px');
                                recArea.css('background-color', '#fff');
                                recArea.css('position', 'absolute');
                                //Change mg title
                                mgTitleAre.empty();
                                //mgTitleAre.text('Recommended for you');
                                //mgTitleAre.css('text-align', 'left');
                            }
                                d.resolve(true);
                            })
                            .fail(function () {
                                if(retry) {
                                    console.log('[Product Widget]> Failed loading resources (Api). Aborting.');
                                    productProxy.MgFail();
                                    renderMainTemplate();
                                    that.failWidget('horizontal', 'mg', 'mgv3', true);
                                } else {
                                    console.log('[Product Widget]> Failed loading resources (Api). Retrying with different source.');
                                }
                                d.reject();
                            });
                        return d.promise();
                    };

                    // get products from api. If fails the first time retry with a second source.
                    $.when(getProductsFromRank())
                        .fail(function(){
                            failId = currCallId;
                            currCallId++;
                            productJson = [];
                            getProductsFromRank(true);
                        });

                } else {
                    console.log('[Product Widget]> Failed loading resources. Aborting.');

                    productProxy.MgFail();
                    renderMainTemplate();
                    that.failWidget('horizontal', 'mg', 'mgv3', true);
                }
            });
        };

        return HorizontalFlexViewEngine;
    });

define('app/view_engine/widgets/engines/gifting/Engine',
    ['underscore', 'app/templates', 'mgthumb', 'app/asset_mapper', 'app/config_manager', 'app/click_through', 'app/tracking', 'app/cookies', 'magicselect', 'app/album_switch', 'app/product_proxy', 'app/utils', 'app/cache_module', 'app/view_engine/widgets/common', 'app/thumbgen_wrapper', 'app/time_monitor', 'app/view_engine/modals/shared', 'app/view_engine/widgets/engines/EngineHorizontal', 'css!./../../../../css/widget.css', 'css!./../../../../css/MagicSelectBox.css'],
    function(_, templates, mgthumb, AssetMapper, config, clickThrough, tracking, cookies, magicselect, albumSwitch, productProxy, utils, cache, view_common, thumbGenWrapper, monitor, modal_common, EngineHorizontal, css1, css2)
    {
        function GiftingViewEngine(params) {
            EngineHorizontal.call(this, params);

            this.LV_PROD_WIDTH           = 125;
            this.LV_PROD_HEIGHT          = 110;
            this.DESKTOP_PROD_WIDTH      = 190;
            this.DESKTOP_PROD_HEIGHT     = 170;
            this.MAX_LV_PRODS            = 4;
            this.PB_NUM_ALBUMS           = 2;
            this.PROD_NUM_ALBUMS         = 2;
            this.PRINTS_NUM_ALBUMS       = 2;
            this.CAL_NUM_ALBUMS          = 2;
            this.DISABLE_CLICK           = false;
            this.IS_WIDGET_OPEN          = {state:false};
            this.CURRENT_OPEN_PID        = null;
            this.IS_VIEW_DISABLED        = {state: false};
            this.ZOOM_LEVEL              = 1.05;
            this.ITEM_TOTAL_WIDTH        = 270;
            this.winHandler              = null;
            this.isAfterUPP              = false;
            this.isThisLifeGeneral       = false;
            this.mixedSourcesGeneral     = false;
            this.clickthroughNoModal     = true;
            this.isManual                = false;
            this.MOBILE_THRESHOLD        = 992;
            this.isMobile                = $(window).width() < this.MOBILE_THRESHOLD;
            this.MOBILE_NUM_PRODUCTS     = 24;

            this.isRendered              = false;
            this.isFirstRun              = true;

            this.prodPositions           = {};
            this.renderedProds           = {};
            this.SCROLL_VIEW_AREA        = 300;
            this.ACTUAL_PROD_HEIGHT      = 300; // assigned in CSS

            this.enableMove = function(container) {
                container.on('mousemove', function (event) {
                    if ($(this).parent().parent().hasClass('sfly-wgt-dont-act')) { // Not yet ready for action.
                        return;
                    }

                    var pages = $(this).attr('data-pages');
                    var rightPadding = parseFloat(($(this).attr('data-right')));
                    var boxWidth = $(this).width() - rightPadding;
                    var leftPadding = parseFloat(($(this).css('left')).replace("px", ""));

                    // Calc real position
                    var targetPos = $(event.currentTarget).offset();
                    var mousePos = {top: event.pageY, left: event.pageX};
                    var realPos = {top: mousePos.top - targetPos.top, left: mousePos.left - targetPos.left};

                    var currPage = Math.floor((realPos.left + leftPadding) * pages / boxWidth);

                    if (currPage < 0) {
                        currPage = 0;
                    } else if (currPage >= pages - 1) {
                        currPage = pages - 1;
                    }

                    $(this).find('canvas').hide();
                    $(this).find('canvas[data-order=' + currPage + ']').show();
                });
            };

            // Will calculate the right position of each product in the given container
            /*
             params:
             containerElement: The main container of the widget
             container: The container of the products, where you actually append the products
             */
            this.calcElementsPosition = function(params) {
                // containerElement, container, productJson, targetHeight, maxSpaceBetweenProds, sidePadding, prodSizes
                var products            = $(params.container).attr('data-pids').split(',');
                var productSizes        = this.calTotalProductsHeightByBoundingBox(products, params.productJson, this.getBoundingBox.bind(this), params.prodSizes);

                return {
                    sizes: productSizes.sizes
                };
            };

            // Define this function if you want custom bounding box for specific product
            this.getBoundingBox = function(pId) {
                return this.isMobile ? { height: this.LV_PROD_HEIGHT, width: this.LV_PROD_WIDTH } : { height: this.DESKTOP_PROD_HEIGHT, width: this.DESKTOP_PROD_WIDTH };
            };

            this.renderProducts = function(pId, productType, container, mgThumbGen, masks, onRenderedCallback) {

                var PRODUCT_PROJECTIONS = 5;

                // We need this function to keep the right order inside the generate function
                var generated = 0;
                function _generate(order) {
                    mgThumbGen.generate(parseInt(order), pId, true, function(canvas) {
                        $(canvas).attr('data-order', order).hide();
                        $(container).append(canvas);
                        generated++;

                        if(typeof(onRenderedCallback) !== "undefined" && _.isFunction(onRenderedCallback)){
                            if(generated == PRODUCT_PROJECTIONS -1) {
                                onRenderedCallback();
                            }
                        }
                    }, true, { masks: masks, textEnabled:(productType !== "book") });
                }

                if (!$(container).attr('data-rendered')) {
                    // Put this first - to block more attempts to render
                    $(container).attr('data-rendered', true);
                    var numOfPages = PRODUCT_PROJECTIONS;
                    $(container).attr('data-pages', PRODUCT_PROJECTIONS);

                    function generateWithTimeout(i) {
                        setTimeout(function(){ _generate(i); }, i*50);
                    }

                    for(var i = 1; i < numOfPages; i++) {
                        generateWithTimeout(i);
                    }
                }
            };

            // This is wrapped so we can add other actions on resize
            this.onContainerResize = function(containerElement, spreads, productJson, commonHeight, viewtype, MAX_SPACE_BETWEEN_PRODUCTS, side_padding, prodSizes) {
                this.isMobile = $(window).width() < this.MOBILE_THRESHOLD;
                this.findPositionProductsInSpreads({
                    container: containerElement,
                    spreads: spreads,
                    productJson: productJson,
                    targetHeight: commonHeight,
                    typeOfView: viewtype,
                    maxSpaceBetweenProds: MAX_SPACE_BETWEEN_PRODUCTS,
                    sidePadding: side_padding,
                    prodSizeZoomLevels: prodSizes,
                    calcElemPositionFunc: this.calcElementsPosition.bind(this)
                });

                if (this.isMobile) {
                    this.updateProductMargins(containerElement);
                }
            };

            this.updateProductMargins = function(containerElement) {
                var that = this;
                var products = $(containerElement).find('.sfly_wgt_product');
                _.each(products, function(prodContainer) {
                    var inner = $(prodContainer).children('.sfly_wgt_product_inner').first();
                    var diff = Math.floor(($(prodContainer).width() - that.ITEM_TOTAL_WIDTH) / 2);
                    $(inner).css('margin-left', diff + 'px');
                });
            };

            this.updateProductMargin = function(productContainer) {
                var inner = $(productContainer).children('.sfly_wgt_product_inner').first();
                var diff = Math.floor(($(productContainer).width() - this.ITEM_TOTAL_WIDTH) / 2);
                $(inner).css('margin-left', diff + 'px');
            };

            this.addProductPosition = function(pId, top, elem, position) {
                if (!this.prodPositions.hasOwnProperty(top)) {
                    this.prodPositions[top] = [];
                }

                this.prodPositions[top].push({
                    "elem": elem,
                    "sku": pId,
                    "position": position
                });
            };

            this.getElementsInViewArea = function(viewArea) {
                var elems = [];
                var that = this;
                Object.keys(this.prodPositions).forEach(function(pos) {
                    pos = parseInt(pos);
                    if (pos + that.ACTUAL_PROD_HEIGHT > viewArea.top && pos < viewArea.bottom) {
                        elems = elems.concat(that.prodPositions[pos]);
                    }

                    if (pos > viewArea.bottom) {
                        return elems;
                    }
                });

                return elems;
            };

            this.getCurrentViewArea = function(padding, model) {
                padding = padding || 0;
                var ctr = $(model.get('container')).find('.sfly_wgt_listview_container');
                var scrollTop = $(ctr).scrollTop();
                try {
                    scrollTop = Number.isNaN(Number(scrollTop)) ? 0 : scrollTop;
                } catch(e) {
                    //support for IE and other browsers which doesnot support Number.isNan
                    scrollTop =  (typeof(Number(scrollTop)) === 'number' && isNaN(Number(scrollTop))) ? 0 : scrollTop;
                }

                return {
                    "top": scrollTop - padding,
                    "bottom": scrollTop + $(ctr).height() + padding
                }
            };

            this.showVisibleProducts = function(visibleElems, renderCallback) {
                visibleElems.forEach(function(elem) {
                    if (typeof elem !== 'undefined' && elem !== null) { // FOR IE11
                        setTimeout(function ()
                        {
                            renderCallback(elem.sku, elem.position);
                        }, 0);
                    }
                });
            };

            this.bindProductScroll = function(renderCallback) {
                var that = this;

                function onScroll() {
                    if (!utils.isIE()) {
                        this.showVisibleProducts(this.getElementsInViewArea(this.getCurrentViewArea(this.SCROLL_VIEW_AREA, this.Model)), renderCallback);
                    }
                }

                $(this.Model.get('container')).find('.sfly_wgt_listview_container').on('scroll', _.debounce(onScroll.bind(that), 100));
            };

            // Will render the ListView products in the given @containerElement
            this.renderView = function(containerElement, products, productJson, albums, prodStyles, prodSizes, prodOptions, modal, instance) {
                var SIDE_PAD                    = 65;
                var SIDE_PAD_SMALL              = 50;
                var MAX_SPACE_BETWEEN_PRODUCTS  = 80;
                var zoomLevelDownsize           = 0.6;
                var SPACE_FROM_TOP              = 20;
                var that                        = this;

                /* === HELPER ==== */

                // Will get and position the price for the given product (@pId)
                function updateProductPrice(container, productJson, pId, targetSize) {
                    var MOVE_DOWN_PX        = 25;
                    var product             = view_common.getProduct(pId);
                    var size                = view_common.getProductRealSize(productJson, pId);

                    var title               = "";
                    // if we have title for the recipe use it otherwise use the one from the sku file
                    if(typeof prodOptions !== "undefined" && typeof prodOptions[pId] !== "undefined" && typeof prodOptions[pId]['title'] !== "undefined") {
                        title = prodOptions[pId]['title'];
                    } else {
                        title = product['type'] == 'photobook' ? product['size'] + ' Photo book' : product['title'];
                    }

                    var price               = config.isPricesLoaded() ? config.getPrice(product['sflySku']) : null;
                    var elem                = $(view_common.renderTemplate(templates.listview_prod_price, {
                        title: title,
                        price: price,
                        price_template: _.template(templates.listview_pprice_inr),
                        coupon: typeof cache.getCoupon() !== "undefined" ? cache.getCoupon().name : false
                    }));
                    var ratio               = targetSize.ratio;
                    var productCenter       = (size.left + (size.width)/2);
                    var priceCenter         = 80;   //size.width/2;   <--- The price has a fixed size of 160px
                    var move_x              = (productCenter*ratio - priceCenter);
                    var move_x_zoomedout    = (productCenter*ratio*zoomLevelDownsize - priceCenter);
                    var move_x_zoomedin     = (productCenter*ratio*that.ZOOM_LEVEL - priceCenter);
                    var top                 = targetSize.height + size.top*ratio + MOVE_DOWN_PX;

                    if (typeof cache.getCoupon() !== "undefined"){
                        top -= 6;
                    }

                    var topZoomedIn         = top + size.height * ratio * (that.ZOOM_LEVEL-1)/2; //top*(1+(ZOOM_LEVEL-1)/2);

                    elem
                        .css('position', 'absolute')
                        .css('bottom', that.isMobile ? '10px' : '55px')
                        .css('margin', '0')
                        .css('width', '100%')
                        .attr('data-top', top)
                        .attr('data-left', move_x)
                        .attr('data-price-center', move_x)
                        .attr('data-price-zoom-center', move_x_zoomedout)
                        .attr('data-price-zoomin-center', move_x_zoomedin)
                        .attr('data-price-top-zoomin', topZoomedIn);

                    $(container).append(elem);

                    // add hover box
                    var hover = $(view_common.renderTemplate(templates.fullview_prod_hover_tl, { productType: product['type'], clickthroughNoModal: that.clickthroughNoModal }));
                    $(container).append(hover);

                    return top;
                }

                function renderThumb(pId, productType, partnerId, product, layoutJson, designJson, position, productGenerateCallBack, layoutMasks, promiseToResolve) {
                    var useCDN = cache.get('env') != 'beta' && cache.get('env') != 'dev';
                    var mgThumbGen  = new MgThumbGenerator(cache.get('env'),useCDN);

                    mgThumbGen.init(productType, partnerId, product, layoutJson, designJson, that.Model.get('monitoring').reportEvent, cache.get('env'));

                    var j = position;

                    that.Model.get('monitoring').eventStart('tl:Generate:' + pId);
                    var thumbPage = 0;
                    if((that.Model.get('prod_type') == "photobook" || that.Model.get('prod_type') == 'photobook_share') && productType == "book"){
                        var product = view_common.findProjectJsonProduct(productJson, pId);
                        var photosRefIds = {};
                        $.each(product.book.pages, function(i, cPage){
                            $.each(cPage.canvas.layout.photos, function(j, cPhoto) {
                                photosRefIds[cPhoto.photoRefId] = 1;
                            });
                        });

                        thumbPage = Object.keys(photosRefIds).length > 1 ? 2 : 1;
                    }
                    mgThumbGen.generate(parseInt(thumbPage), pId, true, function(canvas) {
                        that.renderedProds[pId] = true;
                        that.Model.get('monitoring').eventEnd('tl:Generate:' + pId);
                        view_common.removeLoading(that.Model.get('container'));
                        var elem = $(view_common.renderTemplate(templates.fullview_product, { pid: pId, sku: view_common.getProduct(pId)['sflySku'], ptype: productType }));
                        $(canvas).attr('data-order', thumbPage);
                        elem
                            .addClass('order_' + j)
                            .attr('data-order', j)
                            .children('.sfly_wgt_product_inner')
                            .html(canvas)
                            .addClass('order_' + j);

                        $(containerElement).find('.sfly_wgt_item_placeholder.p_' + pId).css('visibility', 'hidden');
                        var spread = $(containerElement).find('.sfly_wgt_listview_spread');

                        var productInner = elem.children('.sfly_wgt_product_inner');
                        elem.attr('data-spread-order', $(spread).attr('data-order'));
                        if(spread.find('.sfly_wgt_product.order_' + j).length > 0){
                            spread.find('.sfly_wgt_product.order_' + j).replaceWith(elem);
                        } else {
                            spread.append(elem);
                        }

                        //that.addProductPosition(pId, $(elem).position().top, elem);

                        // if is a rotatable render it and bind mousemove action
                        if(view_common.isProductRotatable(productType) && !that.isMobile) {
                            var newRotation  = that.enableMove.bind(that, productInner);
                            setTimeout(function() {
                                that.renderProducts(pId, productType, productInner, mgThumbGen, layoutMasks, newRotation);
                            }, 1000);
                        }

                        // photobook modal only
                        if(that.Model.get('prod_type') == "photobook" &&  productType == "book") {
                            elem.parent().css('width', 'auto');
                            elem.css('width', '70%')
                                .css('top', '50px')
                                .css('cursor', 'default');
                            $(canvas).css('cursor', 'pointer');
                            updateProductPrice(elem, productJson, pId, prodPosAndSize.sizes[pId]);
                            elem.find('.sfly_wgt_product_price')
                                .css('left','auto')
                                .css('right','-198px')
                                .css('top','175px');
                            elem.append("<div class='sfly-wgt-tl-create-photobook'><div class='sfly-wgt-tl-orange-btn'>See more styles</div></div>");
                            elem.find('.sfly-wgt-tl-create-photobook')
                                .css('position', 'absolute')
                                .css('top', '80px');
                            if (elem.parent().width() <= 600) {
                                elem.css('left', '90px');
                                elem.find('.sfly_wgt_product_price')
                                    .css('right','127px')
                                    .css('top','210px');
                                elem.find('.sfly-wgt-tl-create-photobook')
                                    .css('top', '120px')
                                    .css('right', '327px');
                            }

                            var openBookModal = function() {
                                if (!that.isLocked()) {
                                    that.takeLock();

                                    var currAlbums = albums.photobook;
                                    var currAlbum = currAlbums[0];

                                    var callbacks = {
                                        takeLock: that.takeLock.bind(that),
                                        releaseLock: that.releaseLock.bind(that),
                                        animateControlButton: undefined,
                                        changeState: that.changeWidgetOpenState.bind(this, that.IS_WIDGET_OPEN),
                                        handleCurrentPid: undefined,
                                        toggleViewDisable: that.toggleViewDisable.bind(this, that.IS_VIEW_DISABLED)
                                    };

                                    var modalCallback = modal.show.bind(this, {
                                        pId: elem.attr('data-pid'),
                                        currPid: that.CURRENT_OPEN_PID,
                                        currAlbum: currAlbum,
                                        albums: currAlbums,
                                        prodStyles: prodStyles,
                                        prodOptions: prodOptions,
                                        forceCloseExternal: false,
                                        widgetIsOpen: that.IS_WIDGET_OPEN.state,
                                        isThisLife: that.isThisLifeGeneral,
                                        mixedSources: that.mixedSourcesGeneral,
                                        callbacks: callbacks,
                                        instance: instance,
                                        model: that.Model
                                    });

                                    that.openBookModal({
                                        pId: elem.attr('data-pid'),
                                        widgetType: 'gifting',
                                        elem: elem,
                                        albums: albums,
                                        containerElement: containerElement,
                                        widgetState: that.IS_WIDGET_OPEN.state,
                                        instance: instance,
                                        clickthroughNoModal: that.clickthroughNoModal,
                                        winHandler: winHandler,
                                        productJson: productJson,
                                        productType: productType,
                                        clickThrough: clickThrough,
                                        modalCallback: modalCallback
                                    });
                                }
                            };

                            elem.find('.sfly-wgt-tl-orange-btn').on('click', function(){ openBookModal() });
                            $(canvas).on('click', function(){ openBookModal() });
                        } else if (productType == "prints") {
                            elem.parent().css('width', '100%').css('height', '100%');
                            elem.css('width', '320px')
                                .css('top', '50px')
                                .css('cursor', 'default')
                                .css('left', '70px');
                            $(canvas).css('cursor', 'pointer');
                            updateProductPrice(elem, productJson, pId, prodPosAndSize.sizes[pId]);
                            elem.find('.sfly_wgt_product_price')
                                .css('left','auto')
                                .css('right','-250px')
                                .css('top','160px');
                            elem.append("<div class='sfly-wgt-tl-create-prints'><div class='sfly-wgt-tl-orange-btn'>Order Prints</div></div>");
                            elem.find('.sfly-wgt-tl-create-prints')
                                .css('position', 'absolute')
                                .css('top', '65px')
                                .css('right', '-50px');

                            function doClickThrough() {
                                if (that.Model.get('openInNewWindow')) {
                                    that.winHandler = view_common.openNewWindow(that.winHandler);

                                    if (!that.IS_WIDGET_OPEN.state) {
                                        view_common.removeLoading($('.sfly_wgt_listview_container'));
                                    }
                                } else {
                                    that.winHandler = null;
                                }

                                var albumResult  = that.getCurrentAlbum(pId, albums); //currAlbums[currItemOrder % currAlbums.length];
                                var currAlbum    = albumResult.currAlbum;
                                var photoIds     = that.getPhotoIdsForPrints(productJson, $(this).attr('data-pid'), isAfterUPP, currAlbum, false);

                                clickThrough.sendForSeeAll(photoIds, view_common.showLoading.bind(this, $('.sfly_wgt_listview_container')), view_common.removeLoading.bind(this, $('.sfly_wgt_listview_container')), currAlbum, that.winHandler, that.Model);
                                that.Model.get('callback')({action: 'hide_window'});}

                            elem.find('.sfly-wgt-tl-orange-btn').on('click', function(){ doClickThrough() });
                            $(canvas).on('click', function(){ doClickThrough() });
                        }
                        else    //all the others
                        {
                            var SPACE_FROM_BOTTOM = 95;
                            var SPACE_FROM_BOTTOM_MOBILE = 50;
                            view_common.updateProductSize(elem, commonWidth, pId, productJson, prodPosAndSize.sizes);
                            var pSize           = view_common.getProductRealSize(productJson, pId);
                            var priceTop        = updateProductPrice(elem, productJson, pId, prodPosAndSize.sizes[pId]);
                            var productRatio    = prodPosAndSize.sizes[pId].ratio;
                            var topPos          = SPACE_FROM_TOP - pSize.top * productRatio;
                            var bottomPos       = (that.isMobile ? SPACE_FROM_BOTTOM_MOBILE : SPACE_FROM_BOTTOM) - pSize.bottom * productRatio;
                            var productInner    = elem.children('.sfly_wgt_product_inner');

                            // compute center
                            var fromLeft = ((that.ITEM_TOTAL_WIDTH - pSize.width * productRatio) / 2) - pSize.left * productRatio;

                            productInner.css('position', 'absolute')
                                .css('left', fromLeft+'px')
                                .css('bottom', bottomPos+'px');

                            var hoverElem = elem.find(".sfly_wgt_product_hover");
                            productInner.attr('data-pricetop', priceTop);

                            // Calculate target position and size of the product
                            var pTargetSize = elem.width() * that.ZOOM_LEVEL;

                            // Sometimes, in ThisLife, the widget will get a bad size - we want to mark it
                            if (pTargetSize == 0) {
                                $(containerElement).parent().attr('data-renderfor', 0);
                            }

                            elem
                                .off()
                                .on('click', function () {
                                    if (!that.isLocked()) {
                                        that.takeLock();

                                        var currItemOrder = $(this).attr('data-order') - 1; // order is "1" based, albums is "0" based
                                        var albumResult = that.getCurrentAlbum(pId, albums); //currAlbums[currItemOrder % currAlbums.length];
                                        var currAlbum = albumResult.currAlbum;
                                        var currAlbums = albumResult.currAlbums;

                                        // Add Opacity to other products
                                        $('.sfly_wgt_product').addClass('not-selected');
                                        that.removeHoverStates(containerElement);

                                        if (!that.IS_WIDGET_OPEN.state) {
                                            view_common.showLoading($('.sfly_wgt_listview_container'));
                                        }

                                        tracking.track('tl', 'click', {
                                            sku: $(this).attr('data-sku'),
                                            order: currItemOrder,
                                            mode: 'gifting',
                                            prod_type: that.Model.get('prod_type')
                                        });
                                        tracking.track('tl', 'hover', {
                                            sku: $(this).attr('data-sku'),
                                            order: currItemOrder,
                                            mode: 'gifting',
                                            prod_type: that.Model.get('prod_type')
                                        });

                                        var callbacks = {
                                            takeLock: that.takeLock.bind(that),
                                            releaseLock: that.releaseLock.bind(that),
                                            animateControlButton: undefined,
                                            changeState: that.changeWidgetOpenState.bind(this, that.IS_WIDGET_OPEN),
                                            handleCurrentPid: undefined,
                                            toggleViewDisable: that.toggleViewDisable.bind(this, that.IS_VIEW_DISABLED)
                                        };

                                        if ($(this).attr('data-pid') == 'prints_4x6') {
                                            var product = view_common.findProjectJsonProduct(productJson, $(this).attr('data-pid'), isAfterUPP);
                                            var photoIds = that.thumbRenderPreparePhotoIds(product, currAlbum, isAfterUPP, false);

                                            if (that.Model.get('openInNewTab')) {
                                                that.winHandler = view_common.openNewWindow(that.winHandler);

                                                if (!that.IS_WIDGET_OPEN.state) {
                                                    view_common.removeLoading($('.sfly_wgt_listview_container'));
                                                }
                                            } else {
                                                that.winHandler = null;
                                            }

                                            clickThrough.sendForSeeAll(photoIds, view_common.showLoading.bind(this, $('.sfly_wgt_listview_container')), view_common.removeLoading.bind(this, $('.sfly_wgt_listview_container')), currAlbum, that.winHandler);
                                            that.Model.get('callback')({action: 'hide_window'});
                                        } else {
                                            if (that.clickthroughNoModal || that.isMobile) {
                                                if (that.Model.get('openInNewTab')) {
                                                    that.winHandler = view_common.openNewWindow(that.winHandler);

                                                    if (!that.IS_WIDGET_OPEN.state) {
                                                        view_common.removeLoading($('.sfly_wgt_listview_container'));
                                                    }
                                                } else {
                                                    that.winHandler = null;
                                                }

                                                var prod = view_common.getProduct(pId);
                                                var pJson = view_common.findProjectJsonProduct(productJson, pId, !that.isFirstRun);
                                                clickThrough.sendToClickThrough(pJson, productType, null, null, currAlbum, that.winHandler, that.Model, prod.personalizeUrl);

                                            } else {
                                                modal.show({
                                                    pId: elem.attr('data-pid'),
                                                    currPid: that.CURRENT_OPEN_PID,
                                                    currAlbum: currAlbum,
                                                    albums: currAlbums,
                                                    prodStyles: prodStyles,
                                                    prodOptions: prodOptions,
                                                    forceCloseExternal: false,
                                                    widgetIsOpen: that.IS_WIDGET_OPEN.state,
                                                    isThisLife: that.isThisLifeGeneral,
                                                    mixedSources: that.mixedSourcesGeneral,
                                                    callbacks: callbacks,
                                                    instance: instance,
                                                    model: that.Model
                                                });
                                            }
                                        }
                                    }
                                })
                                .on('mouseenter', function () {
                                    // Check that a product is not selected
                                    if (!that.IS_WIDGET_OPEN.state) {
                                        $(this).parent().children().addClass('on-hover-other');
                                        $(this).removeClass('on-hover-other').addClass('on-hover');
                                    }

                                    if (!that.isMobile) {
                                        hoverElem.show();
                                    }
                                })
                                .on('mouseleave', function () {
                                    if (!that.isMobile) {
                                        hoverElem.hide();
                                    }
                                });

                        }

                        that.updateProductMargin.call(that, elem);

                        if (typeof promiseToResolve !== 'undefined') {
                            promiseToResolve.resolve();
                        }

                        if(_.isFunction(productGenerateCallBack)){
                            productGenerateCallBack(j);
                        }
                    }, true, { masks: layoutMasks, textEnabled:(productType !== "book") });
                }

                function addProductContainers(containerElement, howMany) {
                    var spreads = $(containerElement).find('.sfly_wgt_listview_spread');

                    _.each(spreads, function(spread) {
                        var pids = $(spread).attr('data-pids').split(',');
                        var order = 1;
                        if ($(spread).find('.sfly_wgt_product').length == 0) {
                            _.first(pids, howMany).forEach(function(pid)
                            {
                                var elem = $('<div class="sfly_wgt_product sfly_wgt_product_placeholder order_' + order + '"></div>');
                                $(spread).append(elem);
                                that.addProductPosition(pid, elem.position().top, elem, order);
                                order++;
                            });
                        }
                    });

                    that.Model.get('callback')({action: 'finished_view_render'});
                }

                function renderProduct(productJson, sku, position) {
                    if (that.renderedProds[sku]) {
                        console.log('[Product Widget] Product already rendered');
                        return;
                    }

                    var product = view_common.findProjectJsonProduct(productJson, sku, true);
                    var productType = AssetMapper.GetProductType(product);
                    var partnerId = AssetMapper.GetPartnerId(product, productType);
                    var prodSku = productType != 'book' ? view_common.getProduct(sku)['sku'] : view_common.getProduct(sku)['style'] + '_' + view_common.getProduct(sku)['size'];

                    var prodPromise = $.Deferred();
                    // Prints and Calendar will still be using the embedded JSONs. Also anything that is not supported now.
                    if (productType == 'prints') {
                        var layoutJson = JSON.stringify(config.getRecipeLayout()[partnerId]);
                        var designJson = JSON.stringify(config.getRecipeDesign()[partnerId]);
                        renderThumb(sku, productType, partnerId, product, layoutJson, designJson, position, undefined, undefined, prodPromise);
                    } else {
                        // todo: if thumb already was requested before - don't request again!
                        that.Model.get('monitoring').eventStart('tl:prepareThumbGenAssets:' + sku);
                        thumbGenWrapper.prepareThumbGenAssets(prodSku, sku, 'medium', productType, product, function (result) {
                            that.Model.get('monitoring').eventEnd('tl:prepareThumbGenAssets:' + sku);

                            if (result == null || typeof result.layoutJson === 'undefined' || typeof result.designJson === 'undefined') {
                                products.sku = null;
                                prodPromise.resolve();
                                console.log('[Product Widget] Missing Layout / Design json');
                                return;
                            }

                            if (productType == 'book') {
                                layoutJson = JSON.stringify(result.layoutJson[sku]);
                            } else {
                                layoutJson = JSON.stringify(result.layoutJson);
                            }

                            designJson = JSON.stringify(result.designJson);

                            renderThumb(sku, productType, partnerId, product, layoutJson, designJson, position, undefined, result.layoutMasks, prodPromise);
                        });
                    }

                    return prodPromise;
                }

                function renderChunk(skusToRender, chunkSize, fullRenderPromise, count, callbackRender) {
                    var chunk       = _.first(skusToRender, chunkSize);
                    var restChunks  = _.rest(skusToRender, chunkSize);

                    // make download queue
                    skusToRender.forEach(function(sku) {
                        var product     = view_common.findProjectJsonProduct(productJson, sku, true);
                        var productType = AssetMapper.GetProductType(product);
                        that.Model.get('downloadQueue').addProduct(product, that.Model.get('downloadQueue').PRIORITY.HIGH);
                        that.renderedProds[sku] = false;
                    });

                    that.Model.get('downloadQueue').startDownload();

                    var renderCallback = renderProduct.bind(that, productJson);
                    that.bindProductScroll(renderCallback);
                    fullRenderPromise.resolve();

                    if (utils.isIE()) {
                        console.log('[Product Widget] Special treatment for IE11');
                        var idx = 1;
                        skusToRender.forEach(function (sku)
                        {
                            renderCallback(sku, idx);
                            idx++;
                        });
                    } else {
                        that.showVisibleProducts(that.getElementsInViewArea(that.getCurrentViewArea(that.SCROLL_VIEW_AREA, that.Model)), renderCallback);
                    }

                    //var allProductsPromises =  [];
                    //
                    //_.each(chunk, function (sku) {
                    //    allProductsPromises.push(renderProduct(productJson, sku, count));
                    //
                    //    count++;
                    //}, this);
                    //
                    //$.when.apply(undefined, allProductsPromises).then(function() {
                    //    if(restChunks.length > 0) {
                    //        callbackRender(restChunks, chunkSize, fullRenderPromise, count, renderChunk);
                    //    } else {
                    //        fullRenderPromise.resolve();
                    //        that.bindProductScroll();
                    //    }
                    //});
                }

                /* === END HELPER ==== */

                var commonWidth         = that.LV_PROD_WIDTH;
                var commonHeight        = that.LV_PROD_HEIGHT;
                var spreadResult        = that.prepareSpreads(products, 'listview', products.length);
                var spreads             = spreadResult.spreads;
                var side_padding        = spreads.children('.sfly_wgt_listview_spread').length > 1 ? SIDE_PAD : SIDE_PAD_SMALL;
                var prodPosAndSize      = that.findPositionProductsInSpreads({
                    container: containerElement,
                    spreads: spreads,
                    productJson: productJson,
                    targetHeight: commonHeight,
                    typeOfView: 'listview',
                    maxSpaceBetweenProds: MAX_SPACE_BETWEEN_PRODUCTS,
                    sidePadding: side_padding,
                    prodSizeZoomLevels: prodSizes,
                    calcElemPositionFunc: that.calcElementsPosition.bind(that)
                });

                if ($(containerElement).find('.sfly_wgt_listview_spread_container').length == 0) {
                    $(containerElement)
                        .append(spreads)
                        .parent()
                        .attr('data-renderfor', $(containerElement).width());
                }

                // Need to update the height
                $(window).on('resize.mg_gifting', _.debounce(that.onContainerResize.bind(this, containerElement, spreads, productJson, commonHeight, 'listview', MAX_SPACE_BETWEEN_PRODUCTS, side_padding, prodSizes), 200));

                that.updateCssForSpreads(containerElement, 'listview');
                view_common.removeLoading($('.sfly_wgt_listview_container'));

                var batchProduct = 0;
                var numProdToSplit = products.length < batchProduct ? products.length : batchProduct;

                if(numProdToSplit < batchProduct){
                    $(containerElement).find('.p_').remove();
                    spreads.css("text-align", "center");
                    spreads.children('.sfly_wgt_listview_spread').css("position", "relative").css("display","inline-block");
                }

                // if we're on mobile, we want less products
                var productsToRender = products.length - numProdToSplit;
                if (that.isMobile && productsToRender > that.MOBILE_NUM_PRODUCTS) {
                    productsToRender = that.MOBILE_NUM_PRODUCTS;
                }

                addProductContainers(containerElement, productsToRender);

                var fullRender =  $.Deferred();
                var chunkSize = that.isMobile ? 4 : 8;

                renderChunk(_.first(products, productsToRender), chunkSize, fullRender, 1, renderChunk);

                $.when(fullRender).then(function() {
                    // Remove placeholders if there are any and we're on mobile
                    if (that.isMobile) {
                        $(containerElement).find('.sfly_wgt_product_placeholder').remove();
                    }

                    that.loadPrices(containerElement, products);
                    that.Model.get('monitoring').eventEnd('tl:Start');
                });
            }
        }

        utils.inheritPrototype(GiftingViewEngine, EngineHorizontal);

        GiftingViewEngine.prototype.render = function(params) {
            var source          = params.source;
            var prodStyles      = params.prodStyles;
            var prodSizes       = params.prodSizes;
            var prodOptions     = params.prodOptions;
            var showMessage     = params.showMessage;
            var modal_view      = params.modalView;
            var instance        = params.instance;
            var renderParams    = params.renderParams;
            var that            = this;

            if (!utils.browserSupported()){
                that.failWidget('gifting', 'tl', 'tl');
                return;
            }

            var ctr = that.Model.get('container');

            // TODO - remove it for Roman :-)
            this.Model.set('interceptSource', "sflyphotos/gifting/autoselect");

            //add gifting text values
            var giftingMode = this.Model.get('mode');

            if (giftingMode == 'gifting') {
                window.MagicShop.AddressLabel = { gift_family_member : "mom", gift_family_member_nick : "MOM" };
            } else if (giftingMode == 'gifting_gm') {
                window.MagicShop.AddressLabel = { gift_family_member : "grandma", gift_family_member_nick : "NANA" };
            } else if (giftingMode == 'gifting_father') {
                window.MagicShop.AddressLabel = { gift_family_member : "dad", gift_family_member_nick : "DAD" };
            } else if (giftingMode == 'gifting_grandpa') {
                window.MagicShop.AddressLabel = { gift_family_member : "grandpa", gift_family_member_nick : "GRANDPA" };
            }


            that.Model.get('monitoring').eventStart('tl:Start');
            //that.Model.get('monitoring').eventStart('tl:on_first_product_load_Start');


            // A "fast lane" for rendering
            if (this.isRendered) {
                var productJsonNew = [];

                function _getProductJsonNew(pJson) {
                    if (pJson != null) {
                        productJsonNew = productJsonNew.concat(pJson);
                    }
                }

                var newAlbum = {
                    albumId: String.fromCharCode(65 + Math.floor(Math.random() * 26)) + Date.now(),
                    photos: renderParams['photos']
                };

                this.isFirstRun = false;

                $.when(
                    productProxy.getPhotobook(newAlbum, 40, _getProductJsonNew, false, true, source, true, false, true),
                    productProxy.getProducts(newAlbum, _getProductJsonNew, true, source, true, true, false, true),
                    productProxy.getPrints(newAlbum, _getProductJsonNew, true, source, true, false, true),
                    productProxy.getCalendar(newAlbum, _getProductJsonNew, true, source, true, false, true)
                )
                    .then(function ()
                    {
                        var allAlbums = {
                            'photobook': [renderParams['photos']],
                            'products': [renderParams['photos']],
                            'prints': [renderParams['photos']],
                            'calendars': [renderParams['photos']]
                        };
                        renderMainTemplate();
                        $(ctr).find('.sfly_wgt_listview_container').find('.sfly_wgt_product').addClass('sfly_wgt_product_placeholder').html('');
                        this.renderView($(ctr).find('.sfly_wgt_listview_container'), source, productJsonNew, allAlbums, prodStyles, prodSizes, prodOptions, modal_view, instance);
                    })
                    .fail(function ()
                    {
                        view_common.removeLoading($('.sfly_wgt_listview_container'));
                    });
                return;
            }


            this.isRendered = true;


            var useThesePhotos = undefined;
            if(typeof renderParams !== "undefined") {
                useThesePhotos  = renderParams['photos'];

                if(typeof renderParams['manualSelect'] !== "undefined"){
                    this.isManual = renderParams['manualSelect'];
                }
            }

            this.init();

            // do not render template until we have mgsources
            function renderMainTemplate(showLoader) {
                showLoader = typeof showLoader !== "undefined" ? showLoader : true;
                $(ctr).html(view_common.renderTemplate(templates.listview_gifting));

                if(showLoader) {
                    // Animate the appearance of the temp boxes
                    var boxes = $(ctr).find('.sfly_wgt_item_placeholder');
                    var itr = 0;
                    _.each(boxes, function (box) {
                        setTimeout(function () {
                            $(box).css('display', 'inline-block');
                        }, itr * 300);
                        itr++;
                    });
                }
            }

            // Remove classes added on hover on product
            $(ctr).on('mouseleave', function() {
                that.removeHoverStates(this);
            });

            if (typeof showMessage !== 'undefined' && showMessage != null) {
                renderMainTemplate(source);
                that.horizontalShowOverlayView(showMessage, this.IS_VIEW_DISABLED.state, instance);
                return;
            }

            var failId = 0;
            var currCallId = 1;
            var productJson = [];
            function _getProductJson(callId, pJson) {
                if (pJson != null && callId != failId) {
                    productJson = productJson.concat(pJson);
                }
            }

            // Check what kind of products is this and ask for MG Source accordingly
            var getPrints   = 0;
            var getProducts = 0;
            var getBooks    = 0;
            var getCalendar = 0;

            _.each(source, function(pId) {
                var product = view_common.getProduct(pId);
                switch(product.type) {
                    case 'prints':
                        getPrints = this.PRINTS_NUM_ALBUMS;
                        break;
                    case 'photobook':
                        getBooks = this.PB_NUM_ALBUMS;
                        break;
                    case 'calendar':
                    case 'deskcalendar':
                        getCalendar = this.CAL_NUM_ALBUMS;
                        break;
                    default:
                        getProducts = this.PROD_NUM_ALBUMS;
                        break;
                }
            });

            // function for get from rankservice the project jsons and pass call the render method
            function getRankSourcesAndRender(albums, instance, isFullPhotoData){
                var isFullPhotoData = isFullPhotoData || false;
                that.Model.get('monitoring').eventStart('tl:getRankService');
                var getProductsFromRank = function(retry) {

                    var d = $.Deferred();

                    var allAlbums = that.formatAllAlbums(albums, retry);

                    // Check if we have enough products to create using the albums we got.
                    // We pass 100 as num of photos as we don't want to cut it
                    var cleanSource = that.cleanSourceWithAlbums(source, allAlbums, 100, true);

                    // if less than 3 products do not render mg
                    if (cleanSource.length < 1) {
                        console.log('[Product Widget]> Not enough resources for render.');
                        renderMainTemplate(false);
                        that.horizontalShowOverlayView('upload', that.IS_VIEW_DISABLED.state, instance);
                        d.resolve(true);
                        return;
                    }

                    var albumsToSendToRank = _.clone(allAlbums);
                    if(isFullPhotoData){
                        this.isAfterUPP = true;
                        albumsToSendToRank['photobook'] = allAlbums['photobook'][0];
                        albumsToSendToRank['products'] = allAlbums['products'][0];
                        albumsToSendToRank['prints'] = allAlbums['prints'][0];
                        albumsToSendToRank['calendars'] = allAlbums['calendars'][0];
                    }

                    var photobookOnlyCover = false; //(instance.settings['prod_type'] == "photobook" || instance.settings['prod_type'] == "photobook_share") ? false : true;

                    $.when(
                        productProxy.getPhotobook(albumsToSendToRank['photobook'], 40, _getProductJson.bind(this, currCallId), photobookOnlyCover, that.isManual, cleanSource, true, false, true),
                        productProxy.getProducts(albumsToSendToRank['products'], _getProductJson.bind(this, currCallId), that.isManual, cleanSource, true, true, false, true),
                        productProxy.getPrints(albumsToSendToRank['prints'], _getProductJson.bind(this, currCallId), that.isManual, cleanSource, true, false, true),
                        productProxy.getCalendar(albumsToSendToRank['calendars'], _getProductJson.bind(this, currCallId), that.isManual, cleanSource, true, false, true)
                    )
                        .then(function () {
                            that.Model.get('monitoring').eventEnd('tl:getRankService');
                            renderMainTemplate(true, cleanSource);
                            that.renderView($(ctr).find('.sfly_wgt_listview_container'), cleanSource, productJson, allAlbums, prodStyles, prodSizes, prodOptions, modal_view, instance);
                            d.resolve(true);
                        })
                        .fail(function () {
                            if(retry) {
                                console.log('[Product Widget]> Failed loading resources (Api). Aborting.');
                                productProxy.MgFail();
                                renderMainTemplate();
                                that.failWidget('gifting', 'tl', 'tl');
                            } else {
                                console.log('[Product Widget]> Failed loading resources (Api). Retrying with different source.');
                            }
                            d.reject();
                        });
                    return d.promise();
                };

                // get products from api. If fails the first time retry with a second source.
                $.when(getProductsFromRank())
                    .fail(function(){
                        failId = currCallId;
                        currCallId++;
                        productJson = [];
                        getProductsFromRank(true);
                    });
            }

            // render magic shop using some specific photos otherwise call getMgSource
            // This is for TL
            if(typeof useThesePhotos !== "undefined" && _.isArray(useThesePhotos)){
                var albumId = String.fromCharCode(65 + Math.floor(Math.random() * 26)) + Date.now();
                var album = { albumId: albumId, photos: useThesePhotos };
                var albums = {
                    photobooks: [album],
                    products: [album],
                    prints: [album],
                    calendars: [album]
                };
                this.inThisLife = true;
                cache.removeProductsAll();
                getRankSourcesAndRender(albums, instance, true);
            } else {
                // we have a 2 step process for displaying the widget
                // 1. Get the photos and albums for the user
                // 2. Get the covers for the albums
                that.Model.get('monitoring').eventStart('tl:getMgSource');
                productProxy.getMGSources(function(albums) {
                    that.Model.get('monitoring').eventEnd('tl:getMgSource');
                    if (albums != null) {
                        if (_.isEmpty(albums)) {
                            // Not enough sources. Show overlay and exit.
                            renderMainTemplate(false);
                            that.horizontalShowOverlayView('upload',that.IS_VIEW_DISABLED.state, instance);
                            return;
                        }
                        getRankSourcesAndRender(albums, instance);
                    } else {
                        console.log('[Product Widget]> Failed loading resources. Aborting.');
                        productProxy.MgFail();
                        renderMainTemplate();
                        that.failWidget('gifting', 'tl', 'tl');
                    }
                });
            }
        };

        return GiftingViewEngine;
    });

define('app/view_engine/widgets/engines/tl_horizontal/Engine',
    ['underscore', 'app/templates', 'mgthumb', 'app/asset_mapper', 'app/config_manager', 'app/click_through', 'app/tracking', 'app/cookies', 'magicselect', 'app/album_switch', 'app/product_proxy', 'app/utils', 'app/cache_module', 'app/view_engine/widgets/common', 'app/view_engine/modals/shared', 'app/scroller', 'app/thumbgen_wrapper', 'app/time_monitor', 'app/view_engine/widgets/engines/EngineHorizontal', 'css!./../../../../css/widget.css', 'css!./../../../../css/MagicSelectBox.css'],
    function(_, templates, mgthumb, AssetMapper, config, clickThrough, tracking, cookies, magicselect, albumSwitch, productProxy, utils, cache, view_common, modal_common, scroller, thumbGenWrapper, monitor, EngineHorizontal, css1, css2)
    {

            function TLHorizontalViewEngine(params) {

            EngineHorizontal.call(this, params);

            this.LV_PROD_WIDTH = 110;
            this.LV_PROD_HEIGHT = 135;
            this.MAX_LV_PRODS = 4;
            this.PB_NUM_ALBUMS = 2;
            this.PROD_NUM_ALBUMS = 2;
            this.PRINTS_NUM_ALBUMS = 2;
            this.CAL_NUM_ALBUMS = 2;
            this.DISABLE_CLICK = false;
            this.IS_WIDGET_OPEN = {state: false};
            this.CURRENT_OPEN_PID = null;
            this.IS_VIEW_DISABLED = {state: false};
            this.ZOOM_LEVEL = 1.05;
            this.SCROLLER = null;
            this.winHandler = null;
            this.isAfterUPP = false;
            this.isThisLifeGeneral = false;
            this.mixedSourcesGeneral = false;
            this.clickthroughNoModal = false;
            this.isManual = false;
            this.listOfProducts = [];
            this.shareStyleTag = "";

            /**
             * set or get the current opend pid
             * @param currentOpenPid
             * @returns {*}
             */
            this.handleCurrentPid = function(currentOpenPid)
            {
                if (typeof currentOpenPid !== "undefined") {
                    this.CURRENT_OPEN_PID = currentOpenPid;
                }
                return this.CURRENT_OPEN_PID;
            };

            // Will render the ListView products in the given @containerElement
            this.renderView = function(containerElement, products, productJson, albums, prodStyles, prodSizes, prodOptions, modal, instance)
            {
                var SIDE_PAD = 65;
                var SIDE_PAD_SMALL = 50;
                var MAX_SPACE_BETWEEN_PRODUCTS = 80;
                var SPACE_FROM_TOP = 80;
                var that = this;

                /* === HELPER ==== */

                function renderThumb(pId, productType, partnerId, product, layoutJson, designJson, position, productGenerateCallBack, layoutMasks, promiseToResolve) {
                    var useCDN = cache.get('env') != 'beta' && cache.get('env') != 'dev';
                    var mgThumbGen  = new MgThumbGenerator(cache.get('env'),useCDN);

                    mgThumbGen.init(productType, partnerId, product, layoutJson, designJson, that.Model.get('monitoring').reportEvent, cache.get('env'), true);

                    var j = position;

                    that.Model.get('monitoring').eventStart('tl:Generate:' + pId);
                    var thumbPage = 0;
                    if ((that.Model.get('prod_type') == "photobook" || that.Model.get('prod_type') == 'photobook_share') && productType == "book") {
                        var product = view_common.findProjectJsonProduct(productJson, pId);
                        var photosRefIds = {};
                        $.each(product.book.pages, function (i, cPage) {
                            $.each(cPage.canvas.layout.photos, function (j, cPhoto) {
                                photosRefIds[cPhoto.photoRefId] = 1;
                            });
                        });

                        thumbPage = Object.keys(photosRefIds).length > 1 ? 2 : 1;
                    }
                    mgThumbGen.generate(parseInt(thumbPage), pId, true, function (canvas) {
                        that.Model.get('monitoring').eventEnd('tl:Generate:' + pId);

                        var elem = that.thumbRenderPlaceElement(containerElement, canvas, pId, productType, thumbPage, j);

                        // photobook modal only
                        if ((that.Model.get('prod_type') == "photobook" || that.Model.get('prod_type') == "photobook_share") && productType == "book") {
                            elem.parent().css('width', 'auto');
                            elem.css('width', '70%')
                                .css('top', '50px')
                                .css('cursor', 'default');
                            $(canvas).css('cursor', 'pointer');
                            that.updateProductPrice({
                                widgetType: 'tl_horizontal',
                                container: elem,
                                productJson: productJson,
                                pId: pId,
                                targetSize: prodPosAndSize.sizes[pId],
                                prodOptions: prodOptions,
                                coupon: typeof cache.getCoupon() !== "undefined" ? cache.getCoupon().name : false,
                                clickthroughNoModal: that.clickthroughNoModal
                            });
                            elem.find('.sfly_wgt_product_price')
                                .css('left', 'auto')
                                .css('right', '-198px')
                                .css('top', '175px');
                            elem.append("<div class='sfly-wgt-tl-create-photobook'><div class='sfly-wgt-tl-orange-btn'>See your book</div></div>");
                            elem.find('.sfly-wgt-tl-create-photobook')
                                .css('position', 'absolute')
                                .css('top', '80px');
                            if (elem.parent().width() <= 600) {
                                elem.css('left', '90px');
                                elem.find('.sfly_wgt_product_price')
                                    .css('right', '127px')
                                    .css('top', '210px');
                                elem.find('.sfly-wgt-tl-create-photobook')
                                    .css('top', '120px')
                                    .css('right', '327px');
                            }

                            var openBookModal = function () {
                                if (!that.isLocked()) {
                                    that.takeLock();

                                    var currAlbums = albums.photobook;
                                    var currAlbum = currAlbums[0];

                                    var callbacks = {
                                        takeLock: that.takeLock.bind(that),
                                        releaseLock: that.releaseLock.bind(that),
                                        animateControlButton: undefined,
                                        changeState: that.changeWidgetOpenState.bind(that, that.IS_WIDGET_OPEN),
                                        handleCurrentPid: that.handleCurrentPid.bind(that),
                                        toggleViewDisable: that.toggleViewDisable.bind(that, that.IS_VIEW_DISABLED)
                                    };

                                    var modalCallback = modal.show.bind(that, {
                                        pId: elem.attr('data-pid'),
                                        currPid: that.CURRENT_OPEN_PID,
                                        currAlbum: currAlbum,
                                        albums: currAlbums,
                                        prodStyles: prodStyles,
                                        prodOptions: prodOptions,
                                        forceCloseExternal: false,
                                        widgetIsOpen: that.IS_WIDGET_OPEN.state,
                                        isThisLife: that.isThisLifeGeneral,
                                        mixedSources: that.mixedSourcesGeneral,
                                        callbacks: callbacks,
                                        instance: instance,
                                        model: that.Model,
                                        useNewStyleGuide: true,
                                        doNotResizeImages: true
                                    });

                                    that.openBookModal({
                                        pId: elem.attr('data-pid'),
                                        widgetType: 'instance',
                                        elem: elem,
                                        albums: albums,
                                        containerElement: containerElement,
                                        widgetState: that.IS_WIDGET_OPEN.state,
                                        instance: instance,
                                        clickthroughNoModal: that.clickthroughNoModal,
                                        winHandler: that.winHandler,
                                        productJson: productJson,
                                        productType: productType,
                                        clickThrough: clickThrough,
                                        modalCallback: modalCallback
                                    });
                                }
                            };

                            elem.find('.sfly-wgt-tl-orange-btn').on('click', function () {
                                openBookModal()
                            });
                            $(canvas).on('click', function () {
                                openBookModal()
                            });
                        } else if (that.Model.get('prod_type') == "prints_share" && productType == "prints") {
                            elem.parent().css('width', '100%').css('height', '100%');
                            elem.css('width', '320px')
                                .css('top', '50px')
                                .css('cursor', 'default')
                                .css('left', '70px');
                            $(canvas).css('cursor', 'pointer');
                            that.updateProductPrice({
                                widgetType: 'tl_horizontal',
                                container: elem,
                                productJson: productJson,
                                pId: pId,
                                targetSize: prodPosAndSize.sizes[pId],
                                prodOptions: prodOptions,
                                coupon: typeof cache.getCoupon() !== "undefined" ? cache.getCoupon().name : false,
                                clickthroughNoModal: that.clickthroughNoModal
                            });
                            elem.find('.sfly_wgt_product_price')
                                .css('left', 'auto')
                                .css('right', '-250px')
                                .css('top', '160px');
                            elem.append("<div class='sfly-wgt-tl-create-prints'><div class='sfly-wgt-tl-orange-btn'>Order Prints</div></div>");
                            elem.find('.sfly-wgt-tl-create-prints')
                                .css('position', 'absolute')
                                .css('top', '65px')
                                .css('right', '-50px');


                            function doClickThrough() {
                                if (that.Model.get('openInNewTab')) {
                                    that.winHandler = view_common.openNewWindow(that.winHandler);

                                    if (!that.IS_WIDGET_OPEN.state) {
                                        view_common.removeLoading($('.sfly_wgt_listview_container'));
                                    }
                                } else {
                                    that.winHandler = null;
                                }

                                var albumResult = that.getCurrentAlbum(pId, albums); //currAlbums[currItemOrder % currAlbums.length];
                                var currAlbum = albumResult.currAlbum;
                                var photoIds = that.getPhotoIdsForPrints(productJson, $(this).attr('data-pid'), that.isAfterUPP, currAlbum, that.isManual);
                                var modelCopy = that.Model.copy();
                                modelCopy.set('isManualSelect', true);

                                clickThrough.sendForSeeAll(photoIds, view_common.showLoading.bind(that, $('.sfly_wgt_listview_container')), view_common.removeLoading.bind(that, $('.sfly_wgt_listview_container')), currAlbum, that.winHandler, modelCopy);
                                that.Model.get('callback')({action: 'hide_window'});
                            }

                            elem.find('.sfly-wgt-tl-orange-btn').on('click', function () {
                                doClickThrough()
                            });
                            $(canvas).on('click', function () {
                                doClickThrough()
                            });
                        }
                        else    //all the others
                        {
                            view_common.updateProductSize(elem, commonWidth, pId, productJson, prodPosAndSize.sizes);
                            var pSize = view_common.getProductRealSize(productJson, pId);
                            var priceTop = that.updateProductPrice({
                                widgetType: 'tl_horizontal',
                                container: elem,
                                productJson: productJson,
                                pId: pId,
                                targetSize: prodPosAndSize.sizes[pId],
                                prodOptions: prodOptions,
                                coupon: typeof cache.getCoupon() !== "undefined" ? cache.getCoupon().name : false,
                                clickthroughNoModal: that.clickthroughNoModal
                            });
                            var topPos = SPACE_FROM_TOP - pSize.top * prodPosAndSize.sizes[pId].ratio;

                            // Set position
                            // We want to shift all products down
                            elem.css('position', 'absolute')
                                .css('top', topPos + 'px')
                                .css('left', prodPos[pId] + 'px')
                                .css('height', (300 - topPos - 30) + "px")
                                .attr('data-top', topPos)
                                .attr('data-left', prodPos[pId])
                                .attr('data-subleft', topPos)
                                .attr('data-subtop', topPos);
                            var productInner = elem.children('.sfly_wgt_product_inner');
                            var priceElem = elem.children('.sfly_wgt_product_price');
                            var hoverElem = elem.find(".sfly_wgt_product_hover");
                            productInner.attr('data-pricetop', priceTop);

                            // Calculate target position and size of the product
                            var pTargetSize = elem.width() * that.ZOOM_LEVEL;

                            // Sometimes, in ThisLife, the widget will get a bad size - we want to mark it
                            if (pTargetSize == 0) {
                                $(containerElement).parent().attr('data-renderfor', 0);
                            }

                            var currPId = elem.attr('data-pid');
                            var albumResult = that.getCurrentAlbum(pId, albums); //currAlbums[currItemOrder % currAlbums.length];
                            var currAlbum = albumResult.currAlbum;
                            var currAlbums = albumResult.currAlbums;

                            var callbacks = {
                                takeLock: that.takeLock.bind(that),
                                releaseLock: that.releaseLock.bind(that),
                                animateControlButton: undefined,
                                changeState: that.changeWidgetOpenState.bind(that, that.IS_WIDGET_OPEN),
                                handleCurrentPid: that.handleCurrentPid.bind(that),
                                toggleViewDisable: that.toggleViewDisable.bind(that, that.IS_VIEW_DISABLED)
                            };

                            var renderData = {
                                pId: currPId,
                                currPid: that.CURRENT_OPEN_PID,
                                currAlbum: currAlbum,
                                albums: currAlbums,
                                prodStyles: prodStyles,
                                prodOptions: prodOptions,
                                forceCloseExternal: false,
                                widgetIsOpen: that.IS_WIDGET_OPEN.state,
                                isThisLife: that.isThisLifeGeneral,
                                mixedSources: that.mixedSourcesGeneral,
                                callbacks: callbacks,
                                instance: instance,
                                model: that.Model,
                                useNewStyleGuide: true,
                                doNotResizeImages: true,
                                tooltipItems: that.listOfProducts
                            };

                            // collect data for tooltip
                            if (typeof that.listOfProducts[currPId] == 'undefined') {
                                that.listOfProducts[currPId] = {};
                            }
                            that.listOfProducts[currPId] = _.extend(that.listOfProducts[currPId], {renderData: renderData});

                            elem
                                .on('click', function () {
                                    if (!that.isLocked()) {
                                        that.takeLock();

                                        var currItemOrder = $(this).attr('data-order') - 1; // order is "1" based, albums is "0" based

                                        // Add Opacity to other products
                                        $('.sfly_wgt_product').addClass('not-selected');
                                        that.removeHoverStates(containerElement);

                                        if (!that.IS_WIDGET_OPEN.state) {
                                            view_common.showLoading($('.sfly_wgt_listview_container'));
                                        }

                                        tracking.track('tl', 'click', {
                                            sku: $(this).attr('data-sku'),
                                            order: currItemOrder,
                                            mode: 'instance',
                                            prod_type: that.Model.get('prod_type')
                                        });
                                        tracking.track('tl', 'hover', {
                                            sku: $(this).attr('data-sku'),
                                            order: currItemOrder,
                                            mode: 'instance',
                                            prod_type: that.Model.get('prod_type')
                                        });


                                        if ($(this).attr('data-pid') == 'prints_4x6') {
                                            var product = view_common.findProjectJsonProduct(productJson, $(this).attr('data-pid'), that.isAfterUPP);
                                            var photoIds = that.thumbRenderPreparePhotoIds(product, currAlbum, that.isAfterUPP, that.isManual);

                                            if (that.Model.get('openInNewTab')) {
                                                that.winHandler = view_common.openNewWindow(that.winHandler);

                                                if (!that.IS_WIDGET_OPEN.state) {
                                                    view_common.removeLoading($('.sfly_wgt_listview_container'));
                                                }
                                            } else {
                                                that.winHandler = null;
                                            }

                                            clickThrough.sendForSeeAll(photoIds, view_common.showLoading.bind(this, $('.sfly_wgt_listview_container')), view_common.removeLoading.bind(this, $('.sfly_wgt_listview_container')), currAlbum, that.winHandler, that.Model);
                                            that.Model.get('callback')({action: 'hide_window'});
                                        } else {
                                            if (that.clickthroughNoModal) {
                                                if (that.Model.get('openInNewTab')) {
                                                    that.winHandler = view_common.openNewWindow(that.winHandler);

                                                    if (!that.IS_WIDGET_OPEN.state) {
                                                        view_common.removeLoading($('.sfly_wgt_listview_container'));
                                                    }
                                                } else {
                                                    that.winHandler = null;
                                                }

                                                var pJson = view_common.findProjectJsonProduct(productJson, pId);
                                                var prod = view_common.getProduct(pId);

                                                pJson.product.info.productCode = prod["productCode"];
                                                pJson.product.info.sku = prod["sku"];
                                                clickThrough.sendToClickThrough(pJson, productType, null, null, currAlbum, that.winHandler, that.Model, prod.personalizeUrl);
                                            } else {
                                                modal.show(renderData);
                                            }
                                        }
                                    }
                                })
                                .on('mouseenter', function () {
                                    that.horizontalItemMouseEnter(this, that.IS_WIDGET_OPEN.state, priceElem, productInner, hoverElem);
                                })
                                .on('mouseleave', function () {
                                    that.horizontalItemMouseOut(this, productInner, hoverElem, priceElem);
                                });

                        }

                        if (typeof promiseToResolve !== 'undefined') {
                            promiseToResolve.resolve();
                        }

                        if (_.isFunction(productGenerateCallBack)) {
                            productGenerateCallBack(j);
                        }
                    }, true, {masks: layoutMasks, textEnabled:(productType !== "book")});
                }

                /* === END HELPER ==== */
                // [ looks like duplication of horizontal/Engine.js ]
                var commonWidth = that.LV_PROD_WIDTH;
                var commonHeight = that.LV_PROD_HEIGHT;
                var spreadResult = that.prepareSpreads(products, 'listview', products.length);
                var spreads = spreadResult.spreads;
                var side_padding = spreads.children('.sfly_wgt_listview_spread').length > 1 ? SIDE_PAD : SIDE_PAD_SMALL;
                var prodPosAndSize = that.findPositionProductsInSpreads({
                    container: containerElement,
                    spreads: spreads,
                    productJson: productJson,
                    targetHeight: commonHeight,
                    typeOfView: 'listview',
                    maxSpaceBetweenProds: MAX_SPACE_BETWEEN_PRODUCTS,
                    sidePadding: side_padding,
                    prodSizeZoomLevels: prodSizes,
                    calcElemPositionFunc: that.horizontalCalcElementsPosition.bind(that),
                    prodHeight: that.LV_PROD_HEIGHT
                });
                var prodPos = prodPosAndSize.positions;

                if ($(containerElement).find('.sfly_wgt_listview_spread_container').length == 0) {
                    $(containerElement)
                        //.html(spreads)
                        .append(spreads)
                        .parent()
                        .attr('data-renderfor', $(containerElement).width());
                } else {
                    //update the width
                    $(containerElement).find('.sfly_wgt_listview_spread').width(prodPosAndSize.width);

                    //reload scroller
                    that.SCROLLER.reload();
                }

                if ($(containerElement).find('.sfly_wgt_listview_embedded_title').length == 0) {
                    productProxy.getSflyPromos(that.Model.get('prod_type'))
                    .then(
                        function(response) {
                            if (typeof response !== 'undefined') {
                                $(containerElement).append(view_common.renderTemplate(templates.tl_mg_embd_title, {
                                    html: response
                                }));

                                $(containerElement).find('.sfly_wgt_special_offers').on('click', function (e) {
                                    e.preventDefault();
                                    clickThrough.redirectTo('special-offers');
                                });
                            }
                        }
                    );
                }

                // if ($(containerElement).find('.sfly_wgt_listview_embedded_title').length == 0) {
                //     var info = config.getCategoryInfo(that.Model.get('prod_type'));

                //     $(containerElement).append(view_common.renderTemplate(templates.tl_mg_embd_title, {
                //         title: info.title,
                //         see_all_text: info.see_all_text,
                //         see_all_link: info.see_all
                //     }));

                //     $(containerElement).find('.sfly_wgt_listview_embedded_title_tl').on('click', function () {

                //         var prodType = that.Model.get('prod_type');

                //         tracking.track('open', 'go_store', {
                //             mode: "instance",
                //             prod_type: prodType
                //         });

                //         if (that.Model.get('openInNewTab')) {
                //             that.winHandler = view_common.openNewWindow(that.winHandler);

                //             if (!that.IS_WIDGET_OPEN.state) {
                //                 view_common.removeLoading($('.sfly_wgt_listview_container'));
                //             }
                //         } else {
                //             that.winHandler = null;
                //         }

                //         // roman: should put this into one place and use everywhere
                //         var currAlbums;
                //         if (prodType == 'prints' || prodType == 'prints_share') {
                //             currAlbums = albums.prints;
                //         } else if (prodType == 'photobook' || prodType == 'photobook_share') {
                //             currAlbums = albums.photobook;
                //         } else if (prodType == 'calendar' || prodType == 'deskcalendar') {
                //             currAlbums = albums.calendars;
                //         } else {
                //             currAlbums = albums.products;
                //         }
                //         var currAlbum = currAlbums[0];

                //         var photosToTransfer = 200;
                //         if (prodType != 'photobook' && prodType != 'photobook_share' && !that.isManual) {
                //             photosToTransfer = 25;
                //         }

                //         var photoIds = _.first(currAlbum.photos.map(function (p) {
                //             return parseInt(p.id)
                //         }), photosToTransfer);

                //         clickThrough.sendForSeeAllGeneric(that.Model.get('prod_type'), photoIds, currAlbum, that.winHandler, view_common.showLoading.bind(that, $('.sfly_wgt_listview_container')), view_common.removeLoading.bind(that, $('.sfly_wgt_listview_container')), that.Model);
                //         that.Model.get('Callback')({action: 'hide_window'});
                //     });
                // }

                that.updateCssForSpreads(containerElement, 'listview');

                $(containerElement).find('#sfly_wgt_upp_select_main').off('click').on('click', function () {

                    // Using UPP
                    if (that.inThisLife) {
                        function onOK(groupPhotos, isThisLife, mixedSources) {
                            isThisLife = true; //Override value - as we're always in TL here

                            view_common.showLoading($('.sfly_wgt_listview_container'));
                            var productJson = [];

                            function _getProductJson(pJson) {
                                if (pJson != null) {
                                    // if is This Life replace photoIds in the strip with SFLY Ids
                                    if (isThisLife) {
                                        pJson = modal_common.replaceIdWithSFLYId(groupPhotos, pJson);
                                    }
                                    productJson = productJson.concat(pJson);
                                }
                            }


                            that.Model.get('monitoring').eventStart('tl:getRankService_AfterUpp');
                            $.when(
                                productProxy.getPhotobook(groupPhotos, 40, _getProductJson, true, true, products, isThisLife, mixedSources, true),
                                productProxy.getProducts(groupPhotos, _getProductJson, true, products, true, isThisLife, mixedSources, true, true),
                                productProxy.getPrints(groupPhotos, _getProductJson, true, products, isThisLife, mixedSources, true),
                                productProxy.getCalendar(groupPhotos, _getProductJson, true, products, isThisLife, mixedSources, true)
                            )
                                .then(function () {
                                    that.isThisLifeGeneral = isThisLife;
                                    that.mixedSourcesGeneral = mixedSources;
                                    that.Model.get('monitoring').eventEnd('tl:getRankService_AfterUpp');
                                    cache.removeProductsAll();
                                    var newalbums = new Object();
                                    $.each(albums, function (type, album) {
                                        if (album.length > 0) {
                                            $.each(album, function (i, albumObj) {
                                                if (typeof newalbums[type] === "undefined") {
                                                    newalbums[type] = new Array();
                                                }
                                                newalbums[type].push(groupPhotos);
                                            });
                                        }
                                    });
                                    that.isAfterUPP = true;
                                    that.renderView(containerElement, products, productJson, newalbums, prodStyles, prodSizes, prodOptions, modal);
                                })
                                .fail(function () {
                                    view_common.removeLoading($('.sfly_wgt_listview_container'));
                                });

                            tracking.track('tl', 'upp', {
                                action: 'ok',
                                sku: 'main',
                                mode: 'instance',
                                prod_type: that.Model.get('prod_type')
                            });
                        }

                        function onCancel() {
                            tracking.track('tl', 'upp', {
                                action: 'cancel',
                                sku: 'main',
                                mode: 'instance',
                                prod_type: that.Model.get('prod_type')
                            });
                        }

                        tracking.track('tl', 'upp', {
                            action: 'open',
                            sku: 'main',
                            mode: 'instance',
                            prod_type: that.Model.get('prod_type')
                        });
                        modal_common.showUPP(onOK, onCancel);
                    } else {
                        if (_.isFunction(that.Model.get('callback'))) {
                            that.Model.get('callback')('select_photos');
                        }
                    }

                });

                var count = 1;

                function enableScrollAfterFourProds() {
                    var elems = that.getScrollerArrows(containerElement);

                    if (typeof $(containerElement).attr('data-scroller') === "undefined") {
                        // Do tracking for loading
                        tracking.track('tl', 'on_load', {mode: 'instance', prod_type: that.Model.get('prod_type')});
                        that.Model.get('monitoring').eventEnd('tl:Start');
                        that.SCROLLER = scroller(spreads, elems.spreadToMove, elems.scrollerArrows, {
                            orientation: 'horizontal',
                            color: "#3b3b3b"
                        });
                        $(containerElement).attr('data-scroller', true);
                    }
                }

                function addTracking() {
                    $(containerElement).find('.sfly_wgt_listview_scroll_left_arrow').on('click', function () {
                        tracking.track('tl', 'mg_arrow', {
                            dir: 'left',
                            mode: 'instance',
                            prod_type: that.Model.get('prod_type')
                        });
                    });

                    $(containerElement).find('.sfly_wgt_listview_scroll_right_arrow').on('click', function () {
                        tracking.track('tl', 'mg_arrow', {
                            dir: 'right',
                            mode: 'instance',
                            prod_type: that.Model.get('prod_type')
                        });
                    });
                }

                view_common.removeLoading($('.sfly_wgt_listview_container'));
                // addTracking();
                var firstBatchPromises = [];
                var pricePromises = [];

                var batchProduct = 4;
                var numProdToSplit = products.length < batchProduct ? products.length : batchProduct;

                if (numProdToSplit < batchProduct) {
                    $(containerElement).find('.p_').remove();
                    spreads.css("text-align", "center");
                    spreads.children('.sfly_wgt_listview_spread').css("position", "relative").css("display", "inline-block");
                }

                /* use url from params photo array, not from rank service */
                function updateProductPhotoUrls(product, albums) {
                    var photoArray  = albums.products[0].photos;


                    var productContent = product[Object.keys(product)[0]];
                    if (productContent.hasOwnProperty('photoStrip')) {
                        var photoStrip = productContent['photoStrip'];
                        for (var pIndex in photoStrip) {
                            if (photoStrip.hasOwnProperty(pIndex)) {
                                var cPhoto = photoStrip[pIndex];
                                cPhoto.url = _.find(photoArray, function(item) {
                                    return item.id === cPhoto.photoId;
                                }, this).url;
                            }
                        }
                    }

                    return product;
                }

                // build tooltip content
                var prodIndex = 0;
                _.each(products, function(sku) {
                    if (typeof that.listOfProducts[sku] == 'undefined') {
                        that.listOfProducts[sku] = {};
                    }
                    that.listOfProducts[sku] = _.extend(that.listOfProducts[sku], {
                        order: prodIndex++,
                        sku: sku
                    });
                });



                _.each(_.first(products, numProdToSplit), function (sku) {
                    var product = updateProductPhotoUrls(view_common.findProjectJsonProduct(productJson, sku, true), albums);
                    var productType = AssetMapper.GetProductType(product);
                    var partnerId = AssetMapper.GetPartnerId(product, productType);

                    var prodSku = productType != 'book' ? view_common.getProduct(sku)['sku'] : view_common.getProduct(sku)['style'] + '_' + view_common.getProduct(sku)['size'];

                    function renderProdThumb(position) {

                        // Prints and Calendar will still be using the embedded JSONs. Also anything that is not supported now.
                        if (productType == 'prints') {
                            var layoutJson = JSON.stringify(config.getRecipeLayout()[partnerId]);
                            var designJson = JSON.stringify(config.getRecipeDesign()[partnerId]);
                            renderThumb(sku, productType, partnerId, product, layoutJson, designJson, position, null);
                        } else {
                            var deferred = $.Deferred();
                            firstBatchPromises.push(deferred);
                            // todo if thumb already was requested before - don't request again!
                            that.Model.get('monitoring').eventStart('tl:prepareThumbGenAssets:' + sku);
                            thumbGenWrapper.prepareThumbGenAssets(prodSku, sku, 'medium', productType, product, function (result) {
                                that.Model.get('monitoring').eventEnd('tl:prepareThumbGenAssets:' + sku);
                                //deferred.resolve();

                                if (result == null || typeof result.layoutJson === 'undefined' || typeof result.designJson === 'undefined') {
                                    $(containerElement).find('.sfly_wgt_item_placeholder.p_' + sku).css('visibility', 'hidden');
                                    products.sku = null;
                                    deferred.resolve();
                                    console.log('[Product Widget] Missing Layout / Design json');
                                    return;
                                }

                                if (productType == 'book') {
                                    layoutJson = JSON.stringify(result.layoutJson[sku]);
                                } else {
                                    layoutJson = JSON.stringify(result.layoutJson);
                                }

                                designJson = JSON.stringify(result.designJson);

                                renderThumb(sku, productType, partnerId, product, layoutJson, designJson, position, null, result.layoutMasks, deferred);
                            });
                        }
                    }

                    renderProdThumb(count);

                    count++;
                }, this);

                $.when.apply(undefined, firstBatchPromises).then(function () {
                    if (numProdToSplit < batchProduct) {
                        var deferred = $.Deferred();
                        pricePromises.push(deferred);
                        deferred.resolve();
                    } else {
                        _.each(_.last(products, products.length - numProdToSplit), function (sku) {
                            var product = view_common.findProjectJsonProduct(productJson, sku, true);
                            var productType = AssetMapper.GetProductType(product);
                            var partnerId = AssetMapper.GetPartnerId(product, productType);
                            var prodSku = productType != 'book' ? view_common.getProduct(sku)['sku'] : view_common.getProduct(sku)['style'] + '_' + view_common.getProduct(sku)['size'];

                            function renderProdThumb(position) {

                                // Prints and Calendar will still be using the embedded JSONs. Also anything that is not supported now.
                                if (productType == 'prints') {
                                    var layoutJson = JSON.stringify(config.getRecipeLayout()[partnerId]);
                                    var designJson = JSON.stringify(config.getRecipeDesign()[partnerId]);
                                    renderThumb(sku, productType, partnerId, product, layoutJson, designJson, position, null);
                                } else {
                                    var deferred = $.Deferred();
                                    pricePromises.push(deferred);
                                    // todo if thumb already was requested before - don't request again!
                                    that.Model.get('monitoring').eventStart('tl:prepareThumbGenAssets:' + sku);
                                    thumbGenWrapper.prepareThumbGenAssets(prodSku, sku, 'medium', productType, product, function (result) {
                                        that.Model.get('monitoring').eventEnd('tl:prepareThumbGenAssets:' + sku);
                                        deferred.resolve();

                                        if (result == null || typeof result.layoutJson === 'undefined' || typeof result.designJson === 'undefined') {
                                            products.sku = null;
                                            deferred.resolve();
                                            console.log('[Product Widget] Missing Layout / Design json');
                                            return;
                                        }

                                        if (productType == 'book') {
                                            layoutJson = JSON.stringify(result.layoutJson[sku]);
                                        } else {
                                            layoutJson = JSON.stringify(result.layoutJson);
                                        }

                                        designJson = JSON.stringify(result.designJson);

                                        renderThumb(sku, productType, partnerId, product, layoutJson, designJson, position, null, result.layoutMasks);
                                    });
                                }
                            }

                            renderProdThumb(count);

                            count++;
                        }, this);
                    }

                    $.when.apply(undefined, pricePromises).then(function () {
                        enableScrollAfterFourProds();

                        that.loadPrices(containerElement, products);
                    });

                });
            }
        }

        utils.inheritPrototype(TLHorizontalViewEngine, EngineHorizontal);

        TLHorizontalViewEngine.prototype.render = function (params) {
            var that = this;
            var source = params.source;
            var prodStyles = params.prodStyles;
            var prodSizes = params.prodSizes;
            var prodOptions = params.prodOptions;
            var showMessage = params.showMessage;
            var numOfProducts = params.numOfProducts;
            var modal_view = params.modalView;
            var instance = params.instance;
            var renderParams = params.renderParams;

            if (!utils.browserSupported()) {
                that.failWidget('instance', 'tl', 'tl');
                return;
            }

            that.Model.get('monitoring').eventStart('tl:Start');
            //that.Model.get('monitoring').eventStart('tl:on_first_product_load_Start');

            var ctr = this.Model.get('container');

            var useThesePhotos = undefined;
            if (typeof renderParams !== "undefined") {
                useThesePhotos = renderParams['photos'];

                if (typeof renderParams['isManualSelect'] !== "undefined") {
                    that.isManual = renderParams['isManualSelect'];
                }

                if (typeof renderParams['clickthroughNoModal'] !== "undefined") {
                    that.clickthroughNoModal = renderParams['clickthroughNoModal'];
                }

                if (typeof renderParams['shareStyleTag'] !== "undefined") {
                    that.shareStyleTag = renderParams['shareStyleTag'];
                }
            }

            that.globalWidgetInit();

            // do not render template until we have mgsources
            //$(ctr).html(view_common.renderTemplate(templates.listview_cont_horiz));
            function renderMainTemplate(showLoader, fromSource) {
                fromSource = fromSource || [];
                showLoader = typeof showLoader !== "undefined" ? showLoader : true;
                $(ctr).html(view_common.renderTemplate(templates.listview_cont_horiz, {products: fromSource, useNewStyleGuide: true}));
                $(ctr).find('.sfly_wgt_listview_container').addClass(that.shareStyleTag);
                if (showLoader) {
                    // Animate the appearance of the temp boxes
                    var boxes = $(ctr).find('.sfly_wgt_item_placeholder');
                    var itr = 0;
                    _.each(boxes, function (box) {
                        setTimeout(function () {
                            $(box).css('display', 'inline-block');
                        }, itr * 300);
                        itr++;
                    });
                }
            }

            // Remove classes added on hover on product
            $(ctr).on('mouseleave', function () {
                that.removeHoverStates(that);
            });

            if (typeof showMessage !== 'undefined' && showMessage != null) {
                renderMainTemplate(source);
                that.horizontalShowOverlayView(showMessage, that.IS_VIEW_DISABLED.state, instance);
                return;
            }

            var failId = 0;
            var currCallId = 1;
            var productJson = [];

            function _getProductJson(callId, pJson) {
                if (pJson != null && callId != failId) {
                    productJson = productJson.concat(pJson);
                }
            }

            // Check what kind of products is this and ask for MG Source accordingly
            var getPrints = 0;
            var getProducts = 0;
            var getBooks = 0;
            var getCalendar = 0;

            _.each(source, function (pId) {
                var product = view_common.getProduct(pId);
                switch (product.type) {
                    case 'prints':
                        getPrints = that.PRINTS_NUM_ALBUMS;
                        break;
                    case 'photobook':
                        getBooks = that.PB_NUM_ALBUMS;
                        break;
                    case 'calendar':
                    case 'deskcalendar':
                        getCalendar = that.CAL_NUM_ALBUMS;
                        break;
                    default:
                        getProducts = that.PROD_NUM_ALBUMS;
                        break;
                }
            });

            // function for get from rankservice the project jsons and pass call the render method
            function getRankSourcesAndRender(albums, instance, isFullPhotoData) {
                var isFullPhotoData = isFullPhotoData || false;
                that.Model.get('monitoring').eventStart('tl:getRankService');
                var getProductsFromRank = function (retry) {

                    var d = $.Deferred();
                    var allAlbums = that.formatAllAlbums(albums, retry);

                    // Check if we have enough products to create using the albums we got.
                    // We pass 100 as num of photos as we don't want to cut it
                    var cleanSource = that.cleanSourceWithAlbums(source, allAlbums, 100);

                    // if less than 3 products do not render mg
                    if (cleanSource.length < 1) {
                        console.log('[Product Widget]> Not enough resources for render.');
                        renderMainTemplate(false);
                        that.horizontalShowOverlayView('upload', that.IS_VIEW_DISABLED.state, instance);
                        d.resolve(true);
                        return;
                    }

                    var albumsToSendToRank = _.clone(allAlbums);
                    if (isFullPhotoData) {
                        that.isAfterUPP = true;
                        albumsToSendToRank['photobook'] = allAlbums['photobook'][0];
                        albumsToSendToRank['products'] = allAlbums['products'][0];
                        albumsToSendToRank['prints'] = allAlbums['prints'][0];
                        albumsToSendToRank['calendars'] = allAlbums['calendars'][0];
                    }

                    $.when(
                        productProxy.getPhotobook(albumsToSendToRank['photobook'], 40, _getProductJson.bind(this, currCallId), (that.Model.get('prod_type') == "photobook" || that.Model.get('prod_type') == "photobook_share") ? false : true, that.isManual, cleanSource),
                        productProxy.getProducts(albumsToSendToRank['products'], _getProductJson.bind(this, currCallId), that.isManual, cleanSource, true),
                        productProxy.getPrints(albumsToSendToRank['prints'], _getProductJson.bind(this, currCallId), that.isManual, cleanSource),
                        productProxy.getCalendar(albumsToSendToRank['calendars'], _getProductJson.bind(this, currCallId), that.isManual, cleanSource)
                    )
                        .then(function () {
                            that.Model.get('monitoring').eventEnd('tl:getRankService');
                            renderMainTemplate(true, cleanSource);
                            that.renderView($(ctr).find('.sfly_wgt_listview_container'), cleanSource, productJson, allAlbums, prodStyles, prodSizes, prodOptions, modal_view, instance);
                            d.resolve(true);
                        })
                        .fail(function () {
                            if (retry) {
                                console.log('[Product Widget]> Failed loading resources (Api). Aborting.');
                                productProxy.MgFail();
                                renderMainTemplate();
                                that.failWidget('instance', 'tl', 'tl');
                            } else {
                                console.log('[Product Widget]> Failed loading resources (Api). Retrying with different source.');
                            }
                            d.reject();
                        });
                    return d.promise();
                };

                // get products from api. If fails the first time retry with a second source.
                $.when(getProductsFromRank())
                    .fail(function () {
                        failId = currCallId;
                        currCallId++;
                        productJson = [];
                        getProductsFromRank(true);
                    });
            }

            // render magic shop using some specific photos otherwise call getMgSource
            // This is for TL
            if (typeof useThesePhotos !== "undefined" && _.isArray(useThesePhotos) && useThesePhotos.length > 0) {
                var albumId = String.fromCharCode(65 + Math.floor(Math.random() * 26)) + Date.now();
                var album = {albumId: albumId, photos: useThesePhotos};
                var albums = {
                    photobooks: [album],
                    products: [album],
                    prints: [album],
                    calendars: [album]
                };
                that.inThisLife = true;
                cache.set('superfly_user', true);
                cache.removeProductsAll();
                getRankSourcesAndRender(albums, instance, true);
            } else {
                // we have a 2 step process for displaying the widget
                // 1. Get the photos and albums for the user
                // 2. Get the covers for the albums
                that.Model.get('monitoring').eventStart('tl:getMgSource');
                productProxy.getMGSources(function (albums) {
                    that.Model.get('monitoring').eventEnd('tl:getMgSource');
                    if (albums != null) {
                        if (_.isEmpty(albums)) {
                            // Not enough sources. Show overlay and exit.
                            renderMainTemplate(false);
                            that.horizontalShowOverlayView('upload', that.IS_VIEW_DISABLED.state, instance);
                            return;
                        }
                        getRankSourcesAndRender(albums, instance);
                    } else {
                        console.log('[Product Widget]> Failed loading resources. Aborting.');
                        productProxy.MgFail();
                        renderMainTemplate();
                        that.failWidget('instance', 'tl', 'tl');
                    }
                });
            }
        }

        return TLHorizontalViewEngine;
    });

define('app/view_engine/widgets/engines/tl_horizontal/EngineVertical',
    ['underscore', 'app/templates', 'mgthumb', 'app/asset_mapper', 'app/config_manager', 'app/click_through', 'app/tracking', 'app/cookies', 'magicselect', 'app/album_switch', 'app/product_proxy', 'app/utils', 'app/cache_module', 'app/scroller', 'app/view_engine/widgets/common', 'app/thumbgen_wrapper', 'app/time_monitor', 'app/globals', 'app/view_engine/modals/shared', 'app/view_engine/widgets/engines/EngineHorizontal', 'css!./../../../../css/widget.css', 'css!./../../../../css/MagicSelectBox.css'],
    function(_, templates, mgthumb, AssetMapper, config, clickThrough, tracking, cookies, magicselect, albumSwitch, productProxy, utils, cache, scroller, view_common, thumbGenWrapper, monitor, globals, modal_common, EngineHorizontal, css1, css2)
    {

        function TLVerticalViewEngine(params) {
            EngineHorizontal.call(this, params);

            this.MOBILE_THRESHOLD        = globals.MOBILE_THRESHOLD;
            this.isMobile                = $(window).width() < this.MOBILE_THRESHOLD;
            this.isSmallMobile           = $(window).width() < globals.SMALL_MOBILE_THRESHOLD;
            this.LV_PROD_WIDTH           = this.isMobile ? 90 : 125;
            this.LV_PROD_HEIGHT          = this.isMobile ? 80 : 110;
            this.DESKTOP_PROD_WIDTH      = 125;
            this.DESKTOP_PROD_HEIGHT     = 110;
            this.ROW_SIZE                = 120;
            this.MAX_LV_PRODS            = 4;
            this.PB_NUM_ALBUMS           = 2;
            this.PROD_NUM_ALBUMS         = 2;
            this.PRINTS_NUM_ALBUMS       = 2;
            this.CAL_NUM_ALBUMS          = 2;
            this.DISABLE_CLICK           = false;
            this.IS_WIDGET_OPEN          = {state:false};
            this.CURRENT_OPEN_PID        = null;
            this.IS_VIEW_DISABLED        = {state: false};
            this.ZOOM_LEVEL              = 1.05;
            this.CONTAINER_ELWIDTH       = 0;
            this.SPRD_WID                = 0;
            this.PRODINNER_WID           = 209;
            this.PRODINNER_WID_PB_CAL    = ($(window).width() < globals.TABLET_THRESHOLD || $(window).width() > globals.MOBILE_THRESHOLD) ? 278 : 250;
            this.winHandler              = null;
            this.isAfterUPP              = false;
            this.isThisLifeGeneral       = true;
            this.mixedSourcesGeneral     = false;
            this.clickthroughNoModal     = false;
            this.isManual                = false;
            this.isTouch                 = (('ontouchstart' in window) || (typeof navigator.msMaxTouchPoints !== 'undefined' ? navigator.msMaxTouchPoints : false));
            this.MOBILE_NUM_PRODUCTS     = 24;
            this.ScrollbarWidth          = null;
            this.promoEl                 = null;

            this.isRendered              = false;
            this.isFirstRun              = true;
            this.newTitlePricingFormat   = true;

            this.listOfProducts = [];

            // Set the item width
            if ($(window).width() <= globals.SMALL_MOBILE_THRESHOLD) {
                this.ITEM_TOTAL_WIDTH = 160;
            } else if ($(window).width() <= globals.MOBILE_THRESHOLD) {
                this.ITEM_TOTAL_WIDTH = 250;
            } else {
                this.ITEM_TOTAL_WIDTH = 280;
            }

            /**
             * set or get the current opend pid
             * @param currentOpenPid
             * @returns {*}
             */
            this.handleCurrentPid = function(currentOpenPid)
            {
                if (typeof currentOpenPid !== "undefined") {
                    this.CURRENT_OPEN_PID = currentOpenPid;
                    //window.MagicShopGlobalCurrentPid = currentOpenPid;
                }
                return this.CURRENT_OPEN_PID;
            };

            this.enableMove = function(container) {
                container.on('mousemove', function (event) {
                    if ($(this).parent().parent().hasClass('sfly-wgt-dont-act')) { // Not yet ready for action.
                        return;
                    }

                    var pages = $(this).attr('data-pages');
                    var rightPadding = parseFloat(($(this).attr('data-right')));
                    var boxWidth = $(this).width() - rightPadding;
                    var leftPadding = parseFloat(($(this).css('left')).replace("px", ""));

                    // Calc real position
                    var targetPos = $(event.currentTarget).offset();
                    var mousePos = {top: event.pageY, left: event.pageX};
                    var realPos = {top: mousePos.top - targetPos.top, left: mousePos.left - targetPos.left};

                    var currPage = Math.floor((realPos.left + leftPadding) * pages / boxWidth);

                    if (currPage < 0) {
                        currPage = 0;
                    } else if (currPage >= pages - 1) {
                        currPage = pages - 1;
                    }

                    $(this).find('canvas').hide();
                    $(this).find('canvas[data-order=' + currPage + ']').show();
                });
            };

            // Will calculate the right position of each product in the given container
            /*
             params:
             containerElement: The main container of the widget
             container: The container of the products, where you actually append the products
             */
            this.calcElementsPosition = function(params) {
                // containerElement, container, productJson, targetHeight, maxSpaceBetweenProds, sidePadding, prodSizes
                var products = $(params.container).attr('data-pids').split(',');
                var result = this.calTotalProductsHeightByBoundingBox(products, params.productJson, this.getBoundingBox.bind(this), params.prodSizes);

                if (typeof result.error !== 'undefined') {
                    return result;
                } else {
                    return {
                        sizes: result.sizes
                    };
                }
            };

            this.calcElementsPositionAsync = function(params) {
                // containerElement, container, productJson, targetHeight, maxSpaceBetweenProds, sidePadding, prodSizes
                var products = $(params.container).attr('data-pids').split(',');
                this.calTotalProductsHeightByBoundingBoxAsync(products, params.productJson, this.getBoundingBox.bind(this), params.prodSizeZoomLevels, function(result){
                    if (typeof result.error !== 'undefined') {
                        params.callback(result);
                    } else {
                        params.callback({
                            sizes: result.sizes
                        });
                    }
                });
            };

            // custom bounding boxes
            this.boundingBoxes = function() {
                return {
                    'shoppingbag' : { height: 90, width: 102 },
                    'deskcalendar' : { height: 160, width: 181 }
                };
            }();

            this.mobileBoundingBoxes = function() {
                return {
                    'shoppingbag' : { height: 63, width: 71 },
                    'deskcalendar' : { height: 160, width: 181 }
                };
            }();

            // Define this function if you want custome bounding box for specific product
            this.getBoundingBox = function(pId) {
                var product = view_common.getProduct(pId),
                    boundingBox;
                if (!this.isSmallMobile && typeof product.type !== 'undefined' && typeof this.boundingBoxes[product.type] !== 'undefined') {
                    boundingBox = this.boundingBoxes[product.type];
                } else if (this.isSmallMobile && typeof product.type !== 'undefined' && typeof this.mobileBoundingBoxes[product.type] !== 'undefined') {
                    boundingBox = this.mobileBoundingBoxes[product.type];
                } else {
                    boundingBox = this.isSmallMobile ? { height: this.LV_PROD_HEIGHT, width: this.LV_PROD_WIDTH } : { height: this.DESKTOP_PROD_HEIGHT, width: this.DESKTOP_PROD_WIDTH };
                }

                return boundingBox;
            };

            this.renderProducts = function(pId, productType, container, mgThumbGen, masks, onRenderedCallback) {

                var PRODUCT_PROJECTIONS = 5;

                // We need this function to keep the right order inside the generate function
                var generated = 0;
                function _generate(order) {
                    mgThumbGen.generate(parseInt(order), pId, true, function(canvas) {
                        $(canvas).attr('data-order', order).hide();
                        $(container).append(canvas);
                        generated++;

                        if(typeof(onRenderedCallback) !== "undefined" && _.isFunction(onRenderedCallback)){
                            if(generated == PRODUCT_PROJECTIONS -1) {
                                onRenderedCallback();
                            }
                        }
                    }, true, { masks: masks, textEnabled:(productType !== "book") });
                }

                if (!$(container).attr('data-rendered')) {
                    // Put this first - to block more attempts to render
                    $(container).attr('data-rendered', true);
                    var numOfPages = PRODUCT_PROJECTIONS;
                    $(container).attr('data-pages', PRODUCT_PROJECTIONS);

                    function generateWithTimeout(i) {
                        setTimeout(function(){ _generate(i); }, i*50);
                    }

                    for(var i = 1; i < numOfPages; i++) {
                        generateWithTimeout(i);
                    }
                }
            };

            this.onContainerResize = function(containerElement, spreads, productJson, commonHeight, viewtype, MAX_SPACE_BETWEEN_PRODUCTS, side_padding, prodSizes) {
                var currentScreenState          = this.isSmallMobile;
                this.isMobile                   = $(window).width() < globals.MOBILE_THRESHOLD;
                this.isSmallMobile              = $(window).width() < globals.SMALL_MOBILE_THRESHOLD;
                this.ITEM_TOTAL_WIDTH           = this.isSmallMobile ? 160 : 280;
                var shouldProductMarginUpdate   = currentScreenState != this.isSmallMobile; // Check if the state changed from small to big

                // The product sizes are different between the mobile and the desktop view
                if (shouldProductMarginUpdate) {
                    this.boundRenderView();
                }
            };

            this.updateProductMargins = function(containerElement) {
                var that = this;
                var products = $(containerElement).find('.sfly_wgt_product');
                _.each(products, function(prodContainer) {
                    var prodWid = that.isSmallMobile ? (that.SPRD_WID/2) : $(prodContainer).width();
                    var inner = $(prodContainer).children('.sfly_wgt_product_inner').first();
                    var diff = that.isSmallMobile ? 0 : Math.floor((prodWid - that.ITEM_TOTAL_WIDTH) / 2);
                    $(inner).css('margin-left', diff + 'px');
                });
            };

            this.updateProductStyle = function(containerElement, howMany) {
                var spreads = $(containerElement).find('.sfly_wgt_listview_spread');
                this.CONTAINER_ELWIDTH = this.Model.get('container').width();

                if (typeof howMany == 'undefined') {
                    _.each(spreads, function(spread) {
                        var pids = $(spread).attr('data-pids').split(',');
                        howMany = pids.length;
                    })
                }

                this.isMobile = $(window).width() < this.MOBILE_THRESHOLD;
                this.isSmallMobile = $(window).width() < globals.SMALL_MOBILE_THRESHOLD;
                this.SPRD_WID = this.CONTAINER_ELWIDTH - 38;

                if (!this.isMobile) {
                    var maxPdInFLine = parseInt(this.CONTAINER_ELWIDTH / this.PRODINNER_WID);
                    if (howMany < maxPdInFLine) {
                        maxPdInFLine = howMany;
                    }
                    this.SPRD_WID = this.PRODINNER_WID * maxPdInFLine;
                }

                if (!this.isMobile) {
                    spreads.css('width', this.SPRD_WID + 'px');
                }
                //change the promo title width and offset aswell
                var containerTitle = $(containerElement).find('.sfly_wgt_listview_embedded_title');
                if (containerTitle.length > 0) {
                    if (this.isMobile) {
                        containerTitle.css('width', '100%');
                    } else {
                        containerTitle.css('width', (this.SPRD_WID + 4) + 'px');
                    }

                    //if the promoWidth is small due to the less products then make the smaller promo due to the space issues
                    if(this.promoEl != null && this.promoEl.parent().height() > 52) {
                        var self = this;
                        productProxy.getSflyPromos(this.Model.get('prod_type'), true).then(function(response){
                            self.renderPromo(response);
                        });
                    }
                    //calculate only once
                    if (this.ScrollbarWidth == null) {
                        this.ScrollbarWidth = this.getScrollbarWidth();
                    }

                    if (this.ScrollbarWidth != 0) {
                        if (spreads.parent().height() < spreads.height() || spreads.position().left == 0) {
                            containerTitle.css('margin-left', '-' + this.ScrollbarWidth + 'px');
                        }
                    }
                }
            };

            this.getScrollbarWidth = function() {
                var outer = document.createElement("div");
                outer.style.visibility = "hidden";
                outer.style.width = "100px";
                document.body.appendChild(outer);

                var widthNoScroll = outer.offsetWidth;
                // force scrollbars
                outer.style.overflow = "scroll";

                // add innerdiv
                var inner = document.createElement("div");
                inner.style.width = "100%";
                outer.appendChild(inner);

                var widthWithScroll = inner.offsetWidth;

                // remove divs
                outer.parentNode.removeChild(outer);

                return widthNoScroll - widthWithScroll;
            };

            this.renderPromo = function(response) {
                if (typeof response !== 'undefined') {
                    $(this.promoEl).html(response);
                    var aTag = $( "a" );
                    $(this.promoEl).find(aTag).on('click', function (e) {
                        e.preventDefault();
                        clickThrough.redirectTo('special-offers');
                    });
                }
            };

            this.updateProductMargin = function(productContainer) {
                //var inner = $(productContainer).children('.sfly_wgt_product_inner').first();
                //var prodWid = this.isMobile ? (this.SPRD_WID/2) : $(productContainer).width();
                //var diff = Math.floor(( prodWid - this.ITEM_TOTAL_WIDTH) / 2);
                //$(inner).css('margin-left', diff + 'px');
            };

            // Will render the ListView products in the given @containerElement
            this.renderView = function(containerElement, products, productJson, albums, prodStyles, prodSizes, prodOptions, modal, instance, structure) {
                var SIDE_PAD                    = 65;
                var SIDE_PAD_SMALL              = 50;
                var MAX_SPACE_BETWEEN_PRODUCTS  = 80;
                var zoomLevelDownsize           = 0.6;
                var SPACE_FROM_TOP              = 20;
                var that                        = this;
                var menuContainer               = null;

                /* === HELPER ==== */

                // Will get and position the price for the given product (@pId)
                function updateProductPrice(container, productJson, pId, targetSize) {
                    var MOVE_DOWN_PX        = 25;
                    var product             = view_common.getProduct(pId);
                    var size                = view_common.getProductRealSize(productJson, pId, false, product);

                    var title               = "";
                    // if we have title for the recipe use it otherwise use the one from the sku file
                    if(product['type'] !== 'photobook' && typeof prodOptions !== "undefined" && typeof prodOptions[pId] !== "undefined" && typeof prodOptions[pId]['title'] !== "undefined") {
                        title = prodOptions[pId]['title'];
                    } else {
                        title = product['type'] == 'photobook' ? product['size'] + ' Photo book' : product['title'];
                    }

                    var titleElem = $(view_common.renderTemplate(templates.listview_prod_title, {
                        title: title
                    }));

                    var priceSku            = product.type === "photobook" && product.sflySku ? product.sflySku : product.sku;
                    var price               = config.isPricesLoaded() ? config.getPrice(priceSku) : null;
                    var priceElem           = $(view_common.renderTemplate(templates.listview_prod_price, {
                        price: price,
                        price_template: _.template(templates.listview_pprice_inr),
                        coupon: typeof cache.getCoupon() !== "undefined" ? cache.getCoupon().name : false
                    }));
                    var ratio               = targetSize.ratio;
                    var productCenter       = (size.left + (size.width)/2);
                    var priceCenter         = 80;   //size.width/2;   <--- The price has a fixed size of 160px
                    var move_x              = (productCenter*ratio - priceCenter);
                    var move_x_zoomedout    = (productCenter*ratio*zoomLevelDownsize - priceCenter);
                    var move_x_zoomedin     = (productCenter*ratio*that.ZOOM_LEVEL - priceCenter);
                    var top                 = targetSize.height + size.top*ratio + MOVE_DOWN_PX;

                    if (typeof cache.getCoupon() !== "undefined"){
                        top -= 6;
                    }

                    var topZoomedIn         = top + size.height * ratio * (that.ZOOM_LEVEL-1)/2; //top*(1+(ZOOM_LEVEL-1)/2);

                    titleElem
                        .css('position', 'absolute')
                        .css('top', '0')
                        .css('margin', '0')
                        .css('width', that.isSmallMobile ? 'auto' : '100%');

                    priceElem
                        .css('width', '100%')
                        .css('margin-top', '15px')
                        .css('margin-left', '0')
                        .attr('data-price-center', move_x)
                        .attr('data-price-zoom-center', move_x_zoomedout)
                        .attr('data-price-zoomin-center', move_x_zoomedin)
                        .attr('data-price-top-zoomin', topZoomedIn);

                    if (that.isSmallMobile) {
                        var priceTop = (that.ROW_SIZE / 2) - 16; // (-16) for the title

                        titleElem
                            .css('margin-left', '30px')
                            .css('top', priceTop+'px');

                        priceElem
                            .css('top', (priceTop + 20) + 'px')
                            .css('width', 'auto')
                            .css('margin-left', '30px');
                    }

                    $(container).append(titleElem);
                    $(container).append(priceElem);

                    // add hover box
                    var btnTitle = (product.title == "4x6 Prints" ? "Order Prints" : "View all");
                    var hover = $(view_common.renderTemplate(templates.fullview_prod_hover_tl, {forcedTitleText: btnTitle, productType: product['type'], clickthroughNoModal: that.clickthroughNoModal }));
                    $(container).append(hover);

                    return top;
                }

                function renderThumb(pId, productType, partnerId, product, layoutJson, designJson, position, productGenerateCallBack, layoutMasks, promiseToResolve) {
                    var useCDN = cache.get('env') != 'beta' && cache.get('env') != 'dev';
                    var mgThumbGen  = new MgThumbGenerator(cache.get('env'),useCDN);

                    mgThumbGen.init(productType, partnerId, product, layoutJson, designJson, that.Model.get('monitoring').reportEvent, cache.get('env'));

                    var j = position;

                    that.Model.get('monitoring').eventStart('tl:Generate:' + pId);
                    var thumbPage = 0;
                    var isPBProd = (that.Model.get('prod_type') == "photobook" || that.Model.get('prod_type') == 'photobook_share') && productType == "book";
                    if(isPBProd){
                        view_common.findProjectJsonProduct(productJson, pId);
                    }

                    mgThumbGen.generate(parseInt(thumbPage), pId, true, function(canvas) {
                        that.Model.get('monitoring').eventEnd('tl:Generate:' + pId);
                        view_common.removeLoading(that.Model.get('container'));
                        var productInfo = view_common.getProduct(pId);
                        var elem = $(view_common.renderTemplate(templates.fullview_product, { pid: pId, sku: productInfo['sflySku'], ptype: productType }));
                        $(canvas).attr('data-order', thumbPage);
                        elem
                            .addClass('order_' + j)
                            .attr('data-order', j)
                            .children('.sfly_wgt_product_inner')
                            .html(canvas)
                            .addClass('order_' + j);

                        if (position == products.length) {
                            elem.addClass('right');
                        }

                        $(containerElement).find('.sfly_wgt_item_placeholder.p_' + pId).css('visibility', 'hidden');
                        var spread = $(containerElement).find('.sfly_wgt_listview_spread');

                        var productInner = elem.children('.sfly_wgt_product_inner');
                        elem.attr('data-spread-order', $(spread).attr('data-order'));
                        if(spread.find('.sfly_wgt_product.order_' + j).length > 0){
                            spread.find('.sfly_wgt_product.order_' + j).replaceWith(elem);
                        } else {
                            spread.append(elem);
                        }

                        // if is a rotatable render it and bind mousemove action
                        if(view_common.isProductRotatable(productType) && !(that.isMobile && that.isTouch)) {
                            var newRotation  = that.enableMove.bind(that, productInner);
                            setTimeout(function() {
                                that.renderProducts(pId, productType, productInner, mgThumbGen, layoutMasks, newRotation);
                            }, 1000);
                        }

                        var updateTheProductSize = function(elem, targetWidth, pId, productJson, targetSizes, product, size, zoom) {
                            var container = $(elem).children('.sfly_wgt_product_inner');

                            fixProductSize(elem, 0, size, container[0].clientWidth, container[0].clientHeight, undefined, zoom);
                        }

                        var SPACE_FROM_BOTTOM   = 70;
                        var pSize           = view_common.getProductRealSize(productJson, pId, false, productInfo);
                        // view_common.updateProductSize(elem, commonWidth, pId, productJson, prodPosAndSize.sizes, productInfo);
                        updateTheProductSize(elem, commonWidth, pId, productJson, prodPosAndSize.sizes, productInfo, pSize, prodPosAndSize.zoomLevels[pId]);

                        var priceTop        = updateProductPrice(elem, productJson, pId, prodPosAndSize.sizes[pId]);
                        var productRatio    = prodPosAndSize.sizes[pId].ratio;
                        //var topPos          = SPACE_FROM_TOP - pSize.top * productRatio;
                        var topPos          = (that.ROW_SIZE - pSize.realHeight * productRatio)/2 - 4; // the -4 is a fix
                        var bottomPos       = (SPACE_FROM_BOTTOM) - pSize.bottom * productRatio;

                        // Because we used another bounding box, that is not based on the original one - we have a bad positioning
                        if (productType == 'shoppingbag' && that.isSmallMobile) {
                            topPos -= 15;
                        }

                        // compute center

                        var hoverElem = elem.find(".sfly_wgt_product_hover");
                        productInner.attr('data-pricetop', priceTop);

                        // Calculate target position and size of the product
                        var pTargetSize = elem.width() * that.ZOOM_LEVEL;

                        // Sometimes, in ThisLife, the widget will get a bad size - we want to mark it
                        if (pTargetSize == 0) {
                            $(containerElement).parent().attr('data-renderfor', 0);
                        }

                        var currPId = elem.attr('data-pid');
                        var albumResult = that.getCurrentAlbum(pId, albums); //currAlbums[currItemOrder % currAlbums.length];
                        var currAlbum = albumResult.currAlbum;
                        var currAlbums = albumResult.currAlbums;

                        var callbacks = {
                            takeLock: that.takeLock.bind(that),
                            releaseLock: that.releaseLock.bind(that),
                            animateControlButton: undefined,
                            changeState: that.changeWidgetOpenState.bind(that, that.IS_WIDGET_OPEN),
                            handleCurrentPid: that.handleCurrentPid.bind(that),
                            toggleViewDisable: that.toggleViewDisable.bind(that, that.IS_VIEW_DISABLED)
                        };

                        var renderData = {
                            pId: currPId,
                            currPid: that.CURRENT_OPEN_PID,
                            currAlbum: currAlbum,
                            albums: currAlbums,
                            prodStyles: prodStyles,
                            prodOptions: prodOptions,
                            forceCloseExternal: false,
                            widgetIsOpen: that.IS_WIDGET_OPEN.state,
                            isThisLife: that.isThisLifeGeneral,
                            mixedSources: that.mixedSourcesGeneral,
                            callbacks: callbacks,
                            instance: instance,
                            model: that.Model,
                            useNewStyleGuide: true,
                            doNotResizeImages: true,
                            tooltipItems: that.listOfProducts
                        };

                        if (menuContainer != null) {
                            $(menuContainer).find('li[data-sku="' + pId + '"]').on('click', function (event, params) {
                                //if (pId == window.MagicShopGlobalCurrentPid) {
                                //    return;
                                //}
                                if (!that.IS_WIDGET_OPEN.state) {
                                    view_common.showLoading($(containerElement));
                                    var loadingContainer = $(containerElement).find('.sfly_wgt_loading');
                                    if (loadingContainer.length > 0 && !that.isMobile) {
                                        loadingContainer.css('position', 'absolute').css('height', 'inherit');
                                    }
                                }

                                var albumResult = that.getCurrentAlbum(pId, that.Model.get('albums')); //currAlbums[currItemOrder % currAlbums.length];
                                var currAlbum = albumResult.currAlbum;
                                renderData.currAlbum = albumResult.currAlbum;
                                renderData.albums = albumResult.currAlbums;

                                that.updateModalMenuSelection(menuContainer, pId);
                                var productInfo = view_common.getProduct(pId);
                                var sku = productInfo['sflySku'];

                                var trackingSku = view_common.getTrackingSku(sku, pId, productType);

                                // if (params && params.hasOwnProperty('muteTracking') && params.muteTracking === true) {
                                //     // skip tracking
                                // } else {
                                //     tracking.track('tl', 'click-category', {
                                //         sku: trackingSku,
                                //         pid: $(this).attr('data-pid'),
                                //         mode: 'instance',
                                //         prod_type: that.Model.get('prod_type')
                                //     });
                                // }
                                if (productType == 'book') {
                                    currAlbums = albumResult.currAlbums;
                                    currAlbum = renderData.currAlbum;

                                    callbacks.handleCurrentPid = that.handleCurrentPid.bind(that);

                                    var modalCallback = modal.show.bind(this, {
                                        pId: pId,
                                        currPid: that.CURRENT_OPEN_PID,
                                        currAlbum: currAlbum,
                                        albums: currAlbums,
                                        prodStyles: prodStyles,
                                        prodOptions: prodOptions,
                                        forceCloseExternal: false,
                                        widgetIsOpen: that.IS_WIDGET_OPEN.state,
                                        isThisLife: that.isThisLifeGeneral,
                                        mixedSources: that.mixedSourcesGeneral,
                                        callbacks: callbacks,
                                        instance: instance,
                                        model: that.Model,
                                        useNewStyleGuide: true,
                                        doNotResizeImages: true
                                    });

                                    that.openBookModal({
                                        pId: pId,
                                        widgetType: 'instance',
                                        elem: $(this),
                                        albums: that.Model.get('albums'),
                                        containerElement: that.Model.get('modalContainer'),
                                        widgetState: that.IS_WIDGET_OPEN.state,
                                        instance: instance,
                                        clickthroughNoModal: that.clickthroughNoModal,
                                        winHandler: that.winHandler,
                                        productJson: productJson,
                                        productType: productType,
                                        clickThrough: clickThrough,
                                        modalCallback: modalCallback
                                    });
                                } else {
                                    modal.show(renderData);
                                }
                            });
                        }

                        elem.off().on('click', function () {
                            if (!that.isLocked()) {
                                that.takeLock();

                                var currItemOrder = $(this).attr('data-order') - 1; // order is "1" based, albums is "0" based
                                var albumResult = that.getCurrentAlbum(pId, albums); //currAlbums[currItemOrder % currAlbums.length];
                                var currAlbum = albumResult.currAlbum;
                                var currAlbums = albumResult.currAlbums;

                                // Add Opacity to other products
                                $('.sfly_wgt_product').addClass('not-selected');
                                that.removeHoverStates(containerElement);

                                if (!that.IS_WIDGET_OPEN.state) {
                                    view_common.showLoading($(containerElement));
                                    var loadingContainer = $(containerElement).find('.sfly_wgt_loading');
                                    if (loadingContainer.length > 0 && !that.isMobile) {
                                        loadingContainer.css('position', 'absolute').css('height', 'inherit');
                                    }
                                }

                                // tracking params
                                // var trackingSku = view_common.getTrackingSku($(this).attr('data-sku'), $(this).attr('data-pid'), $(this).attr('data-ptype'));
                                // tracking.track('tl', 'click-category', {
                                //     sku: trackingSku,
                                //     pid: $(this).attr('data-pid'),
                                //     order: currItemOrder,
                                //     mode: 'instance',
                                //     prod_type: that.Model.get('prod_type')
                                // });

                                if (menuContainer != null) {
                                    that.updateModalMenuSelection(menuContainer, $(this).attr('data-pid'));
                                    $(that.Model.get('modalcontainer')).addClass('visible');
                                }

                                if ($(this).attr('data-pid') == 'prints_4x6') {
                                    var product = view_common.findProjectJsonProduct(productJson, $(this).attr('data-pid'), that.isAfterUPP);
                                    var photoIds = that.thumbRenderPreparePhotoIds(product, currAlbum, that.isAfterUPP, that.Model.get('ismanualselect'));

                                    if (that.Model.get('openInNewTab')) {
                                        that.winHandler = view_common.openNewWindow(that.winHandler);

                                        if (!that.IS_WIDGET_OPEN.state) {
                                            view_common.removeLoading($('.sfly_wgt_listview_container'));
                                        }
                                    } else {
                                        that.winHandler = null;
                                    }

                                    clickThrough.sendForSeeAll(photoIds, view_common.showLoading.bind(this, $('.sfly_wgt_listview_container')), undefined, currAlbum, that.winHandler, that.Model);
                                    if (!that.isMobile) {
                                        that.Model.get('callback')({action: 'hide_window'});
                                    }
                                } else if ($(this).attr('data-ptype') == 'book') {

                                    currAlbums = albums.photobook;
                                    currAlbum = currAlbums[0];

                                    callbacks.handleCurrentPid = that.handleCurrentPid.bind(that);

                                    var modalCallback = modal.show.bind(this, {
                                        pId: elem.attr('data-pid'),
                                        currPid: that.CURRENT_OPEN_PID,
                                        currAlbum: currAlbum,
                                        albums: currAlbums,
                                        prodStyles: prodStyles,
                                        prodOptions: prodOptions,
                                        forceCloseExternal: false,
                                        widgetIsOpen: that.IS_WIDGET_OPEN.state,
                                        isThisLife: that.isThisLifeGeneral,
                                        mixedSources: that.mixedSourcesGeneral,
                                        callbacks: callbacks,
                                        instance: instance,
                                        model: that.Model,
                                        useNewStyleGuide: true,
                                        doNotResizeImages: true
                                    });

                                    that.openBookModal({
                                        pId: elem.attr('data-pid'),
                                        widgetType: 'instance',
                                        elem: elem,
                                        albums: albums,
                                        containerElement: containerElement,
                                        widgetState: that.IS_WIDGET_OPEN.state,
                                        instance: instance,
                                        clickthroughNoModal: that.clickthroughNoModal,
                                        winHandler: that.winHandler,
                                        productJson: productJson,
                                        productType: productType,
                                        clickThrough: clickThrough,
                                        modalCallback: modalCallback
                                    });
                                }
                                else {

                                    if(productType == "calendar")
                                    {
                                        // tracking params
                                        var trackingSku = view_common.getTrackingSku($(this).attr('data-sku'), $(this).attr('data-pid'), $(this).attr('data-ptype'));
                                        tracking.track('tl', 'click-category', {
                                             sku: trackingSku,
                                             pid: $(this).attr('data-pid'),
                                             order: currItemOrder,
                                             mode: 'instance',
                                             prod_type: that.Model.get('prod_type')
                                         });
                                    }


                                    modal.show(renderData);
                                }
                            }
                        })
                        .on('mouseenter', function () {
                            // Check that a product is not selected
                            if (!that.IS_WIDGET_OPEN.state) {
                                $(this).parent().children().addClass('on-hover-other');
                                $(this).removeClass('on-hover-other').addClass('on-hover');
                            }

                            if (!((that.isMobile && that.isTouch) || that.isSmallMobile)) {
                                hoverElem.show();
                            }
                        })
                        .on('mouseleave', function () {
                            if (!(that.isMobile && that.isTouch)) {
                                hoverElem.hide();
                            }
                        });

                        that.updateProductMargin.call(that, elem);

                        if (typeof promiseToResolve !== 'undefined') {
                            promiseToResolve.resolve();
                        }

                        if(_.isFunction(productGenerateCallBack)) {
                            productGenerateCallBack(j);
                        }
                    }, true, { masks: layoutMasks, textEnabled:(productType !== "book") });
                }

                function addProductContainers(containerElement, howMany, prodType, albums, structure) {

                    if (typeof structure !== 'undefined' && that.isMobile) {
                        var spreads = $(containerElement).find('.sfly_wgt_listview_spread').first();

                        var placeHolders    = [];
                        var order           = 1;
                        Object.keys(structure).forEach(function(category) {
                            placeHolders.push('<div class="sfly_wgt_product_category"><span>' + category + '</span></div>');

                            structure[category].forEach(function() {
                                placeHolders.push('<div class="sfly_wgt_product sfly_wgt_product_placeholder order_' + order + '"></div>');
                                order++;
                            })
                        });
                        $(spreads).html(placeHolders.join(''));
                    } else {
                        var spreads = $(containerElement).find('.sfly_wgt_listview_spread');

                        _.each(spreads, function(spread) {
                            var pids = $(spread).attr('data-pids').split(',');
                            var order = 1;
                            if ($(spread).find('.sfly_wgt_product').length == 0) {
                                var placeHolders = [];
                                _.first(pids, howMany).forEach(function(pid)
                                {
                                    placeHolders.push('<div class="sfly_wgt_product sfly_wgt_product_placeholder order_' + order + '"></div>');
                                    order++;
                                });
                                $(spread).html(placeHolders.join(''));
                            }
                        });
                    }

                    var removeRestrictionEl = true;
                    //if prodType is pb or calendar then the width of the slots are diff, so add a class to the spread
                    var isCal = (prodType == 'calendar' || prodType == 'deskcalendar');
                    if (prodType == 'photobook' || prodType == 'photobook_share' || isCal) {
                        spreads.addClass('pbook_cal');
                        that.PRODINNER_WID = that.PRODINNER_WID_PB_CAL;

                        try {
                            var currAlbum = isCal ? albums.calendars : albums.photobook;
                            var selectedPhotos = currAlbum[0].photos.length;

                            if ((selectedPhotos < 20 && !isCal) || (selectedPhotos < 12 && isCal)) {
                                var count = isCal ? 12 : 20;
                                var restEl = $(containerElement).find('.sfly_wgt_restriction');
                                if (restEl.length > 0) {
                                    restEl.find('.count').html(count);
                                    restEl.show();
                                    removeRestrictionEl = false;
                                }
                            }
                        } catch (e) {}
                    }
                    if (prodType == 'photobook' || prodType == 'photobook_share') {
                        spreads.append
                        ('<div class="sfly_wgt_spread_mg_footer">' +
                            'Upgrade to our NEW PREMIUM ALBUMS. Start your book and go to the OPTION tab' +
                        '</div>');
                    }

                    if (removeRestrictionEl) {
                        try {
                            $(containerElement).find('.sfly_wgt_restriction').remove();
                        } catch (e) {}
                    }

                    that.Model.get('callback')({action: 'finished_view_render_photos_vert', productType: prodType});
                }

                function addStoreLinkInContainer(containerElement, prodType, cb) {
                    //For the email share we dont need store link
                    //if (prodType == 'photogifts_share') {
                    //    return;
                    //}
                    //var spreadContainer = $(containerElement).find('.sfly_wgt_listview_spread_container');
                    //var info = config.getCategoryInfo(prodType);
                    //if (info !== undefined && typeof info !== 'undefined' && info !== null) {
                    //    var goToStore = "";
                    //    if(prodType == 'photobook' || prodType == 'photobook_share') {
                    //        goToStore = "Go to store to see other photo book sizes";
                    //    } else if (prodType == 'calendar' || prodType == 'deskcalendar') {
                    //        goToStore = "Go to store to see magnet and poster calendars";
                    //    } else {
                    //        goToStore = "Go to store to see all " + info.title;
                    //    }
                    //    spreadContainer.append('<div class="sfly_wgt_gotostore"><span>' + goToStore + '</span></div>');
                    //}

                    if (_.isFunction(cb)) {
                        cb();
                    }
                }

                /* use url from params photo array, not from rank service */
                function updateProductPhotoUrls(product, albums) {
                    if (typeof product === 'undefined' || product === null) {
                        return;
                    }

                    var photoArray  = albums.products[0].photos;


                    var productContent = product[Object.keys(product)[0]];
                    if (productContent.hasOwnProperty('photoStrip')) {
                        var photoStrip = productContent['photoStrip'];
                        for (var pIndex in photoStrip) {
                            if (photoStrip.hasOwnProperty(pIndex)) {
                                var cPhoto = photoStrip[pIndex];
                                cPhoto.url = _.find(photoArray, function(item) {
                                    return item.id === cPhoto.photoId;
                                }, this).url;
                            }
                        }
                    }

                    return product;
                }

                function renderChunk(skusToRender, chunkSize, fullRenderPromise, count, callbackRender) {
                    var chunk       = _.first(skusToRender, chunkSize);
                    var restChunks  = _.rest(skusToRender, chunkSize);

                    var allProductsPromises = [];

                    _.each(chunk, function (sku) {
                        var product = updateProductPhotoUrls(view_common.findProjectJsonProduct(productJson, sku, true), albums);
                        var productType = AssetMapper.GetProductType(product);
                        var partnerId = AssetMapper.GetPartnerId(product, productType);
                        var prodSku = productType != 'book' ? view_common.getProduct(sku)['sku'] : view_common.getProduct(sku)['style'] + '_' + view_common.getProduct(sku)['size'];

                        function renderProdThumb(position) {
                            var prodPromise = $.Deferred();
                            allProductsPromises.push(prodPromise);
                            // Prints and Calendar will still be using the embedded JSONs. Also anything that is not supported now.
                            if (productType == 'prints') {
                                var layoutJson = JSON.stringify(config.getRecipeLayout()[partnerId]);
                                var designJson = JSON.stringify(config.getRecipeDesign()[partnerId]);
                                renderThumb(sku, productType, partnerId, product, layoutJson, designJson, position, undefined, undefined, prodPromise);
                            } else {
                                // todo: if thumb already was requested before - don't request again!
                                that.Model.get('monitoring').eventStart('tl:prepareThumbGenAssets:' + sku);
                                thumbGenWrapper.prepareThumbGenAssets(prodSku, sku, 'medium', productType, product, function (result) {
                                    that.Model.get('monitoring').eventEnd('tl:prepareThumbGenAssets:' + sku);

                                    if (result == null || typeof result.layoutJson === 'undefined' || typeof result.designJson === 'undefined') {
                                        products.sku = null;
                                        prodPromise.resolve();
                                        console.log('[Product Widget] Missing Layout / Design json for SKU:', sku);
                                        return;
                                    }

                                    if (productType == 'book') {
                                        layoutJson = JSON.stringify(result.layoutJson[sku]);
                                    } else {
                                        layoutJson = JSON.stringify(result.layoutJson);
                                    }

                                    designJson = JSON.stringify(result.designJson);

                                    _.defer(renderThumb.bind(undefined, sku, productType, partnerId, product, layoutJson, designJson, position, undefined, result.layoutMasks, prodPromise));
                                });
                            }
                        }

                        renderProdThumb(count);

                        count++;
                    }, this);

                    $.when.apply(undefined, allProductsPromises).then(function() {
                        if(restChunks.length > 0) {
                            callbackRender(restChunks, chunkSize, fullRenderPromise, count, renderChunk);
                        } else {
                            fullRenderPromise.resolve();
                            that.Model.get('monitoring').eventEnd('tl:Start');
                        }
                    });
                }

                function injectIntoEmbeddedModal(structure, prodType, modalContainer) {
                    // prepre the structure with titles

                    var title;

                    switch(prodType) {
                        case 'photobook':
                            title = "Photo Books";
                            break;
                        case 'calendar':
                            title = "Calendars";
                            break;
                        default:
                            title = "";
                            break;
                    }

                    var newStructure = {};
                    newStructure[title] = [];

                    Object.keys(structure).forEach(function(category) {
                        newStructure[title].push({
                            title: category,
                            sku: structure[category][0]
                        })
                    });

                    var menuContainer = $(modalContainer).find('.magicshop_modal_menu_wrapper li.' + that.Model.get('prod_type') + ' .modal_category_btn_sub_menu');
                    var menu = view_common.renderTemplate(templates.popup_leftpane, {
                        products: newStructure,
                        currentProduct: ''
                    });
                    $(menuContainer).html(menu);

                    return menuContainer;
                }

                /* === END HELPER ==== */

                var commonWidth         = that.LV_PROD_WIDTH;
                var commonHeight        = that.LV_PROD_HEIGHT;
                var spreadResult        = that.prepareSpreads(products, 'listview', products.length);
                var spreads             = spreadResult.spreads;
                var side_padding        = spreads.children('.sfly_wgt_listview_spread').length > 1 ? SIDE_PAD : SIDE_PAD_SMALL;
                var prodPosAndSize      = null;

                function doTheRender(prodPosAndSizeResult) {
                    prodPosAndSize = prodPosAndSizeResult;
                    if(typeof prodPosAndSize.error !== 'undefined') {
                        this.failWidget('instance', 'tl', 'tl');
                        console.log(utils.formatString('[Product Widget]> Failed. Aborting...\nMessage : {0}', prodPosAndSize.error.msg));
                        return;
                    }

                    if ($(containerElement).find('.sfly_wgt_listview_spread_container').length == 0) {
                        $(containerElement)
                            .append(spreads)
                            .parent()
                            .attr('data-renderfor', $(containerElement).width());
                    }

                    var spreadContainer = $(containerElement).find('.sfly_wgt_listview_spread_container');

                    // Need to update the height
                    $(window).on('resize.instance', _.debounce(that.onContainerResize.bind(this, containerElement, spreads, productJson, commonHeight, 'listview', MAX_SPACE_BETWEEN_PRODUCTS, side_padding, prodSizes), 500));

                    that.updateCssForSpreads(containerElement, 'listview');
                    view_common.removeLoading($('.sfly_wgt_listview_container'));

                    var batchProduct = 0;
                    var numProdToSplit = products.length < batchProduct ? products.length : batchProduct;

                    if(numProdToSplit < batchProduct){
                        $(containerElement).find('.p_').remove();
                        spreads.css("text-align", "center");
                        spreads.children('.sfly_wgt_listview_spread').css("position", "relative").css("display","inline-block");
                    }

                    // if we're on mobile, we want less products
                    var productsToRender = products.length - numProdToSplit;
                    if (that.isMobile && productsToRender > that.MOBILE_NUM_PRODUCTS) {
                        productsToRender = that.MOBILE_NUM_PRODUCTS;
                    }

                    var prodType = that.Model.get('prod_type');

                    //for email sharing in photos
                    if (prodType == 'photogifts_share') {
                        spreadContainer.addClass('pg_share');
                        //hack to fix the scroll
                        if (productsToRender > 4) {
                            spreadContainer.addClass('scroll');
                        }
                    }

                    addProductContainers(containerElement, productsToRender, prodType, albums, structure);

                    if (typeof that.Model.get('modalcontainer') !== 'undefined' && that.Model.get('modalcontainer') != null) {
                        menuContainer = injectIntoEmbeddedModal(structure, prodType, that.Model.get('modalcontainer'));
                    }

                    //add link to the store and bind to the click event
                    addStoreLinkInContainer(containerElement, prodType, function(){
                        $(containerElement).find('.sfly_wgt_gotostore span').on('click', function () {
                            tracking.track('open', 'go_store', {
                                mode: "instance",
                                prod_type: prodType
                            });

                            if (that.Model.get('openInNewTab')) {
                                that.winHandler = view_common.openNewWindow(that.winHandler);

                                if (!that.IS_WIDGET_OPEN.state) {
                                    view_common.removeLoading($('.sfly_wgt_listview_container'));
                                }
                            } else {
                                that.winHandler = null;
                            }

                            // roman: should put this into one place and use everywhere
                            var currAlbums;
                            if (prodType == 'prints' || prodType == 'prints_share') {
                                currAlbums = albums.prints;
                            } else if (prodType == 'photobook' || prodType == 'photobook_share') {
                                currAlbums = albums.photobook;
                            } else if (prodType == 'calendar' || prodType == 'deskcalendar') {
                                currAlbums = albums.calendars;
                            } else {
                                currAlbums = albums.products;
                            }
                            var currAlbum = currAlbums[0];

                            var photosToTransfer = 200;
                            if (prodType != 'photobook' && prodType != 'photobook_share' && !that.isManual) {
                                photosToTransfer = 25;
                            }

                            var photoIds = _.first(currAlbum.photos.map(function (p) {
                                return parseInt(p.id)
                            }), photosToTransfer);

                            clickThrough.sendForSeeAllGeneric(that.Model.get('prod_type'), photoIds, currAlbum, that.winHandler, view_common.showLoading.bind(that, $('.sfly_wgt_listview_container')), view_common.removeLoading.bind(that, $('.sfly_wgt_listview_container')), that.Model);
                            that.Model.get('Callback')({action: 'hide_window'});
                        });
                    });

                    // updating the css of the container containing spread and store link acc to the prods (borders and scrolling and alignment)
                    that.updateProductStyle(containerElement, productsToRender);

                    // build tooltip content
                    var prodIndex = 0;

                    var callbacks = {
                        takeLock: that.takeLock.bind(that),
                        releaseLock: that.releaseLock.bind(that),
                        animateControlButton: undefined,
                        changeState: that.changeWidgetOpenState.bind(that, that.IS_WIDGET_OPEN),
                        handleCurrentPid: that.handleCurrentPid.bind(that),
                        toggleViewDisable: that.toggleViewDisable.bind(that, that.IS_VIEW_DISABLED)
                    };

                    var renderData = {
                        currPid: that.CURRENT_OPEN_PID,
                        prodStyles: prodStyles,
                        prodOptions: prodOptions,
                        forceCloseExternal: false,
                        widgetIsOpen: that.IS_WIDGET_OPEN.state,
                        isThisLife: that.isThisLifeGeneral,
                        mixedSources: that.mixedSourcesGeneral,
                        callbacks: callbacks,
                        instance: instance,
                        model: that.Model,
                        useNewStyleGuide: true,
                        doNotResizeImages: true,
                        tooltipItems: that.listOfProducts
                    };

                    _.each(products, function(sku) {
                        var currPId = sku;
                        var albumResult = that.getCurrentAlbum(sku, albums); //currAlbums[currItemOrder % currAlbums.length];
                        var currAlbum = albumResult.currAlbum;
                        var currAlbums = albumResult.currAlbums;

                        renderData = _.extend(renderData, {
                            pId: currPId,
                            currAlbum: currAlbum,
                            albums: currAlbums
                        });

                        if (typeof that.listOfProducts[sku] == 'undefined') {
                            that.listOfProducts[sku] = {};
                        }
                        that.listOfProducts[sku] = _.extend(that.listOfProducts[sku], {
                            order: prodIndex++,
                            sku: sku,
                            renderData: renderData
                        });
                    });

                    var fullRender =  $.Deferred();
                    var chunkSize = (that.isMobile && that.isTouch) ? 4 : 8;

                    renderChunk(_.first(products, productsToRender), chunkSize, fullRender, 1, renderChunk);

                    $.when(fullRender).then(function() {
                        // Remove placeholders if there are any and we're on mobile
                        if (that.isMobile && that.isTouch) {
                            $(containerElement).find('.sfly_wgt_product_placeholder').remove();
                        }
                        productProxy.getCoupon(function(){
                            that.loadPrices(containerElement, products);
                        });
                    });
                }

                that.findPositionProductsInSpreadsAsync({
                    container: containerElement,
                    spreads: spreads,
                    productJson: productJson,
                    targetHeight: commonHeight,
                    typeOfView: 'listview',
                    maxSpaceBetweenProds: MAX_SPACE_BETWEEN_PRODUCTS,
                    sidePadding: side_padding,
                    prodSizeZoomLevels: prodSizes,
                    calcElemPositionFunc: that.calcElementsPositionAsync.bind(that),
                    callback: doTheRender.bind(this)
                });
            }
        }

        utils.inheritPrototype(TLVerticalViewEngine, EngineHorizontal);

        TLVerticalViewEngine.prototype.render = function(params) {
            var source          = params.source;
            var prodStyles      = params.prodStyles;
            var prodSizes       = params.prodSizes;
            var prodOptions     = params.prodOptions;
            var showMessage     = params.showMessage;
            var modal_view      = params.modalView;
            var instance        = params.instance;
            var renderParams    = params.renderParams;
            var structure       = params.menuStructure;
            var that            = this;

            if (!utils.browserSupported()){
                that.failWidget('instance', 'tl', 'tl');
                return;
            }

            // No need to do anything - but update the collection
            if (renderParams.hasOwnProperty('onlyUpdateCollection') && renderParams.onlyUpdateCollection) {
                var albumId = String.fromCharCode(65 + Math.floor(Math.random() * 26)) + Date.now();
                var album = { albumId: albumId, photos: renderParams['photos'] };
                var albums = {
                    'photobooks': [album],
                    'products': [album],
                    'prints': [album],
                    'calendars': [album]
                };
                //that.allAlbums = that.formatAllAlbums(albums, false);
                that.Model.set('albums', that.formatAllAlbums(albums, false));
                that.Model.set('ismanualselect', renderParams.manualSelection);

                return;
            }

            this.extractUserNameData();

            var ctr = that.Model.get('container');

            that.Model.get('monitoring').eventStart('tl:Start');

            // A "fast lane" for rendering
            if (this.isRendered) {
                var productJsonNew = [];

                function _getProductJsonNew(pJson) {
                    if (pJson != null) {
                        productJsonNew = productJsonNew.concat(pJson);
                    }
                }

                var newAlbum = {
                    albumId: String.fromCharCode(65 + Math.floor(Math.random() * 26)) + Date.now(),
                    photos: renderParams['photos']
                };

                this.isFirstRun = false;

                $.when(
                    productProxy.getPhotobook(newAlbum, 40, _getProductJsonNew, false, true, source, true, false, true),
                    productProxy.getProducts(newAlbum, _getProductJsonNew, true, source, true, true, false, true),
                    productProxy.getPrints(newAlbum, _getProductJsonNew, true, source, true, false, true),
                    productProxy.getCalendar(newAlbum, _getProductJsonNew, true, source, true, false, true)
                )
                    .then(function ()
                    {
                        var allAlbums = {
                            'photobook': [renderParams['photos']],
                            'products': [renderParams['photos']],
                            'prints': [renderParams['photos']],
                            'calendars': [renderParams['photos']]
                        };
                        renderMainTemplate();
                        $(ctr).find('.sfly_wgt_listview_container').find('.sfly_wgt_product').addClass('sfly_wgt_product_placeholder').html('');
                        //this.renderView($(ctr).find('.sfly_wgt_listview_container'), source, productJsonNew, allAlbums, prodStyles, prodSizes, prodOptions, modal_view, instance);
                    })
                    .fail(function ()
                    {
                        view_common.removeLoading($('.sfly_wgt_listview_container'));
                    });
                return;
            }


            this.isRendered = true;


            var useThesePhotos = undefined;
            if(typeof renderParams !== "undefined") {
                useThesePhotos  = renderParams['photos'];

                if(typeof renderParams['manualSelect'] !== "undefined"){
                    this.isManual = renderParams['manualSelect'];
                }
            }

            this.isManual = that.Model.get('isManualSelect') ? true : false;

            this.init();

            // do not render template until we have mgsources
            function renderMainTemplate(showLoader) {
                var pEl;
                var promoElement = that.Model.get('promoElement');
                var pType = that.Model.get('prod_type');
                $(ctr).html(view_common.renderTemplate(templates.listview_cont_tlVert, { prodType: pType, isMobile: utils.isMobile }));

                //Email sharing from photos
                if (pType == 'photogifts_share') {
                    var title = (ctr).find('.sfly_wgt_listview_embedded_title');
                    $(title).html();
                    $(title).addClass('pg_share');
                    return;
                }

                var loadingContainer = $(ctr).find('.sfly_wgt_loading');
                //we are not using promo placeholder now. But lets keep it because i might get used in future
                if (promoElement !== null && $(promoElement).length > 0) {
                    pEl = promoElement;
                    $(ctr).find('.sfly_wgt_listview_embedded_title').remove();
                    loadingContainer.addClass('mobile');
                } else {
                    if (that.isMobile) {
                        loadingContainer.addClass('mobile');
                        $(ctr).find('.sfly_wgt_listview_embedded_title').addClass('mobile');
                    } else {
                        $(ctr).find('.sfly_wgt_listview_embedded_title').removeClass('mobile');
                        if (pType == 'calendar' || pType == 'deskcalendar' || pType == 'photobook' || pType == 'photobook_share') {
                            loadingContainer.addClass('sml_loader');
                        }
                    }

                    pEl = $(ctr).find('.sfly_wgt_special_offers');
                }

                that.promoEl = pEl;

                productProxy.getSflyPromos(pType, that.isMobile).then(function(response){
                    that.renderPromo(response);
                });
            }

            // Remove classes added on hover on product
            $(ctr).on('mouseleave', function() {
                that.removeHoverStates(this);
            });

            if (typeof showMessage !== 'undefined' && showMessage != null) {
                renderMainTemplate(source);
                that.horizontalShowOverlayView(showMessage, this.IS_VIEW_DISABLED.state, instance);
                return;
            }

            var failId = 0;
            var currCallId = 1;
            var productJson = [];
            function _getProductJson(callId, pJson) {
                if (pJson != null && callId != failId) {
                    productJson = productJson.concat(pJson);
                }
            }

            // Check what kind of products is this and ask for MG Source accordingly
            var getPrints   = 0;
            var getProducts = 0;
            var getBooks    = 0;
            var getCalendar = 0;

            _.each(source, function(pId) {
                var product = view_common.getProduct(pId);
                switch(product.type) {
                    case 'prints':
                        getPrints = this.PRINTS_NUM_ALBUMS;
                        break;
                    case 'photobook':
                        getBooks = this.PB_NUM_ALBUMS;
                        break;
                    case 'calendar':
                    case 'deskcalendar':
                        getCalendar = this.CAL_NUM_ALBUMS;
                        break;
                    default:
                        getProducts = this.PROD_NUM_ALBUMS;
                        break;
                }
            });

            // function for get from rankservice the project jsons and pass call the render method
            function getRankSourcesAndRender(albums, instance, isFullPhotoData){
                isFullPhotoData = isFullPhotoData || false;
                that.Model.get('monitoring').eventStart('tl:getRankService');
                var getProductsFromRank = function(retry) {
                    var d = $.Deferred();

                    var allAlbums = that.formatAllAlbums(albums, retry);
                    that.Model.set('albums', allAlbums);

                    // Check if we have enough products to create using the albums we got.
                    // We pass 100 as num of photos as we don't want to cut it
                    var cleanSource = that.cleanSourceWithAlbums(source, allAlbums, 100);

                    // if less than 3 products do not render mg
                    if (cleanSource.length < 1) {
                        console.log('[Product Widget]> Not enough resources for render.');
                        renderMainTemplate(false);
                        that.horizontalShowOverlayView('upload', that.IS_VIEW_DISABLED.state, instance);
                        d.resolve(true);
                        return;
                    }

                    var albumsToSendToRank = _.clone(allAlbums);
                    if(isFullPhotoData){
                        that.isAfterUPP = true;
                        albumsToSendToRank['photobook'] = allAlbums['photobook'][0];
                        albumsToSendToRank['products'] = allAlbums['products'][0];
                        albumsToSendToRank['prints'] = allAlbums['prints'][0];
                        albumsToSendToRank['calendars'] = allAlbums['calendars'][0];
                    }

                    var photobookOnlyCover = false; //(instance.settings['prod_type'] == "photobook" || instance.settings['prod_type'] == "photobook_share") ? false : true;

                    $.when(
                        productProxy.getPhotobook(albumsToSendToRank['photobook'], 40, _getProductJson.bind(this, currCallId), photobookOnlyCover, that.isManual, cleanSource, true, false, true),
                        productProxy.getProducts(albumsToSendToRank['products'], _getProductJson.bind(this, currCallId), that.isManual, cleanSource, true, true, false, true),
                        productProxy.getPrints(albumsToSendToRank['prints'], _getProductJson.bind(this, currCallId), that.isManual, cleanSource, true, false, true),
                        productProxy.getCalendar(albumsToSendToRank['calendars'], _getProductJson.bind(this, currCallId), that.isManual, cleanSource, true, false, true)
                    )
                        .then(function () {
                            that.Model.get('monitoring').eventEnd('tl:getRankService');
                            renderMainTemplate(true, cleanSource);

                            that.boundRenderView = that.renderView.bind(that, $(ctr).find('.sfly_wgt_listview_container'), cleanSource, productJson, allAlbums, prodStyles, prodSizes, prodOptions, modal_view, instance, structure);
                            that.boundRenderView();

                            //that.renderView($(ctr).find('.sfly_wgt_listview_container'), cleanSource, productJson, allAlbums, prodStyles, prodSizes, prodOptions, modal_view, instance, structure);
                            d.resolve(true);
                        })
                        .fail(function () {
                            if(retry) {
                                console.log('[Product Widget]> Failed loading resources (Api). Aborting.');
                                productProxy.MgFail();
                                renderMainTemplate();
                                that.failWidget('instance', 'tl', 'tl');
                            } else {
                                console.log('[Product Widget]> Failed loading resources (Api). Retrying with different source.');
                            }
                            d.reject();
                        });
                    return d.promise();
                };

                // get products from api. If fails the first time retry with a second source.
                $.when(getProductsFromRank())
                    .fail(function(){
                        failId = currCallId;
                        currCallId++;
                        productJson = [];
                        getProductsFromRank(true);
                    });
            }

            // render magic shop using some specific photos otherwise call getMgSource
            // This is for TL
            if(typeof useThesePhotos !== "undefined" && _.isArray(useThesePhotos)){
                var albumId = String.fromCharCode(65 + Math.floor(Math.random() * 26)) + Date.now();
                var album = { albumId: albumId, photos: useThesePhotos };
                var albums = {
                    photobooks: [album],
                    products: [album],
                    prints: [album],
                    calendars: [album]
                };
                this.inThisLife = true;
                cache.removeProductsAll();
                getRankSourcesAndRender(albums, instance, true);
            } else {
                // we have a 2 step process for displaying the widget
                // 1. Get the photos and albums for the user
                // 2. Get the covers for the albums
                that.Model.get('monitoring').eventStart('tl:getMgSource');
                productProxy.getMGSources(function(albums) {
                    that.Model.get('monitoring').eventEnd('tl:getMgSource');
                    if (albums != null) {
                        if (_.isEmpty(albums)) {
                            // Not enough sources. Show overlay and exit.
                            renderMainTemplate(false);
                            that.horizontalShowOverlayView('upload',that.IS_VIEW_DISABLED.state, instance);
                            return;
                        }
                        getRankSourcesAndRender(albums, instance);
                    } else {
                        console.log('[Product Widget]> Failed loading resources. Aborting.');
                        productProxy.MgFail();
                        renderMainTemplate();
                        that.failWidget('instance', 'tl', 'tl');
                    }
                });
            }
        };

        return TLVerticalViewEngine;
    });

define('app/view_engine/widgets/engines/timeline/Engine',
    ['underscore', 'app/templates', 'mgthumb', 'app/asset_mapper', 'app/config_manager', 'app/click_through', 'app/tracking', 'app/cookies', 'magicselect', 'app/album_switch', 'app/product_proxy', 'app/utils', 'app/cache_module', 'app/view_engine/widgets/common', 'app/thumbgen_wrapper', 'app/time_monitor', 'app/view_engine/widgets/engines/EngineBase', 'css!./../../../../css/widget.css', 'css!./../../../../css/MagicSelectBox.css'],
    function(_, templates, mgthumb, AssetMapper, config, clickThrough, tracking, cookies, magicselect, albumSwitch, productProxy, utils, cache, view_common, thumbGenWrapper, monitor, EngineBase, css1, css2)
    {
        function TimelineViewEngine(params) {
            EngineBase.call(this, params);

            this.findElements = function(container, classToFind) {
                var elems = $(container).find('.' + classToFind);

                return _.sortBy(elems, function(item) {
                    return $(item).attr('data-mg-order');
                });
            };

            this.renderThumb = function(elem, pId, productType, partnerId, product, layoutJson, designJson, layoutMasks) {
                var useCDN = cache.get('env') != 'beta' && cache.get('env') != 'dev';
                var mgThumbGen  = new MgThumbGenerator(cache.get('env'),useCDN);

                mgThumbGen.init(productType, partnerId, product, layoutJson, designJson, this.Model.get('monitoring').reportEvent, cache.get('env'));

                mgThumbGen.generate(0, pId, true, function(canvas) {
                    var wrapper = $('<div class="timeline-product-wrapper"></div>');
                    $(elem).html(wrapper.html(canvas));
                }, true, { masks: layoutMasks, textEnabled:(productType !== "book") });
            };

            this.renderProduct = function(elem, sku, productJson, allAlbums, prodStyles, prodSizes, prodOptions, modal_view, instance) {
                var product = view_common.findProjectJsonProduct(productJson, sku, true);
                var productType = AssetMapper.GetProductType(product);
                var partnerId = AssetMapper.GetPartnerId(product, productType);
                var prodSku = productType != 'book' ? view_common.getProduct(sku)['sku'] : view_common.getProduct(sku)['style'] + '_' + view_common.getProduct(sku)['size'];
                var that = this;

                if (productType == 'prints') {
                    var layoutJson = JSON.stringify(config.getRecipeLayout()[partnerId]);
                    var designJson = JSON.stringify(config.getRecipeDesign()[partnerId]);
                    this.renderThumb(elem, sku, productType, partnerId, product, layoutJson, designJson, undefined);
                } else {
                    // todo if thumb already was requested before - don't request again!
                    that.Model.get('monitoring').eventStart('tl:prepareThumbGenAssets:' + sku);
                    thumbGenWrapper.prepareThumbGenAssets(prodSku, sku, 'medium', productType, product, function (result) {
                        that.Model.get('monitoring').eventEnd('tl:prepareThumbGenAssets:' + sku);

                        if (result == null || typeof result.layoutJson === 'undefined' || typeof result.designJson === 'undefined') {
                            //products.sku = null;
                            console.log('[Product Widget] Missing Layout / Design json');
                            return;
                        }

                        if (productType == 'book') {
                            layoutJson = JSON.stringify(result.layoutJson[sku]);
                        } else {
                            layoutJson = JSON.stringify(result.layoutJson);
                        }

                        designJson = JSON.stringify(result.designJson);

                        that.renderThumb(elem, sku, productType, partnerId, product, layoutJson, designJson, result.layoutMasks);
                    });
                }
            };

            this.renderView = function(elements, products, productJson, allAlbums, prodStyles, prodSizes, prodOptions, modal_view, instance) {
                var idx = 0;
                var that = this;
                _.each(products, function(product) {
                    that.renderProduct(elements[idx], product, productJson, allAlbums, prodStyles, prodSizes, prodOptions, modal_view, instance);
                    idx++;
                });
            }
        }

        utils.inheritPrototype(TimelineViewEngine, EngineBase);

        TimelineViewEngine.prototype.render = function(params) {
            var source          = params.source;
            var prodStyles      = params.prodStyles;
            var prodSizes       = params.prodSizes;
            var prodOptions     = params.prodOptions;
            var modal_view      = params.modalView;
            var instance        = params.instance;
            var renderParams    = params.renderParams;
            var that            = this;

            var failId = 0;
            var currCallId = 1;
            var productJson = [];
            function _getProductJson(callId, pJson) {
                if (pJson != null && callId != failId) {
                    productJson = productJson.concat(pJson);
                }
            }

            function getRankSourcesAndRender(albums, instance, isFullPhotoData){
                isFullPhotoData = isFullPhotoData || false;
                that.Model.get('monitoring').eventStart('tl:getRankService');
                var getProductsFromRank = function(retry) {
                    var d = $.Deferred();
                    var allAlbums = that.formatAllAlbums(albums, retry);

                    // Check if we have enough products to create using the albums we got.
                    // We pass 100 as num of photos as we don't want to cut it
                    var cleanSource = that.cleanSourceWithAlbums(source, allAlbums, 100);

                    var albumsToSendToRank = _.clone(allAlbums);
                    if(isFullPhotoData){
                        that.isAfterUPP = true;
                        albumsToSendToRank['photobook'] = allAlbums['photobook'][0];
                        albumsToSendToRank['products'] = allAlbums['products'][0];
                        albumsToSendToRank['prints'] = allAlbums['prints'][0];
                        albumsToSendToRank['calendars'] = allAlbums['calendars'][0];
                    }

                    $.when(
                        productProxy.getPhotobook(albumsToSendToRank['photobook'], 40, _getProductJson.bind(this, currCallId), true, true, cleanSource, true),
                        productProxy.getProducts(albumsToSendToRank['products'], _getProductJson.bind(this, currCallId), true, cleanSource, true, true),
                        productProxy.getPrints(albumsToSendToRank['prints'], _getProductJson.bind(this, currCallId), true, cleanSource, true),
                        productProxy.getCalendar(albumsToSendToRank['calendars'], _getProductJson.bind(this, currCallId), true, cleanSource, true)
                    )
                        .then(function () {
                            that.Model.get('monitoring').eventEnd('tl:getRankService');
                            that.renderView(that.findElements(that.Model.get('container'), that.Model.get('productClass')), cleanSource, productJson, allAlbums, prodStyles, prodSizes, prodOptions, modal_view, instance);
                            d.resolve(true);
                        })
                        .fail(function () {
                            if(retry) {
                                console.log('[Product Widget]> Failed loading resources (Api). Aborting.');
                                productProxy.MgFail();
                            } else {
                                console.log('[Product Widget]> Failed loading resources (Api). Retrying with different source.');
                            }
                            d.reject();
                        });
                    return d.promise();
                };

                // get products from api. If fails the first time retry with a second source.
                $.when(getProductsFromRank())
                    .fail(function(){
                        failId = currCallId;
                        currCallId++;
                        productJson = [];
                        getProductsFromRank(true);
                    });
            }

            var albumId = String.fromCharCode(65 + Math.floor(Math.random() * 26)) + Date.now();
            var album = { albumId: albumId, photos: renderParams['photos'] };
            var albums = {
                photobooks: [album],
                products: [album],
                prints: [album],
                calendars: [album]
            };
            cache.removeProductsAll();
            getRankSourcesAndRender(albums, instance, true);
        };

        return TimelineViewEngine;
    });

define('app/globalComm', ['underscore'], function(_) {
    var MAX_CSELL_WAIT_TIME = 1000 * 20; // 20 seconds
    var WAIT_TIME           = 200;
    var totalWaitTime       = 0;

    return {
        initGlobalVars: function() {
            window._globalCrossSellMGWidgetIsReady = window._globalCrossSellMGWidgetIsReady || false;
        },

        isCrossSellReady: function() {
            if (window.location.href.indexOf('photobookPrintSetIntercept') > -1) {
                return true
            } else {
                return typeof window._globalCrossSellMGWidgetIsReady !== 'undefined' && window._globalCrossSellMGWidgetIsReady;
            }

        },

        waitForCrossSellReady: function(callback) {
            var self = this;

            // If we don't have a callback, nothing to do
            if (!_.isFunction(callback)) {
                return;
            }

            if (totalWaitTime > MAX_CSELL_WAIT_TIME) {
                console.log('[Product Widget] Cross sell wait failed. Aborting.');
                callback();
                return;
            }

            setTimeout(function() {
                if (self.isCrossSellReady()) {
                    callback();
                } else {
                    totalWaitTime += 200;
                    self.waitForCrossSellReady(callback);
                }
            }, WAIT_TIME);
        }
    }
});
define('app/view_engine/widgets/engines/replacement/Engine',
    ['underscore', 'app/templates', 'mgthumb', 'app/asset_mapper', 'app/config_manager', 'app/click_through', 'app/tracking', 'app/cookies', 'magicselect', 'app/album_switch', 'app/product_proxy', 'app/utils', 'app/cache_module', 'app/view_engine/widgets/common', 'app/thumbgen_wrapper', 'app/time_monitor', 'app/globalComm', 'app/view_engine/widgets/engines/EngineBase', 'css!./../../../../css/widget.css', 'css!./../../../../css/MagicSelectBox.css'],
    function(_, templates, mgthumb, AssetMapper, config, clickThrough, tracking, cookies, magicselect, albumSwitch, productProxy, utils, cache, view_common, thumbGenWrapper, monitor, globalComm, EngineBase, css1, css2)
    {
        function ReplaceViewEngine(params) {
            EngineBase.call(this, params);

            // Consts
            this.MAX_PHOTOS_TO_RANK_SERVICE  = 100;
            this.IS_WIDGET_OPEN              = {state:false};
            this.CURRENT_OPEN_PID            = null;

            /**
             * set or get the current opend pid
             * @param currentOpenPid
             * @returns {*}
             */
            this.handleCurrentPid = function(currentOpenPid){
                if(typeof currentOpenPid !== "undefined")
                {
                    this.CURRENT_OPEN_PID = currentOpenPid;
                }
                return this.CURRENT_OPEN_PID;
            };

            this.truncateAlbum = function(albums, maxPhotos) {
                albums.forEach(function(album) {
                    if (album.hasOwnProperty('photos')) {
                        album.photos = _.first(album.photos, maxPhotos);
                    }
                });

                return albums;
            };

            this.findAllProductDivs = function(container, replaceType) {
                if (replaceType == 'cross_sell') {
                    return $(container).find('.mg-product');
                } else if (replaceType == 'store') {
                    return $(container).find('.categoryItem:not(.catHeaderWrapper):not(.dynContent)');
                } else {
                    return [];
                }
            };

            this.updateLinkForProduct = function(linkElem, sku, productJson) {
                var that = this;
                $(linkElem).attr('href', 'javascript:void(0);').on('click', function() {
                    var prod = view_common.getProduct(sku);
                    var skuContainer = $(this).find('.sfly_wgt_product').attr('data-sku');
                    tracking.track('cross_sell', 'click', { sku: skuContainer });
                    // tracking.track('cross_sell', 'hover', { sku: skuContainer });
                    var pDiv    = $('.mg-product[data-mgsku="' + sku + '"]');
                    var personalizeUrl     = typeof prod.personalizeUrl !== 'undefined' ? prod.personalizeUrl
                        : $(pDiv).attr('data-url');
                    clickThrough.sendToClickThrough(productJson, prod.type, undefined, undefined, undefined, undefined, that.Model, personalizeUrl);
                });
            };

            this.updateLinkForProductWithModal = function(linkElem, sku, albums, product, prodStyles, prodSizes, prodOptions, modal) {
                var currAlbum,
                    that = this;
                if (product.type == 'prints') {
                    currAlbum = albums.prints[0];
                } else if (product.type == 'photobook') {
                    currAlbum = albums.photobook[0];
                } else if (product.type == 'calendar') {
                    currAlbum = albums.calendars[0];
                } else {
                    currAlbum = albums.products[0];
                }

                var callbacks = {
                    takeLock: undefined,
                    releaseLock: undefined,
                    animateControlButton: undefined,
                    changeState: this.changeWidgetOpenState.bind(this, this.IS_WIDGET_OPEN),
                    handleCurrentPid: this.handleCurrentPid.bind(this),
                    toggleViewDisable: undefined
                };

                $(linkElem).attr('href', 'javascript:void(0);').on('click', function() {
                    that.handleCurrentPid(sku);

                    modal.show({
                        pId: sku,
                        currPid: sku,
                        currAlbum: currAlbum,
                        albums: albums,
                        prodStyles: prodStyles,
                        prodOptions: prodOptions,
                        forceCloseExternal: false,
                        widgetIsOpen: false,
                        isThisLife: false,
                        mixedSources: false,
                        callbacks: callbacks,
                        model: that.Model
                    });
                });
            };

            this.updateLinksAreaForProduct = function(linksElems, sku, productJson) {
                var that = this;
                $(linksElems).attr('href', 'javascript:void(0);').on('click', function() {
                    var prod = view_common.getProduct(sku);
                    var pDiv    = $('.mg-product[data-mgsku="' + sku + '"]');
                    var personalizeUrl     = typeof prod.personalizeUrl !== 'undefined' ? prod.personalizeUrl
                        : $(pDiv).attr('data-url');
                    clickThrough.sendToClickThrough(productJson, prod.type, undefined, undefined, undefined, undefined, that.Model, personalizeUrl);
                });
            };

            this.updateLinksForStaticAssets = function(linkElems, pId) {
                var url = config.getStaticAsset(pId)['link'];
                linkElems.forEach(function(elem) {
                    $(elem).attr('href', url);
                });
            };

            this.updateDescriptionForProduct = function(descElem, product) {
                //if in prints intercepts
                if (descElem.selector !== '.recDescription') {
                    productProxy.loadPrices(function(){
                        var price = config.getPrice(product.sflySku);
                        var priceText = "";
                        if (price.originalPrice > 0) {
                            if (price.salePrice > -1) {
                                priceText = "<span class='price-old'>" + parseFloat(price.originalPrice).toFixed(2) + "</span> <span class='price-sale'>$" + parseFloat(price.salePrice).toFixed(2);
                                priceText += "</span>";
                            } else {
                                priceText = parseFloat(price.originalPrice).toFixed(2);
                            }
                        }
                        var descNewElem = 'Order your ' + product.size + ' photo book for just $' + priceText;
                        $(descElem).html(descNewElem);
                    });
                } else {
                    var descNewElem = product.formFactor + '<div class="recMessage">' + product.shortName + '</div>';
                    $(descElem).html(descNewElem);
                }
            };

            this.showStoreAnimation = function(mode) {
                var headlineContainer = $('#cluster_cat_headline_area');
                $(headlineContainer).children('#cluster_cat_marquee_well').css({
                    'opacity': 0.8
                });
                $(headlineContainer).children('#cluster_cat_promo_container').css({
                    'opacity': 0.8
                });
                $(headlineContainer).children('#flyout').css({
                    'display': 'none'
                });

                var env = cache.get('env');
                var flyout = '';
                env = env != 'prod' ? '.' + env : '';

                if (mode == "signin") {
                    flyout = $(view_common.renderTemplate(templates.store_flyout, {env: env}));
                } else if (mode == "nophoto") {
                    var isSuperFlyUser = typeof Shr !== "undefined" && typeof Shr.U !== "undefined" && typeof Shr.U.migrated !== "undefined" && Shr.U.migrated == true;
                    flyout = $(view_common.renderTemplate(templates.store_flyout_no_photos, {env: env, superfly: isSuperFlyUser}));
                } else if (mode == "welcome") {
                    flyout = $(view_common.renderTemplate(templates.store_flyout_welcome, {env: env}));
                }

                $(headlineContainer).append(flyout);

                // We need this to see the animation, otherwise it look immediate
                setTimeout(function() {
                    $(flyout).addClass('show');
                }, 200);
            };

            this.renderWithStaticAssets = function(replaceType, photos, specificSku) {

                // if is printsintercept do not render statics
                if($('#sfly-printsetintercept-bookImg.landscapeImage').length !== 0) {
                    return;
                }

                var that = this;

                if (replaceType == 'store') {
                    if(cache.get('token') != ""){
                        productProxy.getMGSources(null, true);
                    }
                    productProxy.getCoupon();
                    cache.set('full_load', true);
                    return;
                }

                // put those 3 static assets
                var productDivs = $('.mg-product');

                if (specificSku != null && typeof specificSku !== 'undefined') {
                    productDivs = productDivs.find('[data-mgsku="' + specificSku + '"]');
                }

                if (replaceType == 'cross_sell') {
                    // get 3 products
                    var prodIds     = [];
                    var usedIds     = [];
                    while (prodIds.length < productDivs.length) {
                        var newId = config.getRandomStaticAssetId();
                        // Add only new products
                        if (_.indexOf(usedIds, newId) == -1) {
                            prodIds.push({
                                pId: newId,
                                sku: config.getStaticAsset(newId)['sku']
                            });
                            usedIds.push(newId);
                        }
                    }

                    console.log('[Product Widget] Chosen SKUs for Static assets:', prodIds);

                    // Get the SKU Jsons
                    var promises = [];
                    prodIds.forEach(function(idObj) {
                        var deferred = $.Deferred();
                        promises.push(deferred);

                        thumbGenWrapper.loadProductSKU(idObj.sku, idObj.pId, '', 'medium', function() {
                            deferred.resolve();
                        });
                    });

                    $.when.apply(undefined, promises).then(function() {
                        var i = 0;
                        prodIds.forEach(function(idObj) {
                            var pDiv = $(productDivs[i]);

                            console.log('[Product Widget] Start working on static asset:', idObj.pId);

                            $(pDiv).attr('data-mgsku', idObj.sku).attr('data-mgid', idObj.pId);

                            var thumbArea       = $(pDiv).find('.recThumbArea');
                            var descArea        = $(pDiv).find('.recDescription');
                            var priceArea       = $(pDiv).find('.pricing');
                            var productImage    = $(thumbArea).find('img.projImg');
                            var linksArea       = $(pDiv).find('.CTASection');
                            var imgSize = {
                                width: thumbArea.width() - 30,
                                height: thumbArea.height() - 30
                            };

                            $(thumbArea).find('.sub-spinner').remove();

                            if (productImage.length > 0) {
                                $(productImage).attr('src', config.getStaticAsset(idObj.pId)['image']+"?");
                            } else {
                                // add the image, it doesn't exist
                                $($(thumbArea).children('a')[0]).append('<img class="projImg personalizedThumbnail" src="' + config.getStaticAsset(idObj.pId)['image'] + '?" />');
                            }

                            var prod = view_common.getProduct(idObj.sku);

                            that.updateLinksForStaticAssets([$(thumbArea).children('a'), $(linksArea).find('a')], idObj.pId);
                            that.updateDescriptionForProduct(descArea, prod);

                            i++;
                        });
                    }).then(function() {
                        productProxy.loadPrices(function() {
                            // Prices are loaded, update the divs
                            _.each(prodIds, function(idObj) {
                                var pDiv = $('.mg-product[data-mgsku="' + idObj.sku + '"]')[0];
                                var priceArea = $(pDiv).find('.pricing');
                                var product = view_common.getProduct(idObj.sku);

                                that.updatePriceForProduct(priceArea, product, 'replacement')
                            });

                            if(cache.get('token') != ""){
                                productProxy.getMGSources(null, true);
                            }
                            productProxy.getCoupon();
                            cache.set('full_load', true);
                        });
                    });
                }
            };

            this.updateProductSize = function(elem, sku, productJson, targetSize, useWidth, widgetType) {

                var product                     = config.getProductBySku(sku);
                var size                        = view_common.getProductRealSize(productJson, sku);
                if (typeof useWidth !== void 0 && useWidth) {
                    var ratio                   = targetSize.width / size.width;
                    var targetRealWidth         = targetSize.width + (size.right + size.left) * ratio;
                    var targetRealHeight        = (size.realHeight + size.top + size.bottom)*ratio;
                } else {
                    var ratio                   = targetSize.height / (size.height - size.top - size.bottom);
                    var targetRealWidth         = (size.width + size.right + size.left) * ratio;
                    var targetRealHeight        = targetSize.realHeight + (size.top + size.bottom)*ratio;
                }


                // The shopping bag sizing is not including the handle. Should make it smaller when in cross sell.
                var centerFix_x = 0,
                    centerFix_y = 0,
                    resizeRatio = 1;
                if (product.type === 'addresslabel' && widgetType === 'cross_sell') {
                    targetRealHeight = 0.8 * targetRealHeight;
                    targetRealWidth  = 0.8 * targetRealWidth;
                } else if (product.type === 'shoppingbag' && widgetType === 'cross_sell') {
                    targetRealHeight = 0.8 * targetRealHeight;
                    targetRealWidth  = 0.8 * targetRealWidth;
                } else if (product.type == 'glassmagnet' && widgetType == 'cross_sell') {
                    targetRealHeight = 0.5 * targetRealHeight;
                    targetRealWidth = 0.5 * targetRealWidth;
                } else if (product.type == 'framedprint' && product.sizeId == 279 && widgetType == 'cross_sell') {
                    targetRealHeight = 0.9 * targetRealHeight;
                    targetRealWidth = 0.9 * targetRealWidth;
                } else if (widgetType == 'store') {
                    if (['mug','mouse','travelmug','iphone','playingcards','candle','card','pillow','glassor'].indexOf(product.type) > -1) {
                        resizeRatio      = 0.8;
                        targetRealHeight = resizeRatio * targetRealHeight;
                        targetRealWidth  = resizeRatio * targetRealWidth;

                        // Need to fix the centering after the resize
                        centerFix_x = (1 - resizeRatio) * (size.width * ratio);
                        centerFix_y = (1 - resizeRatio) * (size.realHeight * ratio);
                    }
                }

                $(elem)
                    .height(targetRealHeight)
                    // .width(targetRealWidth)
                    .attr('data-height',        targetRealHeight)
                    .attr('data-width',         targetRealWidth)
                    .attr('data-real-height',   targetRealHeight)
                    .attr('data-real-width',    size.width*ratio)
                    .attr('data-top-size',      size.top*ratio)
                    .attr('data-bottom',        size.bottom*ratio)
                    .attr('data-left',          size.left*ratio)
                    .attr('data-right',         size.right*ratio);

                if(typeof window.MagicShop.parentApp === "undefined" || window.MagicShop.parentApp !== "IC_WEB_CART" ) {
                    $(elem).width(targetRealWidth)
                }


                if (widgetType === 'cross_sell') {
                    var prc = 0.9;
                    var widthRatio  = (targetSize.wrapperWidth*prc)  / size.width;
                    var heightRatio = (targetSize.wrapperHeight*prc) / size.realHeight;
                    var ratio = Math.min(widthRatio, heightRatio);

                    var marginTop  = (targetSize.wrapperHeight - size.height*ratio)/2   + ((size.top + size.bottom)/2 -size.top )*ratio;
                    var marginLeft = (targetSize.wrapperWidth - size.origWidth*ratio)/2 + ((size.left + size.right)/2 -size.left)*ratio;

                    var imageWidth = size.origWidth*ratio;
                    var imageHeight = size.height*ratio;

                    $(elem).css({
                        'position': 'absolute',
                        'width': imageWidth + 'px',
                        'height': imageHeight + 'px',
                        'top': marginTop + 'px',
                        'left': marginLeft + 'px'
                    });
                } else {
                    // Need to center inside the box
                    var wrapperCenter_x     = targetSize.wrapperWidth / 2;
                    var productCenter_x     = (size.width * ratio) / 2;
                    var wrapperCenter_y     = targetSize.wrapperHeight / 2;
                    var productCenter_y     = (size.realHeight * ratio) / 2;

                    if (product.type == 'travelmug') {
                        productCenter_x = productCenter_x * resizeRatio;
                    } else if (product.type == 'pillow') {
                        productCenter_x += 20;
                    }

                    var left                = (wrapperCenter_x - productCenter_x) - (size.left * ratio) + centerFix_x;
                    var top                 = (wrapperCenter_y - productCenter_y) - (size.top * ratio) - 20 + centerFix_y; // (-30) for half the bottom text

                    $(elem).css({
                        'position': 'absolute',
                        'top': top + 'px',
                        'left': left + 'px'
                    });
                }
            };

            this.updateProductSizeInBox = function(elem, sku, productJson, targetSize, widgetType) {
                // decide if to use Width or height
                var size = view_common.getProductRealSize(productJson, sku);
                this.updateProductSize(elem, sku, productJson, targetSize, size.width > size.realHeight, widgetType);
            };

            // Will render all pages for a product in the given container
            this.renderProducts = function(pId, productType, container, mgThumbGen, masks, onRenderedCallback) {
                var PRODUCT_PROJECTIONS = 5;

                // We need this function to keep the right order inside the generate function
                var generated = 0;
                function _generate(order) {
                    mgThumbGen.generate(parseInt(order), pId, true, function(canvas) {
                        $(canvas).attr('data-order', order).hide();
                        $(container).append(canvas);
                        generated++;

                        if(typeof(onRenderedCallback) !== "undefined" && _.isFunction(onRenderedCallback)){
                            if(generated == PRODUCT_PROJECTIONS -1) {
                                onRenderedCallback();
                            }
                        }
                    }, true, { masks: masks, textEnabled:(productType !== "book") });
                }

                if (!$(container).attr('data-rendered')) {
                    // Put this first - to block more attempts to render
                    $(container).attr('data-rendered', true);
                    var numOfPages = PRODUCT_PROJECTIONS;
                    $(container).attr('data-pages', PRODUCT_PROJECTIONS);

                    function generateWithTimeout(i) {
                        setTimeout(function(){_generate(i);},i*50);
                    }

                    for(var i = 1; i < numOfPages; i++) {
                        generateWithTimeout(i);
                    }
                }
            };

            // return a canvas
            this.renderProduct = function(widgetType, sku, pId, mainContainer, descArea, priceArea, linksArea, targetImgToReplace, targetSize, productJson, albums, prodStyles, prodSizes, prodOptions, modal_view, promiseOnFinish) {
                var that = this;
                console.log('[Product Widget] Starting to generate: ', sku);

                var newContainer = $('<div class="sfly-wgt-prod-container"></div>').css({
                    'width': targetSize.width + 'px',
                    'height': targetSize.height + 'px',
                    'background': 'white',
                    'display': 'none'
                }).attr('data-sku', sku);

                if (widgetType == 'cross_sell') {
                    $(mainContainer)
                        .html(newContainer);
                } else {
                    $(mainContainer)
                        .prepend(newContainer);
                }

                // generate the canvas
                var containerElement    = $(mainContainer).children('.sfly-wgt-prod-container');
                var product             = view_common.findProjectJsonProduct(productJson, sku);

                if (widgetType == 'cross_sell') {
                    containerElement.wrap('<a href="#"></a>');
                }

                if (typeof product === 'undefined' || product === 'undefined') {
                    console.log('[Product Widget] Product not found: ', sku);
                    return;
                }

                var deferred = $.Deferred();

                function renderThumb(productType, partnerId, product, layoutJson, designJson, layoutMasks, prod, promise) {
                    var useCDN = cache.get('env') != 'beta' && cache.get('env') != 'dev';
                    var mgThumbGen  = new MgThumbGenerator(cache.get('env'),useCDN);

                    mgThumbGen.init(productType, partnerId, product, layoutJson, designJson, that.Model.get('monitoring').reportEvent, cache.get('env'));

                    that.Model.get('monitoring').eventStart(widgetType+':mgThumbGenerate:' + pId);
                    mgThumbGen.generate(parseInt(0), pId, true, function(canvas) {
                        that.Model.get('monitoring').eventEnd(widgetType+':mgThumbGenerate:' + pId);
                        var elem = $(view_common.renderTemplate(templates.fullview_product, { pid: pId, sku: view_common.getProduct(sku)['sflySku'], ptype: productType }));
                        $(canvas).attr('data-order', 0);
                        elem
                            .children('.sfly_wgt_product_inner')
                            .html(canvas);

                        var productInner = elem.children('.sfly_wgt_product_inner');
                        productInner.addClass('mg-rendered');

                        $(targetImgToReplace).fadeOut(200, function() {
                            $(targetImgToReplace).remove();
                        });

                        // targetImgToReplace might not be present, so we wait outside
                        setTimeout(function() {
                            $(containerElement).fadeIn(100).append(elem);
                        }, 200);

                        promise.resolve();

                        $(mainContainer).find('.sub-spinner').remove();

                        console.log('[Product Widget] Generated product: ', pId);

                        if (widgetType == 'cross_sell') {
                            that.updateProductSize(productInner, sku, productJson, targetSize, undefined, widgetType);
                        } else {
                            that.updateProductSizeInBox(productInner, sku, productJson, targetSize, widgetType);
                        }

                        if (widgetType == 'cross_sell') {
                            //regular cross sell - not prints intercept
                            if ($('.recDescription').length > 0) {
                                that.updateLinkForProduct($(mainContainer).children('a'), sku, product);
                                that.updateLinksAreaForProduct($(linksArea).find('a'), sku, product);
                                that.updateDescriptionForProduct(descArea, prod);
                            } else {
                                //remove previous links
                                $('#sfly-printsetintercept-promoBook').prop('onclick',null);
                                $('#sfly-printsetintercept-previewButton').prop('onclick', null);
                                $('#sfly-printsetintercept-previewButton a').prop('onclick', null);
                                $('#sfly-printsetintercept-bookTitle a').prop('onclick', null);
                                $("#sfly-printsetintercept-previewButton").removeClass("disable");
                                $("#sfly-printsetintercept-cartButton").removeClass("disable");

                                that.updateLinksAreaForProduct($(linksArea).find('a'), sku, product);
                                that.updateLinksAreaForProduct($(mainContainer).parent(), sku, product);
                                that.updateLinksAreaForProduct($('#sfly-printsetintercept-bookTitle a'), sku, product);
                                that.updateDescriptionForProduct(descArea, prod);
                            }

                        }  else {
                                that.updateLinkForProductWithModal($(mainContainer).parent(), sku, albums, prod, prodStyles, prodSizes, prodOptions, modal_view);
                        }

                        // if is a rotatable render it and bind mousemove action
                        if(view_common.isProductRotatable(productType)) {
                            function enableMove() {
                                productInner.on('mousemove', function (event) {
                                    if ($(this).parent().parent().hasClass('sfly-wgt-dont-act')) { // Not yet ready for action.
                                        return;
                                    }

                                    var pages = $(this).attr('data-pages');
                                    var rightPadding = parseFloat(($(this).attr('data-right')));
                                    var boxWidth = $(this).width() - rightPadding;
                                    var leftPadding = parseFloat(($(this).css('left')).replace("px", ""));

                                    // Calc real position
                                    var targetPos = $(event.currentTarget).offset();
                                    var mousePos = {top: event.pageY, left: event.pageX};
                                    var realPos = {top: mousePos.top - targetPos.top, left: mousePos.left - targetPos.left};

                                    var currPage = Math.floor((realPos.left + leftPadding) * pages / boxWidth);

                                    if (currPage < 0) {
                                        currPage = 0;
                                    } else if (currPage >= pages - 1) {
                                        currPage = pages - 1;
                                    }

                                    $(this).find('canvas').hide();
                                    $(this).find('canvas[data-order=' + currPage + ']').show();
                                });
                            }

                            that.renderProducts(pId, productType, productInner, mgThumbGen, layoutMasks, enableMove);
                        }

                    }, true, { masks: layoutMasks, textEnabled:(productType !== "book") });
                }

                var localProd   = view_common.findProjectJsonProduct(productJson, sku);
                var productType = AssetMapper.GetProductType(localProd);
                var prod        = view_common.getProduct(sku);

                if (prod.type == 'prints') {
                    var partnerId   = AssetMapper.GetPartnerId(localProd, productType);
                    var layoutJson  = JSON.stringify(config.getRecipeLayout()[partnerId]);
                    var designJson  = JSON.stringify(config.getRecipeDesign()[partnerId]);

                    if (typeof promiseOnFinish !== 'undefined') {
                        promiseOnFinish.resolve();
                    }

                    renderThumb(productType, partnerId, product, layoutJson, designJson, null, prod, deferred);
                } else {
                    that.Model.get('monitoring').eventStart(widgetType+':prepareThumbGenAssets:' + sku);
                    thumbGenWrapper.prepareThumbGenAssets(sku, pId, 'medium', prod.type, product, function (result) {
                        that.Model.get('monitoring').eventEnd(widgetType+':prepareThumbGenAssets:' + sku);
                        if (result == null || typeof result.layoutJson === void 0 || typeof result.designJson === void 0) {
                            console.log('[Product Widget] Missing Layout / Design json');
                            // Render static assets
                            that.renderWithStaticAssets(widgetType, null, sku);
                            return;
                        }

                        if (typeof promiseOnFinish !== 'undefined') {
                            promiseOnFinish.resolve();
                        }

                        var prod = view_common.getProduct(sku);

                        var layoutJson;
                        if (prod.type == 'book' || prod.type == 'photobook') {
                            layoutJson = JSON.stringify(result.layoutJson[pId]);
                        } else {
                            layoutJson = JSON.stringify(result.layoutJson);
                        }

                        var designJson  = JSON.stringify(result.designJson);
                        var productType = AssetMapper.GetProductType(product);
                        var partnerId   = AssetMapper.GetPartnerId(product, productType);

                        renderThumb(productType, partnerId, product, layoutJson, designJson, result.layoutMasks, prod, deferred)
                    });
                }

                return deferred;
            };

            this.renderProductsCrossSell = function(skus, productJson, allAlbums, prodStyles, prodSizes, prodOptions, modal_view, type) {
                if(skus.length === 0){
                    return;
                }

                //console.log('[Product Widget] all elements:', productDivs);
                var promises = [];
                var that = this;

                if (!utils.browserSupported()) {
                    console.log('[Product Widget] Browser not supported - using static assets');
                    this.renderWithStaticAssets('cross_sell', allAlbums['products'][0].photos);
                    return;
                }

                var isUsedSku = {};
                _.each(skus, function(sku) {

                    if((Object.keys(isUsedSku)).indexOf(sku) == -1){
                        isUsedSku[sku] = 0;
                    } else {
                        isUsedSku[sku] = isUsedSku[sku]+1;
                    }

                    if(type == "book")
                    {
                        var pId = sku;
                        var pDiv    = $('.mg-product[data-mgid="pb_' + sku + '"]')[isUsedSku[sku]];
                    }
                    else if(type == "calendar")
                    {
                        var pId = sku;
                        var pDiv    = $('.mg-product[data-mgid="cal_' + sku + '"]')[isUsedSku[sku]];
                    }
                    else
                    {
                        var pDiv    = $('.mg-product[data-mgsku="' + sku + '"]')[isUsedSku[sku]];
                        var pId     = $(pDiv).attr('data-mgid');
                    }

                    console.log('[Product Widget] Start working on product:', sku);

                    var thumbArea       = $(pDiv).find('.recThumbArea').length > 0 ? $(pDiv).find('.recThumbArea') : $(pDiv).find('#sfly-printsetintercept-bookImg');
                    if (window.MagicShop.parentApp === "IC_WEB_CART") {
                        thumbArea.addClass('ic-web-cart');
                    }

                    var descArea        = $(pDiv).find('.recDescription').length > 0 ? $(pDiv).find('.recDescription') : $(pDiv).find('#sfly-printsetintercept-bookFormat');
                    var priceArea       = $(pDiv).find('.pricing').length > 0 ? $(pDiv).find('.pricing') : "";
                    var productImage    = $(thumbArea).find('img.projImg').length > 0 ? $(thumbArea).find('img.projImg') : $(thumbArea).find('img');
                    var linksArea       = $(pDiv).find('.CTASection').length > 0 ? $(pDiv).find('.CTASection') : $(pDiv).find('#sfly-printsetintercept-previewButton');
                    var imgSize = {
                        width: thumbArea.width() - 30,
                        height: thumbArea.height() - 30,
                        wrapperWidth: $(thumbArea).width(),
                        wrapperHeight: $(thumbArea).height()
                    };

                    var deferred = that.renderProduct('cross_sell', sku, pId, thumbArea, descArea, priceArea, linksArea, productImage, imgSize, productJson, allAlbums, prodStyles, prodSizes, prodOptions, modal_view);
                    promises.push(deferred);
                });

                $.when.apply(undefined, promises).then(function() {
                    productProxy.loadPrices(function() {
                        // Prices are loaded, update the divs
                        var isUsedSku = {};
                        _.each(skus, function(sku) {
                            if((Object.keys(isUsedSku)).indexOf(sku) == -1){
                                isUsedSku[sku] = 0;
                            } else {
                                isUsedSku[sku] = isUsedSku[sku]+1;
                            }
                            var pDiv = $('.mg-product[data-mgsku="' + sku + '"]')[isUsedSku[sku]];
                            var priceArea = $(pDiv).find('.pricing');
                            var product = view_common.getProduct(sku);

                            that.updatePriceForProduct(priceArea, product, 'replacement');
                        });

                        that.Model.get('monitoring').eventEnd('cross_sell:Start');

                        if(cache.get('token') != ""){
                            productProxy.getMGSources(null, true);
                        }
                        productProxy.getCoupon();
                        cache.set('full_load', true);
                    });

                    //if prints cross-sell
                    if($('#sfly-printsetintercept-bookImg.landscapeImage').length > 0) {
                        $('#sfly-printsetintercept-bookImg.landscapeImage').css('background-image', "none").css('visibility', 'visible');
                        $('#sfly-printsetintercept-playBtn').hide();
                        $('#sfly-printsetintercept-loader-img').hide();
                    }
                })
            };

            this.renderProductsStore = function(skus, pids, productDivs, productJson, allAlbums, prodStyles, prodSizes, prodOptions, modal_view) {
                var that = this;

                if (!utils.browserSupported()) {
                    console.log('[Product Widget] Browser not supported - using static assets');
                    this.renderWithStaticAssets('store', allAlbums['products'][0].photos);
                    return;
                }

                var promises = [];

                _.each(skus, function(sku, idx) {
                    var pDiv = productDivs[idx];
                    var pId  = pids[idx];

                    console.log('[Product Widget] Start working on product:', sku);

                    var thumbArea       = $(pDiv).find('.productWrapper');
                    var productImage    = $(thumbArea).find('img.productImage');
                    // The (-55) for height is the text under the product
                    var imgSize = {
                        width: $(thumbArea).width() - 40,
                        height: $(thumbArea).height() - 65,
                        wrapperWidth: $(thumbArea).width(),
                        wrapperHeight: $(thumbArea).height()
                    };

                    var deferred = $.Deferred();
                    promises.push(deferred);

                    that.renderProduct('store', sku, pId, thumbArea, null, null, null, productImage, imgSize, productJson, allAlbums, prodStyles, prodSizes, prodOptions, modal_view, deferred);
                });

                $.when.apply(undefined, promises).then(function() {
                    productProxy.loadPrices(function(){
                        if(cache.get('token') != ""){
                            productProxy.getMGSources(null, true);
                        }
                        productProxy.getCoupon();
                        cache.set('full_load', true);
                    });
                })
            };

            this.doRenderCrossSell = function(prodSizes, prodStyles, prodOptions, replaceType, modal_view) {
                // Get all SKUs on page
                var productDivs = this.findAllProductDivs($('body'), 'cross_sell');
                var that = this;

                var ids = _.map(productDivs, function(pDiv) {
                    if (typeof $(pDiv).attr('data-mgsku') !== 'undefined') {
                        if ($(pDiv).attr('data-mgsku').length > 0) {
                            var prodCode = $(pDiv).attr('data-mgpc');
                            prodCode = (typeof prodCode !== typeof undefined && prodCode !== false) ? prodCode : '';
                            return {
                                sku: $(pDiv).attr('data-mgsku'),
                                pid: $(pDiv).attr('data-mgid'),
                                pc: prodCode
                            };
                        } else if ($(pDiv).attr('data-mgsku').length == 0 && $(pDiv).attr('data-mgid').length > 0 && $(pDiv).attr('data-mgid').indexOf('pb_') != -1 ) {

                            return {
                                sku: $(pDiv).attr('data-mgid').replace("pb_", ""), //remove the pb_
                                pid: $(pDiv).attr('data-mgid'),
                                pc: ''
                            };
                        } else if ($(pDiv).attr('data-mgsku').length == 0 && $(pDiv).attr('data-mgid').length > 0 && $(pDiv).attr('data-mgid').indexOf('cal_') != -1 ) {

                            return {
                                sku: $(pDiv).attr('data-mgid'),
                                pid: $(pDiv).attr('data-mgid'),
                                pc: ''
                            };
                        }
                        else if ($(pDiv).attr('data-mgid').length > 0) {
                            return {
                                sku: $(pDiv).attr('data-mgsku'),
                                pid: $(pDiv).attr('data-mgid'),
                                pc: ''
                            };
                        } else {
                            return null;
                        }
                    } else if($(pDiv).attr('data-mgid').indexOf('pb_') != -1){
                        return {
                            sku: $(pDiv).attr('data-mgid').replace("pb_", ""), //remove the pb_
                            pid: $(pDiv).attr('data-mgid'),
                            pc: ''
                        };
                    } else {
                        return null;
                    }

                });

                // Clean out failures
                ids = _.filter(ids, function(id) {
                    return id != null;
                });

                var pIds = _.pluck(ids, 'pid');

                // We want to make sure the given SKUs exists, and if not - replace the given SKU
                var newIds      = [];
                var promises    = [];
                _.each(ids, function(id, index) {
                    var deferred = $.Deferred();
                    promises.push(deferred);
                    // The creates only a HEAD call - so it's fast. It will return a new Sku/Pid if the requested one
                    // not found.
                    that.Model.get('monitoring').eventStart('cross_sell:checkSKUExists:' + id.sku);
                    thumbGenWrapper.checkSKUExists(id.sku, id.pid, id.pc, pIds, 'medium', function(sku, pId, type) {

                        // report used skus
                        var reportSkuDisplayParams = {
                            event: "sku_displayed",
                            adobeSku: id.sku
                        };
                        if (id.sku !== sku) {
                            reportSkuDisplayParams.usedSku = sku;
                        }
                        that.Model.get('athenaLogger').logEvent(reportSkuDisplayParams);

                        that.Model.get('monitoring').eventEnd('cross_sell:checkSKUExists:' + id.sku);
                        newIds.push({
                            sku: sku,
                            pid: pId,
                            type: type
                        });

                        // The new SKU is not the requested one - update the div.
                        // Find that div and update the data.
                        if (id.sku != sku) {
                            var prefix = "";
                            if (id.pid.indexOf('pb_') != -1 || id.pid.indexOf('cal_') != -1)
                            {
                                prefix = id.pid.indexOf('pb_') != -1 ? 'pb_' : 'cal_';
                            }
                            $($('.mg-product')[index]).attr('data-mgsku', sku).attr('data-mgid', prefix + pId);

                            // remove from existing skus the old sku and add the new one
                            pIds = _.reject(pIds, function(prodId) { return prodId == id.pid });
                            pIds.push(pId);
                            id.pid = pId;
                        }

                        // Save to cache the pId
                        var prod,
                            layoutId = '',
                            pIdParts = id.pid.split('_');

                        // try to get the layoutId
                        var prodLocal = view_common.getProduct(id.sku);
                        if (typeof prodLocal !== 'undefined' && prodLocal.hasOwnProperty('layoutId')) {
                            layoutId = prodLocal.layoutId;
                        }

                        // if we have the attribute layout in the div use it
                        var prodDiv = $('.mg-product[data-mgsku="'+id.sku+'"]');
                        if(prodDiv.length > 0 && typeof prodDiv.attr('data-mlayout') != "undefined"){
                            layoutId = prodDiv.attr('data-mlayout');
                        }

                        if (pIdParts.length == 3  && (pIdParts[0] !== 'pb') && (pIdParts[0] !== 'cal')) {
                            prod = {
                                type: 'product',
                                occasionId: pIdParts[0],
                                styleId: pIdParts[1],
                                sizeId: pIdParts[2],
                                sku: sku,
                                layoutId: layoutId
                            }
                        } else  if (pIdParts.length == 3 && pIdParts[0] === 'pb'){
                            // We don't support prints, so only book
                            prod = {
                                type: 'photobook',
                                style: pIdParts[1],
                                size: pIdParts[2],
                                sku: sku
                            }
                        }
                        else  if (pIdParts.length == 3 && pIdParts[0] === 'cal'){
                            // We don't support prints, so only book
                            prod = {
                                type: 'calendar',
                                style: pIdParts[1],
                                size: pIdParts[2],
                                sku: sku
                            }
                        }else if (type == 'book' && pIdParts.length == 2) {  // YS - to remove somehow
                            prod = {
                                type: 'photobook',
                                style: pIdParts[1],
                                size: pIdParts[2],
                                sku: sku
                            }
                        }
                        config.addToProductsJson(id.sku, prod);

                        deferred.resolve();
                    });
                });

                $.when.apply(undefined, promises).then(function() {

                    var bookSkus = [];
                    var calendarSku = [];
                    var productIds = [];
                    for(var k=0; k  < newIds.length; k++) {
                        if (newIds[k].type === 'book') {
                            bookSkus.push(newIds[k]);
                        }
                        else if(newIds[k].type === 'calendar') {
                            calendarSku.push(newIds[k]);
                        }
                        else if(newIds[k].type === 'product') {
                            productIds.push(newIds[k]);
                        }
                    }
                    if(bookSkus.length)
                    {
                        bookSkus = _.pluck(bookSkus, 'sku');
                    }
                    if(calendarSku.length)
                    {
                        calendarSku = _.pluck(calendarSku, 'pid');
                    }

                    var skus = [];
                    var pids = [];
                    if(productIds.length) {
                        skus = _.pluck(productIds, 'sku');
                        pids = _.pluck(productIds, 'pid');
                    }

                    // We want one album for each type of product - as all might appear
                    var getBooks    = 1;
                    var getProducts = 1;
                    var getCalendar = 1;
                    var getPrints   = 1;

                    that.Model.get('monitoring').eventStart('cross_sell:getMgSource');
                    var getMgSourcesCallback = function(albums) {
                        that.Model.get('monitoring').eventEnd('cross_sell:getMgSource');

                        // use photoIds logic, for now, only on prints intercpt page
                        if (typeof window.MagicShop.PhotoIds !== 'undefined' && $('#sfly-printsetintercept-bookImg.landscapeImage').length !== 0) {
                            // set user migrated if we don't have mg but we have photoIds
                            if ((albums === null || albums.length === 0)) {
                                cache.set('superfly_user', true);
                                albums = {};
                            }

                            albums.photobooks = albums.photobooks || [];
                            albums.products = albums.photobooks || [];
                            albums.prints = albums.photobooks || [];
                            albums.calendars = albums.photobooks || [];

                            var photoIds = that.getPhotoIds(window.MagicShop.PhotoIds);
                            var coverPhotos = that.getCoverPhotos(window.MagicShop.PhotoIds);
                            var uniqid = String.fromCharCode(65 + Math.floor(Math.random() * 26)) + Date.now();
                            if(photoIds.length > 0) {
                                albums.photobooks.unshift({'albumId': uniqid, 'photos': photoIds});
                                albums.products.unshift({'albumId': uniqid, 'photos': photoIds});
                                albums.prints.unshift({'albumId': uniqid, 'photos': photoIds});
                                albums.calendars.unshift({'albumId': uniqid, 'photos': photoIds});
                            }
                        }

                        if (albums !== null) {
                            if (albums.length === 0) {
                                // Not enough sources. use Static assets.
                                that.renderWithStaticAssets('cross_sell', null);
                                return;
                            }

                            var albumsPhotobook = albums.photobooks || [];
                            var albumsProducts  = albums.products || [];
                            var albumsPrints    = albums.prints || [];
                            var albumsCalendars = albums.calendars || [];

                            albumsPhotobook = that.truncateAlbum(albumsPhotobook, that.MAX_PHOTOS_TO_RANK_SERVICE);
                            albumsProducts  = that.truncateAlbum(albumsProducts, that.MAX_PHOTOS_TO_RANK_SERVICE);
                            albumsPrints    = that.truncateAlbum(albumsPrints, that.MAX_PHOTOS_TO_RANK_SERVICE);
                            albumsCalendars = that.truncateAlbum(albumsCalendars, that.MAX_PHOTOS_TO_RANK_SERVICE);

                            // We don't want to send too much info. So we truncate up to MAX_PHOTOS
                            var allAlbums = {
                                'photobook': albumsPhotobook,
                                'products': albumsProducts,
                                'prints': albumsPrints,
                                'calendars': albumsCalendars
                            };

                            console.log('[Product Widget] >> Starting Cross Sell render');

                            var productJson = [];
                            function _getProductJson(pJson) {
                                if (pJson !== null) {
                                    productJson = productJson.concat(pJson);
                                }
                            }

                            // todo - might be that the rank service will not return SOME of the products
                            // - should change that product and ask again for products.

                            that.Model.get('monitoring').eventStart('cross_sell:getProducts');
                            $.when(
                                productProxy.getPhotobook(albumsPhotobook, 40, _getProductJson, false, true, skus, false, false, false, bookSkus),
                                productProxy.getProducts(albumsProducts, _getProductJson, true, skus, true, false, false, false, false, null, coverPhotos),
                                productProxy.getPrints(albumsPrints, _getProductJson, true, skus),
                                productProxy.getCalendar(albumsCalendars, _getProductJson, true, skus, false, false, false, calendarSku)
                            )
                                .then(function() {
                                    // Do tracking for loading
                                    tracking.track('cross_sell', 'on_load');
                                    that.Model.get('monitoring').eventEnd('cross_sell:getProducts');

                                    if(productJson.length > 0){
                                        that.renderProductsCrossSell(skus, productJson, allAlbums, prodStyles, prodSizes, prodOptions, modal_view);
                                        that.renderProductsCrossSell(bookSkus, productJson, allAlbums, prodStyles, prodSizes, prodOptions, modal_view, 'book');
                                        that.renderProductsCrossSell(calendarSku, productJson, allAlbums, prodStyles, prodSizes, prodOptions, modal_view, 'calendar');
                                    } else {
                                        console.log('[Product Widget]> Failed loading resources. Aborting.');
                                        that.renderWithStaticAssets('cross_sell', albumsProducts[0].photos);
                                    }
                                })
                                .fail(function() {
                                    console.log('[Product Widget]> Failed loading resources. Aborting.');
                                    that.renderWithStaticAssets('cross_sell', albumsProducts[0].photos);
                                });

                        } else {
                            console.log('[Product Widget]> Failed loading resources. Aborting.');
                            that.renderWithStaticAssets('cross_sell', null);
                        }
                    };
                    productProxy.getMGSources(getMgSourcesCallback, false, 'vips');
                });
            };

            this.doRenderStore = function(params) {
                // User not available - show only animation. Can't render anything.
                if (cache.get('user_msg') == 'signin') {
                    console.log('[Product Widget] Showing Store animation');
                    this.showStoreAnimation('signin');
                    return;
                }

                var prodStyles      = params.prodStyles;
                var prodSizes       = params.prodSizes;
                var prodOptions     = params.prodOptions;
                var modal_view      = params.modalView;
                var replaceType     = params.replaceType;
                var getBooks        = 1;
                var getProducts     = 1;
                var getCalendar     = 1;
                var getPrints       = 1;
                var productDivs     = this.findAllProductDivs($('body'), 'store');
                var that            = this;

                productProxy.getMGSources(function(albums) {
                    if (albums != null) {
                        if (albums.length == 0) {
                            // Not enough sources. use Static assets.
                            that.showStoreAnimation('nophoto');
                            that.renderWithStaticAssets('store', null);
                            return;
                        }

                        var slotId,
                            product,
                            prodResult,
                            assoc,
                            skus = [],
                            pids = [],
                            products = [],
                            bookSkus = [], bookPids = [],
                            printSkus = [], printPids = [],
                            fullSkus = [], fullPids = [];

                        function addProduct(product, isAssc) {
                            if (product != null && typeof product !== 'undefined') {
                                var productId = config.parseProductId(product);

                                if (!isAssc) {
                                    fullSkus.push(product.sku);
                                    fullPids.push(productId);
                                }

                                // As we're running through the SKUs, we might get duplicates. Does this matter?

                                if (product.type == 'photobook') {
                                    bookSkus.push(product.sku);
                                    bookPids.push(productId);
                                }
                                else if (product.type == 'prints') {
                                    printSkus.push(product.sku);
                                    printPids.push(productId);
                                }
                                else {
                                    skus.push(product.sku);
                                    pids.push(productId);
                                    products.push(product);
                                }
                            }
                        }

                        // productDiv is Array-like object, so can't use forEach from JS
                        _.each(productDivs, function(prodDiv) {
                            slotId  = $(prodDiv).attr('id');
                            prodResult = config.getStoreProductAtSlot(slotId.split('_')[1] - 1); // (-1) as slots are 1 based and product array is 0 based

                            if (prodResult.product != null) {
                                product = prodResult.product;

                                addProduct(product, false);
                            }
                        });

                        var albumsPhotobook = albums.photobooks || [];
                        var albumsProducts  = albums.products || [];
                        var albumsPrints    = albums.prints || [];
                        var albumsCalendars = albums.calendars || [];

                        albumsPhotobook = that.truncateAlbum(albumsPhotobook, that.MAX_PHOTOS_TO_RANK_SERVICE);
                        albumsProducts  = that.truncateAlbum(albumsProducts, that.MAX_PHOTOS_TO_RANK_SERVICE);
                        albumsPrints    = that.truncateAlbum(albumsPrints, that.MAX_PHOTOS_TO_RANK_SERVICE);
                        albumsCalendars = that.truncateAlbum(albumsCalendars, that.MAX_PHOTOS_TO_RANK_SERVICE);

                        var allAlbums = {
                            'photobook': albumsPhotobook,
                            'products': albumsProducts,
                            'prints': albumsPrints,
                            'calendars': albumsCalendars
                        };

                        //check if we have enough photos for photobooks and calendars
                        bookSkus = allAlbums.photobook.length > 0 ? bookSkus : [];
                        var calendarSkus = allAlbums.calendars.length > 0 ? skus : [];

                        console.log('[Product Widget] >> Starting Store render');

                        var productJson = [];
                        function _getProductJson(pJson) {
                            if (pJson != null) {
                                productJson = productJson.concat(pJson);
                            }
                        }

                        function removeNonProducts(item) {
                            return (item.indexOf('prints') != -1 || (item.split('_').length == 3 && ( item.split('_')[2] == 32 || item.split('_')[2] == 33 || item.split('_')[2] == 195)));
                        }

                        $.when(
                            productProxy.getPhotobook(albumsPhotobook, 40, _getProductJson, true, true, bookSkus),
                            productProxy.getProducts(albumsProducts, _getProductJson, true, _.reject(skus, removeNonProducts), true, false, false, false, false, _.reject(pids, removeNonProducts)),
                            productProxy.getPrints(albumsPrints, _getProductJson, true, printSkus),
                            productProxy.getCalendar(albumsCalendars, _getProductJson, true, calendarSkus)
                        )
                            .then(function() {
                                // Do tracking for loading
                                tracking.track('store', 'on_load');

                                skus = _.union(skus, bookSkus, printSkus);
                                pids = _.union(pids, bookPids, printPids);

                                // Show welcome animation
                                that.showStoreAnimation('welcome');

                                that.renderProductsStore(fullSkus, fullPids, productDivs, productJson, allAlbums, prodStyles, prodSizes, prodOptions, modal_view);
                            })
                            .fail(function() {
                                console.log('[Product Widget]> Failed loading resources. Aborting.');
                                that.renderWithStaticAssets('store', albumsProducts[0].photos);
                            });

                    } else {
                        // todo: change for store
                        // Not enough sources. use Static assets.
                        that.renderWithStaticAssets('store', null);
                        return;
                    }
                });
            }

            this.getPhotoIds = function(photoIds)
            {
                var photoList = [];
                //add cover id photos
                if(typeof photoIds['coverIds'] !== 'undefined') {
                    if(photoIds['coverIds'].length > 1) {
                        _.each(photoIds['coverIds'], function(page) {
                            _.each(page, function(photo) {
                                photoList.push(photo);
                            });
                        });
                    } else if (photoIds['coverIds'].length > 0) { //if there is only one cover photo
                        photoList.push(photoIds['coverIds'][0]);
                    }

                    //add cover id photos
                    if(photoIds['backCoverIds'].length > 1) {
                        _.each(photoIds['backCoverIds'], function(page) {
                            _.each(page, function(photo) {
                                photoList.push(photo);
                            });
                        });
                    } else if (photoIds['backCoverIds'].length > 0) {//if there is only one cover photo
                        photoList.push(photoIds['backCoverIds'][0]);
                    }

                    _.each(photoIds['pagesIds'], function(page) {
                        _.each(page, function(photo) {
                            photoList.push(photo);
                        });
                    });
                    //if list of photo ids
                } else {
                    photoList = photoIds;
                }


                return photoList;
            };

            this.getCoverPhotos = function(photoIds) {
                var photoList = [];
                //add cover id photos
                if(typeof photoIds['coverIds'] !== 'undefined') {
                    if(photoIds['coverIds'].length > 1) {
                        _.each(photoIds['coverIds'], function(page) {
                            _.each(page, function(photo) {
                                photoList.push(photo);
                            });
                        });
                    } else if (photoIds['coverIds'].length > 0) { //if there is only one cover photo
                        photoList.push(photoIds['coverIds'][0]);
                    }
                } else {
                    photoList = photoIds;
                }

                return photoList;
            };
        }

        utils.inheritPrototype(ReplaceViewEngine, EngineBase);

        ReplaceViewEngine.prototype.render = function(params) {
            var prodStyles      = params.prodStyles;
            var prodSizes       = params.prodSizes;
            var prodOptions     = params.prodOptions;
            var modal_view      = params.modalView;
            var replaceType     = params.replaceType;

            this.Model.get('monitoring').eventStart('cross_sell:Start');

            // For store. Add call when relevant.
            if (replaceType == 'store') {
                this.doRenderStore(params);
            }

            // For Cross sell we need to wait for a flag
            if (replaceType == 'cross_sell') {
                globalComm.waitForCrossSellReady(this.doRenderCrossSell.bind(this, prodSizes, prodStyles, prodOptions, replaceType, modal_view));
            }
        };

        return ReplaceViewEngine;
    });

define('app/view_engine/widgets/engines/tl_horizontal/EngineTextual',
    ['underscore', 'app/templates', 'mgthumb', 'app/asset_mapper', 'app/config_manager', 'app/click_through', 'app/tracking', 'app/cookies', 'magicselect', 'app/album_switch', 'app/product_proxy', 'app/utils', 'app/cache_module', 'app/scroller', 'app/view_engine/widgets/common', 'app/thumbgen_wrapper', 'app/time_monitor', 'app/view_engine/modals/shared', 'app/view_engine/widgets/engines/EngineHorizontal', 'css!./../../../../css/widget.css', 'css!./../../../../css/MagicSelectBox.css'],
    function(_, templates, mgthumb, AssetMapper, config, clickThrough, tracking, cookies, magicselect, albumSwitch, productProxy, utils, cache, scroller, view_common, thumbGenWrapper, monitor, modal_common, EngineHorizontal, css1, css2)
    {
        function TLTextualViewEngine(params) {
            EngineHorizontal.call(this, params);

            this.LV_PROD_WIDTH           = 125;
            this.LV_PROD_HEIGHT          = 110;
            this.DESKTOP_PROD_WIDTH      = 125;
            this.DESKTOP_PROD_HEIGHT     = 110;
            this.MAX_LV_PRODS            = 4;
            this.PB_NUM_ALBUMS           = 2;
            this.PROD_NUM_ALBUMS         = 2;
            this.PRINTS_NUM_ALBUMS       = 2;
            this.CAL_NUM_ALBUMS          = 2;
            this.DISABLE_CLICK           = false;
            this.IS_WIDGET_OPEN          = {state:false};
            this.CURRENT_OPEN_PID        = null;
            this.IS_VIEW_DISABLED        = {state: false};
            this.ZOOM_LEVEL              = 1.05;
            this.ITEM_TOTAL_WIDTH        = 160;
            this.CONTAINER_ELWIDTH       = 0;
            this.SPRD_WID                = 0;
            this.PRODINNER_WID           = 209;
            this.PRODINNER_WID_PB_CAL    = 278;
            this.winHandler              = null;
            this.isAfterUPP              = false;
            this.isThisLifeGeneral       = true;
            this.mixedSourcesGeneral     = false;
            this.clickthroughNoModal     = false;
            this.isManual                = false;
            this.MOBILE_THRESHOLD        = 992;
            this.isMobile                = $(window).width() < this.MOBILE_THRESHOLD;
            this.isTouch                 = (('ontouchstart' in window) || (typeof navigator.msMaxTouchPoints !== 'undefined' ? navigator.msMaxTouchPoints : false));
            this.MOBILE_NUM_PRODUCTS     = 24;
            this.ScrollbarWidth          = null;
            this.promoEl                 = null;
            this.PROD_CONT_BOX           = 130;

            //var coupon                  = 'EPIC';
            this.coupon                  = false;

            this.isRendered              = false;
            this.isFirstRun              = true;
            this.newTitlePricingFormat   = true;
            this.trackSent               = false;

            this.listOfProducts = [];

            /**
             * set or get the current opend pid
             * @param currentOpenPid
             * @returns {*}
             */
            this.handleCurrentPid = function(currentOpenPid)
            {
                if (typeof currentOpenPid !== "undefined") {
                    this.CURRENT_OPEN_PID = currentOpenPid;
                    //// TODO: must move it up to higher container structure.
                    //window.MagicShopGlobalCurrentPid = currentOpenPid;
                }
                return this.CURRENT_OPEN_PID;
            };

            this.enableMove = function(container) {
                container.on('mousemove', function (event) {
                    if ($(this).parent().parent().hasClass('sfly-wgt-dont-act')) { // Not yet ready for action.
                        return;
                    }

                    var pages = $(this).attr('data-pages');
                    var rightPadding = parseFloat(($(this).attr('data-right')));
                    var boxWidth = $(this).width() - rightPadding;
                    var leftPadding = parseFloat(($(this).css('left')).replace("px", ""));

                    // Calc real position
                    var targetPos = $(event.currentTarget).offset();
                    var mousePos = {top: event.pageY, left: event.pageX};
                    var realPos = {top: mousePos.top - targetPos.top, left: mousePos.left - targetPos.left};

                    var currPage = Math.floor((realPos.left + leftPadding) * pages / boxWidth);

                    if (currPage < 0) {
                        currPage = 0;
                    } else if (currPage >= pages - 1) {
                        currPage = pages - 1;
                    }

                    $(this).find('canvas').hide();
                    $(this).find('canvas[data-order=' + currPage + ']').show();
                });
            };

            // Will calculate the right position of each product in the given container
            /*
             params:
             containerElement: The main container of the widget
             container: The container of the products, where you actually append the products
             */
            this.calcElementsPosition = function(params) {
                // containerElement, container, productJson, targetHeight, maxSpaceBetweenProds, sidePadding, prodSizes
                var products = $(params.container).attr('data-pids').split(',');
                var result = this.calTotalProductsHeightByBoundingBox(products, params.productJson, this.getBoundingBox.bind(this), params.prodSizes);

                if (typeof result.error !== 'undefined') {
                    return result;
                } else {
                    return {
                        sizes: result.sizes
                    };
                }
            };

            this.calcElementsPositionAsync = function(params) {
                // containerElement, container, productJson, targetHeight, maxSpaceBetweenProds, sidePadding, prodSizes
                var products = $(params.container).attr('data-pids').split(',');
                this.calTotalProductsHeightByBoundingBoxAsync(products, params.productJson, this.getBoundingBox.bind(this), params.prodSizeZoomLevels, function(result){
                    if (typeof result.error !== 'undefined') {
                        params.callback(result);
                    } else {
                        params.callback({
                            sizes: result.sizes
                        });
                    }
                });
            };

            // custom bounding boxes
            this.boundingBoxes = function() {
                return {
                    'shoppingbag' : { height: 10, width: 102 },
                    'deskcalendar' : { height: 160, width: 181 }
                };
            }();

            // Define this function if you want custome bounding box for specific product
            this.getBoundingBox = function(pId) {

                var product = view_common.getProduct(pId), boundingBox;
                if (typeof product.type !== 'undefined' && typeof this.boundingBoxes[product.type] !== 'undefined') {
                    boundingBox = this.boundingBoxes[product.type];
                } else {
                    boundingBox = this.isMobile ? { height: this.LV_PROD_HEIGHT, width: this.LV_PROD_WIDTH } : { height: this.DESKTOP_PROD_HEIGHT, width: this.DESKTOP_PROD_WIDTH };
                }

                return boundingBox;
            };

            this.renderProducts = function(pId, productType, container, mgThumbGen, masks, onRenderedCallback) {

                var PRODUCT_PROJECTIONS = 5;

                // We need this function to keep the right order inside the generate function
                var generated = 0;
                function _generate(order) {
                    mgThumbGen.generate(parseInt(order), pId, true, function(canvas) {
                        $(canvas).attr('data-order', order).hide();
                        $(container).append(canvas);
                        generated++;

                        if(typeof(onRenderedCallback) !== "undefined" && _.isFunction(onRenderedCallback)){
                            if(generated == PRODUCT_PROJECTIONS -1) {
                                onRenderedCallback();
                            }
                        }
                    }, true, { masks: masks, textEnabled:(productType !== "book") });
                }

                if (!$(container).attr('data-rendered')) {
                    // Put this first - to block more attempts to render
                    $(container).attr('data-rendered', true);
                    var numOfPages = PRODUCT_PROJECTIONS;
                    $(container).attr('data-pages', PRODUCT_PROJECTIONS);

                    function generateWithTimeout(i) {
                        setTimeout(function(){ _generate(i); }, i*50);
                    }

                    for(var i = 1; i < numOfPages; i++) {
                        generateWithTimeout(i);
                    }
                }
            };

            // This is wrapped so we can add other actions on resize
            this.onContainerResize = function(containerElement, spreads, productJson, commonHeight, viewtype, MAX_SPACE_BETWEEN_PRODUCTS, side_padding, prodSizes) {
                var getScreenState = this.isMobile;
                this.isMobile = $(window).width() < this.MOBILE_THRESHOLD;
                var shouldProductMarginUpdate = getScreenState == this.isMobile;
                var res = this.findPositionProductsInSpreads({
                    container: containerElement,
                    spreads: spreads,
                    productJson: productJson,
                    targetHeight: commonHeight,
                    typeOfView: viewtype,
                    maxSpaceBetweenProds: MAX_SPACE_BETWEEN_PRODUCTS,
                    sidePadding: side_padding,
                    prodSizeZoomLevels: prodSizes,
                    calcElemPositionFunc: this.calcElementsPosition.bind(this)
                });

                if(typeof res.error !== 'undefined') {
                    this.failWidget('instance', 'tl', 'tl');
                    console.log(utils.formatString('[Product Widget]> Failed. Aborting...\nMessage : {0}', res.error.msg));
                    return;
                }

                if (this.isMobile || !shouldProductMarginUpdate) {
                    this.updateProductMargins(containerElement);
                }

                var updateStyleCss = this.CONTAINER_ELWIDTH !== this.Model.get('container').width();

                if(!shouldProductMarginUpdate || updateStyleCss){
                    this.updateProductStyle(containerElement)
                }
            };

            this.updateProductMargins = function(containerElement) {
                var that = this;
                var products = $(containerElement).find('.sfly_wgt_product');
                _.each(products, function(prodContainer) {
                    var prodWid = that.isMobile ? (that.SPRD_WID/2) : $(prodContainer).width();
                    var inner = $(prodContainer).children('.sfly_wgt_product_inner').first();
                    var diff = Math.floor((prodWid - that.ITEM_TOTAL_WIDTH) / 2);
                    $(inner).css('margin-left', diff + 'px');
                });
            };

            this.updateProductStyle = function(containerElement, howMany) {

                var spreads = $(containerElement).find('.sfly_wgt_listview_spread');
                this.CONTAINER_ELWIDTH = this.Model.get('container').width();

                if (typeof howMany == 'undefined') {
                    _.each(spreads, function(spread) {
                        var pids = $(spread).attr('data-pids').split(',');
                        howMany = pids.length;
                    })
                }

                this.isMobile = $(window).width() < this.MOBILE_THRESHOLD;
                this.SPRD_WID = this.CONTAINER_ELWIDTH - 38;

                if (!this.isMobile) {
                    var maxPdInFLine = parseInt(this.CONTAINER_ELWIDTH / this.PRODINNER_WID);
                    if (howMany < maxPdInFLine) {
                        maxPdInFLine = howMany;
                    }
                    this.SPRD_WID = this.PRODINNER_WID * maxPdInFLine;
                }

                spreads.css('width', this.SPRD_WID + 'px');
                //change the promo title width and offset aswell
                var containerTitle = $(containerElement).find('.sfly_wgt_listview_embedded_title');
                if (containerTitle.length > 0) {
                    containerTitle.css('width', (this.SPRD_WID + 4) + 'px');
                    //if the promoWidth is small due to the less products then make the smaller promo due to the space issues
                    if(this.promoEl != null && this.promoEl.parent().height() > 52) {
                        var self = this;
                        productProxy.getSflyPromos(this.Model.get('prod_type'), true).then(function(response){
                            self.renderPromo(response);
                        });
                    }
                    //calculate only once
                    if (this.ScrollbarWidth == null) {
                        this.ScrollbarWidth = this.getScrollbarWidth();
                    }

                    if (this.ScrollbarWidth != 0) {
                        if (spreads.parent().height() < spreads.height() || spreads.position().left == 0) {
                            containerTitle.css('margin-left', '-' + this.ScrollbarWidth + 'px');
                        }
                    }
                }
            };

            this.getScrollbarWidth = function() {
                var outer = document.createElement("div");
                outer.style.visibility = "hidden";
                outer.style.width = "100px";
                document.body.appendChild(outer);

                var widthNoScroll = outer.offsetWidth;
                // force scrollbars
                outer.style.overflow = "scroll";

                // add innerdiv
                var inner = document.createElement("div");
                inner.style.width = "100%";
                outer.appendChild(inner);

                var widthWithScroll = inner.offsetWidth;

                // remove divs
                outer.parentNode.removeChild(outer);

                return widthNoScroll - widthWithScroll;
            };

            this.renderPromo = function(response) {
                if (typeof response !== 'undefined') {
                    $(this.promoEl).html(response);
                    var aTag = $( "a" );
                    $(this.promoEl).find(aTag).on('click', function (e) {
                        e.preventDefault();
                        clickThrough.redirectTo('special-offers');
                    });
                }
            };

            this.setProductSize = function(sku, product, elem, boxSize, productJson) {
                var ratio = 1;
                var newSize = {
                    "width": 0,
                    "height": 0
                };

                var boxSizePadded = boxSize - 20;

                switch (product.type) {
                    case 'mug':
                        boxSizePadded -= 15;
                        break;
                    case 'travelmug':
                        boxSizePadded -= 15;
                        break;
                    case 'waterbottle':
                        boxSizePadded -= 8;
                        break;
                    case 'pillow':
                        boxSizePadded -= 10;
                        break;
                    case 'ceramicTile':
                        boxSizePadded -= 12;
                        break;
                    case 'stockings':
                        boxSizePadded -= 6;
                        break;
                    case 'glassor':
                        boxSizePadded -= 8;
                        break;
                    case 'shoppingbag':
                        boxSizePadded -= 30;
                        break;

                }

                var prodSize = view_common.getProductRealSize(productJson, sku, false, product);

                if (prodSize.realHeight > prodSize.width) {
                    // rescale by height
                    ratio           = boxSizePadded / prodSize.realHeight;
                } else {
                    // rescale by width
                    ratio           = boxSizePadded / prodSize.width;
                }

                newSize.height  = prodSize.height * ratio;
                newSize.width   = prodSize.origWidth * ratio;

                var leftPad = Math.floor((boxSize - newSize.width) / 2);

                switch (product.type) {
                    case 'plaque':
                        leftPad -= 10;
                        break;
                    //case 'wallart':
                    //    leftPad -= 20;
                    //    break;
                    case 'canvas':
                        leftPad -= 10;
                        break;
                }

                elem.css({
                    'width':  newSize.width + 'px',
                    'height': newSize.height + 'px',
                    'bottom': ((-1) * prodSize.bottom * ratio + 10) + 'px',
                    'left': leftPad + 'px'
                });
            };

            this.updateProductMargin = function(productContainer) {
                var inner = $(productContainer).children('.sfly_wgt_product_inner').first();
                var prodWid = this.isMobile ? (this.SPRD_WID/2) : $(productContainer).width();
                var diff = Math.floor(( prodWid - this.ITEM_TOTAL_WIDTH) / 2);
                $(inner).css('margin-left', diff + 'px');
            };

            this.renderView = function(containerElement, products, productJson, albums, prodStyles, prodSizes, prodOptions, modal, instance, structure) {
                var viewModel           = {};
                var that                = this;
                var commonWidth         = that.LV_PROD_WIDTH;
                var commonHeight        = that.LV_PROD_HEIGHT;
                var menuContainer       = null;

                function updateProductPhotoUrls(product, albums) {
                    if (typeof product === 'undefined' || product === null) {
                        return;
                    }

                    var photoArray  = albums.products[0].photos;

                    var productContent = product[Object.keys(product)[0]];
                    if (productContent.hasOwnProperty('photoStrip')) {
                        var photoStrip = productContent['photoStrip'];
                        for (var pIndex in photoStrip) {
                            if (photoStrip.hasOwnProperty(pIndex)) {
                                var cPhoto = photoStrip[pIndex];
                                cPhoto.url = _.find(photoArray, function(item) {
                                    return item.id === cPhoto.photoId;
                                }, this).url;
                            }
                        }
                    }

                    return product;
                }

                function showPrintsRedirectMsg() {
                    $(that.Model.get('container')).find('.sfly_wgt_textual_order_prints').html('REDIRECTING...');
                }

                function renderProdThumb(sku, position, container, showProduct) {
                    var product = updateProductPhotoUrls(view_common.findProjectJsonProduct(productJson, sku, true), albums);
                    var productType = AssetMapper.GetProductType(product);
                    var partnerId = AssetMapper.GetPartnerId(product, productType);
                    var prodSku = productType != 'book' ? view_common.getProduct(sku)['sku'] : view_common.getProduct(sku)['style'] + '_' + view_common.getProduct(sku)['size'];

                    // Prints and Calendar will still be using the embedded JSONs. Also anything that is not supported now.
                    if (productType == 'prints') {
                        var layoutJson = JSON.stringify(config.getRecipeLayout()[partnerId]);
                        var designJson = JSON.stringify(config.getRecipeDesign()[partnerId]);
                        renderThumb(sku, productType, partnerId, product, layoutJson, designJson, position, undefined, undefined, undefined, container, !getBanner());
                    } else {
                        // todo: if thumb already was requested before - don't request again!
                        that.Model.get('monitoring').eventStart('tl:prepareThumbGenAssets:' + sku);
                        thumbGenWrapper.prepareThumbGenAssets(prodSku, sku, 'medium', productType, product, function (result) {
                            that.Model.get('monitoring').eventEnd('tl:prepareThumbGenAssets:' + sku);

                            if (result == null || typeof result.layoutJson === 'undefined' || typeof result.designJson === 'undefined') {
                                products.sku = null;
                                console.log('[Product Widget] Missing Layout / Design json for SKU:', sku);
                                return;
                            }

                            if (productType == 'book') {
                                layoutJson = JSON.stringify(result.layoutJson[sku]);
                            } else {
                                layoutJson = JSON.stringify(result.layoutJson);
                            }

                            designJson = JSON.stringify(result.designJson);

                            _.defer(renderThumb.bind(undefined, sku, productType, partnerId, product, layoutJson, designJson, position, undefined, result.layoutMasks, undefined, container, showProduct));
                        });
                    }
                }

                function renderThumb(pId, productType, partnerId, product, layoutJson, designJson, position, productGenerateCallBack, layoutMasks, promiseToResolve, container, showProduct) {
                    var useCDN = cache.get('env') != 'beta' && cache.get('env') != 'dev';
                    var mgThumbGen  = new MgThumbGenerator(cache.get('env'),useCDN);

                    mgThumbGen.init(productType, partnerId, product, layoutJson, designJson, that.Model.get('monitoring').reportEvent, cache.get('env'), true);

                    var j = position;

                    var thumbPage = 0;
                    var isPBProd = (that.Model.get('prod_type') == "photobook" || that.Model.get('prod_type') == 'photobook_share') && productType == "book";
                    if(isPBProd){
                        view_common.findProjectJsonProduct(productJson, pId);
                    }
                    that.Model.get('monitoring').eventStart('tl:Generate:' + pId);
                    mgThumbGen.generate(parseInt(thumbPage), pId, true, function(canvas) {
                        that.Model.get('monitoring').eventEnd('tl:Generate:' + pId);
                        //view_common.removeLoading(that.Model.get('container'));
                        var productInfo = view_common.getProduct(pId);
                        var elem = $(view_common.renderTemplate(templates.fullview_product, { pid: pId, sku: productInfo['sflySku'], ptype: productType }));
                        $(canvas).attr('data-order', thumbPage);
                        elem
                            .addClass('order_' + j)
                            .attr('data-order', j)
                            .css('display', showProduct ? 'block' : 'none')
                            .children('.sfly_wgt_product_inner')
                            .html(canvas)
                            .addClass('order_' + j);

                        var productInner = elem.children('.sfly_wgt_product_inner');
                        $(container).append(elem);

                        var updateTheProductSize = function(elem, size, zoom) {
                            var container = $(elem).children('.sfly_wgt_product_inner');

                            fixProductSize(elem, 0, size, 130, 130, undefined, zoom);
                        }

                        // that.setProductSize(pId, productInfo, productInner, that.PROD_CONT_BOX, productJson);

                        var prodSize = view_common.getProductRealSize(productJson, pId, false, productInfo);
                        updateTheProductSize(elem, prodSize, null);

                        var albumResult = that.getCurrentAlbum(pId, albums); //currAlbums[currItemOrder % currAlbums.length];
                        var currAlbum = albumResult.currAlbum;
                        var currAlbums = albumResult.currAlbums;

                        var renderData = {
                            pId: pId,
                            currPid: that.CURRENT_OPEN_PID,
                            currAlbum: currAlbum,
                            albums: currAlbums,
                            prodStyles: prodStyles,
                            prodOptions: prodOptions,
                            forceCloseExternal: false,
                            widgetIsOpen: that.IS_WIDGET_OPEN.state,
                            isThisLife: that.isThisLifeGeneral,
                            mixedSources: that.mixedSourcesGeneral,
                            callbacks: callbacks,
                            instance: instance,
                            model: that.Model,
                            useNewStyleGuide: true,
                            doNotResizeImages: true,
                            tooltipItems: that.listOfProducts,
                            textualStructure: viewModel,
                            sessionToken: (typeof ThisLife != 'undefined' && ThisLife.sessionToken ? ThisLife.sessionToken : null)
                        };

                        // connect this to the side menu as well, but only if present
                        if (menuContainer != null) {
                            $(menuContainer).find('li[data-sku="' + pId + '"]').on('click', function (event, params)
                            {

                                if (!that.IS_WIDGET_OPEN.state) {
                                    view_common.showLoading($(containerElement));
                                    var loadingContainer = $(containerElement).find('.sfly_wgt_loading');
                                    if (loadingContainer.length > 0) {
                                        loadingContainer.css('position', 'absolute').css('height', 'inherit');
                                    }
                                }

                                that.updateModalMenuSelection(menuContainer, pId);
                                // always keep the photos updated

                                var albumResult = that.getCurrentAlbum(pId, that.Model.get('albums')); //currAlbums[currItemOrder % currAlbums.length];

                                var isManualSelect = that.Model.get('ismanualselect');
                                isManualSelect = isManualSelect ||
                                    !!(window.MagicShopCurrAlbum && window.MagicShopCurrAlbum.photos && window.MagicShopCurrAlbum.photos.length > 0);
                                that.Model.set('ismanualselect', isManualSelect);
                                renderData.currAlbum = window.MagicShopCurrAlbum ? window.MagicShopCurrAlbum:  albumResult.currAlbum;
                                renderData.albums =  albumResult.currAlbums;

                                var clickedCategory = $(this).find(".sfly-wgt-left-pane-category-product-title")[0];
                                var trackingSku = clickedCategory.innerText.replace(/(\r\n|\n|\r)/gm,"");

                                // if (params && params.hasOwnProperty('muteTracking') && params.muteTracking === true) {
                                //     // skip tracking
                                // } else {
                                //     tracking.track('tl', 'click-category', {
                                //         sku: trackingSku,
                                //         pid: $(this).attr('data-pid'),
                                //         mode: 'instance',
                                //         prod_type: that.Model.get('prod_type')
                                //     });
                                // }

                                modal.show(renderData);
                            });
                        }

                        if (productType != 'prints') {
                            function showModal() {
                                if (!that.IS_WIDGET_OPEN.state) {
                                    view_common.showLoading($(containerElement));
                                    var loadingContainer = $(containerElement).find('.sfly_wgt_loading');
                                    if (loadingContainer.length > 0) {
                                        loadingContainer.css('position', 'absolute').css('height', 'inherit');
                                    }
                                }

                                window.MagicShopCurrAlbum = null;
                                modal.show(renderData);
                            }

                            elem.on('click', function ()
                            {
                                if (!that.IS_WIDGET_OPEN.state) {
                                    view_common.showLoading($(containerElement));
                                    var loadingContainer = $(containerElement).find('.sfly_wgt_loading');
                                    if (loadingContainer.length > 0) {
                                        loadingContainer.css('position', 'absolute').css('height', 'inherit');
                                    }
                                }

                                if (menuContainer != null) {
                                    that.updateModalMenuSelection(menuContainer, pId);
                                    $(that.Model.get('modalcontainer')).addClass('visible');
                                }

                                //that.Model.set('currAlbum', null);
                                window.MagicShopCurrAlbum = null;
                                modal.show(renderData);
                            });
                        } else {
                            var product = view_common.findProjectJsonProduct(productJson, pId, that.isAfterUPP);
                            var photoIds = that.thumbRenderPreparePhotoIds(product, currAlbum, that.isAfterUPP, that.Model.get('ismanualselect'));

                            if (that.Model.get('openInNewTab')) {
                                that.winHandler = view_common.openNewWindow(that.winHandler);

                                if (!that.IS_WIDGET_OPEN.state) {
                                    view_common.removeLoading($('.sfly_wgt_listview_container'));
                                }
                            } else {
                                that.winHandler = null;
                            }

                            elem.on('click', function ()
                            {
                                clickThrough.sendForSeeAll(photoIds, view_common.showLoading.bind(this, $('.sfly_wgt_listview_container')), view_common.removeLoading.bind(this, $('.sfly_wgt_listview_container')), currAlbum, that.winHandler, that.Model);
                                //that.Model.get('callback')({action: 'hide_window'});
                                showPrintsRedirectMsg();
                            });
                        }

                        if (typeof promiseToResolve !== 'undefined') {
                            promiseToResolve.resolve();
                        }

                        if(_.isFunction(productGenerateCallBack)) {
                            productGenerateCallBack(j);
                        }
                    }, true, { masks: layoutMasks, textEnabled:(productType !== "book") });
                }

                function injectIntoEmbeddedModal(structure, modalContainer) {
                    // prepre the structure with titles

                    var newStructure = {};
                    Object.keys(structure).forEach(function(category) {
                        newStructure[category] = [];
                        structure[category].forEach(function(sku) {
                            newStructure[category].push({
                                title: prodOptions[sku].title,
                                sku: sku
                            })
                        });
                    });

                    var menuContainer = $(modalContainer).find('.magicshop_modal_menu_wrapper li.' + that.Model.get('prod_type') + ' .modal_category_btn_sub_menu');
                    var menu = view_common.renderTemplate(templates.popup_leftpane, {
                        products: newStructure,
                        currentProduct: ''
                    });
                    $(menuContainer).html(menu);

                    return menuContainer;
                }

                Object.keys(structure).forEach(function(category) {
                    viewModel[category] = [];
                    structure[category].forEach(function(sku) {
                        viewModel[category].push({
                            'sku': sku,
                            'title': prodOptions[sku].title
                        });
                    });
                });

                var mainTemplate = view_common.renderTemplate(templates.listview_textual_container, { model: viewModel, prodType: that.Model.get('prod_type') });
                $(containerElement).append(mainTemplate);

                view_common.removeLoading(that.Model.get('container'));

                if (typeof that.Model.get('modalcontainer') !== 'undefined' && that.Model.get('modalcontainer') != null) {
                    menuContainer = injectIntoEmbeddedModal(structure, that.Model.get('modalcontainer'));
                }

                var makeCategoryActive = function(container, index, sku) {
                    $(container).find('.sfly_wgt_product').css({'display': 'none'});
                    $(container).find('li[data-pid="' + sku + '"]').css({'display': 'block'});
                    var titles = $(container).find('li');
                    titles.removeClass('hover');
                    $(titles[index]).addClass('hover');
                };

                // Generate the products
                var position = 1;
                Object.keys(structure).forEach(function(category) {
                    var container = $(containerElement).find('.sfly_wgt_textual_product_placeholder[data-forcat="' + category + '"]');
                    var catIdx = 0;
                    // Select active category randomly
                    var categoryToShow = Math.floor((Math.random() * structure[category].length));
                    structure[category].forEach(function(sku) {
                        renderProdThumb(sku, position, container, catIdx == categoryToShow);
                        if (catIdx == categoryToShow) {
                            var textualContainer = $(containerElement).find('.sfly_wgt_textual_area[data-category="' + category.toLowerCase() + '"]');
                            makeCategoryActive(textualContainer, catIdx, sku);
                        }
                        position++;
                        catIdx++;
                    });
                });

                // if we have prints, render it
                if (that.Model.get('prod_type') == 'prints') {
                    function printsOnClick(pId, album) {
                        //var albumResult = that.getCurrentAlbum(pId, albums);
                        //var album = albumResult.currAlbum;
                        var product = view_common.findProjectJsonProduct(productJson, pId, that.isAfterUPP);
                        var photoIds = that.thumbRenderPreparePhotoIds(product, album, that.isAfterUPP, that.Model.get('ismanualselect'));

                        if (that.Model.get('openInNewTab')) {
                            that.winHandler = view_common.openNewWindow(that.winHandler);

                            if (!that.IS_WIDGET_OPEN.state) {
                                view_common.removeLoading($('.sfly_wgt_listview_container'));
                            }
                        } else {
                            that.winHandler = null;
                        }

                        tracking.track('tl', 'click-category', {
                            sku: 'prints',
                            pid: 'prints_4x6',
                            order: 0,
                            mode: 'instance',
                            prod_type: that.Model.get('prod_type')
                        });

                        clickThrough.sendForSeeAll(photoIds, view_common.showLoading.bind(this, $('.sfly_wgt_listview_container')), view_common.removeLoading.bind(this, $('.sfly_wgt_listview_container')), album, that.winHandler, that.Model);
                        //that.Model.get('callback')({action: 'hide_window'});

                        showPrintsRedirectMsg();
                    }

                    function printsOnClickManual() {
                        var pId = $(this).attr('data-pid');
                        var albumResult = that.getCurrentAlbum(pId, albums);
                        var currAlbum = albumResult.currAlbum;

                        printsOnClick(pId, currAlbum);
                    }

                    function printsOnClickActivateSelection() {
                        var pId = $(this).attr('data-pid');

                        function onSuccess(selectedPhotos) {
                            var groupPhotos = {
                                'albumId' : String.fromCharCode(65 + Math.floor(Math.random() * 26)) + Date.now(),
                                'photos' : selectedPhotos
                            };

                            that.Model.set('ismanualselect', true);

                            printsOnClick(pId, groupPhotos);
                        }

                        that.Model.get('callback')({action: 'select_photos', onSuccess: onSuccess, productType: 'products'});
                    }

                    function printsOnClickGoToCreationPath() {
                        tracking.track('tl', 'click-category', {
                            sku: 'prints',
                            pid: 'prints_4x6',
                            order: 0,
                            mode: 'instance',
                            prod_type: that.Model.get('prod_type')
                        });

                        clickThrough.sendForSeeAll([], view_common.showLoading.bind(this, $('.sfly_wgt_listview_container')), view_common.removeLoading.bind(this, $('.sfly_wgt_listview_container')), undefined, that.winHandler, that.Model);
                        showPrintsRedirectMsg();
                    }
                    // If we're in selection mode, show as usual
                    // If we're in automatic mode, show a button for selection mode

                    var $placeHolder = $(containerElement).find('.sfly_wgt_textual_area[data-category="prints"] .sfly_wgt_textual_product_placeholder');
                    var bannerFreePrints = getBanner();
                    if (bannerFreePrints) {
                        $placeHolder.append(bannerFreePrints);
                        $placeHolder.find(".sfly_wgt_product_inner").css('opacity', '0');
                        $placeHolder.show();
                        $(containerElement).find('.sfly_wgt_textual_area[data-category="prints"] .sfly_wgt_textual_area_menu').html(view_common.renderTemplate(templates.listview_textual_prints_auto_btn));
                        $(containerElement).find('.sfly_wgt_textual_area[data-category="prints"] .sfly_wgt_textual_area_menu .sfly_wgt_textual_order_prints').on('click', printsOnClickGoToCreationPath)
                    }
                    else if (that.Model.get('ismanualselect')) {
                        $(containerElement).find('.sfly_wgt_textual_area[data-category="prints"] .sfly_wgt_textual_area_menu').html(view_common.renderTemplate(templates.listview_textual_prints_btn));
                        $(containerElement).find('.sfly_wgt_textual_area[data-category="prints"] .sfly_wgt_textual_area_menu .sfly_wgt_textual_order_prints').on('click', printsOnClickManual);
                        $placeHolder.show();
                    } else {
                        $(containerElement).find('.sfly_wgt_textual_area[data-category="prints"] .sfly_wgt_textual_area_menu').html(view_common.renderTemplate(templates.listview_textual_prints_auto_btn));
                        $(containerElement).find('.sfly_wgt_textual_area[data-category="prints"] .sfly_wgt_textual_area_menu .sfly_wgt_textual_order_prints').on('click', printsOnClickGoToCreationPath)
                    }




                    // Load prints price and show
                    //productProxy.loadPrices(function() {
                    //    // Update price
                    //    var price = config.getPrice('4x6');
                    //    if (price.originalPrice > -1) {
                    //        $(containerElement).find('.sfly_wgt_textual_area[data-category="prints"] .sfly_wgt_textual_order_prints_info').html('Starting from ' + price.originalPrice + '$ per print');
                    //    }
                    //})
                }

                $(containerElement).find('li').off().on('click', function() {
                    var currPId = $(this).attr('data-sku');
                    var albumResult = that.getCurrentAlbum(currPId, albums); //currAlbums[currItemOrder % currAlbums.length];
                    var currAlbum = albumResult.currAlbum;
                    var currAlbums = albumResult.currAlbums;

                    var callbacks = {
                        takeLock: that.takeLock.bind(that),
                        releaseLock: that.releaseLock.bind(that),
                        animateControlButton: undefined,
                        changeState: that.changeWidgetOpenState.bind(that, that.IS_WIDGET_OPEN),
                        handleCurrentPid: that.handleCurrentPid.bind(that),
                        toggleViewDisable: that.toggleViewDisable.bind(that, that.IS_VIEW_DISABLED)
                    };

                    var renderData = {
                        pId: currPId,
                        currPid: that.CURRENT_OPEN_PID,
                        currAlbum: currAlbum,
                        albums: currAlbums,
                        prodStyles: prodStyles,
                        prodOptions: prodOptions,
                        forceCloseExternal: false,
                        widgetIsOpen: that.IS_WIDGET_OPEN.state,
                        isThisLife: that.isThisLifeGeneral,
                        mixedSources: that.mixedSourcesGeneral,
                        callbacks: callbacks,
                        instance: instance,
                        model: that.Model,
                        useNewStyleGuide: true,
                        doNotResizeImages: true,
                        tooltipItems: that.listOfProducts,
                        textualStructure: viewModel
                    };

                    if (!that.isLocked()) {
                        that.takeLock();

                        var currItemOrder = 1; //$(this).attr('data-order') - 1; // order is "1" based, albums is "0" based

                        // Add Opacity to other products
                        $('.sfly_wgt_product').addClass('not-selected');
                        that.removeHoverStates(containerElement);

                        if (!that.IS_WIDGET_OPEN.state) {
                            view_common.showLoading($(containerElement));
                            var loadingContainer = $(containerElement).find('.sfly_wgt_loading');
                            if (loadingContainer.length > 0) {
                                loadingContainer.css('position', 'absolute').css('height', 'inherit');
                            }
                        }

                        // tracking params
                        var trackingSku = view_common.getTrackingSku($(this).attr('data-sku'), $(this).attr('data-pid'), $(this).attr('data-ptype'));
                        trackingSku = $(this).attr('data-ptype') ? $(this).attr('data-ptype') : trackingSku;
                        tracking.track('tl', 'click-category', {
                            sku: trackingSku,
                            pid: $(this).attr('data-pid'),
                            order: currItemOrder,
                            mode: 'instance',
                            prod_type: that.Model.get('prod_type')
                        });

                        if ($(this).attr('data-pid') == 'prints_4x6') {
                            var product = view_common.findProjectJsonProduct(productJson, $(this).attr('data-pid'), that.isAfterUPP);
                            var photoIds = that.thumbRenderPreparePhotoIds(product, currAlbum, that.isAfterUPP, that.Model.get('ismanualselect'));

                            if (that.Model.get('openInNewTab')) {
                                that.winHandler = view_common.openNewWindow(that.winHandler);

                                if (!that.IS_WIDGET_OPEN.state) {
                                    view_common.removeLoading($('.sfly_wgt_listview_container'));
                                }
                            } else {
                                that.winHandler = null;
                            }

                            clickThrough.sendForSeeAll(photoIds, view_common.showLoading.bind(this, $('.sfly_wgt_listview_container')), view_common.removeLoading.bind(this, $('.sfly_wgt_listview_container')), currAlbum, that.winHandler, that.Model);
                            //that.Model.get('callback')({action: 'hide_window'});
                            showPrintsRedirectMsg();
                        } else if ($(this).attr('data-ptype') == 'book') {
                            currAlbums = albums.photobook;
                            currAlbum = currAlbums[0];

                            callbacks.handleCurrentPid = that.handleCurrentPid.bind(that);

                            var modalCallback = modal.show.bind(this, {
                                pId: elem.attr('data-pid'),
                                currPid: that.CURRENT_OPEN_PID,
                                currAlbum: currAlbum,
                                albums: currAlbums,
                                prodStyles: prodStyles,
                                prodOptions: prodOptions,
                                forceCloseExternal: false,
                                widgetIsOpen: that.IS_WIDGET_OPEN.state,
                                isThisLife: that.isThisLifeGeneral,
                                mixedSources: that.mixedSourcesGeneral,
                                callbacks: callbacks,
                                instance: instance,
                                model: that.Model,
                                useNewStyleGuide: true,
                                doNotResizeImages: true
                            });

                            that.openBookModal({
                                pId: elem.attr('data-pid'),
                                widgetType: 'instance',
                                elem: elem,
                                albums: albums,
                                containerElement: containerElement,
                                widgetState: that.IS_WIDGET_OPEN.state,
                                instance: instance,
                                clickthroughNoModal: that.clickthroughNoModal,
                                winHandler: that.winHandler,
                                productJson: productJson,
                                productType: productType,
                                clickThrough: clickThrough,
                                modalCallback: modalCallback
                            });

                            var trackingSku = view_common.getTrackingSku($(this).attr('data-sku'), $(this).attr('data-pid'), $(this).attr('data-ptype'));
                            trackingSku = $(this).attr('data-ptype') ? $(this).attr('data-ptype') : trackingSku;
                            tracking.track('tl', 'click-category', {
                                sku: trackingSku,
                                pid: $(this).attr('data-pid'),
                                order: currItemOrder,
                                mode: 'instance',
                                prod_type: that.Model.get('prod_type')
                            });

                        }
                        else {
                            if (menuContainer != null) {
                                that.updateModalMenuSelection(menuContainer, renderData.pId);
                                $(that.Model.get('modalcontainer')).addClass('visible');
                            }
                            modal.show(renderData);
                        }
                    }
                })
                .on('mouseenter', function() {
                        var sku = $(this).attr('data-pid');
                        var menuParent = utils.findParentWithClass($(this), 'sfly_wgt_textual_area');
                        $(menuParent).find('.sfly_wgt_product').css({'display': 'none'});
                        $(menuParent).find('.sfly_wgt_product[data-pid="' + sku + '"]').css({'display': 'flex'}).css({'align-items': 'center'});
                        $(menuParent).find('li').removeClass('hover');
                        $(this).addClass('hover');

                        // tracking params
                        var trackingSku = view_common.getTrackingSku($(this).attr('data-sku'), $(this).attr('data-pid'), $(this).attr('data-ptype'));
                        trackingSku = $(this).attr('data-ptype') ? $(this).attr('data-ptype') : trackingSku;
                        // tracking.track('tl', 'hover-textual-category', {
                        //     sku: trackingSku,
                        //     pid: sku,
                        //     mode: 'instance',
                        //     prod_type: that.Model.get('prod_type')
                        // });


                });

                // build tooltip content
                var prodIndex = 0;

                var callbacks = {
                    takeLock: that.takeLock.bind(that),
                    releaseLock: that.releaseLock.bind(that),
                    animateControlButton: undefined,
                    changeState: that.changeWidgetOpenState.bind(that, that.IS_WIDGET_OPEN),
                    handleCurrentPid: that.handleCurrentPid.bind(that),
                    toggleViewDisable: that.toggleViewDisable.bind(that, that.IS_VIEW_DISABLED)
                };

                var renderData = {
                    currPid: that.CURRENT_OPEN_PID,
                    prodStyles: prodStyles,
                    prodOptions: prodOptions,
                    forceCloseExternal: false,
                    widgetIsOpen: that.IS_WIDGET_OPEN.state,
                    isThisLife: that.isThisLifeGeneral,
                    mixedSources: that.mixedSourcesGeneral,
                    callbacks: callbacks,
                    instance: instance,
                    model: that.Model,
                    useNewStyleGuide: true,
                    doNotResizeImages: true,
                    tooltipItems: that.listOfProducts
                };

                _.each(products, function(sku) {
                    var currPId = sku;
                    var albumResult = that.getCurrentAlbum(sku, albums); //currAlbums[currItemOrder % currAlbums.length];
                    var currAlbum = albumResult.currAlbum;
                    var currAlbums = albumResult.currAlbums;

                    renderData = _.extend(renderData, {
                        pId: currPId,
                        currAlbum: currAlbum,
                        albums: currAlbums
                    });

                    if (typeof that.listOfProducts[sku] == 'undefined') {
                        that.listOfProducts[sku] = {};
                    }
                    that.listOfProducts[sku] = _.extend(that.listOfProducts[sku], {
                        order: prodIndex++,
                        sku: sku,
                        renderData: renderData
                    });
                });
            };
        }

        function getBanner() {
            var date = new Date();
            var day = date.getDate();
            var month = date.getMonth() + 1; // months are between 0 and 11
            var year = date.getFullYear();

            if ((day >= 27 && day <= 29) && month === 5 && year === 2018) {
                return templates.fullview_prints_banner;
            }
            return '';
        }

        utils.inheritPrototype(TLTextualViewEngine, EngineHorizontal);

        TLTextualViewEngine.prototype.render = function(params) {
            var source          = params.source;
            var prodStyles      = params.prodStyles;
            var prodSizes       = params.prodSizes;
            var prodOptions     = params.prodOptions;
            var showMessage     = params.showMessage;
            var modal_view      = params.modalView;
            var instance        = params.instance;
            var renderParams    = params.renderParams;
            var structure       = params.menuStructure;
            var that            = this;

            if (!utils.browserSupported()){
                that.failWidget('instance', 'tl', 'tl');
                return;
            }

            // No need to do anything - but update the collection
            if (renderParams.hasOwnProperty('onlyUpdateCollection') && renderParams.onlyUpdateCollection) {
                var albumId = String.fromCharCode(65 + Math.floor(Math.random() * 26)) + Date.now();
                var album = { albumId: albumId, photos: renderParams['photos'] };
                var albums = {
                    'photobook': [album],
                    'products': [album],
                    'prints': [album],
                    'calendars': [album]
                };
                //that.allAlbums = that.formatAllAlbums(albums, false);
                that.Model.set('albums', that.formatAllAlbums(albums, false));
                that.Model.set('ismanualselect', renderParams.manualSelection);

                return;
            }

            this.extractUserNameData();

            var ctr = that.Model.get('container');

            that.Model.get('monitoring').eventStart('tl:Start');

            // A "fast lane" for rendering
            if (this.isRendered) {
                var productJsonNew = [];

                function _getProductJsonNew(pJson) {
                    if (pJson != null) {
                        productJsonNew = productJsonNew.concat(pJson);
                    }
                }

                var newAlbum = {
                    albumId: String.fromCharCode(65 + Math.floor(Math.random() * 26)) + Date.now(),
                    photos: renderParams['photos']
                };

                this.isFirstRun = false;

                $.when(
                    productProxy.getPhotobook(newAlbum, 40, _getProductJsonNew, false, true, source, true, false, true),
                    productProxy.getProducts(newAlbum, _getProductJsonNew, true, source, true, true, false, true),
                    productProxy.getPrints(newAlbum, _getProductJsonNew, true, source, true, false, true),
                    productProxy.getCalendar(newAlbum, _getProductJsonNew, true, source, true, false, true)
                )
                    .then(function ()
                    {
                        var allAlbums = {
                            'photobook': [renderParams['photos']],
                            'products': [renderParams['photos']],
                            'prints': [renderParams['photos']],
                            'calendars': [renderParams['photos']]
                        };
                        renderMainTemplate();
                        $(ctr).find('.sfly_wgt_listview_container').find('.sfly_wgt_product').addClass('sfly_wgt_product_placeholder').html('');
                        //this.renderView($(ctr).find('.sfly_wgt_listview_container'), source, productJsonNew, allAlbums, prodStyles, prodSizes, prodOptions, modal_view, instance);
                    })
                    .fail(function ()
                    {
                        view_common.removeLoading($('.sfly_wgt_listview_container'));
                    });
                return;
            }


            this.isRendered = true;


            var useThesePhotos = undefined;
            if(typeof renderParams !== "undefined") {
                useThesePhotos  = renderParams['photos'];

                if(typeof renderParams['manualSelect'] !== "undefined"){
                    this.isManual = renderParams['manualSelect'];
                }
            }

            this.isManual = that.Model.get('isManualSelect') ? true : false;

            this.init(this.coupon);

            // do not render template until we have mgsources
            function renderMainTemplate(showLoader) {
                var pEl;
                var promoElement = that.Model.get('promoElement');
                var pType = that.Model.get('prod_type');
                $(ctr).html(view_common.renderTemplate(templates.listview_cont_tlVert, { prodType: pType }));

                //Email sharing from photos
                if (pType == 'photogifts_share') {
                    var title = (ctr).find('.sfly_wgt_listview_embedded_title');
                    $(title).html();
                    $(title).addClass('pg_share');
                    return;
                }

                var loadingContainer = $(ctr).find('.sfly_wgt_loading');
                //we are not using promo placeholder now. But lets keep it because i might get used in future
                if (promoElement !== null && $(promoElement).length > 0) {
                    pEl = promoElement;
                    $(ctr).find('.sfly_wgt_listview_embedded_title').remove();
                    loadingContainer.addClass('mobile');
                } else {
                    if (that.isMobile) {
                        loadingContainer.addClass('mobile');
                        $(ctr).find('.sfly_wgt_listview_embedded_title').addClass('mobile');
                    }
                    else {
                        $(ctr).find('.sfly_wgt_listview_embedded_title').removeClass('mobile');
                        if (pType == 'calendar' || pType == 'deskcalendar' || pType == 'photobook' || pType == 'photobook_share') {
                            loadingContainer.addClass('sml_loader');
                        }
                    }

                    pEl = $(ctr).find('.sfly_wgt_special_offers');
                }

                that.promoEl = pEl;

                productProxy.getSflyPromos(pType, that.isMobile).then(function(response){
                    that.renderPromo(response);
                });

                // if(!cache.get('trackSent')) {
                //     tracking.track('tl', 'load-top-menu', {
                //         mode: 'instance'
                //     });
                //     cache.set('trackSent', true)
                // }

            }

            // Remove classes added on hover on product
            $(ctr).on('mouseleave', function() {
                that.removeHoverStates(this);
            });

            if (typeof showMessage !== 'undefined' && showMessage != null) {
                renderMainTemplate(source);
                that.horizontalShowOverlayView(showMessage, this.IS_VIEW_DISABLED.state, instance);
                return;
            }

            var failId = 0;
            var currCallId = 1;
            var productJson = [];
            function _getProductJson(callId, pJson) {
                if (pJson != null && callId != failId) {
                    productJson = productJson.concat(pJson);
                }
            }

            // Check what kind of products is this and ask for MG Source accordingly
            var getPrints   = 0;
            var getProducts = 0;
            var getBooks    = 0;
            var getCalendar = 0;

            _.each(source, function(pId) {
                var product = view_common.getProduct(pId);
                switch(product.type) {
                    case 'prints':
                        getPrints = this.PRINTS_NUM_ALBUMS;
                        break;
                    case 'photobook':
                        getBooks = this.PB_NUM_ALBUMS;
                        break;
                    case 'calendar':
                    case 'deskcalendar':
                        getCalendar = this.CAL_NUM_ALBUMS;
                        break;
                    default:
                        getProducts = this.PROD_NUM_ALBUMS;
                        break;
                }
            });

            // function for get from rankservice the project jsons and pass call the render method
            function getRankSourcesAndRender(albums, instance, isFullPhotoData){
                isFullPhotoData = isFullPhotoData || false;
                that.Model.get('monitoring').eventStart('tl:getRankService');
                var getProductsFromRank = function(retry) {
                    var d = $.Deferred();

                    var allAlbums = that.formatAllAlbums(albums, retry);
                    //that.allAlbums = allAlbums;
                    that.Model.set('albums', allAlbums);

                    // Check if we have enough products to create using the albums we got.
                    // We pass 100 as num of photos as we don't want to cut it
                    var cleanSource = that.cleanSourceWithAlbums(source, allAlbums, 100);

                    // if less than 3 products do not render mg
                    if (cleanSource.length < 1) {
                        console.log('[Product Widget]> Not enough resources for render.');
                        renderMainTemplate(false);
                        that.horizontalShowOverlayView('upload', that.IS_VIEW_DISABLED.state, instance);
                        d.resolve(true);
                        return;
                    }

                    var albumsToSendToRank = _.clone(allAlbums);
                    if(isFullPhotoData){
                        that.isAfterUPP = true;
                        albumsToSendToRank['photobook'] = allAlbums['photobook'][0];
                        albumsToSendToRank['products'] = allAlbums['products'][0];
                        albumsToSendToRank['prints'] = allAlbums['prints'][0];
                        albumsToSendToRank['calendars'] = allAlbums['calendars'][0];
                    }

                    var photobookOnlyCover = false; //(instance.settings['prod_type'] == "photobook" || instance.settings['prod_type'] == "photobook_share") ? false : true;

                    $.when(
                        productProxy.getPhotobook(albumsToSendToRank['photobook'], 40, _getProductJson.bind(this, currCallId), photobookOnlyCover, that.isManual, cleanSource, true, false, true),
                        productProxy.getProducts(albumsToSendToRank['products'], _getProductJson.bind(this, currCallId), that.isManual, cleanSource, true, true, false, true),
                        productProxy.getPrints(albumsToSendToRank['prints'], _getProductJson.bind(this, currCallId), that.isManual, cleanSource, true, false, true),
                        productProxy.getCalendar(albumsToSendToRank['calendars'], _getProductJson.bind(this, currCallId), that.isManual, cleanSource, true, false, true)
                    )
                        .then(function () {
                            that.Model.get('monitoring').eventEnd('tl:getRankService');
                            renderMainTemplate(true, cleanSource);
                            that.renderView($(ctr).find('.sfly_wgt_listview_container'), cleanSource, productJson, allAlbums, prodStyles, prodSizes, prodOptions, modal_view, instance, structure);
                            d.resolve(true);
                        })
                        .fail(function () {
                            if(retry) {
                                console.log('[Product Widget]> Failed loading resources (Api). Aborting.');
                                productProxy.MgFail();
                                renderMainTemplate();
                                that.failWidget('instance', 'tl', 'tl');
                            } else {
                                console.log('[Product Widget]> Failed loading resources (Api). Retrying with different source.');
                            }
                            d.reject();
                        });
                    return d.promise();
                };

                // get products from api. If fails the first time retry with a second source.
                $.when(getProductsFromRank())
                    .fail(function(){
                        failId = currCallId;
                        currCallId++;
                        productJson = [];
                        getProductsFromRank(true);
                    });
            }

            // render magic shop using some specific photos otherwise call getMgSource
            // This is for TL
            if(typeof useThesePhotos !== "undefined" && _.isArray(useThesePhotos)){
                var albumId = String.fromCharCode(65 + Math.floor(Math.random() * 26)) + Date.now();
                var album = { albumId: albumId, photos: useThesePhotos };
                var albums = {
                    photobooks: [album],
                    products: [album],
                    prints: [album],
                    calendars: [album]
                };
                this.inThisLife = true;
                cache.removeProductsAll();
                getRankSourcesAndRender(albums, instance, true);
            } else {
                // we have a 2 step process for displaying the widget
                // 1. Get the photos and albums for the user
                // 2. Get the covers for the albums
                that.Model.get('monitoring').eventStart('tl:getMgSource');
                productProxy.getMGSources(function(albums) {
                    that.Model.get('monitoring').eventEnd('tl:getMgSource');
                    if (albums != null) {
                        if (_.isEmpty(albums)) {
                            // Not enough sources. Show overlay and exit.
                            renderMainTemplate(false);
                            that.horizontalShowOverlayView('upload',that.IS_VIEW_DISABLED.state, instance);
                            return;
                        }
                        getRankSourcesAndRender(albums, instance);
                    } else {
                        console.log('[Product Widget]> Failed loading resources. Aborting.');
                        productProxy.MgFail();
                        renderMainTemplate();
                        that.failWidget('instance', 'tl', 'tl');
                    }
                });
            }
        };

        return TLTextualViewEngine;
    });

/*
This module will be responsible to load the correct modules for the view engines
 */

define('app/view_engine/controller', ['app/view_engine/widgets/widget', 'app/cache_module', 'app/view_engine/widgets/widgetVertical', 'app/view_engine/modals/minimal/modal_manager', 'app/view_engine/modals/full/modal_manager', 'app/settings', 'app/utils', 'app/time_monitor', 'app/athena_logger', 'app/view_engine/helpers', 'app/view_engine/widgets/engines/vertical/Engine', 'app/view_engine/widgets/engines/horizontal/Engine', 'app/view_engine/widgets/engines/horizontal_flex/Engine', 'app/view_engine/widgets/engines/gifting/Engine', 'app/view_engine/widgets/engines/tl_horizontal/Engine', 'app/view_engine/widgets/engines/tl_horizontal/EngineVertical', 'app/view_engine/widgets/engines/timeline/Engine', 'app/view_engine/widgets/engines/replacement/Engine', 'app/view_engine/widgets/engines/tl_horizontal/EngineTextual'], function(Widget, cache, WidgetVertical, modal_view_minimal, modal_view_full, settings, utils, Monitor, Logger, helpers, VerticalEngine, HorizontalEngine, HorizontalFlexEngine, GiftingEngine, TLHorizontalEngine, TLVerticalEngine, TimelineEngine, ReplaceEngine, TLTextualEngine) {
    // Will prepare the needed containers. The widget always needs a container.
    function prepareContainer(widgetType, container) {
        if (widgetType == 'floating') {
            $('body').append('<div id="sfly_wgt_container" class="sfly_wgt"></div>');
            container = $('body').children('#sfly_wgt_container');
        } else if (widgetType == 'replacement') {
            container = null;
        }

        if (typeof container === "undefined" || container == null) {
            var mg_crossSell = (typeof (window.MagicShop.cross_sell_recipeB) != 'undefined') &&  (window.location.href.indexOf('recommendations.sfly') != -1); //get the cross_sell parameter
            container = mg_crossSell ? $('#recommendationsArea') : $('#MagicShopFull');
        }

        return container;
    }

    // Prepare containers for the modals.
    function prepareModalHelpers(modalType, modalContainer) {
        switch(modalType) {
            case 'min_modal':
                $('body')
                    .append('<div id="sfly_wgt_openwin_container" class="sfly_wgt"></div>');

                // Disable / Enable scrolling when entering/existing the widget open state
                $('#sfly_wgt_openwin_container')
                    .on('mouseenter', utils.disableScroll)
                    .on('mouseleave', utils.enableScroll);
                break;
            case 'full_modal':
                if (modalContainer !== null && typeof modalContainer !== 'undefined') {
                    if($(modalContainer).find("#sfly_wgt_full_openwin_container").length == 0) {
                        $(modalContainer).find('.magicshop_modal_content_wrapper').html('<div id="sfly_wgt_full_openwin_container" class="sfly_wgt sfly_wgt_modal_embedded"></div><div id="sfly_wgt_full_overlay" class="sfly_wgt_modal_embedded"></div>');
                    }
                } else {
                    if(document.getElementById("sfly_wgt_full_openwin_container") == null) {
                        $('body').append('<div id="sfly_wgt_full_openwin_container" class="sfly_wgt"></div><div id="sfly_wgt_full_overlay"></div>');
                    }
                }
                break;
        }
    }

    function prepareParameters(baseParams, widgetConfig, widgetParams, model) {
        var prod_type = model.attributes.prod_type ? model.attributes.prod_type : null;
        var mg_crossSell = (typeof (window.MagicShop.cross_sell_recipeB) != 'undefined') &&  (window.location.href.indexOf('recommendations.sfly') != -1); //get the cross_sell parameter
        var params = {
            "model": model
        };
        switch(widgetConfig.orientation) {
            case 'vertical':
                baseParams = _.extend(baseParams, {
                    modalView: modal_view_minimal,
                    viewEngine: new VerticalEngine(params)
                });

                break;
            case 'horizontal':
                //force display for monitoring purpose
                if(MagicShop.ForceDisplay) {
                    $("#MagicShopFull").attr('style','display: block !important');
                }
                baseParams = _.extend(baseParams, {
                    modalView: modal_view_full,
                    viewEngine: new HorizontalEngine(params)
                });
                break;
            case 'horizontal_flex':
                //force display for monitoring purpose
                if(MagicShop.ForceDisplay) {
                    $("#MagicShopFull").attr('style','display: block !important');
                }
                baseParams = _.extend(baseParams, {
                    modalView: modal_view_full,
                    viewEngine: new HorizontalFlexEngine(params)
                });
                break;
            case 'tl_horizontal':
                if (widgetParams.isTimeline) {
                    baseParams = {
                        source: widgetParams.showProducts,
                        prodStyles: widgetParams.prodAssociations,
                        prodSizes: widgetParams.prodSizing,
                        prodOptions: widgetParams.prodOptions,
                        renderParams: widgetParams.renderParams,
                        //instance: instance,
                        modalView: modal_view_full,
                        viewEngine: new TimelineEngine(params)
                    };
                    model.set('instance', true);

                    //if require to put mg on cross_sell page
                } else {

                    var viewEngine;

                    switch (prod_type) {
                        case 'photogifts':
                        case 'cns':
                        case 'prints':
                        case 'homedecor':
                        case 'kids':
                            viewEngine = utils.isMobile ? TLVerticalEngine : TLTextualEngine;
                            break;
                        case 'photobook_share':
                            viewEngine = TLHorizontalEngine;
                            widgetParams.renderParams['shareStyleTag'] = 'photobook_share_widget_style';
                            break;
                        case 'prints_share':
                            viewEngine = TLHorizontalEngine;
                            widgetParams.renderParams['shareStyleTag'] = 'prints_share_widget_style';
                            break;
                        case 'photogifts_share':
                            viewEngine = TLHorizontalEngine;
                            widgetParams.renderParams['shareStyleTag'] = 'photogifts_share_widget_style';
                            break;
                        default:
                            viewEngine = TLVerticalEngine;
                    }

                    baseParams = _.extend(baseParams, {
                        modalView: modal_view_full,
                        renderParams: widgetParams.renderParams,
                        menuStructure: widgetParams.menuStructure,
                        viewEngine: new viewEngine(params)
                    });

                    model.set('instance', true);
                }
                break;
            case 'gifting':
            case 'gifting_gm':
            case 'gifting_father':
            case 'gifting_grandpa':
            case 'gifting_christmas':
            case 'gifting_holiday':
            case 'gifting_hanukkah':
                baseParams = _.extend(baseParams, {
                    modalView: modal_view_full,
                    //instance: instance,
                    renderParams: widgetParams.renderParams,
                    viewEngine: new GiftingEngine(params)
                });
                model.set('instance', true);
                break;
            case 'replacement':
                if (mg_crossSell) {
                    baseParams = _.extend(baseParams, {
                        modalView: modal_view_full,
                        isCrossSell: true,
                        viewEngine: new HorizontalEngine(params)
                    });

                } else {
                    baseParams = {
                        prodStyles: widgetParams.prodAssociations,
                        prodSizes: widgetParams.prodSizing,
                        prodOptions: widgetParams.prodOptions,
                        replaceType: widgetParams.replaceType,
                        modalView: modal_view_full,
                        viewEngine: new ReplaceEngine(params)
                    };
                }
                break;
            default:
                throw "Invalid widget orientation: " + widgetConfig.orientation ;
                break;
        }

        return baseParams;
    }

    function createWidget(orientation, params) {
        if (orientation == 'vertical') {
            return new WidgetVertical(params);
        }

        return new Widget(params);
    }

    return {
        startRender: function(widgetConfig, widgetParams, model) {
            var prodType = model.get('prod_type') ? model.get('prod_type') : cache.get('prod_type');
            model.set('instance',       false);
            model.set('container',      prepareContainer(widgetConfig.type, model.get('container')));
            model.set('downloadQueue',  new helpers.ImageQueue());
            model.set('monitoring', new Monitor(prodType));
            model.set('athenaLogger', new Logger(prodType, cache.get('cohort')));
            prepareModalHelpers(widgetConfig.modal, model.get('modalContainer'));

            model.get('athenaLogger').logModuleInit();

            var baseParams = {
                source: widgetParams.showProducts,
                prodStyles: widgetParams.prodAssociations,
                prodSizes: widgetParams.prodSizing,
                prodOptions: widgetParams.prodOptions,
                showMessage: widgetParams.showMsg,
                numOfProducts: widgetParams.minNumOfProducts,
                Model: model
            };

            createWidget(widgetConfig.orientation, prepareParameters(baseParams, widgetConfig, widgetParams, model)).render();
        }
    }
});

/*
The flow manager is a kind of router for different types of the widget.
 */
define("app/flow_manager", ['app/view_engine/controller', 'app/settings', 'app/config_manager', 'app/cache_module'],
    function(controller, settings, config, cache) {
        return {

            /*
             Parameters:
             @photos - photos to use for the widget
             @manualSelect - if photos were selected manually
             */
            render: function(model, params) {
                // Make sure all the data has been loaded
                var MAX_ITR     = 50;
                var ITR_WAIT    = 200;
                var count       = 0;

                // Check if the prices were loaded
                function _isPriceLoaded() {
                    return (typeof cache.get('prices_loaded') !== 'undefined' && cache.get('prices_loaded'));
                }

                // Try to render the correct view. Retry if not ready yet.
                function renderView() {
                    // We want to wait until all the recipe and config files are loaded before rendering

                    if (model.get('timeline')) {
                        var overrideMode = 'timeline';
                    } else if (model.get('mode')) {
                        overrideMode = model.get('mode');
                    }

                    model.set('isManualSelect', typeof params !== 'undefined' && params.hasOwnProperty('isManualSelect') ? !!params.isManualSelect : false);

                    // We have everything loaded, can render now
                    var prod_type       = model.get('prod_type') ? model.get('prod_type') : cache.get('prod_type');
                    var modeConfig      = config.getWidgetModeConfig(overrideMode);
                    var widgetParams    = null;
                    var recipeName      = modeConfig.orientation + "_" + config.getWidgetProdType({"overrideType": prod_type});
                    if (recipeName === "horizontal_flex_mysfly") {
                        if (typeof window.MagicShop !== 'undefined' &&
                            window.MagicShop.abTestGroup ==='GroupB'
                        )
                        {
                            recipeName = "horizontal_flex_mysfly_oneline";
                        }
                    }
                    var recipe          = config.getRecipe(recipeName);
                    var products        = {};
                    if (typeof recipe !== "undefined") {
                        recipe          = config.shuffleRecipe(recipeName, recipe);
                        products        = typeof recipe[recipeName] !== "undefined" ? recipe[recipeName] : {};
                    }
                    //var products        = config.getProductsByModeAndType(modeConfig.orientation, config.getWidgetProdType({"overrideType": prod_type}), overrideMode);

                    switch(modeConfig.orientation) {
                        case 'vertical':
                        case 'horizontal':
                        case 'tl_horizontal':
                        case 'horizontal_flex':
                        case 'gifting':
                        case 'gifting_gm':
                        case 'gifting_father':
                        case 'gifting_grandpa':
                        case 'gifting_christmas':
                        case 'gifting_holiday':
                        case 'gifting_hanukkah':
                            widgetParams = {
                                showProducts: products['products'],
                                prodAssociations: products['associations'],
                                prodSizing: products['zoom_levels'],
                                prodOptions: products['options'],
                                showMsg: cache.getUserMessage(),
                                minNumOfProducts: products['product_number'],
                                menuStructure: products.hasOwnProperty('structure') ? products['structure'] : undefined
                            };

                            if (typeof params !== 'undefined') {
                                widgetParams.renderParams = params;
                            }

                            if (config.getWidgetProdType({"model":model}) == 'timeline') {
                                widgetParams.isTimeline = true;
                                widgetParams.renderParams = params;
                                widgetParams.showProducts = products['products'];
                            }
                            break;
                        case 'replacement':
                            widgetParams = {
                                replaceType: cache.get('mode')
                            };

                            if (cache.get('mode') == 'cross_sell') {
                                widgetParams.showProducts = products['products'];
                                widgetParams.prodAssociations = products['associations'];
                                widgetParams.prodSizing = products['zoom_levels'];
                                widgetParams.prodOptions = products['options'];
                            }

                            if (cache.get('mode') == 'store' || config.getWidgetProdType() == 'timeline') {
                                widgetParams.prodAssociations = products['associations'];
                                widgetParams.prodSizing = products['zoom_levels'];
                                widgetParams.prodOptions = products['options'];
                            }
                            break;
                        default:
                            throw "Invalid widget orientation";
                            break;
                    }

                    controller.startRender(modeConfig, widgetParams, model);
                }

                renderView();
            }
        }
});
/** @license
 * RequireJS plugin for loading JSON files
 * - depends on Text plugin and it was HEAVILY "inspired" by it as well.
 * Author: Miller Medeiros
 * Version: 0.4.0 (2014/04/10)
 * Released under the MIT license
 */
define('json',['text'], function(text){

    var CACHE_BUST_QUERY_PARAM = 'bust',
        CACHE_BUST_FLAG = '!bust',
        jsonParse = (typeof JSON !== 'undefined' && typeof JSON.parse === 'function')? JSON.parse : function(val){
            return eval('('+ val +')'); //quick and dirty
        },
        buildMap = {};

    function cacheBust(url){
        url = url.replace(CACHE_BUST_FLAG, '');
        url += (url.indexOf('?') < 0)? '?' : '&';
        return url + CACHE_BUST_QUERY_PARAM +'='+ Math.round(2147483647 * Math.random());
    }

    //API
    return {

        load : function(name, req, onLoad, config) {
            if (( config.isBuild && (config.inlineJSON === false || name.indexOf(CACHE_BUST_QUERY_PARAM +'=') !== -1)) || (req.toUrl(name).indexOf('empty:') === 0)) {
                //avoid inlining cache busted JSON or if inlineJSON:false
                //and don't inline files marked as empty!
                onLoad(null);
            } else {
                text.get(req.toUrl(name), function(data){
                        var parsed;
                        if (config.isBuild) {
                            buildMap[name] = data;
                            onLoad(data);
                        } else {
                            try {
                                parsed = jsonParse(data);
                            } catch (e) {
                                onLoad.error(e);
                            }
                            onLoad(parsed);
                        }
                    },
                    onLoad.error, {
                        accept: 'application/json'
                    }
                );
            }
        },

        normalize : function (name, normalize) {
            // used normalize to avoid caching references to a "cache busted" request
            if (name.indexOf(CACHE_BUST_FLAG) !== -1) {
                name = cacheBust(name);
            }
            // resolve any relative paths
            return normalize(name);
        },

        //write method based on RequireJS official text plugin by James Burke
        //https://github.com/jrburke/requirejs/blob/master/text.js
        write : function(pluginName, moduleName, write){
            if(moduleName in buildMap){
                var content = buildMap[moduleName];
                write('define("'+ pluginName +'!'+ moduleName +'", function(){ return '+ content +';});\n');
            }
        }

    };
});

define("json!app/json/recipeunited.min.json", function(){ return {
  "sizes": {
    "photobook": {
      "8x8": {
        "width": 683,
        "height": 515,
        "top": 27,
        "bottom": 75,
        "right": 105,
        "left": 189
      },
      "8x8_sprite": {
        "width": 1017,
        "height": 458,
        "top": 20,
        "bottom": 50,
        "right": 113,
        "left": 111
      },
      "8x11": {
        "width": 771,
        "height": 482,
        "top": 15,
        "bottom": 52,
        "right": 77,
        "left": 150
      },
      "8x11_sprite": {
        "width": 1234,
        "height": 445,
        "top": 20,
        "bottom": 40,
        "right": 114,
        "left": 114
      },
      "11x14": {
        "width": 771,
        "height": 482,
        "top": 15,
        "bottom": 52,
        "right": 77,
        "left": 150
      },
      "11x14_sprite": {
        "width": 1234,
        "height": 445,
        "top": 20,
        "bottom": 40,
        "right": 114,
        "left": 114
      }
    },
    "calendar": {
      "8x11": {
        "width": 470,
        "height": 400,
        "top": 33,
        "bottom": 56,
        "right": 34,
        "left": 32
      },
      "8x11_sprite": {
        "width": 465,
        "height": 430,
        "top": 5,
        "bottom": 0,
        "right": 16,
        "left": 45
      },
      "12x12": {
        "width": 321,
        "height": 321,
        "top": 15,
        "bottom": 37,
        "right": 28,
        "left": 23
      },
      "12x12_sprite": {
        "width": 321,
        "height": 356,
        "top": 13,
        "bottom": 0,
        "right": 26,
        "left": 22
      }
    },
    "deskcalendar": {
      "5x11_desk": {
        "width": 935,
        "height": 460,
        "top": 26,
        "bottom": 66,
        "right": 103,
        "left": 110
      },
      "5x11_desk_sprite": {
        "width": 935,
        "height": 460,
        "top": 26,
        "bottom": 66,
        "right": 103,
        "left": 110
      }
    },
    "iphone": {
      "width": 192,
      "height": 268,
      "top": 11,
      "bottom": 41,
      "right": 39,
      "left": 49,
      "5_liner": {
        "width": 192,
        "height": 268,
        "top": 11,
        "bottom": 41,
        "right": 39,
        "left": 49
      },
      "6_liner": {
        "width": 192,
        "height": 269,
        "top": 13,
        "bottom": 44,
        "right": 38,
        "left": 52
      },
      "6_slim": {
        "width": 192,
        "height": 269,
        "top": 13,
        "bottom": 44,
        "right": 38,
        "left": 52
      },
      "6plus_liner": {
        "width": 192,
        "height": 269,
        "top": 13,
        "bottom": 41,
        "right": 40,
        "left": 50
      },
      "8_slim": {
        "width": 252,
        "height": 360,
        "top": 32,
        "bottom": 26,
        "right": 52,
        "left": 52
      },
      "8_liner": {
        "width": 252,
        "height": 360,
        "top": 32,
        "bottom": 36,
        "right": 49,
        "left": 54
      },
      "8plus_slim": {
        "width": 231,
        "height": 360,
        "top": 38,
        "bottom": 36,
        "right": 43,
        "left": 41
      },
      "8plus_liner": {
        "width": 241,
        "height": 360,
        "top": 28,
        "bottom": 36,
        "right": 48,
        "left": 40
      },
      "x_slim": {
        "width": 360,
        "height": 698,
        "top": 40,
        "bottom": 38,
        "right": 21,
        "left": 23
      },
      "x_liner": {
        "width": 360,
        "height": 700,
        "top": 3,
        "bottom": 5,
        "right": 4,
        "left": 3
      },
      "xs_slim": {
        "width": 350,
        "height": 670,
        "top": 10,
        "bottom": 10,
        "right": 10,
        "left": 10
      },
      "xs_liner": {
        "width": 193,
        "height": 357,
        "top": 6,
        "bottom": 7,
        "right": 8,
        "left": 7
      },
      "xsmax_slim": {
        "width": 360,
        "height": 636,
        "top": 3,
        "bottom": 25,
        "right": 21,
        "left": 27
      },
      "xsmax_liner": {
        "width": 189,
        "height": 357,
        "top": 5,
        "bottom": 7,
        "right": 9,
        "left": 7
      },
      "xr_slim": {
        "width": 189,
        "height": 360,
        "top": 3,
        "bottom": 3,
        "right": 4,
        "left": 3
      },
      "xr_liner": {
        "width": 189,
        "height": 360,
        "top": 5,
        "bottom": 5,
        "right": 5,
        "left": 5
      }
    },
    "ipad": {
      "width": 211,
      "height": 260,
      "top": 11,
      "bottom": 40,
      "right": 19,
      "left": 33
    },
    "magnet": {
      "2x3_l": {
        "width": 519,
        "height": 266,
        "top": 20,
        "bottom": 40,
        "right": 59,
        "left": 123
      },
      "3x3": {
        "width": 227,
        "height": 183,
        "top": 9,
        "bottom": 39,
        "left": 62,
        "right": 22
      },
      "4x5.5_l": {
        "width": 519,
        "height": 266,
        "top": 10,
        "bottom": 40,
        "right": 59,
        "left": 123
      },
      "4x5.5_p": {
        "width": 276,
        "height": 266,
        "top": 10,
        "bottom": 39,
        "left": 75,
        "right": 28
      },
      "3x5_p": {
        "width": 227,
        "height": 266,
        "top": 10,
        "bottom": 39,
        "right": 22,
        "left": 62
      }
    },
    "glassmagnet": {
      "width": 618,
      "height": 234,
      "top": 23,
      "bottom": 60,
      "right": 22,
      "left": 22
    },
    "woven": {
      "54x70": {
        "width": 360,
        "height": 360,
        "top": 50,
        "bottom": 50,
        "right": 5,
        "left": 6
      },
      "60x80": {
        "width": 408,
        "height": 299,
        "top": 30,
        "bottom": 57,
        "right": 58,
        "left": 72
      }
    },
    "plaque": {
      "5x7_l": {
        "width": 464,
        "height": 271,
        "top": 14,
        "bottom": 41,
        "right": 46,
        "left": 110
      },
      "5x7_p": {
        "width": 228,
        "height": 266,
        "top": 8,
        "bottom": 40,
        "right": 22,
        "left": 55
      },
      "5x7_ticket_p": {
        "width": 250,
        "height": 266,
        "top": 9,
        "bottom": 42,
        "right": 21,
        "left": 55
      },
      "5x7_bracket_p": {
        "width": 260,
        "height": 360,
        "top": 31,
        "bottom": 106,
        "right": 30,
        "left": 47
      },
      "8x10_ticket_l": {
        "width": 464,
        "height": 271,
        "top": 13,
        "bottom": 43,
        "right": 69,
        "left": 132
      },
      "5x5": {
        "width": 409,
        "height": 271,
        "top": 15,
        "bottom": 47,
        "right": 66,
        "left": 110
      },
      "8x10_bracket_l": {
        "width": 326,
        "height": 307,
        "top": 20,
        "bottom": 67,
        "right": 20,
        "left": 34
      },
      "8x10_bracket_p": {
        "width": 260,
        "height": 360,
        "top": 31,
        "bottom": 110,
        "right": 31,
        "left": 33
      },
      "5x5_bracket": {
        "width": 260,
        "height": 360,
        "top": 88,
        "bottom": 110,
        "right": 31,
        "left": 46
      },
      "5x5_ticket": {
        "width": 250,
        "height": 189,
        "top": 10,
        "bottom": 13,
        "right": 15,
        "left": 52
      },
      "6x6_heart": {
        "width": 300,
        "height": 300,
        "top": 60,
        "bottom": 46,
        "right": 34,
        "left": 59
      },
      "8x10_rectangle_l": {
        "width": 464,
        "height": 271,
        "top": 5,
        "bottom": 25,
        "right": 15,
        "left": 109
      },
      "8x10_rectangle_p": {
        "width": 360,
        "height": 382,
        "top": 41,
        "bottom": 58,
        "right": 53,
        "left": 67
      },
      "oval_p": {
        "width": 300,
        "height": 360,
        "top": 33,
        "bottom": 55,
        "right": 51,
        "left": 52
      },
      "oval_l": {
        "width": 360,
        "height": 268,
        "top": 45,
        "bottom": 53,
        "right": 49,
        "left": 68
      }
    },
    "cup": {
      "width": 290,
      "height": 290,
      "top": 10,
      "bottom": 67,
      "right": 23,
      "left": 23
    },
    "travelmug": {
      "16_ss": {
        "width": 231,
        "height": 294,
        "top": 10,
        "bottom": 30,
        "right": 25,
        "left": 75
      },
      "handle": {
        "width": 320,
        "height": 365,
        "top": 6,
        "bottom": 6,
        "right": 70,
        "left": 0
      }
    },
    "waterbottle": {
      "width": 241,
      "height": 294,
      "top": 16,
      "bottom": 34,
      "right": 51,
      "left": 108
    },
    "mouse": {
      "width": 360,
      "height": 281,
      "top": 17,
      "bottom": 53,
      "right": 34,
      "left": 28,
      "bracket": {
        "width": 360,
        "height": 281,
        "top": 17,
        "bottom": 48,
        "right": 31,
        "left": 72
      }
    },
    "canvas": {
      "width": 403,
      "height": 266,
      "top": 14,
      "bottom": 38,
      "right": 34,
      "left": 104,
      "20x30_l": {
        "width": 489,
        "height": 266,
        "top": 9,
        "bottom": 40,
        "right": 42,
        "left": 125
      },
      "12x12": {
        "width": 317,
        "height": 266,
        "top": 9,
        "bottom": 40,
        "right": 22,
        "left": 83
      },
      "20x30_p": {
        "width": 223,
        "height": 257,
        "top": 5,
        "bottom": 36,
        "right": 20,
        "left": 60
      },
      "10x14_p": {
        "width": 223,
        "height": 257,
        "top": 6,
        "bottom": 39,
        "right": 20,
        "left": 51
      },
      "10x14_l": {
        "width": 459,
        "height": 266,
        "top": 9,
        "bottom": 40,
        "right": 39,
        "left": 118
      },
      "8x10_p": {
        "width": 262,
        "height": 257,
        "top": 6,
        "bottom": 39,
        "right": 22,
        "left": 68
      },
      "8x10_l": {
        "width": 459,
        "height": 266,
        "top": 10,
        "bottom": 40,
        "right": 39,
        "left": 149
      },
      "24x36_p": {
        "width": 223,
        "height": 257,
        "top": 5,
        "bottom": 37,
        "right": 20,
        "left": 60
      },
      "16x20_p": {
        "width": 270,
        "height": 266,
        "top": 9,
        "bottom": 40,
        "right": 22,
        "left": 70
      },
      "16x20_l": {
        "width": 403,
        "height": 266,
        "top": 9,
        "bottom": 40,
        "right": 35,
        "left": 103
      },
      "5x7_easel_l": {
        "width": 360,
        "height": 360,
        "top": 65,
        "bottom": 69,
        "right": 21,
        "left": 15
      },
      "5x7_easel_p": {
        "width": 360,
        "height": 360,
        "top": 2,
        "bottom": 4,
        "right": 48,
        "left": 32
      }
    },
    "blanket": {
      "width": 488,
      "height": 265,
      "top": 9,
      "bottom": 41,
      "right": 69,
      "left": 137,
      "50x60_l": {
        "width": 488,
        "height": 265,
        "top": 9,
        "bottom": 41,
        "right": 69,
        "left": 137
      },
      "50x60_p": {
        "width": 250,
        "height": 306,
        "top": 13,
        "bottom": 40,
        "right": 36,
        "left": 25
      }
    },
    "wallart": {
      "10x14_l": {
        "width": 447,
        "height": 289,
        "top": 16,
        "bottom": 60,
        "right": 39,
        "left": 114
      },
      "8x10_p": {
        "width": 447,
        "height": 289,
        "top": 12,
        "bottom": 60,
        "right": 135,
        "left": 131
      },
      "8x10_l": {
        "width": 360,
        "height": 360,
        "top": 49,
        "bottom": 65,
        "right": 29,
        "left": 23
      },
      "16x20_p": {
        "width": 360,
        "height": 360,
        "top": 12,
        "bottom": 11,
        "right": 46,
        "left": 45
      },
      "16x20_l": {
        "width": 360,
        "height": 360,
        "top": 46,
        "bottom": 46,
        "right": 12,
        "left": 13
      },
      "12x12": {
        "width": 360,
        "height": 360,
        "top": 36,
        "bottom": 36,
        "right": 38,
        "left": 34
      }
    },
    "shoppingbag": {
      "width": 186,
      "height": 297,
      "top": 25,
      "bottom": 44,
      "right": 10,
      "left": 10,
      "trueblue_new": {
        "width": 360,
        "height": 360,
        "top": 7,
        "bottom": 28,
        "right": 52,
        "left": 48
      }
    },
    "curvedglass": {
      "width": 393,
      "height": 287,
      "top": 10,
      "bottom": 62,
      "right": 37,
      "left": 31
    },
    "galaxy": {
      "width": 192,
      "height": 268,
      "top": 10,
      "bottom": 38,
      "right": 37,
      "left": 32,
      "8_liner": {
        "width": 192,
        "height": 360,
        "top": 4,
        "bottom": 6,
        "right": 12,
        "left": 13
      },
      "8_slim": {
        "width": 180,
        "height": 360,
        "top": 3,
        "bottom": 5,
        "right": 9,
        "left": 9
      },
      "8plus_liner": {
        "width": 190,
        "height": 360,
        "top": 4,
        "bottom": 3,
        "right": 11,
        "left": 7
      },
      "8plus_slim": {
        "width": 177,
        "height": 360,
        "top": 5,
        "bottom": 5,
        "right": 7,
        "left": 9
      }
    },
    "metalwallart": {
      "10x14_l": {
        "width": 360,
        "height": 360,
        "top": 57,
        "bottom": 58,
        "right": 10,
        "left": 10
      },
      "8x10_l": {
        "width": 374,
        "height": 236,
        "top": 7,
        "bottom": 40,
        "right": 34,
        "left": 104
      },
      "12x12": {
        "width": 360,
        "height": 360,
        "top": 24,
        "bottom": 32,
        "right": 30,
        "left": 24
      },
      "16x16": {
        "width": 360,
        "height": 360,
        "top": 18,
        "bottom": 25,
        "right": 24,
        "left": 20
      },
      "20x30_p": {
        "width": 360,
        "height": 360,
        "top": 2,
        "bottom": 15,
        "right": 65,
        "left": 67
      }
    },
    "plate": {
      "width": 196,
      "height": 207,
      "top": 13,
      "bottom": 21,
      "right": 3,
      "left": 22
    },
    "collage": {
      "width": 421,
      "height": 266,
      "top": 10,
      "bottom": 40,
      "right": 37,
      "left": 110,
      "8x10_l": {
        "width": 421,
        "height": 266,
        "top": 10,
        "bottom": 40,
        "right": 37,
        "left": 110
      },
      "20x30_l": {
        "width": 600,
        "height": 315,
        "top": 2,
        "bottom": 44,
        "right": 59,
        "left": 143
      },
      "11x14_p": {
        "width": 326,
        "height": 315,
        "top": 2,
        "bottom": 48,
        "right": 30,
        "left": 88
      },
      "8x8": {
        "width": 409,
        "height": 315,
        "top": 2,
        "bottom": 47,
        "right": 38,
        "left": 106
      }
    },
    "prints": {
      "width": 431,
      "height": 315,
      "top": 11,
      "bottom": 35,
      "right": 36,
      "left": 26
    },
    "printsl": {
      "width": 431,
      "height": 315,
      "top": 11,
      "bottom": 35,
      "right": 36,
      "left": 26
    },
    "printsp": {
      "width": 431,
      "height": 315,
      "top": 12,
      "bottom": 34,
      "right": 115,
      "left": 105
    },
    "flatglass": {
      "width": 350,
      "height": 307,
      "top": 18,
      "bottom": 65,
      "right": 34,
      "left": 31,
      "5x7_p": {
        "width": 460,
        "height": 460,
        "top": 16,
        "bottom": 20,
        "right": 78,
        "left": 77
      },
      "5x5": {
        "width": 460,
        "height": 460,
        "top": 51,
        "bottom": 52,
        "right": 52,
        "left": 53
      },
      "7x7": {
        "width": 460,
        "height": 460,
        "top": 25,
        "bottom": 27,
        "right": 27,
        "left": 27
      },
      "8x10_l": {
        "width": 460,
        "height": 460,
        "top": 68,
        "bottom": 71,
        "right": 31,
        "left": 28
      },
      "8x10_p": {
        "width": 460,
        "height": 460,
        "top": 30,
        "bottom": 32,
        "right": 73,
        "left": 70
      },
      "9x9": {
        "width": 460,
        "height": 460,
        "top": 29,
        "bottom": 31,
        "right": 32,
        "left": 30
      },
      "10x12_l": {
        "width": 460,
        "height": 460,
        "top": 58,
        "bottom": 61,
        "right": 25,
        "left": 24
      },
      "10x12_p": {
        "width": 460,
        "height": 460,
        "top": 25,
        "bottom": 29,
        "right": 63,
        "left": 60
      }
    },
    "card": {
      "5x7_flat_p": {
        "width": 193,
        "height": 243,
        "top": 10,
        "bottom": 15,
        "right": 18,
        "left": 21
      },
      "5x7_flat_l": {
        "width": 360,
        "height": 271,
        "top": 15,
        "bottom": 39,
        "right": 26,
        "left": 30
      },
      "5x7_folded_l": {
        "width": 360,
        "height": 271,
        "top": 14,
        "bottom": 39,
        "right": 25,
        "left": 32
      },
      "5x7_folded_p": {
        "width": 193,
        "height": 267,
        "top": 11,
        "bottom": 36,
        "right": 16,
        "left": 20
      },
      "4x8_flat_l": {
        "width": 427,
        "height": 227,
        "top": 6,
        "bottom": 41,
        "right": 28,
        "left": 30
      },
      "4x8_flat_p": {
        "width": 135,
        "height": 272,
        "top": 15,
        "bottom": 41,
        "right": 13,
        "left": 14
      },
      "5x5_flat": {
        "width": 193,
        "height": 215,
        "top": 8,
        "bottom": 39,
        "right": 13,
        "left": 15
      },
      "6x8_flat_p": {
        "width": 193,
        "height": 267,
        "top": 10,
        "bottom": 41,
        "right": 17,
        "left": 19
      },
      "4x5_flat_p": {
        "width": 193,
        "height": 267,
        "top": 15,
        "bottom": 41,
        "right": 17,
        "left": 20
      },
      "4x5_flat_l": {
        "width": 353,
        "height": 271,
        "top": 9,
        "bottom": 41,
        "right": 25,
        "left": 31
      },
      "3x5_folded_l": {
        "width": 370,
        "height": 271,
        "top": 15,
        "bottom": 41,
        "right": 36,
        "left": 31
      },
      "6x8_flat_l": {
        "width": 353,
        "height": 271,
        "top": 14,
        "bottom": 40,
        "right": 25,
        "left": 30
      },
      "3x5_folded_p": {
        "width": 193,
        "height": 267,
        "top": 2,
        "bottom": 39,
        "right": 17,
        "left": 20
      }
    },
    "ceramicor": {
      "circle": {
        "width": 284,
        "height": 344,
        "top": 53,
        "bottom": 79,
        "right": 8,
        "left": 65
      }
    },
    "journal": {
      "6x8": {
        "width": 360,
        "height": 360,
        "top": 37,
        "bottom": 35,
        "right": 70,
        "left": 73
      }
    },
    "mug": {
      "11_w": {
        "width": 326,
        "height": 283,
        "top": 26,
        "bottom": 40,
        "right": 30,
        "left": 30
      },
      "15_w": {
        "width": 321,
        "height": 283,
        "top": 56,
        "bottom": 51,
        "right": 93,
        "left": 86
      }
    },
    "pillow": {
      "width": 262,
      "height": 299,
      "top": 15,
      "bottom": 66,
      "right": 25,
      "left": 8,
      "18x24_i": {
        "width": 309,
        "height": 308,
        "top": 10,
        "bottom": 70,
        "right": 14,
        "left": 18
      },
      "12x16_i": {
        "width": 310,
        "height": 308,
        "top": 10,
        "bottom": 70,
        "right": 14,
        "left": 18
      }
    },
    "rubberstamp": {
      "width": 250,
      "height": 250,
      "top": 10,
      "bottom": 10,
      "right": 0,
      "left": 55
    },
    "cubeor": {
      "width": 359,
      "height": 320,
      "top": 53,
      "bottom": 90,
      "right": 109,
      "left": 64
    },
    "puzzle": {
      "width": 366,
      "height": 264,
      "top": 7,
      "bottom": 38,
      "right": 26,
      "left": 31
    },
    "acrylicblock": {
      "width": 357,
      "height": 244,
      "top": 15,
      "bottom": 29,
      "right": 26,
      "left": 56
    },
    "acrylicprint": {
      "width": 378,
      "height": 277,
      "top": 18,
      "bottom": 39,
      "right": 26,
      "left": 31
    },
    "metalor": {
      "rect": {
        "width": 275,
        "height": 264,
        "top": 20,
        "bottom": 38,
        "right": 0,
        "left": 0
      },
      "square": {
        "width": 275,
        "height": 264,
        "top": 0,
        "bottom": 50,
        "right": 40,
        "left": 40
      },
      "snow_l": {
        "width": 218,
        "height": 261,
        "top": 26,
        "bottom": 46,
        "left": 11,
        "right": 35
      }
    },
    "glassor": {
      "circle": {
        "width": 210,
        "height": 252,
        "top": 30,
        "bottom": 36,
        "right": 9,
        "left": 23
      },
      "square": {
        "width": 215,
        "height": 259,
        "top": 20,
        "bottom": 47,
        "right": 22,
        "left": 21
      },
      "glitter": {
        "width": 360,
        "height": 360,
        "top": 7,
        "bottom": 9,
        "right": 24,
        "left": 23
      }
    },
    "artprint": {
      "5x7_l": {
        "width": 359,
        "height": 262,
        "top": 10,
        "bottom": 38,
        "right": 30,
        "left": 30
      },
      "5x7_p": {
        "width": 257,
        "height": 388,
        "top": 22,
        "bottom": 38,
        "right": 23,
        "left": 21
      }
    },
    "framedartprint": {
      "8x10_l": {
        "width": 221,
        "height": 257,
        "top": 7,
        "bottom": 38,
        "right": 22,
        "left": 19
      },
      "8x10_p": {
        "width": 221,
        "height": 257,
        "top": 5,
        "bottom": 36,
        "right": 20,
        "left": 19
      },
      "11x14_p": {
        "width": 268,
        "height": 265,
        "top": 7,
        "bottom": 39,
        "right": 50,
        "left": 37
      },
      "12x12": {
        "width": 262,
        "height": 270,
        "top": 18,
        "bottom": 38,
        "right": 25,
        "left": 26
      }
    },
    "stockings": {
      "width": 166,
      "height": 259,
      "top": 25,
      "bottom": 59,
      "right": 51,
      "left": 23,
      "xmes": {
        "width": 166,
        "height": 259,
        "top": 3,
        "bottom": 49,
        "right": 39,
        "left": 23
      }
    },
    "serving-tray": {
      "width": 358,
      "height": 278,
      "top": 30,
      "bottom": 35,
      "right": 12,
      "left": 34
    },
    "candle": {
      "width": 190,
      "height": 240,
      "top": 17,
      "bottom": 50,
      "right": 29,
      "left": 31
    },
    "portable": {
      "width": 161,
      "height": 302,
      "top": 8,
      "bottom": 77,
      "right": 7,
      "left": 12
    },
    "giftwrap": {
      "width": 265,
      "height": 287,
      "top": 11,
      "bottom": 60,
      "right": 11,
      "left": 15
    },
    "playingcards": {
      "width": 308,
      "height": 283,
      "top": 17,
      "bottom": 40,
      "right": 42,
      "left": 28
    },
    "framedcanvas": {
      "8x10_l": {
        "width": 359,
        "height": 313,
        "top": 24,
        "bottom": 61,
        "right": 31,
        "left": 34
      },
      "8x10_p": {
        "width": 218,
        "height": 307,
        "top": 17,
        "bottom": 65,
        "right": 18,
        "left": 23
      },
      "16x16": {
        "width": 265,
        "height": 313,
        "top": 30,
        "bottom": 59,
        "right": 22,
        "left": 22
      }
    },
    "quilt": {
      "50x60_taupe": {
        "width": 230,
        "height": 299,
        "top": 16,
        "bottom": 49,
        "right": 20,
        "left": 17
      }
    },
    "luggagetag": {
      "width": 149,
      "height": 326,
      "top": 7,
      "bottom": 47,
      "right": 15,
      "left": 18
    },
    "lunchbag": {
      "width": 320,
      "height": 317,
      "top": 70,
      "bottom": 51,
      "right": 32,
      "left": 37
    },
    "notebook": {
      "width": 211,
      "height": 260,
      "top": 8,
      "bottom": 35,
      "right": 53,
      "left": 42,
      "5x8": {
        "width": 211,
        "height": 260,
        "top": 23,
        "bottom": 55,
        "right": 53,
        "left": 42
      },
      "8x11": {
        "width": 201,
        "height": 270,
        "top": 9,
        "bottom": 43,
        "right": 34,
        "left": 24
      }
    },
    "framedprint": {
      "11x14_p": {
        "width": 360,
        "height": 360,
        "top": 6,
        "bottom": 13,
        "right": 46,
        "left": 36
      },
      "8x10_p": {
        "width": 221,
        "height": 257,
        "top": 5,
        "bottom": 38,
        "right": 21,
        "left": 19
      },
      "8x10_l": {
        "width": 317,
        "height": 257,
        "top": 7,
        "bottom": 39,
        "right": 30,
        "left": 32
      },
      "12x12": {
        "width": 278,
        "height": 268,
        "top": 6,
        "bottom": 40,
        "right": 27,
        "left": 28
      },
      "16x16": {
        "width": 278,
        "height": 268,
        "top": 5,
        "bottom": 40,
        "right": 26,
        "left": 27
      },
      "16x20_l": {
        "width": 326,
        "height": 265,
        "top": 7,
        "bottom": 39,
        "right": 31,
        "left": 35
      },
      "16x20_p": {
        "width": 232,
        "height": 265,
        "top": 7,
        "bottom": 39,
        "right": 22,
        "left": 26
      },
      "10x24_l": {
        "width": 514,
        "height": 268,
        "top": 6,
        "bottom": 39,
        "right": 51,
        "left": 51
      },
      "20x30_l": {
        "width": 397,
        "height": 265,
        "top": 7,
        "bottom": 38,
        "right": 38,
        "left": 41
      },
      "20x30_p": {
        "width": 190,
        "height": 265,
        "top": 6,
        "bottom": 39,
        "right": 19,
        "left": 19
      },
      "24x36_l": {
        "width": 363,
        "height": 265,
        "top": 9,
        "bottom": 38,
        "right": 36,
        "left": 38
      },
      "24x36_p": {
        "width": 211,
        "height": 256,
        "top": 5,
        "bottom": 29,
        "right": 20,
        "left": 23
      }
    },
    "placement": {
      "width": 391,
      "height": 300,
      "top": 47,
      "bottom": 43,
      "right": 32,
      "left": 40
    },
    "notepad": {
      "width": 183,
      "height": 266,
      "top": 19,
      "bottom": 36,
      "right": 19,
      "left": 12
    },
    "wineglass": {
      "width": 326,
      "height": 283,
      "top": 22,
      "bottom": 37,
      "right": 82,
      "left": 79
    },
    "pewteror": {
      "rect_l": {
        "width": 240,
        "height": 295,
        "top": 85,
        "bottom": 74,
        "right": 32,
        "left": 40
      }
    },
    "pet-tag": {
      "width": 284,
      "height": 290,
      "top": 33,
      "bottom": 76,
      "right": 9,
      "left": 12
    },
    "addresslabel": {
      "21_l": {
        "width": 514,
        "height": 271,
        "top": 15,
        "bottom": 40,
        "right": 39,
        "left": 44
      }
    },
    "ceramicTile": {
      "square": {
        "width": 195,
        "height": 267,
        "top": 20,
        "bottom": 10,
        "right": 20,
        "left": 20
      }
    },
    "pilsner": {
      "16": {
        "width": 200,
        "height": 305,
        "top": 9,
        "bottom": 65,
        "right": 55,
        "left": 61
      }
    },
    "decanter": {
      "43": {
        "width": 360,
        "height": 360,
        "top": 0,
        "bottom": 4,
        "right": 95,
        "left": 95
      }
    },
    "growler": {
      "width": 360,
      "height": 360,
      "top": 0,
      "bottom": 7,
      "right": 107,
      "left": 106
    },
    "paperweight": {
      "dome": {
        "width": 390,
        "height": 390,
        "top": 38,
        "bottom": 48,
        "right": 59,
        "left": 27
      },
      "square": {
        "width": 360,
        "height": 360,
        "top": 8,
        "bottom": 42,
        "right": 25,
        "left": 25
      },
      "heart": {
        "width": 360,
        "height": 360,
        "top": 15,
        "bottom": 19,
        "right": 14,
        "left": 6
      }
    },
    "glassjar": {
      "small": {
        "width": 360,
        "height": 360,
        "top": 0,
        "bottom": 0,
        "right": 59,
        "left": 59
      },
      "large": {
        "width": 360,
        "height": 360,
        "top": 0,
        "bottom": 0,
        "right": 60,
        "left": 59
      }
    },
    "santasack": {
      "medium": {
        "width": 293,
        "height": 293,
        "top": 3,
        "bottom": 7,
        "right": 5,
        "left": 0
      },
      "large": {
        "width": 218,
        "height": 300,
        "top": 3,
        "bottom": 4,
        "right": 54,
        "left": 55
      }
    },
    "trumpet": {
      "6": {
        "width": 360,
        "height": 360,
        "top": 0,
        "bottom": 6,
        "right": 95,
        "left": 95
      }
    },
    "mason": {
      "16": {
        "width": 326,
        "height": 283,
        "top": 22,
        "bottom": 36,
        "right": 55,
        "left": 55
      }
    },
    "postage": {
      "49": {
        "width": 360,
        "height": 255,
        "top": 0,
        "bottom": 0,
        "right": 0,
        "left": 0
      }
    },
    "stickers": {
      "2x2": {
        "width": 360,
        "height": 360,
        "top": 37,
        "bottom": 36,
        "right": 37,
        "left": 37
      }
    },
    "cavvaspouch": {
      "large": {
        "width": 360,
        "height": 360,
        "top": 30,
        "bottom": 36,
        "right": 7,
        "left": 5
      }
    },
    "wood_wallprint": {
      "8x10_p": {
        "width": 360,
        "height": 360,
        "top": 16,
        "bottom": 9,
        "right": 45,
        "left": 47
      },
      "8x10_l": {
        "width": 360,
        "height": 360,
        "top": 37,
        "bottom": 55,
        "right": 22,
        "left": 5
      }
    },
    "canvastotebag": {
      "bucket": {
        "width": 360,
        "height": 360,
        "top": 0,
        "bottom": 2,
        "right": 63,
        "left": 62
      },
      "large": {
        "width": 360,
        "height": 360,
        "top": 0,
        "bottom": 2,
        "right": 45,
        "left": 45
      }
    },
    "keychain": {
      "sq": {
        "width": 360,
        "height": 337,
        "top": 3,
        "bottom": 6,
        "right": 8,
        "left": 0
      },
      "rec": {
        "width": 250,
        "height": 445,
        "top": 3,
        "bottom": 4,
        "right": 5,
        "left": 3
      }
    },
    "glassplates": {
      "4x8_l": {
        "width": 360,
        "height": 162,
        "top": 2,
        "bottom": 2,
        "right": 2,
        "left": 2
      },
      "4x10_l": {
        "width": 360,
        "height": 158,
        "top": 3,
        "bottom": 9,
        "right": 4,
        "left": 3
      },
      "6x6": {
        "width": 360,
        "height": 360,
        "top": 16,
        "bottom": 17,
        "right": 17,
        "left": 16
      }
    },
    "cuttingboard": {
      "10x10": {
        "width": 360,
        "height": 360,
        "top": 12,
        "bottom": 13,
        "right": 12,
        "left": 13
      },
      "10x14": {
        "width": 360,
        "height": 287,
        "top": 34,
        "bottom": 39,
        "right": 32,
        "left": 26
      },
      "17x7": {
        "width": 210,
        "height": 360,
        "top": 7,
        "bottom": 23,
        "right": 41,
        "left": 35
      }
    },
    "gardenstone": {
      "6x4": {
        "width": 360,
        "height": 275,
        "top": 2,
        "bottom": 2,
        "right": 2,
        "left": 2
      },
      "11x18": {
        "width": 360,
        "height": 257,
        "top": 0,
        "bottom": 0,
        "right": 0,
        "left": 0
      },
      "9x9": {
        "width": 352,
        "height": 360,
        "top": 0,
        "bottom": 0,
        "right": 0,
        "left": 0
      }
    },
    "coasters": {
      "4x4": {
        "width": 321,
        "height": 271,
        "top": 44,
        "bottom": 49,
        "right": 71,
        "left": 57
      }
    },
    "pet-placement": {
      "12x17": {
        "width": 333,
        "height": 297,
        "top": 15,
        "bottom": 84,
        "right": 32,
        "left": 19
      }
    },
    "canvaspouch": {
      "large": {
        "width": 360,
        "height": 360,
        "top": 30,
        "bottom": 36,
        "right": 7,
        "left": 5
      }
    },
    "trivet": {
      "6x6": {
        "width": 360,
        "height": 360,
        "top": 7,
        "bottom": 14,
        "right": 16,
        "left": 5
      }
    },
    "folder": {
      "front": {
        "width": 360,
        "height": 360,
        "top": 53,
        "bottom": 54,
        "right": 12,
        "left": 12
      }
    },
    "name": {
      "plaque": {
        "width": 360,
        "height": 360,
        "top": 115,
        "bottom": 114,
        "right": 4,
        "left": 6
      }
    },
    "pencil": {
      "case": {
        "width": 360,
        "height": 360,
        "top": 59,
        "bottom": 154,
        "right": 11,
        "left": 11
      }
    },
    "towel": {
      "30x60_l": {
        "width": 360,
        "height": 360,
        "top": 91,
        "bottom": 95,
        "right": 7,
        "left": 7
      },
      "30x60_p": {
        "width": 360,
        "height": 360,
        "top": 6,
        "bottom": 6,
        "right": 94,
        "left": 92
      }
    },
    "hangingcanvas": {
      "11x14_p": {
        "width": 360,
        "height": 360,
        "top": 6,
        "bottom": 9,
        "right": 67,
        "left": 64
      },
      "11x14_l": {
        "width": 360,
        "height": 360,
        "top": 6,
        "bottom": 10,
        "right": 18,
        "left": 18
      },
      "16x20_l": {
        "width": 360,
        "height": 360,
        "top": 7,
        "bottom": 9,
        "right": 16,
        "left": 20
      },
      "16x20_p": {
        "width": 360,
        "height": 360,
        "top": 7,
        "bottom": 7,
        "right": 64,
        "left": 67
      }
    },
    "bottleopener": {
      "2x7_p": {
        "width": 360,
        "height": 360,
        "top": 5,
        "bottom": 6,
        "right": 147,
        "left": 134
      },
      "2x7_l": {
        "width": 360,
        "height": 360,
        "top": 141,
        "bottom": 141,
        "right": 7,
        "left": 8
      }
    },
    "night": {
      "light": {
        "width": 360,
        "height": 360,
        "top": 10,
        "bottom": 14,
        "right": 70,
        "left": 58
      }
    },
    "laptopcase": {
      "13": {
        "width": 360,
        "height": 360,
        "top": 51,
        "bottom": 59,
        "right": 24,
        "left": 12
      },
      "15": {
        "width": 360,
        "height": 360,
        "top": 54,
        "bottom": 56,
        "right": 21,
        "left": 11
      }
    },
    "can": {
      "cooler": {
        "width": 360,
        "height": 360,
        "top": 7,
        "bottom": 5,
        "right": 84,
        "left": 81
      }
    },
    "drawstring": {
      "backpack": {
        "width": 360,
        "height": 254,
        "top": 10,
        "bottom": 10,
        "right": 4,
        "left": 11
      }
    },
    "pot": {
      "holder": {
        "width": 360,
        "height": 346,
        "top": 5,
        "bottom": 6,
        "right":6,
        "left": 5
      }
    }
  },
  "layout": {
    "prints_4x6": {
      "prints_default": [
        {
          "x": 0,
          "y": 0,
          "w": 100,
          "h": 100,
          "r": 0,
          "sepLines": "0 0 0 0",
          "sFix": "0 0 0 0"
        }
      ]
    }
  },
  "design": {
    "prints_4x6": {
      "landscape": {
        "thumbWidth": "431",
        "thumbHeight": "315",
        "overlay_img": "",
        "multiply_mask": "",
        "opacity_mask": "https://d36611kofft9sk.cloudfront.net/prod/prints/assets/medium/layers/4x6/landscape/front/0/tOpacityMask.png",
        "canvases": [
          {
            "width": 346,
            "height": 260,
            "offset": {
              "x": 43,
              "y": 16
            }
          }
        ],
        "background_img": "https://d36611kofft9sk.cloudfront.net/prod/prints/assets/medium/layers/4x6/landscape/front/0/tBackground.png"
      },
      "portrait": {
        "thumbWidth": "431",
        "thumbHeight": "315",
        "overlay_img": "",
        "multiply_mask": "",
        "opacity_mask": "https://d36611kofft9sk.cloudfront.net/prod/prints/assets/medium/layers/4x6/portrait/front/0/tOpacityMask.png",
        "canvases": [
          {
            "width": 195,
            "height": 261,
            "offset": {
              "x": 117,
              "y": 17
            }
          }
        ],
        "background_img": "https://d36611kofft9sk.cloudfront.net/prod/prints/assets/medium/layers/4x6/portrait/front/0/tBackground.png"
      }
    }
  }
};});

/*
This module is used to load a specific widget instance.
 */
define("app/sdk_main", ['app/flow_manager', 'app/cache_module', 'app/settings', 'app/config_manager', 'app/product_proxy', 'app/model', 'json!app/json/recipeunited.min.json', 'app/tracking', 'app/utils', 'app/globals'], function(flow_manager, cache, settings, config, productProxy, Model, recipeJson, tracking, utils, globals) {

    var SMALL_MOBILE_THRESHOLD = globals.SMALL_MOBILE_THRESHOLD;
    var MOBILE_THRESHOLD       = globals.MOBILE_THRESHOLD;
    var isSmallMobile          = $(window).width() < SMALL_MOBILE_THRESHOLD;
    var isMobile               = $(window).width() < MOBILE_THRESHOLD;

    function listenToResize(containerElement) {
        isMobile               = $(window).width() < MOBILE_THRESHOLD;
        isSmallMobile          = $(window).width() < SMALL_MOBILE_THRESHOLD;

        //if ((isSmallMobile || utils.isMobile)) {
        //    if (cache.get('mode') == 'instance') {
        //        $(containerElement)
        //            .css('overflow-y', 'scroll')
        //            .css('-webkit-overflow-scrolling', 'touch')
        //            .css('width', '100%');
        //    }
        //
        //    $('html').addClass('sfly_wgt_mobile');
        //} else if (!(isSmallMobile || utils.isMobile) && cache.get('mode') == 'instance') {
        //    if (cache.get('mode') == 'instance') {
        //        $(containerElement)
        //            .css('overflow-y', 'hidden')
        //            .css('width', isMobile ? '600px' : '889px');
        //    }
        //
        //    $('html').removeClass('sfly_wgt_mobile');
        //}
        if (utils.isMobile) {
            if (cache.get('mode') == 'instance') {
                $(containerElement)
                    .css('overflow-y', 'scroll')
                    .css('-webkit-overflow-scrolling', 'touch')
                    .css('width', '100%');
            }

            $('html').addClass('sfly_wgt_mobile');
        } else {
            if (cache.get('mode') == 'instance') {
                $(containerElement)
                    .css('overflow-y', 'hidden')
                    .css('width', isMobile ? '600px' : '889px');
            }

            $('html').removeClass('sfly_wgt_mobile');
        }
    }

    function prepareInstanceMode(model, params) {
        if (params.partnerUserId != 'undefined' && params.partnerUserId != null) {
            cache.set('partner_user_id', params.partnerUserId);
            cache.set('partner_owner_id', params.partnerUserId);
        }

        if (params.partnerOwnerId != 'undefined' && params.partnerOwnerId != null) {
            cache.set('partner_owner_id', params.partnerOwnerId);
        }

        if (params.token != 'undefined' && params.token != null) {
            cache.set('token', params.token);
        }

        if (params.hasOwnProperty('gifting') && params.gifting) {
            cache.set('mode', 'gifting_father');
        } else {
            cache.set('mode', 'instance');
        }

        model.set('mode', cache.get('mode'));
        model.set('prod_type', params.prodtype);
        model.set('partnerId', cache.get('partner_id'));
        model.set('partnerUserId', cache.get('partner_user_id'));
        model.set('partnerOwnerId', cache.get('partner_owner_id'));
        model.set('container', params.containerElement);
        
        if (cache.get('mode') == 'instance' && typeof params.promoElement !== 'undefined') {
            model.set('promoElement', params.promoElement);
        }
        
        model.set('OperationMode', params.operationMode.toLowerCase());
        model.set('DisplayMode', params.displayMode.toLowerCase());
        model.set('Callback', params.callback);
        model.set('currentTab', -1);
        model.set('interceptSource', params.interceptSource.replace('%2f', '/'));
        model.set('isMigrated', params.isUserMigrated || false);
        model.set('timeline', (params.hasOwnProperty('timeline') && params.timeline) || false);
        model.set('productClass', (params.hasOwnProperty('timeline')) ? params.productClass : undefined);

        if (params.hasOwnProperty('modalContainer') && typeof params.modalContainer !== 'undefined' && params.modalContainer !== null) {
            model.set('modalContainer', params.modalContainer);
            var modalContainer = model.get('modalcontainer');
            var modalContainerPromoElement = $(modalContainer).find('.sfly_wgt_special_offers');
            model.set('modalContainerPromoElement', modalContainerPromoElement);
        }

        $(params.containerElement).css('overflow-y', 'hidden').css('position', 'relative');
        if(model.get('timeline') === false) {
            listenToResize(params.containerElement);
            $(window).on('resize.instance_sdkmain', _.debounce(listenToResize.bind(this, params.containerElement), 500));
        }
    }

    function prepareStandaloneMode(model) {

        var mg_crossSell = (typeof (window.MagicShop.cross_sell_recipeB) != 'undefined') &&  (window.location.href.indexOf('recommendations.sfly') != -1);

        $('body')
            .append('<iframe id="iframe_cns" name="iframe_cns" style="display: none; width:1px; height:1px;"></iframe>');

        model.set('partnerId', cache.get('partner_id'));
        model.set('partnerUserId', cache.get('partner_user_id'));
        model.set('interceptSource', 'web/' + cache.get('prod_type').replace('-','') + '/magicshop');

        // exceptions on the main rule
        if (cache.get('prod_type') === 'mysfly' && (cache.get('mode') === 'mode2' || cache.get('mode') === 'mode5')) {
            model.set('interceptSource', 'Web/magicshop');
        } else if (cache.get('mode') == 'mode2' && cache.get('prod_type') == 'homepage') {
            model.set('interceptSource', 'web/homepage_horizontal/magicshop');
        } else if (cache.get('mode') == 'cross_sell') {
            if(mg_crossSell) {
                model.set('interceptSource', 'web/cross_sell_mg/magicshop');
            } else {
                model.set('interceptSource', 'web/cross_sell/magicshop');
            }
        } else if (cache.get('mode') == 'store') {
            model.set('interceptSource', 'Store/magicshop');
        }

        // Check for Personalization group
        //var group =  typeof utils.parse_query_vars(window.location.href).group !== 'undefined' ? utils.parse_query_vars(window.location.href).group.toUpperCase(): ""; // get user group
        var group = window.location.href.indexOf('version1')!= -1 ? 'PRE01' : ""; // get user group
        if (group == 'PRE01')
        {
            //settings["interceptSource"] += "/PRE01";
            model.set('interceptSource', model.get('interceptSource') + '/PRE01');
        }
    }

    function updateEnv(params) {
        if (params.hasOwnProperty('env')) {
            cache.set('env', params.env);
        }
    }

    /* Pass params.isStandalone for a standalone widget */
    var Widget = function(params) {
        params = params || {};
        this.settings   = {};
        this.isReady    = new $.Deferred();
        this.model      = new Model();
        var that        = this;

        if (params.hasOwnProperty('isStandalone') && params.isStandalone) {
            prepareStandaloneMode(this.model);

            // This is used to present a single interface outside
            this.render = this.renderDirectly;
        } else {
            prepareInstanceMode(this.model, params);

            var parserOptions = {
                "timeline": this.model.get('timeline')
            };

            var recipeName      = config.getRecipeName(parserOptions, this.model);
            productProxy.getRecipe(recipeName, function (recipe) {
                var recipes = {};
                recipes[recipeName] = recipe;
                config.parseRecipes(recipes, parserOptions, that.model, function () {
                    config.parseRecipeJson(recipeJson, function () {
                        that.settings = $.extend(true, {}, settings);
                        that.isReady.resolve();
                    });
                });
            });
        }

        updateEnv(params);
    };

    Widget.prototype = {
        render: function(params) {
            var self = this;

            function startRender() {
                if (typeof params !== 'undefined' && params.hasOwnProperty('openInNewTab')) {
                    self.model.set('openInNewTab', params.openInNewTab);
                }

                if (typeof params !== 'undefined' && params.hasOwnProperty('clickthroughNoModal')) {
                    self.model.set('clickthroughNoModal', params.clickthroughNoModal);
                }
                flow_manager.render(self.model, params);
            }

            if(this.isReady.state() !== "resolved") {
                this.isReady.done(startRender);
            } else {
                startRender();
            }
        },
        renderDirectly: function() {
            flow_manager.render(this.model);
        },
        openFirst: function(){
            var that = this;
            var startTimeContainer = Date.now();
            var checkContainer = setInterval(function() {
                if(Date.now() - startTimeContainer <= 20*1000) {
                    if (typeof that.model.get('container') !== "undefined") {
                        clearInterval(checkContainer);
                        var startTime = Date.now();
                        var checkExist = setInterval(function() {
                            if(Date.now() - startTime <= 20*1000) {
                                if ($(that.model.get('container')).find('.sfly_wgt_product.order_1').length) {
                                    clearInterval(checkExist);
                                    $(that.model.get('container')).find('.sfly_wgt_product.order_1').click();
                                }
                            } else {
                                clearInterval(checkExist);
                            }
                        }, 100); // check every 100ms
                    }
                } else {
                    clearInterval(checkContainer);
                }
            }, 100); // check every 100ms
        },
        getType: function() {
            return this.model.get('prod_type');
        },
        setOpenInNewTab: function(shouldOpen) {
            this.model.set('openInNewTab', shouldOpen);
        },
        changeRecipe: function(newMode) {
            cache.set('mode', newMode);
            this.isReady = new $.Deferred();
            var self = this;

            productProxy.getRecipe(newMode, function (recipe) {
                var recipes = {};
                recipes[newMode] = recipe;
                config.parseRecipes(recipes, {}, self.model, function () {
                    config.parseRecipeJson(recipeJson, function () {
                        self.model.set('mode', newMode);
                        self.isReady.resolve();
                    });
                });
            });
        },
        track: function(type, target, params, waitLoad) {
            tracking.track(type, target, params, waitLoad)
        },

        applyModalMenuSelection: function(category, product) {
            var modalContainer = this.model.get('modalcontainer');
            var menuContainer = $(modalContainer).find('.magicshop_modal_menu_wrapper li.' + category + ' .modal_category_btn_sub_menu');
            if (product) {
                $(menuContainer).find('li[data-sku="' + product + '"]').trigger('click',{muteTracking: true});
            } else {
                $(menuContainer).find('li.sfly-wgt-left-pane-category-product:first').trigger('click',{muteTracking: true});
            }
        }
    };

    return Widget;
});

define("json!app/json/configjson.json", function(){ return {
  "products": [],
  "product_fallback": {
    "45": [
      {
        "sku": "1084334",
        "type": "plaque",
        "occasionId": 3,
        "styleId": 149,
        "sizeId": 45,
        "layoutId": "45_L_desktopplaq_5x7_sfly_global_unlocked-fullbleed_1_10"
      },
      {
        "sku": "1162121",
        "type": "plaque",
        "occasionId": 3,
        "styleId": 2253,
        "sizeId": 45,
        "layoutId": "45_P_5x7-desktopplaq_99_sfly_2253_printed-weathered-wood_brown_S1_a_1"
      },
      {
        "sku": "1121101",
        "type": "plaque",
        "occasionId": 3,
        "styleId": 1473,
        "sizeId": 45,
        "layoutId": "45_L_desktopplaq_5x7_global_unlocked_01_4L0P_border"
      }
    ],
    "47": [
      {
        "sku": "1076695",
        "type": "mug",
        "occasionId": 5,
        "styleId": 149,
        "sizeId": 47,
        "layoutId": "47_L_mug_11oz_white_classic_10"
      },
      {
        "sku": "1076695",
        "type": "mug",
        "occasionId": 5,
        "styleId": 149,
        "sizeId": 47,
        "layoutId": "47_L_mug_11oz_white_classic_10"
      },
      {
        "sku": "1173560",
        "type": "mug",
        "occasionId": 5,
        "styleId": 847,
        "sizeId": 47,
        "layoutId": "47_L_mug_11oz_white_classic_30"
      }
    ],
    "187": [
      {
        "sku": "1087841",
        "type": "shoppingbag",
        "occasionId": 45,
        "styleId": 508,
        "sizeId": 187,
        "layoutId": "187_S_shopping-bag_global_1L0P"
      }
    ],
    "185": [
      {
        "sku": "1087837",
        "type": "shoppingbag",
        "occasionId": 45,
        "styleId": 506,
        "sizeId": 185,
        "layoutId": "185_S_shopping-bag_global_1L0P"
      }
    ],
    "117": [
      {
        "sku": "1085285",
        "type": "magnet",
        "occasionId": 37,
        "styleId": 149,
        "sizeId": 117,
        "layoutId": "117_L_magnet_5x4_global_unlocked_fullbleed_multi_1_10"
      },
      {
        "sku": "1085279",
        "type": "magnet",
        "occasionId": 37,
        "styleId": 327,
        "sizeId": 117,
        "layoutId": "117_P_magnet4x5_99_sfly_1569_joy-love-family_bright-coral_S1_a_4"
      }
    ],
    "38": [
      {
        "sku": "1154356",
        "type": "canvas",
        "occasionId": 1,
        "styleId": 2172,
        "sizeId": 38,
        "layoutId": "38_P_canvasprint_24x36_global_00_0L1P_fullbleed_b"
      }
    ],
    "273": [
      {
        "sku": "1116126",
        "type": "framedprint",
        "occasionId": 68,
        "styleId": 149,
        "sizeId": 273,
        "layoutId": "273_P_11x14-framedprint_99_sfly_149_unlocked-photo-gallery_multi_S1_a_1"
      }
    ],
    "279": [
      {
        "sku": "1119740",
        "type": "framedprint",
        "occasionId": 68,
        "styleId": 393,
        "sizeId": 279,
        "layoutId": "279_L_10x24-framedprint_99_sfly_393_unlocked-gallery-panoramic_multi_S1_a_1"
      }
    ],
    "122": [
      {
        "sku": "1085328",
        "type": "pillow",
        "occasionId": 38,
        "styleId": 101,
        "sizeId": 122,
        "layoutId": "122_L_pillow_18x18_global_unlocked_fullbleed_multi_0_40"
      }
    ],
    "121": [
      {
        "sku": "1085361",
        "type": "pillow",
        "occasionId": 38,
        "styleId": 149,
        "sizeId": 121,
        "layoutId": "121_L_pillow_16x16_global_unlocked_fullbleed_multi_2_10"
      }
    ],
    "431": [
      {
        "sku": "1257815",
        "type": "coasters",
        "occasionId": 85,
        "styleId": 149,
        "sizeId": 431,
        "layoutId": "431_L_4x4-coaster_99_sfly_149_unlocked-photo-gallery_multi_S1_a_1"
      }
    ],
    "194": [
      {
        "sku": "1088653",
        "type": "puzzle",
        "occasionId": 52,
        "styleId": 312,
        "sizeId": 194,
        "layoutId": "194_L_252piece-puzzle_10x14_global_unlocked_fullbleed_S1_2_10"
      }
    ],
    "25": [
      {
        "sku": "1153774",
        "type": "notepad",
        "occasionId": 10,
        "styleId": 14198,
        "sizeId": 25,
        "layoutId": "25_P_5x7notepad_8_yt_14198_classic-color-block_navy_S1_a_1"
      }
    ],
    "442": [
      {
        "sku": "1173621",
        "type": "ceramicTile",
        "occasionId": 87,
        "styleId": 149,
        "sizeId": 442,
        "layoutId": "442_L_6x6-ceramic-tile_99_sfly_149_unlocked-photo-gallery_multi_S1_a_1"
      }
    ],
    "443": [
      {
        "sku": "1105839",
        "type": "flatglass",
        "occasionId": 60,
        "styleId": 149,
        "sizeId": 243,
        "layoutId": "243_L_5x7-flatglassprint_99_sfly_unlocked_multi_S1_a_1"
      }
    ]
  },
  "widget_positioning": {
    "vertical": 136,
    "vertical_small": 35,
    "horizontal": 0,
    "width": 180,
    "height": 520,
    "openwidth": 740,
    "side": "right"
  },
  "widget_modes": {
    "mode1": {
      "type": "floating",
      "orientation": "vertical",
      "modal": "min_modal"
    },
    "mode2": {
      "type": "embedded",
      "orientation": "horizontal",
      "modal": "full_modal"
    },
    "mode3": {
      "type": "replacement",
      "orientation": "",
      "modal": "full_modal"
    },
    "mode5": {
      "type": "embedded",
      "orientation": "horizontal_flex",
      "modal": "full_modal"
    },
    "instance": {
      "type": "embedded",
      "orientation": "tl_horizontal",
      "modal": "full_modal"
    },
    "cross_sell": {
      "type": "replacement",
      "orientation": "replacement",
      "modal": "full_modal"
    },
    "store": {
      "type": "replacement",
      "orientation": "replacement",
      "modal": "full_modal"
    },
    "gifting": {
      "type": "embedded",
      "orientation": "gifting",
      "modal": "full_modal"
    },
    "gifting_gm": {
      "type": "embedded",
      "orientation": "gifting_gm",
      "modal": "full_modal"
    },
    "gifting_father": {
      "type": "embedded",
      "orientation": "gifting_father",
      "modal": "full_modal"
    },
    "gifting_grandpa": {
      "type": "embedded",
      "orientation": "gifting_grandpa",
      "modal": "full_modal"
    },
    "gifting_christmas": {
      "type": "embedded",
      "orientation": "gifting_christmas",
      "modal": "full_modal"
    },
    "gifting_holiday": {
      "type": "embedded",
      "orientation": "gifting_holiday",
      "modal": "full_modal"
    },
    "gifting_hanukkah": {
      "type": "embedded",
      "orientation": "gifting_hanukkah",
      "modal": "full_modal"
    },
    "timeline": {
      "type": "embedded",
      "orientation": "tl_horizontal",
      "modal": "full_modal"
    }
  },
  "static_assets": {
    "5_149_47": {
      "sku": "1100681",
      "image": "https://d22bbwxztp2lry.cloudfront.net/productswidget/v.0.7/static_products/5_149_47.png",
      "link": "/creationpath/from/store/47/5/149?productCode=1076692&categoryCode=1084035&brand=SFLY&addOns=MUG_HANDLE_COLOR%3alight-blue_mug%2cMUG_FILLER%3anone&skuCode=1100681"
    },
    "37_327_117": {
      "sku": "1085279",
      "image": "https://d22bbwxztp2lry.cloudfront.net/productswidget/v.0.7/static_products/37_327_117.png",
      "link": "/creationpath/from/store/117/37/327?productCode=1085278&categoryCode=1084048&brand=SFLY&skuCode=1085279"
    },
    "55_796_212": {
      "sku": "1121511",
      "image": "https://d22bbwxztp2lry.cloudfront.net/productswidget/v.0.7/static_products/55_796_212.png",
      "link": "/creationpath/from/store/215/55/796?productCode=1104712&categoryCode=1084054&brand=SFLY&addOns=CASE_FINISH%3aMATTE&skuCode=1121511"
    },
    "7_274_50": {
      "sku": "1085472",
      "image": "https://d22bbwxztp2lry.cloudfront.net/productswidget/v.0.7/static_products/7_274_50.png",
      "link": "/creationpath/from/store/50/7/274?productCode=1085471&categoryCode=1091314&brand=SFLY&skuCode=1085472"
    },
    "15_728_93": {
      "sku": "1095366",
      "image": "https://d22bbwxztp2lry.cloudfront.net/productswidget/v.0.7/static_products/15_728_93.png",
      "link": "/creationpath/from/store/93/15/728?productCode=1095365&brand=SFLY&skuCode=1095366"
    },
    "18_149_74": {
      "sku": "1087030",
      "image": "https://d22bbwxztp2lry.cloudfront.net/productswidget/v.0.7/static_products/18_149_74.png",
      "link": "/creationpath/from/store/74/18/149?productCode=1087029&brand=SFLY&skuCode=1087030"
    },
    "1_498_36": {
      "sku": "1091212",
      "image": "https://d22bbwxztp2lry.cloudfront.net/productswidget/v.0.7/static_products/1_498_36.png",
      "link": "/creationpath/from/store/37/1/498?productCode=1091208&brand=SFLY&skuCode=1091212"
    },
    "38_409_121": {
      "sku": "1129851",
      "image": "https://d22bbwxztp2lry.cloudfront.net/productswidget/v.0.7/static_products/38_409_121.png",
      "link": "/creationpath/from/store/122/38/409?productCode=1085347&brand=SFLY&skuCode=1129851"
    },
    "58_386_227": {
      "sku": "1104183",
      "image": "https://d22bbwxztp2lry.cloudfront.net/productswidget/v.0.7/static_products/58_386_227.png",
      "link": "/creationpath/from/store/232/58/386?productCode=1104410&brand=SFLY&skuCode=1104183"
    },
    "34_7496_23": {
      "sku": "1086203",
      "image": "https://d22bbwxztp2lry.cloudfront.net/productswidget/v.0.7/static_products/34_7496_23.png",
      "link": "/creationpath/bundle/views/type/3/group/3?bundleId=3&productCode=1086202&brand=SFLY&skuCode=1086203&sizeIds=23&styleIds=7496&occasionIds=34"
    },
    "104_11638_27": {
      "sku": "1122839",
      "image": "https://d22bbwxztp2lry.cloudfront.net/productswidget/v.0.7/static_products/104_11638_27.png",
      "link": "/creationpath/bundle/views/type/3/group/3?bundleId=3&productCode=1122838&brand=SFLY&skuCode=1122839&sizeIds=27&styleIds=11638&occasionIds=104"
    },
    "34_5521_23": {
      "sku": "1051258",
      "image": "https://d22bbwxztp2lry.cloudfront.net/productswidget/v.0.7/static_products/34_5521_23.png",
      "link": "/creationpath/bundle/views/type/3/group/3?bundleId=3&productCode=1051211&brand=SFLY&skuCode=1051258&sizeIds=23&styleIds=5521&occasionIds=34"
    },
    "102_3373_27": {
      "sku": "561668",
      "image": "https://d22bbwxztp2lry.cloudfront.net/productswidget/v.0.7/static_products/102_3373_27.png",
      "link": "/creationpath/bundle/views/type/3/group/3?bundleId=3&productCode=561667&brand=SFLY&skuCode=561668&sizeIds=27&styleIds=3373&occasionIds=102"
    },
    "102_7666_27": {
      "sku": "1087393",
      "image": "https://d22bbwxztp2lry.cloudfront.net/productswidget/v.0.7/static_products/102_7666_27.png",
      "link": "https://www.shutterfly.com/creationpath/bundle/views/type/3/group/3?bundleId=3&productCode=1087392&brand=SFLY&skuCode=1087393&sizeIds=27&styleIds=7666&occasionIds=102"
    },
    "34_1857_23": {
      "sku": "478919",
      "image": "https://d22bbwxztp2lry.cloudfront.net/productswidget/v.0.7/static_products/34_1857_23.png",
      "link": "/creationpath/bundle/views/type/3/group/3?bundleId=3&productCode=478918&brand=SFLY&skuCode=478919&sizeIds=23&styleIds=1857&occasionIds=34"
    },
    "4_12821_23": {
      "sku": "1133088",
      "image": "https://d22bbwxztp2lry.cloudfront.net/productswidget/v.0.7/static_products/4_12821_23.png",
      "link": "/creationpath/bundle/views/type/3/group/3?bundleId=3&productCode=1133087&brand=SFLY&skuCode=1133088&sizeIds=23&styleIds=12821&occasionIds=4"
    },
    "102_1867_27": {
      "sku": "474609",
      "image": "https://d22bbwxztp2lry.cloudfront.net/productswidget/v.0.7/static_products/102_1867_27.png",
      "link": "/creationpath/bundle/views/type/3/group/3?bundleId=3&productCode=474608&brand=SFLY&skuCode=474609&sizeIds=27&styleIds=1867&occasionIds=102"
    }
  },
  "calendars_map": {
    "3_19521_33": {
      "style": "3_19521_33",
      "styleName": "Crafted Seasons",
      "static": "https://d22bbwxztp2lry.cloudfront.net/productswidget/Shutterfly/sidewidget/cal_styles/crafted_seasons.png"
    },
    "3_19519_33": {
      "style": "3_19519_33",
      "styleName": "Bold Seasons",
      "static": "https://d22bbwxztp2lry.cloudfront.net/productswidget/Shutterfly/sidewidget/cal_styles/bold_seasons.png"
    },
    "3_28_33": {
      "style": "3_28_33",
      "styleName": "Seasonal Stencils",
      "static": "https://d22bbwxztp2lry.cloudfront.net/productswidget/Shutterfly/sidewidget/cal_styles/seasonal_stencils.png"
    },
    "3_19520_33": {
      "style": "3_19520_33",
      "styleName": "Bold Type",
      "static": "https://d22bbwxztp2lry.cloudfront.net/productswidget/Shutterfly/sidewidget/cal_styles/bold_type.png"
    }
  }
};});

!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define('magicSDK',[],e):"object"==typeof exports?exports.MagicSDK=e():t.MagicSDK=e()}("undefined"!=typeof self?self:this,function(){return function(t){function e(o){if(r[o])return r[o].exports;var a=r[o]={i:o,l:!1,exports:{}};return t[o].call(a.exports,a,a.exports,e),a.l=!0,a.exports}var r={};return e.m=t,e.c=r,e.d=function(t,r,o){e.o(t,r)||Object.defineProperty(t,r,{configurable:!1,enumerable:!0,get:o})},e.n=function(t){var r=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(r,"a",r),r},e.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e.p="",e(e.s=86)}([function(t,e,r){"use strict";e.__esModule=!0,e.default=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}},function(t,e,r){"use strict";e.__esModule=!0;var o=r(123),a=function(t){return t&&t.__esModule?t:{default:t}}(o);e.default=function(){function t(t,e){for(var r=0;r<e.length;r++){var o=e[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),(0,a.default)(t,o.key,o)}}return function(e,r,o){return r&&t(e.prototype,r),o&&t(e,o),e}}()},function(t,e,r){"use strict";function o(t){return t&&t.__esModule?t:{default:t}}var a=r(129),n=o(a),i=r(0),s=o(i),h=r(1),u=o(h),c={'"PD"':'"PhotoID"','"Tp"':'"TimeStamp"','"Sp"':'"SubClusterTimeStamp"','"Sy1"':'"Similarity1"','"Sy2"':'"Similarity2"','"PPs"':'"PhotoParams"',DPct:"DominantPercent",PRix:"PersonRecIndex",'"OF"':'"ObjectsF"','"Sg"':'"Smiling"','"SCf"':'"SmilingConf"','"Fj"':'"FaceObj"','"Rt"':'"Rect"','"w"':'"width"','"h"':'"height"','"Fr"':'"FacesArr"','"Le"':'"LeftEye"','"Re"':'"RightEye"','"Pts"':'"Points"','"BR"':'"BackgroundRank"','"BF"':'"BokehFactor"','"CM"':'"CameraModel"','"Cl"':'"CameraModelndex"','"Ch"':'"Coherency"','"CC"':'"ColorContrastF"','"CS"':'"ColorSimilarity"','"CR"':'"Colors"',DmCl:"DominantCol",'"p"':'"percent"','"v"':'"value"',StrC:"StrongCol",'"CF"':'"ContrastF"','"DT"':'"DateTaken"','"DS"':'"DirectionSimilarity"','"DR"':'"DynRange"','"DF"':'"DynRangeF"','"EF"':'"ExposureF"','"FR"':'"FacesRank"','"Fl"':'"FinalRank"','"FC"':'"FullFramColorSim"','"GS"':'"GridColorSimilarity"','"HL"':'"HorizonLeft"','"IF"':'"IntBallanceF"','"Os"':'"Objects"','"OH"':'"OrigHeight"','"OW"':'"OrigWidth"','"PI"':'"PhotoIndex"','"Ps"':'"Position"','"SF"':'"SaturationF"','"Sy"':'"Sky"','"SL"':'"SplitLevel"','"Ss"':'"Status"','"SI"':'"SubClusterIndex"','"TS"':'"TextureScaleSimilarity"','"Ul"':'"Url"','"UI"':'"UserID"','"Vn"':'"Version"','"dN"':'"dateNew"','"pH"':'"pHash"','"Sn"':'"isSynthetic"','"CE"':'"ClosedEyesF"','"Cd"':'"Confidence"','"EC"':'"EngineCode"','"FF"':'"FocusF"','"Gr"':'"Gender"','"GC"':'"GenderConf"','"Ht"':'"Height"','"KF"':'"KissF"','"LC"':'"LEyeClosed"','"LX"':'"LEyeX"','"LY"':'"LEyeY"','"M1X"':'"MouthP1X"','"M1Y"':'"MouthP1Y"','"M2X"':'"MouthP2X"','"M2Y"':'"MouthP2Y"','"M3X"':'"MouthP3X"','"M3Y"':'"MouthP3Y"','"N1X"':'"NoseP1X"','"N1Y"':'"NoseP1Y"','"Ph"':'"Pitch"','"PF"':'"ProfileF"','"RC"':'"REyeClosed"','"RX"':'"REyeX"','"RY"':'"REyeY"','"Rk"':'"Rank"','"RI"':'"RecIndex"','"RN"':'"RecIndexNew"','"Rl"':'"Roll"','"Sf"':'"Significance"','"Sl"':'"Smile"','"Wh"':'"Width"','"Yw"':'"Yaw"','"fI"':'"faceId"','"iB"':'"isBaby"','"Adv"':'"AgeDeviation"'},l=r(6),f=function(){function t(){(0,s.default)(this,t)}return(0,u.default)(t,null,[{key:"checkSimilarity",value:function(t,e,r){var o=Math.abs(r.allParams.TimeStamp-e.allParams.TimeStamp),a=Math.abs(e.allParams.AverageFaceYaw-r.allParams.AverageFaceYaw);0!=e.allParams.AverageFaceYaw&&0!=r.allParams.AverageFaceYaw||(a=0);var n=r.allParams.Similarity1,i=r.allParams.Similarity2,s=r.allParams.DirectionSimilarity,h=r.allParams.TextureScaleSimilarity,u=!1;s<70&&h<80&&(u=!0);var c=!1,l=!1,f=!1;if(e.allParams.NumOfFaces==r.allParams.NumOfFaces&&1==e.allParams.NumOfFaces&&e.allParams.AverageFaceSize<.1&&r.allParams.AverageFaceSize<.1){for(var d=0;d<e.allParams.FacesArr.length&&!c;){var p=e.allParams.FacesArr[d];1==p.Significance&&(c=p.PersonRecIndex1),d++}for(d=0;d<r.allParams.FacesArr.length&&!l;){var g=r.allParams.FacesArr[d];1==g.Significance&&(l=g.PersonRecIndex1),d++}c&&c==l&&(f=!0)}var m=!1;Math.abs(e.allParams.NumOfFaces-r.allParams.NumOfFaces)>=2&&r.allParams.RecSimilarity&&r.allParams.RecSimilarity.Match<=1&&o>=30&&e.allParams.GroupFactor>0&&r.allParams.GroupFactor>0&&(m=!0);var v=!1,P=Math.max(e.allParams.NumOfFaces,r.allParams.NumOfFaces);switch(e.allParams.NumOfFaces>=3&&r.allParams.NumOfFaces>=3&&r.allParams.RecSimilarity&&r.allParams.RecSimilarity.Match>=P/4&&(e.allParams.NumOfFaces==r.allParams.NumOfFaces||e.allParams.NumOfFaces>=6&&Math.abs(e.allParams.NumOfFaces-r.allParams.NumOfFaces)<=1)&&i+s+n+h>380-4*P&&(v=!0),t){case"NoWeakSimilarity":if((o<=2||o<=4&&n>80||n>=87)&&a<40)return!0;break;case"NoStrongSimilarity":if((n>=97||i>=99&&s>=95&&n>=90||i>=90&&s>=90&&h>=90||i>=98&&n>=90&&s>=95||i>=99&&n>=90&&s>=90||s>=99||h>=80&&s>=97&&n>=80||0==o||o<=1&&(n>=85||s>=90)||f||v||i+s+n+h>368)&&a<45&&!m&&!u)return!0;break;case"SamePhoto":if(i+s+n+h>376||o<=1||v)return!0}}},{key:"sumGoodPhotos",value:function(t){var e=0,r=[];return t.forEach(function(o){o.allParams.indexInArray=t.indexOf(o),!o.allParams.Good&&!o.allParams.Best||o.isView()||(e++,r.push(o))}),r}},{key:"getBgLightLevel",value:function(t){var e=this,r=0,o=0,a=0,n=void 0,i=void 0,s=[1,2,3,4,5,6,7,8];return s.forEach(function(e){n="DominantPercent"+e,t[n]&&(a+=t[n])}),s.forEach(function(s){i="DominantCol"+s,n="DominantPercent"+s,t[n]&&t[i]&&(o+=t[n]/a*e._rgb2gray(e._html2rgb(t[i])),r+=t[n])}),o}},{key:"isNumeric",value:function(t){return Number(parseFloat(t))==t}},{key:"_html2rgb",value:function(t){var e=void 0,r=void 0,o=void 0;if(0===t.indexOf("#")&&(t=t.slice(1,t.length)),6==t.length)e=t.substring(0,2),r=t.substring(2,4),o=t.substring(4,6);else{if(3!=t.length)return!1;e=t.substring(0,1)+t.substring(0,1),r=t.substring(1,2)+t.substring(1,2),o=t.substring(2,3)+t.substring(2,3)}return e=this._hexdec(e),r=this._hexdec(r),o=this._hexdec(o),[e,r,o]}},{key:"_hexdec",value:function(t){return t=(t+"").replace(/[^a-f0-9]/gi,""),parseInt(t,16)}},{key:"_rgb2gray",value:function(t){return.21*t[0]+.71*t[1]+.07*t[2]}},{key:"edgesFix",value:function(t){t.x<0&&(t.width-=Math.abs(t.x),t.x=0),t.y<0&&(t.height-=Math.abs(t.y),t.y=0),t.x+t.width>1&&(t.width=1-t.x),t.y+t.height>1&&(t.height=1-t.y)}},{key:"round2",value:function(t){return Math.round(100*t)/100}},{key:"objectValues",value:function(t){var e=[];return Object.keys(t).forEach(function(r){e.push(t[r])}),e}},{key:"calcDist",value:function(t,e){return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2))}},{key:"getArrayLength",value:function(t){var e=0;return t.forEach(function(t){t&&e++}),e}},{key:"clone",value:function(e){var r=void 0;if(null==e||"object"!==(void 0===e?"undefined":(0,n.default)(e)))return e;if(e instanceof Date)return r=new Date,r.setTime(e.getTime()),r;if(e instanceof Array){r=[];for(var o=0,a=e.length;o<a;o++)r[o]=t.clone(e[o]);return r}if(e instanceof Object){r={};for(var i in e)e.hasOwnProperty(i)&&(r[i]=t.clone(e[i]));return r}throw new Error("Unable to copy obj! Its type isn't supported.")}},{key:"checkOrientation",value:function(t,e){var r=t.allParams.OrigWidth>t.allParams.OrigHeight?"landscape":"portrait";r=t.allParams.OrigWidth==t.allParams.OrigHeight?"square":r;var o=e.wPt*e.ew>e.hPt*e.eh?"landscape":"portrait";return o=e.wPt*e.ew==e.hPt*e.eh?"square":o,r==o||"square"==o||"square"==r}},{key:"debugPrint",value:function(t,e,r,o,a){-1!==a.indexOf(o)&&console.log("DEBUG MagicSDK "+t+": "+e+" ",this.clone(r))}},{key:"absDiff",value:function(t,e){return Math.abs(t-e)}},{key:"mapParams",value:function(t){return t=JSON.stringify(t),Object.keys(c).forEach(function(e){t=t.replace(new RegExp(e,"g"),c[e])}),JSON.parse(t)}},{key:"randomGroups",value:function(t,e){var r=Math.max(e,Math.round(.2*t.length)),o=t.splice(0,r);return o=l.shuffle(o),o.concat(t)}},{key:"pointsInInches",value:function(t){return.0138889*t}}]),t}();t.exports=f},function(t,e,r){var o=r(60)("wks"),a=r(36),n=r(5).Symbol,i="function"==typeof n;(t.exports=function(t){return o[t]||(o[t]=i&&n[t]||(i?n:a)("Symbol."+t))}).store=o},function(t,e,r){"use strict";function o(t){return t&&t.__esModule?t:{default:t}}var a=r(0),n=o(a),i=r(1),s=o(i),h=(r(2),function(){function t(){(0,n.default)(this,t)}return(0,s.default)(t,null,[{key:"bestFamilyPhoto",value:function(t){t.sort(function(t,e){if(t.isView())return 1;if(e.isView())return-1;if(t.allParams.NumOfFaces>1&&1==e.allParams.NumOfFaces)return-1;if(1==t.allParams.NumOfFaces&&e.allParams.NumOfFaces>1)return 1;var r=t.getRank(!0,!0,!1,!0,1,!1,1,!1,!0,!0);return e.getRank(!0,!0,!1,!0,1,!1,1,!1,!0,!0)-r})}},{key:"sortGroupRank",value:function(t){t.sort(function(t,e){return e.rank-t.rank})}},{key:"sortBestPortrait",value:function(t){t.sort(function(t,e){return t.isView(t)?1:e.isView()?-1:1==t.allParams.NumOfFaces&&e.allParams.NumOfFaces>1?-1:t.allParams.NumOfFaces>1&&1==e.allParams.NumOfFaces?1:t.getRank(!0,!0,!0,!0,2,!1,0,!1,!0,!1)>e.getRank(!0,!0,!0,!0,2,!1,0,!1,!0,!1)?-1:1})}},{key:"sortJsonByValue",value:function(t){var e=this._objEntries(t),r=e.sort(function(t,e){return e[1]-t[1]}),o=[];return t={},r.forEach(function(e){t[e[0]]=e[1],o.push(e[0])}),o}},{key:"sortArea",value:function(t){t.sort(function(t,e){return t.area>e.area?-1:1})}},{key:"sortBestAndRank",value:function(t){t.sort(function(t,e){return t.allParams.Best&&!e.allParams.Best?-1:e.allParams.Best&&!t.allParams.Best?1:t.allParams.Good&&!e.allParams.Good?-1:e.allParams.Good&&!t.allParams.Good?1:t.getRank(!0,!0,!0,!0,1,!1,1,!1,!0,!1)>e.getRank(!0,!0,!0,!0,1,!1,1,!1,!0,!1)?-1:1})}},{key:"sortPhotosOnlyRank",value:function(t){t.sort(function(t,e){return t.getRank(!0,!0,!0,!0,1,!1,1,!1,!0,!1)>e.getRank(!0,!0,!0,!0,1,!1,1,!1,!0,!1)?-1:1})}},{key:"sortJsonMatchingWellFromLowToHigh",value:function(t){var e=this._objEntries(t);return e.sort(function(t,e){return t[1].length==e[1].length?0:t[1].length>e[1].length?1:-1}),e}},{key:"sortJsonBigestArea",value:function(t){var e=this._objEntries(t);return e.sort(function(t,e){return t[1]<e[1]?1:-1}),e}},{key:"_objEntries",value:function(t){var e=[];return Object.keys(t).forEach(function(r){e.push([r,t[r]])}),e}},{key:"sortPhotosByDate",value:function(t){t.sort(function(t,e){return t.allParams.TimeStamp==e.allParams.TimeStamp?t.id<e.id?-1:1:t.allParams.TimeStamp<e.allParams.TimeStamp?-1:1})}},{key:"sortFacesByPos",value:function(t,e){t.sort(function(t,r){return t[e]==r[e]?0:t[e]<r[e]?-1:1})}},{key:"sortJsonOfArrayByCount",value:function(t){var e=this._objEntries(t);return e.sort(function(t,e){return t[1].length==e[1].length?0:t[1].length>e[1].length?-1:1}),e}},{key:"sortJsonNumOneApearencesInAlbum",value:function(t,e){var r=this._objEntries(t);return r.sort(function(t,r){return 0==t[0]?-1:0==r[0]?1:e[t[0]].length==e[r[0]].length?0:e[t[0]].length<e[r[0]].length?1:-1}),r}},{key:"sortPhotosByRank",value:function(t,e){var r=void 0;switch(e){case"RecognitionSubClusterNotAsGoodForBestGroups":r=[!0,!0,!1,!0,1,3,3,!1,!1,!1];break;case"RecognitionSubClusterNotAsGoodForBest":r=[!0,!0,!1,!0,1,3,!1,!1,!1,!1];break;case"SubClusterPortrait":r=[!0,!1,!0,!0,2,3,!1,!1,!1,!1];break;case"NotAsGoodForBest":r=[!0,!1,!1,!0,1,3,!1,!1,!1,!1];break;case"PortraitSubclusterNotAsGoodForBest":r=[!0,!1,!0,!0,1,3,!1,!1,!1,!1];break;case"RecognitionSubcluster":r=[!0,!0,!1,!0,1,!1,!1,!1,!1,!1];break;case"AddRecognitionAndPortrait":r=[!0,!0,!0,!1,1,!1,!1,!1,!1,!1];break;case"BestForPortrait":r=[!0,1.5,!0,!0,1,!1,!1,!1,!1,!1];break;case"3":r=[!0,!0,!1,!1,1,!1,!1,!1,!1,!1];break;default:r=[!1,!1,!1,!1,1,!1,!1,!1,!1,!1]}this._sortPhotoRank(t,r)}},{key:"_sortPhotoRank",value:function(t,e){t.sort(function(t,r){var o=t.getRank(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9]),a=r.getRank(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9]);return o==a?0:o>a?-1:1})}},{key:"sortBestForGroup",value:function(t){t.sort(function(t,e){if(t.allParams.NumOfFaces>1&&1==e.allParams.NumOfFaces)return-1;if(e.allParams.NumOfFaces>1&&1==t.allParams.NumOfFaces)return 1;var r=t.getRank(!0,!0,!1,!0,1,3,3,!1,!1,!1),o=e.getRank(!0,!0,!1,!0,1,3,3,!1,!1,!1);return r==o?0:r>o?-1:1})}},{key:"sortFitOptionsByRank",value:function(t){t.sort(function(t,e){return t.res.rank>=e.res.rank?-1:1})}},{key:"sortLayoutWellSize",value:function(t){t.sort(function(t,e){return t.Big&&!e.Big?-1:e.Big&&!t.Big?1:(t.area=t.area?t.area:t.w*t.h,e.area=e.area?e.area:e.w*e.h,t.area>e.area?-1:1)})}},{key:"sortLayoutsByRank",value:function(t){t.sort(function(t,e){return t.rank>=e.rank?-1:1})}},{key:"sortLayoutWellPercent",value:function(t){t.sort(function(t,e){var r=0;t.wells.forEach(function(e){"image"==e.type&&(r+=t.width*(e.width/100)*(e.height/100*t.height))});var o=0;return e.wells.forEach(function(t){"image"==t.type&&(o+=e.width*(t.width/100)*(t.height/100*e.height))}),r>=o?-1:1})}},{key:"sortWellsAccordingToPhotosIds",value:function(t){t.sort(function(t,e){return t.photoId>=e.photoId?-1:1})}}]),t}());t.exports=h},function(t,e){var r=t.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=r)},function(t,e,r){var o,a;(function(){function r(t){function e(e,r,o,a,n,i){for(;n>=0&&n<i;n+=t){var s=a?a[n]:n;o=r(o,e[s],s,e)}return o}return function(r,o,a,n){o=S(o,n,4);var i=!E(r)&&O.keys(r),s=(i||r).length,h=t>0?0:s-1;return arguments.length<3&&(a=r[i?i[h]:h],h+=t),e(r,o,a,i,h,s)}}function n(t){return function(e,r,o){r=w(r,o);for(var a=T(e),n=t>0?0:a-1;n>=0&&n<a;n+=t)if(r(e[n],n,e))return n;return-1}}function i(t,e,r){return function(o,a,n){var i=0,s=T(o);if("number"==typeof n)t>0?i=n>=0?n:Math.max(n+s,i):s=n>=0?Math.min(n+1,s):n+s+1;else if(r&&n&&s)return n=r(o,a),o[n]===a?n:-1;if(a!==a)return n=e(p.call(o,i,s),O.isNaN),n>=0?n+i:-1;for(n=t>0?i:s-1;n>=0&&n<s;n+=t)if(o[n]===a)return n;return-1}}function s(t,e){var r=A.length,o=t.constructor,a=O.isFunction(o)&&o.prototype||l,n="constructor";for(O.has(t,n)&&!O.contains(e,n)&&e.push(n);r--;)(n=A[r])in t&&t[n]!==a[n]&&!O.contains(e,n)&&e.push(n)}var h=this,u=h._,c=Array.prototype,l=Object.prototype,f=Function.prototype,d=c.push,p=c.slice,g=l.toString,m=l.hasOwnProperty,v=Array.isArray,P=Object.keys,y=f.bind,k=Object.create,b=function(){},O=function(t){return t instanceof O?t:this instanceof O?void(this._wrapped=t):new O(t)};void 0!==t&&t.exports&&(e=t.exports=O),e._=O,O.VERSION="1.8.3";var S=function(t,e,r){if(void 0===e)return t;switch(null==r?3:r){case 1:return function(r){return t.call(e,r)};case 2:return function(r,o){return t.call(e,r,o)};case 3:return function(r,o,a){return t.call(e,r,o,a)};case 4:return function(r,o,a,n){return t.call(e,r,o,a,n)}}return function(){return t.apply(e,arguments)}},w=function(t,e,r){return null==t?O.identity:O.isFunction(t)?S(t,e,r):O.isObject(t)?O.matcher(t):O.property(t)};O.iteratee=function(t,e){return w(t,e,1/0)};var F=function(t,e){return function(r){var o=arguments.length;if(o<2||null==r)return r;for(var a=1;a<o;a++)for(var n=arguments[a],i=t(n),s=i.length,h=0;h<s;h++){var u=i[h];e&&void 0!==r[u]||(r[u]=n[u])}return r}},x=function(t){if(!O.isObject(t))return{};if(k)return k(t);b.prototype=t;var e=new b;return b.prototype=null,e},_=function(t){return function(e){return null==e?void 0:e[t]}},R=Math.pow(2,53)-1,T=_("length"),E=function(t){var e=T(t);return"number"==typeof e&&e>=0&&e<=R};O.each=O.forEach=function(t,e,r){e=S(e,r);var o,a;if(E(t))for(o=0,a=t.length;o<a;o++)e(t[o],o,t);else{var n=O.keys(t);for(o=0,a=n.length;o<a;o++)e(t[n[o]],n[o],t)}return t},O.map=O.collect=function(t,e,r){e=w(e,r);for(var o=!E(t)&&O.keys(t),a=(o||t).length,n=Array(a),i=0;i<a;i++){var s=o?o[i]:i;n[i]=e(t[s],s,t)}return n},O.reduce=O.foldl=O.inject=r(1),O.reduceRight=O.foldr=r(-1),O.find=O.detect=function(t,e,r){var o;if(void 0!==(o=E(t)?O.findIndex(t,e,r):O.findKey(t,e,r))&&-1!==o)return t[o]},O.filter=O.select=function(t,e,r){var o=[];return e=w(e,r),O.each(t,function(t,r,a){e(t,r,a)&&o.push(t)}),o},O.reject=function(t,e,r){return O.filter(t,O.negate(w(e)),r)},O.every=O.all=function(t,e,r){e=w(e,r);for(var o=!E(t)&&O.keys(t),a=(o||t).length,n=0;n<a;n++){var i=o?o[n]:n;if(!e(t[i],i,t))return!1}return!0},O.some=O.any=function(t,e,r){e=w(e,r);for(var o=!E(t)&&O.keys(t),a=(o||t).length,n=0;n<a;n++){var i=o?o[n]:n;if(e(t[i],i,t))return!0}return!1},O.contains=O.includes=O.include=function(t,e,r,o){return E(t)||(t=O.values(t)),("number"!=typeof r||o)&&(r=0),O.indexOf(t,e,r)>=0},O.invoke=function(t,e){var r=p.call(arguments,2),o=O.isFunction(e);return O.map(t,function(t){var a=o?e:t[e];return null==a?a:a.apply(t,r)})},O.pluck=function(t,e){return O.map(t,O.property(e))},O.where=function(t,e){return O.filter(t,O.matcher(e))},O.findWhere=function(t,e){return O.find(t,O.matcher(e))},O.max=function(t,e,r){var o,a,n=-1/0,i=-1/0;if(null==e&&null!=t){t=E(t)?t:O.values(t);for(var s=0,h=t.length;s<h;s++)(o=t[s])>n&&(n=o)}else e=w(e,r),O.each(t,function(t,r,o){((a=e(t,r,o))>i||a===-1/0&&n===-1/0)&&(n=t,i=a)});return n},O.min=function(t,e,r){var o,a,n=1/0,i=1/0;if(null==e&&null!=t){t=E(t)?t:O.values(t);for(var s=0,h=t.length;s<h;s++)(o=t[s])<n&&(n=o)}else e=w(e,r),O.each(t,function(t,r,o){((a=e(t,r,o))<i||a===1/0&&n===1/0)&&(n=t,i=a)});return n},O.shuffle=function(t){for(var e,r=E(t)?t:O.values(t),o=r.length,a=Array(o),n=0;n<o;n++)e=O.random(0,n),e!==n&&(a[n]=a[e]),a[e]=r[n];return a},O.sample=function(t,e,r){return null==e||r?(E(t)||(t=O.values(t)),t[O.random(t.length-1)]):O.shuffle(t).slice(0,Math.max(0,e))},O.sortBy=function(t,e,r){return e=w(e,r),O.pluck(O.map(t,function(t,r,o){return{value:t,index:r,criteria:e(t,r,o)}}).sort(function(t,e){var r=t.criteria,o=e.criteria;if(r!==o){if(r>o||void 0===r)return 1;if(r<o||void 0===o)return-1}return t.index-e.index}),"value")};var M=function(t){return function(e,r,o){var a={};return r=w(r,o),O.each(e,function(o,n){var i=r(o,n,e);t(a,o,i)}),a}};O.groupBy=M(function(t,e,r){O.has(t,r)?t[r].push(e):t[r]=[e]}),O.indexBy=M(function(t,e,r){t[r]=e}),O.countBy=M(function(t,e,r){O.has(t,r)?t[r]++:t[r]=1}),O.toArray=function(t){return t?O.isArray(t)?p.call(t):E(t)?O.map(t,O.identity):O.values(t):[]},O.size=function(t){return null==t?0:E(t)?t.length:O.keys(t).length},O.partition=function(t,e,r){e=w(e,r);var o=[],a=[];return O.each(t,function(t,r,n){(e(t,r,n)?o:a).push(t)}),[o,a]},O.first=O.head=O.take=function(t,e,r){if(null!=t)return null==e||r?t[0]:O.initial(t,t.length-e)},O.initial=function(t,e,r){return p.call(t,0,Math.max(0,t.length-(null==e||r?1:e)))},O.last=function(t,e,r){if(null!=t)return null==e||r?t[t.length-1]:O.rest(t,Math.max(0,t.length-e))},O.rest=O.tail=O.drop=function(t,e,r){return p.call(t,null==e||r?1:e)},O.compact=function(t){return O.filter(t,O.identity)};var j=function(t,e,r,o){for(var a=[],n=0,i=o||0,s=T(t);i<s;i++){var h=t[i];if(E(h)&&(O.isArray(h)||O.isArguments(h))){e||(h=j(h,e,r));var u=0,c=h.length;for(a.length+=c;u<c;)a[n++]=h[u++]}else r||(a[n++]=h)}return a};O.flatten=function(t,e){return j(t,e,!1)},O.without=function(t){return O.difference(t,p.call(arguments,1))},O.uniq=O.unique=function(t,e,r,o){O.isBoolean(e)||(o=r,r=e,e=!1),null!=r&&(r=w(r,o));for(var a=[],n=[],i=0,s=T(t);i<s;i++){var h=t[i],u=r?r(h,i,t):h;e?(i&&n===u||a.push(h),n=u):r?O.contains(n,u)||(n.push(u),a.push(h)):O.contains(a,h)||a.push(h)}return a},O.union=function(){return O.uniq(j(arguments,!0,!0))},O.intersection=function(t){for(var e=[],r=arguments.length,o=0,a=T(t);o<a;o++){var n=t[o];if(!O.contains(e,n)){for(var i=1;i<r&&O.contains(arguments[i],n);i++);i===r&&e.push(n)}}return e},O.difference=function(t){var e=j(arguments,!0,!0,1);return O.filter(t,function(t){return!O.contains(e,t)})},O.zip=function(){return O.unzip(arguments)},O.unzip=function(t){for(var e=t&&O.max(t,T).length||0,r=Array(e),o=0;o<e;o++)r[o]=O.pluck(t,o);return r},O.object=function(t,e){for(var r={},o=0,a=T(t);o<a;o++)e?r[t[o]]=e[o]:r[t[o][0]]=t[o][1];return r},O.findIndex=n(1),O.findLastIndex=n(-1),O.sortedIndex=function(t,e,r,o){r=w(r,o,1);for(var a=r(e),n=0,i=T(t);n<i;){var s=Math.floor((n+i)/2);r(t[s])<a?n=s+1:i=s}return n},O.indexOf=i(1,O.findIndex,O.sortedIndex),O.lastIndexOf=i(-1,O.findLastIndex),O.range=function(t,e,r){null==e&&(e=t||0,t=0),r=r||1;for(var o=Math.max(Math.ceil((e-t)/r),0),a=Array(o),n=0;n<o;n++,t+=r)a[n]=t;return a};var I=function(t,e,r,o,a){if(!(o instanceof e))return t.apply(r,a);var n=x(t.prototype),i=t.apply(n,a);return O.isObject(i)?i:n};O.bind=function(t,e){if(y&&t.bind===y)return y.apply(t,p.call(arguments,1));if(!O.isFunction(t))throw new TypeError("Bind must be called on a function");var r=p.call(arguments,2),o=function(){return I(t,o,e,this,r.concat(p.call(arguments)))};return o},O.partial=function(t){var e=p.call(arguments,1),r=function(){for(var o=0,a=e.length,n=Array(a),i=0;i<a;i++)n[i]=e[i]===O?arguments[o++]:e[i];for(;o<arguments.length;)n.push(arguments[o++]);return I(t,r,this,this,n)};return r},O.bindAll=function(t){var e,r,o=arguments.length;if(o<=1)throw new Error("bindAll must be passed function names");for(e=1;e<o;e++)r=arguments[e],t[r]=O.bind(t[r],t);return t},O.memoize=function(t,e){var r=function(o){var a=r.cache,n=""+(e?e.apply(this,arguments):o);return O.has(a,n)||(a[n]=t.apply(this,arguments)),a[n]};return r.cache={},r},O.delay=function(t,e){var r=p.call(arguments,2);return setTimeout(function(){return t.apply(null,r)},e)},O.defer=O.partial(O.delay,O,1),O.throttle=function(t,e,r){var o,a,n,i=null,s=0;r||(r={});var h=function(){s=!1===r.leading?0:O.now(),i=null,n=t.apply(o,a),i||(o=a=null)};return function(){var u=O.now();s||!1!==r.leading||(s=u);var c=e-(u-s);return o=this,a=arguments,c<=0||c>e?(i&&(clearTimeout(i),i=null),s=u,n=t.apply(o,a),i||(o=a=null)):i||!1===r.trailing||(i=setTimeout(h,c)),n}},O.debounce=function(t,e,r){var o,a,n,i,s,h=function(){var u=O.now()-i;u<e&&u>=0?o=setTimeout(h,e-u):(o=null,r||(s=t.apply(n,a),o||(n=a=null)))};return function(){n=this,a=arguments,i=O.now();var u=r&&!o;return o||(o=setTimeout(h,e)),u&&(s=t.apply(n,a),n=a=null),s}},O.wrap=function(t,e){return O.partial(e,t)},O.negate=function(t){return function(){return!t.apply(this,arguments)}},O.compose=function(){var t=arguments,e=t.length-1;return function(){for(var r=e,o=t[e].apply(this,arguments);r--;)o=t[r].call(this,o);return o}},O.after=function(t,e){return function(){if(--t<1)return e.apply(this,arguments)}},O.before=function(t,e){var r;return function(){return--t>0&&(r=e.apply(this,arguments)),t<=1&&(e=null),r}},O.once=O.partial(O.before,2);var C=!{toString:null}.propertyIsEnumerable("toString"),A=["valueOf","isPrototypeOf","toString","propertyIsEnumerable","hasOwnProperty","toLocaleString"];O.keys=function(t){if(!O.isObject(t))return[];if(P)return P(t);var e=[];for(var r in t)O.has(t,r)&&e.push(r);return C&&s(t,e),e},O.allKeys=function(t){if(!O.isObject(t))return[];var e=[];for(var r in t)e.push(r);return C&&s(t,e),e},O.values=function(t){for(var e=O.keys(t),r=e.length,o=Array(r),a=0;a<r;a++)o[a]=t[e[a]];return o},O.mapObject=function(t,e,r){e=w(e,r);for(var o,a=O.keys(t),n=a.length,i={},s=0;s<n;s++)o=a[s],i[o]=e(t[o],o,t);return i},O.pairs=function(t){for(var e=O.keys(t),r=e.length,o=Array(r),a=0;a<r;a++)o[a]=[e[a],t[e[a]]];return o},O.invert=function(t){for(var e={},r=O.keys(t),o=0,a=r.length;o<a;o++)e[t[r[o]]]=r[o];return e},O.functions=O.methods=function(t){var e=[];for(var r in t)O.isFunction(t[r])&&e.push(r);return e.sort()},O.extend=F(O.allKeys),O.extendOwn=O.assign=F(O.keys),O.findKey=function(t,e,r){e=w(e,r);for(var o,a=O.keys(t),n=0,i=a.length;n<i;n++)if(o=a[n],e(t[o],o,t))return o},O.pick=function(t,e,r){var o,a,n={},i=t;if(null==i)return n;O.isFunction(e)?(a=O.allKeys(i),o=S(e,r)):(a=j(arguments,!1,!1,1),o=function(t,e,r){return e in r},i=Object(i));for(var s=0,h=a.length;s<h;s++){var u=a[s],c=i[u];o(c,u,i)&&(n[u]=c)}return n},O.omit=function(t,e,r){if(O.isFunction(e))e=O.negate(e);else{var o=O.map(j(arguments,!1,!1,1),String);e=function(t,e){return!O.contains(o,e)}}return O.pick(t,e,r)},O.defaults=F(O.allKeys,!0),O.create=function(t,e){var r=x(t);return e&&O.extendOwn(r,e),r},O.clone=function(t){return O.isObject(t)?O.isArray(t)?t.slice():O.extend({},t):t},O.tap=function(t,e){return e(t),t},O.isMatch=function(t,e){var r=O.keys(e),o=r.length;if(null==t)return!o;for(var a=Object(t),n=0;n<o;n++){var i=r[n];if(e[i]!==a[i]||!(i in a))return!1}return!0};var N=function(t,e,r,o){if(t===e)return 0!==t||1/t==1/e;if(null==t||null==e)return t===e;t instanceof O&&(t=t._wrapped),e instanceof O&&(e=e._wrapped);var a=g.call(t);if(a!==g.call(e))return!1;switch(a){case"[object RegExp]":case"[object String]":return""+t==""+e;case"[object Number]":return+t!=+t?+e!=+e:0==+t?1/+t==1/e:+t==+e;case"[object Date]":case"[object Boolean]":return+t==+e}var n="[object Array]"===a;if(!n){if("object"!=typeof t||"object"!=typeof e)return!1;var i=t.constructor,s=e.constructor;if(i!==s&&!(O.isFunction(i)&&i instanceof i&&O.isFunction(s)&&s instanceof s)&&"constructor"in t&&"constructor"in e)return!1}r=r||[],o=o||[];for(var h=r.length;h--;)if(r[h]===t)return o[h]===e;if(r.push(t),o.push(e),n){if((h=t.length)!==e.length)return!1;for(;h--;)if(!N(t[h],e[h],r,o))return!1}else{var u,c=O.keys(t);if(h=c.length,O.keys(e).length!==h)return!1;for(;h--;)if(u=c[h],!O.has(e,u)||!N(t[u],e[u],r,o))return!1}return r.pop(),o.pop(),!0};O.isEqual=function(t,e){return N(t,e)},O.isEmpty=function(t){return null==t||(E(t)&&(O.isArray(t)||O.isString(t)||O.isArguments(t))?0===t.length:0===O.keys(t).length)},O.isElement=function(t){return!(!t||1!==t.nodeType)},O.isArray=v||function(t){return"[object Array]"===g.call(t)},O.isObject=function(t){var e=typeof t;return"function"===e||"object"===e&&!!t},O.each(["Arguments","Function","String","Number","Date","RegExp","Error"],function(t){O["is"+t]=function(e){return g.call(e)==="[object "+t+"]"}}),O.isArguments(arguments)||(O.isArguments=function(t){return O.has(t,"callee")}),"function"!=typeof/./&&"object"!=typeof Int8Array&&(O.isFunction=function(t){return"function"==typeof t||!1}),O.isFinite=function(t){return isFinite(t)&&!isNaN(parseFloat(t))},O.isNaN=function(t){return O.isNumber(t)&&t!==+t},O.isBoolean=function(t){return!0===t||!1===t||"[object Boolean]"===g.call(t)},O.isNull=function(t){return null===t},O.isUndefined=function(t){return void 0===t},O.has=function(t,e){return null!=t&&m.call(t,e)},O.noConflict=function(){return h._=u,this},O.identity=function(t){return t},O.constant=function(t){return function(){return t}},O.noop=function(){},O.property=_,O.propertyOf=function(t){return null==t?function(){}:function(e){return t[e]}},O.matcher=O.matches=function(t){return t=O.extendOwn({},t),function(e){return O.isMatch(e,t)}},O.times=function(t,e,r){var o=Array(Math.max(0,t));e=S(e,r,1);for(var a=0;a<t;a++)o[a]=e(a);return o},O.random=function(t,e){return null==e&&(e=t,t=0),t+Math.floor(Math.random()*(e-t+1))},O.now=Date.now||function(){return(new Date).getTime()};var D={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"},G=O.invert(D),L=function(t){var e=function(e){return t[e]},r="(?:"+O.keys(t).join("|")+")",o=RegExp(r),a=RegExp(r,"g");return function(t){return t=null==t?"":""+t,o.test(t)?t.replace(a,e):t}};O.escape=L(D),O.unescape=L(G),O.result=function(t,e,r){var o=null==t?void 0:t[e];return void 0===o&&(o=r),O.isFunction(o)?o.call(t):o};var B=0;O.uniqueId=function(t){var e=++B+"";return t?t+e:e},O.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var W=/(.)^/,V={"'":"'","\\":"\\","\r":"r","\n":"n","\u2028":"u2028","\u2029":"u2029"},U=/\\|'|\r|\n|\u2028|\u2029/g,H=function(t){return"\\"+V[t]};O.template=function(t,e,r){!e&&r&&(e=r),e=O.defaults({},e,O.templateSettings);var o=RegExp([(e.escape||W).source,(e.interpolate||W).source,(e.evaluate||W).source].join("|")+"|$","g"),a=0,n="__p+='";t.replace(o,function(e,r,o,i,s){return n+=t.slice(a,s).replace(U,H),a=s+e.length,r?n+="'+\n((__t=("+r+"))==null?'':_.escape(__t))+\n'":o?n+="'+\n((__t=("+o+"))==null?'':__t)+\n'":i&&(n+="';\n"+i+"\n__p+='"),e}),n+="';\n",e.variable||(n="with(obj||{}){\n"+n+"}\n"),n="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+n+"return __p;\n";try{var i=new Function(e.variable||"obj","_",n)}catch(t){throw t.source=n,t}var s=function(t){return i.call(this,t,O)};return s.source="function("+(e.variable||"obj")+"){\n"+n+"}",s},O.chain=function(t){var e=O(t);return e._chain=!0,e};var z=function(t,e){return t._chain?O(e).chain():e};O.mixin=function(t){O.each(O.functions(t),function(e){var r=O[e]=t[e];O.prototype[e]=function(){var t=[this._wrapped];return d.apply(t,arguments),z(this,r.apply(O,t))}})},O.mixin(O),O.each(["pop","push","reverse","shift","sort","splice","unshift"],function(t){var e=c[t];O.prototype[t]=function(){var r=this._wrapped;return e.apply(r,arguments),"shift"!==t&&"splice"!==t||0!==r.length||delete r[0],z(this,r)}}),O.each(["concat","join","slice"],function(t){var e=c[t];O.prototype[t]=function(){return z(this,e.apply(this._wrapped,arguments))}}),O.prototype.value=function(){return this._wrapped},O.prototype.valueOf=O.prototype.toJSON=O.prototype.value,O.prototype.toString=function(){return""+this._wrapped},o=[],void 0!==(a=function(){return O}.apply(e,o))&&(t.exports=a)}).call(this)},function(t,e){var r=t.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=r)},function(t,e,r){var o=r(18);t.exports=function(t){if(!o(t))throw TypeError(t+" is not an object!");return t}},function(t,e,r){var o=r(28),a=r(73),n=r(46),i=Object.defineProperty;e.f=r(10)?Object.defineProperty:function(t,e,r){if(o(t),e=n(e,!0),o(r),a)try{return i(t,e,r)}catch(t){}if("get"in r||"set"in r)throw TypeError("Accessors not supported!");return"value"in r&&(t[e]=r.value),t}},function(t,e,r){t.exports=!r(30)(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},function(t,e){var r={}.hasOwnProperty;t.exports=function(t,e){return r.call(t,e)}},function(t,e,r){var o=r(23),a=r(62);t.exports=r(19)?function(t,e,r){return o.f(t,e,a(1,r))}:function(t,e,r){return t[e]=r,t}},function(t,e){var r=t.exports={version:"2.5.1"};"number"==typeof __e&&(__e=r)},function(t,e,r){var o=r(9),a=r(31);t.exports=r(10)?function(t,e,r){return o.f(t,e,a(1,r))}:function(t,e,r){return t[e]=r,t}},function(t,e,r){var o=r(136),a=r(48);t.exports=function(t){return o(a(t))}},function(t,e,r){var o=r(53)("wks"),a=r(32),n=r(7).Symbol,i="function"==typeof n;(t.exports=function(t){return o[t]||(o[t]=i&&n[t]||(i?n:a)("Symbol."+t))}).store=o},function(t,e,r){var o=r(5),a=r(12),n=r(20),i=r(36)("src"),s=Function.toString,h=(""+s).split("toString");r(13).inspectSource=function(t){return s.call(t)},(t.exports=function(t,e,r,s){var u="function"==typeof r;u&&(n(r,"name")||a(r,"name",e)),t[e]!==r&&(u&&(n(r,i)||a(r,i,t[e]?""+t[e]:h.join(String(e)))),t===o?t[e]=r:s?t[e]?t[e]=r:a(t,e,r):(delete t[e],a(t,e,r)))})(Function.prototype,"toString",function(){return"function"==typeof this&&this[i]||s.call(this)})},function(t,e){t.exports=function(t){return"object"==typeof t?null!==t:"function"==typeof t}},function(t,e,r){t.exports=!r(61)(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},function(t,e){var r={}.hasOwnProperty;t.exports=function(t,e){return r.call(t,e)}},function(t,e){t.exports={}},function(t,e){var r={}.toString;t.exports=function(t){return r.call(t).slice(8,-1)}},function(t,e,r){var o=r(8),a=r(89),n=r(90),i=Object.defineProperty;e.f=r(19)?Object.defineProperty:function(t,e,r){if(o(t),e=n(e,!0),o(r),a)try{return i(t,e,r)}catch(t){}if("get"in r||"set"in r)throw TypeError("Accessors not supported!");return"value"in r&&(t[e]=r.value),t}},function(t,e,r){var o=r(5),a=r(13),n=r(12),i=r(17),s=r(25),h=function(t,e,r){var u,c,l,f,d=t&h.F,p=t&h.G,g=t&h.S,m=t&h.P,v=t&h.B,P=p?o:g?o[e]||(o[e]={}):(o[e]||{}).prototype,y=p?a:a[e]||(a[e]={}),k=y.prototype||(y.prototype={});p&&(r=e);for(u in r)c=!d&&P&&void 0!==P[u],l=(c?P:r)[u],f=v&&c?s(l,o):m&&"function"==typeof l?s(Function.call,l):l,P&&i(P,u,l,t&h.U),y[u]!=l&&n(y,u,f),m&&k[u]!=l&&(k[u]=l)};o.core=a,h.F=1,h.G=2,h.S=4,h.P=8,h.B=16,h.W=32,h.U=64,h.R=128,t.exports=h},function(t,e,r){var o=r(26);t.exports=function(t,e,r){if(o(t),void 0===e)return t;switch(r){case 1:return function(r){return t.call(e,r)};case 2:return function(r,o){return t.call(e,r,o)};case 3:return function(r,o,a){return t.call(e,r,o,a)}}return function(){return t.apply(e,arguments)}}},function(t,e){t.exports=function(t){if("function"!=typeof t)throw TypeError(t+" is not a function!");return t}},function(t,e){var r=t.exports={version:"2.5.1"};"number"==typeof __e&&(__e=r)},function(t,e,r){var o=r(29);t.exports=function(t){if(!o(t))throw TypeError(t+" is not an object!");return t}},function(t,e){t.exports=function(t){return"object"==typeof t?null!==t:"function"==typeof t}},function(t,e){t.exports=function(t){try{return!!t()}catch(t){return!0}}},function(t,e){t.exports=function(t,e){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:e}}},function(t,e){var r=0,o=Math.random();t.exports=function(t){return"Symbol(".concat(void 0===t?"":t,")_",(++r+o).toString(36))}},function(t,e,r){"use strict";function o(t){return t&&t.__esModule?t:{default:t}}var a=r(0),n=o(a),i=r(1),s=o(i),h=r(4),u=r(2),c=function(){function t(e,r){(0,n.default)(this,t),this.allParams=void 0===e.PhotoID?u.mapParams(e):e,this.id=this.allParams.PhotoID?this.allParams.PhotoID.toString():this.allParams.id.toString(),this.wellsCache={},this.wellsCacheRank={},r&&(this.PosInPhotosArr=r),this.allParams.url&&!this.allParams.Url&&(this.allParams.Url=e.url),this.allParams.origHeight&&!this.allParams.OrigHeight&&(this.allParams.OrigHeight=this.allParams.origHeight),this.allParams.origWidth&&!this.allParams.OrigWidth&&(this.allParams.OrigWidth=this.allParams.origWidth);try{this.allParams.rank=this.getRank(!0,!0,!1,!0,1,!1,1,!1,!0,!0),this.allParams.FacesSizeDeviation=this._addFacesSizeDeviation()}catch(t){}}return(0,s.default)(t,[{key:"isView",value:function(){return 0==this.allParams.NumOfFacesEstimation||this.allParams.SumFaceSize<.05}},{key:"getRank",value:function(t,e,r,o,a,n,i,s,h,c){var l=0;if(this.allParams.FacesArr&&this.allParams.FacesArr.length>0){if(l=t?Number(this.allParams.FacesRank)?Number(this.allParams.FacesRank):0:this.allParams.FacesRank&&this.allParams.NumOfFacesFactor?Number(this.allParams.FacesRank)+Number(this.allParams.NumOfFacesFactor):0,this.allParams.Vips&&this.allParams.Vips.length>0){this.allParams.hasOwnProperty("FacesArr")&&0!=this.allParams.FacesArr.length||(this.allParams.FacesArr=this.allParams.Vips);var f=this.allParams.Vips.length/this.allParams.FacesArr.length;this.allParams.VipsPer&&u.isNumeric(this.allParams.VipsPer)&&(f+=this.allParams.VipsPer),f++,l+=f}this.allParams.SideLookAwayFactor&&(l-=Number(this.allParams.SideLookAwayFactor)),this.allParams.FacesOnSidesFactor&&(l-=Number(this.allParams.FacesOnSidesFactor)),e&&(u.isNumeric(e)||(e=1),!h&&this.allParams.RecognitionFactor?l+=e*Number(this.allParams.RecognitionFactor):h&&this.allParams.RecognitionFactorGlobal&&(l+=e*Number(this.allParams.RecognitionFactorGlobal))),r&&this.allParams.PortraitFactor&&(l+=a*Number(this.allParams.PortraitFactor)),this.allParams.bokehFactor&&a>1&&(l+=Number(this.allParams.bokehFactor)),o&&this.allParams.SubClusterSizeFactor&&(l+=Number(this.allParams.SubClusterSizeFactor)),i&&this.allParams.GroupFactor&&(l+=i*Number(this.allParams.GroupFactor)),this.allParams.BadDynRangeFactor&&(l+=Number(this.allParams.BadDynRangeFactor)),this.allParams.BigLowPlacedFaceFactor&&(l+=Number(this.allParams.BigLowPlacedFaceFactor)),this.allParams.OneFaceBigOnTheSide&&(l+=Number(this.allParams.OneFaceBigOnTheSide)),this.allParams.OneFaceBigOnTheTop&&(l+=Number(this.allParams.OneFaceBigOnTheTop));var d=0;c&&this.allParams.FacesArr&&(d=0,this.allParams.FacesArr.length>=3&&this.allParams.FacesArr.length<=5&&(d=.5),this.allParams.FacesArr.length>=6&&this.allParams.FacesArr.length<=7&&(d=.2),l+=d,2==this.allParams.FacesArr.length&&i&&this.allParams.GroupFactor&&(l-=i*Number(this.allParams.GroupFactor)/2)),n&&this.allParams.NotAsGoodForBest&&(u.isNumeric(e)||(n=1),l-=n)}else l=this.allParams.BackgroundRank?Number(this.allParams.BackgroundRank):0,this.allParams.PhotoParams&&this.allParams.PhotoParams.ObjectsF&&(l+=Number(this.allParams.PhotoParams.ObjectsF)),n&&this.allParams.NotAsGoodForBest&&(u.isNumeric(e)||(n=1),l-=n);return this.allParams.OrigWidth>2.5*this.allParams.OrigHeight&&(l+=2),this.allParams.Harting&&Number(this.allParams.Harting)>0&&(l+=10*(Number(this.allParams.Harting)+1)),this.allParams.hasOwnProperty("PhotoParams")&&this.allParams.PhotoParams.hasOwnProperty("isSynthetic")&&this.allParams.PhotoParams.isSynthetic&&(l-=10*Math.abs(l)),l}},{key:"getBaseRank",value:function(){return this.allParams.NumOfFacesEstimation?this.allParams.FacesRank:this.allParams.BackgroundRank}},{key:"isProductWorthyPhoto",value:function(t){if(t){if(!this.isView()&&(this.allParams.Best||this.getBaseRank()>6||this.isAGoodPortrait(!0)))return!0;if(this.isView()&&this.getBaseRank()>5)return!0}else if(!this.isView()&&(this.allParams.Best||this.getBaseRank()>7.5||this.isAGoodPortrait(!0))){if(this.allParams.NumOfFaces>2&&this.allParams.GroupFactor<.03)return!1;var e=this.getFacesBaseCrop(),r=this.allParams.AverageFaceSize/Math.min(e.width,e.height);return!(r<.1)}return!1}},{key:"checkPhotoInPhotosArray",value:function(t){var e=this,r=!1;return t.forEach(function(t){e.id==t.id&&(r=!0)}),r}},{key:"isAGoodPortrait",value:function(t){var e=!0;return 1==this.allParams.NumOfFaces&&this.getBaseRank()>5.5&&this.allParams.AverageFaceSize>.15&&Math.abs(this.allParams.FacesArr[0].Pitch)<30&&Math.abs(this.allParams.FacesArr[0].Yaw)<30&&Math.abs(this.allParams.FacesArr[0].Roll)<30&&(t&&(this.allParams.Good||this.allParams.Best||(e=!1)),this.allParams.FacesArr[0].Smiling&&this.allParams.FacesArr[0].SmilingConf>50&&this.getBaseRank()<7&&(e=!1),e)}},{key:"getFacesBaseCrop",value:function(){if(this.allParams.MinFacesBaseCrop)return this.allParams.MinFacesBaseCrop;var t=this.getMinFacesCrop();if(!t)return!1;var e={x:t.x,y:t.y,width:t.width,height:t.height};if(e){var r=0,o=0;this.allParams.FacesArr.forEach(function(t){1==t.Significance&&(t.FaceObj.Rect.width>r&&(r=t.FaceObj.Rect.width),t.FaceObj.Rect.height>o&&(o=t.FaceObj.Rect.height))}),e.x=e.x-1.5*r,e.width=e.width+3*r,e.y=e.y-1.5*o,e.height=e.height+4*o,u.edgesFix(e)}return this.allParams.MinFacesBaseCrop=e,this.allParams.MinFacesBaseCrop}},{key:"getMinFacesCrop",value:function(){if(this.allParams.MinFacesCrop)return this.allParams.MinFacesCrop;var t=!1,e=1e6,r=1e6,o=-1e6,a=-1e6;if(this.allParams.FacesArr){if(this.allParams.FacesArr.forEach(function(n){if(1==n.Significance){t=!0;var i=n.FaceObj.Rect.x-.15*n.FaceObj.Rect.width,s=n.FaceObj.Rect.y-.2*n.FaceObj.Rect.height,h=n.FaceObj.Rect.x+n.FaceObj.Rect.width+.15*n.FaceObj.Rect.width,u=n.FaceObj.Rect.y+n.FaceObj.Rect.height+.15*n.FaceObj.Rect.height;i<e&&(e=i),s<r&&(r=s),h>o&&(o=h),u>a&&(a=u)}}),o-e<.7&&a-r<.7){var n=o-e,i=a-r;e-=.05*n,o+=.05*n,r-=.05*i,a+=.05*i}e<0&&(e=0),r<0&&(r=0),o>1&&(o=1),a>1&&(a=1);var s=o-e,h=a-r;if(Math.max(h,s)<.1){var u=.1-s,c=.1-h;e-=u/2,r-=c/2,e<0?(o+=u/2+Math.abs(e),e=0):(o+=u/2)>1&&(e-=o-1,o=1),r<0?(a+=c/2+Math.abs(r),r=0):(a+=c/2)>1&&(r-=a-1,a=1)}}return!!t&&(this.allParams.MinFacesCrop={x:e,y:r,width:o-e,height:a-r},this.allParams.MinFacesCrop)}},{key:"checkFaceSize",value:function(t,e){var r={val:0},o=this.getBestCropWithin(t.wPt,t.hPt,null,r,!0,t.ex,t.ey,t.ew,t.eh,.8,null,!1,!1);if(o){var a=this.allParams.AverageFaceSize*Math.min(this.allParams.OrigWidth,this.allParams.OrigHeight),n=o.width*this.allParams.OrigWidth,i=t.wPt*a/n,s=this.getMinFacesCrop();i*=Math.min(s.width&&s.width>0?o.width/s.width:0,s.height&&s.height>0?o.height/s.height:0);var h=.5*e*72;return this.allParams.NumOfFaces>=5&&(h=.35*e*72),t.wPt<36&&(h=.8*e*t.wPt*72),!(i<h)}return!0}},{key:"_findFacesAreaOfInterest",value:function(){if(this.facesAreaOfInterest)return this.facesAreaOfInterest;var t={x:100,y:100},e={x:0,y:0};return this.allParams.FacesArr&&this.allParams.FacesArr.forEach(function(r){if(r&&1==r.Significance){var o={x1:r.FaceObj.Rect.x,x2:r.FaceObj.Rect.x+r.FaceObj.Rect.width,y1:r.FaceObj.Rect.y,y2:r.FaceObj.Rect.y+r.FaceObj.Rect.height};t.x=t.x>o.x1?o.x1:t.x,t.y=t.y>o.y1?o.y1:t.y,e.x=e.x<o.x2?o.x2:e.x,e.y=e.y<o.y2?o.y2:e.y}}),this.facesAreaOfInterest={x:t.x,y:t.y,width:e.x-t.x,height:e.y-t.y},this.facesAreaOfInterest}},{key:"_filterEngineCode",value:function(t){return t.EngineCode>=1e3}},{key:"_filterVip",value:function(t){return 0!=t.PersonRecIndex1}},{key:"_filterDummy",value:function(t){return!0}},{key:"_getStrictFacesCrop",value:function(t,e,r,o,a){var n={x:1,y:1},i={x:0,y:0},s={maxwidth:1,minwidth:0,maxheight:1,minheight:0},h=0,u=0,c=0,l=0,f=0,d=0;return this.allParams.FacesArr&&this.allParams.FacesArr.forEach(function(a){if(a&&1==a.Significance&&e(a)){var p={x1:a.FaceObj.Rect.x,x2:a.FaceObj.Rect.x+a.FaceObj.Rect.width,y1:a.FaceObj.Rect.y,y2:a.FaceObj.Rect.y+a.FaceObj.Rect.height};(p[r+"2"]<=t[r]+t[o]&&t[r]<=p[r+"2"]||t[r]<=p[r+"1"]&&t[r]+t[o]>=p[r+"1"])&&(h++,l+=a.FaceObj.Rect.width+a.FaceObj.Rect.height,0!=a.PersonRecIndex1&&(c++,d+=a.FaceObj.Rect.width+a.FaceObj.Rect.height),a.EngineCode>=1e3&&(u++,f+=a.FaceObj.Rect.width+a.FaceObj.Rect.height),n.x>p.x1&&t.x<p.x2&&(n.x=p.x1,s.minwidth=a),p.y1-=.1*a.FaceObj.Rect.y,n.y>p.y1&&t.y<p.y2&&(n.y=p.y1,s.minheight=a),i.x<p.x2&&t.x+t.width>p.x1&&(i.x=p.x2,s.maxwidth=a),i.y<p.y2&&t.y+t.height>p.y1&&(i.y=p.y2,s.maxheight=a))}}),{min:n,max:i,faces:s,faceCount:h,nscCount:u,recCount:c,faceSize:l,nscSize:f,recSize:d}}},{key:"_recursiveRemoveFaces",value:function(t,e,r,o,a,n,i,s,h){if(0==t.faceCount)return{minCrop:h,margin:t};if((t.max[e]-t.min[e])*o<i[r]*a+n*(t.faces["max"+r].FaceObj.Rect[r]+t.faces["min"+r].FaceObj.Rect[r])*o){h=u.clone(i),h[e]=t.min[e];var c={x:h.x*this.allParams.OrigWidth,y:h.y*this.allParams.OrigHeight,width:h.width*this.allParams.OrigWidth,height:h.height*this.allParams.OrigHeight};return c[r]=s*a,h[r]=c[r]/o,c[e]+c[r]>o&&(h[e]-=h[r]+h[e]-1,c[e]=h[e]*o),this._shiftPhoto(t,e,r,h,c,!1),{crop:c,margin:t,minCrop:h}}var l=u.clone(h),f=u.clone(h);f[r]=t.faces["max"+r].FaceObj.Rect[e]-1e-4-t.faces["min"+r].FaceObj.Rect[e],f[e]=t.faces["min"+r].FaceObj.Rect[e]-1e-4,l[e]=t.faces["min"+r].FaceObj.Rect[e]+t.faces["min"+r].FaceObj.Rect[r]+1e-4,l[r]=t.faces["max"+r].FaceObj.Rect[e]+t.faces["max"+r].FaceObj.Rect[r]-l[e]-1e-4;for(var d=this._getStrictFacesCrop(l,this._filterDummy,e,r);d.faceCount>=t.faceCount;)l[e]+=.05,l[r]-=.05,d=this._getStrictFacesCrop(l,this._filterDummy,e,r);for(var p=this._getStrictFacesCrop(f,this._filterDummy,e,r);p.faceCount>=t.faceCount;)f[e]-=.05,f[r]-=.05,p=this._getStrictFacesCrop(f,this._filterDummy,e,r);var g=this._recursiveRemoveFaces(p,e,r,o,a,n,i,s,h),m=this._recursiveRemoveFaces(d,e,r,o,a,n,i,s,h);return m.crop||g.crop?m.crop?g.crop?"left"==this._checkSideToPrefer(m.margin,g.margin,e,r)?m:g:m:g:0==m.margin.faceCount&&0==g.margin.faceCount?m:"left"==this._checkSideToPrefer(m.margin,g.margin,e,r)?m:g}},{key:"_setWellOnPhoto",value:function(t,e,r,o){var a="width",n=r,i=this.allParams.OrigWidth,s=this.allParams.OrigHeight,h=0,u=void 0;"y"==t&&(n=Math.pow(r,-1),a="height",s=this.allParams.OrigWidth,i=this.allParams.OrigHeight);var c={x:0,y:0,width:1,height:1},l={x:0,y:0,width:1,height:1},f=!1,d={},p=this._getStrictFacesCrop(c,this._filterDummy,t,a);switch(this._findMarginRunShift(p,e,c,l,t,a,i,s,n,o)){case 0:f=!0;break;case 2:this.allParams.FacesArr&&this.allParams.FacesArr.length>0&&(f=!0,h-=5);break;case 1:u=this._filterDummy,h-=5}if(d=p,!f&&this.checkIfPhotoIsGoodForRecursion()){var g=this._recursiveRemoveFaces(d,t,a,i,s,o,e,n,c);c=g.minCrop,g.crop?(l=g.crop,f=!0):h-=5}if(this.checkIfPhotoIsGoodForRecursion()||f||(f=!0,l={x:0,y:0,width:1,height:1},h-=5),f||this.objectsInsteadOfFaces||(d=this._getStrictFacesCrop(c,u,t,a),c=e,c[t]=d.min[t],l={x:c.x*this.allParams.OrigWidth,y:c.y*this.allParams.OrigHeight,width:c.width*this.allParams.OrigWidth,height:c.height*this.allParams.OrigHeight},l[a]=n*s,c[a]=l[a]/i,l[t]+l[a]>i&&(c[t]-=c[a]+c[t]-1,l[t]=c[t]*i),this._shiftPhoto(d,t,a,c,l,!1)),"y"===t&&!this.objectsInsteadOfFaces){var m=this._getStrictFacesCrop(c,this._filterDummy,t,a);if(m.faces.minheight.hasOwnProperty("FaceObj")){var v=m.faces.minheight.FaceObj.Rect.height+.02,P={y1:m.min.y*this.allParams.OrigHeight,y2:m.max.y*this.allParams.OrigHeight},y=Math.min(this.allParams.OrigHeight-l.height,Math.max(0,P.y1-this.allParams.OrigHeight*v));l.y=Math.max(y,l.y)}}return{crop:l,rank:h}}},{key:"_findMarginRunShift",value:function(t,e,r,o,a,n,i,s,h,u){return t.faceCount>0&&(t.max[a]-t.min[a])*i<e[n]*s+u*(t.faces["max"+n].FaceObj.Rect[n]+t.faces["min"+n].FaceObj.Rect[n])*i?(r.x=e.x,r.y=e.y,r.width=e.width,r.height=e.height,r[a]=t.min[a],o.x=r.x*this.allParams.OrigWidth,o.y=r.y*this.allParams.OrigHeight,o.width=r.width*this.allParams.OrigWidth,o.height=r.height*this.allParams.OrigHeight,o[n]=h*s,r[n]=o[n]/i,o[a]+o[n]>i&&(r[a]-=r[n]+r[a]-1,o[a]=r[a]*i),this._shiftPhoto(t,a,n,r,o,!0),0):t.faceCount>1?1:2}},{key:"_checkDistanceBetweenFaces",value:function(t,e,r){return t["max"+r].FaceObj.Rect[e]+t["max"+r].FaceObj.Rect[r]-t["min"+r].FaceObj.Rect[e]}},{key:"_checkSideToPrefer",value:function(t,e,r,o){if(t.recCount>e.recCount)return"left";if(e.recCount>t.recCount)return"right";if(t.nscCount>e.nscCount)return"left";if(e.nscCount>t.nscCount)return"right";if(t.faceCount>e.faceCount)return"left";if(e.faceCount>t.faceCount)return"right";if(t.recSize>e.recSize+.05)return"left";if(e.recSize>t.recSize+.05)return"right";if(t.nscSize>e.nscSize+.05)return"left";if(e.recSize>t.recSize+.05)return"right";var a=this._checkDistanceBetweenFaces(t.faces,r,o),n=this._checkDistanceBetweenFaces(e.faces,r,o);return t.faceCount>1&&a<.9*n?"left":t.faceCount>1&&n<.9*a?"right":t.faceSize>e.faceSize?"left":"right"}},{key:"_shiftPhoto",value:function(t,e,r,o,a,n){var i=t.min[e],s=t.max[e],h=t.faces,u=t.faceCount,c="width"==r?"OrigWidth":"OrigHeight",l=void 0,f="",d=i-o[e],p=o[e]+o[r]-s;if(d>0?p>0?(l=(d+p)/2,d<p?(f="remove",l-=d):(f="add",l-=p)):n||d>Math.abs(p)||Math.abs(p)/h["max"+r].FaceObj.Rect[r]<.5||1==u?(f="add",l=(d+p)/2,l<0?l=Math.abs(l+p):l+=Math.abs(p)):(f="remove",l=h["max"+r]+p):p<0?!n&&Math.abs(p)/h["max"+r].FaceObj.Rect[r]>=.5?(f="remove",l=h["max"+r]+p):!n&&Math.abs(d)/h["min"+r].FaceObj.Rect[r]>=.5?(f="add",l=h["min"+r]+d):(l=Math.abs((d+p)/2),d<p?(f="remove",l+=p):(f="add",l+=d)):n||p>Math.abs(d)||Math.abs(d)/h["min"+r].FaceObj.Rect[r]<.5||1==u?(f="remove",l=(d+p)/2,l<0?l=Math.abs(l+d):l+=Math.abs(d)):(f="add",l=h["min"+r]+d),"remove"==f){var g=o[e],m=s<o[e]+o[r]?o[e]+o[r]-s:.1,v=l>=0?Math.min(l,o[e]):Math.min(g,m)-1e-4;a[e]-=this.allParams[c]*v}else{var P=this.allParams[c]-(a[e]+a[r]),y=i>o[e]?i-o[e]:.1,k=l>=0?Math.min(l,P):Math.min(y,P)-1e-4;a[e]+=this.allParams[c]*k}}},{key:"cropPhotoInWell",value:function(t,e,r,o,a,n,i,s,h){var c=t+"_"+e+"_"+r+"_"+o+"_"+a+"_"+n;if(h&&this.wellsCache[c])return this.wellsCache[c];r/=100,o/=100,a/=100,n/=100;var l={},f=void 0,d={x:r,y:o,width:a,height:n},p=this.allParams.OrigWidth/this.allParams.OrigHeight,g=t/e;if(p<=g){l.x=0,l.width=1,l.height=1/g,t=this.allParams.OrigWidth,e=this.allParams.OrigWidth/g;var m=l,v={};v=0==r&&0==o&&1==a&&1==n?this._setWellOnPhoto("y",m,g,i):this._setWellWithBlockersOnPhoto("y",m,g,0,d),l=v.crop,f=v.rank}else{l.y=0,l.height=1,l.width=g,e=this.allParams.OrigHeight,t=this.allParams.OrigHeight*g;var P=l,y={};y=0==r&&0==o&&1==a&&1==n?this._setWellOnPhoto("x",P,g,i):this._setWellWithBlockersOnPhoto("x",P,g,0,d),l=y.crop,f=y.rank}if(f<=-5&&!s)return!1;if(0==l.x&&0==l.y&&1==l.width&&1==l.height)return l;var k=t*a,b=e*n,O=Math.max(l.width/k,l.height/b),S=Math.round(k*O),w=Math.round(b*O),F=Math.round(l.x)+(Math.round(l.width)-S)/2,x=Math.round(l.y)+(Math.round(l.height)-w)/2,_=S/a,R=w/n,T=F-_*r,E=x-R*o;if(0===r&&0===o&&100===a&&100===n||(_=Math.round(l.width),R=Math.round(l.height),T=Math.round(l.x),E=Math.round(l.y)),T<0||E<0||T+_>this.allParams.OrigWidth||E+R>this.allParams.OrigHeight){if(s){var M={x:0,y:0,width:1,height:1};return this.wellsCache[c]=M,this.wellsCacheRank[c]=f,M}return!1}var j=F+S/2,I=x+w/2,C=Math.min(j/(j-T),I/(I-E),(this.allParams.OrigWidth-j)/(_-(j-T)),(this.allParams.OrigHeight-I)/(R-(I-E)));_*=C,R*=C,T=j-C*(j-T),E=I-C*(I-E);var A={x:u.round2(T/this.allParams.OrigWidth),y:u.round2(E/this.allParams.OrigHeight),width:u.round2(_/this.allParams.OrigWidth),height:u.round2(R/this.allParams.OrigHeight)};return this.wellsCache[c]=A,this.wellsCacheRank[c]=f,A}},{key:"checkIfPhotoIsGoodForRecursion",value:function(){var t=this;return this.hasOwnProperty("isGoodForRecursion")?this.isGoodForRecursion:(this.isGoodForRecursion=!0,this.allParams.FacesArr&&Array.isArray(this.allParams.FacesArr)&&this.allParams.FacesArr.length>1&&this.allParams.FacesArr.some(function(e){e.checked||(e.checked={});var r=e.FaceObj.Rect,o=e.faceId,a=!0;t.allParams.FacesArr.some(function(n){if(!a)return!0;if(n.checked||(n.checked={}),n.faceId!=o&&!e.checked[n.faceId]){e.checked[n.faceId]=!0,n.checked[e.faceId]=!0;var i=n.FaceObj.Rect;if(i.x<=r.x+.001&&i.x>=r.x-.001||i.y<=r.y+.001&&i.y>=r.y-.001)return a=!1,t.isGoodForRecursion=!1,!0}})}),this.isGoodForRecursion)}},{key:"getBestCropWithin",value:function(t,e,r,o,a,n,i,s,h,c,l,f,d){n/=100,i/=100,s/=100,h/=100;var p=void 0;if(a&&(p=this.getMinFacesCrop()),!p&&!d)return!1;(p=this.getMinCrop())||(p=this.getMinCrop());var g={x:p.x,y:p.y,width:p.width,height:p.height};g.x=g.x*Math.round(this.allParams.OrigWidth),g.y=g.y*Math.round(this.allParams.OrigHeight),g.width=g.width*Math.round(this.allParams.OrigWidth),g.height=g.height*Math.round(this.allParams.OrigHeight);var m=t*s,v=e*h,P=Math.max(g.width/m,g.height/v),y=Math.round(m*P),k=Math.round(v*P),b=g.x+(g.width-y)/2,O=g.y+(g.height-k)/2,S=y/s,w=k/h,F=b-S*n,x=O-w*i;if(F<0||x<0||F+S>this.allParams.OrigWidth||x+w>this.allParams.OrigHeight){var _=Math.max(F,0),R=Math.max(x,0),T=Math.min(F+S,this.allParams.OrigWidth),E=Math.min(x+w,this.allParams.OrigHeight),M=(T-_)*(E-R);if(o.val=S*S-M,f&&(o.val=o.val/(S*S)),!d)return!1}var j=b+y/2,I=O+k/2,C=Math.min(j/(j-F),I/(I-x),(this.allParams.OrigWidth-j)/(S-(j-F)),(this.allParams.OrigHeight-I)/(w-(I-x)));return S*=C,w*=C,F=j-C*(j-F),x=I-C*(I-x),{x:u.round2(F/this.allParams.OrigWidth),y:u.round2(x/this.allParams.OrigHeight),width:u.round2(S/this.allParams.OrigWidth),height:u.round2(w/this.allParams.OrigHeight)}}},{key:"getMinCropWithin",value:function(t,e,r,o,a){var n=Math.min(t>0?this.allParams.OrigWidth/t:0,e>0?this.allParams.OrigHeight/e:0),i=Math.round(t*n),s=Math.round(e*n),h=!1;(h=a?this.getMinFacesCrop():this.getMinCrop())||(h=this.getMinCrop());var u={x:h.x,y:h.y,width:h.width,height:h.height};if(u.x=u.x*Math.round(this.allParams.OrigWidth),u.y=u.y*Math.round(this.allParams.OrigHeight),u.width=u.width*Math.round(this.allParams.OrigWidth),u.height=u.height*Math.round(this.allParams.OrigHeight),i==this.allParams.OrigWidth){if(s>u.height){var c=(u.y-(s-u.height)/2)/this.allParams.OrigHeight;c<0&&(c=0);var l=s/this.allParams.OrigHeight;return c+l>1&&(c=1-l),{x:0,y:c,width:1,height:l}}return o.val=1-(u.height>0?s/u.height:0),!1}if(s==this.allParams.OrigHeight){if(i>u.width){var f=(u.x-(i-u.width)/2)/this.allParams.OrigWidth;f<0&&(f=0);var d=i/this.allParams.OrigWidth;return f+d>1&&(f=1-d),{x:f,y:0,width:d,height:1}}return o.val=1-i/u.width,!1}}},{key:"getMinCrop",value:function(){if(this.allParams.MinCrop)return this.allParams.MinCrop;var t=this.getMinFacesCrop(),e=this.getMinObjCrop();if(t&&!e)this.allParams.MinCrop={x:t.x,y:t.y,width:t.width,height:t.height};else if(!t&&e)this.allParams.MinCrop={x:e.x,y:e.y,width:e.width,height:e.height};else if(t&&e){var r=Math.min(t.x,e.x),o=Math.min(t.y,e.y),a=Math.max(t.x+t.width,e.x+e.width),n=Math.max(t.y+t.height,e.y+e.height);this.allParams.MinCrop={x:r,y:o,width:a-r,height:n-o}}else this.allParams.MinCrop={x:.2,y:.2,width:.6,height:.2};return u.edgesFix(this.allParams.MinCrop),this.allParams.MinCrop}},{key:"getMinObjCrop",value:function(){if(this.allParams.MinObjCrop)return this.allParams.MinObjCrop;var t=!1,e=1e6,r=1e6,o=-1e6,a=-1e6,n=!1;if(this.allParams.PhotoParams&&this.addObjectsToCrop()){for(var i=1;i<=4;i++){var s="Obj"+i,h=this.allParams.PhotoParams[s];h&&(t=!0,n=!0,h.Rect.x<e&&(e=h.Rect.x),h.Rect.y<r&&(r=h.Rect.y),h.Rect.x+h.Rect.width>o&&(o=h.Rect.x+h.Rect.width),h.Rect.y+h.Rect.height>a&&(a=h.Rect.y+h.Rect.height))}if(n){var u=o-e,c=a-r;e-=.1*u,r-=.1*c,o+=.1*u,a+=.1*c,o-e<.3&&(e-=(.3-(o-e))/2,o+=(.3-(o-e))/2),a-r<.3&&(r-=(.3-(a-r))/2,a+=(.3-(a-r))/2),e<0&&(e=0),r<0&&(r=0),o>1&&(o=1),a>1&&(a=1)}}return!!t&&(this.allParams.MinObjCrop={x:e,y:r,width:o-e,height:a-r},this.allParams.MinObjCrop)}},{key:"addObjectsToCrop",value:function(){return this.allParams.PhotoParams&&this.allParams.PhotoParams.ObjectsF&&this.allParams.PhotoParams.ObjectsF>0}},{key:"checkPhotoCanCropToAtLeastOneWell",value:function(t,e){var r=this,o=!1;return t.some(function(t){var a={val:0};return r.getBestCropWithin(t.wPt,t.hPt,null,a,!0,t.ex,t.ey,t.ew,t.eh,.8,null,!0,!1),a.val<.05?(o=!0,!0):.5==e&&a.val<.15?(o=!0,!0):0==e&&a.val<.3&&(o=!0,!0)}),o}},{key:"analyzePhoto",value:function(){var t=this,e=0,r=0,o=[],a=0,n=!1;if(this.allParams.FacesArr){var i=0,s=0,c=0,l=0,f=0,d=0,p=0;if(this.allParams.FacesArr.forEach(function(h){if(h&&1==h.Significance){h.FocusFactor&&h.FocusFactor<-5&&(n=!0),h.FaceObj&&h.FaceObj.Rect&&(i=Math.max(i,Math.max(h.FaceObj.Rect.width,h.FaceObj.Rect.height)),s+=Math.max(h.FaceObj.Rect.width,h.FaceObj.Rect.height),l+=Math.max(h.FaceObj.Rect.width,h.FaceObj.Rect.height)),(h.LeftEyeClosed||h.RightEyeClosed)&&e++,r++,c+=Math.abs(h.Yaw),a+=h.Confidence;var u=(h.FaceObj.Rect.x+h.FaceObj.Rect.width/2)*t.allParams.OrigWidth,g=(h.FaceObj.Rect.y+h.FaceObj.Rect.height/2)*t.allParams.OrigHeight;if(o.push({x:u,y:g}),h.Confidence&&h.Confidence>50&&(h.LeftEye&&h.LeftEye.Points[0].x>.75?d++:h.RightEye&&h.RightEye.Points[0].x<.25?f++:p++,h.FaceObj&&h.FaceObj.Rect)){var m=.25*t.allParams.OrigWidth,v=Math.max(h.FaceObj.Rect.width,h.FaceObj.Rect.height);if(v<=.35){var P=u,y=u;h.LeftEye&&h.LeftEye.Points[0].x&&(P=h.LeftEye.Points[0].x*t.allParams.OrigWidth);var k=0;P<m&&v>.1&&h.Yaw<-50&&(k=(m-P)/m),h.RightEye&&h.RightEye.Points[0].x&&(y=h.RightEye.Points[0].x*t.allParams.OrigWidth),y>t.allParams.OrigWidth-m&&v>.1&&h.Yaw>50&&(k=(m-(t.allParams.OrigWidth-y))/m),k>1&&(k=1);var b=10*v,O=3*k*b;t.allParams.SideLookAwayFactor+=O}}}}),this.allParams.SumFacesWidth=l,r>0&&(this.allParams.AverageFaceYaw=c/r,this.allParams.AverageConfidence=a/r,this.allParams.AverageFaceSize=s/r,d&&f&&!p&&this.allParams.AverageFaceSize<.3&&(this.allParams.FacesOnSidesFactor=4/(d+f))),this.allParams.NumOfFaces=r,o.length>1){var g=1e7,m=1e7,v=-1e7,P=-1e7;o.forEach(function(t){t.x<g&&(g=t.x),t.x>v&&(v=t.x),t.y<m&&(m=t.y),t.y>P&&(P=t.y)}),v-g>P-m?h.sortFacesByPos(o,"x"):h.sortFacesByPos(o,"y");var y=0;if(o.forEach(function(t,e){var r=0,a=0;e>0&&(r=u.calcDist(t,o[e-1])),o.length-1>e&&(a=u.calcDist(t,o[e+1])),y+=Math.max(r,a)}),y/=o.length,Math.min(this.allParams.OrigWidth,this.allParams.OrigHeight)>0?this.allParams.AverageGap=y/Math.min(this.allParams.OrigWidth,this.allParams.OrigHeight):this.allParams.AverageGap=1e6,this.allParams.AverageFaceYaw<45){var k=this.allParams.AverageFaceSize/this.allParams.AverageGap;k<.2&&(k=0),k>=.2&&k<=.4&&(k=k*(k-.2)/.2),this.allParams.GroupFactor=k}}if(this.allParams.MaxFaceSize=i,this.allParams.SumFaceSize=s,1==r&&(this.isAGoodPortrait(!1)&&(this.allParams.MaxFaceSize<.1?this.allParams.PortraitFactor=10*(this.allParams.MaxFaceSize-.1):this.allParams.MaxFaceSize>=.1&&this.allParams.MaxFaceSize<=.2?this.allParams.PortraitFactor=1.5*(this.allParams.MaxFaceSize-.1)/.1:this.allParams.MaxFaceSize>=.2&&this.allParams.MaxFaceSize<=.4?this.allParams.PortraitFactor=1.5+2*(this.allParams.MaxFaceSize-.2)/.2:this.allParams.PortraitFactor=3.5+30*(.4-this.allParams.MaxFaceSize)),this.allParams.PhotoParams&&this.allParams.PhotoParams.BokehF&&this.allParams.MaxFaceSize>.14&&(this.allParams.bokehFactor+=2),this.allParams.MaxFaceSize>.15&&this.allParams.FacesArr.forEach(function(e){1==e.Significance&&(e.RightEye.Points[0].y<.1||e.LeftEye.Points[0].y<.1?t.allParams.OneFaceBigOnTheTop=-2:t.allParams.MaxFaceSize>.2&&(e.RightEye.Points[0].x>.9||e.LeftEye.Points[0].x<.1)&&(t.allParams.OneFaceBigOnTheSide=-2))})),this.allParams.MaxFaceSize>.28){var b=0,O=0,S=void 0;this.allParams.FacesArr.forEach(function(t){Math.max(t.FaceObj.Rect.width,t.FaceObj.Rect.height)>.28&&1==t.Significance&&t.Confidence>50&&(b+=t.LeftEye.Points[0].y,b+=t.RightEye.Points[0].y,O+=2),S=t}),O&&(b/=O),b>.55&&S&&S.Roll<20&&(this.allParams.PortraitFactor=0,this.allParams.bokehFactor=0,this.allParams.BigLowPlacedFaceFactor=-3)}}this.allParams.NumOfFacesEstimation=r,this.allParams.ConsideredAsFace=r>0||0,this.allParams.PhotoParams&&this.allParams.PhotoParams.DynRangeF&&this.allParams.PhotoParams.DynRangeF<.3&&(this.allParams.BadDynRangeFactor=20*(this.allParams.PhotoParams.DynRangeF-.3));var w=!1;if(this.allParams.GroupFactor>0&&this.allParams.NumOfFaces>5&&(w=!0),this.allParams.NumOfFacesFactor=0,this.allParams.FacesArr){var F=0;this.allParams.FacesArr.forEach(function(e){1==e.Significance&&(t.allParams.NumOfFacesFactor+=F<4?1:F<8?w?1:.5:w?1:.2,F++)})}this.allParams.MaxFaceSize&&this.allParams.MaxFaceSize>0&&this.allParams.MaxFaceSize<.1&&(this.allParams.FaceType="Small")}},{key:"getObjectsAsFaces",value:function(){var t=this;if(t.allParams&&t.allParams.PhotoParams&&!t.allParams.ObjectsArr){for(var e=[],r=1;t.allParams.PhotoParams.hasOwnProperty("Obj"+r);){var o=t.allParams.PhotoParams["Obj"+r];if(o.hasOwnProperty("Rect")&&o.Rect.hasOwnProperty("x")&&o.Rect.hasOwnProperty("y")&&o.Rect.hasOwnProperty("height")&&o.Rect.hasOwnProperty("width")){var a={FaceObj:{Rect:o.Rect},Significance:1,PersonRecIndex1:0,EngineCode:1};e.push(a)}r++}t.allParams.ObjectsArr=e}}},{key:"_setWellWithBlockersOnPhoto",value:function(t,e,r,o,a){var n="width",i=r,s="y",h=this.allParams.OrigWidth,u=this.allParams.OrigHeight,c=0,l=void 0,f="height";"y"==t&&(s="x",i=Math.pow(r,-1),n="height",f="width",u=this.allParams.OrigWidth,h=this.allParams.OrigHeight);var d={x:0,y:0,width:1,height:1},p={x:0,y:0,width:1,height:1},g=!1,m={},v=this._getStrictFacesCrop(d,this._filterDummy,t,n);switch(this._findMarginRunShiftForBlockers(v,e,d,p,t,s,n,f,h,u,i,o,a)){case 0:g=!0;break;case 2:this.allParams.FacesArr&&this.allParams.FacesArr.length>0&&(g=!0,c-=5);break;case 1:l=this._filterDummy,c-=5;break;case 3:this.allParams.FacesArr&&this.allParams.FacesArr.length>0&&(g=!0,c-=5)}if(m=v,!g&&this.checkIfPhotoIsGoodForRecursion()){var P=this._recursiveRemoveFacesWithBlockers(m,t,n,h,u,o,e,i,d,a);d=P.minCrop,P.crop?(p=P.crop,g=!0):c-=5}if(this.checkIfPhotoIsGoodForRecursion()||g||(g=!0,p={x:0,y:0,width:1,height:1},c-=5),g||this.objectsInsteadOfFaces||(m=this._getStrictFacesCrop(d,l,t,n),d=e,a[t]=a[t]*e[n]*u/h,a[n]=a[n]*e[n]*u/h,d[t]=m.min[t]-a[t],p={x:d.x*this.allParams.OrigWidth,y:d.y*this.allParams.OrigHeight,width:d.width*this.allParams.OrigWidth,height:d.height*this.allParams.OrigHeight},p[n]=i*u,d[n]=p[n]/h,p[t]+p[n]>h&&(d[t]-=d[n]+d[t]-1,p[t]=d[t]*h),this._shiftPhotoWithBlockers(m,t,n,d,p,!1,a)),"y"===t&&!this.objectsInsteadOfFaces){var y=this._getStrictFacesCrop(d,this._filterDummy,t,n);if(y.faces.minheight.hasOwnProperty("FaceObj")){var k=y.faces.minheight.FaceObj.Rect.height+.02,b={y1:y.min.y*this.allParams.OrigHeight,y2:y.max.y*this.allParams.OrigHeight},O=Math.min(this.allParams.OrigHeight-p.height,Math.max(0,b.y1-this.allParams.OrigHeight*k));p.y=Math.max(O,p.y)}}return{crop:p,rank:c}}},{key:"_findMarginRunShiftForBlockers",value:function(t,e,r,o,a,n,i,s,h,c,l,f,d){var p=u.clone(d),g=f*t.faces["max"+i].FaceObj.Rect[i]*h,m=f*t.faces["max"+s].FaceObj.Rect[s]*c;return(t.max[n]-t.min[n])*c>p[s]*e[s]*c+m||t.min[n]*c<p[n]*e[s]*c-m?3:(t.max[a]-t.min[a])*h<p[i]*e[i]*c-g&&t.min[a]*h>p[a]*e[i]*c+g?(r.x=e.x,r.y=e.y,r.width=e.width,r.height=e.height,p[a]=p[a]*e[i]*c/h,p[i]=p[i]*e[i]*c/h,r[a]=t.min[a]-p[a],o.x=r.x*this.allParams.OrigWidth,o.y=r.y*this.allParams.OrigHeight,o.width=r.width*this.allParams.OrigWidth,o.height=r.height*this.allParams.OrigHeight,o[i]=l*c,r[i]=o[i]/h,o[a]+o[i]>h&&(r[a]-=r[i]+r[a]-1,o[a]=r[a]*h),p[a]=r[a]+p[a],this._shiftPhotoWithBlockers(t,a,i,r,o,!0,p),0):t.faceCount>1?1:2}},{key:"_shiftPhotoWithBlockers",value:function(t,e,r,o,a,n,i){var s=t.min[e],h=t.max[e],u=t.faces,c=t.faceCount,l="width"==r?"OrigWidth":"OrigHeight",f=void 0,d="",p=s-i[e],g=Math.min(o[e]+o[r],i[e]+i[r])-h;if(p>0?g>0?(f=(p+g)/2,p<g?(d="remove",f-=p):(d="add",f-=g)):n||p>Math.abs(g)||Math.abs(g)/u["max"+r].FaceObj.Rect[r]<.5||1==c?(d="add",f=(p+g)/2,f<0?f=Math.abs(f+g):f+=Math.abs(g)):(d="remove",f=u["max"+r]+g):g<0?!n&&Math.abs(g)/u["max"+r].FaceObj.Rect[r]>=.5?(d="remove",f=u["max"+r]+g):!n&&Math.abs(p)/u["min"+r].FaceObj.Rect[r]>=.5?(d="add",f=u["min"+r]+p):(f=Math.abs((p+g)/2),p<g?(d="remove",f+=g):(d="add",f+=p)):n||g>Math.abs(p)||Math.abs(p)/u["min"+r].FaceObj.Rect[r]<.5||1==c?(d="remove",f=(p+g)/2,f<0?f=Math.abs(f+p):f+=Math.abs(p)):(d="add",f=u["min"+r]+p),"remove"==d){var m=i[e],v=g>0?g:.1,P=f>=0?Math.min(f,o[e]):Math.min(m,v)-1e-4;a[e]-=this.allParams[l]*P}else{var y=this.allParams[l]-(a[e]+a[r]),k=p>0?p:.1,b=f>=0?Math.min(f,y):Math.min(k,y)-1e-4;a[e]+=this.allParams[l]*b}}},{key:"_recursiveRemoveFacesWithBlockers",value:function(t,e,r,o,a,n,i,s,h,c){var l=n*t.faces["max"+r].FaceObj.Rect[r]*o;if(0==t.faceCount)return{minCrop:h,margin:t};if((t.max[e]-t.min[e])*o<c[r]*i[r]*a+l){h=u.clone(i),c[e]=c[e]*i[r]*a/o,c[r]=c[r]*i[r]*a/o,h[e]=t.min[e]-c[e];var f={x:h.x*this.allParams.OrigWidth,y:h.y*this.allParams.OrigHeight,width:h.width*this.allParams.OrigWidth,height:h.height*this.allParams.OrigHeight};return f[r]=s*a,h[r]=f[r]/o,f[e]+f[r]>o&&(h[e]-=h[r]+h[e]-1,f[e]=h[e]*o),this._shiftPhotoWithBlockers(t,e,r,h,f,!1,c),{crop:f,margin:t,minCrop:h}}var d=u.clone(h),p=u.clone(h);p[r]=t.faces["max"+r].FaceObj.Rect[e]-1e-4-t.faces["min"+r].FaceObj.Rect[e],p[e]=t.faces["min"+r].FaceObj.Rect[e]-1e-4,d[e]=t.faces["min"+r].FaceObj.Rect[e]+t.faces["min"+r].FaceObj.Rect[r]+1e-4,d[r]=t.faces["max"+r].FaceObj.Rect[e]+t.faces["max"+r].FaceObj.Rect[r]-d[e]-1e-4;for(var g=this._getStrictFacesCrop(d,this._filterDummy,e,r);g.faceCount>=t.faceCount;)d[e]+=.05,d[r]-=.05,g=this._getStrictFacesCrop(d,this._filterDummy,e,r);for(var m=this._getStrictFacesCrop(p,this._filterDummy,e,r);m.faceCount>=t.faceCount;)p[e]-=.05,p[r]-=.05,m=this._getStrictFacesCrop(p,this._filterDummy,e,r);var v=this._recursiveRemoveFaces(m,e,r,o,a,n,i,s,h),P=this._recursiveRemoveFaces(g,e,r,o,a,n,i,s,h);return P.crop||v.crop?P.crop?v.crop?"left"==this._checkSideToPrefer(P.margin,v.margin,e,r)?P:v:P:v:0==P.margin.faceCount&&0==v.margin.faceCount?P:"left"==this._checkSideToPrefer(P.margin,v.margin,e,r)?P:v}},{key:"checkMinFaceInWell",value:function(t,e){var r=this;if(r.allParams.hasOwnProperty("FacesArr")&&r.allParams.FacesArr.length>0&&!r.objectsInsteadOfFaces){var o=r.getMaxFace(),a=1,n=1,i=r.allParams.OrigWidth/r.allParams.OrigHeight,s=t.wPt/t.hPt;return i<=s?(a=t.iw,n=1/s*t.ih):(n=t.ih,a=s*t.iw),Math.max(o*n,o*a)>=e}return!0}},{key:"getMaxFace",value:function(){var t=this;if(t.hasOwnProperty("maxFaceSize"))return t.maxFaceSize;var e=0;return t.allParams.FacesArr.forEach(function(t){t.hasOwnProperty("FaceObj")&&t.FaceObj.hasOwnProperty("Rect")&&t.FaceObj.Rect.hasOwnProperty("height")&&t.FaceObj.Rect.height>e&&(e=t.FaceObj.Rect.height)}),t.maxFaceSize=e,t.maxFaceSize}},{key:"_addFacesSizeDeviation",value:function(){var t=this._getFacesWidthArray();if(0==t.length)return 0;var e=void 0,r=void 0,o=0,a=0,n=[];for(e=0;e<t.length;e+=1)o+=t[e];for(a=o/t.length,r=0;r<t.length;r+=1)n.push(Math.pow(t[r]-a,2));return Math.sqrt(n.reduce(function(t,e){return t+e})/t.length)}},{key:"_getFacesWidthArray",value:function(){var t=[];return this.allParams.hasOwnProperty("FacesArr")&&this.allParams.FacesArr.forEach(function(e){e.hasOwnProperty("FaceObj")&&e.FaceObj.hasOwnProperty("Rect")&&e.FaceObj.Rect.hasOwnProperty("width")&&t.push(e.FaceObj.Rect.width)}),t}}]),t}();t.exports=c},function(t,e,r){"use strict";var o=r(44),a=function(t){return t&&t.__esModule?t:{default:t}}(o),n=r(59),i=r(85);t.exports={getRanks:function(t){return n(a.default.mark(function e(){var r,o,n;return a.default.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r={requestHeader:{},requestBody:{}},o=t.timeout?t.timeout:30001,r.requestHeader.key=t.migratedUser?"e60972e6e25250eef243dc2fb5cffdd2":"917418fa13822ffc168f016937407f2e",t.userId&&t.oauthToken&&(r.requestBody.partnerUserId=t.userId,r.requestBody.oauthToken=t.oauthToken),t.hasOwnProperty("allowOnDemand")&&!t.allowOnDemand&&delete r.requestBody.oauthToken,r.requestBody.selection=!1,r.requestBody.source="magic_sdk",r.requestBody.onlyRank=!0,r.requestBody.photos=t.photos,n=void 0,e.prev=10,n=i.post("GetRank",r,t.env,o,t.currentResult),e.abrupt("return",n);case 15:throw e.prev=15,e.t0=e.catch(10),e.t0;case 18:case"end":return e.stop()}},e,this,[[10,15]])}))},sendMonitor:function(t,e){return n(a.default.mark(function r(){var o,n,s,h;return a.default.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return o={requests:t},n="prod"==e?"":"-"+e,s="https://magicapi"+n+".photoccino.com/monitor/",h=void 0,r.prev=4,h=i.post("magicSDK",o,s),r.abrupt("return",h);case 9:throw r.prev=9,r.t0=r.catch(4),r.t0;case 12:case"end":return r.stop()}},r,this,[[4,9]])}))},sendFeedback:function(t,e,r){return n(a.default.mark(function o(){var n,s,h,u;return a.default.wrap(function(o){for(;;)switch(o.prev=o.next){case 0:return n={feedbacks:t,type:r},s="prod"==e?"":"-"+e,h="https://magicapi"+s+".photoccino.com/monitor/",u=void 0,o.prev=4,u=i.post("magicSDKFeedbacks",n,h),o.abrupt("return",u);case 9:throw o.prev=9,o.t0=o.catch(4),o.t0;case 12:case"end":return o.stop()}},o,this,[[4,9]])}))},getVips:function(t,e){return n(a.default.mark(function r(){var o,n,s,h;return a.default.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return o={userId:t},console.log("Calling get Vips"),n="prod"===e?"":"-"+e,s="https://magicapi"+n+".photoccino.com/v1/vips/getVips",h=void 0,r.prev=5,h=i.post("",o,s),r.abrupt("return",h);case 10:throw r.prev=10,r.t0=r.catch(5),r.t0;case 13:case"end":return r.stop()}},r,this,[[5,10]])}))}}},function(t,e,r){var o=r(22),a=r(3)("toStringTag"),n="Arguments"==o(function(){return arguments}()),i=function(t,e){try{return t[e]}catch(t){}};t.exports=function(t){var e,r,s;return void 0===t?"Undefined":null===t?"Null":"string"==typeof(r=i(e=Object(t),a))?r:n?o(e):"Object"==(s=o(e))&&"function"==typeof e.callee?"Arguments":s}},function(t,e){var r=0,o=Math.random();t.exports=function(t){return"Symbol(".concat(void 0===t?"":t,")_",(++r+o).toString(36))}},function(t,e,r){var o=r(18),a=r(5).document,n=o(a)&&o(a.createElement);t.exports=function(t){return n?a.createElement(t):{}}},function(t,e){var r=Math.ceil,o=Math.floor;t.exports=function(t){return isNaN(t=+t)?0:(t>0?o:r)(t)}},function(t,e){t.exports=function(t){if(void 0==t)throw TypeError("Can't call method on  "+t);return t}},function(t,e,r){var o=r(97),a=r(39);t.exports=function(t){return o(a(t))}},function(t,e,r){var o=r(60)("keys"),a=r(36);t.exports=function(t){return o[t]||(o[t]=a(t))}},function(t,e,r){var o=r(23).f,a=r(20),n=r(3)("toStringTag");t.exports=function(t,e,r){t&&!a(t=r?t:t.prototype,n)&&o(t,n,{configurable:!0,value:e})}},function(t,e,r){"use strict";function o(t){var e,r;this.promise=new t(function(t,o){if(void 0!==e||void 0!==r)throw TypeError("Bad Promise constructor");e=t,r=o}),this.resolve=a(e),this.reject=a(r)}var a=r(26);t.exports.f=function(t){return new o(t)}},function(t,e,r){t.exports=r(121)},function(t,e,r){var o=r(7),a=r(27),n=r(126),i=r(14),s=function(t,e,r){var h,u,c,l=t&s.F,f=t&s.G,d=t&s.S,p=t&s.P,g=t&s.B,m=t&s.W,v=f?a:a[e]||(a[e]={}),P=v.prototype,y=f?o:d?o[e]:(o[e]||{}).prototype;f&&(r=e);for(h in r)(u=!l&&y&&void 0!==y[h])&&h in v||(c=u?y[h]:r[h],v[h]=f&&"function"!=typeof y[h]?r[h]:g&&u?n(c,o):m&&y[h]==c?function(t){var e=function(e,r,o){if(this instanceof t){switch(arguments.length){case 0:return new t;case 1:return new t(e);case 2:return new t(e,r)}return new t(e,r,o)}return t.apply(this,arguments)};return e.prototype=t.prototype,e}(c):p&&"function"==typeof c?n(Function.call,c):c,p&&((v.virtual||(v.virtual={}))[h]=c,t&s.R&&P&&!P[h]&&i(P,h,c)))};s.F=1,s.G=2,s.S=4,s.P=8,s.B=16,s.W=32,s.U=64,s.R=128,t.exports=s},function(t,e,r){var o=r(29);t.exports=function(t,e){if(!o(t))return t;var r,a;if(e&&"function"==typeof(r=t.toString)&&!o(a=r.call(t)))return a;if("function"==typeof(r=t.valueOf)&&!o(a=r.call(t)))return a;if(!e&&"function"==typeof(r=t.toString)&&!o(a=r.call(t)))return a;throw TypeError("Can't convert object to primitive value")}},function(t,e){var r=Math.ceil,o=Math.floor;t.exports=function(t){return isNaN(t=+t)?0:(t>0?o:r)(t)}},function(t,e){t.exports=function(t){if(void 0==t)throw TypeError("Can't call method on  "+t);return t}},function(t,e){t.exports=!0},function(t,e){t.exports={}},function(t,e,r){var o=r(78),a=r(54);t.exports=Object.keys||function(t){return o(t,a)}},function(t,e,r){var o=r(53)("keys"),a=r(32);t.exports=function(t){return o[t]||(o[t]=a(t))}},function(t,e,r){var o=r(7),a=o["__core-js_shared__"]||(o["__core-js_shared__"]={});t.exports=function(t){return a[t]||(a[t]={})}},function(t,e){t.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(t,e,r){var o=r(9).f,a=r(11),n=r(16)("toStringTag");t.exports=function(t,e,r){t&&!a(t=r?t:t.prototype,n)&&o(t,n,{configurable:!0,value:e})}},function(t,e,r){e.f=r(16)},function(t,e,r){var o=r(7),a=r(27),n=r(49),i=r(56),s=r(9).f;t.exports=function(t){var e=a.Symbol||(a.Symbol=n?{}:o.Symbol||{});"_"==t.charAt(0)||t in e||s(e,t,{value:i.f(t)})}},function(t,e){e.f={}.propertyIsEnumerable},function(t,e){function r(t){var e=this,r=l.call(arguments,1);return new Promise(function(a,n){function i(e){var r;try{r=t.next(e)}catch(t){return n(t)}u(r)}function h(e){var r;try{r=t.throw(e)}catch(t){return n(t)}u(r)}function u(t){if(t.done)return a(t.value);var r=o.call(e,t.value);return r&&s(r)?r.then(i,h):h(new TypeError('You may only yield a function, promise, generator, array, or object, but the following object was passed: "'+String(t.value)+'"'))}if("function"==typeof t&&(t=t.apply(e,r)),!t||"function"!=typeof t.next)return a(t);i()})}function o(t){return t?s(t)?t:u(t)||h(t)?r.call(this,t):"function"==typeof t?a.call(this,t):Array.isArray(t)?n.call(this,t):c(t)?i.call(this,t):t:t}function a(t){var e=this;return new Promise(function(r,o){t.call(e,function(t,e){if(t)return o(t);arguments.length>2&&(e=l.call(arguments,1)),r(e)})})}function n(t){return Promise.all(t.map(o,this))}function i(t){for(var e=new t.constructor,r=Object.keys(t),a=[],n=0;n<r.length;n++){var i=r[n],h=o.call(this,t[i]);h&&s(h)?function(t,r){e[r]=void 0,a.push(t.then(function(t){e[r]=t}))}(h,i):e[i]=t[i]}return Promise.all(a).then(function(){return e})}function s(t){return"function"==typeof t.then}function h(t){return"function"==typeof t.next&&"function"==typeof t.throw}function u(t){var e=t.constructor;return!!e&&("GeneratorFunction"===e.name||"GeneratorFunction"===e.displayName||h(e.prototype))}function c(t){return Object==t.constructor}var l=Array.prototype.slice;t.exports=r.default=r.co=r,r.wrap=function(t){function e(){return r.call(this,t.apply(this,arguments))}return e.__generatorFunction__=t,e}},function(t,e,r){var o=r(5),a=o["__core-js_shared__"]||(o["__core-js_shared__"]={});t.exports=function(t){return a[t]||(a[t]={})}},function(t,e){t.exports=function(t){try{return!!t()}catch(t){return!0}}},function(t,e){t.exports=function(t,e){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:e}}},function(t,e,r){"use strict";var o=r(64),a=r(24),n=r(17),i=r(12),s=r(20),h=r(21),u=r(93),c=r(42),l=r(100),f=r(3)("iterator"),d=!([].keys&&"next"in[].keys()),p=function(){return this};t.exports=function(t,e,r,g,m,v,P){u(r,e,g);var y,k,b,O=function(t){if(!d&&t in x)return x[t];switch(t){case"keys":case"values":return function(){return new r(this,t)}}return function(){return new r(this,t)}},S=e+" Iterator",w="values"==m,F=!1,x=t.prototype,_=x[f]||x["@@iterator"]||m&&x[m],R=_||O(m),T=m?w?O("entries"):R:void 0,E="Array"==e?x.entries||_:_;if(E&&(b=l(E.call(new t)))!==Object.prototype&&b.next&&(c(b,S,!0),o||s(b,f)||i(b,f,p)),w&&_&&"values"!==_.name&&(F=!0,R=function(){return _.call(this)}),o&&!P||!d&&!F&&x[f]||i(x,f,R),h[e]=R,h[S]=p,m)if(y={values:w?R:O("values"),keys:v?R:O("keys"),entries:T},P)for(k in y)k in x||n(x,k,y[k]);else a(a.P+a.F*(d||F),e,y);return y}},function(t,e){t.exports=!1},function(t,e,r){var o=r(96),a=r(67);t.exports=Object.keys||function(t){return o(t,a)}},function(t,e,r){var o=r(38),a=Math.min;t.exports=function(t){return t>0?a(o(t),9007199254740991):0}},function(t,e){t.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(t,e,r){var o=r(5).document;t.exports=o&&o.documentElement},function(t,e,r){var o=r(8),a=r(26),n=r(3)("species");t.exports=function(t,e){var r,i=o(t).constructor;return void 0===i||void 0==(r=o(i)[n])?e:a(r)}},function(t,e,r){var o,a,n,i=r(25),s=r(112),h=r(68),u=r(37),c=r(5),l=c.process,f=c.setImmediate,d=c.clearImmediate,p=c.MessageChannel,g=c.Dispatch,m=0,v={},P=function(){var t=+this;if(v.hasOwnProperty(t)){var e=v[t];delete v[t],e()}},y=function(t){P.call(t.data)};f&&d||(f=function(t){for(var e=[],r=1;arguments.length>r;)e.push(arguments[r++]);return v[++m]=function(){s("function"==typeof t?t:Function(t),e)},o(m),m},d=function(t){delete v[t]},"process"==r(22)(l)?o=function(t){l.nextTick(i(P,t,1))}:g&&g.now?o=function(t){g.now(i(P,t,1))}:p?(a=new p,n=a.port2,a.port1.onmessage=y,o=i(n.postMessage,n,1)):c.addEventListener&&"function"==typeof postMessage&&!c.importScripts?(o=function(t){c.postMessage(t+"","*")},c.addEventListener("message",y,!1)):o="onreadystatechange"in u("script")?function(t){h.appendChild(u("script")).onreadystatechange=function(){h.removeChild(this),P.call(t)}}:function(t){setTimeout(i(P,t,1),0)}),t.exports={set:f,clear:d}},function(t,e){t.exports=function(t){try{return{e:!1,v:t()}}catch(t){return{e:!0,v:t}}}},function(t,e,r){var o=r(8),a=r(18),n=r(43);t.exports=function(t,e){if(o(t),a(e)&&e.constructor===t)return e;var r=n.f(t);return(0,r.resolve)(e),r.promise}},function(t,e,r){t.exports=!r(10)&&!r(30)(function(){return 7!=Object.defineProperty(r(74)("div"),"a",{get:function(){return 7}}).a})},function(t,e,r){var o=r(29),a=r(7).document,n=o(a)&&o(a.createElement);t.exports=function(t){return n?a.createElement(t):{}}},function(t,e,r){"use strict";var o=r(49),a=r(45),n=r(76),i=r(14),s=r(11),h=r(50),u=r(134),c=r(55),l=r(141),f=r(16)("iterator"),d=!([].keys&&"next"in[].keys()),p=function(){return this};t.exports=function(t,e,r,g,m,v,P){u(r,e,g);var y,k,b,O=function(t){if(!d&&t in x)return x[t];switch(t){case"keys":case"values":return function(){return new r(this,t)}}return function(){return new r(this,t)}},S=e+" Iterator",w="values"==m,F=!1,x=t.prototype,_=x[f]||x["@@iterator"]||m&&x[m],R=_||O(m),T=m?w?O("entries"):R:void 0,E="Array"==e?x.entries||_:_;if(E&&(b=l(E.call(new t)))!==Object.prototype&&b.next&&(c(b,S,!0),o||s(b,f)||i(b,f,p)),w&&_&&"values"!==_.name&&(F=!0,R=function(){return _.call(this)}),o&&!P||!d&&!F&&x[f]||i(x,f,R),h[e]=R,h[S]=p,m)if(y={values:w?R:O("values"),keys:v?R:O("keys"),entries:T},P)for(k in y)k in x||n(x,k,y[k]);else a(a.P+a.F*(d||F),e,y);return y}},function(t,e,r){t.exports=r(14)},function(t,e,r){var o=r(28),a=r(135),n=r(54),i=r(52)("IE_PROTO"),s=function(){},h=function(){var t,e=r(74)("iframe"),o=n.length;for(e.style.display="none",r(140).appendChild(e),e.src="javascript:",t=e.contentWindow.document,t.open(),t.write("<script>document.F=Object<\/script>"),t.close(),h=t.F;o--;)delete h.prototype[n[o]];return h()};t.exports=Object.create||function(t,e){var r;return null!==t?(s.prototype=o(t),r=new s,s.prototype=null,r[i]=t):r=h(),void 0===e?r:a(r,e)}},function(t,e,r){var o=r(11),a=r(15),n=r(137)(!1),i=r(52)("IE_PROTO");t.exports=function(t,e){var r,s=a(t),h=0,u=[];for(r in s)r!=i&&o(s,r)&&u.push(r);for(;e.length>h;)o(s,r=e[h++])&&(~n(u,r)||u.push(r));return u}},function(t,e){var r={}.toString;t.exports=function(t){return r.call(t).slice(8,-1)}},function(t,e){e.f=Object.getOwnPropertySymbols},function(t,e,r){var o=r(78),a=r(54).concat("length","prototype");e.f=Object.getOwnPropertyNames||function(t){return o(t,a)}},function(t,e,r){"use strict";function o(t){return t&&t.__esModule?t:{default:t}}var a=r(0),n=o(a),i=r(1),s=o(i),h=r(6),u=r(4),c=r(2),l=function(){function t(e){(0,n.default)(this,t);var r=this._reformatWells(e.wells);this._layoutCalc(r),this.cnsObj={LayoutID:e.id,Type:"OnePage",Layout:r,NumBig:this.numOfBigPhotos,NumSmall:this.numOfSmallPhotos,NumText:this.numOfTexts,Description:"",FullArea:0,Sequences:this.sequence,Rank:"0",Side:"Both",NewEvent:"0",MatchTo:"0",Ignore:"1",FormFactor:"",SflyBackgroundID:null,PageName:"front",pWidth:"0",pHeight:"0",CnsID:"1",CnsType:"none",CnsCategory:"",Title:"",ProductCode:"1",CategoryCode:"1",SkuCode:"1",layoutWidth:Number(e.width),layoutHeight:Number(e.height)},this._layoutSetSize(),this._calcEffectiveSize()}return(0,s.default)(t,[{key:"_reformatWells",value:function(t){var e=[];return t.forEach(function(t){var r={x:Number(t.x),y:Number(t.y),w:Number(t.width),h:Number(t.height),r:t.rotation,z:t.zIndex,index:t.wellIndex};switch(t.type){case"text":r.t=1,t.textArea&&(r.textArea=t.textArea);break;case"embellishment":r.e=1;break;case"blocker":r.b=1}e.push(r)}),e}},{key:"_layoutCalc",value:function(t){this.theJson=t,this.numOfObjects=this.theJson.length,this.numOfTexts=this._calcNumOfType("t");var e=this._calcNumOfType("e"),r=this._calcNumOfType("b");this.numOfPhotos=this.numOfObjects-this.numOfTexts-e-r,this._sortJson(),this.numOfSmallPhotos=this._calcNumOfSmallPhotos(),this.numOfBigPhotos=this.numOfPhotos-this.numOfSmallPhotos,this.sequence=this._calcRawSequence(this._clacSortedSequence(),this.photoReverseMapping,this._preparePartsIndexes())}},{key:"_layoutSetSize",value:function(){var t=this;this._getLayout(),this.cnsObj.wellsObj.forEach(function(e){e.t||e.e||e.b||(t.cnsObj.layoutWidth&&(e.wPt=e.w/100*t.cnsObj.layoutWidth,e.iw=c.pointsInInches(e.wPt)),t.cnsObj.layoutHeight&&(e.hPt=e.h/100*t.cnsObj.layoutHeight,e.ih=c.pointsInInches(e.hPt)))})}},{key:"_calcEffectiveSize",value:function(){var t=this;this.cnsObj.wellsObj.forEach(function(e){e.t||e.e||e.b||(e.ex?(e.ex=e.ex/100*e.w+e.x,e.ey=e.ey/100*e.h+e.y,e.ew=e.ew/100*e.w,e.eh=e.eh/100*e.h):(e.ex=e.x,e.ey=e.y,e.ew=e.w,e.eh=e.h),t.cnsObj.wellsObj.forEach(function(t){if(t.b){var r=c.clone(t);if(r.x<e.ex&&r.x+r.w>e.ex&&(r.w-=e.ex-r.x,r.x=e.ex),r.x+r.w>e.ex+e.ew&&r.x<e.ex+e.ew&&(r.w=e.ex+e.ew-r.x),r.y<e.ey&&r.y+r.h>e.ey&&(r.h-=e.ey-r.y,r.y=e.ey),r.y+r.h>e.ey+e.eh&&r.y<e.ey+e.eh&&(r.h=e.ey+e.eh-r.y),r.x>=e.ex&&r.x+r.w<=e.ex+e.ew&&r.y>=e.ey&&r.y+r.h<=e.ey+e.eh){var o={top:e.ew*(r.y-e.ey),left:e.eh*(r.x-e.ex),right:e.eh*(e.ew-(r.x-e.ex+r.w)),bottom:e.ew*(e.eh-(r.y-e.ey+r.h))};switch(u.sortJsonBigestArea(o)[0][0]){case"top":e.eh=r.y-e.ey;break;case"left":e.ew=r.x-e.ex;break;case"right":e.ew=e.ew-(r.x+r.w-e.ex),e.ex=r.x+r.w;break;case"bottom":e.eh=e.eh-(r.y+r.h-e.ey),e.ey=r.y+r.h}}}}),e.ex=c.round2(100*(e.ex-e.x)/e.w),e.ey=c.round2(100*(e.ey-e.y)/e.h),e.ew=c.round2(100*e.ew/e.w),e.eh=c.round2(100*e.eh/e.h))})}},{key:"_getLayout",value:function(){if(!this.cnsObj.wellsObj){var t=this.cnsObj.Layout.slice(0),e=-1e7,r=void 0;t.forEach(function(t,o){if(t.i=t.index,!t.t&&!t.e&&!t.b){var a=Math.round(t.w)*Math.round(t.h);a>e&&(e=a,r=o)}t.seqNum||(t.index?t.seqNum=t.index:t.seqNum=o)}),this.cnsObj.NumBig&&(t[r].Big=1),this.cnsObj.wellsObj=t}}},{key:"_calcNumOfType",value:function(t){if(0==this.numOfObjects)return 0;var e=0;return this.theJson.forEach(function(r){r[t]&&e++}),e}},{key:"_sortJson",value:function(){var t={},e=[],r={},o=[];if(0==this.numOfObjects)this.sortedJson=t,this.sortedParts=e,this.photoSizes=r,this.photoReverseMapping=o;else{var a={};this.theJson.forEach(function(t){if(!t.t&&!t.e&&!t.b){var e=t.w,o=t.h,n=t.x,i=t.y,s=e*o,h=s+"-"+n+"-"+i;r[h]=s,a[h]=t}});var n=u.sortJsonByValue(r),i=0;n.forEach(function(t){e[i]=a[t],o[i]=t,i++}),this.theJson.forEach(function(t){(t.t||t.e||t.b)&&(e[i]=t,i++)}),this.sortedJson=e,this.sortedParts=e,this.photoSizes=r,this.photoReverseMapping=o}}},{key:"_calcNumOfSmallPhotos",value:function(){if(0==this.numOfPhotos)return 0;var t=c.objectValues(this.photoSizes);t.sort(function(t,e){return t<=e?-1:1});var e=t.length;if(0==e)return 0;if(1==e)return t[0]>=2e3?0:1;for(var r=t[e-1],o=0,a=0;a<e;a++)t[a]/r>.75&&o++;return o==e||o>3?e:e-o}},{key:"_clacSortedSequence",value:function(){for(var t=0,e="";t<this.numOfPhotos;){for(var r=[],o=0;o<this.numOfBigPhotos;o++)r.push(this.sortedParts[t+o]);e+=this._calcBigPhotosSequence(r,t),t+=this.numOfBigPhotos;for(var a=0;a<this.numOfSmallPhotos;a++)e+=t.toString(),e+="-",t++}return e=e.slice(0,e.length-1)}},{key:"_calcBigPhotosSequence",value:function(t,e){var r=t.length;if(0==r)return"";if(1==r)return e+" ";if(2==r){var o=t[0].x,a=t[0].y,n=e++,i=t[1].x,s=t[1].y,h=e;return Math.abs(o-i)<40&&Math.abs(a-s)<40?n+"-"+h+" ":n+" "+h+" "}if(3==r){var u=t[0].x,c=t[0].y,l=e++,f=t[1].x,d=t[1].y,p=e++,g=t[2].x,m=t[2].y,v=e,P=void 0,y=void 0,k=void 0;switch(P=Math.abs(u-f)<40&&Math.abs(c-d)<40?100:0,k=Math.abs(f-g)<40&&Math.abs(d-m)<40?10:0,y=Math.abs(u-g)<40&&Math.abs(c-m)<40?1:0,P+k+y){case"0":return l+" "+p+" "+v+" ";case"1":return l+"-"+v+" "+p+" ";case"10":return l+" "+p+"-"+v+" ";case"100":return l+"-"+p+" "+v+" ";case"111":return l+"-"+p+"-"+v+" ";default:return l+" "+p+" "+v+" "}}}},{key:"_preparePartsIndexes",value:function(){var t={};if(0==this.numOfPhotos)return t;var e=0;return this.theJson.forEach(function(r){if(!r.t&&!r.e&&!r.b){var o=r.w,a=r.h,n=r.x,i=r.y;t[o*a+"-"+n+"-"+i]=e,e++}}),t}},{key:"_calcRawSequence",value:function(t,e,r){for(var o=t,a="";o.length>0;){var n=o.indexOf(" "),i=o.indexOf("-"),s=void 0;if(0<(s=-1==n&&-1==i?999:-1==n?i:-1==i?n:Math.min(n,i))&&s<999)a+=r[e[o.slice(0,s)]],o=o.slice(s,o.length);else if(0==s)a+=o.slice(0,1),o=o.slice(1,o.length);else{var h=parseInt(o);a+=r[e[h]],o=""}}for(var u=a.split(" "),c=0;c<u.length;c++){var l=u[c].split("-");l.sort(),u[c]=l.join("-")}return a=u.join(" ")}},{key:"getBigPhotosObj",value:function(){if(this.cnsObj.NumBig>0||0!=this.cnsObj.NumBig&&1==this.cnsObj.NumSmall){if(this.cnsObj.LayoutBigPhotos>0)return this.cnsObj.LayoutBigPhotos;var t=this.cnsObj.NumBig?this.cnsObj.NumBig:1,e=this._getPhotosObj().slice(0);return e.forEach(function(t){t.area=t.w*t.h}),u.sortArea(e),this.cnsObj.LayoutBigPhotos=e.splice(0,t),this.cnsObj.LayoutSmallPhotos=e,this.cnsObj.LayoutBigPhotos}var r=this._getPhotosObj().slice(0);return 1==r.length&&(this.cnsObj.LayoutBigPhotos=r,this.cnsObj.LayoutSmallPhotos=[],this.cnsObj.LayoutBigPhotos)}},{key:"getSmallPhotosObj",value:function(){if(this.cnsObj.LayoutSmallPhotos)return this.cnsObj.LayoutSmallPhotos;var t=[],e=this._getPhotosObj();if(0==this.cnsObj.NumBig)return this.LayoutSmallPhotos=e,this.LayoutSmallPhotos;var r=this.getBigPhotosObj();r&&r.forEach(function(e,r){t[e[r.toString()]]=!0});var o=[];return e.forEach(function(e,r){t[e[r.toString()]]||o.push(e)}),this.LayoutSmallPhotos=o,this.LayoutSmallPhotos}},{key:"_getPhotosObj",value:function(){var t=this;return this.cnsObj.LayoutPhotos?this.cnsObj.LayoutPhotos:(this.cnsObj.LayoutPhotos=[],this.cnsObj.LayoutPhotos=[],this.theJson.forEach(function(e){h.has(e,"t")||h.has(e,"e")||h.has(e,"b")||t.cnsObj.LayoutPhotos.push(e)}),this.cnsObj.LayoutPhotos)}}]),t}();t.exports=l},function(t,e,r){"use strict";function o(t){return t&&t.__esModule?t:{default:t}}var a=r(0),n=o(a),i=r(1),s=o(i),h=r(4),u=r(2),c=r(6),l=function(){function t(e){(0,n.default)(this,t),this.photos=[],this.mainPhotos=[e],this.NumFaces=0,this.NumGroup=0,this.totalBgCol=0,this.ID=e.id,this.rank=0,this.minTimeStamp=1e9,this.maxTimeStamp=0,this.photosLength=1,this.simHash={},this.isSmart=!1}return(0,s.default)(t,[{key:"markAsSmart",value:function(){this.isSmart=!0,this.ID=this.ID+"_S"}},{key:"addGroupRank",value:function(){var t=0;this.mainPhotos.forEach(function(e){var r=e.getRank(!0,!0,!1,!0,2,0,1,!1,!0,!1);t+=r}),t/=this.mainPhotos.length;var e=this.setAvgBgLevel(),r=0;e<80?r=5/80*e-5:e<120&&(r=(e-80)/40),t+=r,this.rank=t}},{key:"_addPhotoToSimHash",value:function(t){var e=this;this.photos.forEach(function(r){t.id!=r.id&&u.checkSimilarity("SamePhoto",t,r)&&(e.simHash[t.id].push(r.id),e.simHash[r.id].push(t.id))})}},{key:"addPhoto",value:function(t){this.photos.push(t),this.simHash[t.id]=[],this._addPhotoToSimHash(t),1==this.photos.length?(this.minTimeStamp=t.allParams.TimeStamp,this.maxTimeStamp=t.allParams.TimeStamp):(this.minTimeStamp=Math.min(this.minTimeStamp,t.allParams.TimeStamp),this.maxTimeStamp=Math.max(this.maxTimeStamp,t.allParams.TimeStamp));var e=u.getBgLightLevel(t.allParams.PhotoParams);this.totalBgCol+=e,t.allParams.NumOfFaces>1&&this.NumGroup++,1==t.allParams.NumOfFaces&&this.NumFaces++,t.allParams.rank=t.getRank(!0,!0,!0,!0,1,!1,1,!1,!0,!1)}},{key:"setAvgBgLevel",value:function(){return this.avgBgLevel||(this.avgBgLevel=this.totalBgCol/this.photos.length),this.avgBgLevel}},{key:"loopAfterMainPhotoForGroup",value:function(t,e,r,o,a){for(var n=void 0,i=o;i<a.length;i++){var s=a[i];if(Math.abs(s.allParams.TimeStamp-this.mainPhotos[0].allParams.TimeStamp)>e*r){n=i;break}if(s.isProductWorthyPhoto(!1)){if(t[s.id]){this.CollideOptions={},this.CollideOptions[t[s.id]]=1,n=a.length;break}this.addPhoto(s),this.photosLength++,t[s.id]=this.ID}}return n}},{key:"loopBeforeMainPhotoForGroup",value:function(t,e,r,o,a){for(var n=void 0,i=o;i>=0;i--){var s=a[i];if(Math.abs(this.mainPhotos[0].allParams.TimeStamp-s.allParams.TimeStamp)>e*r){n=i;break}if(s.isProductWorthyPhoto(!1)){if(t[s.id]){this.CollideOptions={},this.CollideOptions[t[s.id]]=1,n=-1;break}this.addPhoto(s),this.photosLength++,t[s.id]=this.ID}}return n}},{key:"checkPhotoInGroup",value:function(t){var e=t.id;return void 0!==c.find(this.photos,function(t){return t.id==e})}},{key:"sortAndRankPhotos",value:function(){this.addGroupRank(),h.bestFamilyPhoto(this.mainPhotos),h.bestFamilyPhoto(this.photos)}}]),t}();t.exports=l},function(t,e,r){"use strict";function o(t){return t&&t.__esModule?t:{default:t}}var a=r(0),n=o(a),i=r(1),s=o(i),h=(r(6),r(160)),u=r(4),c=r(2),l=function(){function t(e){(0,n.default)(this,t),this.rankVector=[],this.photos=e,this.isNoRanking=!1,this.clusters=[],this.dominantPeopleGroups={},this.numOfSubClusters=0,this.sortedDominantPeopleGroups=[],this.numOfGoodForBest=0,this.numOfGoodphotos=0,this.numOfBestPhotos=0,this.bestPhotos=[],this.dominantPeopleGroupsNumOneFace={},this.onlyRemoveSimilar=!1,this.albumTimeSpan,this.noCoverIds=null,this.coverPhoto=!1,this.coverBest=[]}return(0,s.default)(t,[{key:"activateSelection",value:function(t,e,r){this.noCoverIds=e,1==this.photos.length?this._onePhoto():(this.photos.length<200&&(this.onlyRemoveSimilar=!0),this.isNoRanking?(this.coverPhoto=this.photos[0],this._randomBestSelection()):this._calcBest(!1,r))}},{key:"_onePhoto",value:function(){var t=this.photos[0],e={subClusters:[],timeFromLastCluster:0,level:t.allParams.Level},r=new h;r.index=1,r.goodForBestPhotos.push(t),r.photos.push(t),r.goodPhotos.push(t),r.SubClusterTimeStamp=t.allParams.TimeStamp,e.subClusters.push(r),t.SubClusterAvgTime=t.allParams.TimeStamp,t.allParams.SubClusterIndex=1,this.clusters.push(e),t.allParams.Good=!0,t.allParams.Best=!0,this.rankVector.push(t),this.numOfGoodForBest=1,this.numOfGoodphotos=1,this.numOfBestPhotos=1,this.bestPhotos.push(t),this.numOfSubClusters=1}},{key:"_calcBest",value:function(t,e){var r=1,o=!0,a=null,n=null,i=null,s=this,u={};s.photos.forEach(function(t,e){var c=!1;if((a&&a.allParams.Level>1||o)&&(o=!1,u={subClusters:[],timeFromLastCluster:0},u.level=t.allParams.Level,e>0&&(u.timeFromLastCluster=t.allParams.TimeStamp-s.photos[e-1].allParams.TimeStamp),s.clusters.push(u),c=!0),a&&"1"==a.allParams.Level&&(c=!0),n&&n!=t.allParams.SubClusterTimeStamp&&(c=!0),c){if(i){var l=0,f=0;i.photos.forEach(function(t,e){i.photos[e+1]&&(f+=i.photos[e+1].allParams.TimeStamp-t.allParams.TimeStamp)}),f&&(l=f/(i.photos.length-1)),i.photos.forEach(function(t){t.allParams.SubClusterAvgTime=l})}i=new h,i.index=r++,u.subClusters.push(i)}i.photos.push(t),t.allParams.SubClusterIndex=i.index,a=t,n=t.allParams.SubClusterTimeStamp}),t||(s.photos.forEach(function(t,e){e>0&&(t.allParams.RecSimilarity=s._compareRec(t,s.photos[e-1]))}),s.clusters.forEach(function(t){t.subClusters.forEach(function(t){t.analyze()})}),s._calcDominantPeople(),s.clusters.forEach(function(t){t.subClusters.forEach(function(t){t.selectGoodPhotos(s.onlyRemoveSimilar,e),t.selectGoodForBest(),s.numOfSubClusters++,s.numOfGoodphotos+=t.goodPhotos.length,s.numOfGoodForBest+=t.goodForBestPhotos.length})}),s._calcBestPhotos(),s._getCoverPhoto(),s._calcRankVector(e))}},{key:"_compareRec",value:function(t,e){var r={},o={};t.allParams.FacesArr&&t.allParams.FacesArr.forEach(function(t){if(1==t.Significance){var e=t.PersonRecIndex1;e&&(r[e]=1)}}),e.allParams.FacesArr&&e.allParams.FacesArr.forEach(function(t){if(1==t.Significance){var e=t.PersonRecIndex1;e&&(o[e]=1)}});var a=0,n=0;return Object.keys(r).forEach(function(t){1==r[t]&&(o[t]?(a++,r[t]=2,o[t]=2):(n++,r[t]=2,o[t]=2))}),Object.keys(o).forEach(function(t){1==o[t]&&(r[t]?(a++,r[t]=2,o[t]=2):(n++,r[t]=2,o[t]=2))}),{match:a,noMatch:n}}},{key:"_calcDominantPeople",value:function(){var t=this;this.photos.forEach(function(e){e.allParams.FacesArr&&e.allParams.FacesArr.forEach(function(r){if(1==r.Significance){var o=r.PersonRecIndex1;o&&0!=o&&(t.dominantPeopleGroups[o]||(t.dominantPeopleGroups[o]=[]),t.dominantPeopleGroups[o].push(e))}})}),this.sortedDominantPeopleGroups=u.sortJsonOfArrayByCount(this.dominantPeopleGroups);var e=0,r=[1.5,1,.5,.3,.1];this.sortedDominantPeopleGroups.forEach(function(o){var a=o[0],n=o[1];if(0==e&&(e=n.length),!(n.length<=2)){var i=void 0,s=1e3,h=-1e3;t.dominantPeopleGroups[a].forEach(function(o){var u=o.allParams.NumRecognitionsAdded;u>r.length-1&&(u=r.length-1),o.allParams.RecognitionFactor+=r[u]*Math.sqrt(Math.sqrt(n.length/e)),o.allParams.RecognitionFactorGlobal+=r[u]*(n.length/e),o.allParams.NumRecognitionsAdded++,t.dominantPeopleGroupsNumOneFace[a]||(t.dominantPeopleGroupsNumOneFace[a]=0),1==o.allParams.NumOfFacesEstimation&&t.dominantPeopleGroupsNumOneFace[a]++,o.allParams.FacesArr&&o.allParams.FacesArr.length<s?(i=o,s=o.allParams.FacesArr.length,h=o.getRank(!0,!1,!0,!1,1,!1,!1,!1,!1,!1)):o.allParams.FacesArr&&o.allParams.FacesArr.length==s&&o.getRank(!1,!1,!1,!1,1,!1,!1,!1,!1,!1)>h&&(i=o,s=o.allParams.FacesArr.length,h=o.getRank(!0,!1,!0,!1,1,!1,!1,!1,!1,!1))})}})}},{key:"_calcBestPhotos",value:function(){var t=this,e=1e15,r=-1e15;this.photos.forEach(function(t){t.allParams.TimeStamp<157766400||(t.allParams.TimeStamp<e&&(e=t.allParams.TimeStamp),t.allParams.TimeStamp>r&&(r=t.allParams.TimeStamp))}),this.albumTimeSpan=r-e;var o=[],a=[];this.clusters.forEach(function(t){t.subClusters.forEach(function(t){t.goodForBestPhotos.forEach(function(t){0==t.allParams.NumOfFacesEstimation?a.push(t):o.push(t)})})});var n=void 0;n=this.albumTimeSpan>43200?1800:1,this._markCloseInTimePhotos(o,3,5,n,"RecognitionSubcluster","Dropped, too close"),this._markCloseInTimePhotos(o,5,1e3,n,"RecognitionSubcluster","Dropped, too close"),n=this.albumTimeSpan>43200?1800:300,this._markCloseInTimePhotos(a,0,0,n,"NotAsGoodForBest","Dropped, too close"),n=120,this._markCloseInTimePhotos(o,1,1,n,"PortraitSubclusterNotAsGoodForBest","Dropped, too close");var i=this._calcStandartDevGoodForBest(o),s=this._calcStandartDevGoodForBest(a),h=0,l=i.AV-i.SD;o.forEach(function(t){t.getRank(!0,!0,!0,!0,1,!1,!1,!1,!1,!1)<l?t.allParams.NotAsGoodForBest="Dropped":h++});var f=0;l=s.AV-s.SD,a.forEach(function(e){var r=e.getRank(!0,!0,!0,!0,1,!1,!1,!1,!1,!1);r<l||t.photos.length<10&&r<5.2?e.allParams.NotAsGoodForBest="Dropped":f++});var d=Math.ceil(this.numOfGoodphotos/10),p=void 0,g=void 0,m=void 0;f>0?(p=2*h/f,g=Math.round(d/(1+p)),m=d-g):(g=0,m=d),u.sortPhotosByRank(a,"NotAsGoodForBest");for(var v=0;v<Math.min(g,a.length);v++)a[v].allParams.Best=!0;var P=[];o.some(function(t){if("Dropped"!=t.allParams.NotAsGoodForBest){var e=t.allParams.NumOfFacesEstimation;if(1!=e)P[e]||(P[e]=[]),P[e].push(t);else{P[e]||(P[e]={});var r=0;t.allParams.FacesArr&&t.allParams.FacesArr.forEach(function(t){if(t.Significance&&t.PersonRecIndex1)return r=t.PersonRecIndex1,!0}),P[e][r]||(P[e][r]=[]),P[e][r].push(t)}}});var y=[],k=Math.round(h/10),b=0;P.forEach(function(e,r){if(1==r){var o=0;Object.keys(e).forEach(function(t){o+=e[t].length});var a=Math.round(m*o/h),n=u.sortJsonNumOneApearencesInAlbum(e,t.dominantPeopleGroups),i=0;n[0]&&(i=n[0][1].length);var s=o-i,l=Math.round(3*a*s/(3*s+i)),f=a-l,d=Math.round(a/2),p=[],g=0;n.forEach(function(t){var r=t[1],o=t[0];if(0!=o){p.push(o);var a=0;if(p.forEach(function(t){a+=e[t].length}),a>d&&n.length-g-1>=d||g==n.length-1){var i=Math.round(l*a/s);0==i&&(i=1);var h=[],c="";p.forEach(function(t){e[t].forEach(function(t){h.push(t)}),c&&(c+=", "),c+=t.toString()}),u.sortPhotosByRank(h,"SubClusterPortrait");var m=0,v=void 0;for(v=0;v<h.length&&(h[v].allParams.Best=!0,!(++m>=i));v++);for(var P=v;P<h.length;P++)h[P].getRank(!0,!1,!0,!0,2,3,!1,!1,!1,!1)>11&&(h[P].allParams.Best=!0);p=[]}}else{u.sortPhotosByRank(r,"SubClusterPortrait");var y=void 0;for(y=0;y<f;y++)r[y]&&(r[y].allParams.Best=!0);for(var k=y;k<r.length;k++)r[k].getRank(!0,!1,!0,!0,1.5,3,!1,!1,!1,!1)>11&&(r[k].allParams.Best=!0)}g++})}else{y.push(r);var v=0;if(y.forEach(function(t){v+=P[t].length}),v>k||b==c.getArrayLength(P)-1){var O=Math.round(m*v/h);y[y.length-1]>=4&&(O+=Math.floor(.5*(O+3)));var S=[],w="",F="";y.forEach(function(t){P[t].forEach(function(t){S.push(t)}),w&&(w+=", "),w+=t.toString(),F&&(F+="-"),F+=t.toString()}),r>3?u.sortPhotosByRank(S,"RecognitionSubClusterNotAsGoodForBestGroups"):u.sortPhotosByRank(S,"RecognitionSubClusterNotAsGoodForBest");var x=0,_=void 0;for(_=0;_<S.length&&(S[_].allParams.NotAsGoodForBest||(S[_].allParams.Best=!0,!(++x>=O)));_++);for(var R=_;R<S.length;R++)S[R].allParams.NotAsGoodForBest||(r>3?S[R].getRank(!0,!0,!1,!0,1,3,3,!1,!1,!1)>12&&(S[R].allParams.Best=!0):S[R].getRank(!0,!0,!1,!0,1,3,!1,!1,!1,!1)>9&&(S[R].allParams.Best=!0));y=[]}}b++})}},{key:"_markCloseInTimePhotos",value:function(t,e,r,o,a,n){u.sortPhotosByDate(t);var i=[],s=void 0;if(t.forEach(function(t){if(t.allParams.NumOfFacesEstimation>=e&&t.allParams.NumOfFacesEstimation<=r)if(0==i.length)i.push(t);else if(t.allParams.TimeStamp-i[0].allParams.TimeStamp>=o||i.length>1&&t.allParams.TimeStamp-i[i.length-1].allParams.TimeStamp>5*(i[i.length-1].allParams.TimeStamp-i[0].allParams.TimeStamp)){if(i.length>1&&t.allParams.TimeStamp-i[i.length-1].allParams.TimeStamp<i[1].allParams.TimeStamp-i[0].allParams.TimeStamp)return s=i.shift(),void i.push(t);u.sortPhotosByRank(i,a);for(var h=1;h<i.length;h++)i[h].allParams.NotAsGoodForBest=n;i=[],i.push(t)}else i.push(t)}),i.length>0){u.sortPhotosByRank(i,a);for(var h=1;h<i.length;h++)i[h].allParams.NotAsGoodForBest=n}}},{key:"_calcStandartDevGoodForBest",value:function(t){if(0==t.length)return!1;var e=0,r=0;return t.forEach(function(t){e+=t.getRank(!0,!0,!0,!0,1,!1,!1,!1,!1,!1)}),t.length>0&&(e/=t.length),t.forEach(function(t){r+=Math.pow(t.getRank(!0,!0,!0,!0,1,!1,!1,!1,!1,!1)-e,2)}),t.length>0&&(r=Math.sqrt(r/t.length)),{AV:e,SD:r}}},{key:"_getCoverPhoto",value:function(){var t=this,e=0;Object.keys(this.dominantPeopleGroups).forEach(function(r){var o=t.dominantPeopleGroups[r];if(!(o.length<=2)){var a=t.dominantPeopleGroupsNumOneFace[r]/o.length;o.length>6&&a>.4&&e++}}),e>=Math.ceil(this.dominantPeopleGroups.length/20)&&1==e||this.albumTimeSpan,this.bestPhotos=[],this.photos.forEach(function(e){e.allParams.Best&&t.bestPhotos.push(e)}),u.sortBestForGroup(this.bestPhotos);var r=1e4,o=0;if(this.NoCoverIds&&this.bestPhotos[0])for(var a=this.noCoverIds.split(","),n=!1;!n;){var i=!1;if(a.forEach(function(e){t.bestPhotos[o].id==e&&(i=!0)}),this.bestPhotos[o].allParams.DeletedByUser&&(i=!0),i?(o++,this.bestPhotos[o]||(o=0,n=!0)):n=!0,0==--r)break}this.bestPhotos[o]&&(this.coverPhoto=this.bestPhotos[o],this.coverBest=this.bestPhotos)}},{key:"_calcRankVector",value:function(t){var e=this,r=[];this.rankVector=[],this.coverPhoto&&(this.rankVector.push(this.coverPhoto),r[this.coverPhoto.id]=1);for(var o=0;o<Math.min(7,this.coverBest.length);o++){var a=this.coverBest[o];r[a.id]||(r[a.id]=1,this.rankVector.push(a))}this.numOfBestPhotos=0,this.photos.forEach(function(t){t.allParams.Best&&(e.numOfBestPhotos++,r[t.id]||(r[t.id]=1,e.rankVector.push(t)))}),this.numOfGoodPhotos=0;var n=[],i=[];this.clusters.forEach(function(t){t.subClusters.forEach(function(t){t.goodPhotos.forEach(function(t){r[t.id]||i.push(t),e.numOfGoodPhotos++,n.push(t.id)})})}),u.sortPhotosByRank(i,"3"),i.forEach(function(t){r[t.id]=1,e.rankVector.push(t)}),t&&(i=[],this.photos.forEach(function(t){t.allParams.removedBasedOnSimilarity&&!r[t.id]&&i.push(t)}),u.sortPhotosByRank(i,"3"),i.forEach(function(t){r[t.id]=1,e.rankVector.push(t)})),i=[],this.photos.forEach(function(t){r[t.id]||i.push(t)}),u.sortPhotosByRank(i,"3"),i.forEach(function(t){r[t.id]=1,e.rankVector.push(t)});for(var s=0,h=[],c=0;c<this.rankVector.length;c++)this.rankVector[c].allParams.RankPos=c+1,h.push(this.rankVector[c].id),this.rankVector[c].allParams.Best&&s++}},{key:"_randomBestSelection",value:function(){var t=this;if(this.photos.length>1){u.sortPhotosByDate(this.photos);var e=[],r=[],o=Math.min(Math.round(this.photos.length/10),8);0==o&&(o=1);for(var a=0,n=2;r.length<o&&a<5e4;){for(var i=0;i<this.photos.length;i++)if(this.photos[i+1]){var s=this.photos[i+1].allParams.TimeStamp-this.photos[i].allPararms.TimeStamp;if(s<n)e[i]=1,e[i+1]=1;else if(e.length>0){for(var h=0;h<Math.max(Math.round(e.length/10),1);h++){var c=array_rand(e,1),l=this.photos[c];if(l.allParams.Best=1,l.allParams.NumOfFacesEstimation=1,l.allParams.SumFaceSize=.05,r[c]||(this.bestPhotos.push(this.photos[c]),r[c]=1),r.length==o)return!0}e=[]}}n<10?n+=2:n*=5,a++}if(5e4==a){var f=this.photos.slice(0),d=f.sort(function(){return.5-Math.random()}),p=d.slice(0,o-r.length);Array.isArray(p)&&p.length>0&&p.forEach(function(e){e.allParams.Best=1,e.allParams.NumOfFacesEstimation=1,e.allParams.SumFaceSize=.05,t.BestPhotos.push(e)})}}else{var g=this.photos[0];g.allParams.Best=1,g.allParams.NumOfFacesEstimation=1,g.allParams.SumFaceSize=.05,this.BestPhotos.push(g)}}}]),t}();t.exports=l},function(t,e,r){"use strict";function o(t,e,r,o){return new Promise(function(a,n){var i={method:t,url:o+e,body:""};switch(t.toUpperCase()){case"POST":i.headers={"Content-Type":"text/plain"},i.body=JSON.stringify(r);break;case"GET":default:i.qs=r}var s=new l;s.open(t.toUpperCase(),o+e),i.headers&&Object.keys(i.headers).forEach(function(t){s.setRequestHeader(t,i.headers[t])}),s.onload=function(){if(!(this.status>=200&&this.status<300)){var t={ErrorMsg:this.status+": "+s.statusText};return void n(t)}var e=void 0;e=JSON.parse(s.responseText),a(e)},s.onerror=function(){var t={ErrorMsg:this.status+": "+s.statusText};console.log(e+"failed, error is: ",t),n(t)},s.send(i.body)})}function a(t,e,r,a){return new Promise(function(n,i){var s=3;!function h(){o("POST",t,e,r).then(function(t){if(!("responseBody"in t)||"ResponseHeader"in t&&"Failed"==t.ResponseHeader.Status)return t.ResponseHeader.origPhotos=e.requestBody.photos,void i(t.ResponseHeader);a.result=c.clone(t.responseBody),t=t.responseBody,t.photos||t.inProcess||t.deleted?(t.inProcess&&t.inProcess.remainingTime&&-1==t.inProcess.remainingTime&&(t.stop=!0),n(t)):i(t)}).catch(function(t){if(--s<=0)return t.origPhotos=e.requestBody.photos,void i(t);setTimeout(function(){h()},1e3)})}()})}function n(t){return new Promise(function(e,r){t&&r(t),e(!0)})}function i(t){return t?"prod"==t?f+d:f+t+"."+d:f+p+d}var s=r(44),h=function(t){return t&&t.__esModule?t:{default:t}}(s),u=r(59),c=r(2),l=void 0;l="undefined"==typeof window?r(161).XMLHttpRequest:window.XMLHttpRequest;var f="https://rank.",d="thislife.com/",p="dev.";t.exports={dummy:u.wrap(h.default.mark(function t(e,r){var o;return h.default.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return o=n(r),t.abrupt("return",o);case 2:case"end":return t.stop()}},t,this)})),post:u.wrap(h.default.mark(function t(e,r,n,s,u){var c;return h.default.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return c=void 0,c="GetRank"==e?a(e,r,i(n),u):o("POST",e,r,n),t.abrupt("return",c);case 3:case"end":return t.stop()}},t,this)})),postGen:u.wrap(h.default.mark(function t(e,r,a){var n;return h.default.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return n=void 0,t.next=3,o("POST",r,a,e);case 3:return n=t.sent,console.log("response of postgen is ",n),t.abrupt("return",n);case 6:case"end":return t.stop()}},t,this)})),get:u.wrap(h.default.mark(function t(e,r){var a;return h.default.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,o("GET",e,r);case 2:return a=t.sent,t.abrupt("return",a);case 4:case"end":return t.stop()}},t,this)}))}},function(t,e,r){r(87),t.exports=r(119)},function(t,e,r){r(88),r(91),r(102),r(106),r(117),r(118),t.exports=r(13).Promise},function(t,e,r){"use strict";var o=r(35),a={};a[r(3)("toStringTag")]="z",a+""!="[object z]"&&r(17)(Object.prototype,"toString",function(){return"[object "+o(this)+"]"},!0)},function(t,e,r){t.exports=!r(19)&&!r(61)(function(){return 7!=Object.defineProperty(r(37)("div"),"a",{get:function(){return 7}}).a})},function(t,e,r){var o=r(18);t.exports=function(t,e){if(!o(t))return t;var r,a;if(e&&"function"==typeof(r=t.toString)&&!o(a=r.call(t)))return a;if("function"==typeof(r=t.valueOf)&&!o(a=r.call(t)))return a;if(!e&&"function"==typeof(r=t.toString)&&!o(a=r.call(t)))return a;throw TypeError("Can't convert object to primitive value")}},function(t,e,r){"use strict";var o=r(92)(!0);r(63)(String,"String",function(t){this._t=String(t),this._i=0},function(){var t,e=this._t,r=this._i;return r>=e.length?{value:void 0,done:!0}:(t=o(e,r),this._i+=t.length,{value:t,done:!1})})},function(t,e,r){var o=r(38),a=r(39);t.exports=function(t){return function(e,r){var n,i,s=String(a(e)),h=o(r),u=s.length;return h<0||h>=u?t?"":void 0:(n=s.charCodeAt(h),n<55296||n>56319||h+1===u||(i=s.charCodeAt(h+1))<56320||i>57343?t?s.charAt(h):n:t?s.slice(h,h+2):i-56320+(n-55296<<10)+65536)}}},function(t,e,r){"use strict";var o=r(94),a=r(62),n=r(42),i={};r(12)(i,r(3)("iterator"),function(){return this}),t.exports=function(t,e,r){t.prototype=o(i,{next:a(1,r)}),n(t,e+" Iterator")}},function(t,e,r){var o=r(8),a=r(95),n=r(67),i=r(41)("IE_PROTO"),s=function(){},h=function(){var t,e=r(37)("iframe"),o=n.length;for(e.style.display="none",r(68).appendChild(e),e.src="javascript:",t=e.contentWindow.document,t.open(),t.write("<script>document.F=Object<\/script>"),t.close(),h=t.F;o--;)delete h.prototype[n[o]];return h()};t.exports=Object.create||function(t,e){var r;return null!==t?(s.prototype=o(t),r=new s,s.prototype=null,r[i]=t):r=h(),void 0===e?r:a(r,e)}},function(t,e,r){var o=r(23),a=r(8),n=r(65);t.exports=r(19)?Object.defineProperties:function(t,e){a(t);for(var r,i=n(e),s=i.length,h=0;s>h;)o.f(t,r=i[h++],e[r]);return t}},function(t,e,r){var o=r(20),a=r(40),n=r(98)(!1),i=r(41)("IE_PROTO");t.exports=function(t,e){var r,s=a(t),h=0,u=[];for(r in s)r!=i&&o(s,r)&&u.push(r);for(;e.length>h;)o(s,r=e[h++])&&(~n(u,r)||u.push(r));return u}},function(t,e,r){var o=r(22);t.exports=Object("z").propertyIsEnumerable(0)?Object:function(t){return"String"==o(t)?t.split(""):Object(t)}},function(t,e,r){var o=r(40),a=r(66),n=r(99);t.exports=function(t){return function(e,r,i){var s,h=o(e),u=a(h.length),c=n(i,u);if(t&&r!=r){for(;u>c;)if((s=h[c++])!=s)return!0}else for(;u>c;c++)if((t||c in h)&&h[c]===r)return t||c||0;return!t&&-1}}},function(t,e,r){var o=r(38),a=Math.max,n=Math.min;t.exports=function(t,e){return t=o(t),t<0?a(t+e,0):n(t,e)}},function(t,e,r){var o=r(20),a=r(101),n=r(41)("IE_PROTO"),i=Object.prototype;t.exports=Object.getPrototypeOf||function(t){return t=a(t),o(t,n)?t[n]:"function"==typeof t.constructor&&t instanceof t.constructor?t.constructor.prototype:t instanceof Object?i:null}},function(t,e,r){var o=r(39);t.exports=function(t){return Object(o(t))}},function(t,e,r){for(var o=r(103),a=r(65),n=r(17),i=r(5),s=r(12),h=r(21),u=r(3),c=u("iterator"),l=u("toStringTag"),f=h.Array,d={CSSRuleList:!0,CSSStyleDeclaration:!1,CSSValueList:!1,ClientRectList:!1,DOMRectList:!1,DOMStringList:!1,DOMTokenList:!0,DataTransferItemList:!1,FileList:!1,HTMLAllCollection:!1,HTMLCollection:!1,HTMLFormElement:!1,HTMLSelectElement:!1,MediaList:!0,MimeTypeArray:!1,NamedNodeMap:!1,NodeList:!0,PaintRequestList:!1,Plugin:!1,PluginArray:!1,SVGLengthList:!1,SVGNumberList:!1,SVGPathSegList:!1,SVGPointList:!1,SVGStringList:!1,SVGTransformList:!1,SourceBufferList:!1,StyleSheetList:!0,TextTrackCueList:!1,TextTrackList:!1,TouchList:!1},p=a(d),g=0;g<p.length;g++){var m,v=p[g],P=d[v],y=i[v],k=y&&y.prototype;if(k&&(k[c]||s(k,c,f),k[l]||s(k,l,v),h[v]=f,P))for(m in o)k[m]||n(k,m,o[m],!0)}},function(t,e,r){"use strict";var o=r(104),a=r(105),n=r(21),i=r(40);t.exports=r(63)(Array,"Array",function(t,e){this._t=i(t),this._i=0,this._k=e},function(){var t=this._t,e=this._k,r=this._i++;return!t||r>=t.length?(this._t=void 0,a(1)):"keys"==e?a(0,r):"values"==e?a(0,t[r]):a(0,[r,t[r]])},"values"),n.Arguments=n.Array,o("keys"),o("values"),o("entries")},function(t,e,r){var o=r(3)("unscopables"),a=Array.prototype;void 0==a[o]&&r(12)(a,o,{}),t.exports=function(t){a[o][t]=!0}},function(t,e){t.exports=function(t,e){return{value:e,done:!!t}}},function(t,e,r){"use strict";var o,a,n,i,s=r(64),h=r(5),u=r(25),c=r(35),l=r(24),f=r(18),d=r(26),p=r(107),g=r(108),m=r(69),v=r(70).set,P=r(113)(),y=r(43),k=r(71),b=r(72),O=h.TypeError,S=h.process,w=h.Promise,F="process"==c(S),x=function(){},_=a=y.f,R=!!function(){try{var t=w.resolve(1),e=(t.constructor={})[r(3)("species")]=function(t){t(x,x)};return(F||"function"==typeof PromiseRejectionEvent)&&t.then(x)instanceof e}catch(t){}}(),T=function(t){var e;return!(!f(t)||"function"!=typeof(e=t.then))&&e},E=function(t,e){if(!t._n){t._n=!0;var r=t._c;P(function(){for(var o=t._v,a=1==t._s,n=0;r.length>n;)!function(e){var r,n,i=a?e.ok:e.fail,s=e.resolve,h=e.reject,u=e.domain;try{i?(a||(2==t._h&&I(t),t._h=1),!0===i?r=o:(u&&u.enter(),r=i(o),u&&u.exit()),r===e.promise?h(O("Promise-chain cycle")):(n=T(r))?n.call(r,s,h):s(r)):h(o)}catch(t){h(t)}}(r[n++]);t._c=[],t._n=!1,e&&!t._h&&M(t)})}},M=function(t){v.call(h,function(){var e,r,o,a=t._v,n=j(t);if(n&&(e=k(function(){F?S.emit("unhandledRejection",a,t):(r=h.onunhandledrejection)?r({promise:t,reason:a}):(o=h.console)&&o.error&&o.error("Unhandled promise rejection",a)}),t._h=F||j(t)?2:1),t._a=void 0,n&&e.e)throw e.v})},j=function(t){if(1==t._h)return!1;for(var e,r=t._a||t._c,o=0;r.length>o;)if(e=r[o++],e.fail||!j(e.promise))return!1;return!0},I=function(t){v.call(h,function(){var e;F?S.emit("rejectionHandled",t):(e=h.onrejectionhandled)&&e({promise:t,reason:t._v})})},C=function(t){var e=this;e._d||(e._d=!0,e=e._w||e,e._v=t,e._s=2,e._a||(e._a=e._c.slice()),E(e,!0))},A=function(t){var e,r=this;if(!r._d){r._d=!0,r=r._w||r;try{if(r===t)throw O("Promise can't be resolved itself");(e=T(t))?P(function(){var o={_w:r,_d:!1};try{e.call(t,u(A,o,1),u(C,o,1))}catch(t){C.call(o,t)}}):(r._v=t,r._s=1,E(r,!1))}catch(t){C.call({_w:r,_d:!1},t)}}};R||(w=function(t){p(this,w,"Promise","_h"),d(t),o.call(this);try{t(u(A,this,1),u(C,this,1))}catch(t){C.call(this,t)}},o=function(t){this._c=[],this._a=void 0,this._s=0,this._d=!1,this._v=void 0,this._h=0,this._n=!1},o.prototype=r(114)(w.prototype,{then:function(t,e){var r=_(m(this,w));return r.ok="function"!=typeof t||t,r.fail="function"==typeof e&&e,r.domain=F?S.domain:void 0,this._c.push(r),this._a&&this._a.push(r),this._s&&E(this,!1),r.promise},catch:function(t){return this.then(void 0,t)}}),n=function(){var t=new o;this.promise=t,this.resolve=u(A,t,1),this.reject=u(C,t,1)},y.f=_=function(t){return t===w||t===i?new n(t):a(t)}),l(l.G+l.W+l.F*!R,{Promise:w}),r(42)(w,"Promise"),r(115)("Promise"),i=r(13).Promise,l(l.S+l.F*!R,"Promise",{reject:function(t){var e=_(this);return(0,e.reject)(t),e.promise}}),l(l.S+l.F*(s||!R),"Promise",{resolve:function(t){return b(s&&this===i?w:this,t)}}),l(l.S+l.F*!(R&&r(116)(function(t){w.all(t).catch(x)})),"Promise",{all:function(t){var e=this,r=_(e),o=r.resolve,a=r.reject,n=k(function(){var r=[],n=0,i=1;g(t,!1,function(t){var s=n++,h=!1;r.push(void 0),i++,e.resolve(t).then(function(t){h||(h=!0,r[s]=t,--i||o(r))},a)}),--i||o(r)});return n.e&&a(n.v),r.promise},race:function(t){var e=this,r=_(e),o=r.reject,a=k(function(){g(t,!1,function(t){e.resolve(t).then(r.resolve,o)})});return a.e&&o(a.v),r.promise}})},function(t,e){t.exports=function(t,e,r,o){if(!(t instanceof e)||void 0!==o&&o in t)throw TypeError(r+": incorrect invocation!");return t}},function(t,e,r){var o=r(25),a=r(109),n=r(110),i=r(8),s=r(66),h=r(111),u={},c={},e=t.exports=function(t,e,r,l,f){var d,p,g,m,v=f?function(){return t}:h(t),P=o(r,l,e?2:1),y=0;if("function"!=typeof v)throw TypeError(t+" is not iterable!");if(n(v)){for(d=s(t.length);d>y;y++)if((m=e?P(i(p=t[y])[0],p[1]):P(t[y]))===u||m===c)return m}else for(g=v.call(t);!(p=g.next()).done;)if((m=a(g,P,p.value,e))===u||m===c)return m};e.BREAK=u,e.RETURN=c},function(t,e,r){var o=r(8);t.exports=function(t,e,r,a){try{return a?e(o(r)[0],r[1]):e(r)}catch(e){var n=t.return;throw void 0!==n&&o(n.call(t)),e}}},function(t,e,r){var o=r(21),a=r(3)("iterator"),n=Array.prototype;t.exports=function(t){return void 0!==t&&(o.Array===t||n[a]===t)}},function(t,e,r){var o=r(35),a=r(3)("iterator"),n=r(21);t.exports=r(13).getIteratorMethod=function(t){if(void 0!=t)return t[a]||t["@@iterator"]||n[o(t)]}},function(t,e){t.exports=function(t,e,r){var o=void 0===r;switch(e.length){case 0:return o?t():t.call(r);case 1:return o?t(e[0]):t.call(r,e[0]);case 2:return o?t(e[0],e[1]):t.call(r,e[0],e[1]);case 3:return o?t(e[0],e[1],e[2]):t.call(r,e[0],e[1],e[2]);case 4:return o?t(e[0],e[1],e[2],e[3]):t.call(r,e[0],e[1],e[2],e[3])}return t.apply(r,e)}},function(t,e,r){var o=r(5),a=r(70).set,n=o.MutationObserver||o.WebKitMutationObserver,i=o.process,s=o.Promise,h="process"==r(22)(i);t.exports=function(){var t,e,r,u=function(){var o,a;for(h&&(o=i.domain)&&o.exit();t;){a=t.fn,t=t.next;try{a()}catch(o){throw t?r():e=void 0,o}}e=void 0,o&&o.enter()};if(h)r=function(){i.nextTick(u)};else if(n){var c=!0,l=document.createTextNode("");new n(u).observe(l,{characterData:!0}),r=function(){l.data=c=!c}}else if(s&&s.resolve){var f=s.resolve();r=function(){f.then(u)}}else r=function(){a.call(o,u)};return function(o){var a={fn:o,next:void 0};e&&(e.next=a),t||(t=a,r()),e=a}}},function(t,e,r){var o=r(17);t.exports=function(t,e,r){for(var a in e)o(t,a,e[a],r);return t}},function(t,e,r){"use strict";var o=r(5),a=r(23),n=r(19),i=r(3)("species");t.exports=function(t){var e=o[t];n&&e&&!e[i]&&a.f(e,i,{configurable:!0,get:function(){return this}})}},function(t,e,r){var o=r(3)("iterator"),a=!1;try{var n=[7][o]();n.return=function(){a=!0},Array.from(n,function(){throw 2})}catch(t){}t.exports=function(t,e){if(!e&&!a)return!1;var r=!1;try{var n=[7],i=n[o]();i.next=function(){return{done:r=!0}},n[o]=function(){return i},t(n)}catch(t){}return r}},function(t,e,r){"use strict";var o=r(24),a=r(13),n=r(5),i=r(69),s=r(72);o(o.P+o.R,"Promise",{finally:function(t){var e=i(this,a.Promise||n.Promise),r="function"==typeof t;return this.then(r?function(r){return s(e,t()).then(function(){return r})}:t,r?function(r){return s(e,t()).then(function(){throw r})}:t)}})},function(t,e,r){"use strict";var o=r(24),a=r(43),n=r(71);o(o.S,"Promise",{try:function(t){var e=a.f(this),r=n(t);return(r.e?e.reject:e.resolve)(r.v),e.promise}})},function(t,e,r){"use strict";t.exports=r(120)},function(t,e,r){"use strict";function o(t){return t&&t.__esModule?t:{default:t}}function a(t){return new Promise(function(e,r){setTimeout(function(){e("timeout")},t)})}function n(t,e){var r=[],o=[],a=[];return!e||e&&0==e.length?{added:t,removed:o}:(t.forEach(function(t){var o=t.id?t.id.toString():t.locSpec;void 0===F.find(e,function(t){return!t.hasOwnProperty("id")&&t.hasOwnProperty("PhotoID")?t.id=t.PhotoID.toString():!t.hasOwnProperty("id")&&t.hasOwnProperty("allParams")&&t.allParams.hasOwnProperty("PhotoID")&&(t.id=t.allParams.PhotoID),t.id==o})?r.push(t):a.push(t)}),e.forEach(function(e){var r=e.hasOwnProperty("id")?e.id:e.PhotoID;!r&&e.hasOwnProperty("allParams")&&e.allParams.hasOwnProperty("PhotoID")&&(r=e.allParams.PhotoID),void 0===F.find(t,function(t){return t.id&&t.id==r||t.locSpec&&t.locSpec==r})&&o.push(e)}),{added:r,removed:o,same:a})}function i(t,e){var r={x:0,y:0,width:1,height:1},o=t.width/t.height,a=e.width/e.height;return o<=a?(r.width=1,r.height=t.width/a/t.height,r.y=(1-r.height)/2):(r.height=1,r.width=t.height*a/t.width,r.x=(1-r.width)/2),[r.x,r.y,r.x+r.width,r.y+r.height]}function s(t){t.FacesRank=t.hasOwnProperty("FacesRank")?t.FacesRank+10:10,t.BackgroundRank=t.hasOwnProperty("BackgroundRank")?t.BackgroundRank+10:10,t.Similarity1=100,t.Similarity2=100,t.DirectionSim=100,t.Texturesim=100,t.GroupFactor=t.hasOwnProperty("GroupFactor")?t.GroupFactor+10:10}function h(t){var e=0;return t.forEach(function(t){t.photos&&(e+=t.photos.length)}),e}function u(t){return t.filter(function(t){var e=!1;return t.allParams&&t.allParams.FacesArr&&t.allParams.FacesArr.length>0&&t.allParams.FacesArr.some(function(t){if(Math.max(t.FaceObj.Rect.height,t.FaceObj.Rect.width)>.05)return e=!0,!0}),e})}function c(){var t=window.location.href.toLowerCase(),e={},r=/\?([^#]+)/,o=/([^=]+)=([^&]*)(?:&(amp;)?|$)/gi,a=t.match(r),n="";for(a&&(n=a[1]);a=o.exec(n);)e[a[1]]=a[2];return e}var l=r(44),f=o(l),d=r(0),p=o(d),g=r(1),m=o(g),v=r(128),P=r(84),y=r(34),k=r(4),b=r(59),O=r(85),S=r(33),w=r(162),F=r(6),x=r(163),_=r(166),R=r(167),T=r(168),E=r(2),M=r(169),j=r(170).version,I=[],C=function(){function t(e){if((0,p.default)(this,t),this.debug=e&&void 0!==e.debugOptions?e.debugOptions:I,this.currentResult={result:!1},this.env=!(!e||void 0===e.env)&&e.env,console.log("started magicSdk v"+j+" with env: "+this.env),this.source=e&&void 0!==e.source?e.source:"unknown",this.useVips=!(!e||void 0===e.useVips)&&e.useVips,this.response,this.photosStrip=[],this.requestObj=!1,this.photos=[],this.rankVector=!1,this.userInfo={vips:[]},this.last={},this.select=!1,this.readyRakVectors=[],this.layouts,this.gotTimeout=!1,this.monitor=new T("v1",this.env,this.source,this.debug),this.feedback=new R("v1",this.env,this.monitor,this.debug),this.startTime=Date.now(),this.sentPhotos=[],this.inProcess=[],this.fakeRankPhotos=[],this.importantPhotos=[],this.startedAddPhotosLoop=!1,this.photosArrivedCallbacks=[],"undefined"!=typeof window){var r=c();r.hasOwnProperty("magicsdkdebug")&&r.magicsdkdebug&&(this.debug=["req","res"])}}return(0,m.default)(t,[{key:"addPhotos",value:function(t,e){var r=E.clone(t),o=this;t.hasOwnProperty("user")&&t.user.hasOwnProperty("vips")&&t.user.vips.length>0&&(o.useVips=!0,t.user.id=r.userId,o._addUserInfo(t.user));var a=o.monitor.addNewRequest("addPhotos"),i=void 0===r.timeout?1e3:r.timeout,s=r.photos,h=!(r.hasOwnProperty("migrated")&&!r.migrated),u=r.photos.length;return b(f.default.mark(function t(){var c,l,d,p,g,m;return f.default.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:E.debugPrint("addPhotos","got input: ",r,"req",o.debug),c=!1,l=!1,r.userId&&r.oauthToken||(l=!0),t.prev=4,s.forEach(function(t){t.id||t.locSpec||(c="missing photo id or locSpec"),l&&!t.locSpec&&(c="missing photo locSpec for anonymous user")}),d=n(s,o.photos),c?(E.debugPrint("Timing","addPhotos sending dummy promise",Date.now()-r.startTime,"time",o.debug),o.response=O.dummy(!0,c)):(o.last.photos=s.slice(0),o.sentPhotos=o.sentPhotos.concat(s),o.last.userId=r.userId,o.last.oauthToken=r.oauthToken,d.added&&Array.isArray(d.added)&&d.added.length>0&&(o.inProcess=o.inProcess.concat(d.added),o.inProcess=F.uniq(o.inProcess,function(t){return t.id?t.id:t.locSpec})),p=o._splitPhotosToChunks(d.added),g=[],p.forEach(function(t){var e={userId:r.userId,photos:t,env:o.env,oauthToken:r.oauthToken,timeout:i,currentResult:o.currentResult,migratedUser:h,allowOnDemand:!0};e.allowOnDemand=!("magicshop"===o.source||"crm"===o.source),g.push(y.getRanks(e))}),o.response=new Promise(function(t,e){Promise.all(g).then(function(e){var r=[],a=[],n={};e.forEach(function(t){t.photos&&(r=r.concat(t.photos)),t.inProcess&&t.inProcess.photoIds&&t.inProcess.photoIds.forEach(function(e){a.push({id:e.toString(),remainingTime:t.inProcess.remainingTime})})}),a=F.uniq(a,function(t){return t.id}),r.length>0&&(n.photos=E.mapParams(r),n.photos=n.photos.filter(function(t){return t.hasOwnProperty("BackgroundRank")||t.hasOwnProperty("FacesRank")}),0===n.photos.length&&delete n.photos),a.length>0&&(n.inProcess=E.mapParams(a)),E.debugPrint("Timing","time to add "+r.length+" photos:",Date.now()-o.startTime,"time",o.debug),t(n)}).catch(function(r){if(r.ErrorMsg&&r.origPhotos){var o=[];r.origPhotos.forEach(function(t){if(t&&t.url&&t.origWidth&&t.origHeight&&t.dateTaken&&(t.id||t.locSpec)){var e=t.id?t.id.toString():t.locSpec.toString();o.push({id:e,remainingTime:-1})}}),o.length>0?t({inProcess:o}):(console.log("MagicSDK no ranked photos found. requested: "+d.added.length+" photos"),e(r))}else e(r)})})),o.response.then(function(t){o.startedAddPhotosLoop||(r.migrated=h,o._runAddPhotosLoop(r)),E.debugPrint("addPhotos","got from GetRank: ",t,"res",o.debug);var i=[],c=t.photos?t.photos:[],l=c.slice();t&&t.inProcess&&(o.monitor.setOnDemandAddPhotosFlag(a,t.inProcess),o.last.photos.forEach(function(e){var r=e.id?e.id:e.locSpec,o=F.find(t.inProcess,function(t){return t.id==r});void 0!==o&&(e.gotTimeout=!0,e.addFakeRank=!0,-1==o.remainingTime&&(!e.locSpec||e.id||e.PhotoID||(e.id=e.locSpec),i.push(e),c.push(e)),l.push(e))})),t.addFakeRank=i,n(s,l).added.forEach(function(t){t.gotTimeout=!0,t.addFakeRank=!0,!t.locSpec||t.id||t.PhotoID||(t.id=t.locSpec),o.fakeRankPhotos.push(t),i.push(t)}),o._addPhotosToArray(t),o.response=!1,"function"==typeof e&&(t?e(null,t):e("ranking request timed out",null)),c.length>0&&o.monitor.finishAddPhotos(a,u,c)}).catch(function(t){E.debugPrint("Timing","addPhotos sending error response time",Date.now()-r.startTime,"time",o.debug),E.debugPrint("addPhotos","sending error response: ",t,"res",o.debug),o.response=!1,"function"==typeof e&&e(t,null)}),t.next=18;break;case 11:throw t.prev=11,t.t0=t.catch(4),a&&o.monitor.addErrorMessage(a),m=void 0,m=t.t0.message?t.t0.message:t.t0.ErrorMsg?t.t0.ErrorMsg:t.t0,"function"==typeof e&&e(m,null),m;case 18:return t.abrupt("return",o.response);case 19:case"end":return t.stop()}},t,this,[[4,11]])}))}},{key:"fitPhotoToWell",value:function(t,e){var r=E.clone(t),o=this,a=o.monitor.addNewRequest("fitPhotoToWell"),n=Date.now();r.startTime=n,r.funcName="fitWell",E.debugPrint("fitPhotoToWell","got input: ",t,"req",o.debug);var s=function(t,e){E.debugPrint("Timing","fitWell finished addPhotos",Date.now()-n,"time",o.debug),t.length>1&&(t=t.slice(0,1));var r=new v(o.env,o.debug),s={},h=!1;try{if(o.monitor.finishFitFunc(a,"addPhotos"),!e.rankVector){var u=new x(t),c=u.getRankVector();e.rankVector=new w(c.rankVector,t,c.photosStrip,c.groups),c.reuseThisSelection&&o.readyRakVectors.push(e.rankVector)}var l={wells:[{type:"image",height:100,width:100,x:0,y:0,rotation:0,zIndex:0}],width:e.well.width,height:e.well.height,id:1};o._fixRotatedPhotos(e.rankVector.rankVector,e);var f={photoId:t[0].id,well:e.well};f.photoScored=!t[0].allParams.IsFakeRank;var d=r.getProducts([l],t,e.rankVector),p=d.res.crop;f.crop=p,o.feedback.addSDKRes("fitWell",f),s={crop:p},E.debugPrint("fitPhotoToWell","sending response: ",s,"res",o.debug),o.monitor.finishFitFunc(a,"fitPhotos"),o.monitor.finishFitFunc(a,"total",1)}catch(t){t.message?s.error=t.message:t.ErrorMsg?s.error=t.ErrorMsg:s.error=t,h=t,o.monitor.addErrorMessage(a)}if(h){if(s={crop:[0,0,1,1]},e.photos[0].origWidth&&e.photos[0].origHeight){var g={width:e.photos[0].origWidth,height:e.photos[0].origHeight};s.crop=i(g,e.well)}E.debugPrint("Timing","fitWell finished sending to defaultCrop",Date.now()-e.startTime,"time",o.debug),E.debugPrint("fitPhotoToWell","sending response: ",s,"res",o.debug)}return s};try{if(!r.well)throw"missing well info";return r.photo&&(r.photos=[r.photo]),r.monitorKey=a,o._managePhotos(r,s,e)}catch(t){o.monitor.addErrorMessage(a);var h={crop:[0,0,1,1]};if(r.photos[0].origWidth&&r.photos[0].origHeight){var u={width:r.photos[0].origWidth,height:r.photos[0].origHeight};h=i(u,params.well)}return"function"==typeof e&&e(null,h),h}}},{key:"fitPhotoToWellFeedback",value:function(t,e){var r=this,o=E.clone(t);E.debugPrint("fitPhotoToWellFeedback","got input: ",o,"req",r.debug),r.feedback.addUserRes("fitWell",o),"function"==typeof e&&e("ok")}},{key:"fitPhotosToLayouts",value:function(t,e){var r=Date.now(),o=E.clone(t),a=this,n=a.monitor.addNewRequest("fitPhotosToLayouts");E.debugPrint("fitPhotosToLayouts","got input: ",t,"req",a.debug);var i=!!o.changeGroups&&o.changeGroups,s=!!o.allowDuplicates&&o.allowDuplicates;o.importantPhotos&&Array.isArray(o.importantPhotos)&&o.importantPhotos.length>0&&(a.importantPhotos=a.importantPhotos.concat(o.importantPhotos),a.inProcess=F.uniq(a.inProcess,function(t){return t}));var c=!!o.userData&&o.userData,l=!!o.onlyDetectedPhotos&&o.onlyDetectedPhotos,f=t.hasOwnProperty("doNotForce")&&t.doNotForce,d=function(t,e){E.debugPrint("Timing","fitPhotosToLayouts finished addPhotos",Date.now()-r,"time",a.debug),a.monitor.finishFitFunc(n,"addPhotos");var o=new v(a.env,a.debug,f),d={};try{if(l&&(t=u(t),0==t.length))throw"there're no photos with detection";if(!e.rankVector){var p=new x(t,a.userInfo,f),g=p.getRankVector();e.rankVector=new w(g.rankVector,t,g.photosStrip,g.groups,[],g.smartGroups),g.reuseThisSelection&&a.readyRakVectors.push(e.rankVector)}a._fixRotatedPhotos(e.rankVector.rankVector,e);var m={photos:e.rankVector.rankVector,layouts:E.clone(e.layouts)},P=o.getProducts(e.layouts,t,e.rankVector,i,s,a.source,c);P.res.onePhotoWell&&(P.res.layouts=[{id:P.res.id,photos:[{photoId:t[0].id,wellIndex:e.layouts[0].wells[0].wellIndex,crop:P.res.crop}]}]),d={layouts:P.res.layouts,photoStrip:P.photosStrip},m.result=d,a.feedback.addSDKRes("fitLayouts",m),a.monitor.finishFitFunc(n,"fitPhotos"),a.monitor.finishFitFunc(n,"total",h(d.layouts)),E.debugPrint("Timing","fitPhotosToLayouts finished all",Date.now()-r,"time",a.debug),E.debugPrint("fitPhotosToLayouts","sending response: ",d,"res",a.debug)}catch(t){throw a.monitor.addErrorMessage(n),E.debugPrint("fitPhotosToLayouts","sending error response: ",t,"res",a.debug),t.message?d.error=t.message:t.ErrorMsg?d.error=t.ErrorMsg:d.error=t,t}return d};try{return o.monitorKey=n,a._managePhotos(o,d,e)}catch(t){throw"function"==typeof e&&e(t,null),t}}},{key:"fitPhotosToLayoutsFeedback",value:function(t,e){var r=this,o=E.clone(t);E.debugPrint("fitPhotosToLayoutsFeedback","got input: ",o,"req",r.debug),r.feedback.addUserRes("fitLayouts",o),"function"==typeof e&&e("ok")}},{key:"adaptLayout",value:function(t,e){var r=E.clone(t),o=this,a=o.monitor.addNewRequest("adaptLayout");E.debugPrint("adaptLayout","got input: ",t,"req",o.debug);var n=Date.now(),i=function(t,e){o.monitor.finishFitFunc(a,"addPhotos");var r=new v(o.env,o.debug),i={};try{if(!e.rankVector){var s=new x(t),h=s.getRankVector();e.rankVector=new w(h.rankVector,t,h.photosStrip,h.groups),h.reuseThisSelection&&o.readyRakVectors.push(e.rankVector)}o._fixRotatedPhotos(e.rankVector.rankVector,e);var u=!!e.debugMode&&e.debugMode,c=r.adaptLayout(o.layouts,e.size,e.type,t,e.rankVector,e.sidePageLayout,u);i={layout:c.res.layouts[0],photoStrip:c.photosStrip},u&&(i={layouts:c.res.layouts,photoStrip:c.photosStrip}),o.monitor.finishFitFunc(a,"fitPhotos"),o.monitor.finishFitFunc(a,"total"),E.debugPrint("Timing","adaptLayout finished all",Date.now()-n,"time",o.debug),E.debugPrint("adaptLayout","sending response: ",i,"res",o.debug)}catch(t){throw o.monitor.addErrorMessage(a),t.message?i.error=t.message:t.ErrorMsg?i.error=t.ErrorMsg:i.error=t,t}return i};try{if(!r.layouts&&void 0===this.layouts||!r.layouts&&(!r.size||!r.type))throw"missing layouts/size/type";return r.size=r.size?r.size:r.layouts[0].size,r.type=r.type?r.type:r.layouts[0].type,r.layouts&&this.addLayouts(r),o._managePhotos(r,i,e)}catch(t){throw"function"==typeof e&&e(t,null),t}}},{key:"getHighlights",value:function(t,e){var r=t?E.clone(t):{},o=this,a=function(t,e){if(!e.rankVector){var r=new x(t),a=r.getRankVector(!0);e.rankVector=new w(a.rankVector,t,a.photosStrip,a.groups,a.clusters),a.reuseThisSelection&&o.readyRakVectors.push(e.rankVector)}var n=[];return e.rankVector.clusters.forEach(function(t){t.subClusters.forEach(function(t){t.goodForBestPhotos&&t.goodForBestPhotos.length>0&&t.goodForBestPhotos.forEach(function(t){n.push(t.id)})})}),{highlights:n}};try{return o._managePhotos(r,a,e)}catch(t){throw"function"==typeof e&&e(t,null),t}}},{key:"addLayouts",value:function(t,e){var r=this,o=E.clone(t);E.debugPrint("addLayouts","got input: ",o,"req",r.debug),void 0===this.layouts?r.layouts=new _(o.layouts,o.type,o.size):o.layouts.forEach(function(t){void 0===F.find(r.layouts.layouts[t.type][t.size],function(e){return e.id==t.id})&&r.layouts.addLayout(t,t.type,t.size)}),"function"==typeof e&&e("ok")}},{key:"_managePhotos",value:function(t,e,r){t.rankVector=!1,t.gotTimeout=!1,t.timeout?t.timeout-=50:t.timeout=4e4;var o=a(t.timeout),s=this;return t.hasOwnProperty("user")&&t.user.hasOwnProperty("vips")&&t.user.vips.length>0&&(s.useVips=!0,t.user.id=t.userId,s._addUserInfo(t.user)),new Promise(function(a,h){var u=function(n,u){if(t.photos=n,u&&u.length>0){var c=s.addPhotos({photos:u,selection:!1,timeout:t.timeout,userId:t.userId,oauthToken:t.oauthToken,startTime:t.startTime});t.hasOwnProperty("migrated")&&(c.migrated=t.migrated),Promise.race([c,o]).then(function(o){o&&"timeout"===o&&(E.debugPrint("_managePhotos","addPhotos got timeout. current photos result: ",s.currentResult.result,"timeout",s.debug),s._addPhotosToArray(s.currentResult.result));try{var i=e(s._getRelevantPhotos(n),t);i.error?("function"==typeof r&&r(i.error,null),h(i.error)):("function"==typeof r&&r(null,i),a(i))}catch(t){var u=void 0!==t.message?t.message:t;"function"==typeof r&&r(u,null),h(u)}}).catch(function(e){if(E.debugPrint("Timing","_managePhotos got res from addPhotos",Date.now()-t.startTime,"time",s.debug),t.funcName&&"fitWell"===t.funcName){var o={crop:[0,0,1,1]};if(E.debugPrint("fitPhotoToWell","got from addPhotos: ",e,"req",s.debug),t.photos[0].origWidth&&t.photos[0].origHeight){var n={width:t.photos[0].origWidth,height:t.photos[0].origHeight};o.crop=i(n,t.well)}E.debugPrint("Timing","fitWell finished sending to defaultCrop",Date.now()-t.startTime,"time",s.debug),"function"==typeof r&&r(null,o),E.debugPrint("fitPhotoToWell","sending response: ",o,"res",s.debug),a(o)}else"function"==typeof r&&r(e,null),h(e)})}else try{var l=e(s._getRelevantPhotos(n),t);l.error?("function"==typeof r&&r(l.error,null),h(l.error)):("function"==typeof r&&r(null,l),a(l))}catch(t){var f=void 0!==t.message?t.message:t;"function"==typeof r&&r(f,null),h(f)}};if(t.photos){var c=s._findRankVector(t.photos);if(c)t.rankVector=c,u(t.photos,null);else{var l=n(t.photos,s.photos),f=n(l.added,s.inProcess),d=!1;0===f.added.length?f.same&&f.same.length>0?(setTimeout(function(){E.debugPrint("_managePhotos","addPhotos internal got timeout ",{},"timeout",s.debug),d||(E.debugPrint("_managePhotos","calling returnFunc after timeout",{},"timeout",s.debug),d=!0,u(t.photos,null))},t.timeout),s.photosArrivedCallbacks.push(function(){E.debugPrint("_managePhotos","addPhotos internal got event ",{},"timeout",s.debug),l=n(t.photos,s.photos),0!=l.added||d||(E.debugPrint("_managePhotos","calling returnFunc after event",{},"timeout",s.debug),d=!0,u(t.photos,null))})):u(t.photos,null):u(t.photos,f.added)}}else if(s.last.photos){var p=s._findRankVector(s.last.photos,s.fakeRankPhotos);if(p)t.rankVector=p,u(s.last.photos,null);else{var g=n(s.last.photos,s.inProcess);0==g.added.length?g.same.length>0?setTimeout(function(){u(s.last.photos,null)},t.timeout):u(s.last.photos,null):u(s.last.photos,g.added)}}else"function"==typeof r&&r("send photos!",null),h("send photos!")})}},{key:"_raceFunction",value:function(t,e,r){var o=this;try{var a=Promise.race([o.response,t]);return a.then(function(t){if(e.userId=o.last.userId,e.oauthToken=o.last.oauthToken,t&&"timeout"==t)return console.log("MagicSDK reached timeout"),o._addPhotosToArray(o.currentResult.result),{photos:o.last.photos,added:null};var a=e.timeout-(Date.now()-r),i=n(o.last.photos,o.photos);return i.added.length>0&&a>0?(e.timeout=a,{photos:o.last.photos,added:i.added}):{photos:o.last.photos,added:null}}).catch(function(t){return{error:t}}),a}catch(t){throw t}}},{key:"_addPhotosToArray",value:function(t){var e=this;if(t){t.addFakeRank=void 0!==t.addFakeRank?t.addFakeRank:[];var r=t.photos?t.photos.concat(t.addFakeRank):t.addFakeRank;r.forEach(function(t){void 0===F.find(e.photos,function(e){return void 0!==t.id&&e.id==t.id.toString()||void 0!==t.PhotoID&&e.id==t.PhotoID.toString()})&&(e.importantPhotos&&(void 0!==t.id&&-1!=e.importantPhotos.indexOf(String(t.id))||void 0!==t.PhotoID&&-1!=e.importantPhotos.indexOf(String(t.PhotoID)))&&s(t),e.inProcess=F.reject(e.inProcess,function(e){return e.id=e.id?e.id:e.locSpec,void 0!==t.id&&e.id==t.id.toString()||void 0!==t.PhotoID&&e.id==t.PhotoID.toString()}),e.photos.push(new S(t)))}),r.length>0&&e.photosArrivedCallbacks.forEach(function(t){return t()}),E.debugPrint("_addPhotosToArray","photos length after adding: ",e.photos.length,"timeout",e.debug),E.debugPrint("_addPhotosToArray","inProcess length after adding: ",e.inProcess.length,"timeout",e.debug)}}},{key:"_getRelevantPhotos",value:function(t){var e=[],r=[],o=this,a=E.clone(this.photos);return t.forEach(function(t){var n=t.id?t.id.toString():t.locSpec,i=a.findIndex(function(t){return t.id.toString()===n}),s=a[i];if(void 0===s||s.gotTimeout||s.allParams&&s.allParams.gotTimeout){var h=t.allParams?t.allParams:t;h.PhotoID=h.PhotoID?h.PhotoID:n,h.addFakeRank=!0,h.origUrl=t.url,h.Vips=[],h.VipsPer=0,r.push(new S(h))}else{var u=s.allParams?s.allParams:s;u.addFakeRank=!1,u.origUrl=t.url;var c=o._addVipsToPhoto(u);u.Vips=c.vips,u.Kids=c.kids,u.VipsPer=u.Vips.length/o.userInfo.vips.length,e.push(new S(u)),a.splice(i,1)}}),e.length<15&&(e=e.concat(r)),k.sortPhotosByDate(e),e}},{key:"_getRankVector",value:function(t){try{this.select=new P(t),this.select.activateSelection(!1,"",!1)}catch(t){throw t}}},{key:"_buildPhotoStripArr",value:function(){var t=this;this.photosStrip=[],this.rankVector.forEach(function(e){var r={photoId:e.id,url:e.allParams.Url};t.photosStrip.push(r)})}},{key:"_findRankVector",value:function(t){var e=this,r=!1;return this.readyRakVectors.some(function(o){if(o.isVector(t,e.fakeRankPhotos))return r=o,!0}),r}},{key:"_splitPhotosToChunks",value:function(t){for(var e=[],r=0;r<t.length;r+=250)e.push(t.slice(r,r+250));return e}},{key:"_fixRotatedPhotos",value:function(t,e){t.forEach(function(t){t.allParams.notRotatedSize&&(t.allParams.OrigWidth=t.allParams.notRotatedSize.width,t.allParams.OrigHeight=t.allParams.notRotatedSize.height);var r=F.find(e.photos,function(e){return e.id==t.id});if(r&&r.hasOwnProperty("userRotation")){if(t.allParams.origUrl&&!t.allParams.IsFakeRank){var o=t.allParams.origUrl.indexOf("&rotation=");if(-1!=o){for(var a="",n=o+10;"&"!=t.allParams.origUrl[n];)a+=t.allParams.origUrl[n],n++;r.userRotation<Number(a)&&(r.userRotation+=360),r.userRotation-=Number(a)}}var i=t.allParams.OrigWidth,s=t.allParams.OrigHeight;switch(r.userRotation.toString()){case"90":case"270":t.allParams.OrigWidth=s,t.allParams.OrigHeight=i}}})}},{key:"getSelection",value:function(t){var e=E.clone(t),r=this,o=void 0,a=void 0===e.timeout?12e4:e.timeout,n=void 0!==e.onlyHighlights&&e.onlyHighlights,i=e.photos,s=!(e.hasOwnProperty("migrated")&&!e.migrated);E.debugPrint("getSelection","got input: ",t,"req",r.debug);var h={id:e.userId};return t.hasOwnProperty("user")&&t.user.hasOwnProperty("vips")&&t.user.vips.length>0&&(r.useVips=!0,h=t.user,h.id=t.userId),r._addUserInfo(h),new Promise(function(t,h){console.log("getSelection called");var u=!1,c=!1;e.userId&&e.oauthToken||(c=!0);try{if(i.forEach(function(t){t.id||t.locSpec||(u="missing photo id or locSpec"),c&&!t.locSpec&&(u="missing photo locSpec for anonymous user")}),u)o=O.dummy(!0,u);else{var l={userId:e.userId,photos:i,env:r.env,oauthToken:e.oauthToken,timeout:a,currentResult:{},migratedUser:s};o=y.getRanks(l)}o.then(function(e){if(!e)return"err";var o=[];e&&e.photos&&e.photos.forEach(function(t){t.addFakeRank=!1,o.push(new S(t))}),i.forEach(function(t){var r=t.id?t.id.toString():t.locSpec;e&&e.photos&&void 0===F.find(e.photos,function(t){return t.PhotoID==r})?(t.addFakeRank=!0,t.PhotoID=r,o.push(new S(t))):e.photos||(t.addFakeRank=!0,t.PhotoID=r,o.push(new S(t)))});try{o.forEach(function(t){var e=r._addVipsToPhoto(t.allParams);t.allParams.Vips=e.vips,t.allParams.Kids=e.kids,t.allParams.VipsPer=r.userInfo&&r.userInfo.vips&&r.userInfo.vips.length>0?t.allParams.Vips.length/r.userInfo.vips.length:0})}catch(t){}var a=new x(o),s=void 0;s=n?a.getRankVector(!0):a.getRankVector();var h=new w(s.rankVector,i,s.photosStrip,s.groups);if(h.clusters=s.clusters,n){var u=[];h.clusters.forEach(function(t){t.subClusters.forEach(function(t){if(t.goodForBestPhotos&&t.goodForBestPhotos.length>0){var e=[];t.goodForBestPhotos.forEach(function(t){e.push(t.id)}),u.push({photos:e})}})}),E.debugPrint("getSelection","sending result: ",{clustersHighlights:u},"res",r.debug),t({clustersHighlights:u})}else h.ranks=h.rankPhotos(),h.smartGroups=a.smartGroups,E.debugPrint("getSelection","sending result: ",h,"res",r.debug),t(h)}).catch(function(t){"function"==typeof callback&&callback(t),h("err")})}catch(t){var f=void 0;return f=t.message?t.message:t.ErrorMsg?t.ErrorMsg:t,h("err"),"function"==typeof callback&&callback(f),f}"function"==typeof callback&&callback()})}},{key:"getPrints",value:function(t,e){var r=E.clone(t),o=this,a=o.monitor.addNewRequest("getPrints"),n=Date.now();E.debugPrint("getPrints","got input: ",t,"req",o.debug);var i=function(t,r){E.debugPrint("Timing","getPrints finished addPhotos",Date.now()-n,"time",o.debug),o.monitor.finishFitFunc(a,"addPhotos");var i=(r.minPhotos&&r.minPhotos,r.maxPhotos&&r.maxPhotos<t.length?r.maxPhotos:t.length),s={},h=!1;try{if(!r.rankVector){var u=new x(t),c=u.getRankVector();r.rankVector=new w(c.rankVector,t,c.photosStrip,c.groups),c.reuseThisSelection&&o.readyRakVectors.push(r.rankVector)}k.sortBestAndRank(r.rankVector.rankVector);for(var l=[],f=[],d=0;d<Math.min(i,r.rankVector.rankVector.length);d++){l.push(r.rankVector.rankVector[d].id);var p={photoId:r.rankVector.rankVector[d].id,url:r.rankVector.rankVector[d].allParams.Url,orientation:r.rankVector.rankVector[d].allParams.OrigHeight>r.rankVector.rankVector[d].allParams.OrigWidth?"portrait":"landscape"};f.push(p)}s={prints:l,photoStrip:f},o.monitor.finishFitFunc(a,"total"),E.debugPrint("Timing","getPrints finished all",Date.now()-n,"time",o.debug),E.debugPrint("getPrints","sending response: ",s,"res",o.debug)}catch(t){t.message?s.error=t.message:t.ErrorMsg?s.error=t.ErrorMsg:s.error=t,h=t,o.monitor.addErrorMessage(a)}return"function"==typeof e&&(h||e(null,s)),s};try{var s=o._managePhotos(r,i);return s.catch(function(t){"function"==typeof e&&e(t,null)}),s}catch(t){throw"function"==typeof e&&e(t,null),t}}},{key:"testSelection",value:function(){if(this.testPhotos){var t=[];this.testPhotos.forEach(function(e){t.push(new S(e))}),new P(t).activateSelection(!1,"",!1)}else new P(this.photos).activateSelection(!1,"",!1)}},{key:"_runAddPhotosLoop",value:function(t){function e(t){setTimeout(function(){E.debugPrint("_runAddPhotosLoop","sleeping for 30 sec. inProcess photos: ",r.inProcess,"timeout",r.debug),r.inProcess.length>0?(a.photos=r.inProcess,E.debugPrint("_runAddPhotosLoop","running addPhotos for photos: ",r.inProcess,"timeout",r.debug),r.addPhotos(a).then(function(t){e(o)}).catch(function(t){e(o)})):r.startedAddPhotosLoop=!1},t)}var r=this;r.startedAddPhotosLoop=!0;var o=3e4,a={photos:r.inProcess,selection:!1,timeout:10,userId:t.userId,oauthToken:t.oauthToken,migrated:t.migrated};e(o)}},{key:"_addUserInfo",value:function(t){this.useVips=!0,this.userInfo.hasOwnProperty("userId")&&this.userInfo.userId===t.id||(this.userInfo=new M({userId:t.id,env:this.env,vips:t.vips}))}},{key:"_addVipsToPhoto",value:function(t){var e=[],r=[],o=this;return o.useVips&&o.userInfo.vips.length>0&&t.hasOwnProperty("FacesArr")&&Array.isArray(t.FacesArr)&&t.FacesArr.length>0&&t.FacesArr.forEach(function(t){t.hasOwnProperty("PersonRecIndex1")&&0!==t.PersonRecIndex1&&o.userInfo.vipsObj.hasOwnProperty(t.PersonRecIndex1)&&(e.push(t.PersonRecIndex1),F.contains(o.userInfo.kids,t.PersonRecIndex1)&&r.push(t.PersonRecIndex1))}),{vips:e,kids:r}}}],[{key:"test",value:function(t){return(new v).test(t)}},{key:"getScore",value:function(){return console.log("getScore called"),"MagicSDK"+this.test()}}]),t}();t.exports=C},function(t,e,r){var o=function(){return this}()||Function("return this")(),a=o.regeneratorRuntime&&Object.getOwnPropertyNames(o).indexOf("regeneratorRuntime")>=0,n=a&&o.regeneratorRuntime;if(o.regeneratorRuntime=void 0,t.exports=r(122),a)o.regeneratorRuntime=n;else try{delete o.regeneratorRuntime}catch(t){o.regeneratorRuntime=void 0}},function(t,e){!function(e){"use strict";function r(t,e,r,o){var n=e&&e.prototype instanceof a?e:a,i=Object.create(n.prototype),s=new d(o||[]);return i._invoke=u(t,r,s),i}function o(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(t){return{type:"throw",arg:t}}}function a(){}function n(){}function i(){}function s(t){["next","throw","return"].forEach(function(e){t[e]=function(t){return this._invoke(e,t)}})}function h(t){function e(r,a,n,i){var s=o(t[r],t,a);if("throw"!==s.type){var h=s.arg,u=h.value;return u&&"object"==typeof u&&P.call(u,"__await")?Promise.resolve(u.__await).then(function(t){e("next",t,n,i)},function(t){e("throw",t,n,i)}):Promise.resolve(u).then(function(t){h.value=t,n(h)},i)}i(s.arg)}function r(t,r){function o(){return new Promise(function(o,a){e(t,r,o,a)})}return a=a?a.then(o,o):o()}var a;this._invoke=r}function u(t,e,r){var a=F;return function(n,i){if(a===_)throw new Error("Generator is already running");if(a===R){if("throw"===n)throw i;return g()}for(r.method=n,r.arg=i;;){var s=r.delegate;if(s){var h=c(s,r);if(h){if(h===T)continue;return h}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(a===F)throw a=R,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);a=_;var u=o(t,e,r);if("normal"===u.type){if(a=r.done?R:x,u.arg===T)continue;return{value:u.arg,done:r.done}}"throw"===u.type&&(a=R,r.method="throw",r.arg=u.arg)}}}function c(t,e){var r=t.iterator[e.method];if(r===m){if(e.delegate=null,"throw"===e.method){if(t.iterator.return&&(e.method="return",e.arg=m,c(t,e),"throw"===e.method))return T;e.method="throw",e.arg=new TypeError("The iterator does not provide a 'throw' method")}return T}var a=o(r,t.iterator,e.arg);if("throw"===a.type)return e.method="throw",e.arg=a.arg,e.delegate=null,T;var n=a.arg;return n?n.done?(e[t.resultName]=n.value,e.next=t.nextLoc,"return"!==e.method&&(e.method="next",e.arg=m),e.delegate=null,T):n:(e.method="throw",e.arg=new TypeError("iterator result is not an object"),e.delegate=null,T)}function l(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function f(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function d(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(l,this),this.reset(!0)}function p(t){if(t){var e=t[k];if(e)return e.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var r=-1,o=function e(){for(;++r<t.length;)if(P.call(t,r))return e.value=t[r],e.done=!1,e;return e.value=m,e.done=!0,e};return o.next=o}}return{next:g}}function g(){return{value:m,done:!0}}var m,v=Object.prototype,P=v.hasOwnProperty,y="function"==typeof Symbol?Symbol:{},k=y.iterator||"@@iterator",b=y.asyncIterator||"@@asyncIterator",O=y.toStringTag||"@@toStringTag",S="object"==typeof t,w=e.regeneratorRuntime;if(w)return void(S&&(t.exports=w));w=e.regeneratorRuntime=S?t.exports:{},w.wrap=r;var F="suspendedStart",x="suspendedYield",_="executing",R="completed",T={},E={};E[k]=function(){return this};var M=Object.getPrototypeOf,j=M&&M(M(p([])));j&&j!==v&&P.call(j,k)&&(E=j);var I=i.prototype=a.prototype=Object.create(E);n.prototype=I.constructor=i,i.constructor=n,i[O]=n.displayName="GeneratorFunction",w.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===n||"GeneratorFunction"===(e.displayName||e.name))},w.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,i):(t.__proto__=i,O in t||(t[O]="GeneratorFunction")),t.prototype=Object.create(I),t},w.awrap=function(t){return{__await:t}},s(h.prototype),h.prototype[b]=function(){return this},w.AsyncIterator=h,w.async=function(t,e,o,a){var n=new h(r(t,e,o,a));return w.isGeneratorFunction(e)?n:n.next().then(function(t){return t.done?t.value:n.next()})},s(I),I[O]="Generator",I[k]=function(){return this},I.toString=function(){return"[object Generator]"},w.keys=function(t){var e=[];for(var r in t)e.push(r);return e.reverse(),function r(){for(;e.length;){var o=e.pop();if(o in t)return r.value=o,r.done=!1,r}return r.done=!0,r}},w.values=p,d.prototype={constructor:d,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=m,this.done=!1,this.delegate=null,this.method="next",this.arg=m,this.tryEntries.forEach(f),!t)for(var e in this)"t"===e.charAt(0)&&P.call(this,e)&&!isNaN(+e.slice(1))&&(this[e]=m)},stop:function(){this.done=!0;var t=this.tryEntries[0],e=t.completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){function e(e,o){return n.type="throw",n.arg=t,r.next=e,o&&(r.method="next",r.arg=m),!!o}if(this.done)throw t;for(var r=this,o=this.tryEntries.length-1;o>=0;--o){var a=this.tryEntries[o],n=a.completion;if("root"===a.tryLoc)return e("end");if(a.tryLoc<=this.prev){var i=P.call(a,"catchLoc"),s=P.call(a,"finallyLoc");if(i&&s){if(this.prev<a.catchLoc)return e(a.catchLoc,!0);if(this.prev<a.finallyLoc)return e(a.finallyLoc)}else if(i){if(this.prev<a.catchLoc)return e(a.catchLoc,!0)}else{if(!s)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return e(a.finallyLoc)}}}},abrupt:function(t,e){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&P.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var a=o;break}}a&&("break"===t||"continue"===t)&&a.tryLoc<=e&&e<=a.finallyLoc&&(a=null);var n=a?a.completion:{};return n.type=t,n.arg=e,a?(this.method="next",this.next=a.finallyLoc,T):this.complete(n)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),T},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),f(r),T}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.tryLoc===t){var o=r.completion;if("throw"===o.type){var a=o.arg;f(r)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(t,e,r){return this.delegate={iterator:p(t),resultName:e,nextLoc:r},"next"===this.method&&(this.arg=m),T}}}(function(){return this}()||Function("return this")())},function(t,e,r){t.exports={default:r(124),__esModule:!0}},function(t,e,r){r(125);var o=r(27).Object;t.exports=function(t,e,r){return o.defineProperty(t,e,r)}},function(t,e,r){var o=r(45);o(o.S+o.F*!r(10),"Object",{defineProperty:r(9).f})},function(t,e,r){var o=r(127);t.exports=function(t,e,r){if(o(t),void 0===e)return t;switch(r){case 1:return function(r){return t.call(e,r)};case 2:return function(r,o){return t.call(e,r,o)};case 3:return function(r,o,a){return t.call(e,r,o,a)}}return function(){return t.apply(e,arguments)}}},function(t,e){t.exports=function(t){if("function"!=typeof t)throw TypeError(t+" is not a function!");return t}},function(t,e,r){"use strict";function o(t){return t&&t.__esModule?t:{default:t}}var a=r(0),n=o(a),i=r(1),s=o(i),h=r(2),u=r(4),c=r(82),l=r(6),f=r(33),d=r(83),p=r(158),g=r(159),m=function(){function t(e,r,o){(0,n.default)(this,t),this.photos=[],this.layouts=[],this.env=e,this.groups=[],this.rankVector=[],this.forceCreate=!1,this.sortedPhotos=!1,this.photosStrip=[],this.clusters=[],this.photosJson={},this.changeGroups=!1,this.countPhotos={},this.countPhotosInLayout={},this.allowDuplicates=!1,this.response={layouts:[]},this.isMagicShop=!1,this.textTemplate=new g,this.userData,this.startTime=Date.now(),this.debug=r,this.smartGroups={},this.doNotForce=o}return(0,s.default)(t,[{key:"adaptLayout",value:function(t,e,r,o,a,n,i){var s=this,h=t.GetLayouts(r,e,n),c=this;try{c._init(o,a,h),c._makeProducts(!0),u.sortLayoutsByRank(this.layouts),i?this.layouts.forEach(function(t){c._createLayoutFromBestMatch(t,t.bestMatchIndexes)}):(this.layouts.splice(1,this.layouts.length-1),this.response.id=this.layouts[0].id,c._createLayoutFromBestMatch(this.layouts[0],this.layouts[0].bestMatchIndexes)),c._buildFinalObject(),i&&this.layouts.forEach(function(t){var e=l.find(s.response.layouts,function(e){return e.id==t.id});"undefined"!=e&&(e.rank=t.rank)})}catch(t){throw t}return{res:c.response,photosStrip:c.photosStrip,rankVector:c.rankVector}}},{key:"getProducts",value:function(t,e,r,o,a,n,i){i&&(this.userData=i),this.response.id=t[0].id;var s=this;h.debugPrint("Timing","running getProducts:",Date.now()-this.startTime,"time",s.debug),s.changeGroups=o||s.changeGroups,s.allowDuplicates=a||s.allowDuplicates,s.isMagicShop="magicshop"===n||s.changeGroups&&"number"==typeof s.changeGroups;try{s._init(e,r,t),1===t.length&&1===t[0].wells.length&&1===e.length?(this.photos=this.rankVector,s._fitPhotoToWell(),h.debugPrint("Timing","end of fitting:",Date.now()-this.startTime,"time",s.debug),s.response.onePhotoWell=!0,this.photosStrip=r.photosStrip):(s._makeProducts(),h.debugPrint("Timing","end of fitting:",Date.now()-this.startTime,"time",s.debug),s._buildFinalObject())}catch(t){throw t}return{res:s.response,photosStrip:s.photosStrip,rankVector:s.rankVector}}},{key:"_init",value:function(t,e,r){try{if(!(r&&Array.isArray(r)&&r.length>0))throw"missing layouts info";this.layouts=r,this.photos=this._copyPhotosToWorkOn(t),this.rankVector=this._copyPhotosToWorkOn(e.rankVector),this.photosStrip=e.photosStrip,this.groups=e.groups.slice(0),this.smartGroups=e.smartGroups}catch(t){throw t}}},{key:"_fitPhotoToWell",value:function(){var t=(new p({groups:this.groups,sortedPhotos:this.photos,changeGroups:this.changeGroups,debug:this.debug}),this.layouts[0]);t.layoutObj=new c(t);var e=t.layoutObj.getBigPhotosObj()?t.layoutObj.getBigPhotosObj():[],r=p.fitOnePhotoToWell(e[0],this.photos[0],.05);if(0==r.x&&0==r.y&&1==r.width&&1==r.height){var o=this.photos[0].allParams.OrigWidth/this.photos[0].allParams.OrigHeight,a=e[0].wPt/e[0].hPt;o<=a?(r.width=1,r.height=this.photos[0].allParams.OrigWidth/a/this.photos[0].allParams.OrigHeight,r.y=(1-r.height)/2):(r.height=1,r.width=this.photos[0].allParams.OrigHeight*a/this.photos[0].allParams.OrigWidth,r.x=(1-r.width)/2)}var n={x1:h.round2(r.x),y1:h.round2(1-(r.y+r.height)),x2:h.round2(r.x+r.width),y2:h.round2(1-r.y)};n.x1<0&&(n.x1=0),n.x1>1&&(n.x1=1),n.y1<0&&(n.y1=0),n.y1>1&&(n.y1=1),n.x2<0&&(n.x2=0),n.x2>1&&(n.x2=1),n.y2<0&&(n.y2=0),n.y2>1&&(n.y2=1),this.response.crop=[],this.response.crop.push(n.x1),this.response.crop.push(n.y1),this.response.crop.push(n.x2),this.response.crop.push(n.y2)}},{key:"_copyPhotosToWorkOn",value:function(t){return t.map(function(t){return new f(t.allParams)})}},{key:"_makeProducts",value:function(t){var e=this;this._getSortedPhotos();var r={},o=!!this.changeGroups&&{},a=this.layouts.length;"number"==typeof this.changeGroups&&(this.groups=h.randomGroups(this.groups,this.changeGroups));var n=new p({groups:this.groups,sortedPhotos:this.sortedPhotos,changeGroups:this.changeGroups,smartGroups:this.smartGroups,debug:this.debug,doNotForce:this.doNotForce}),i={},s={},l={},g=this.layouts.every(function(t){return t.hasOwnProperty("group")}),m=0;g&&(this.layouts.sort(function(t,e){return t.group-e.group}),m=this.layouts[0].group),this.layouts.forEach(function(h){h.layoutObj=new c(h);var p=h.layoutObj.numOfPhotos.toString();s.hasOwnProperty(p)||(s[p]=0);var v=e.smartGroups&&e.smartGroups.hasOwnProperty("up"+p)&&e.smartGroups["up"+p].length>0?e.smartGroups["up"+p].slice(0):[],P=e.doNotForce?v:v.concat(e.groups);if(0===P.length)return void(h.layoutObj.notGenerated="unable to create good product");if(g&&e.changeGroups&&m!==h.group&&(m=h.group,r={},o={},i={}),!l.hasOwnProperty(p)||P[s[p]].ID!==l[p].ID&&e.changeGroups){var y=new f(P[s[p]].mainPhotos[0].allParams);l[p]=new d(y),l[p].addPhoto(y),P[s[p]].isSmart&&(l[p].ID=P[s[p]].ID,l[p].isSmart=!0),l[p].fromIndex=y.PosInPhotosArr-1,l[p].toIndex=y.PosInPhotosArr+1,l[p].mainPhotos=P[s[p]].mainPhotos,l[p].photos=e.sortedPhotos,l[p].addGroupRank()}Date.now(),e.countPhotosInLayout[h.id]={};var k=null,b=-1e12,O=null,S=!1,w=void 0;e.forceCreate=!e.doNotForce&&e._getMaxGroupLength()<h.layoutObj.cnsObj.NumBig+h.layoutObj.cnsObj.NumSmall;var F=[];if(P.some(function(t){if(!i[t.ID]||!e.isMagicShop){!r[t.ID]&&e.changeGroups&&(r[t.ID]=0,t.photos.forEach(function(t){o[t.id]||(o[t.id]=0)})),e._getSortedPhotos();var a=n.matchLayoutPhotoGroup(h.layoutObj,t,e.forceCreate,o);if(a&&(e.changeGroups&&(a.isOnePhoto=1===h.layoutObj.numOfPhotos,F.push({id:t.ID,res:a})),a.rank>b?(b=a.rank,k=a.matchIndexes,O=t.ID,i[t.ID]=!0):a.rank===b&&(r[O]>r[t.ID]||t.rank>w)&&(b=a.rank,k=a.matchIndexes,O=t.ID,w=t.rank,i[t.ID]=!0),a.isGroupLayout&&(S=!0),e.isMagicShop)){if(e.changeGroups&&a.isOnePhoto){var s=Object.keys(a.matchIndexes)[0];o[a.matchIndexes[s].id]||(o[a.matchIndexes[s].id]=0),o[a.matchIndexes[s].id]++}return!0}}}),!S&&!e.doNotForce){!r[l[p].ID]&&e.changeGroups&&(r[l[p].ID]=0,l[p].photos.forEach(function(t){o[t.id]||(o[t.id]=0)})),e._getSortedPhotos();var x=n.matchLayoutPhotoGroup(h.layoutObj,l[p],!1,o);if(x||(x=n.matchLayoutPhotoGroup(h.layoutObj,l[p],!0,o),x.rank=.5*x.rank),x){if(e.changeGroups){if(x.isOnePhoto=1===h.layoutObj.numOfPhotos,F.push({id:l[p].ID,res:x}),x.isOnePhoto&&e.isMagicShop){var _=Object.keys(x.matchIndexes)[0];o[x.matchIndexes[_].id]||(o[x.matchIndexes[_].id]=0),o[x.matchIndexes[_].id]++}(x.rank>b||x.rank===b&&(r[O]>r[l[p].ID]||l[p].rank>w))&&++s[p]>=P.length&&(s[p]=0)}x.rank>b?(b=x.rank,k=x.matchIndexes,O=l[p].ID):x.rank==b&&(r[O]>r[l[p].ID]||l[p].rank>w)&&(b=x.rank,k=x.matchIndexes,O=l[p].ID,w=l[p].rank)}}if(k){if(e.changeGroups&&!e.isMagicShop){u.sortFitOptionsByRank(F);var R={};R=e._shuffleGroups(F,a,.01,r,o),R||(R=e._shuffleGroups(F,a,.1,r,o)),R||(R=e._shuffleGroups(F,a,.3,r,o)),R&&(k=R.res.matchIndexes,O=R.id);var T=e._getResFromResOptions(F,O);T&&T.isGroupLayout&&r[O]++,T&&T.isOnePhoto&&o[e._getPhotoFromMatch(k).id]++}t?(h.rank=b,h.bestMatchIndexes=k):e._createLayoutFromBestMatch(h,k)}else h.layoutObj.notGenerated="unable to create good product"})}},{key:"_createLayoutFromBestMatch",value:function(t,e){var r=this,o=t.layoutObj.cnsObj.wellsObj;u.sortLayoutWellSize(o);var a=[];o.forEach(function(o){if(!o.t&&!o.e&&!o.b&&e[o.i]){var n=e[o.i];r.allowDuplicates||r._checkAllowedDuplicated(n,t.id)?r._setFinalCropToWell(n,o):(a.push(o),o.isEmpty=!0)}}),a.length>0&&Object.keys(this.countPhotosInLayout[t.id]).forEach(function(e){r.countPhotosInLayout[t.id][e]--,r.countPhotosInLayout[t.id][e]>0&&a.forEach(function(o){o.isEmpty&&h.checkOrientation(r.photosJson[e],o)&&r.countPhotosInLayout[t.id][e]>0&&(r._setFinalCropToWell(r.photosJson[e],o),r.countPhotosInLayout[t.id][e]--,o.isEmpty=!1)}),r.countPhotosInLayout[t.id][e]>0&&a.forEach(function(o){o.isEmpty&&r.countPhotosInLayout[t.id][e]>0&&(r._setFinalCropToWell(r.photosJson[e],o),r.countPhotosInLayout[t.id][e]--,o.isEmpty=!1)})})}},{key:"_setFinalCropToWell",value:function(t,e){e.photo=t;var r={val:0},o=null;if(p.checkForObjectsIfNoFaces(t),o=t.cropPhotoInWell(e.wPt,e.hPt,e.ex,e.ey,e.ew,e.eh,.05,!1,!0),o||(o=t.getMinCropWithin(e.wPt,e.hPt,null,r,!0)),!o||0==o.x&&0==o.y&&1==o.width&&1==o.height){o={x:0,y:0,width:1,height:1};var a=t.allParams.OrigWidth/t.allParams.OrigHeight,n=e.wPt/e.hPt;a<=n?(o.width=1,o.height=t.allParams.OrigWidth/n/t.allParams.OrigHeight,o.y=(1-o.height)/2):(o.height=1,o.width=t.allParams.OrigHeight*n/t.allParams.OrigWidth,o.x=(1-o.width)/2)}e.crop=o}},{key:"_checkAllowedDuplicated",value:function(t,e){var r=this,o=t.id;return this.photosJson[o]||(this.photosJson[o]=t),void 0!=this.countPhotos[o]?void 0!=this.countPhotosInLayout[e][o]?--this.countPhotosInLayout[e][o]>0:(this.countPhotosInLayout[e][o]=this.countPhotos[o],!0):(this.countPhotos[o]=0,this.photos.forEach(function(t){t.id==o&&r.countPhotos[o]++}),this.countPhotosInLayout[e][o]=this.countPhotos[o],!0)}},{key:"_shuffleGroups",value:function(t,e,r,o,a){var n=this,i=!1;return t.some(function(t){if(t.res.isGroupLayout&&o[t.id]<=r*e||t.res.isOnePhoto&&a[n._getPhotoFromMatch(t.res.matchIndexes).id]<=r*e||!t.res.isOnePhoto&&!t.res.isGroupLayout)return i=t,!0}),!!(i&&i.res.rank>=0)&&i}},{key:"_getPhotoFromMatch",value:function(t){return t[Object.keys(t)[0]]}},{key:"_getResFromResOptions",value:function(t,e){var r=!1;return t.forEach(function(t){e==t.id&&(r=t.res)}),r}},{key:"_sortAndAddCandidates",value:function(t,e,r,o,a,n){u.sortBestAndRank(t),t.forEach(function(t){r.val>0&&(o.push(t),t.NumOfMgAppear++,e[t.id]=!0,r.val--,a[t.id]&&n.push(t.id))})}},{key:"_getSortedPhotos",value:function(){this.sortedPhotos||(this.sortedPhotos=this.rankVector.slice(0),u.sortBestAndRank(this.sortedPhotos))}},{key:"_fitPhotosToWells",value:function(t,e,r){if(0==e.length)return!1;var o={},a=[];e.forEach(function(e,n){t.forEach(function(t,i){var s={val:0};e.getBestCropWithin(t.wPt,t.hPt,null,s,!0,t.ex,t.ey,t.ew,t.eh,.8,null,!0,r)?(o[n]||(o[n]=[]),o[n].push(i)):(a[s.val]||(a[s.val]={}),a[s.val][i]||(a[s.val][i]=[]),a[s.val][i].push(n))})});var n=u.sortJsonMatchingWellFromLowToHigh(o),i={};n.forEach(function(t){var e=t[0];o[e].some(function(t){return!i[t]&&(i[t]=e,!0)})});var s=0;t.length>Object.keys(i).length&&a.forEach(function(t,e){Object.keys(t).forEach(function(r){var o=t[r];i[r]&&o.forEach(function(t){-1==h.objectValues(i).indexOf(t)&&(i[r]=t,s+=e)})})});var c=[];return t.forEach(function(t,e){i.hasOwnProperty(e)||c.push(t)}),c.length!=t.length&&{photosOrder:i,miss:s,emptyWells:c}}},{key:"_getMaxGroupLength",value:function(){var t=0;return this.groups.forEach(function(e){e.photos.length>t&&(t=e.photos.length)}),t}},{key:"_buildFinalObject",value:function(){var t=this;this.layouts.forEach(function(e){t.response.layouts.push(t._buildPhotosArr(e.layoutObj,e.id))})}},{key:"_buildPhotosArr",value:function(t,e){var r=this,o={id:e};if(void 0!==t.notGenerated)return o.notGenerated=t.notGenerated,o;o.photos=[];var a=[];return t.cnsObj.wellsObj.forEach(function(t){if(t.t||t.e||t.b){if(t.hasOwnProperty("t")&&t.hasOwnProperty("textArea")){var e=h.clone(t.textArea),n=e.templateText,i=e.fieldsUsed;e.text=r.textTemplate.getTextTemplate(n,i,r.userData),e.ignore=!e.text||void 0!==n&&r.textTemplate.ignore,delete e.fieldsUsed,delete e.templateText,a.push(e)}}else if(t.photo){var s=r.photosStrip.find(function(e){return t.photo.id==e.photoId}),u=s.photoId;t.crop||(t.crop={x:0,y:0,width:1,height:1});var c={x1:h.round2(t.crop.x),y1:h.round2(1-(t.crop.y+t.crop.height)),x2:h.round2(t.crop.x+t.crop.width),y2:h.round2(1-t.crop.y)};c.x1<0&&(c.x1=0),c.x1>1&&(c.x1=1),c.y1<0&&(c.y1=0),c.y1>1&&(c.y1=1),c.x2<0&&(c.x2=0),c.x2>1&&(c.x2=1),c.y2<0&&(c.y2=0),c.y2>1&&(c.y2=1);var l={photoId:u,crop:h.objectValues(c),wellIndex:t.i};o.photos.push(l)}}),a.length>0&&(o.textWells=a),o}},{key:"_fillEmptyLayouts",value:function(t,e){e.photos.length>0&&t.forEach(function(t){if(!(t.t||t.e||t.b||t.photo)){var r=h.clone(e.photos[0]);r.crop=[0,0,1,1],r.seqNum=t.seqNum,e.photos.push(r)}})}},{key:"_fitAllPhotosLeft",value:function(t,e,r,o,a){this._getSortedPhotos();for(var n=[],i=[],s={val:e.length},h={},u=0;u<t.length;u++)h[t[u].id]=!0;this.sortedPhotos.forEach(function(t){h[t.id]||(t.allParams.NumOfMgAppear||(t.allParams.NumOfMgAppear=0),i.push(t))}),this._sortAndAddCandidates(i,h,s,n,{},[]);var c=this._fitPhotosToWells(e,n,a);if(c){var l=c.miss;return e.forEach(function(e,r){n[c.photosOrder[r]]&&(o[e.i]=n[c.photosOrder[r]],t.push(n[c.photosOrder[r]]))}),r.val-=l,c.emptyWells}return r.val-=e.length,e}}]),t}();t.exports=m},function(t,e,r){"use strict";function o(t){return t&&t.__esModule?t:{default:t}}e.__esModule=!0;var a=r(130),n=o(a),i=r(147),s=o(i),h="function"==typeof s.default&&"symbol"==typeof n.default?function(t){return typeof t}:function(t){return t&&"function"==typeof s.default&&t.constructor===s.default&&t!==s.default.prototype?"symbol":typeof t};e.default="function"==typeof s.default&&"symbol"===h(n.default)?function(t){return void 0===t?"undefined":h(t)}:function(t){return t&&"function"==typeof s.default&&t.constructor===s.default&&t!==s.default.prototype?"symbol":void 0===t?"undefined":h(t)}},function(t,e,r){t.exports={default:r(131),__esModule:!0}},function(t,e,r){r(132),r(143),t.exports=r(56).f("iterator")},function(t,e,r){"use strict";var o=r(133)(!0);r(75)(String,"String",function(t){this._t=String(t),this._i=0},function(){var t,e=this._t,r=this._i;return r>=e.length?{value:void 0,done:!0}:(t=o(e,r),this._i+=t.length,{value:t,done:!1})})},function(t,e,r){var o=r(47),a=r(48);t.exports=function(t){return function(e,r){var n,i,s=String(a(e)),h=o(r),u=s.length;return h<0||h>=u?t?"":void 0:(n=s.charCodeAt(h),n<55296||n>56319||h+1===u||(i=s.charCodeAt(h+1))<56320||i>57343?t?s.charAt(h):n:t?s.slice(h,h+2):i-56320+(n-55296<<10)+65536)}}},function(t,e,r){"use strict";var o=r(77),a=r(31),n=r(55),i={};r(14)(i,r(16)("iterator"),function(){return this}),t.exports=function(t,e,r){t.prototype=o(i,{next:a(1,r)}),n(t,e+" Iterator")}},function(t,e,r){var o=r(9),a=r(28),n=r(51);t.exports=r(10)?Object.defineProperties:function(t,e){a(t);for(var r,i=n(e),s=i.length,h=0;s>h;)o.f(t,r=i[h++],e[r]);return t}},function(t,e,r){var o=r(79);t.exports=Object("z").propertyIsEnumerable(0)?Object:function(t){return"String"==o(t)?t.split(""):Object(t)}},function(t,e,r){var o=r(15),a=r(138),n=r(139);t.exports=function(t){return function(e,r,i){var s,h=o(e),u=a(h.length),c=n(i,u);if(t&&r!=r){for(;u>c;)if((s=h[c++])!=s)return!0}else for(;u>c;c++)if((t||c in h)&&h[c]===r)return t||c||0;return!t&&-1}}},function(t,e,r){var o=r(47),a=Math.min;t.exports=function(t){return t>0?a(o(t),9007199254740991):0}},function(t,e,r){var o=r(47),a=Math.max,n=Math.min;t.exports=function(t,e){return t=o(t),t<0?a(t+e,0):n(t,e)}},function(t,e,r){var o=r(7).document;t.exports=o&&o.documentElement},function(t,e,r){var o=r(11),a=r(142),n=r(52)("IE_PROTO"),i=Object.prototype;t.exports=Object.getPrototypeOf||function(t){return t=a(t),o(t,n)?t[n]:"function"==typeof t.constructor&&t instanceof t.constructor?t.constructor.prototype:t instanceof Object?i:null}},function(t,e,r){var o=r(48);t.exports=function(t){return Object(o(t))}},function(t,e,r){r(144);for(var o=r(7),a=r(14),n=r(50),i=r(16)("toStringTag"),s="CSSRuleList,CSSStyleDeclaration,CSSValueList,ClientRectList,DOMRectList,DOMStringList,DOMTokenList,DataTransferItemList,FileList,HTMLAllCollection,HTMLCollection,HTMLFormElement,HTMLSelectElement,MediaList,MimeTypeArray,NamedNodeMap,NodeList,PaintRequestList,Plugin,PluginArray,SVGLengthList,SVGNumberList,SVGPathSegList,SVGPointList,SVGStringList,SVGTransformList,SourceBufferList,StyleSheetList,TextTrackCueList,TextTrackList,TouchList".split(","),h=0;h<s.length;h++){var u=s[h],c=o[u],l=c&&c.prototype;l&&!l[i]&&a(l,i,u),n[u]=n.Array}},function(t,e,r){"use strict";var o=r(145),a=r(146),n=r(50),i=r(15);t.exports=r(75)(Array,"Array",function(t,e){this._t=i(t),this._i=0,this._k=e},function(){var t=this._t,e=this._k,r=this._i++;return!t||r>=t.length?(this._t=void 0,a(1)):"keys"==e?a(0,r):"values"==e?a(0,t[r]):a(0,[r,t[r]])},"values"),n.Arguments=n.Array,o("keys"),o("values"),o("entries")},function(t,e){t.exports=function(){}},function(t,e){t.exports=function(t,e){return{value:e,done:!!t}}},function(t,e,r){t.exports={default:r(148),__esModule:!0}},function(t,e,r){r(149),r(155),r(156),r(157),t.exports=r(27).Symbol},function(t,e,r){"use strict";var o=r(7),a=r(11),n=r(10),i=r(45),s=r(76),h=r(150).KEY,u=r(30),c=r(53),l=r(55),f=r(32),d=r(16),p=r(56),g=r(57),m=r(151),v=r(152),P=r(28),y=r(15),k=r(46),b=r(31),O=r(77),S=r(153),w=r(154),F=r(9),x=r(51),_=w.f,R=F.f,T=S.f,E=o.Symbol,M=o.JSON,j=M&&M.stringify,I=d("_hidden"),C=d("toPrimitive"),A={}.propertyIsEnumerable,N=c("symbol-registry"),D=c("symbols"),G=c("op-symbols"),L=Object.prototype,B="function"==typeof E,W=o.QObject,V=!W||!W.prototype||!W.prototype.findChild,U=n&&u(function(){return 7!=O(R({},"a",{get:function(){return R(this,"a",{value:7}).a}})).a})?function(t,e,r){var o=_(L,e);o&&delete L[e],R(t,e,r),o&&t!==L&&R(L,e,o)}:R,H=function(t){var e=D[t]=O(E.prototype);return e._k=t,e},z=B&&"symbol"==typeof E.iterator?function(t){return"symbol"==typeof t}:function(t){return t instanceof E},q=function(t,e,r){return t===L&&q(G,e,r),P(t),e=k(e,!0),P(r),a(D,e)?(r.enumerable?(a(t,I)&&t[I][e]&&(t[I][e]=!1),r=O(r,{enumerable:b(0,!1)})):(a(t,I)||R(t,I,b(1,{})),t[I][e]=!0),U(t,e,r)):R(t,e,r)},K=function(t,e){P(t);for(var r,o=m(e=y(e)),a=0,n=o.length;n>a;)q(t,r=o[a++],e[r]);return t},J=function(t,e){return void 0===e?O(t):K(O(t),e)},Y=function(t){var e=A.call(this,t=k(t,!0));return!(this===L&&a(D,t)&&!a(G,t))&&(!(e||!a(this,t)||!a(D,t)||a(this,I)&&this[I][t])||e)},Q=function(t,e){if(t=y(t),e=k(e,!0),t!==L||!a(D,e)||a(G,e)){var r=_(t,e);return!r||!a(D,e)||a(t,I)&&t[I][e]||(r.enumerable=!0),r}},X=function(t){for(var e,r=T(y(t)),o=[],n=0;r.length>n;)a(D,e=r[n++])||e==I||e==h||o.push(e);return o},Z=function(t){for(var e,r=t===L,o=T(r?G:y(t)),n=[],i=0;o.length>i;)!a(D,e=o[i++])||r&&!a(L,e)||n.push(D[e]);return n};B||(E=function(){if(this instanceof E)throw TypeError("Symbol is not a constructor!");var t=f(arguments.length>0?arguments[0]:void 0),e=function(r){this===L&&e.call(G,r),a(this,I)&&a(this[I],t)&&(this[I][t]=!1),U(this,t,b(1,r))};return n&&V&&U(L,t,{configurable:!0,set:e}),H(t)},s(E.prototype,"toString",function(){return this._k}),w.f=Q,F.f=q,r(81).f=S.f=X,r(58).f=Y,r(80).f=Z,n&&!r(49)&&s(L,"propertyIsEnumerable",Y,!0),p.f=function(t){return H(d(t))}),i(i.G+i.W+i.F*!B,{Symbol:E});for(var $="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),tt=0;$.length>tt;)d($[tt++]);for(var et=x(d.store),rt=0;et.length>rt;)g(et[rt++]);i(i.S+i.F*!B,"Symbol",{for:function(t){return a(N,t+="")?N[t]:N[t]=E(t)},keyFor:function(t){if(!z(t))throw TypeError(t+" is not a symbol!");for(var e in N)if(N[e]===t)return e},useSetter:function(){V=!0},useSimple:function(){V=!1}}),i(i.S+i.F*!B,"Object",{create:J,defineProperty:q,defineProperties:K,getOwnPropertyDescriptor:Q,getOwnPropertyNames:X,getOwnPropertySymbols:Z}),M&&i(i.S+i.F*(!B||u(function(){var t=E();return"[null]"!=j([t])||"{}"!=j({a:t})||"{}"!=j(Object(t))})),"JSON",{stringify:function(t){if(void 0!==t&&!z(t)){for(var e,r,o=[t],a=1;arguments.length>a;)o.push(arguments[a++]);return e=o[1],"function"==typeof e&&(r=e),!r&&v(e)||(e=function(t,e){if(r&&(e=r.call(this,t,e)),!z(e))return e}),o[1]=e,j.apply(M,o)}}}),E.prototype[C]||r(14)(E.prototype,C,E.prototype.valueOf),l(E,"Symbol"),l(Math,"Math",!0),l(o.JSON,"JSON",!0)},function(t,e,r){var o=r(32)("meta"),a=r(29),n=r(11),i=r(9).f,s=0,h=Object.isExtensible||function(){return!0},u=!r(30)(function(){return h(Object.preventExtensions({}))}),c=function(t){i(t,o,{value:{i:"O"+ ++s,w:{}}})},l=function(t,e){if(!a(t))return"symbol"==typeof t?t:("string"==typeof t?"S":"P")+t;if(!n(t,o)){if(!h(t))return"F";if(!e)return"E";c(t)}return t[o].i},f=function(t,e){if(!n(t,o)){if(!h(t))return!0;if(!e)return!1;c(t)}return t[o].w},d=function(t){return u&&p.NEED&&h(t)&&!n(t,o)&&c(t),t},p=t.exports={KEY:o,NEED:!1,fastKey:l,getWeak:f,onFreeze:d}},function(t,e,r){var o=r(51),a=r(80),n=r(58);t.exports=function(t){var e=o(t),r=a.f;if(r)for(var i,s=r(t),h=n.f,u=0;s.length>u;)h.call(t,i=s[u++])&&e.push(i);return e}},function(t,e,r){var o=r(79);t.exports=Array.isArray||function(t){return"Array"==o(t)}},function(t,e,r){var o=r(15),a=r(81).f,n={}.toString,i="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[],s=function(t){try{return a(t)}catch(t){return i.slice()}};t.exports.f=function(t){return i&&"[object Window]"==n.call(t)?s(t):a(o(t))}},function(t,e,r){var o=r(58),a=r(31),n=r(15),i=r(46),s=r(11),h=r(73),u=Object.getOwnPropertyDescriptor;e.f=r(10)?u:function(t,e){if(t=n(t),e=i(e,!0),h)try{return u(t,e)}catch(t){}if(s(t,e))return a(!o.f.call(t,e),t[e])}},function(t,e){},function(t,e,r){r(57)("asyncIterator")},function(t,e,r){r(57)("observable")},function(t,e,r){"use strict";function o(t){return t&&t.__esModule?t:{default:t}}var a=r(0),n=o(a),i=r(1),s=o(i),h=r(4),u=r(2),c=function(){function t(e){(0,n.default)(this,t),this.groups=e.groups,this.sortedPhotos=e.sortedPhotos,this.changeGroups=e.changeGroups,this.onePhotoWellAppearanceHelper={},this.rank=0,this.smartGroups=!!e.hasOwnProperty("smartGroups")&&e.smartGroups,this.allowNonGroupPhotos=!0,this.debug=e.debug,this.doNotForce=e.hasOwnProperty("doNotForce")&&e.doNotForce}return(0,s.default)(t,[{key:"matchLayoutPhotoGroup",value:function(t,e,r,o){this.startTime=Date.now(),this.rank=0;var a={},n={},i=[];this.allowNonGroupPhotos=!e.isSmart;var s=t.getBigPhotosObj()?t.getBigPhotosObj():[],h=t.getSmallPhotosObj()?t.getSmallPhotosObj():[];if(e.photos.length<s.length+h.length&&!r)return!1;this.onePhotoWellAppearanceHelper=1===s.length+h.length&&o,this._wellsIteration(s,e,i,n,!1),this._wellsIteration(h,e,i,n,!1);var u=this._checkIfEmptyWells(h,s);if(u&&!this.doNotForce&&(this.rank-=2,i=[],this._wellsIteration(u,e,i,n,"dupPhoto")),u=this._checkIfEmptyWells(h,s),u&&!this.doNotForce&&(this.rank-=4,this._wellsIteration(u,e,i,n,"dupPhoto2")),u=this._checkIfEmptyWells(h,s))return!1;var c=0,l=0,f=0,d=s.concat(h),p=Object.keys(n).length/d.length>=.5;return d.forEach(function(t){if(a[t.i]=t.res.photo,!p&&n[t.res.photo.id]||!t.res.photo.allParams.Best||t.res.forcePhoto||t.res.dupPhoto||t.res.dupPhoto2){if(!n[t.res.photo.id]&&t.res.photo.allParams.Good&&!p&&!t.res.forcePhoto&&!t.res.dupPhoto&&!t.res.dupPhoto2){var e=t.res.photo.getRank(!0,!0,!1,!0,1,!1,1,!1,!0,!0);l+=e/10}}else{var r=t.res.photo.getRank(!0,!0,!1,!0,1,!1,1,!1,!0,!0);l+=r/10}t.res.forcePhoto&&(c+=1),t.res.dupPhoto&&(c+=1),t.res.dupPhoto2&&(c+=2);var o=t.wPt+"_"+t.hPt+"_"+t.ex+"_"+t.ey+"_"+t.ew+"_"+t.eh;t.res.photo.wellsCacheRank[o]&&(f+=t.res.photo.wellsCacheRank[o])}),this.rank+=l,this.rank-=c,this.rank+=f,!p&&d.length>1&&(this.rank+=e.rank/10),{rank:this.rank,matchIndexes:a,isGroupLayout:!p}}},{key:"_wellsIteration",value:function(t,e,r,o,a){var n=this,i=.25;t.forEach(function(t){"dupPhoto2"===a&&(r=[]),t.res=n._addBestPhotoToWell(t,e,r,o,!1,i),a&&t.res&&(t.res[a]=!0)}),this.doNotForce||t.forEach(function(t){t.res||("dupPhoto2"===a&&(r=[],i=0),t.res=n._addBestPhotoToWell(t,e,r,o,!0,i),t.res&&(a&&(t.res[a]=!0),t.res.forcePhoto=!0))})}},{key:"_addBestPhotoToWell",value:function(t,e,r,o,a,n){var i=this,s={},h=[];r&&r.forEach(function(t){s[t.id]=!0});var c=u.clone(s),l=!1;this.onePhotoWellAppearanceHelper&&Object.keys(this.onePhotoWellAppearanceHelper).forEach(function(t){i.onePhotoWellAppearanceHelper[t]>0&&!c[t]&&(c[t]=!0,l=!0)});var f=this._findCandidate(e.mainPhotos,t,!1,c,h,!0,o,a,e,!0,!0,n);return this.onePhotoWellAppearanceHelper&&l&&(f||(this.rank-=1,f=this._findCandidate(e.photos,t,!1,c,h,!0,o,a,e,!0,!0,n)),!f&&this.changeGroups&&this.allowNonGroupPhotos&&(this.rank-=1,f=this._findCandidate(this.sortedPhotos,t,!1,c,h,!1,o,a,e,!0,!0,n)),!f&&this.allowNonGroupPhotos&&(this.rank-=1,f=this._findCandidate(this.sortedPhotos,t,!1,c,h,!1,o,a,e,!1,!0,n)),f||(this.rank-=2,f=this._findCandidate(e.photos,t,!1,c,h,!0,o,a,e,!0,!1,n)),f||(f=this._findCandidate(e.mainPhotos,t,!1,s,h,!0,o,a,e,!0,!0,n)),!f&&this.allowNonGroupPhotos&&(this.rank-=2,f=this._findCandidate(this.sortedPhotos,t,!1,c,h,!1,o,a,e,!1,!1,n))),f||(this.rank-=1,f=this._findCandidate(e.photos,t,!1,s,h,!0,o,a,e,!0,!0,n)),f||(this.rank-=1,f=this._findCandidate(e.mainPhotos,t,!1,s,h,!0,o,a,e,!0,!1,n)),f||(this.rank-=2,f=this._findCandidate(e.photos,t,!1,s,h,!0,o,a,e,!0,!1,n)),!f&&this.changeGroups&&this.allowNonGroupPhotos&&(this.rank-=1,f=this._findCandidate(this.sortedPhotos,t,!1,s,h,!1,o,a,e,!0,!0,n)),!f&&this.allowNonGroupPhotos&&(this.rank-=1,f=this._findCandidate(this.sortedPhotos,t,!1,s,h,!1,o,a,e,!1,!0,n)),!f&&this.allowNonGroupPhotos&&(this.rank-=2,f=this._findCandidate(this.sortedPhotos,t,!1,s,h,!1,o,a,e,!1,!1,n)),!!f&&(r.push(f),{photo:f,options:h})}},{key:"_findCandidate",value:function(e,r,o,a,n,i,s,c,l,f,d,p){var g=this,m=!1;return r.ex<=30&&r.ey<=30&&r.ew>=70&&r.eh>=70?h.sortBestAndRank(e):h.sortBestPortrait(e),e&&Array.isArray(e)&&e.some(function(e){if(!a[e.id]&&e.checkMinFaceInWell(r,p)&&(!d||u.checkOrientation(e,r))&&t._fitPhotoToWell(r,e,c)){if(!m&&(i||!i&&l.checkPhotoInGroup(e)||!i&&!l.checkPhotoInGroup(e)&&!f||!i&&!l.checkPhotoInGroup(e)&&f&&!g._findIfMainPhotosOfGroup(e))&&(m=e,i||l.checkPhotoInGroup(e)||(s[e.id]=!0),!o))return!0;n.push(e)}}),m}},{key:"_findIfMainPhotosOfGroup",value:function(t){var e=!1;return this.groups.some(function(r){r.mainPhotos&&r.mainPhotos.some(function(r){if(r.id===t.id)return e=!0,!0})}),e}},{key:"_checkIfEmptyWells",value:function(t,e){var r=[];return t.forEach(function(t){t.res||r.push(t)}),e.forEach(function(t){t.res||r.push(t)}),r.length>0&&r}}],[{key:"fitOnePhotoToWell",value:function(e,r,o){if(void 0===r)return!1;var a={x:0,y:0,width:1,height:1},n=!1;return t.checkForObjectsIfNoFaces(r),r.checkIfPhotoIsGoodForRecursion(),r.allParams.FacesArr&&r.allParams.FacesArr.length>0&&r.allParams.FacesArr.length<=10&&(n=r.cropPhotoInWell(e.wPt,e.hPt,e.ex,e.ey,e.ew,e.eh,o,!0)),r.objectsInsteadOfFaces&&(r.objectsInsteadOfFaces=!1,delete r.allParams.FacesArr),n||(n=a),n}},{key:"_fitPhotoToWell",value:function(e,r,o){if(void 0===r)return!1;var a=!1,n=!1;if(r.checkIfPhotoIsGoodForRecursion(),t.checkForObjectsIfNoFaces(r),r.checkIfPhotoIsGoodForRecursion(),r.allParams.FacesArr&&r.allParams.FacesArr.length>0&&r.allParams.FacesArr.length<=10)n=r.cropPhotoInWell(e.wPt,e.hPt,e.ex,e.ey,e.ew,e.eh,.05,o);else{var i=e.wPt+"_"+e.hPt+"_"+e.ex+"_"+e.ey+"_"+e.ew+"_"+e.eh;r.wellsCache[i]={x:0,y:0,width:1,height:1},n=!0}return r.objectsInsteadOfFaces&&(r.objectsInsteadOfFaces=!1,delete r.allParams.FacesArr),n&&(a=!0),a}},{key:"checkForObjectsIfNoFaces",value:function(t){t.objectsInsteadOfFaces=!1,t.allParams.FacesArr&&0!==t.allParams.FacesArr.length||(t.getObjectsAsFaces(),void 0!==t.allParams.ObjectsArr&&t.allParams.ObjectsArr.length>0&&(t.objectsInsteadOfFaces=!0,t.allParams.FacesArr=t.allParams.ObjectsArr))}}]),t}();t.exports=c},function(t,e,r){"use strict";function o(t){return t&&t.__esModule?t:{default:t}}var a=r(0),n=o(a),i=r(1),s=o(i),h=["date1","date2","date3","date4","date5","date6","date7","date8","date9","date10","date11","date12","date13","date14","date15","date16","date17","date18","date19","date20","date21","date22","date23","date24","date25","date26","date27","date28","dat29","date30","date31","date32","date33","date34","date35","date36","date37","date38","dat39","date40","date41","wkday1","wkday2","wkday3","wkday4","wkday5","wkday6","month1","month2","month3","month4","month5","month6","month7","month8","day1","day2","day3","day4","day5","day6","day7","year1","year2","year3","year4","year5","year6","year7","year8","year9","year10"],u=["num1","num2","num3","num4","num5","num6","num7","num8","num9","num10"],c=["length1","length2","length3","length5","length7","length8","length9","length10"],l=["case0","case1","case2","case3","case4","firstname0","firstname1","firstname2","initial1","initial2","initial3","initial4","initial5","initial6","lastname0","lastname1","lastname2"],f=["time1","time2","time3","time4","time5","time6","time7","time8","time9","time10","time11","time12","time13"],d=["weight1","weight2","weight3","weight4","weight5","weight6","weight7","weight8","weight13"],p=["","one","two","three","four","five","six","seven","eight","nine","ten","eleven","twelve","thirteen","fourteen","fifteen","sixteen","seventeen","eighteen","nineteen"],g=["","first","second","third","fourth","fifth","sixth","seventh","eighth","ninth","tenth","eleventh","twelfth","thirteenth","fourteenth","fifteenth","sixteenth","seventeenth","eighteenth","nineteenth"],m=["zero","ten","twenty","thirty","forty","fifty","sixty","seventy","eighty","ninety"],v=["","tenth","twentieth","thirtieth","fortieth","fiftieth","sixtieth","seventieth","eightieth","ninetieth"],P=["","thousand","million","billion","trillion","quadrillion"],y=["","thousandth","millionth","billionth","quadrillionth"],k=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],b=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],O=["January","February","March","April","May","June","July","August","September","October","November","December"],S=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],w=["","1/4","1/2","3/4"],F=["","one-quarter","one-half","three-quarter"],x=" o'clock",_=function(){function t(){(0,n.default)(this,t);var e=this;e._init(),e.userDataDefault={first:"Holly",last:"Smith",line1:"101 Your Street",line2:"",addressnum:"849",city:"Your Town",region:"CA",country:"US",postCode:"12345",family_members:"John, Mary, Lucy",groom_name:"John Smith",bride_name:"Holly Jackson",contact_info:"Sara",rsvp_date:"07/09/2019",event_start_time:"50400000",event_end_time:"64800000",event_date:"07/21/2019",event_name:"Party",event_location:"849 Hawthorne Place Richmond",hosts:"Sara and Rob Winn",age:5,honoree:"Holly",honoree2:"John"},e.integerUtils={getEnglish:function(t,e){var r,o,a,n,i,s;return t<1e3?this._getEnglishLessThan1000(t,e):(r=Math.floor(Math.log(t)/Math.log(1e3)),o=Math.pow(1e3,r),a=Math.floor(t/o),n=t%o,i=!e||n>0?P[r]:y[r],s=this._getEnglishLessThan1000(a,!1)+" "+i,n>0&&(s+=" "+this.getEnglish(n,e)),s)},getOrdinalSuffix:function(t){var e=t%100,r=t%10;if(e>10&&e<20)return"th";switch(r){case 1:return"st";case 2:return"nd";case 3:return"rd";default:return"th"}},getTwoDigitNumber:function(t){return t<10?"0"+t:String(t)},_getEnglishLessThan20:function(t,e){return t>=20||t<0?"":e?g[t]:p[t]},_getEnglishLessThan100:function(t,e){var r,o;return t>=100||t<0?"":t<20?this._getEnglishLessThan20(t,e):(r=Math.floor(t/10),o=t%10,0===o?e?v[r]:m[r]:m[r]+"-"+this._getEnglishLessThan20(o,e))},_getEnglishLessThan1000:function(t,e){var r,o,a="";return t>=1e3||t<0?"":t<100?this._getEnglishLessThan100(t,e):(r=Math.floor(t/100),o=t%100,a+=this._getEnglishLessThan100(r)+" hundred",e&&0===o&&(a+="th"),o>0&&(a+=" "+this._getEnglishLessThan100(o,e)),a)}},e.stringUtils={capitalizeEachWord:function(t){return"string"!=typeof t||""===t?"":t.replace(/\w+/g,function(t){return t.charAt(0).toUpperCase()+t.substr(1).toLowerCase()})},capitalizeFirstWord:function(t){return"string"!=typeof t||""===t?"":t.charAt(0).toUpperCase()+t.substr(1).toLowerCase()},getFirstLetter:function(t){if(!t)return"";var e=t.match(/\w/);return e&&e.length>0?e[0]:""},getFirstLetterOfLastWord:function(t){var e=this.getLastWord(t),r=e&&e.match(/\w/);return r&&r.length>0?r[0]:""},getFirstWord:function(t){var e=this.getWordArray(t);return e.length>0?e[0]:""},getInitials:function(t){var e,r=this.getWordArray(t),o=[];for(e=0;e<r.length;e++)o.push(r[e].charAt(0));return o.join("")},getLastWord:function(t){var e=this.getWordArray(t);return e.length>0?e[e.length-1]:""},getWordArray:function(t){if("string"!=typeof t||""===t)return[];var e,r=t.split(/\s+/),o=[];for(e=0;e<r.length;e++)r[e]&&o.push(r[e]);return o},insertDashBetweenFirstTwoWords:function(t){var e,r,o,a=this.getWordArray(t);return a.length<2?t:(e=t.indexOf(a[0]),r=t.indexOf(a[1],e+a[0].length),o=t.substring(r),this.capitalizeEachWord(a[0]+"-"+o))},insertWordAfterGivenWord:function(t,e,r){var o,a,n=this.getWordArray(t);return 0===(o=n.length)||""===e||""===r?"":(a=n.indexOf(e),-1!==a&&a!==o-1&&n.splice(a+1,0,r),n.join(" "))}},e.integerObj={format:function(t,r){if(!t||void 0===r)return"";var o=parseInt(r,10);if(isNaN(o)||o<0)return"";switch(t){case"num1":return String(o);case"num2":return o+e.integerUtils.getOrdinalSuffix(o);case"num3":return e.integerUtils.getEnglish(o,!0);case"num4":return e.integerUtils.getEnglish(o,!1);case"num5":return String(o+e.integerUtils.getOrdinalSuffix(o)).toUpperCase();case"num6":return e.integerUtils.getEnglish(o,!0).toUpperCase();case"num7":return e.integerUtils.getEnglish(o,!1).toUpperCase();case"num8":return e.stringUtils.capitalizeEachWord(e.integerUtils.getEnglish(o,!0));case"num9":return e.stringUtils.capitalizeEachWord(e.integerUtils.getEnglish(o,!1));case"num10":return e.stringUtils.insertDashBetweenFirstTwoWords(e.integerUtils.getEnglish(o,!1));default:return""}}},e.stringObj={format:function(t,r){if(!r||!t)return"";switch(t){case"case0":return r;case"case1":return r.toUpperCase();case"case2":return r.toLowerCase();case"case3":return e.stringUtils.capitalizeEachWord(r);case"case4":return e.stringUtils.insertDashBetweenFirstTwoWords(r);case"firstname0":return e.stringUtils.getFirstWord(r);case"firstname1":return e.stringUtils.getFirstWord(r).toUpperCase();case"firstname2":return e.stringUtils.getFirstWord(r).toLowerCase();case"initial1":return e.stringUtils.getFirstLetter(r).toUpperCase();case"initial2":return e.stringUtils.getInitials(r).toUpperCase();case"initial3":return e.stringUtils.getFirstLetter(r).toLowerCase();case"initial4":return this.stringUtils.getInitials(r).toLowerCase();case"initial5":return e.stringUtils.getFirstLetterOfLastWord(r).toUpperCase();case"initial6":return e.stringUtils.getFirstLetterOfLastWord(r).toLowerCase();case"lastname0":return e.stringUtils.getLastWord(r);case"lastname1":return e.stringUtils.getLastWord(r).toUpperCase();case"lastname2":return e.stringUtils.getLastWord(r).toLowerCase();default:return""}}},e.dateObj={format:function(t,r,o,a){if(!t)return"";var n=parseInt(r,10),i=parseInt(o,10),s=parseInt(a,10),h=void 0,u=void 0,c=void 0;if(isNaN(n)||isNaN(i)||isNaN(s)||i<1||i>12||s<1||s>31)return"";switch(n=n<100?n+2e3:n,h=n-2e3,u=new Date(n,i-1,s,0,0,0,0),c=u.getDay(),t){case"date1":return e.integerUtils.getTwoDigitNumber(i)+"/"+e.integerUtils.getTwoDigitNumber(s)+"/"+e.integerUtils.getTwoDigitNumber(h);case"date2":return e.integerUtils.getTwoDigitNumber(i)+"-"+e.integerUtils.getTwoDigitNumber(s)+"-"+e.integerUtils.getTwoDigitNumber(h);case"date3":return e.integerUtils.getTwoDigitNumber(i)+"."+e.integerUtils.getTwoDigitNumber(s)+"."+e.integerUtils.getTwoDigitNumber(h);case"date4":return O[i-1]+" "+s+", "+n;case"date5":return k[c]+", "+O[i-1]+" "+s+e.integerUtils.getOrdinalSuffix(s);case"date6":return k[c]+", "+O[i-1]+" "+s+", "+n;case"date7":return(k[c]+", "+O[i-1]+" "+s+", "+n).toLowerCase();case"date8":return"the "+s+e.integerUtils.getOrdinalSuffix(s)+" of "+O[i-1]+" "+n;case"date9":return"the "+e.integerUtils.getEnglish(s,!0)+" of "+O[i-1]+", "+this.integerUtils.getEnglish(n);case"date10":return(O[i-1]+" "+s+e.integerUtils.getOrdinalSuffix(s)).toLowerCase();case"date11":return(O[i-1]+" "+s+", "+n).toLowerCase();case"date12":return(O[i-1]+" "+s+", "+n).toUpperCase();case"date13":return(k[c]+", "+O[i-1]+" "+s+e.integerUtils.getOrdinalSuffix(s)).toLowerCase();case"date14":return(k[c]+", "+O[i-1]+" "+s+e.integerUtils.getOrdinalSuffix(s)).toUpperCase();case"date15":return(k[c]+", "+O[i-1]+" "+s+", "+n).toUpperCase();case"date16":return("the "+s+e.integerUtils.getOrdinalSuffix(s)+" of "+O[i-1]+" "+n).toLowerCase();case"date17":return("the "+s+e.integerUtils.getOrdinalSuffix(s)+" of "+O[i-1]+" "+n).toUpperCase();case"date18":return("the "+e.integerUtils.getEnglish(s,!0)+" of "+O[i-1]+", "+e.integerUtils.getEnglish(n)).toLowerCase();case"date19":return("the "+e.integerUtils.getEnglish(s,!0)+" of "+O[i-1]+", "+e.integerUtils.getEnglish(n)).toUpperCase();case"date20":return O[i-1]+" "+s+e.integerUtils.getOrdinalSuffix(s);case"date21":return(O[i-1]+" "+s+e.integerUtils.getOrdinalSuffix(s)).toUpperCase();case"date22":return k[c]+", the "+e.integerUtils.getEnglish(s,!0)+" of "+O[i-1];case"date23":return(k[c]+", the "+e.integerUtils.getEnglish(s,!0)+" of "+O[i-1]).toLowerCase();case"date24":return(k[c]+", the "+e.integerUtils.getEnglish(s,!0)+" of "+O[i-1]).toUpperCase();case"date25":return k[c]+", the "+e.integerUtils.getEnglish(s,!0)+" of "+O[i-1]+", "+e.integerUtils.getEnglish(n);case"date26":return(k[c]+", the "+e.integerUtils.getEnglish(s,!0)+" of "+O[i-1]+", "+e.integerUtils.getEnglish(n)).toLowerCase();case"date27":return(k[c]+", the "+e.integerUtils.getEnglish(s,!0)+" of "+O[i-1]+", "+e.integerUtils.getEnglish(n)).toUpperCase();case"date28":return O[i-1]+" "+e.integerUtils.getEnglish(s,!0)+", "+e.integerUtils.getEnglish(n);case"date29":return(O[i-1]+" "+e.integerUtils.getEnglish(s,!0)+", "+e.integerUtils.getEnglish(n)).toLowerCase();case"date30":return(O[i-1]+" "+e.integerUtils.getEnglish(s,!0)+", "+e.integerUtils.getEnglish(n)).toUpperCase();case"date31":return O[i-1]+" "+e.integerUtils.getEnglish(s,!0);case"date32":return(O[i-1]+" "+e.integerUtils.getEnglish(s,!0)).toLowerCase();case"date33":return(O[i-1]+" "+e.integerUtils.getEnglish(s,!0)).toUpperCase();case"date34":return e.integerUtils.getEnglish(s,!0)+" of "+O[i-1];case"date35":return(e.integerUtils.getEnglish(s,!0)+" of "+O[i-1]).toLowerCase();case"date36":return(e.integerUtils.getEnglish(s,!0)+" of "+O[i-1]).toUpperCase();case"date37":return s+e.integerUtils.getOrdinalSuffix(s)+" of "+O[i-1];case"date38":return(s+e.integerUtils.getOrdinalSuffix(s)+" of "+O[i-1]).toLowerCase();case"date39":return(s+e.integerUtils.getOrdinalSuffix(s)+" of "+O[i-1]).toUpperCase();case"date40":return e.integerUtils.getTwoDigitNumber(i)+"."+e.integerUtils.getTwoDigitNumber(s);case"date41":return e.integerUtils.getTwoDigitNumber(i)+"."+e.integerUtils.getTwoDigitNumber(s)+"."+n;case"wkday1":return b[c];case"wkday2":return b[c].toLowerCase();case"wkday3":return b[c].toUpperCase();case"wkday4":return k[c];case"wkday5":return k[c].toLowerCase();case"wkday6":return k[c].toUpperCase();case"month1":return e.integerUtils.getTwoDigitNumber(i);case"month2":return String(i);case"month3":return O[i-1];case"month4":return O[i-1].toLowerCase();case"month5":return O[i-1].toUpperCase();case"month6":return S[i-1];case"month7":return S[i-1].toLowerCase();case"month8":return S[i-1].toUpperCase();case"day1":return e.integerUtils.getTwoDigitNumber(s);case"day2":return String(s);case"day3":return s+e.integerUtils.getOrdinalSuffix(s);case"day4":return(s+e.integerUtils.getOrdinalSuffix(s)).toUpperCase();case"day5":return e.stringUtils.capitalizeEachWord(e.integerUtils.getEnglish(s,!0));case"day6":return e.integerUtils.getEnglish(s,!0).toLowerCase();case"day7":return e.integerUtils.getEnglish(s,!0).toUpperCase();case"year1":return e.integerUtils.getTwoDigitNumber(h);case"year2":return String(h);case"year3":return String(n);case"year4":return"'"+e.integerUtils.getTwoDigitNumber(h);case"year5":return e.stringUtils.capitalizeFirstWord(e.integerUtils.getEnglish(n));case"year6":return e.integerUtils.getEnglish(n).toLowerCase();case"year7":return e.integerUtils.getEnglish(n).toUpperCase();case"year8":return e.stringUtils.insertWordAfterGivenWord(e.integerUtils.getEnglish(n),"thousand","and").toLowerCase();case"year9":return e.stringUtils.insertWordAfterGivenWord(e.integerUtils.getEnglish(n),"thousand","and").toUpperCase();case"year10":return e.stringUtils.capitalizeFirstWord(e.stringUtils.insertWordAfterGivenWord(e.integerUtils.getEnglish(n),"thousand","and"));default:return""}}},e.lengthObj={format:function(t,r,o){if(!t)return"";var a=parseFloat(r),n=Math.floor(a),i=Math.floor(4*(a-n));if(isNaN(r)||r<0)return"";switch(t){case"length1":return this._getLength1Str(n,i,o);case"length2":return this._getLength2Str(n,i,o);case"length3":return this._getLength3Str(n,i,o);case"length5":return this._getLength1Str(n,i,o).toUpperCase();case"length7":return e.stringUtils.capitalizeEachWord(this._getLength2Str(n,i,o));case"length8":return this._getLength2Str(n,i,o).toUpperCase();case"length9":return e.stringUtils.capitalizeEachWord(this._getLength3Str(n,i,o));case"length10":return this._getLength3Str(n,i,o).toUpperCase();default:return""}},_getLength1Str:function(t,e,r){var o=t>0||0===e?t:"";return 0!==e&&(o+=(t>0?" ":"")+w[e]),o+=r?" cm":" in"},_getLength2Str:function(t,e,r){var o=t>0||0===e?t:"";return 0!==e&&(o+=(t>0?" ":"")+w[e]),t<=1?o+(r?" centimeter":" inch"):o+(r?" centimeters":" inches")},_getLength3Str:function(t,r,o){if(1===t&&0===r)return e.integerUtils.getEnglish(t)+(o?" centimeter":" inch");var a=t>0?e.integerUtils.getEnglish(t):"";return 0!==r&&(t>=1&&(a+=" and "),a+=F[r]),t<1?a+(o?" centimeter":" inch"):a+(o?" centimeters":" inches")}},e.timeObj={format:function(t,r,o,a){if(!t||void 0===r)return"";var n=parseInt(o||0,10),i=parseInt(r,10);if(isNaN(i)||i<0||i>23)return"";switch(i=i>12?i-12:i,i=0===i?12:i,n=isNaN(n)?0:n,t){case"time1":return this._getTime1Str(i,n);case"time2":return this._getTime2Str(i,n,a);case"time3":return this._getTime3Str(i,n,a);case"time4":return this._getTime4Str(i,n,a);case"time5":return i+":"+e.integerUtils.getTwoDigitNumber(n)+" "+this._getDescriptiveTimeOfDay(i,n,a);case"time6":return this._getTime6Str(i,n,a);case"time7":return this._getTime1Str(i,n).toUpperCase();case"time8":return this._getTime2Str(i,n,a).toUpperCase();case"time9":return this._getTime3Str(i,n,a).toUpperCase();case"time10":return this._getTime4Str(i,n,a).toUpperCase();case"time11":return this._getTime4Str(i,n,a).toLowerCase();case"time12":return this._getTime12Str(i,n,a).toLowerCase();case"time13":return this._getTime12Str(i,n,a).toUpperCase();default:return""}},_getDescriptiveTimeOfDay:function(t,e,r){return 12===t&&0===e?r?"noon":"midnight":r?t<6||12===t?"in the afternoon":"in the evening":"in the morning"},_getMinutesPastString:function(t){return 1===t?" minute past ":" minutes past "},_getTime1Str:function(t,r){return r<1?e.integerUtils.getEnglish(t):r<10?e.integerUtils.getEnglish(r)+this._getMinutesPastString(r)+e.integerUtils.getEnglish(t):e.integerUtils.getEnglish(t)+" "+e.integerUtils.getEnglish(r)},_getTime2Str:function(t,r,o){return t+":"+e.integerUtils.getTwoDigitNumber(r)+(o?" pm":" am")},_getTime3Str:function(t,r,o){return t+(0===r?x:":"+e.integerUtils.getTwoDigitNumber(r))+" "+this._getDescriptiveTimeOfDay(t,r,o)},_getTime4Str:function(t,r,o){return 0===r?e.integerUtils.getEnglish(t)+x+" "+this._getDescriptiveTimeOfDay(t,r,o):r<10?e.integerUtils.getEnglish(r)+this._getMinutesPastString(r)+e.integerUtils.getEnglish(t)+" "+this._getDescriptiveTimeOfDay(t,r,o):e.integerUtils.getEnglish(t)+" "+e.integerUtils.getEnglish(r)+" "+this._getDescriptiveTimeOfDay(t,r,o)},_getTime6Str:function(t,r,o){return r>10?e.integerUtils.getEnglish(t)+" "+e.integerUtils.getEnglish(r)+" "+this._getDescriptiveTimeOfDay(t,r,o):r>0&&r<10?e.integerUtils.getEnglish(r)+this._getMinutesPastString(r)+e.integerUtils.getEnglish(t)+" "+this._getDescriptiveTimeOfDay(t,r,o):e.integerUtils.getEnglish(t)+" "+this._getDescriptiveTimeOfDay(t,r,o)},_getTime12Str:function(t,r,o){var a="";if(r>0)if(r%15==0)switch(r){case 15:a+="a quarter past ";break;case 30:a+="half past ";break;case 45:a+="three quarters past "}else a+=e.integerUtils.getEnglish(r)+this._getMinutesPastString(r);return a+=e.integerUtils.getEnglish(t)+x+" "+this._getDescriptiveTimeOfDay(t,r,o)}},e.weightObj={format:function(t,e,r,o){if(!t)return"";var a=parseInt(e,10),n=parseInt(r,10);if(isNaN(a)||a<0)return"";switch(n=isNaN(n)||n<0?0:n,t){case"weight1":return this._getWeight1Str(a,n,o);case"weight2":return this._getWeight2Str(a,n,o);case"weight3":return this._getWeight3Str(a,n,o);case"weight4":return this._getWeight1Str(a,n,o).toUpperCase();case"weight5":return this._getWeight5Str(a,n,o);case"weight6":return this._getWeight5Str(a,n,o).toUpperCase();case"weight7":return this._getWeight2Str(a,n,o);case"weight8":return this._getWeight2Str(a,n,o).toUpperCase();case"weight13":return this._getWeight3Str(a,n,o).toUpperCase();default:return""}},_getWeight1Str:function(t,e,r){var o=t>0||0===e?t+(r?" kg":" lb"):"";return 0===e?o:(t>0&&(o+=" "),o+e+(r?" g":" oz"))},_getWeight2Str:function(t,e,r){var o="";return(t>0||0===e)&&(o=t+(r?" kilogram":" pound"),o+=1===t?"":"s"),0===e?o:(t>0&&(o+=" "),o+e+(r?" gram":" ounce")+(1===e?"":"s"))},_getWeight3Str:function(t,r,o){var a="";return(t>0||0===r)&&(a=e.integerUtils.getEnglish(t),a+=o?" kilogram":" pound",a+=1===t?"":"s"),0===r?a:(t>0&&(a+=" "),a+e.integerUtils.getEnglish(r)+(o?" gram":" ounce")+(1===r?"":"s"))},_getWeight5Str:function(t,e,r){var o=t>0||0===e?t+(r?" kg":" lb"):"";return 0===e?o:(t>0&&(o+=", "),o+e+(r?" g":" oz"))}}}return(0,s.default)(t,[{key:"_init",value:function(){this.template=!1,this.bindings=!1,this.ignore=!1,this.userData={}}},{key:"_escapeHtmlENT_NOQUOTES",value:function(t){var e={"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#039;"};return"string"!=typeof t&&(t=t.toString()),t.replace(/[&<>"']/g,function(t){return e[t]})}},{key:"_userBindings",value:function(t){var e="";return this.userData.hasOwnProperty(t)?e=this.userData[t]:"full_name"===t?(this.userData.hasOwnProperty("first")||(this.userData.first=this.userDataDefault.first,this.ignore=!0),this.userData.hasOwnProperty("last")||(this.userData.last=this.userDataDefault.last,this.ignore=!0),e=this.userData.first+" "+this.userData.last):"full_name2"===t?(this.userData.hasOwnProperty("bride_name")||(this.userData.bride_name=this.userDataDefault.bride_name,this.ignore=!0),e=this.userData.bride_name):"surname"===t||"surname0"===t||"surname_01"===t?(this.userData.hasOwnProperty("last")||(this.userData.last=this.userDataDefault.last,this.ignore=!0),e=this.userData.last):"address"===t?(this.userData.hasOwnProperty("line1")||(this.userData.line1=this.userDataDefault.line1,this.ignore=!0),e=this.userData.line1):"zip"===t?(this.userData.hasOwnProperty("postCode")||(this.userData.postCode=this.userDataDefault.postCode,this.ignore=!0),e=this.userData.postCode):"state_province"===t?(this.userData.hasOwnProperty("region")||(this.userData.region=this.userDataDefault.region,this.ignore=!0),e=this.userData.region):this.userDataDefault.hasOwnProperty(t)?(e=this.userDataDefault[t],this.ignore=!0):this.ignore=!0,this._escapeHtmlENT_NOQUOTES(e)}},{key:"_transformText",value:function(t,e){if(-1!==l.indexOf(t))return this.stringObj.format(t,e);if(-1!==u.indexOf(t))return this.integerObj.format(t,e);if(-1!==h.indexOf(t)){var r=e.split("/");if(!r||3!==r.length)return"";var o=parseInt(r[0],10),a=parseInt(r[1],10),n=parseInt(r[2],10);return isNaN(o)||isNaN(a)||isNaN(n)?"":this.dateObj.format(t,n,o,a)}if(-1!==f.indexOf(t)){var i=parseInt(e,10),s=!1,p=void 0,g=void 0;return isNaN(i)||i<0?"":(p=i/6e4,g=Math.floor(p/60),p-=60*g,g>=12&&(g-=12,s=!0),g=12===g?0:g,this.timeObj.format(t,g,p,s))}if(-1!==c.indexOf(t)){var m=e.split(":");if(!m||2!==m.length)return"";var v=parseFloat(m[0]);if(isNaN(v))return"";var P=Math.floor(v),y=v-P;return this.lengthObj.format(t,y,"centimeters"===m[1])}if(-1!==d.indexOf(t)){var k=e.split(":");if(!k||2!==k.length)return"";var b=parseFloat(k[0]);if(isNaN(b))return"";var O="kilograms_grams"===k[1],S=O?1e3:16,w=Math.floor(b),F=Math.round((b-w)*S);return this.weightObj.format(t,w,F,O)}return""}},{key:"getTextTemplate",value:function(t,e,r){return this._init(),this.template=t,this.bindings=e,void 0===r&&(r=this.userDataDefault,this.ignore=!0),this.userData=r,this._buildTextTemplate()}},{key:"_buildTextTemplate",value:function(){for(var t=this.template,e=0,r=this.bindings.length;e<r;e++){var o=this.bindings[e],a=t.match(new RegExp("<<"+o+":(.+?)>>"));if(a&&a.length>0){var n=this._userBindings(o),i=this._transformText(a[1],n);t=t.replace("<<"+o+":"+a[1]+">>",i,t)}}return t.replace(/<<(.+?)>>/g,"").replace(/!\s\s+!/g," ").trim()}},{key:"_sendToCreationPath",value:function(){return!this.ignore}}]),t}();t.exports=_},function(t,e,r){"use strict";function o(t){return t&&t.__esModule?t:{default:t}}var a=r(0),n=o(a),i=r(1),s=o(i),h=r(4),u=r(2),c=function(){function t(){(0,n.default)(this,t),this.index=0,this.batches=[],this.photos=[],this.goodPhotos=[],this.goodForBestPhotos=[],this.recFacesAdditionToGood=[],this.recPortraitAdditionToGood=[],this.batchAdditionToGood=[],this.numFacesPhotos=0,this.averageFaces=0,this.maxNumOfFaces=-1e4,this.minNumOfFaces=1e4,this.numOfFacesConsistency=0,this.averageTimeBetweenPhotos=0,this.averageFaceSize=0,this.numberOfPhotosWithKiss=0,this.averageRank=0,this.averageSimilarity=0,this.averageOneSimilarity=0,this.averageDirSimilarity=0,this.averageTexSimilarity=0,this.numHighSimilarity=0,this.numZeroRank=0,this.numBadPhotos=0,this.numOfPhotosSuggested=0,this.includeNumOfFacesFactor=!0,this.origPhotos=[],this.exp=""}return(0,s.default)(t,[{key:"analyze",value:function(){var t=this,e={};t.photos.forEach(function(t){e[t.allParams.TimeStamp+"_"+t.getBaseRank()]=t}),Object.keys(e).length!==t.photos.length&&(t.origPhotos=t.photos,t.photos=[],Object.keys(e).forEach(function(r){t.photos.push(e[r])}),h.sortPhotosByDate(t.photos));var r=void 0;t.photos.forEach(function(e,o){e.analyzePhoto(),e.PosInPhotosArr=o;var a=0,n=!1,i=!1;e.allParams.FacesArr&&e.allParams.FacesArr.length>0&&(e.allParams.FacesArr.forEach(function(e){1===e.Significance&&((!e.FocusFactor||e.FocusFactor<-5)&&(n=!0),e.Kiss&&!i&&(t.numberOfPhotosWithKiss++,i=!0),(e.LeftEyeClosed||e.RightEyeClosed)&&a++)}),t.averageFaceSize+=e.allParams.MaxFaceSize,t.maxNumOfFaces=Math.max(t.maxNumOfFaces,e.allParams.NumOfFaces),t.minNumOfFaces=Math.min(t.minNumOfFaces,e.allParams.NumOfFaces),e.allParams.NumOfFaces>0&&t.numFacesPhotos++,t.averageFaces+=e.allParams.NumOfFaces),e.allParams.NumOfFaces>0&&a/e.allParams.NumOfFaces>=.5&&t.numBadPhotos++;var s=void 0;if(o>0&&(t.averageSimilarity+=e.allParams.Similarity1,t.averageOneSimilarity+=e.allParams.Similarity2,t.averageDirSimilarity+=e.allParams.DirectionSimilarity,t.averageTexSimilarity+=e.allParams.TextureScaleSimilarity,s=u.checkSimilarity("NoStrongSimilarity",t.photos[o-1],e)),Math.round(e.getRank(!0,!1,!1,!1,1,!1,!1,!1,!1,!1))<=0&&!n?t.numZeroRank++:o>0&&t.photos[o-1]&&s&&t.numHighSimilarity++,0===o){var h={photos:[]};h.photos.push(e),t.batches.push(h),r=h}else if(s)r.photos.push(e);else{var c={photos:[]};c.photos.push(e),t.batches.push(c),r=c}e.allParams.BatchIndex=t.batches.length-1,o<t.photos.length-1&&(t.averageTimeBetweenPhotos+=t.photos[o+1].allParams.TimeStamp-e.allParams.TimeStamp),t.averageRank+=e.getRank(!1,!1,!1,!1,1,!1,!1,!1,!1,!1)}),t.averageTimeBetweenPhotos=t.averageTimeBetweenPhotos/(t.photos.length-1),t.averageRank=t.averageRank/t.photos.length,t.photos.length>1&&(t.averageSimilarity=t.averageSimilarity/(t.photos.length-1),t.averageOneSimilarity=t.averageOneSimilarity/(t.photos.length-1),t.averageDirSimilarity=t.averageDirSimilarity/(t.photos.length-1),t.averageTexSimilarity=t.averageTexSimilarity/(t.photos.length-1)),t.averageFaces=t.averageFaces/t.photos.length,t.numFacesPhotos>0&&(t.averageFaceSize=t.averageFaceSize/t.numFacesPhotos);var o=0;t.photos.length>1&&(t.averageTimeBetweenPhotos<5||t.averageTimeBetweenPhotos<10&&t.averageSimilarity>80||t.averageSimilarity>87)&&(o=1.5*(1-Math.exp(-(t.photos.length-1)/5))),t.photos.forEach(function(e,r){t.averageTimeBetweenPhotos>0&&(e.allParams.SubClusterAvgTime=t.averageTimeBetweenPhotos),e.allParams.SubClusterSizeFactor=o;var a=null,n=null;r>0&&(a=t.photos[r-1]),r!==t.photos.length-1&&(n=t.photos[r+1]),a&&a.allParams.TimeStamp<315532800&&(a=null),n&&n.allParams.TimeStamp<315532800&&(n=null);var i=!1;a&&a.allParams.ConsideredAsFace&&e.allParams.TimeStamp-a.allParams.TimeStamp<=4&&e.allParams.Similarity1>85&&a.allParams.AverageConfidence>80&&(e.allParams.ConsideredAsFace?e.allParams.NumOfFacesEstimation=Math.max(e.allParams.NumOfFacesEstimation,a.allParams.NumOfFacesEstimation):(e.allParams.ConsideredAsFace=!0,e.allParams.NumOfFacesEstimation=a.allParams.NumOfFacesEstimation),i=!0),n&&n.allParams.ConsideredAsFace&&n.allParams.TimeStamp-e.allParams.TimeStamp<=4&&n.allParams.Similarity1>85&&n.allParams.AverageConfidence>80&&(!i||n.allParams.TimeStamp-e.allParams.TimeStamp<e.allParams.TimeStamp-a.allParams.TimeStamp)&&(e.allParams.ConsideredAsFace?e.allParams.NumOfFacesEstimation=Math.max(e.allParams.NumOfFacesEstimation,n.allParams.NumOfFacesEstimation):(e.allParams.ConsideredAsFace=!0,e.allParams.NumOfFacesEstimation=n.allParams.NumOfFacesEstimation))}),t.maxNumOfFaces-t.minNumOfFaces>3&&t.averageSimilarity<80&&(t.includeNumOfFacesFactor=!1)}},{key:"selectGoodPhotos",value:function(e,r){var o=this,a=!1;this.numFacesPhotos>.66*this.photos.length&&(this.averageFaces<=1.3&&this.averageFaceSize>.14&&this.photos.length>=4&&(this.averageTimeBetweenPhotos<=10||this.averageFaces<=1)?a=1:this.averageFaces<=2&&this.averageFaceSize>.14&&this.photos.length>=4&&(this.averageTimeBetweenPhotos<=5||this.averageFaces<=1)?a=1:1===this.maxNumOfFaces&&1===Math.round(this.averageFaces)&&this.averageFaceSize>.14&&this.photos.length>=3&&this.averageSimilarity>85?a=1:1===this.maxNumOfFaces&&1===Math.round(this.averageFaces)&&this.photos.length>7&&this.averageSimilarity>85&&this.averageFaceSize>.098&&(a=1),1===this.maxNumOfFaces&&1===this.minNumOfFaces&&this.averageFaceSize);var n=.51;this.averageSimilarity>80&&this.averageFaces>=2.5&&this.maxNumOfFaces>=3&&this.maxNumOfFaces-this.minNumOfFaces<4&&(n-=.2);var i=!1;this.numOfPhotosSuggested=Math.round(n*(this.photos.length-this.numHighSimilarity-this.numZeroRank)),this.numHighSimilarity>12&&(this.numOfPhotosSuggested+=Math.floor(this.numHighSimilarity/7),i=!0),this.numOfPhotosSuggested>=8&&!i?(this.numOfPhotosSuggested=Math.floor(.6*this.numOfPhotosSuggested),i=!0):this.numOfPhotosSuggested>=4&&!a&&!i&&(this.numOfPhotosSuggested=Math.ceil(.7*this.numOfPhotosSuggested),i=!0),this.numOfPhotosSuggested<=0&&(this.numOfPhotosSuggested=1),this.numBadPhotos/this.photos.length<.5&&(this.averageRank>9&&this.averageTimeBetweenPhotos>10&&this.averageSimilarity<90&&this.numOfPhotosSuggested++,this.numOfPhotosSuggested<4&&(this.averageTimeBetweenPhotos>20&&this.averageSimilarity<75&&this.averageRank>=5?(this.averageFaceSize>=.08||2===this.photos.length)&&this.numOfPhotosSuggested++:this.averageTimeBetweenPhotos>60&&this.averageSimilarity<90&&this.numFacesPhotos>.66*this.photos.length&&this.averageRank>=7&&this.numOfPhotosSuggested++),this.numberOfPhotosWithKiss>0&&(this.averageSimilarity>87||this.averageTimeBetweenPhotos<=7)&&this.numOfPhotosSuggested++,a&&this.numOfPhotosSuggested++),2===this.photos.length&&(this.maxNumOfFaces-this.minNumOfFaces>=2&&this.minNumOfFaces>=3&&this.minNumOfFaces<6&&this.averageRank>6&&this.averageTimeBetweenPhotos>10&&this.numOfPhotosSuggested++,Math.abs(this.photos[0].AverageFaceSize-this.photos[1].AverageFaceSize)>.2&&this.averageRank>6&&this.numOfPhotosSuggested++),this.numOfPhotosSuggested=Math.min(this.numOfPhotosSuggested,this.photos.length);var s=4.5;this.photos.length>=4&&(s-=this.photos.length-4),s=Math.max(s,2.5);var h=4;this.photos.length>=7&&0===this.averageFaces&&!i&&(h-=.5*(this.photos.length-7),this.numOfPhotosSuggested=Math.round(this.numOfPhotosSuggested/1.9),this.numOfPhotosSuggested=Math.max(this.numOfPhotosSuggested,2)),h=Math.max(h,2.5),1===this.photos.length&&(h=5.5),e&&(this.numOfPhotosSuggested=this.photos.length),this.numOfPhotosSuggested=Math.min(this.numOfPhotosSuggested,this.photos.length);for(var u=0;u<this.numOfPhotosSuggested;u++)this._addNextGoodPhoto(s,8,h,"NoStrongSimilarity");var c={},l={};this.goodPhotos.forEach(function(t){t.allParams.FacesArr&&t.allParams.FacesArr.forEach(function(t){if(1===t.Significance){var e=t.PersonRecIndex1;e&&(l[e]=1,Math.max(t.FaceObj.Rect.width,t.FaceObj.Rect.height)>.1&&(c[e]=1))}})});var f=0;if(this.photos.forEach(function(t,e){var r=!1;t.allParams.NumOfFaces&&t.allParams.NumOfFaces<=2&&f<2&&t.allParams.FacesArr.forEach(function(a){if(1===a.Significance){var n=a.PersonRecIndex1;if(n){var i=Math.max(a.FaceObj.Rect.width,a.FaceObj.Rect.height);if(1===t.allParams.NumOfFaces&&i>.13&&!r&&!c[n]&&t.getRank(!0,!1,!0,!1,1,!1,!1,!1,!1,!1)>6){var s=null,h=null;o.photos[e-1]&&(h=o.photos[e-1]),o.photos[e+1]&&(s=o.photos[e+1]),o._checkSimilarityAgainstFound(o.goodPhotos,t,h,s,"NoStrongSimilarity")||(c[n]=1,l[n]=1,o.recPortraitAdditionToGood.push(t.id),o.goodPhotos.push(t),t.allParams.Good=!0,r=!0,f++)}if(!l[n]&&!r&&t.allParams.NumOfFaces<=1&&t.allParams.AverageFaceSize>.1&&t.getRank(!1,!1,!1,!1,1,!1,!1,!1,!1,!1)>6.1){var u=null,d=null;o.photos[e-1]&&(d=o.photos[e-1]),o.photos[e+1]&&(u=o.photos[e+1]),o._checkSimilarityAgainstFound(o.goodPhotos,t,d,u,"NoStrongSimilarity")||(l[n]=1,o.recFacesAdditionToGood.push(t.id),o.goodPhotos.push(t),t.allParams.Good=!0,r=!0,f++)}}}})}),this.batches.forEach(function(t){if(t.photos.length>=3){var e=0,r=null;t.photos.forEach(function(t){t.allParams.Good&&e++,r?t.getRank(!1,!1,!1,!1,1,0,2,!1,!1,!1)>r.getRank(!1,!1,!1,!1,1,0,2,!1,!1,!1)&&(r=t):r=t}),0===e&&(r.allParams.NumOfFacesEstimation>0?r.getRank(!0,!1,!1,!1,1,!1,!1,!1,!1,!1)>6&&(o.goodPhotos.push(r),r.allParams.Good=!0,o.batchAdditionToGood.push(r.id)):r.getRank(!0,!1,!1,!1,1,!1,!1,!1,!1,!1)>4.5&&(o.goodPhotos.push(r),r.allParams.Good=!0,o.batchAdditionToGood.push(r.id)))}}),this.origPhotos.length>0&&(this.photos=this.origPhotos),r)for(var d=0,p=0;p<this.photos.length;p++){var g=this.photos[p],m=!!this.photos[p+1]&&this.photos[p+1];if(!m||!t._checkSimilarTest(g,m)){if(p-d>0)for(var v=0,P=0,y=d;y<=p;y++)this.photos[y].allParams.Good?v++:(this.photos[y].allParams.removedBasedOnSimilarity=!(y===p&&P>0&&0===v),P++);d=p+1}}}},{key:"selectGoodForBest",value:function(){h.sortPhotosByRank(this.goodPhotos,"AddRecognitionAndPortrait"),this.goodPhotos.length>0&&(this.goodForBestPhotos=[this.goodPhotos[0]])}},{key:"_addNextGoodPhoto",value:function(t,e,r,o){var a=this._getNextGoodPhoto(t,e,r,o,!1);a&&(this.goodPhotos.push(a),a.allParams.Good=!0)}},{key:"_getNextGoodPhoto",value:function(t,e,r,o,a){var n=this,i=null,s=[],h={},c="NoStrongSimilarity";return a&&(c="SamePhoto"),this.photos.forEach(function(t,e){if(t.allParams.Good){h[t.id]||(s.push(t),h[t.id]=1);for(var r=e;r>0&&u.checkSimilarity(c,n.photos[r-1],n.photos[r]);r--)h[n.photos[r-1].id]||(s.push(n.photos[r-1]),h[n.photos[r-1].id]=1);for(var o=e;o<n.photos.length-1&&u.checkSimilarity(c,n.photos[o],n.photos[o+1]);o++)h[n.photos[o+1].id]||(s.push(n.photos[o+1]),h[n.photos[o+1].id]=1)}}),this.photos.forEach(function(c,l){var f=null,d=null,p=null;if(n.photos[l-1]&&(f=n.photos[l-1]),n.photos[l+1]&&(d=n.photos[l+1]),a)(p=n._checkSimilarityAgainstFound(s,c,f,d,"SamePhoto"))||(p=n._checkSimilarityAgainstFound(n.goodPhotos,c,f,d,"SamePhoto"))||(p=n._checkFound(n.goodPhotos,c));else{if(t>0&&0===r&&0===c.allParams.FacesArr.length)return;if(0===t&&r>0&&c.allParams.FacesArr.length>0)return;p=n._checkSimilarityAgainstFound(s,c,f,d,o),p||(p=n._checkSimilarityAgainstFound(n.goodPhotos,c,f,d,o)),p&&(h[c.id]||(s.push(c),h[c.id]=1))}if(!p){if(c.allParams.FacesArr&&c.allParams.FacesArr.length>0){if(!(u.round2(c.getRank(!0,!1,!1,!1,1,!1,!1,!1,!1,!1))>=t||u.round2(c.getRank(!1,!1,!1,!1,1,!1,!1,!1,!1,!1))>=e))return}else if(!(u.round2(c.getRank(!0,!1,!1,!1,1,!1,!1,!1,!1,!1))>=r))return;i?n.includeNumOfFacesFactor?i.getRank(!1,!1,!1,!1,1,!1,2,!1,!1,!1)<c.getRank(!1,!1,!1,!1,1,!1,2,!1,!1,!1)&&(i=c):i.getRank(!0,!1,!1,!1,1,!1,2,!1,!1,!1)<c.getRank(!0,!1,!1,!1,1,!1,2,!1,!1,!1)&&(i=c):i=c}}),i||a||(i=this._getNextGoodPhoto(t,e,r,o,!0)),i}},{key:"_checkFound",value:function(t,e){var r=!1;return t.some(function(t){if(t.id===e.id)return r=!0,!0}),r}},{key:"_checkSimilarityAgainstFound",value:function(t,e,r,o,a){var n=!1;return t.some(function(t){return t.id===e.id?(n=!0,!0):(r&&t.id===r.id&&(n=u.checkSimilarity(a,r,e)),o&&t.id===o.id&&(n=u.checkSimilarity(a,e,o)),!!n||void 0)}),n}}],[{key:"_checkSimilarTest",value:function(t,e){var r=Math.abs(e.allParams.TimeStamp-t.allParams.TimeStamp),o=e.allParams.Similarity1,a=e.allParams.Similarity2,n=e.allParams.DirectionSimilarity,i=e.allParams.TextureScaleSimilarity;return(o>=97||a>=99&&n>=95&&o>=90||a>=90&&n>=90&&i>=90||a>=98&&o>=90&&n>=95||a>=99&&o>=90&&n>=90||n>=99||i>=80&&n>=97&&o>=80||0===r||r<=1&&(o>=85||n>=90)||a+n+o+i>368)&&t.allParams.SubClusterIndex===e.allParams.SubClusterIndex&&e.allParams.Position-t.allParams.Position==1}}]),t}();t.exports=c},function(t,e){},function(t,e,r){"use strict";function o(t){return t&&t.__esModule?t:{default:t}}var a=r(0),n=o(a),i=r(1),s=o(i),h=r(2),u=function(){function t(e,r,o,a,i,s){var h=this;(0,n.default)(this,t),this.rankVector=e,this.photoIds=[],r.forEach(function(t){h.photoIds.push(t.id)}),this.groups=a,this.photosStrip=o,this.clusters=i||[],this.smartGroups=s||{}}return(0,s.default)(t,[{key:"isVector",value:function(t){var e=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],o=!0;return t.length===this.photoIds.length+r.length&&(t.some(function(t){if(void 0===e.rankVector.find(function(e){return e.id===t.id})&&void 0===r.find(function(e){return e.id===t.id}))return o=!1,!0}),this.rankVector.some(function(e){if(void 0===t.find(function(t){return t.id===e.id}))return o=!1,!0}),o)}},{key:"rankPhotos",value:function(){var t={};return this.rankVector.forEach(function(e){var r=e.getRank(!0,!0,!0,!0,1,!1,1,!1,!0,!1);t[e.id]=h.round2(r)}),t}}]),t}();t.exports=u},function(t,e,r){"use strict";function o(t){return t&&t.__esModule?t:{default:t}}var a=r(0),n=o(a),i=r(1),s=o(i),h=r(164),u=r(33),c=r(165),l=function(){function t(e,r){var o=arguments.length>2&&void 0!==arguments[2]&&arguments[2];(0,n.default)(this,t),this.rankVector=[],this.photosStrip=[],this.bestPhotos=[],this.clusters=[],this.photos=[],this._copyPhotosToWorkOn(e),this.groups=[],this.smartGroups={},this.reuseThisSelection=!0,this.userInfo=r||!1,this.onlySmarts=o}return(0,s.default)(t,[{key:"getRankVector",value:function(t){var e=this;try{e._initRanks(),void 0===t&&e._createPhotosGroups()}catch(t){throw t}return{rankVector:e.rankVector,photosStrip:e.photosStrip,groups:e.groups,bestPhotos:e.bestPhotos,reuseThisSelection:e.reuseThisSelection,clusters:e.clusters,smartGroups:e.smartGroups}}},{key:"_initRanks",value:function(){var t=this,e=void 0;try{e=new h(t.env).getRanks(t.photos),t.rankVector=e.rankVector,t.photosStrip=e.photoStrip,t.bestPhotos=e.bestPhotos,t.clusters=e.clusters,t.reuseThisSelection=e.reuseThisSelection}catch(t){throw t}}},{key:"_copyPhotosToWorkOn",value:function(t){var e=t.map(function(t){return new u(t.allParams)});return this.photos=e,e}},{key:"_createPhotosGroups",value:function(){var t=new c(this.rankVector,this.bestPhotos,this.clusters);this.onlySmarts||(this.groups=t.findProductPhotosMaterial());var e=["vips","groupshots"];t.createSmartGroups(this.userInfo,e),this.smartGroups=t.smartGroups}}]),t}();t.exports=l},function(t,e,r){"use strict";function o(t){return t&&t.__esModule?t:{default:t}}var a=r(0),n=o(a),i=r(1),s=o(i),h=r(33),u=r(6),c=r(84),l=function(){function t(e){(0,n.default)(this,t),this.photos=[],this.rankVector=[],this.env=e,this.bestPhotos=[],this.photosStrip=[],this.reuseThisSelection=!0,this.hasFake=!1}return(0,s.default)(t,[{key:"getRanks",value:function(t){var e=this;e.photos=t;try{e._init()}catch(t){throw t}return{rankVector:e.rankVector,photoStrip:e.photosStrip,bestPhotos:e.bestPhotos,reuseThisSelection:e.reuseThisSelection,clusters:e.select.clusters}}},{key:"_init",value:function(){var t=this;try{t._getRankedPhotos(),t.rankVector.forEach(function(e,r){e.PosInPhotosArr=r,e.allParams.Best&&t.bestPhotos.push(new h(e.allParams,r))})}catch(t){throw t}}},{key:"_getRankedPhotos",value:function(){try{var t=this,e=[],r=[];if(t.photos.forEach(function(t){if(t.allParams.PhotoID||(t.allParams.PhotoID=t.id?t.id:t.locSpec),t.addFakeRank||t.allParams&&t.allParams.addFakeRank){var o=t.id?t.id:t.locSpec;r.push(o)}else t.allParams.notRotatedSize||(t.allParams.notRotatedSize={width:t.allParams.OrigWidth,height:t.allParams.OrigHeight}),e.push(t)}),t.rankVector=[],r.length>0){var o=t._createFakeRankVector(r,!0);e=e.concat(o)}if(!(e.length>0))throw"missing attributes for fake rank";t._getRankVector(e),t.rankVector=t.select.rankVector,t._buildPhotoStripArr(t.rankVector)}catch(t){throw t}}},{key:"_findPhotoInArr",value:function(t,e){return u.find(e,function(e){return e.id&&e.id===t||e.locSpec&&e.locSpec===t})}},{key:"_buildPhotoStripArr",value:function(){this.photosStrip=this.rankVector.map(function(t){return{photoId:t.id,url:t.allParams.Url}})}},{key:"_createFakeRankVector",value:function(t,e){var r=this;console.log("creating fake ranks");try{var o=[];return t.forEach(function(t){var a=r._findPhotoInArr(t,r.photos);if(a&&a.allParams.url&&a.allParams.origWidth&&a.allParams.origHeight&&a.allParams.dateTaken){a.allParams.gotTimeout||(r.reuseThisSelection=!1);var n=a.allParams;n.notRotatedSize={width:n.origWidth,height:n.origHeight},n.IsFakeRank=!0,n.PhotoID=t,n.TimeStamp=n.dateTaken,n.FacesRank=e?0:7,n.BackgroundRank=e?0:7,n.Good=!e,n.SubClusterTimeStamp=n.TimeStamp+(Math.floor(1e3*Math.random())+1),n.PhotoParams={};for(var i=1;i<5;i++){var s="DominantCol"+i,u="DominantPercent"+i;n.PhotoParams[s]="A0C2DB",n.PhotoParams[u]=25}e&&(n.RankPos=9999999);var c=new h(n);a.gotTimeout&&(c.gotTimeout=!0),o.push(c)}}),o}catch(t){throw console.log("error creating fake rank"),t}}},{key:"_getRankVector",value:function(t){try{this.select=new c(t),this.select.activateSelection(!1,"",!0)}catch(t){throw t}}}]),t}();t.exports=l},function(t,e,r){"use strict";function o(t){return t&&t.__esModule?t:{default:t}}var a=r(0),n=o(a),i=r(1),s=o(i),h=r(4),u=r(2),c=r(83),l=r(6),f={vips:["allVips","allKids","someVipsAndOthers","allVipsAndOthers","allKidsAndOthers"],groupshots:["moreThan4"]},d=function(){function t(e,r,o){(0,n.default)(this,t),this.rankVector=e,this.groups=[],this.goodPhotos=[],this.numOfPhotoGroups=5,this.bestPhotos=r,this.clusters=o,this.ranksLimits=[10,30,80],this.maxVipsRankReduce={},this.ranks={10:0,30:0,80:0,avg:0},this.smartGroups={up1:[],up2:[],up3:[],up4:[],up5:[]},this.vips=[],this.kids=[],this.parents=[],this.photosGroups={allVips:[],allKids:[],someVipsAndOthers:[],allVipsAndOthers:[],allKidsAndOthers:[],someVips:{},mostVips:[],moreThan10:[],others:{},noFaces:[],kids:{},parents:{},moreThan4:[],vips:{}}}return(0,s.default)(t,[{key:"_calcRankRange",value:function(t){var e=this;h.sortPhotosOnlyRank(t);var r=0,o=0;t.forEach(function(a){o+=a.allParams.rank,r==Math.round(t.length*(e.ranksLimits[0]/100))?e.ranks[e.ranksLimits[0]]=a.allParams.rank:r==Math.round(t.length*(e.ranksLimits[1]/100))?e.ranks[e.ranksLimits[1]]=a.allParams.rank:r==Math.round(t.length*(e.ranksLimits[2]/100))&&(e.ranks[e.ranksLimits[2]]=a.allParams.rank),r++}),this.ranks.avg=o/t.length}},{key:"_findVips",value:function(t){var e=this;t?(e.vips=void 0!==t.vipsObj?Object.keys(t.vipsObj):[],t.numOfParents>0&&(e.kids=t.kids,e.parents=t.parents)):e.rankVector.forEach(function(t){t.allParams.Vips&&t.allParams.Vips.length>0&&t.allParams.Vips.forEach(function(t){l.contains(e.vips,t)||e.vips.push(t)})})}},{key:"createSmartGroups",value:function(t,e){var r=this;r._findVips(t);var o=this.rankVector;r._orderPhotos(o);var a=[];e.forEach(function(t){r._create1UpGroup(t,a)}),r._removeClose1UpGroups(),r._sortUpGroupsByRank()}},{key:"_sortUpGroupsByRank",value:function(){var t=this;Object.keys(this.smartGroups).forEach(function(e){h.sortGroupRank(t.smartGroups[e])})}},{key:"_orderPhotos",value:function(t){var e=this;t.forEach(function(t){if(t.allParams.hasOwnProperty("FacesArr")&&t.allParams.FacesArr.length>0){if(t.allParams.FacesArr.length>=2&&e.photosGroups.moreThan4.push(t),t.allParams.hasOwnProperty("Vips")&&t.allParams.Vips.length>0)if(t.allParams.FacesArr.length==t.allParams.Vips.length){if(1==t.allParams.Vips.length&&(l.contains(e.kids,t.allParams.Vips[0])?(e.photosGroups.kids.hasOwnProperty(t.allParams.Vips[0])||(e.photosGroups.kids[t.allParams.Vips[0]]=[]),e.photosGroups.kids[t.allParams.Vips[0]].push(t)):(e.photosGroups.vips.hasOwnProperty(t.allParams.Vips[0])||(e.photosGroups.vips[t.allParams.Vips[0]]=[]),e.photosGroups.vips[t.allParams.Vips[0]].push(t))),t.allParams.Vips.length==e.kids.length){var r=!1;e.kids.some(function(e){if(!l.contains(t.allParams.Vips,e))return r=!0,!0}),r||e.photosGroups.allKids.push(t)}t.allParams.Vips.length==e.vips.length?e.photosGroups.allVips.push(t):(e.photosGroups.someVips.hasOwnProperty(t.allParams.Vips.length.toString())||(e.photosGroups.someVips[t.allParams.Vips.length.toString()]=[]),e.photosGroups.someVips[t.allParams.Vips.length.toString()].push(t),t.allParams.Vips.length>e.vips.length/2&&e.photosGroups.mostVips.push(t))}else if(t.allParams.Vips.length==e.vips.length){e.photosGroups.allVipsAndOthers.push(t);var o=!1;e.kids.some(function(e){if(!l.contains(t.allParams.Vips,e))return o=!0,!0}),o||e.photosGroups.allKidsAndOthers.push(t)}else e.photosGroups.someVipsAndOthers.push(t)}else e.photosGroups.noFaces.push(t)}),Object.keys(e.photosGroups).forEach(function(t){Array.isArray(e.photosGroups[t])?h.sortPhotosByDate(e.photosGroups[t]):Object.keys(e.photosGroups[t]).forEach(function(r){h.sortPhotosByDate(e.photosGroups[t][r])})})}},{key:"_create1UpGroup",value:function(t,e){var r=this,o=this;f[t].forEach(function(a){var n="someVipsAndOthers"==a;r._create1UpBocketOfPhotos(o.photosGroups[a],n,e).forEach(function(r){e.push(r.id),o._addGroupTo1Up(r,t)})})}},{key:"_addGroupTo1Up",value:function(t,e){var r=this,o=Math.round((new Date).getTime()/1e3),a=new c(t);if(a.markAsSmart(),a.addGroupRank(),a.addPhoto(t),"vips"==e){a.rank+=3;var n=r._checkMaxVipsRankPer(t);n=void 0!==n?n:1,a.rank=a.rank*n,a.rank-=.1*(o-t.allParams.TimeStamp)/86400}else a.rank-=(o-t.allParams.TimeStamp)/86400;a.rank+=100,r.smartGroups.up1.push(a)}},{key:"_create1UpBocketOfPhotos",value:function(t,e,r){var o=this,a=[];return t.forEach(function(t){(!e||o._checkMaxVipsRankPer(t,"Vips")<1||o._checkMaxVipsRankPer(t,"Kids")<1)&&!l.contains(r,t.id)&&a.push(t)}),a}},{key:"_removeClose1UpGroups",value:function(){var t=this,e=[];t.smartGroups.up1.forEach(function(r,o){l.contains(e,r.ID)||t.smartGroups.up1.forEach(function(t,o){r.ID!=t.ID&&!l.contains(e,t.ID)&&Math.abs(r.mainPhotos[0].allParams.TimeStamp-t.mainPhotos[0].allParams.TimeStamp)<3e4&&(r.rank>t.rank?e.push(t.ID):e.push(r.ID))})});var r=[];t.smartGroups.up1.forEach(function(t,o){l.contains(e,t.ID)||r.push(t)}),t.smartGroups.up1=r}},{key:"_checkMaxVipsRankPer",value:function(t,e){var r=this;if(r.maxVipsRankReduce.hasOwnProperty(t.id))return r.maxVipsRankReduce[t.id];if(void 0!==e){var o=e.toLowerCase(),a=t.allParams.FacesArr.length-t.allParams[e].length,n=1;switch(r[o].length){case 1:case 2:break;case 3:2==t.allParams[e].length&&1==a&&(n=.7);case 4:2==t.allParams[e].length&&2==a?n=.5:3==t.allParams[e].length&&1==a&&(n=.75);break;default:var i=r[o].length;t.allParams[e].length==i-2&&2==a?n=.6:t.allParams[e].length==i-1&&1==a?n=.9:t.allParams[e].length==i-2&&1==a&&(n=.5)}return r.maxVipsRankReduce[t.id]=n,r.maxVipsRankReduce[t.id]}}},{key:"createGroupWithConditions",value:function(t,e,r){var o=this,a=86400*t,n=[],i=[];1==e&&function(){for(var t=0,e=!1,r=void 0,s=o.photosGroups.kids.hasOwnProperty(o.kids[0])?o.photosGroups.kids[o.kids[0]]:[];t<s.length&&l.contains(i,s[t].id);)if(++t<s.length&&!l.contains(i,s[t].id)){e=s[t].allParams.TimeStamp,r=new c(s[t]),r.markAsSmart(),r.addPhoto(s[t]);for(var h=1,u=!0;o.photosGroups.kids.hasOwnProperty(o.kids[h])&&h<o.kids.length&&1==u;)u=!1,o.photosGroups.kids[o.kids[h]].some(function(t){if(!l.contains(i,t.id)&&Math.abs(t.allParams.TimeStamp-e)<=a)return r.addPhoto(t),u=!0,!0}),h++;u&&(r.photos.forEach(function(t){i.push(t.id)}),n.push(r))}}()}},{key:"_findGroupsForRankAndInterval",value:function(t,e,r,o,a){var n=this,i=86400*t,s=n.ranks[e],h=Math.round((new Date).getTime()/1e3);r.forEach(function(e,u){try{if(e.allParams.tags&&l.contains(e.allParams.tags,"allFamily")&&!e.grouped){var f=new c(e);f.markAsSmart(),f.addPhoto(e),n.smartGroups.up1.push(f)}else e.allParams.Vips.length<n.vips.length&&e.allParams.rank>=s&&e.allParams.Vips.length>0&&!e.grouped&&("onlyVips"==o&&e.allParams.Vips.length==e.allParams.FacesArr.length||"vipsAndOthers"==o&&e.allParams.Vips.length<=e.allParams.FacesArr.length)&&function(){var f=new c(e);f.rank-=(h-e.allParams.TimeStamp)/864e4,f.markAsSmart(),f.addPhoto(e);for(var d=l.reject(n.vips,function(t){return l.contains(e.allParams.Vips,t)}),p=1,g=u+p<r.length?r[u+p]:e;g.allParams.TimeStamp-e.allParams.TimeStamp<=i&&d.length>0&&u+p<r.length;){if(g.allParams.rank>=s&&g.allParams.Vips.length>0&&!g.grouped){for(var m=0,v=!1;!v&&m<g.allParams.Vips.length;)l.contains(d,g.allParams.Vips[m])&&(v=!0),m++;v&&("onlyVips"==o&&g.allParams.Vips.length==g.allParams.FacesArr.length||"vipsAndOthers"==o)&&(f.addPhoto(g),d=l.reject(d,function(t){return l.contains(g.allParams.Vips,t)}))}p++,u+p<r.length&&(g=r[u+p])}if(0==d.length&&f.photos.length>1){var P=!0;if(f.photos.some(function(t){if(t["grouped"+f.photos.length.toString()])return P=!1,!0}),P){var y="up"+f.photos.length.toString();n.smartGroups[y].push(f),f.addGroupRank(),f.rank-=t,f.rank-=a,f.photos.forEach(function(t){t["grouped"+f.photos.length.toString()]=!0})}}}()}catch(t){}})}},{key:"findProductPhotosMaterial",value:function(){var t=this;if(this.goodPhotos=u.sumGoodPhotos(this.rankVector),this.goodPhotos.length<8){0===this.goodPhotos.length&&(this.goodPhotos=this.rankVector),h.bestFamilyPhoto(this.goodPhotos);var e=new c(this.goodPhotos[0]);e.addPhoto(this.goodPhotos[0]),this.groups.push(e),this.goodPhotos.forEach(function(r){r!==t.goodPhotos[0]&&(e.addPhoto(r),r.getBaseRank()>6&&e.mainPhotos.push(r)),h.sortGroupRank(t.groups)}),e.addGroupRank()}else{this.groups=[];var r={};this._groupingFromSubClusters(r);for(var o=0;o<2;o++){this._mergeCloseSmallGroups(),h.sortGroupRank(this.groups);var a=0;this.groups.forEach(function(t){a+=t.photos.length}),a<=10&&this.groups.length>1&&this._mergeAllGroups(),this._getMaxNumPhotosInGroups<8&&this.groups.length>0&&this._extendGroups();for(var n=this._getMaxNumPhotosInGroups();n<5&&this.groups.length>1;)this._mergeCloseGroups(),n=this._getMaxNumPhotosInGroups();0===o&&this._removeToSimilarPhotos()}}return this.groups.forEach(function(t){t.sortAndRankPhotos()}),this.groups}},{key:"_removeToSimilarPhotos",value:function(){this.groups.forEach(function(t){for(var e=0;e<t.photos.length;e++)for(var r=e+1;r<t.photos.length;r++)Math.abs(t.photos[e].allParams.TimeStamp-t.photos[r].allParams.TimeStamp)<10&&(t.photos[e].allParams.RankPos<=t.photos[r].allParams.RankPos?t.photos.splice(r,1):(t.photos.splice(e,1),e>0&&e--),r--)})}},{key:"_getOrigPhotos",value:function(){var t=[];return this.goodPhotos.length<31?(t=this.bestPhotos?this.bestPhotos:[],this.rankVector.forEach(function(e){e.allParams.Good&&!e.allParams.Best&&e.isProductWorthyPhoto(!1)&&t.push(e)}),t):t=this.bestPhotos}},{key:"_updateCorrectPosInArr",value:function(t){this.rankVector.forEach(function(e){t.id===e.id&&(t.allParams.PosInPhotosArr=e.allParams.PosInPhotosArr)})}},{key:"_mergeCloseSmallGroups",value:function(){var e=this,r=[];this.groups.forEach(function(o){o.CollideOptions&&!o.ignore&&Object.keys(o.CollideOptions).forEach(function(a){var n=null,i=e._getGroupById(a);i&&(n=e.groups[i],!n.Ignore&&o.photos.length+n.photos.length<10&&Math.abs(Math.max(o.minTimeStamp,n.minTimeStamp)-Math.min(o.maxTimeStamp,n.maxTimeStamp))<3600&&(t._mergeGroups(o,n),r.push(i)))}),o.addGroupRank()}),r.forEach(function(t){e.groups.splice(t,1)})}},{key:"_getGroupById",value:function(t){var e=l.find(this.groups,function(e){return e.ID===t});return!!e&&this.groups.indexOf(e)}},{key:"_mergeAllGroups",value:function(){var e=this.groups[0];this.groups.forEach(function(r){r.Ignore||r.ID===e.ID||(t._mergeGroups(e,r),r.Ignore=!0)}),this.groups=[e]}},{key:"_getMaxNumPhotosInGroups",value:function(){var t=0;return this.groups.forEach(function(e){t=Math.max(t,e.photos.length)}),t}},{key:"_extendGroups",value:function(){var t=this,e={};this.groups.forEach(function(t){t.photos.forEach(function(r){e[r.id]=t.ID})}),this.groups.forEach(function(r){r.mainPhotos.forEach(function(o){r.loopAfterMainPhotoForGroup(e,iterationCount,300,o.PosInPhotosArr+1,t.rankVector),r.loopBeforeMainPhotoForGroup(e,iterationCount,300,o.PosInPhotosArr-1,t.rankVector)})}),h.sortGroupRank(this.groups)}},{key:"_mergeCloseGroups",value:function(){var e=this,r=0,o=0,a=1e8;this.groups.forEach(function(t,n){if(n<e.groups.length-1){var i=Math.abs(e.groups[n+1].minTimeStamp-t.minTimeStamp);i<a&&(a=i,r=n,o=n+1)}});var n=this.groups[r],i=this.groups[o];t._mergeGroups(n,i),this.groups.splice(o,1),h.sortGroupRank(this.groups)}},{key:"_groupingBestPhotos",value:function(t,e,r,o){var a=null,n=this;t.forEach(function(t){var i=n._getGroupById(t.id);i?a=n.groups[i]:e[t.id]||(a=new c(t),a.addPhoto(t),a.fromIndex=t.PosInPhotosArr-1,a.toIndex=t.PosInPhotosArr+1,e[t.id]=t.id,n.groups.push(a)),a&&(a.toIndex=a.loopAfterMainPhotoForGroup(e,r,o,a.toIndex,n.rankVector),a.fromIndex=a.loopBeforeMainPhotoForGroup(e,r,o,a.fromIndex,n.rankVector),a.addGroupRank())})}},{key:"_groupingFromSubClusters",value:function(t){var e=this;e.clusters.forEach(function(r){r.subClusters.forEach(function(r){h.sortBestAndRank(r.goodPhotos);var o=r.goodPhotos[0];if(o&&o.allParams.Best){var a=new c(o);a.addPhoto(o),a.fromIndex=o.PosInPhotosArr-1,a.toIndex=o.PosInPhotosArr+1,t[o.id]=o.id,e.groups.push(a),a.addGroupRank(),h.sortBestAndRank(r.photos),r.photos.forEach(function(e){e.id!==a.ID&&(e.isProductWorthyPhoto(!1)&&!e.allParams.removedBasedOnSimilarity||e.allParams.Good)&&(t[e.id]?(a.CollideOptions={},a.CollideOptions[t[e.id]]=1):(e.allParams.Best&&a.mainPhotos.push(e),a.addPhoto(e),a.photosLength++,t[e.id]=a.ID))}),a.addGroupRank()}})})}}],[{key:"_mergeGroups",value:function(t,e){t.photos=l.union(t.photos,e.photos),t.minTimeStamp=Math.min(t.minTimeStamp,e.minTimeStamp),t.maxTimeStamp=Math.max(t.maxTimeStamp,e.maxTimeStamp),t.mainPhotos=l.union(t.mainPhotos,e.mainPhotos),t.origPhotos=t.photos,e.Ignore=!0}}]),t}();t.exports=d},function(t,e,r){"use strict";function o(t){return t&&t.__esModule?t:{default:t}}var a=r(0),n=o(a),i=r(1),s=o(i),h=(r(82),r(4)),u=r(6),c=function(){function t(e,r,o){var a=this;(0,n.default)(this,t),this.layouts={frontCover:{},backCover:{},core:{},spread:{}},e.forEach(function(t){var e=void 0!==t.size?t.size:o,n=void 0!==t.type?t.type:r;a.addLayout(t,n,e)})}return(0,s.default)(t,[{key:"addLayout",value:function(t,e,r){this.layouts[e][r]?this.layouts[e][r].push(t):this.layouts[e][r]=[t]}},{key:"GetLayouts",value:function(t,e,r){for(var o=this,a=e,n=Number(u.max(Object.keys(o.layouts[t]),function(t){return Number(t)}));a<=n&&(!o.layouts[t][a]||0==o.layouts[t][a].length);)a++;if(a>n)for(a=e;a>=0&&(!o.layouts[t][a]||0==o.layouts[t][a].length);)a--;if(a<0)throw"No Layouts to Choose From";return this._filterLayouts(o.layouts[t][a],r)}},{key:"_filterLayouts",value:function(t,e){var r=this;if(t.length<6)return t.slice(0);var o=[];if(t.forEach(function(t){r._checkPhotosWellSizeInLayouts(t,.6)&&o.push(t)}),o.length<3){var a=[];t.forEach(function(t){r._checkPhotosWellSizeInLayouts(t,.4)&&a.push(t)})}return o.length<3?(h.sortLayoutWellPercent(t),t.slice(0,3)):o}},{key:"_checkPhotosWellSizeInLayouts",value:function(t,e){"135"==t.id&&console.log("");var r=0;return t.wells.forEach(function(e){"image"==e.type&&(r+=t.width*(e.width/100)*(e.height/100*t.height))}),!(r/(t.width*t.height)<e)}}]),t}();t.exports=c},function(t,e,r){"use strict";function o(t){return t&&t.__esModule?t:{default:t}}var a=r(0),n=o(a),i=r(1),s=o(i),h=r(4),u=r(2),c=r(6),l=r(34),f=function(){function t(e,r,o,a){(0,n.default)(this,t),this.feedback={fitWell:{originals:{},feedbacks:{}},fitLayouts:{originals:{},feedbacks:{}}},this.debug=a,this.sdkVersion=e,this.loopStarted=!1,this.env=r,this.monitorSer=o}return(0,s.default)(t,[{key:"addSDKRes",value:function(t,e){try{switch(t){case"fitWell":this._saveFitWellSDK(e);break;case"fitLayouts":this._saveFitLayoutsSDK(e)}}catch(t){}}},{key:"addUserRes",value:function(t,e){switch(t){case"fitWell":this._saveFitWellUser(e);break;case"fitLayouts":this._saveFitLayoutsUser(e)}}},{key:"_saveFitWellSDK",value:function(t){if(t.photoScored){var e=t.photoId+"_"+t.well.width+"x"+t.well.height;this.feedback.fitWell.originals[e]=t}}},{key:"_saveFitLayoutsSDK",value:function(t){var e=this,r=this;t.result.layouts.forEach(function(o){var a=[],n="",i=r._getLayout(o.id,t.layouts);h.sortWellsAccordingToPhotosIds(o.photos),o.photos.forEach(function(e){n+=e.photoId;var o={photoId:e.photoId,well:r._getWell(i.wells,e.wellIndex,i.width,i.height,!1),photoScored:!r._getPhotoParams(e.photoId,t.photos).IsFakeRank,crop:e.crop};r._saveFitWellSDK(o),a.push({photoId:e.photoId,wellIndex:e.wellIndex,photoScored:o.photoScored})});var s=parseInt(n).toString(16),u=s+"_"+o.id,c={photos:a,layout:i};e.feedback.fitLayouts.originals[u]=c})}},{key:"_getLayout",value:function(t,e){return c.find(e,function(e){return e.id==t})}},{key:"_getPhotoParams",value:function(t,e){return c.find(e,function(e){return e.id==t}).allParams}},{key:"_getWell",value:function(t,e,r,o,a){var n=a;return n||(n=c.find(t,function(t){return t.wellIndex==e})),{width:u.round2(n.width/100*r),height:u.round2(n.height/100*o)}}},{key:"_saveFitWellUser",value:function(t){var e=t.photoId+"_"+t.well.width+"x"+t.well.height;this.feedback.fitWell.originals[e]&&this._checkIfCropChanged(t.userCrop,this.feedback.fitWell.originals[e].crop)&&(this.feedback.fitWell.feedbacks[e]={userId:t.userId,photoId:this.feedback.fitWell.originals[e].photoId,well:this.feedback.fitWell.originals[e].well,sdkCrop:this.feedback.fitWell.originals[e].crop,photoScored:this.feedback.fitWell.originals[e].photoScored,userCrop:t.userCrop},this.monitorSer.addFeedbackMessage("fitPhotoToWell"),this.loopStarted||this._saveFeedBacksLoop())}},{key:"_saveFitLayoutsUser",value:function(t){var e="",r=[],o=this;h.sortWellsAccordingToPhotosIds(t.layout.wells),t.layout.wells.forEach(function(t){t.photoId&&(e+=t.photoId,r.push({photoId:t.photoId,wellIndex:t.wellIndex}))});var a=parseInt(e).toString(16),n=a+"_"+t.layout.id;this.feedback.fitLayouts.originals[n]&&o._checkIfPhotosChanged(r,o.feedback.fitLayouts.originals[n].photos)&&(o.feedback.fitLayouts.feedbacks[n]={userId:t.userId,userPhotos:r,layouts:this.feedback.fitLayouts.originals[n].layout,sdkPhotos:this.feedback.fitLayouts.originals[n].photos},this.monitorSer.addFeedbackMessage("fitPhotosToLayouts"),o.loopStarted||o._saveFeedBacksLoop())}},{key:"_checkIfCropChanged",value:function(t,e){for(var r=!1,o=0;o<4;o++)if(u.absDiff(t[o],e[o])>.02){r=!0;break}return r}},{key:"_checkIfPhotosChanged",value:function(t,e){var r=!1;return t.some(function(t){var o=c.find(e,function(e){return e.photoId==t.photoId});if(o&&o.wellIndex!=t.wellIndex)return r=!0,!0}),r}},{key:"_sendFeedbacksToQueue",value:function(){var t=this,e=u.objectValues(t.feedback.fitWell.feedbacks),r=u.objectValues(t.feedback.fitLayouts.feedbacks);e.length>0&&l.sendFeedback(e,t.env,"fitWell").then(function(r){u.debugPrint("sendFeedbacksToQueue","sent "+e.length+" wells feedbacks",{},"feedbacks",t.debug)}).catch(function(e){u.debugPrint("sendFeedbacksToQueue","wells feedbacks got error:",e,"feedbacks",t.debug)}),r.length>0&&l.sendFeedback(r,t.env,"fitLayouts").then(function(r){u.debugPrint("sendFeedbacksToQueue","sent "+e.length+" layouts feedbacks",{},"feedbacks",t.debug)}).catch(function(e){u.debugPrint("sendFeedbacksToQueue","layouts feedbacks got error:",e,"feedbacks",t.debug)})}},{key:"_clearFeedbacks",value:function(){this.feedback.fitWell.feedbacks={},this.feedback.fitLayouts.feedbacks={}}},{key:"_saveFeedBacksLoop",value:function(){function t(){e._sendFeedbacksToQueue(),e._clearFeedbacks()}var e=this;e.loopStarted=!0,setInterval(t,6e4)}}]),t}();t.exports=f},function(t,e,r){"use strict";function o(t){return t&&t.__esModule?t:{default:t}}var a=r(0),n=o(a),i=r(1),s=o(i),h=(r(4),r(2)),u=r(6),c=r(34),l=function(){function t(e,r,o,a){(0,n.default)(this,t),this.inProcessPhotos=[],this.inProcessMonitorKey=!1,this.index=0,this.env=r||"prod",this.requests=[],this.jsonReqs={},this.sdkVersion=e,this.loopStarted=!1,this.source=o,this.debug=a,this._addInitMessage(),this.wellsCounts=0}return(0,s.default)(t,[{key:"addNewRequest",value:function(t){var e=this,r=Date.now(),o=e.index;return e.jsonReqs[o]={startTimeStamp:r,LastTimeStamp:r,type:t,source:e.source,onDemandType:""},e.index++,o}},{key:"setOnDemandAddPhotosFlag",value:function(t,e){var r=this,o=r.jsonReqs[t];r.inProcessMonitorKey?delete r.jsonReqs[t]:(o.onDemandType="_onDemand",r.inProcessMonitorKey=t),r._saveInProcessPhotos(e)}},{key:"finishAddPhotos",value:function(t,e,r){var o=this,a=!1;r&&(a=o._compareToInProcess(r)),a&&0==a.added.length&&o.inProcessMonitorKey?(o._finishAddPhotosByKey(e,o.inProcessMonitorKey),o.inProcessPhotos=[],o.inProcessMonitorKey=!1):a&&(o.inProcessPhotos=h.clone(a.removed)),o.jsonReqs.hasOwnProperty(t)&&(!a||a.added.length>0)&&o._finishAddPhotosByKey(e,t)}},{key:"_finishAddPhotosByKey",value:function(t,e){var r=this,o=r.jsonReqs[e],a=Date.now(),n={Source:o.source,EventName:o.type+o.onDemandType+"_total",Time:a-o.startTimeStamp};h.debugPrint("finishAddPhotos","adding addPhotos to events:",n,"monitor",r.debug),r.requests.push(n);var i={Source:o.source,EventName:o.type+o.onDemandType+"_normalized",Time:(a-o.startTimeStamp)/t};r.requests.push(i),r.loopStarted||r._saveMonitorLoop()}},{key:"_saveInProcessPhotos",value:function(t){var e=this;e.inProcessPhotos=e.inProcessPhotos.concat(t),e.inProcessPhotos=u.uniq(e.inProcessPhotos,function(t){return t.id?t.id:t.locSpec})}},{key:"finishFitFunc",value:function(t,e,r){var o=this,a=o.jsonReqs[t],n=Date.now(),i={Source:a.source,EventName:a.type+"_"+e,Time:n-a.LastTimeStamp};"total"==e&&(i.Time=n-a.startTimeStamp),a.LastTimeStamp=n,o.requests.push(i),r&&(o.wellsCounts+=r),o.loopStarted||o._saveMonitorLoop()}},{key:"_addInitMessage",value:function(){var t={Source:this.source,EventName:"magicSDK_init",Count:1};this.requests.push(t),this.loopStarted||this._saveMonitorLoop()}},{key:"addErrorMessage",value:function(t){var e=this,r=e.jsonReqs[t],o={Source:r.source,EventName:r.type+"_error",Count:1};e.requests.push(o),e.loopStarted||e._saveMonitorLoop()}},{key:"addFeedbackMessage",value:function(t){var e=this,r={Source:e.source,EventName:t+"_change",Count:1};e.requests.push(r),e.loopStarted||e._saveMonitorLoop()}},{key:"_sendRequestsToQueue",value:function(){var t=this;if(t.wellsCounts>0){var e={Source:t.source,EventName:"photoWellsFitted",Count:t.wellsCounts};t.wellsCounts=0,t.requests.push(e)}t.requests.length>0&&(h.debugPrint("sendRequestsToQueue","sending monitor events:",{events:t.requests},"monitor",t.debug),c.sendMonitor(t.requests,this.env).then(function(e){h.debugPrint("sendRequestsToQueue","success! sent "+t.requests.length+" monitor events",{},"monitor",t.debug)}).catch(function(e){h.debugPrint("sendRequestsToQueue","monitor got error:",e,"monitor",t.debug)}),t.requests=[])}},{key:"_saveMonitorLoop",value:function(){function t(){e._sendRequestsToQueue()}var e=this;e.loopStarted=!0,setInterval(t,6e4)}},{key:"_compareToInProcess",value:function(t){var e=[],r=[],o=[],a=this.inProcessPhotos;return!t||t&&0==t.length?{added:e,removed:a}:(t.forEach(function(t){var r=t.id?t.id.toString():t.locSpec;void 0===u.find(a,function(t){return t.id&&t.id.toString()==r||t.PhotoID==r})?e.push(t):o.push(t)}),a.forEach(function(e){var o=e.id?e.id.toString():e.PhotoID;e.id=o,void 0===u.find(t,function(t){return t.id&&t.id==o||t.locSpec&&t.locSpec==o})&&r.push(e)}),{added:e,removed:r,same:o})}}]),t}();t.exports=l},function(t,e,r){"use strict";function o(t){return t&&t.__esModule?t:{default:t}}var a=r(0),n=o(a),i=r(1),s=o(i),h=r(6),u=(r(2),r(4)),c=r(34),l=function(){function t(e){(0,n.default)(this,t),this.userId=e.userId,this.env=e.env,this.testVips=[{person:"81fabc7d-3805-44f0-8c74-cf4971575fc5",bday:"05-21-1984",gender:"female",relation:"wife",first:"Jennifer",last:"Sabbah"},{person:"6c085be2-dc82-45dd-bc4e-1c63fb5f2d18",bday:"02-21-2012",gender:"male",relation:"son",first:"Matan",last:"Sabbah"},{person:"6bc9b448-88c4-484c-8ff8-3666242683a7",bday:"01-19-2012",gender:"male",relation:"son",first:"Ariel",last:"Sabbah"},{person:"51bf851f-cc8d-4361-99b9-1fafe71cccf9",bday:"02-15-1983",gender:"male",relation:"me",first:"Yohann",last:"Sabbah"}],this.vips=[],this.vipsObj={},this.hasVips=!1,this.age=30,this.gender="m",this.user,this.partner={},this.kids=[],this.parents=[],this.friends=[],this.vipsPhotosIds=[],this.totalPhotosCount=0,this.createFake=!0,this.photos={vipsCount:{},kids:{1:[],2:[]},partner:{portrait:[],couple:[],kids:[]},friends:[],user:{portrait:[],kids:[]},fullFamily:[],faces:{}},this.photosForBigWells=[],this.photosForSmallWells=[],this.numOfParents=0,this.kidsRange={start:0,end:20},this.vipPromise=!1,e.vips&&(this._addFakeVips(e.vips),this.hasVips=!0),this.createFake||this._parseVips(e.vips)}return(0,s.default)(t,[{key:"_getVips",value:function(){var t=this,e=new Promise(function(e,r){c.getVips(t.userId,t.env).then(function(r){Array.isArray(r)&&r.length>0&&(t.hasVips=!0,t._addFakeVips(r),t.vipPromise=!1,e())}).catch(function(r){t.vipPromise=!1,e(r)})});t.vipPromise=e}},{key:"_addFakeVips",value:function(t){var e=this;t.forEach(function(t){if(t.hasOwnProperty("id")){var r={id:t.id};e.vips.push(r),e.photos.faces[r.id]={portrait:[],group:[]},e.vipsObj[r.id]=!0;var o=t.hasOwnProperty("ageGroup")&&t.ageGroup&&"kid"!==t.ageGroup?"parents":"kids";"parents"==o&&e.numOfParents++,e[o].push(t.id)}})}},{key:"_parseVips",value:function(t){var e=this;this.parents=this._getAndAddTopVipsByAgeRange(20,60,1,"parents"),e.kidsRange.start=Math.max(0,Number(e.parents[0].age)-45),e.kidsRange.end=Math.min(30,Number(e.parents[0].age)-20),this.kids=this._getAndAddTopVipsByAgeRange(e.kidsRange.start,e.kidsRange.end,7,"kids"),console.log()}},{key:"addToPhotos",value:function(t,e,r){var o=this;if(1==r?o.photos.faces[t.vips[0].recId].portrait.push(t):t.vips.forEach(function(e){o.photos.faces[e.recId].group.push(t)}),o.photos.vipsCount[r]||(o.photos.vipsCount[r]=[]),o.photos.vipsCount[r].push(t),o.totalPhotosCount++,!o.createFake){if(e.friends.length>=2)return void o.photos.friends.push(t);if(e.kids.length>0){if(e.partner.length>0)return e.user.length>0&&e.kids.length==o.kids.length&&r==o.kids.length+2?void o.photos.fullFamily.push(t):void o.photos.partner.kids.push(t);if(e.user.length>0)return void o.photos.user.kids.push(t);if(1==e.kids.length&&r>1)return;return o.photos.kids[e.kids.length]||(o.photos.kids[e.kids.length]=[]),void o.photos.kids[e.kids.length].push(t)}if(e.partner.length>0){if(e.user.length>0)return void o.photos.partner.couple.push(t);if(1==e.partner.length&&r>1)return;if(1==e.partner.length&&r>1){if(e.friends.length==r-1)return void o.photos.friends.push(t);return}return void o.photos.partner.portrait.push(t)}if(e.user.length>0){if(1==e.user.length&&r>1){if(e.friends.length==r-1)return void o.photos.friends.push(t);return}o.photos.user.portrait.push(t)}}}},{key:"parsePhotos",value:function(){var t=this;if(this.createFake){var e=u.sortJsonByBiggestKey(this.photos.vipsCount),r=0,o=e[r];for(t.photosForBigWells=t.photosForBigWells.concat(o[1]);t.photosForBigWells.length<.2*t.totalPhotosCount&&r<e.length-2;)r++,o=e[r],t.photosForBigWells=t.photosForBigWells.concat(o[1]);var a=e.length-1;for(o=e[a],t.photosForSmallWells=t.photosForSmallWells.concat(o[1]);t.photosForSmallWells.length<.2*t.totalPhotosCount&&a>r+1;)a--,o=e[a],t.photosForSmallWells=t.photosForSmallWells.concat(o[1])}else Object.keys(t.photos).forEach(function(e){Array.isArray(t.photos[e])&&u.sortBestAndRank(t.photos[e])}),Object.keys(t.photos.kids).forEach(function(e){u.sortBestAndRank(t.photos.kids[e])}),Object.keys(t.photos.partner).forEach(function(e){u.sortBestAndRank(t.photos.partner[e])}),Object.keys(t.photos.vipsCount).forEach(function(e){u.sortBestAndRank(t.photos.vipsCount[e])}),Object.keys(t.photos.faces).forEach(function(e){u.sortBestAndRank(t.photos.faces[e].portrait),u.sortBestAndRank(t.photos.faces[e].group)})}},{key:"_getAndAddTopVipsByAgeRange",value:function(t,e,r,o){for(var a=[],n=this,i=0;i<n.testSortedVips.length&&a.length<r;){var s=n.testSortedVips[i];Number(s.age)<e&&Number(s.age)>t&&(a.push(s),n.vips[s.id]=o,n.photos.faces[s.id]={portrait:[],group:[]}),i++}return a}},{key:"findPhotosOfGroup",value:function(t){for(var e=[],r=t.length;r>=2&&r>t.length-3;)this.photos.vipsCount[r].forEach(function(r){var o=!0;r.vips.some(function(e){if(void 0===h.find(t,function(t){return e.recId==t}))return o=!1,!0}),o&&e.push(r)}),r--;return e}}]),t}();t.exports=l},function(t,e){t.exports={name:"@pc/magicsdk",version:"1.0.14",description:"magicSDK repo",main:"index.js",scripts:{test:"./node_modules/.bin/jasmine spec/*","generate-docs":"./node_modules/.bin/jsdoc -c jdocConf.json",build:"webpack -p --output-library-target=umd","build-common":"webpack -p --output-library-target=commonjs2"},repository:{type:"git",url:"https://github.com/ShutterflyIsrael/MagicSDK.git"},publishConfig:{registry:"http://npm.photoccino.com:4873"},shutterfly:{publishBranch:"master",jenkinsBuildUrl:"https://build.stage.shutterfly.com/job/pc-magicsdk"},author:"gonnyg",license:"UNLICENSED",bugs:{url:"https://github.com/ShutterflyIsrael/MagicSDK/issues"},homepage:"https://github.com/ShutterflyIsrael/MagicSDK#readme",dependencies:{co:"^4.6.0",underscore:"^1.8.3",xmlhttprequest:"^1.8.0"},devDependencies:{"babel-cli":"^6.26.0","babel-core":"^6.26.0","babel-loader":"^7.1.2","babel-plugin-transform-runtime":"^6.23.0","babel-preset-env":"^1.6.1",jasmine:"^2.9.0",webpack:"^3.10.0","webpack-bundle-analyzer":"^2.9.2"},browser:{xmlhttprequest:!1}}}])});
//# sourceMappingURL=magic-sdk.js.map;
/* SOURCE: https://github.com/kmewhort/pointer_events_polyfill */

/*
 * Pointer Events Polyfill: Adds support for the style attribute "pointer-events: none" to browsers without this feature (namely, IE).
 * (c) 2013, Kent Mewhort, licensed under BSD. See LICENSE.txt for details.
 */

// constructor
function PointerEventsPolyfill(options){
    // set defaults
    this.options = {
        selector: '*',
        mouseEvents: ['click','dblclick','mousedown','mouseup'],
        usePolyfillIf: function(){
            if(navigator.appName == 'Microsoft Internet Explorer')
            {
                var agent = navigator.userAgent;
                if (agent.match(/MSIE ([0-9]{1,}[\.0-9]{0,})/) != null){
                    var version = parseFloat( RegExp.$1 );
                    if(version < 11)
                        return true;
                }
            }
            return false;
        }
    };
    if(options){
        var obj = this;
        $.each(options, function(k,v){
            obj.options[k] = v;
        });
    }

    if(this.options.usePolyfillIf())
        this.register_mouse_events();
}

// singleton initializer
PointerEventsPolyfill.initialize = function(options){
    if(PointerEventsPolyfill.singleton == null)
        PointerEventsPolyfill.singleton = new PointerEventsPolyfill(options);
    return PointerEventsPolyfill.singleton;
};

// handle mouse events w/ support for pointer-events: none
PointerEventsPolyfill.prototype.register_mouse_events = function(){
    // register on all elements (and all future elements) matching the selector
    $(document).on(this.options.mouseEvents.join(" "), this.options.selector, function(e){
        if($(this).css('pointer-events') == 'none'){
            // peak at the element below
            var origDisplayAttribute = $(this).css('display');
            $(this).css('display','none');

            var underneathElem = document.elementFromPoint(e.clientX, e.clientY);

            if(origDisplayAttribute)
                $(this)
                    .css('display', origDisplayAttribute);
            else
                $(this).css('display','');

            // fire the mouse event on the element below
            e.target = underneathElem;
            $(underneathElem).trigger(e);

            return false;
        }
        return true;
    });
};
define("PointerEventsPolyfill", function(){});

/*
This file includes the configuration for require.js compilation of the module and it's basic entry point.
 */
requirejs.config({
    baseUrl: 'scripts/lib',
    paths: {
        jquery: '//code.jquery.com/jquery-1.11.0.min', // use the right one here
        app: './app',
        text: './lib/require.text',
        json: './lib/require.json',
        css: './lib/require.css',
        md5: './lib/spark-md5.min',
        mgthumb: './lib/MgThumbGenerator.min',
        underscore: './lib/underscore-min',
        magicselect: './lib/MagicSelectBox',
        PointerEventsPolyfill: './lib/PointerEventsPolyfill',
        magicSDK: './lib/magic-sdk' // https://s3.amazonaws.com/magic-sdk/prod/v1/magic-sdk.js
    },
    map: {
        '*': {
            css: 'lib/require.css'
        }
    },
    shim: {
        mgthumb: {
            exports : 'mgthumb'
        },
        magicselect: {
            exports : 'magicselect'
        },
        'underscore': {
            exports: '_'
        }
    }
});

define('sdk', ['app/sdk_main', 'app/cache_module', 'app/utils', 'app/config_manager', 'app/product_proxy', 'app/utils', 'json!./app/json/configjson.json', 'json!./app/json/recipeunited.min.json', 'app/time_monitor', 'app/model', 'app/globals', 'magicSDK', 'PointerEventsPolyfill'], function(sdk_instance, cache, utils, config, productProxy, util, cfgJson, recipeJson, Monitor, Model, globals, magicSDK, pointerEvents) {
    var ASSET_VERSION = '1.4';

    if(typeof window.MagicShop === "undefined") {
        window.MagicShop = {};
    }

    // Extract paramateres passed to the script
    var scriptParams = utils.parse_query_vars($('script#prod-widget-sfly').attr('src'));

    // Temp fix for prevent double vertical widget on the smae page
    if((typeof scriptParams.mode === 'undefined' || typeof scriptParams.mode === 'mode1') && typeof window.MagicShop.verticalWidgetLoaded !== "undefined" && window.MagicShop.verticalWidgetLoaded == true )
    {
        console.log("[Product Widget] 2 widgets loaded skip one");
        return;
    }
    else if(typeof scriptParams.mode === 'undefined' || typeof scriptParams.mode === 'mode1') {
        if (!scriptParams.prodtype || (scriptParams.prodtype && scriptParams.prodtype !== 'calendar')) {
            return;
        }
        window.MagicShop.verticalWidgetLoaded = true;
    }

    // Make sure we don't use any old information, but retain the MgSource cache
    // Leave the keys only if it's the same user, otherwise clean everything
    if ((typeof scriptParams.partneruserid === 'undefined' || scriptParams.partneruserid != cache.get('partner_user_id', true)) && scriptParams.mode !== "instance") {
        cache.clearLocalStorage();
    }

    if (typeof scriptParams.mode === 'undefined' || scriptParams.mode !== "instance") {
        cache.clearCache();
    }

    // delete old cache (temporary solution - will deleted in future)
    if('localStorage' in window && window['localStorage'] !== null) {
        Object.keys(localStorage).forEach(function (key) {
            if (key.indexOf("Mg2:") === 0) {
                try{localStorage.removeItem(key);} catch (e){}
            }
        });
    }

    // For signout mode and horizontal mode, no UserId, use a fake user with models photos
    if ((typeof scriptParams.partneruserid === 'undefined' || scriptParams.partneruserid === "") && (scriptParams.mode == 'mode2'))
    {
        scriptParams.partneruserid = "009085953279";
        scriptParams.msg    = undefined; // Need to reset the message from outside (signin)
    }

    if (typeof scriptParams.partneruserid !== 'undefined') {
        cache.set('partner_user_id', scriptParams.partneruserid);
        //cache.set('partner_user_id', scriptParams.partneruserid, true);
    }

    if (typeof scriptParams.env !== void 0) {
        cache.set('env', scriptParams.env);
    } else {
        cache.set('env', 'beta');
    }

    var continueLoadMgAfterMbox = function (params) {
        var cohort = params.cohort || "";
        cache.set('cohort', cohort);

        var shouldUse2LineMG = true;
        if (typeof cohort !== "" &&
            (cohort === 'GroupB' || cohort === 'Group_B')) {
            shouldUse2LineMG = true;
        }
        if (window.location.href.indexOf("2linemg") > -1) {
            shouldUse2LineMG = true;
        }

        if (window.location.href.indexOf("GroupB") > -1) {
            shouldUse2LineMG = true;
        }

        if (typeof scriptParams.mode !== 'undefined') {
            // AB test
            if (window.location.href.indexOf("1linemg") > -1) {
                cache.set('mode', scriptParams.mode);
            } else {
                if (scriptParams.mode === 'mode2' && scriptParams.prodtype === 'mysfly'
                    && shouldUse2LineMG) {
                    cache.set('mode', 'mode5'); // 2-line magicshop
                } else {
                    cache.set('mode', scriptParams.mode);
                }
            }

        } else {
            cache.set('mode', 'mode1');
        }

        if (typeof scriptParams.use_pending !== 'undefined') {
            cache.set('use_pending', scriptParams.use_pending);
        } else {
            cache.set('use_pending', 'false');
        }

        // Make sure the current browser is supported
        if (!utils.browserSupported() && cache.get('mode') !== 'cross_sell' && cache.get('mode')
                                                                              !== 'mode2') {
            console.log('[Products Widget] Browser Not Supported');
            return;
        }

        var group = MagicShop.abTestGroup;

        if (typeof scriptParams.prodtype !== 'undefined') {
            if (!config.isProductTypeSupport(scriptParams.prodtype)) {
                // todo: revert back. if product not supported - don't show
                console.log('[Products Widget] Widget Type not supported.');
                //cache.set('prod_type', 'homepage');
                return;

        }
        else if (scriptParams.prodtype === 'calendar' || scriptParams.prodtype === 'specialoffers') { // set specialoffer and calendar to be horizontal flex
                    cache.set('prod_type', scriptParams.prodtype);
                    cache.set('mode', 'mode5');
            }
            else {
                cache.set('prod_type', scriptParams.prodtype);
            }
        } else {
            if (cache.get('mode') === 'store') {
                cache.set('prod_type', 'store');
            } else if (cache.get('mode') === 'cross_sell') {
                cache.set('prod_type', 'cross_sell');
            } else {
                cache.set('prod_type', 'photobook');
            }
        }

        // on init tracking
        var monitor = new Monitor(cache.get('prod_type'));

        if ((cache.get('mode') === 'mode2' || cache.get('mode') === 'mode5') && cache.get('prod_type') === 'mysfly') {
            monitor.addCounter('mgv3:onInit');

            if (typeof window.mgShop !== "undefined" && typeof window.mgShop.timeSdk
                                                        !== "undefined") {
                monitor.eventStart('mgv3:loadSdk', window.mgShop.timeSdk);
                monitor.eventEnd('mgv3:loadSdk');

                if (typeof window.MagicShop !== "undefined" && typeof window.MagicShop.pageLoad
                                                               !== "undefined") {
                    monitor.eventStart('mgv3:mgActivationTime', window.MagicShop.pageLoad);
                    monitor.eventEnd('mgv3:mgActivationTime', window.mgShop.timeSdk);
                }
            }
        } else if (cache.get('mode') === 'mode1') {
            monitor.addCounter('sideWidget:onInit');
        } else if (cache.get('mode') === 'cross_sell') {
            if (typeof window.mgShop !== "undefined" && typeof window.mgShop.timeSdk
                                                        !== "undefined") {
                monitor.eventStart('cross_sell:loadSdk', window.mgShop.timeSdk);
                monitor.eventEnd('cross_sell:loadSdk');

                if (typeof window.MagicShop !== "undefined" && typeof window.MagicShop.pageLoad
                                                               !== "undefined") {
                    monitor.eventStart('cross_sell:mgActivationTime', window.MagicShop.pageLoad);
                    monitor.eventEnd('cross_sell:mgActivationTime', window.mgShop.timeSdk);
                }
            }
        }

        if (typeof scriptParams.msg !== 'undefined') {
            cache.set('user_msg', scriptParams.msg);
        } else {
            cache.set('user_msg', null);
        }

        if ((cache.get('mode') === 'store') && (typeof scriptParams.partnerid === 'undefined'
                                               || typeof scriptParams.token === 'undefined'
                                               || !scriptParams.token || !scriptParams.partnerid)) {
            cache.set('user_msg', 'signin');
        }

        config.setAssetsVersion(ASSET_VERSION);

        cache.set('partner_id', scriptParams.partnerid);

        // Try to get token from the Shr
        var token = "";
        if (typeof scriptParams.token !== "undefined") {
            token = scriptParams.token;
        } else if (typeof Shr !== "undefined" && typeof Shr.U !== "undefined"
                   && typeof Shr.U.oauthToken !== "undefined") {
            token = Shr.U.oauthToken;
        }

        cache.set('token', token);
        cache.set('recipe_loaded', false);
        cache.set('prices_loaded', false);

        // Activate pointer-events polyfill
        PointerEventsPolyfill.initialize({});

        //If MyShutterfly MG (mode2/homepage)
        // if(cache.get('mode') == 'mode2' && cache.get('prod_type') == 'mysfly')
        // {
        //     config.setConversionTable();
        //     productProxy.loadPersonalization();
        // }

        // init magicSDK
        if (typeof globals.magicSDK === "undefined") {
            globals.magicSDK =
                new magicSDK({"env": cache.get('env'), "source": "magicshop", "debugOptions": []});
        }

        // Get the config and Save to the cache for use with every widget
        config.parseConfigJson(cfgJson, function () {
            if (cache.get('mode') === 'mode1' && !util.hasSpaceToOpenWidget(
                    config.getWidgetPosition())) {
                console.log('[Product Widget] Not enough space to open widget. Aborting.');
                return;
            }

            if (cache.get('mode') !== 'instance') {
                // The recipe need to know the prod type
                var options = {};
                var localModel = new Model({"prod_type": cache.get("prod_type")});
                var recipeName = config.getRecipeName(options, localModel);
                productProxy.getRecipe(recipeName, function (recipe) {
                    var recipes = {};
                    recipes[recipeName] = recipe;
                    config.parseRecipes(recipes, options, localModel, function () {
                        config.parseRecipeJson(recipeJson, function () {
                            if (window.MagicShop !== "undefined") {
                                window.MagicShop.instance = new sdk_instance({"isStandalone": true});
                                window.MagicShop.instance.render();
                            } else {
                                (new sdk_instance({"isStandalone": true})).render();
                            }
                        });
                    });
                });
            }
        });
    };

    var abTestActive = false; // set to false when there is no ab test to wait for
    if (abTestActive && $(".mboxDefaultContainer").length > 0) {
        console.log('waiting mbox');
        var waitMboxTimeout = setTimeout(function () {
            console.log('mbox not loaded after 2 sec (no abTest group set)');
            clearInterval(waitMboxInterval);
            continueLoadMgAfterMbox({"cohort": "badCohort"});
        }, 2000);
        var waitMboxInterval = setInterval(function () {
            if (typeof MagicShop !== "undefined" && typeof MagicShop.abTestGroup !== "undefined") {
                console.log('mbox loaded before 2 sec');
                clearTimeout(waitMboxTimeout);
                // if we are in GroupA, then MagicShop.abTestGroup is undefined
                // by testversion should include indication
                // two step check:
                var cohort = MagicShop.abTestGroup;

                if (typeof cohort === "undefined" || !cohort) { // no test group set
                    if (typeof testversion !== "undefined" && testversion.indexOf('No MS') !== -1) { // we are in group A
                        cohort = 'control';
                    } else { // not test group set
                        cohort = 'badCohort';
                    }
                }
                continueLoadMgAfterMbox({"cohort": cohort});
                clearInterval(waitMboxInterval);
            }
        }, 100);
    } else {
        console.log('not waiting mbox');
        continueLoadMgAfterMbox({"cohort": ""});
    }

    if (cache.get('mode') === 'instance') {
        if(document.getElementById("iframe_cns") == null) {
            $('body').append('<iframe id="iframe_cns" name="iframe_cns" style="display: none; width:1px; height:1px;"></iframe>');
        }

        return sdk_instance;
    }

});


(function(c){var d=document,a='appendChild',i='styleSheet',s=d.createElement('style');s.type='text/css';d.getElementsByTagName('head')[0][a](s);s[i]?s[i].cssText=c:s[a](d.createTextNode(c));})
('@-moz-keyframes rotateClockwise {\n  100% {\n    -moz-transform: rotate(360deg); } }\n@-webkit-keyframes rotateClockwise {\n  100% {\n    -webkit-transform: rotate(360deg); } }\n@keyframes rotateClockwise {\n  100% {\n    -webkit-transform: rotate(360deg);\n    transform: rotate(360deg); } }\n@-webkit-keyframes blink {\n  from {\n    opacity: 1;\n    filter: alpha(opacity=100); }\n  to {\n    opacity: 0.6;\n    filter: alpha(opacity=60); } }\n@-moz-keyframes blink {\n  from {\n    opacity: 1;\n    filter: alpha(opacity=100); }\n  to {\n    opacity: 0.6;\n    filter: alpha(opacity=60); } }\n@keyframes blink {\n  from {\n    opacity: 1;\n    filter: alpha(opacity=100); }\n  to {\n    opacity: 0.6;\n    filter: alpha(opacity=60); } }\n/* ==== BUTTONS ===== */\n.sfly-wgt-orange-btn, .sfly-wgt-porcelain-btn {\n  display: inline-block;\n  cursor: pointer;\n  height: auto;\n  text-align: center;\n  font-size: 14px;\n  line-height: 15px;\n  -webkit-border-radius: 5px;\n  -moz-border-radius: 5px;\n  -ms-border-radius: 5px;\n  border-radius: 5px;\n  padding: 6px 12px; }\n\n.sfly-wgt-orange-btn {\n  -webkit-border-radius: 3px;\n  -moz-border-radius: 3px;\n  -ms-border-radius: 3px;\n  border-radius: 3px;\n  background-color: #f15d1b;\n  border: 1px solid #bc5019;\n  text-shadow: 0 1px 1px #a30045;\n  color: #fff;\n  background-image: -webkit-linear-gradient(top, #e94d0f, #f57b39);\n  /* For Chrome 25 and Safari 6, iOS 6.1, Android 4.3 */\n  background-image: -moz-linear-gradient(top, #e94d0f, #f57b39);\n  /* For Firefox (3.6 to 15) */\n  background-image: -o-linear-gradient(top, #e94d0f, #f57b39);\n  /* For old Opera (11.1 to 12.0) */\n  background-image: linear-gradient(to top, #e94d0f, #f57b39);\n  /* Standard syntax; must be last */ }\n\n.sfly-wgt-orange-btn-sfly {\n  /*border: 0;\n  text-shadow: -1px -1px #ba2911;\n  color: white;\n  background-color: #f05323;\n  background-image: -webkit-gradient(linear,50% 0,50% 100%,color-stop(0%,#f05323),color-stop(100%,#cb3f16));\n  background-image: -webkit-linear-gradient(top,#f05323,#cb3f16);\n  background-image: -moz-linear-gradient(top,#f05323,#cb3f16);\n  background-image: -o-linear-gradient(top,#f05323,#cb3f16);\n  background-image: -ms-linear-gradient(top,#f05323,#cb3f16);\n  background-image: linear-gradient(top,#f05323,#cb3f16);\n  display: inline-block;\n  padding: 0 10px;\n  font-weight: normal;\n  font-family: \"Avenir LT W01 85 Heavy\",verdana,arial,sans-serif;\n  font-size: 13px;\n  text-align: center;\n  vertical-align: middle;\n  cursor: pointer;\n  outline: 0;\n  line-height: 24px;\n  text-decoration: none;\n  box-shadow: 1px 1px 4px #CCC;\n  border-radius: 3px;*/\n  cursor: pointer;\n  color: white;\n  background-color: #f05323;\n  display: inline-block;\n  font-family: \"Avenir LT W01 45 Book\", Verdana, Arial, sans-serif;\n  font-size: 12px;\n  font-weight: 400;\n  text-transform: uppercase;\n  letter-spacing: normal;\n  line-height: 1;\n  text-align: center;\n  padding: 12px 9px;\n  border-radius: 4px;\n  vertical-align: middle;\n  user-select: none;\n  border: none;\n  min-width: 101px; }\n\n.sfly-wgt-orange-btn-sfly:hover {\n  background-color: #dc4405;\n  background-image: none; }\n\n.sfly-wgt-orange-btn:hover {\n  background-color: #e8650e;\n  background-image: -webkit-linear-gradient(top, #fcad5d, #e8650e);\n  /* For Chrome 25 and Safari 6, iOS 6.1, Android 4.3 */\n  background-image: -moz-linear-gradient(top, #fcad5d, #e8650e);\n  /* For Firefox (3.6 to 15) */\n  background-image: -o-linear-gradient(top, #fcad5d, #e8650e);\n  /* For old Opera (11.1 to 12.0) */\n  background-image: linear-gradient(to top, #fcad5d, #e8650e);\n  /* Standard syntax; must be last */\n  border: 1px solid #df610b; }\n\n.sfly-wgt-orange-btn:active {\n  -moz-box-shadow: #e45b00 0 3px 6px inset, 0 1px 0 #ffffff;\n  -webkit-box-shadow: #e45b00 0 3px 6px inset, 0 1px 0 #ffffff;\n  box-shadow: #e45b00 0 3px 6px inset, 0 1px 0 #ffffff;\n  border: 1px solid #bc450b; }\n\n.sfly-wgt-orange-btn.disabled {\n  opacity: 0.6; }\n\n.sfly_wgt_fullview_bottombar a.sfly-wgt-orange-btn, .sfly_wgt_product_custom a.sfly-wgt-orange-btn {\n  color: #ffffff; }\n\n.sfly-wgt-porcelain-btn {\n  -webkit-border-radius: 6px;\n  -moz-border-radius: 6px;\n  -ms-border-radius: 6px;\n  border-radius: 6px;\n  background-color: #dbdfe5;\n  -moz-box-shadow: #fff 0 1px 0 inset, 0 1px 2px #dadfe7;\n  -webkit-box-shadow: #fff 0 1px 0 inset, 0 1px 2px #dadfe7;\n  box-shadow: #fff 0 1px 0 inset, 0 1px 2px #dadfe7;\n  background-image: -webkit-linear-gradient(top, #dbdfe5, #fafcff);\n  /* For Chrome 25 and Safari 6, iOS 6.1, Android 4.3 */\n  background-image: -moz-linear-gradient(top, #dbdfe5, #fafcff);\n  /* For Firefox (3.6 to 15) */\n  background-image: -o-linear-gradient(top, #dbdfe5, #fafcff);\n  /* For old Opera (11.1 to 12.0) */\n  background-image: linear-gradient(to top, #dbdfe5, #fafcff);\n  /* Standard syntax; must be last */\n  border: 1px solid #c3c5c7;\n  text-shadow: 0 1px 0 #fff;\n  color: #9aa2af; }\n\n.sfly-wgt-porcelain-btn:hover {\n  background-color: #e6e9ee;\n  background-image: -webkit-linear-gradient(top, #e6e9ee, #ffffff);\n  /* For Chrome 25 and Safari 6, iOS 6.1, Android 4.3 */\n  background-image: -moz-linear-gradient(top, #e6e9ee, #ffffff);\n  /* For Firefox (3.6 to 15) */\n  background-image: -o-linear-gradient(top, #e6e9ee, #ffffff);\n  /* For old Opera (11.1 to 12.0) */\n  background-image: linear-gradient(to top, #e6e9ee, #ffffff);\n  /* Standard syntax; must be last */\n  -moz-box-shadow: #ffffff 0 1px 0 inset, 0 1px 2px #dee3ea;\n  -webkit-box-shadow: #ffffff 0 1px 0 inset, 0 1px 2px #dee3ea;\n  box-shadow: #ffffff 0 1px 0 inset, 0 1px 2px #dee3ea;\n  border: 1px solid #d0d2d5; }\n\n.sfly-wgt-porcelain-btn:active {\n  background-color: #dbdfe5;\n  background-image: -webkit-linear-gradient(top, #dbdfe5, #ffffff);\n  /* For Chrome 25 and Safari 6, iOS 6.1, Android 4.3 */\n  background-image: -moz-linear-gradient(top, #dbdfe5, #ffffff);\n  /* For Firefox (3.6 to 15) */\n  background-image: -o-linear-gradient(top, #dbdfe5, #ffffff);\n  /* For old Opera (11.1 to 12.0) */\n  background-image: linear-gradient(to top, #dbdfe5, #ffffff);\n  /* Standard syntax; must be last */\n  -moz-box-shadow: #c3cad6 0 3px 9px inset, 0 1px 0 #ffffff;\n  -webkit-box-shadow: #c3cad6 0 3px 9px inset, 0 1px 0 #ffffff;\n  box-shadow: #c3cad6 0 3px 9px inset, 0 1px 0 #ffffff;\n  border: 1px solid #bdc5d2; }\n\n.sfly-wgt-gray-btn-sfly {\n  text-shadow: 1px 1px white;\n  background-color: white;\n  display: inline-block;\n  font-weight: normal;\n  font-size: 13px;\n  text-align: center;\n  vertical-align: middle;\n  cursor: pointer;\n  outline: 0;\n  border-radius: 3px;\n  margin-top: 0px;\n  border: solid 1px #c6c7c9;\n  color: #58595b;\n  background-color: rgba(255, 255, 255, 0.05);\n  background-image: none;\n  line-height: 36px;\n  padding: 0 20px;\n  font-family: \"Avenir LT W01 65 Medium\", Avenir, Verdana, Arial, sans-serif;\n  text-transform: uppercase; }\n  .sfly-wgt-gray-btn-sfly:hover {\n    background-color: #ece7e3;\n    background-image: none; }\n  .sfly-wgt-gray-btn-sfly.sfly-wgt-gray-btn-sfly-hp {\n    margin-top: -5px; }\n\n.sfly-wgt-gray-dark-btn-sfly {\n  color: #5681ab;\n  border: 1px solid #5681ab;\n  text-shadow: 1px 1px white;\n  background-color: white;\n  background-image: -webkit-gradient(linear, 50% 0, 50% 100%, color-stop(0%, #fff), color-stop(100%, #e0dbd7));\n  background-image: -webkit-linear-gradient(top, #fff, #e0dbd7);\n  background-image: -moz-linear-gradient(top, #fff, #e0dbd7);\n  background-image: -o-linear-gradient(top, #fff, #e0dbd7);\n  background-image: -ms-linear-gradient(top, #fff, #e0dbd7);\n  background-image: linear-gradient(top, #fff, #e0dbd7);\n  display: inline-block;\n  padding: 0 10px;\n  font-weight: normal;\n  font-family: \"Avenir LT W01 85 Heavy\",verdana,arial,sans-serif;\n  font-size: 13px;\n  text-align: center;\n  vertical-align: middle;\n  cursor: pointer;\n  outline: 0;\n  line-height: 24px;\n  text-decoration: none;\n  border-radius: 3px;\n  box-shadow: 1px 1px 4px #CCC; }\n  .sfly-wgt-gray-dark-btn-sfly:hover {\n    background-color: #e0dbd7;\n    background-image: none; }\n\n/*=========\nNEW STYLE-GUIDE BUTTONS\n==========*/\n.use-new-style-guide .sfly-wgt-orange-btn-sfly {\n  display: inline-block;\n  cursor: pointer;\n  border: solid 1px rgba(0, 0, 0, 0.15);\n  border-radius: 4px;\n  background-color: #ed542f;\n  background-image: none;\n  padding: 6px 16px;\n  font-weight: normal;\n  font-family: \"Avenir LT W01 65 Medium\", \"Avenir LT\",verdana,arial,sans-serif;\n  font-size: 14px;\n  letter-spacing: 0.5px;\n  color: white;\n  text-align: center;\n  vertical-align: middle;\n  line-height: 19px;\n  text-shadow: none;\n  box-shadow: none; }\n.use-new-style-guide .sfly-wgt-orange-btn-sfly:not(.disabled):hover {\n  background-color: #e4371b;\n  border: solid 1px rgba(0, 0, 0, 0.25); }\n.use-new-style-guide .sfly-wgt-orange-btn-sfly:not(.disabled):active {\n  background-color: #e4371b;\n  border: solid 2px rgba(0, 0, 0, 0.25);\n  padding: 5px 15px; }\n.use-new-style-guide .sfly-wgt-orange-btn-sfly.disabled {\n  border: 0;\n  opacity: 0.5;\n  padding: 7px 17px; }\n.use-new-style-guide .sfly-wgt-gray-btn-sfly {\n  display: inline-block;\n  cursor: pointer;\n  border: solid 1px rgba(0, 0, 0, 0.25);\n  border-radius: 4px;\n  background-color: #f6f8fb;\n  background-image: none;\n  padding: 6px 16px;\n  font-weight: normal;\n  font-family: \"Avenir LT W01 65 Medium\", \"Avenir LT\",verdana,arial,sans-serif;\n  font-size: 14px;\n  letter-spacing: 0.5px;\n  color: #58595b;\n  text-align: center;\n  vertical-align: middle;\n  line-height: 19px;\n  text-shadow: none;\n  box-shadow: none; }\n  .use-new-style-guide .sfly-wgt-gray-btn-sfly.sfly-wgt-gray-btn-sfly-hp {\n    margin-top: -5px; }\n.use-new-style-guide .sfly-wgt-gray-btn-sfly:not(.disabled):hover {\n  background-color: #ebf0f7;\n  border: solid 1px rgba(0, 0, 0, 0.3); }\n.use-new-style-guide .sfly-wgt-gray-btn-sfly:not(.disabled):active {\n  background-color: #ebf0f7;\n  border: solid 2px rgba(0, 0, 0, 0.3);\n  padding: 5px 15px; }\n.use-new-style-guide .sfly-wgt-gray-btn-sfly.disabled {\n  border: 0;\n  opacity: 0.5;\n  padding: 7px 17px; }\n.use-new-style-guide .sfly-wgt-white-btn-sfly {\n  display: inline-block;\n  cursor: pointer;\n  border: solid 1px rgba(0, 0, 0, 0.25);\n  border-radius: 4px;\n  background-color: white;\n  background-image: none;\n  padding: 6px 16px;\n  font-weight: normal;\n  font-family: \"Avenir LT W01 65 Medium\", \"Avenir LT\",verdana,arial,sans-serif;\n  font-size: 14px;\n  letter-spacing: 0.5px;\n  color: #58595b;\n  text-align: center;\n  vertical-align: middle;\n  line-height: 19px;\n  text-shadow: none;\n  box-shadow: none; }\n  .use-new-style-guide .sfly-wgt-white-btn-sfly.sfly-wgt-white-btn-sfly-hp {\n    margin-top: -5px; }\n.use-new-style-guide .sfly-wgt-white-btn-sfly:not(.disabled):hover {\n  background-color: white;\n  border: solid 1px #ed542f;\n  color: #ed542f; }\n.use-new-style-guide .sfly-wgt-white-btn-sfly:not(.disabled):active {\n  background-color: white;\n  border: solid 2px #ed542f;\n  padding: 5px 15px;\n  color: #ed542f; }\n.use-new-style-guide .sfly-wgt-white-btn-sfly.disabled {\n  opacity: 0.5;\n  padding: 6px 16px; }\n\n/*=========\nTL BTN\n==========*/\n.sfly-wgt-tl-create-photobook {\n  position: absolute;\n  top: 20px;\n  right: 0; }\n  .sfly-wgt-tl-create-photobook .sfly-wgt-tl-orange-btn {\n    display: none;\n    top: -60px; }\n\n.sfly-wgt-tl-create-prints {\n  position: relative !important;\n  width: 100% !important;\n  height: 100px !important;\n  top: 0 !important;\n  right: 0 !important; }\n  .sfly-wgt-tl-create-prints .sfly-wgt-tl-orange-btn {\n    display: none;\n    top: -60px; }\n\n.sfly_wgt_spread_mg:hover .sfly-wgt-tl-create-photobook .sfly-wgt-tl-orange-btn, .sfly_wgt_spread_mg:hover .sfly-wgt-tl-create-prints .sfly-wgt-tl-orange-btn {\n  display: block; }\n\n.sfly-wgt-tl-orange-btn {\n  border-radius: 3px;\n  background-color: #f15d1b;\n  background-image: url(\"data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4gPHN2ZyB2ZXJzaW9uPSIxLjEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGRlZnM+PGxpbmVhckdyYWRpZW50IGlkPSJncmFkIiBncmFkaWVudFVuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgeDE9IjAuNSIgeTE9IjEuMCIgeDI9IjAuNSIgeTI9IjAuMCI+PHN0b3Agb2Zmc2V0PSIwJSIgc3RvcC1jb2xvcj0iI2U5NGQwZiIvPjxzdG9wIG9mZnNldD0iMTAwJSIgc3RvcC1jb2xvcj0iI2Y1N2IzOSIvPjwvbGluZWFyR3JhZGllbnQ+PC9kZWZzPjxyZWN0IHg9IjAiIHk9IjAiIHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9InVybCgjZ3JhZCkiIC8+PC9zdmc+IA==\");\n  background-size: 100%;\n  background-image: -webkit-gradient(linear, 50% 100%, 50% 0%, color-stop(0%, #e94d0f), color-stop(100%, #f57c3a));\n  background-image: -moz-linear-gradient(bottom, #e94d0f 0%, #f57c3a 100%);\n  background-image: -webkit-linear-gradient(bottom, #e94d0f 0%, #f57c3a 100%);\n  background-image: linear-gradient(to top, #e94d0f 0%, #f57c3a 100%);\n  background-image: linear-gradient(bottom, #e94d0f 0%, #f57c3a 100%);\n  text-shadow: 0 1px 1px #a30045;\n  color: #fff;\n  line-height: 15px;\n  height: auto;\n  text-align: center;\n  cursor: pointer;\n  font-family: \"Avenir LT W01 65 Medium\", \"Avenir LT\",Verdana,Arial,sans-serif;\n  position: inherit !important;\n  display: block;\n  margin: 30px auto 0 auto;\n  float: none;\n  padding: 14px 12px;\n  font-size: 18px;\n  border: 1px solid #bc5119;\n  border-radius: 5px;\n  width: 208px; }\n\n.sfly-wgt-tl-orange-btn:not(.disabled):hover {\n  background-color: #e8650e;\n  background-size: 100%; }\n\n.sfly-wgt-tl-orange-btn:not(.disabled):active {\n  -moz-box-shadow: #e45b00 0 3px 6px inset, 0 1px 0 #ffffff;\n  -webkit-box-shadow: #e45b00 0 3px 6px inset, 0 1px 0 #ffffff;\n  box-shadow: #e45b00 0 3px 6px inset, 0 1px 0 #ffffff;\n  border: 1px solid #bc450b; }\n\n.sfly-wgt-tl-orange-btn.disabled {\n  opacity: 0.6;\n  cursor: auto; }\n\n/* ==== SCROLL BAR        ===== */\n.sfly-wgt-listview-scrollbar-horizontal {\n  width: 100%;\n  height: 1px;\n  -webkit-touch-callout: none;\n  -webkit-user-select: none;\n  -khtml-user-select: none;\n  -moz-user-select: none;\n  -ms-user-select: none;\n  -o-user-select: none;\n  user-select: none;\n  position: absolute;\n  bottom: 5px;\n  left: 0;\n  z-index: 1; }\n  .sfly-wgt-listview-scrollbar-horizontal .sfly-wgt-scroll-track {\n    height: 100%;\n    width: 100%;\n    background-color: #696969;\n    border-radius: 4px;\n    margin: 0;\n    position: relative; }\n    .sfly-wgt-listview-scrollbar-horizontal .sfly-wgt-scroll-track .sfly-wgt-scroll-thumb {\n      width: 100px;\n      height: 5px;\n      margin-top: -2px;\n      background-color: #f05323;\n      display: inline-block;\n      position: absolute;\n      left: 0;\n      top: 0;\n      cursor: pointer;\n      z-index: 20;\n      border-radius: 4px;\n      transition: all 0ms;\n      -webkit-transition: all 0ms;\n      transform: translateX(0px) translateZ(0px);\n      -webkit-transform: translateX(0px) translateZ(0px); }\n\n.sfly-wgt-listview-scrollbar-vertical {\n  height: 100%;\n  width: 6px;\n  -webkit-touch-callout: none;\n  -webkit-user-select: none;\n  -khtml-user-select: none;\n  -moz-user-select: none;\n  -ms-user-select: none;\n  -o-user-select: none;\n  user-select: none;\n  z-index: 1;\n  position: absolute;\n  right: 10px;\n  top: 0; }\n  .sfly-wgt-listview-scrollbar-vertical .sfly-wgt-scroll-track {\n    height: 100%;\n    width: 100%;\n    background-color: #cdcdcd;\n    border-radius: 4px;\n    margin: 0;\n    position: relative; }\n    .sfly-wgt-listview-scrollbar-vertical .sfly-wgt-scroll-track .sfly-wgt-scroll-thumb {\n      width: 100%;\n      height: 100px;\n      background-color: #f35e1c;\n      display: inline-block;\n      position: absolute;\n      left: 0;\n      top: 0;\n      cursor: pointer;\n      z-index: 20;\n      border-radius: 4px;\n      transition: all 0ms;\n      -webkit-transition: all 0ms;\n      transform: translateY(0px) translateZ(0px);\n      -webkit-transform: translateY(0px) translateZ(0px); }\n\n/* ==== END SCROLL BAR ===== */\n.sfly-wgt-send-link-container {\n  width: 100%; }\n  @media only screen and (max-width: 767px) {\n    .sfly-wgt-send-link-container {\n      position: absolute;\n      top: 273px; } }\n  .sfly-wgt-send-link-container .widget-send-link {\n    padding: 20px;\n    box-sizing: border-box;\n    position: absolute;\n    left: 50%;\n    bottom: 5px;\n    transform: translate(-50%); }\n    @media only screen and (max-width: 767px) {\n      .sfly-wgt-send-link-container .widget-send-link {\n        position: relative;\n        bottom: 0; } }\n    @media only screen and (min-width: 768px) and (max-width: 991px) {\n      .sfly-wgt-send-link-container .widget-send-link {\n        bottom: -5px; } }\n    .sfly-wgt-send-link-container .widget-send-link .send-link-btn {\n      cursor: pointer;\n      float: left;\n      width: 90px;\n      height: 100%;\n      border-radius: 4px;\n      background-color: rgba(255, 255, 255, 0.05);\n      color: #58595b;\n      border: solid 1px #c6c7c9;\n      display: flex;\n      align-items: center;\n      margin-left: 10px; }\n      @media only screen and (max-width: 767px) {\n        .sfly-wgt-send-link-container .widget-send-link .send-link-btn {\n          width: 70px;\n          margin-left: 5px; } }\n      .sfly-wgt-send-link-container .widget-send-link .send-link-btn:not(.disabled):hover {\n        background-color: white;\n        border: solid 1px #ed542f;\n        color: #ed542f; }\n      .sfly-wgt-send-link-container .widget-send-link .send-link-btn .send {\n        width: 100%;\n        font-family: Avenir;\n        font-size: 12px;\n        font-weight: 400;\n        line-height: 1;\n        text-align: center; }\n    .sfly-wgt-send-link-container .widget-send-link .send-link-form {\n      position: relative; }\n      .sfly-wgt-send-link-container .widget-send-link .send-link-form div.info {\n        margin-top: 8px;\n        text-align: center;\n        width: auto;\n        height: 22px;\n        font-family: Avenir-Roman !important;\n        font-size: 16px;\n        color: #4b525b; }\n        .sfly-wgt-send-link-container .widget-send-link .send-link-form div.info .info-text {\n          min-width: 350px;\n          text-overflow: ellipsis; }\n          @media only screen and (max-width: 767px) {\n            .sfly-wgt-send-link-container .widget-send-link .send-link-form div.info .info-text {\n              text-align: center;\n              width: 100%;\n              min-width: 100%; } }\n      .sfly-wgt-send-link-container .widget-send-link .send-link-form div.send-to-phone {\n        position: relative;\n        height: 32px;\n        width: 280px;\n        margin: 0 auto; }\n        @media only screen and (max-width: 767px) {\n          .sfly-wgt-send-link-container .widget-send-link .send-link-form div.send-to-phone {\n            width: 260px; } }\n        .sfly-wgt-send-link-container .widget-send-link .send-link-form div.send-to-phone .phone-input {\n          width: 155px;\n          height: 32px;\n          border-radius: 4px;\n          background-color: #ffffff;\n          border: solid 1px #dddfe1; }\n        .sfly-wgt-send-link-container .widget-send-link .send-link-form div.send-to-phone .warning-icon {\n          display: none;\n          position: absolute;\n          width: 11px;\n          height: 11px;\n          margin: 10px auto;\n          left: 150px;\n          cursor: pointer; }\n        .sfly-wgt-send-link-container .widget-send-link .send-link-form div.send-to-phone .warning-tooltip {\n          display: none;\n          position: absolute;\n          width: 200px;\n          margin: -27px auto auto 48px;\n          bottom: 31px;\n          text-align: center;\n          color: #990000;\n          border: 1px solid #bebec3;\n          border-radius: 6px;\n          background-color: #fff;\n          -moz-box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);\n          -webkit-box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);\n          box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1); }\n          .sfly-wgt-send-link-container .widget-send-link .send-link-form div.send-to-phone .warning-tooltip:before {\n            content: \'\';\n            position: absolute;\n            left: 50%;\n            bottom: -6px;\n            width: 10px;\n            height: 10px;\n            -moz-transform: rotate(45deg);\n            -o-transform: rotate(45deg);\n            -ms-transform: rotate(45deg);\n            -webkit-transform: rotate(45deg);\n            transform: rotate(45deg);\n            background-color: white;\n            border-right: 1px solid #bebec3;\n            border-bottom: 1px solid #bebec3; }\n        .sfly-wgt-send-link-container .widget-send-link .send-link-form div.send-to-phone.invalid .phone-input {\n          border-color: #ba3b3d; }\n        .sfly-wgt-send-link-container .widget-send-link .send-link-form div.send-to-phone.invalid .warning-icon, .sfly-wgt-send-link-container .widget-send-link .send-link-form div.send-to-phone.invalid .warning-tooltip {\n          display: inline-block; }\n    .sfly-wgt-send-link-container .widget-send-link .success-overlay {\n      display: none;\n      position: relative;\n      top: -7px;\n      right: 0;\n      bottom: 0;\n      left: 0; }\n      .sfly-wgt-send-link-container .widget-send-link .success-overlay .phone-number-container {\n        position: relative;\n        text-align: center;\n        min-width: 120px; }\n        @media only screen and (max-width: 767px) {\n          .sfly-wgt-send-link-container .widget-send-link .success-overlay .phone-number-container {\n            top: 20px; } }\n        .sfly-wgt-send-link-container .widget-send-link .success-overlay .phone-number-container .checkcircle {\n          display: inline-block;\n          position: relative;\n          top: 2px;\n          background-color: white;\n          width: 28px;\n          height: 28px;\n          cursor: default;\n          box-shadow: inset 0 0 0 2px #e35600; }\n          .sfly-wgt-send-link-container .widget-send-link .success-overlay .phone-number-container .checkcircle:before {\n            width: 8px;\n            height: 2px;\n            margin-left: -6px;\n            margin-bottom: -1px;\n            background-color: #f05323; }\n          .sfly-wgt-send-link-container .widget-send-link .success-overlay .phone-number-container .checkcircle:after {\n            height: 2px;\n            margin-left: -2px;\n            margin-top: 3px;\n            background-color: #f05323; }\n        .sfly-wgt-send-link-container .widget-send-link .success-overlay .phone-number-container .phone-number {\n          display: inline-block;\n          position: relative;\n          top: -6px;\n          line-height: 20px;\n          padding: 0 10px;\n          font-family: Avenir-Roman;\n          font-size: 16px;\n          text-align: center;\n          color: #4b525b; }\n      .sfly-wgt-send-link-container .widget-send-link .success-overlay .wrong-number {\n        cursor: pointer;\n        clear: both;\n        width: 102px;\n        height: 18px;\n        font-family: Avenir;\n        font-size: 13px;\n        font-weight: 500;\n        text-align: center;\n        color: #1aaeba;\n        margin: 0 auto;\n        left: 0;\n        right: 0; }\n        @media only screen and (max-width: 767px) {\n          .sfly-wgt-send-link-container .widget-send-link .success-overlay .wrong-number {\n            position: relative;\n            top: 20px; } }\n\n.sfly_wgt_listview_embedded_title_background .sfly-wgt-holiday-title-left-corner, .sfly_wgt_listview_embedded_title_background .sfly-wgt-holiday-title-right-corner {\n  display: block;\n  position: absolute;\n  background-repeat: no-repeat;\n  background-size: contain;\n  background-position: center; }\n.sfly_wgt_listview_embedded_title_background .sfly-wgt-holiday-title-left-corner {\n  top: 0;\n  left: 0;\n  width: 141px;\n  height: 60px;\n  background-image: url(\"https://d22bbwxztp2lry.cloudfront.net/productswidget/Shutterfly/sidewidget/images/prod/holiday-title-left-corner-image.png\"); }\n.sfly_wgt_listview_embedded_title_background .sfly-wgt-holiday-title-right-corner {\n  top: 0;\n  right: 0;\n  width: 97px;\n  height: 67px;\n  background-image: url(\"https://d22bbwxztp2lry.cloudfront.net/productswidget/Shutterfly/sidewidget/images/prod/holiday-title-right-corner-image.png\"); }\n.sfly_wgt_listview_embedded_title_background .sfly-wgt-valentine-title-left-corner, .sfly_wgt_listview_embedded_title_background .sfly-wgt-valentine-title-right-corner {\n  display: block;\n  position: absolute;\n  background-repeat: no-repeat;\n  background-size: contain;\n  background-position: center; }\n.sfly_wgt_listview_embedded_title_background .sfly-wgt-valentine-title-left-corner {\n  display: none; }\n.sfly_wgt_listview_embedded_title_background .sfly-wgt-valentine-title-right-corner {\n  top: 0;\n  right: 0;\n  width: 244px;\n  height: 80px;\n  background-image: url(\"https://d22bbwxztp2lry.cloudfront.net/productswidget/Shutterfly/sidewidget/images/prod/valentine-title-right-corner-image.png\"); }\n.sfly_wgt_listview_embedded_title_background .sfly-wgt-president-title-left-corner, .sfly_wgt_listview_embedded_title_background .sfly-wgt-president-title-right-corner {\n  display: block;\n  position: absolute;\n  background-repeat: no-repeat;\n  background-size: contain;\n  background-position: center; }\n.sfly_wgt_listview_embedded_title_background .sfly-wgt-president-title-left-corner {\n  display: none; }\n.sfly_wgt_listview_embedded_title_background .sfly-wgt-president-title-right-corner {\n  top: 0;\n  right: 0;\n  width: 605px;\n  height: 69px;\n  background-image: url(\"https://d22bbwxztp2lry.cloudfront.net/productswidget/Shutterfly/sidewidget/images/prod/president-title-right-corner-image.png\"); }\n.sfly_wgt_listview_embedded_title_background .sfly-wgt-mother-day-title-left-corner, .sfly_wgt_listview_embedded_title_background .sfly-wgt-mother-day-title-right-corner {\n  display: block;\n  position: absolute;\n  background-repeat: no-repeat;\n  background-size: contain;\n  background-position: right; }\n.sfly_wgt_listview_embedded_title_background .sfly-wgt-mother-day-title-left-corner {\n  display: none; }\n.sfly_wgt_listview_embedded_title_background .sfly-wgt-mother-day-title-right-corner {\n  top: 0;\n  right: 0;\n  width: 723px;\n  height: 126px;\n  background-image: url(\"https://d22bbwxztp2lry.cloudfront.net/productswidget/Shutterfly/sidewidget/images/prod/mother-day-title-right-corner-image.png\"); }\n.sfly_wgt_listview_embedded_title_background .sfly-wgt-father-day-title-left-corner, .sfly_wgt_listview_embedded_title_background .sfly-wgt-father-day-title-right-corner {\n  display: block;\n  position: absolute;\n  background-repeat: no-repeat;\n  background-size: contain;\n  background-position: right; }\n.sfly_wgt_listview_embedded_title_background .sfly-wgt-father-day-title-left-corner {\n  top: 0;\n  left: 225px;\n  width: 144px;\n  height: 101px;\n  background-image: url(\"https://d22bbwxztp2lry.cloudfront.net/productswidget/Shutterfly/sidewidget/images/prod/father-day-title-left-corner-image.png\"); }\n.sfly_wgt_listview_embedded_title_background .sfly-wgt-father-day-title-right-corner {\n  top: 0;\n  right: 0;\n  width: 122px;\n  height: 128px;\n  background-image: url(\"https://d22bbwxztp2lry.cloudfront.net/productswidget/Shutterfly/sidewidget/images/prod/father-day-title-right-corner-image.png\"); }\n.sfly_wgt_listview_embedded_title_background .sfly-wgt-summer-title-left-corner, .sfly_wgt_listview_embedded_title_background .sfly-wgt-summer-title-right-corner {\n  display: block;\n  position: absolute;\n  background-repeat: no-repeat;\n  background-size: contain;\n  background-position: right; }\n.sfly_wgt_listview_embedded_title_background .sfly-wgt-summer-title-left-corner {\n  top: 17px;\n  left: 233px;\n  width: 91px;\n  height: 70px;\n  background-image: url(\"https://d22bbwxztp2lry.cloudfront.net/productswidget/Shutterfly/sidewidget/images/prod/summer-title-left-corner-image.png\"); }\n.sfly_wgt_listview_embedded_title_background .sfly-wgt-summer-title-right-corner {\n  top: 0;\n  right: 0;\n  width: 233px;\n  height: 93px;\n  background-image: url(\"https://d22bbwxztp2lry.cloudfront.net/productswidget/Shutterfly/sidewidget/images/prod/summer-title-right-corner-image.png\"); }\n.sfly_wgt_listview_embedded_title_background .sfly-wgt-school-title-left-corner, .sfly_wgt_listview_embedded_title_background .sfly-wgt-school-title-right-corner {\n  display: block;\n  position: absolute;\n  background-repeat: no-repeat;\n  background-size: contain;\n  background-position: right; }\n.sfly_wgt_listview_embedded_title_background .sfly-wgt-school-title-left-corner {\n  display: none; }\n.sfly_wgt_listview_embedded_title_background .sfly-wgt-school-title-right-corner {\n  top: 16px;\n  right: 0;\n  width: 648px;\n  height: 77px;\n  background-image: url(\"https://d22bbwxztp2lry.cloudfront.net/productswidget/Shutterfly/sidewidget/images/prod/school-title-right-corner-image.png\"); }\n\n#MagicShopFull {\n  overflow: hidden; }\n\n#MagicShopFull.horizontal-flex.one-line {\n  height: 350px !important;\n  width: 980px !important; }\n  #MagicShopFull.horizontal-flex.one-line .sfly_wgt_listview_spread {\n    flex-flow: row nowrap;\n    justify-content: flex-start;\n    padding: 0 !important; }\n  #MagicShopFull.horizontal-flex.one-line .sfly_wgt_listview_container .sfly_wgt_listview_scroll_arrows .sfly_wgt_listview_scroll_arrow {\n    top: 170px;\n    width: 48px;\n    height: 96px; }\n#MagicShopFull.horizontal-flex.calendars-cat-page {\n  height: 350px !important;\n  width: 974px !important;\n  border-radius: 0 !important;\n  border-color: #f8f8f8 !important; }\n  #MagicShopFull.horizontal-flex.calendars-cat-page .sfly_wgt_listview_scroll_arrow {\n    display: none; }\n  #MagicShopFull.horizontal-flex.calendars-cat-page.made-just .sfly_wgt_listview_embedded_title .embedded_signout {\n    text-align: left;\n    margin-top: 25px;\n    padding: 15px; }\n  #MagicShopFull.horizontal-flex.calendars-cat-page.made-just .sfly_wgt_listview_embedded_title .sfly_wgt_listview_embedded_title_actions {\n    display: none !important; }\n  #MagicShopFull.horizontal-flex.calendars-cat-page .sfly_wgt_listview_spread_container {\n    display: flex; }\n    #MagicShopFull.horizontal-flex.calendars-cat-page .sfly_wgt_listview_spread_container .sfly_wgt_spread_mg.sfly_wgt_listview_spread {\n      align-content: center !important; }\n  #MagicShopFull.horizontal-flex.calendars-cat-page.mg-static-data {\n    height: 0 !important;\n    opacity: 0 !important;\n    transition: all 0.6s; }\n#MagicShopFull.horizontal-flex.specialoffers-cat-page {\n  height: 350px !important;\n  width: 974px !important;\n  border-radius: 0 !important;\n  border-color: #f8f8f8 !important; }\n  #MagicShopFull.horizontal-flex.specialoffers-cat-page .sfly_wgt_listview_scroll_left_arrow, #MagicShopFull.horizontal-flex.specialoffers-cat-page .sfly_wgt_arrow_disabled, #MagicShopFull.horizontal-flex.specialoffers-cat-page .sfly_wgt_listview_scroll_arrow {\n    display: block;\n    top: 178px !important; }\n  #MagicShopFull.horizontal-flex.specialoffers-cat-page .sfly_wgt_listview_scroll_arrows.made-just {\n    display: block !important; }\n\n#MagicShopFull.horizontal-flex {\n  height: 567px !important;\n  width: 980px !important;\n  background-color: #f5f6f8;\n  margin: 0;\n  padding: 0;\n  border-top: 0;\n  margin-bottom: 20px;\n  -webkit-transition: height 1s;\n  -moz-transition: height 1s;\n  -ms-transition: height 1s;\n  -o-transition: height 1s;\n  transition: height 1s; }\n  #MagicShopFull.horizontal-flex.mother-day {\n    background-color: #f5f6f8; }\n  #MagicShopFull.horizontal-flex.father-day {\n    background-color: #f9f9f9; }\n  #MagicShopFull.horizontal-flex.summer {\n    background-color: #ffffff;\n    border-radius: 4px;\n    border: solid 1px #f2f2f2; }\n  #MagicShopFull.horizontal-flex.made-just {\n    background-color: #ffffff;\n    border-radius: 4px;\n    border: solid 1px #f2f2f2; }\n  #MagicShopFull.horizontal-flex #mg_displayArea {\n    height: 567px !important;\n    -webkit-transition: height 1s;\n    -moz-transition: height 1s;\n    -ms-transition: height 1s;\n    -o-transition: height 1s;\n    transition: height 1s; }\n    #MagicShopFull.horizontal-flex #mg_displayArea #mg_mainDiv {\n      height: 567px !important;\n      -webkit-transition: height 1s;\n      -moz-transition: height 1s;\n      -ms-transition: height 1s;\n      -o-transition: height 1s;\n      transition: height 1s;\n      display: flex;\n      justify-content: center;\n      align-items: center; }\n      #MagicShopFull.horizontal-flex #mg_displayArea #mg_mainDiv #mg_LoadingDiv {\n        margin: auto !important; }\n  #MagicShopFull.horizontal-flex .sfly_wgt_listview_container .sfly_wgt_listview_embedded_title {\n    top: 0; }\n    #MagicShopFull.horizontal-flex .sfly_wgt_listview_container .sfly_wgt_listview_embedded_title .sfly-wgt-title-flex .sfly-wgt-title-text {\n      display: block;\n      position: absolute;\n      top: 15px;\n      left: 10px;\n      width: 162px;\n      height: 55px;\n      background-image: url(\"https://d22bbwxztp2lry.cloudfront.net/productswidget/Shutterfly/sidewidget/images/prod/title-text.png\");\n      background-repeat: no-repeat;\n      background-size: contain;\n      background-position: center; }\n      #MagicShopFull.horizontal-flex .sfly_wgt_listview_container .sfly_wgt_listview_embedded_title .sfly-wgt-title-flex .sfly-wgt-title-text.holiday {\n        top: 15px;\n        left: 90px;\n        width: 393px;\n        height: 53px;\n        background-image: url(\"https://d22bbwxztp2lry.cloudfront.net/productswidget/Shutterfly/sidewidget/images/prod/holiday-title-text.png\"); }\n      #MagicShopFull.horizontal-flex .sfly_wgt_listview_container .sfly_wgt_listview_embedded_title .sfly-wgt-title-flex .sfly-wgt-title-text.valentine {\n        top: 7px;\n        left: 15px;\n        width: 381px;\n        height: 72px;\n        background-image: url(\"https://d22bbwxztp2lry.cloudfront.net/productswidget/Shutterfly/sidewidget/images/prod/valentine-title-text.png\"); }\n      #MagicShopFull.horizontal-flex .sfly_wgt_listview_container .sfly_wgt_listview_embedded_title .sfly-wgt-title-flex .sfly-wgt-title-text.president {\n        top: 20px;\n        left: 15px;\n        width: 237px;\n        height: 53px;\n        background-image: url(\"https://d22bbwxztp2lry.cloudfront.net/productswidget/Shutterfly/sidewidget/images/prod/president-title-text.png\"); }\n      #MagicShopFull.horizontal-flex .sfly_wgt_listview_container .sfly_wgt_listview_embedded_title .sfly-wgt-title-flex .sfly-wgt-title-text.mother-day {\n        top: 19px;\n        left: 14px;\n        width: 225px;\n        height: 86px;\n        background-image: url(\"https://d22bbwxztp2lry.cloudfront.net/productswidget/Shutterfly/sidewidget/images/prod/mother-day-title-text.png\"); }\n      #MagicShopFull.horizontal-flex .sfly_wgt_listview_container .sfly_wgt_listview_embedded_title .sfly-wgt-title-flex .sfly-wgt-title-text.father-day {\n        top: 0;\n        left: 17px;\n        width: 178px;\n        height: 81px;\n        background-image: url(\"https://d22bbwxztp2lry.cloudfront.net/productswidget/Shutterfly/sidewidget/images/prod/father-day-title-text.png\"); }\n      #MagicShopFull.horizontal-flex .sfly_wgt_listview_container .sfly_wgt_listview_embedded_title .sfly-wgt-title-flex .sfly-wgt-title-text.summer {\n        top: 17px;\n        left: 17px;\n        width: 200px;\n        height: 53px;\n        background-image: url(\"https://d22bbwxztp2lry.cloudfront.net/productswidget/Shutterfly/sidewidget/images/prod/summer-title-text.png\"); }\n      #MagicShopFull.horizontal-flex .sfly_wgt_listview_container .sfly_wgt_listview_embedded_title .sfly-wgt-title-flex .sfly-wgt-title-text.made-just {\n        top: 16px;\n        left: 15px;\n        width: 300px;\n        height: 53px;\n        background-image: url(\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAcQAAABECAMAAAAoRrVBAAAAWlBMVEUAAABLS0tLS0tLS0tWVlZKSkpLS0tMTExOTk5KSkpLS0tMTExKSkpKSkpKSkpLS0tLS0tKSkpLS0tRUVFLS0tLS0tKSkpMTExOTk5NTU1KSkpLS0tLS0tKSkp+J5bsAAAAHXRSTlMAZnKnCvTBTRlYgDPl1LOb7Y/MED5h20ckK7iGebOHTaAAAAgRSURBVHja7JnZkuMgDEVx4n1f4jXx///mdBuSGyxjiinKNVPFfWpjQLIOQpBmTk5OTk5OTk5OTk5OTk5OTk5OTk5OTk7/g6Yxi5l9+dODzPsvGZk9rlFqjURrxGR1ov1BZhHqIzhCO0AzO1O279NvDXh+bM+yJT9tg/VH9X18t3hUvrFvvteuvwqqTD2yHyemUuztvUWD2ojJx3srVy6Nq0VryGQl+3bMAg0NHEEHWTd2pnTfJ9gaAOC+PUeSazlmXyYevZUqZoa+RTXelN3ZyKJXpBj3LAUFzqvTGNF+PPVjYlC2KmA1oj3wz+NQdVdDrKTp88wWxIbOqx5ZPNiRnvzlztdKa8QcosegmwpisQo9FHGAI9dCTFZZqQWI8ASqJ8VIxIVq4u9meZ/LtEbMId4ZVCogdgiSBuJaz1dCjINVUmhpO03I+MI//ezBZwdapJhF21OrN2IOsSbDKMRIihKZJRiGHLno0w51/pZnF+IiFuI4RWnxY5uj6spNBQ8Mf+hMIPq1qB6N91rE2ycZGVZVVQ7idcOEaNwKyfleY8QcopzeGVgdlMTloCh6n2SOkzs+Z98hQYM9iEi5ngflvtvUbtJsKoiVspitbfyVMEG8H+lxUGL9duxA+dd+6gcIoMaIOUR85QsQD0riiM2fQJQq6nwZxEQuCBmzA7HjZusYXqGjDBFLP1N/UPqVlo3OiDnE336LtDkFBxA7voQ2lC8VRCyn6jKIKZndCsR+lc2EqDt7iDh0knsGtorhy/dZY8QcYrCIBEe+32WIWEMtd3ZRQcSRufavgAh7mW2IC2LwnWujAqKHFCMqhYfv3TTUGjGHeBM7JO6i3gHEhjvZb0OUEHFYTK6AiByYLUPsyGE1Fz0pRNzhS6Y+2jw/21SiNWIOMRNbNkI4HUAsuPkZ655AlOw0V0G8Wd9OAWWd9pfyQgExQxAgCc3wzsnc1xoxh7h1DL925ZwBorxoYjHr7QxigtFXQIxgzhJEjBsYNK7wg0LscXqheomV3wU8JfVGzCGWWz+UxEqGiFDl79pbnkAUyRpcBXFaET97ECvS7uMAqjjYKL8xFvtpLzJBb8Qc4g3tI3eFQmw4O/FHrYQIR+KLILJWXPY7mxBDelBBrVdeMSZGBJcHtiABNEbMIWaY6rmF3wdEKVKvz+6VqSDCcLbr0JZCqWWIj5Wrvv01xDAResgr40Uv7d4RxDFXl0S4OMJxnRHjeyJj9aeYhttfFGL3ueTHiIoKYiE6o4Ok0hZENAgVkSFEtW8Dvfe1mAojyzRNqxa/cFBhuvxdkvRGjCGKN/F7J2wOIEaYKwcyBcQQhi6B6N/xz8TOEsQcRugv2XQk8uekNCPvtEaMIQoTyZtVBIhySSwwTa2CCEPJFRDhntAw24FY49Yt232qIAYKhrg846igN2IOcebFXQSjO4DY8h44L8/aTBwvhMge7SeWs8VMTOhZ56UYWYEOJMFBmPRGjCGK2XLBqmUUYic2bxRp7wRiflgTX3/YN7vlxkEYCisxIY4NDk781yR+/9fcaezmLMgaj2aYzl6srtri+CB9gECh9WpTRoiw3qFur4YYbqu1yOv43MafUHh2LkQroLy1QVT2RfQQ16ZpYfXcgHjGBpoMmAkQ1yz/K0cMmGnxjYwWYiEcMSo+b3q2O12O8I5kAx2vENFBXH84LKxGBhGHQ3THyXEof/ecCBvDMq0yQETtMB2bI4OIDu27VSlEtBCntydvVicDiHFKvNWLNZiWLA44+DrKBTEkY6KJ/eSXD0o9RKEXDyJxbALimb1DPrCqRGTnOcR1FgfyCzoG0czcejEOT3QtC0SfrM5WOJNhnGaAeMHFvjh7EoOISCshyiIa5wGxePP9mfD3BOJ55lZIcTABu2QtRIyBY3p06hK/7nKkXhkgTnM6HhoEJYXYQkQDURbROA+I/TvrLs9ziO3MzUlx6FHD1UGUSslXRItwTYWY4fZDBog0oKhKkJ1fKUQkEK+FKIsonAfEdS1e2wERKZFbuR0Hszw8kBqi+XtJ7NL1tYlBeQFJlpmIBcGZ5G7hxCGi0KiEKItonAdEGnDaBcQoJYbqx1Dy43EwD1SXVBDHZuXu0gTTx5njyioGYzJu+xwQ6zhrlAEXRjnEF2aUAqIssuc898Cg9a3CII6Joy26nMbhbnHxVAHRHPw7+PCL3ztrMFjjtz0/6+e0PDnlgEgWBVH81m9DLBFqBURRROE8IKJ5rtEnu7XVwLND/BbbdWNlT7Mo014+JtQzXE1U4lCcpuTiu7k/QRxDzHbmmz8+mwFit+aXlyH6eszs1Qce/oMOoiyy7zyHiKQYiEHEtlY4zBykratYKpa2EbP3OMDApnm14Pk92dIt77RXu7aNeSDiGy5cbR8liD3WQQVEUWTfeQ4RublIISIlspBfRIiN0UI88q0v9xQWIPDgAygTxPswJ/YkDjFa9WolRFlk33kOEXtZDnFcwPBykQTxakgLkSyaua+llf/t6nxK2u65INIU9teXAwuJAqIosu88h4hEN6UQkRLZ5/w2oxtEFBDvfoZVaaspIoUySitD1PZF2SDS5NkUkSCeMUl0ELmIxnlABDhHGxAtWym+kBQjRs4/jhORBiIotj9TKpyJ2wsTrjCJk0f3eTOClAMimTZ8gjeSCBGlt4sSoiwiO/9PW1kVN19U55I2IfeF9YMtjlvNXdvchsfzUlJuM/3VDr5pa4L9ogh3/r/9aQ8OBAAAAAAE+VsPcgUAAAAAAABwEVZkbxOQ71dsAAAAAElFTkSuQmCC\"); }\n      #MagicShopFull.horizontal-flex .sfly_wgt_listview_container .sfly_wgt_listview_embedded_title .sfly-wgt-title-flex .sfly-wgt-title-text.school {\n        top: 17px;\n        left: 17px;\n        width: 296px;\n        height: 46px;\n        background-image: url(\"https://d22bbwxztp2lry.cloudfront.net/productswidget/Shutterfly/sidewidget/images/prod/school-title-text.png\"); }\n    #MagicShopFull.horizontal-flex .sfly_wgt_listview_container .sfly_wgt_listview_embedded_title .sfly-wgt-title-flex .sfly-wgt-subtitle-text {\n      top: 63px;\n      left: 17px;\n      position: absolute;\n      font-family: \"Avenir LT W01 45 Book\", Avenir, Verdana, Arial, sans-serif;\n      line-height: 18px;\n      font-size: 14px;\n      color: #747577; }\n    #MagicShopFull.horizontal-flex .sfly_wgt_listview_container .sfly_wgt_listview_embedded_title .sfly_wgt_listview_embedded_title_actions {\n      font-family: Avenir, Verdana, Arial, sans-serif;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      width: 142px;\n      height: 36px;\n      margin: 0;\n      top: 25px;\n      right: 10px;\n      border-radius: 4px;\n      background-color: transparent;\n      font-size: 12px;\n      font-weight: 700;\n      text-transform: uppercase;\n      text-decoration: none;\n      color: #58595b;\n      border: 1px solid #c6c7c9;\n      cursor: pointer;\n      box-sizing: border-box; }\n      #MagicShopFull.horizontal-flex .sfly_wgt_listview_container .sfly_wgt_listview_embedded_title .sfly_wgt_listview_embedded_title_actions .sfly_wgt_upp_select_main {\n        width: 100%;\n        height: 100%;\n        display: flex;\n        align-items: center;\n        justify-content: center; }\n      #MagicShopFull.horizontal-flex .sfly_wgt_listview_container .sfly_wgt_listview_embedded_title .sfly_wgt_listview_embedded_title_actions.holiday {\n        color: #bf2829;\n        border: 1px solid #bf2829;\n        right: 69px; }\n      #MagicShopFull.horizontal-flex .sfly_wgt_listview_container .sfly_wgt_listview_embedded_title .sfly_wgt_listview_embedded_title_actions.valentine {\n        color: #58595b;\n        border: 1px solid #d81669;\n        right: 20px;\n        top: 30px;\n        background-color: white;\n        width: 156px; }\n      #MagicShopFull.horizontal-flex .sfly_wgt_listview_container .sfly_wgt_listview_embedded_title .sfly_wgt_listview_embedded_title_actions.president {\n        color: #58595b;\n        border: 1px solid #c6c7c9;\n        right: 40px;\n        top: 35px;\n        background-color: rgba(255, 255, 255, 0.05);\n        width: 142px; }\n      #MagicShopFull.horizontal-flex .sfly_wgt_listview_container .sfly_wgt_listview_embedded_title .sfly_wgt_listview_embedded_title_actions.mother-day {\n        border: solid 1px #e51a94;\n        background-color: rgba(255, 255, 255, 0.05);\n        right: 55px; }\n      #MagicShopFull.horizontal-flex .sfly_wgt_listview_container .sfly_wgt_listview_embedded_title .sfly_wgt_listview_embedded_title_actions.father-day {\n        border: solid 1px #093e52;\n        background-color: #f9f9f9;\n        right: 30px; }\n      #MagicShopFull.horizontal-flex .sfly_wgt_listview_container .sfly_wgt_listview_embedded_title .sfly_wgt_listview_embedded_title_actions.summer {\n        background-color: #ffffff;\n        border: solid 1px #dfe5f2;\n        right: 30px; }\n      #MagicShopFull.horizontal-flex .sfly_wgt_listview_container .sfly_wgt_listview_embedded_title .sfly_wgt_listview_embedded_title_actions.made-just {\n        background-color: #ffffff;\n        border: solid 1px #dfe5f2;\n        right: 30px; }\n      #MagicShopFull.horizontal-flex .sfly_wgt_listview_container .sfly_wgt_listview_embedded_title .sfly_wgt_listview_embedded_title_actions.school {\n        background-color: rgba(255, 255, 255, 0.38);\n        border: solid 1px #bfe5f2;\n        right: 32px;\n        color: #0048bd; }\n  #MagicShopFull.horizontal-flex .sfly_wgt_listview_container .sfly_wgt_listview_embedded_title_background.holiday {\n    display: block;\n    position: absolute;\n    top: 0;\n    left: 0;\n    width: 980px;\n    height: 110px;\n    background-image: url(\"https://d22bbwxztp2lry.cloudfront.net/productswidget/Shutterfly/sidewidget/images/prod/holiday-title-background-image-2line.jpg\");\n    background-repeat: no-repeat;\n    background-size: contain;\n    background-position: center; }\n  #MagicShopFull.horizontal-flex .sfly_wgt_listview_container .sfly_wgt_listview_spread_container {\n    box-sizing: border-box;\n    padding-bottom: 10px;\n    padding-left: 10px;\n    padding-right: 10px; }\n    #MagicShopFull.horizontal-flex .sfly_wgt_listview_container .sfly_wgt_listview_spread_container .sfly_wgt_spread_mg.sfly_wgt_listview_spread {\n      display: flex;\n      flex-flow: column wrap;\n      overflow-x: auto;\n      justify-content: flex-end;\n      align-content: flex-start;\n      padding-bottom: 15px;\n      padding-top: 3px; }\n      #MagicShopFull.horizontal-flex .sfly_wgt_listview_container .sfly_wgt_listview_spread_container .sfly_wgt_spread_mg.sfly_wgt_listview_spread .sfly_wgt_product {\n        width: 182px !important;\n        height: 227px !important;\n        border-radius: 4px;\n        background-color: #ffffff;\n        border: solid 1px #dcdee1;\n        margin: 5px 5px;\n        box-sizing: border-box; }\n        #MagicShopFull.horizontal-flex .sfly_wgt_listview_container .sfly_wgt_listview_spread_container .sfly_wgt_spread_mg.sfly_wgt_listview_spread .sfly_wgt_product .sfly_wgt_product_inner {\n          display: flex;\n          justify-content: center;\n          align-items: center;\n          height: 180px;\n          position: relative;\n          overflow: hidden; }\n          #MagicShopFull.horizontal-flex .sfly_wgt_listview_container .sfly_wgt_listview_spread_container .sfly_wgt_spread_mg.sfly_wgt_listview_spread .sfly_wgt_product .sfly_wgt_product_inner canvas {\n            width: auto !important;\n            height: auto !important;\n            position: absolute; }\n          @media screen and (-ms-high-contrast: active), (-ms-high-contrast: none) {\n            #MagicShopFull.horizontal-flex .sfly_wgt_listview_container .sfly_wgt_listview_spread_container .sfly_wgt_spread_mg.sfly_wgt_listview_spread .sfly_wgt_product .sfly_wgt_product_inner canvas {\n              max-width: 164px !important; } }\n        #MagicShopFull.horizontal-flex .sfly_wgt_listview_container .sfly_wgt_listview_spread_container .sfly_wgt_spread_mg.sfly_wgt_listview_spread .sfly_wgt_product .sfly_wgt_product_price {\n          margin-top: -5px !important; }\n          #MagicShopFull.horizontal-flex .sfly_wgt_listview_container .sfly_wgt_listview_spread_container .sfly_wgt_spread_mg.sfly_wgt_listview_spread .sfly_wgt_product .sfly_wgt_product_price h5 {\n            font-size: 13px;\n            font-weight: 800;\n            margin-bottom: 5px; }\n          #MagicShopFull.horizontal-flex .sfly_wgt_listview_container .sfly_wgt_listview_spread_container .sfly_wgt_spread_mg.sfly_wgt_listview_spread .sfly_wgt_product .sfly_wgt_product_price span {\n            font-size: 12px;\n            line-height: 16px; }\n    #MagicShopFull.horizontal-flex .sfly_wgt_listview_container .sfly_wgt_listview_spread_container .sfly-wgt-listview-scrollbar-horizontal {\n      visibility: hidden; }\n  #MagicShopFull.horizontal-flex .sfly_wgt_listview_container .sfly_wgt_listview_scroll_arrows .sfly_wgt_listview_scroll_arrow {\n    top: 266px;\n    width: 48px;\n    height: 96px; }\n  #MagicShopFull.horizontal-flex .sfly_wgt_listview_container .sfly_wgt_listview_scroll_arrows.holiday .sfly_wgt_listview_scroll_arrow.sfly_wgt_listview_scroll_left_arrow {\n    background-image: url(\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAABgCAYAAABbjPFwAAAAAXNSR0IArs4c6QAAApVJREFUeAHtnNFKAkEUhmd1NyPTiyIqCO8riHqGoBdJukx7kuo26iXqTugd6qK6jzBEitCCTGvzSCNqbq1nz8zZhTM347pzZv7v/zeKaRmn/vTiqwS1lOM8+45z6U+lywvZbNUBgHxuNjEIX76vPjud9nvro6mmvQ03Mcp/hHYTUCnP87qXufdW+zCVNACtN+26nuP724kFgCS6j9NcYgF0EgKgneDqJQEu5/W6koB2gquXBLic1+tKAtoJrl4S4HJerysJaCe4ekmAy3m9riSgneDqJQEu5/W6koB2gquXBLic1+tKAtqJSfr6+YV6qlQmKQkca313+v74SD2cnfUEFUpltbK7GyguzA2rj9CgeBAH183rqzA6A8dYAxgVD4rcfF5NLS0HigtzwwpAkPj1k1OVWVwMozNwjHGAv8Rn11YDhYW9YRTAtHiANAZgQ7wxAFvijQDYFE8OYFs8KQCHeDIALvEkAJziIwNwi48EEAfxaIC4iEcDqO57CnFpqD8lCvsltVIsDjF0Gg11s1dUb7d3Q9+bvkABgKi4QKAB4gIRCSAOEJEBuCFIADghyAC4IEgBOCDIAfoQIxtWpn5PGAHoQYzZdTMBYQzAFoRRABsQxgH+g2jVajAE3awAgLpxO9HwM/HxWEWLh0JrALDYKARc5za34Ba6sbx+D//gSE1n1PzODlo4FDaar4oFIJLqgWIAsPoIDaxN9lEAyKxETiQJII0jK5MEyKxETiQJII0jK5MEyKxETiQJII0jK5MEyKxETiQJII0jK5MEyKxETiQJII0jK5MEyKxETiQJII0jK5MEyKyccCI4ogTOWUlsAnC+ChwSY/3t9QmN/jV85HCYgx4A7PImpfWP58m45YWZmeo3u6E0/VxMrv4AAAAASUVORK5CYII=\"); }\n  #MagicShopFull.horizontal-flex .sfly_wgt_listview_container .sfly_wgt_listview_scroll_arrows.holiday .sfly_wgt_listview_scroll_arrow.sfly_wgt_listview_scroll_right_arrow {\n    background-image: url(\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAABgCAYAAABbjPFwAAAAAXNSR0IArs4c6QAAAoZJREFUeAHtnN9OE1EQxuesC9UITTAxRAXulRt4BrjVl6DxUvRJ1FsCL6F3xHfQxIhXhoSY2ASJpgVsae26pwnSgqiZb2ZOlsy56fY0M+f7fd9pdtM/G6gcX4+P71G3/zwUxcqgKG7FuaqMMBTf6b2/XpucupbnE1kIVdFOrfYh5dH5KH6iHJVRPiI0KwbFal46PzJXqcOMqJgJFdo2590tAao9HCB1fp6AJwA64FsINBAu9wRgC8EGngBoIFzuCcAWgg08AdBAuNwTgC0EG3gCoIFwuScAWwg28ARAA+FyTwC2EGwgksDB9jbtv3oNSuGV57yys6rPW1u09/LFcOLH7idaWH969qLBEZRA+93b3+Kj1lEYA+3DJSCAyTt3Ka/Xx7RaQ0AAtdlZWtzYTAoBAUTrbz64nxQCBkgNIQKQEkIMIBWEKEAKCHEAawgVAEsINQArCFUACwh1AG0IEwBNCDMALQhTgAhx6WD+XsMU4GjnI3143KB+qzXGMddo0MKT9bG5/31iBqAhPkKaAGiJNwHQFK8OoC1eFcBCvBqAlXgVAEvx4gDW4kUBLhW/tsY+SUWB/xoi54G/ilf+qBEGSCk+pgMBdJvNP1/bxG2j7Pzp1oIATppfLl6YGYqHE5heWh5zes5YfASAvx+Iom/Mz9Og06Xbjx6eJmv2GPYPvhf16SmzBSUXiv8fgN4DkmK4vRyA65xUnScg5SS3jyfAdU6qzhOQcpLbxxPgOidV5wlIOcnt4wlwnZOq8wSknOT28QS4zknVeQJSTnL7eAJc56TqPAEpJ7l9rkIC4Vt5PxWuAcnrspCFNz/7/V5yJUwBGdXyZ53uSbtXjiomMbyVTZVvz/MLUjAtL5SUCuYAAAAASUVORK5CYII=\"); }\n  #MagicShopFull.horizontal-flex .sfly_wgt_listview_container .sfly_wgt_listview_scroll_arrows.school .sfly_wgt_listview_scroll_arrow.sfly_wgt_listview_scroll_left_arrow {\n    background-image: url(\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAC8AAABeCAYAAACzWU3IAAAAAXNSR0IArs4c6QAAAtFJREFUeAHtnM9rE1EQx9/GLDGaoCBIE9FDY+NJpfjjUpBePPRQBP+G3gVrEYReCvXiD/Au/RMELx70oCAeSisi9JQ29lCbxoKgJLi2m2S703YgSFU6O292F+ZdJqWZN5/vJy3ZbMtz3jZaiyYly3WcTi6bqW13u/dGBoqbDsCPlgqpwPcDYzZ++Wa9vd0NTDCeTQX1PqTrGHPuuAtfHdn0Oo8zaYJH1tIx12x1etVUwsMr4AdBNpXw+AooPJqQrmpe2jjOU/NoQrqqeWnjOE/NownpqualjeM8NY8mpKualzaO89Q8mpCual7aOM5T82hCuqp5aeM4T9x8EN4s/dL0dm84IgS1isK3vV5mZPJj9cLE/KX7c/USFRr7xOAB/OaDT+cXaq0iDH/6Yq387OX6KQShVBF4BF9c3gNH0HrDO4qPKdU6/N/Ab1w8+fPRRKVBgcYeq/D/An81c7mec53w15e+rMHbBofIVuAlwK3AS4Gzw0uCs8JLg7PBxwHOAh8XeGT4OMEjwccNToZPAjgJPingJHhocsI/n/+54EOG9Dr05UEhn+m9nh1euVYttvph3y/9ODE2/bmy5QcHROt/Jt/jQ8PD6KQEIMEnJQAZPgkBIsHHHSAyfJwBWODjCsAGH0cAVnjpAOzwkgGswPcHuDpk753YGjwGePNweMVWAKvw/wsw9bxehudQl3V4AINroYNegUo5/5sKDn0i8DAIA+DV6N3bZxt3bp35Dt+jLtF/hIYAH55cqa1+89zBgbxPhcY+MfM4ED7IcIDDfuLwGIKjKjyHRcoeap5ijaNHzXNYpOyh5inWOHrUPIdFyh5qnmKNo0fNc1ik7KHmKdY4etQ8h0XKHmqeYo2jR81zWKTsoeYp1jh6UmkeDm+A0ydSCd8MT53IZc2y6I3WqD8qYBzAv4bHZYSHHkztwr/baEfdV6R/76CS0HgIfv10obkDUjOpE9lntWEAAAAASUVORK5CYII=\");\n    width: 47px;\n    height: 94px; }\n  #MagicShopFull.horizontal-flex .sfly_wgt_listview_container .sfly_wgt_listview_scroll_arrows.school .sfly_wgt_listview_scroll_arrow.sfly_wgt_listview_scroll_right_arrow {\n    background-image: url(\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAC8AAABeCAYAAACzWU3IAAAAAXNSR0IArs4c6QAAAsNJREFUeAHtnE1rE0EYx2f2JWG1RQ8lbSIKGhsvviDUkyhePHgS/Ay9C0oRBC+CXqriBxA/gghCD3pQEA+2FRE8WdNLSxoEQUm0jRuzZgoLSzDDduZ5nmHhmctmdzLP/P6/LGRIhpVi2N61O5WS7z/o9QeNOEkCda0ILVDgUsgXlSjwq/tCEcoiYAvxZqsrgpIvH1aikn9kf1gM6gyl1+uLWWW8iM1T93hRbpVRwd7ohSKdM7yrT4vNs3kDA3zbGEgDGcLmQTQaFGHzBtJAhrB5EI0GRdi8gTSQIWweRKNBETZvIA1kCJsH0WhQhM0bSAMZwubX29thkoDI3FMRa/O3njarJ+bfnz5/80Ojuz2wrrcXeqvJHj/fnHr0bKOmJlz50pm8fPvjccoAVvDrWzvlrKnVNdoAVvCL8/XWxVMHf7oKYAVfDmWydPdM01UAK3hl3GUAa3iXAUDgXQUAg3cRABSeOgA4PGUAFHiqAGjwFAFQ4bEDoMNjBiCBzwa4cBJuLUQGrwKMa9JwpwkZfC9O5JU7n+pvP/84kA1xrjHZeXnv7NeJyBtkr+d5TQKPAa7CocNjgaPDY4KjwmODo8FTgKPAU4GDw1OCg8JTg4PBuwAHgXcFbg0/Dnxu1vwrX0HlbVbfsAtPmrX/rVVe3Tdbq+SFTt9nBV+vRTtpIXWkMp7OaQV//eqh7zeuHW6pYmp1SGU8hZevW53VS9WJ9NzoqP5cODodxabrcpNJd3dxmwwcHXNsJopHr1GcW902FIC6ORheZwezj81j2tXVZvM6O5h9bB7Trq42m9fZwexj85h2dbXZvM4OZh+bx7Srq83mdXYw+9g8pl1dbTavs4PZx+Yx7epqe6GU/djBPmAdVN4+rxyItfZvJ7/W5WUc+z5vuPt6YbP75+/Gr1gU7RPY3W+x/K07M/yFd1E9faJIDyr5B13soWlrNdFmAAAAAElFTkSuQmCC\");\n    width: 47px;\n    height: 94px; }\n  #MagicShopFull.horizontal-flex .sfly_banner_free_prints.sfly_wgt_product_banner.horizontal_magic {\n    top: 3px;\n    right: 3px; }\n\n#recommendationArea .recThumbArea.ic-web-cart a, #recommendationEntities .recThumbArea.ic-web-cart a {\n  width: 100%;\n  height: 100%; }\n  #recommendationArea .recThumbArea.ic-web-cart a .sfly_wgt_product_inner, #recommendationEntities .recThumbArea.ic-web-cart a .sfly_wgt_product_inner {\n    display: flex;\n    justify-content: center;\n    align-items: center;\n    height: 100%; }\n    #recommendationArea .recThumbArea.ic-web-cart a .sfly_wgt_product_inner canvas, #recommendationEntities .recThumbArea.ic-web-cart a .sfly_wgt_product_inner canvas {\n      width: auto !important;\n      height: auto !important;\n      max-width: 100% !important;\n      max-height: 100% !important; }\n#recommendationArea .pricing, #recommendationEntities .pricing {\n  margin-top: 22px;\n  font-family: \"Avenir LT W01 55 Roman\",Verdana,Arial,sans-serif;\n  color: #58595b; }\n  #recommendationArea .pricing .listPrice, #recommendationEntities .pricing .listPrice {\n    text-decoration: line-through;\n    color: #666; }\n  #recommendationArea .pricing .salePrice, #recommendationEntities .pricing .salePrice {\n    color: #c00;\n    margin-left: 10px; }\n#recommendationArea .CTASection, #recommendationEntities .CTASection {\n  margin-top: 20px; }\n  #recommendationArea .CTASection .secondaryButton, #recommendationEntities .CTASection .secondaryButton {\n    border: solid 1px #c6c7c9 !important;\n    color: #58595b !important;\n    line-height: 34px !important;\n    background-color: rgba(255, 255, 255, 0.05) !important;\n    background-image: none !important;\n    box-shadow: none !important;\n    text-shadow: none !important; }\n    #recommendationArea .CTASection .secondaryButton:hover, #recommendationEntities .CTASection .secondaryButton:hover {\n      border: solid 1px #dc4405 !important;\n      color: #dc4405 !important; }\n\n.storyBook canvas {\n  transform: scale(0.75);\n  top: 51px !important; }\n\n.storyBook .sfly_wgt_product_inner {\n  height: 100% !important; }\n\n#MagicShopFull.horizontal-flex .sfly_wgt_listview_container .sfly_wgt_listview_spread_container .sfly_wgt_spread_mg.sfly_wgt_listview_spread .sfly_wgt_product.storyBook .sfly_wgt_product_price.marginTopM30 {\n  margin-top: -29px !important; }\n\n.storyBook div.title {\n  position: absolute;\n  left: 63px;\n  top: 11px;\n  width: 94px;\n  height: 32px;\n  font-family: \"Avenir LT\",Verdana,Arial,sans-serif;\n  font-size: 12px;\n  font-style: normal;\n  font-stretch: normal;\n  line-height: normal;\n  letter-spacing: normal;\n  color: #58595b;\n  text-transform: uppercase;\n  font-weight: 700;\n  text-align: center; }\n\n.storyBook div.subTitle {\n  position: absolute;\n  top: 49px;\n  width: 139px;\n  height: 28px;\n  font-family: \"Avenir LT\",Verdana,Arial,sans-serif;\n  font-size: 10px;\n  font-weight: 500;\n  font-style: normal;\n  font-stretch: normal;\n  line-height: normal;\n  letter-spacing: normal;\n  color: #58595b;\n  text-align: center;\n  left: 22px; }\n\n.storyBook h5 {\n  display: none; }\n\n.sfly-img-spread {\n  width: auto;\n  height: 45px; }\n\n#sfly_wgt_container {\n  -webkit-touch-callout: none;\n  -webkit-user-select: none;\n  -khtml-user-select: none;\n  -moz-user-select: none;\n  -ms-user-select: none;\n  -o-user-select: none;\n  user-select: none;\n  position: fixed;\n  border: solid 1px #c6c7c9;\n  border-right: solid 1px #fff;\n  background-color: #fff;\n  z-index: 6000;\n  height: 500px;\n  width: 0px;\n  overflow: hidden;\n  display: none; }\n  #sfly_wgt_container .sfly_wgt_product.not-selected {\n    opacity: 0.4;\n    filter: alpha(opacity=40); }\n    #sfly_wgt_container .sfly_wgt_product.not-selected:hover {\n      opacity: 0.7;\n      filter: alpha(opacity=70); }\n  #sfly_wgt_container .sfly_wgt_product.on-hover {\n    opacity: 0.9;\n    filter: alpha(opacity=90); }\n  #sfly_wgt_container .sfly_wgt_product.on-hover-other {\n    opacity: 0.7;\n    filter: alpha(opacity=70); }\n  #sfly_wgt_container p.sfly_wgt_side_widget_title {\n    position: absolute;\n    top: 0px;\n    margin: 0;\n    padding: 0;\n    padding-top: 5px;\n    padding-bottom: 3px;\n    background-color: #fff;\n    color: #888888;\n    font-family: \"Avenir LT W01 65 Medium\", \"Avenir LT\", Verdana, Arial, sans-serif;\n    font-size: 11px;\n    /* temp */\n    text-align: center;\n    width: 100%;\n    z-index: 2; }\n    #sfly_wgt_container p.sfly_wgt_side_widget_title .sfly-wgt-qst-mark {\n      position: absolute;\n      right: 9px;\n      top: 4px;\n      width: 18px;\n      height: 18px; }\n      #sfly_wgt_container p.sfly_wgt_side_widget_title .sfly-wgt-qst-mark:hover {\n        cursor: pointer; }\n        #sfly_wgt_container p.sfly_wgt_side_widget_title .sfly-wgt-qst-mark:hover:after, #sfly_wgt_container p.sfly_wgt_side_widget_title .sfly-wgt-qst-mark:hover:before {\n          background: #F05323; }\n  #sfly_wgt_container .sfly-wgt-overlay-message {\n    position: absolute;\n    top: 30px;\n    left: 0;\n    background-color: #f05323;\n    color: white;\n    width: 160px;\n    z-index: 1001;\n    opacity: 0.9;\n    filter: alpha(opacity=90); }\n    #sfly_wgt_container .sfly-wgt-overlay-message a {\n      color: #fff;\n      padding: 10px;\n      display: block; }\n  #sfly_wgt_container .sfly-wgt-static-filler {\n    width: 180px;\n    height: 520px;\n    position: absolute;\n    top: 0;\n    left: 0; }\n\n.sfly_wgt {\n  -webkit-touch-callout: none;\n  -webkit-user-select: none;\n  -khtml-user-select: none;\n  -moz-user-select: none;\n  -ms-user-select: none;\n  -o-user-select: none;\n  user-select: none;\n  font-size: 13px;\n  font-family: verdana, geneva, arial, helvetica, clean, sans-serif;\n  line-height: normal; }\n  .sfly_wgt p, .sfly_wgt h5 {\n    color: #181512; }\n  .sfly_wgt a, .sfly_wgt a:active, .sfly_wgt a:visited, .sfly_wgt a:hover {\n    text-decoration: none;\n    color: #4b525c; }\n  .sfly_wgt ul.sfly-wgt-cal-nav {\n    list-style: none;\n    display: none;\n    position: absolute;\n    top: -3px;\n    right: -17px;\n    z-index: 8;\n    margin-top: 13px;\n    margin-bottom: 13px; }\n    .sfly_wgt ul.sfly-wgt-cal-nav li {\n      float: left;\n      clear: both;\n      cursor: pointer;\n      line-height: 1; }\n      .sfly_wgt ul.sfly-wgt-cal-nav li div {\n        width: 3px;\n        height: 20px;\n        border: none;\n        background-color: #c6c7c9;\n        display: inline-block;\n        margin-right: 5px;\n        float: left; }\n      .sfly_wgt ul.sfly-wgt-cal-nav li span {\n        display: inline-block;\n        margin-top: 4px;\n        font-size: 11px; }\n      .sfly_wgt ul.sfly-wgt-cal-nav li.wgt-nav-selected div {\n        background-color: #f05323; }\n      .sfly_wgt ul.sfly-wgt-cal-nav li.wgt-nav-selected span {\n        color: #f05323; }\n  .sfly_wgt ul.sfly-wgt-cal-nav-horiz {\n    list-style: none;\n    display: none;\n    z-index: 8;\n    text-align: center;\n    position: relative;\n    margin-top: 0;\n    margin-bottom: 5px; }\n    .sfly_wgt ul.sfly-wgt-cal-nav-horiz li {\n      float: left;\n      cursor: pointer;\n      width: 32px;\n      line-height: 1.22em; }\n      .sfly_wgt ul.sfly-wgt-cal-nav-horiz li:first-of-type {\n        background-color: #FFFFFF;\n        border-radius: 5px 0 0 5px; }\n        .sfly_wgt ul.sfly-wgt-cal-nav-horiz li:first-of-type div {\n          background-color: #c6c7c9;\n          border-radius: 5px 0 0 5px; }\n      .sfly_wgt ul.sfly-wgt-cal-nav-horiz li:last-of-type {\n        background-color: #FFFFFF;\n        border-radius: 0 5px 5px 0; }\n        .sfly_wgt ul.sfly-wgt-cal-nav-horiz li:last-of-type div {\n          background-color: #c6c7c9;\n          border-radius: 0 5px 5px 0; }\n      .sfly_wgt ul.sfly-wgt-cal-nav-horiz li div {\n        width: 100%;\n        height: 5px;\n        border: none;\n        background-color: #c6c7c9;\n        display: inline-block; }\n      .sfly_wgt ul.sfly-wgt-cal-nav-horiz li span {\n        font-size: 11px;\n        display: inline-block; }\n      .sfly_wgt ul.sfly-wgt-cal-nav-horiz li.wgt-nav-selected div {\n        background-color: #f05323;\n        border-radius: 5px; }\n        .sfly_wgt ul.sfly-wgt-cal-nav-horiz li.wgt-nav-selected div:hover {\n          background-color: #dc4405; }\n      .sfly_wgt ul.sfly-wgt-cal-nav-horiz li.wgt-nav-selected span {\n        color: #f05323; }\n        .sfly_wgt ul.sfly-wgt-cal-nav-horiz li.wgt-nav-selected span:hover {\n          color: #dc4405; }\n  .sfly_wgt ul.sfly-wgt-book-nav {\n    list-style: none;\n    position: absolute;\n    bottom: 0px;\n    left: 0px;\n    z-index: 8;\n    height: 7px;\n    padding: 0;\n    margin: 0; }\n    .sfly_wgt ul.sfly-wgt-book-nav li {\n      float: left;\n      /*\n      div.last {\n        border-right: 1px solid #AAA;\n      }\n      */ }\n      .sfly_wgt ul.sfly-wgt-book-nav li div {\n        width: 20px;\n        height: 7px;\n        /*border: 1px solid #AAA;*/\n        /*border-right: none;*/\n        border: none;\n        background-color: #c6c7c9;\n        display: inline-block;\n        float: left; }\n      .sfly_wgt ul.sfly-wgt-book-nav li span {\n        display: inline-block;\n        margin-top: 1px;\n        font-size: 11px; }\n      .sfly_wgt ul.sfly-wgt-book-nav li.wgt-nav-selected div {\n        background-color: #f25e1c; }\n  .sfly_wgt.sfly_wgt_fullview.sfly_wgt_fullview_container {\n    font-size: 18px;\n    color: darkred;\n    background-color: #fff;\n    height: 100%; }\n    .sfly_wgt.sfly_wgt_fullview.sfly_wgt_fullview_container p {\n      margin-left: 50px; }\n    .sfly_wgt.sfly_wgt_fullview.sfly_wgt_fullview_container span {\n      display: inline-block;\n      margin-left: 70px; }\n    .sfly_wgt.sfly_wgt_fullview.sfly_wgt_fullview_container ul.sfly-wgt-cal-nav {\n      top: 27px;\n      left: -65px;\n      width: 65px; }\n      .sfly_wgt.sfly_wgt_fullview.sfly_wgt_fullview_container ul.sfly-wgt-cal-nav li {\n        float: left;\n        clear: both; }\n        .sfly_wgt.sfly_wgt_fullview.sfly_wgt_fullview_container ul.sfly-wgt-cal-nav li div {\n          float: right; }\n        .sfly_wgt.sfly_wgt_fullview.sfly_wgt_fullview_container ul.sfly-wgt-cal-nav li span {\n          display: inline-block;\n          float: left;\n          text-align: right;\n          margin-right: 10px;\n          margin-left: 0;\n          width: 40px;\n          color: #c6c7c9; }\n        .sfly_wgt.sfly_wgt_fullview.sfly_wgt_fullview_container ul.sfly-wgt-cal-nav li.wgt-nav-selected span {\n          color: #f05323; }\n    .sfly_wgt.sfly_wgt_fullview.sfly_wgt_fullview_container .sfly_wgt_fullview_categories {\n      width: 100%;\n      background-color: #f7f8fb;\n      text-align: center;\n      clear: both;\n      float: left;\n      border-bottom: 1px solid #e1e1e3; }\n      .sfly_wgt.sfly_wgt_fullview.sfly_wgt_fullview_container .sfly_wgt_fullview_categories a {\n        display: inline-block;\n        /*padding: 15px 39px 5px 39px;*/\n        padding-top: 15px;\n        padding-bottom: 5px;\n        height: 24px;\n        width: 155px;\n        color: #8e939a;\n        float: left;\n        border-right: 1px solid #e1e1e3;\n        /*border-bottom: 1px solid #e1e1e3;*/ }\n        .sfly_wgt.sfly_wgt_fullview.sfly_wgt_fullview_container .sfly_wgt_fullview_categories a.selected {\n          margin-bottom: -2px;\n          background-color: #FFF;\n          color: #f05323;\n          border-bottom: 2px solid #fff; }\n        .sfly_wgt.sfly_wgt_fullview.sfly_wgt_fullview_container .sfly_wgt_fullview_categories a:hover {\n          color: #f05323; }\n      .sfly_wgt.sfly_wgt_fullview.sfly_wgt_fullview_container .sfly_wgt_fullview_categories a.sfly-wgt-main-close {\n        float: right;\n        border-right: none;\n        /*padding: 15px 22px 5px 22px;*/\n        width: 44px;\n        background-image: url(\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAwAAAAMCAYAAABWdVznAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2hpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDpGQkM0RDIwNDBBMjA2ODExOTEwOUNDNjQyQzQ0RUMwQyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDpEMzBDMTk3QTcxNTIxMUU0QkJCODhBRTc0MkFDQkZBMiIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDpEMzBDMTk3OTcxNTIxMUU0QkJCODhBRTc0MkFDQkZBMiIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M2IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6MDM4MDExNzQwNzIwNjgxMTgyMkE4N0I0NUQ5RjhBMkUiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6RkJDNEQyMDQwQTIwNjgxMTkxMDlDQzY0MkM0NEVDMEMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz5zv0xgAAABMklEQVR42mL8//8/AymABUT4BMfaAql4IJ6/Ze3io8gKoHIJQDwPJMcEEmRjY0sFUlyMjIxZQAXWyIqBYhlAJic7O1gNAyPISecvXr7W2Np78c/fv/+BCoBC/6eA5IAgG8hmZGFmZqyvLtE11NfRYYT6IerCpavNDS3dp2CaQPjfv39MIMWNtaXm+rraVUB1K5igti8z0NOuq60sMgVxQKbCFDfUgBVXgxSD5JiQ/Lf0yrUb89BDBSg2A0gth/FhTgJ50AbojEyQ6UDAwMzExIjkp2mw0GNCCo1MmAebasssgE4xA7GhBoBCzwquARSscMV1ZebA0KgD+QlZEzBY0xigHmQ4d+HStbiU3DUXL1+9B+RHgMSgOPr8xSv3QHLnLly+AnY+VCIKiN+iKcYqBxBgAHZAyDRaafTEAAAAAElFTkSuQmCC\");\n        background-repeat: no-repeat;\n        background-position: 50% 50%; }\n        .sfly_wgt.sfly_wgt_fullview.sfly_wgt_fullview_container .sfly_wgt_fullview_categories a.sfly-wgt-main-close:hover {\n          background-image: url(\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAwAAAAMCAYAAABWdVznAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2hpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDpGQkM0RDIwNDBBMjA2ODExOTEwOUNDNjQyQzQ0RUMwQyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDpEMzBDMTk3RTcxNTIxMUU0QkJCODhBRTc0MkFDQkZBMiIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDpEMzBDMTk3RDcxNTIxMUU0QkJCODhBRTc0MkFDQkZBMiIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M2IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6MDM4MDExNzQwNzIwNjgxMTgyMkE4N0I0NUQ5RjhBMkUiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6RkJDNEQyMDQwQTIwNjgxMTkxMDlDQzY0MkM0NEVDMEMiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz61mopnAAABNElEQVR42mL8//8/AymAEaThY4iKLZAdD8Tz+dfcOYqsACqXAMTzQHJMYF1sHKlAiouBkSkLqMAaRTEjUwaQycnIzpkKt+HPxSPXvralXGT4++c/UMF/hv//poDkgOxsIJuRgZmFkbtqji6Lvo0OI9QPUX8uHW3+2pp8Cq6JkfE/w7+/TGDFNfPMWXStqoDqVjAieTr6z/lDjV9bk07BPQBSXD3XnEXPuhrIWw4SYkLy39I/10/NQw+VP9dOz4AphvsB6kEboFMywW5mBJrDxMSI5KdpsNBDBCsoNBAeNAf5AcVP//9NBWo6hghWmOLaBebA0KgDursO6H4zkBhIDhisaWCngGz4feHwtU+pVmt+Xz5+D8iPAIlBcfTvi0fugeUuHL4Cdj5UIgqI36IpxioHEGAAKVTKN//8UEIAAAAASUVORK5CYII=\"); }\n    .sfly_wgt.sfly_wgt_fullview.sfly_wgt_fullview_container .sfly_wgt_fullview_sub_cats {\n      position: absolute;\n      top: 204px;\n      left: 30px; }\n      .sfly_wgt.sfly_wgt_fullview.sfly_wgt_fullview_container .sfly_wgt_fullview_sub_cats .sfly_wgt_fullview_subcat_ctr {\n        float: right; }\n        .sfly_wgt.sfly_wgt_fullview.sfly_wgt_fullview_container .sfly_wgt_fullview_sub_cats .sfly_wgt_fullview_subcat_ctr.sfly_wgt_right-pad {\n          margin-right: 20px;\n          padding-right: 30px;\n          border-right: 1px solid #c6c7c9; }\n      .sfly_wgt.sfly_wgt_fullview.sfly_wgt_fullview_container .sfly_wgt_fullview_sub_cats h6.sfly_wgt_fullview_subcat_title {\n        color: #f05323;\n        padding: 0;\n        margin: 0;\n        margin-bottom: 3px;\n        font-size: 16px;\n        font-weight: 300; }\n      .sfly_wgt.sfly_wgt_fullview.sfly_wgt_fullview_container .sfly_wgt_fullview_sub_cats ul.sfly_wgt_fullview_sub_cat_menu {\n        padding: 0;\n        margin: 0; }\n        .sfly_wgt.sfly_wgt_fullview.sfly_wgt_fullview_container .sfly_wgt_fullview_sub_cats ul.sfly_wgt_fullview_sub_cat_menu li {\n          list-style: none;\n          margin-bottom: 20px; }\n          .sfly_wgt.sfly_wgt_fullview.sfly_wgt_fullview_container .sfly_wgt_fullview_sub_cats ul.sfly_wgt_fullview_sub_cat_menu li.link_see_all {\n            margin-top: 40px; }\n          .sfly_wgt.sfly_wgt_fullview.sfly_wgt_fullview_container .sfly_wgt_fullview_sub_cats ul.sfly_wgt_fullview_sub_cat_menu li a:hover {\n            color: #f05323; }\n          .sfly_wgt.sfly_wgt_fullview.sfly_wgt_fullview_container .sfly_wgt_fullview_sub_cats ul.sfly_wgt_fullview_sub_cat_menu li a.selected {\n            color: #f05323;\n            background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABEAAAAOCAYAAADJ7fe0AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA4JpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDpGQkM0RDIwNDBBMjA2ODExOTEwOUNDNjQyQzQ0RUMwQyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDpEQTNGRjhGQTVBQkExMUU0QkY3Q0JBNzYwMzg3Nzg0QyIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDpEQTNGRjhGOTVBQkExMUU0QkY3Q0JBNzYwMzg3Nzg0QyIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ0MgMjAxNCAoTWFjaW50b3NoKSI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOjVkMDA0MGZjLTBjOWUtNGRiNy05MzNjLWYyMGY2MGIyYjQ2MiIgc3RSZWY6ZG9jdW1lbnRJRD0iYWRvYmU6ZG9jaWQ6cGhvdG9zaG9wOjIzNDQ3ZTJiLThiN2YtMTE3Ny1hNDMyLWM3MzNkODJmYmUxNyIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PmFNu5UAAAFSSURBVHjaYvwUJ8NABOgG4lgg9gHiM8gSvAsfMzARYwKzlrU7kBJnYGbZC6T10eWJMoQzd9Y5Zg0LBoa/f/iABu0HCmmTbAgjF18WZ/7cI8yqJiCDBIEGHQAKq5FkyOd42W9Agzw5C+adZFbUBxkkAjToIFBKGWwJMGCZgTQfMYaxeabxsdpFbvo+IUnv38v7wMBieQo00JLxU7zsRYb///UYyAUsrLeYmOV1lBkoAExSarKM////PwJkWxOr6f+Hlwzf2kIY/r18wMAkrsjAWbbsHCORiQ0GRIHhcAQYDmpMonIMnBUr7zOJyFgzkWCAMDhqgQYwCkkxcJYufQQ0wA4o/pxYQ/jBqfXvHy1GQQkGrrKlz5nEFeyBUf+E6HTCwMK2CGiAPiOfCANXyZKXTJIqdkADHpCU2FiM3LWATmfgKl3yjklG3QFowB1keYAAAwB8sVv+XJC7sQAAAABJRU5ErkJggg==);\n            background-repeat: no-repeat;\n            background-position: right center;\n            padding-right: 25px; }\n          .sfly_wgt.sfly_wgt_fullview.sfly_wgt_fullview_container .sfly_wgt_fullview_sub_cats ul.sfly_wgt_fullview_sub_cat_menu li a.link_see_all {\n            background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA4JpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDpGQkM0RDIwNDBBMjA2ODExOTEwOUNDNjQyQzQ0RUMwQyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDpEQTNGRjhGRTVBQkExMUU0QkY3Q0JBNzYwMzg3Nzg0QyIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDpEQTNGRjhGRDVBQkExMUU0QkY3Q0JBNzYwMzg3Nzg0QyIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ0MgMjAxNCAoTWFjaW50b3NoKSI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOjVkMDA0MGZjLTBjOWUtNGRiNy05MzNjLWYyMGY2MGIyYjQ2MiIgc3RSZWY6ZG9jdW1lbnRJRD0iYWRvYmU6ZG9jaWQ6cGhvdG9zaG9wOjIzNDQ3ZTJiLThiN2YtMTE3Ny1hNDMyLWM3MzNkODJmYmUxNyIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PjEzWncAAAEkSURBVHjaYvz//z8DMcAnOJYXSBkDsQkQqwOxJhCLsRChkRFI5QNxFxCzIsupqih9ZwEqwOmELWsXMwIxmH37zj3G8poWhl+/f8PlxcVEPjIR4XqQBRPaeyZvQNYMAkKCAg9YkGzD541cIBUC4zMzMzP8/fsX6ALR88guYMSCQZrtGRkZJ8AUOdhaMXQ0V/9lARqipam+g4VQyLOxsq4GOp0JZGt8dBhDkL/XMqDUlJTE6MOqyoqH8BqgramuePvufREJcTGGgpzUvzpaGhVA4R6w4Z6uoJj5wOAdFPMfhEHpAQtWfvrs+bcfP37eA7JtsakhlA7uSklK6AHpp0D8Heqt/7AoBtEsRETjHXySTAwUAvobAIpOZMCCFOf/B8QLAAEGAN/jesiECqnKAAAAAElFTkSuQmCC);\n            background-repeat: no-repeat;\n            background-position: left center;\n            padding-left: 25px; }\n  .sfly_wgt.sfly_wgt_fullview.sfly_wgt_fullview_products {\n    width: 100%; }\n  .sfly_wgt.sfly_wgt_fullview.sfly_wgt_products_container {\n    /*width: 780px;*/\n    width: 100%;\n    height: 430px;\n    /*margin-top: 40px;*/\n    overflow-x: auto;\n    float: left;\n    /*margin-left: 200px;*/\n    text-align: center;\n    /* If not menu on left - Center everything */ }\n    .sfly_wgt.sfly_wgt_fullview.sfly_wgt_products_container.no_menu {\n      margin-left: 0px;\n      width: 980px; }\n    .sfly_wgt.sfly_wgt_fullview.sfly_wgt_products_container.sfly_wgt_loading {\n      margin: 0;\n      width: 100%; }\n    .sfly_wgt.sfly_wgt_fullview.sfly_wgt_products_container .sfly_wgt_product {\n      display: inline-block;\n      position: relative;\n      margin-top: 25px;\n      height: 315px; }\n      .sfly_wgt.sfly_wgt_fullview.sfly_wgt_products_container .sfly_wgt_product .sfly_wgt_product_price, .sfly_wgt.sfly_wgt_fullview.sfly_wgt_products_container .sfly_wgt_product .sfly_wgt_product_price_nav {\n        text-align: center;\n        color: #181512;\n        font-size: 13px;\n        font-weight: 300;\n        /*margin-top: -25px;*/\n        width: 100%;\n        position: relative !important;\n        top: 0 !important;\n        left: 0 !important; }\n        .sfly_wgt.sfly_wgt_fullview.sfly_wgt_products_container .sfly_wgt_product .sfly_wgt_product_price h5, .sfly_wgt.sfly_wgt_fullview.sfly_wgt_products_container .sfly_wgt_product .sfly_wgt_product_price span, .sfly_wgt.sfly_wgt_fullview.sfly_wgt_products_container .sfly_wgt_product .sfly_wgt_product_price_nav h5, .sfly_wgt.sfly_wgt_fullview.sfly_wgt_products_container .sfly_wgt_product .sfly_wgt_product_price_nav span {\n          margin: 0;\n          padding: 0; }\n        .sfly_wgt.sfly_wgt_fullview.sfly_wgt_products_container .sfly_wgt_product .sfly_wgt_product_price span.price-old, .sfly_wgt.sfly_wgt_fullview.sfly_wgt_products_container .sfly_wgt_product .sfly_wgt_product_price_nav span.price-old {\n          text-decoration: line-through; }\n        .sfly_wgt.sfly_wgt_fullview.sfly_wgt_products_container .sfly_wgt_product .sfly_wgt_product_price span.price-sale, .sfly_wgt.sfly_wgt_fullview.sfly_wgt_products_container .sfly_wgt_product .sfly_wgt_product_price_nav span.price-sale {\n          color: #C11111; }\n        .sfly_wgt.sfly_wgt_fullview.sfly_wgt_products_container .sfly_wgt_product .sfly_wgt_product_price span.price-wrapper, .sfly_wgt.sfly_wgt_fullview.sfly_wgt_products_container .sfly_wgt_product .sfly_wgt_product_price_nav span.price-wrapper {\n          line-height: 16px; }\n      .sfly_wgt.sfly_wgt_fullview.sfly_wgt_products_container .sfly_wgt_product .sfly_wgt_product_price_nav h5 {\n        display: inline-block;\n        font-weight: 600; }\n      .sfly_wgt.sfly_wgt_fullview.sfly_wgt_products_container .sfly_wgt_product .sfly_wgt_product_price_nav span {\n        display: inline-block;\n        font-weight: 300; }\n      .sfly_wgt.sfly_wgt_fullview.sfly_wgt_products_container .sfly_wgt_product .sfly_wgt_product_price {\n        font-size: 13px; }\n        .sfly_wgt.sfly_wgt_fullview.sfly_wgt_products_container .sfly_wgt_product .sfly_wgt_product_price h5 {\n          font-weight: 600;\n          margin-bottom: 3px;\n          display: inline-block; }\n      .sfly_wgt.sfly_wgt_fullview.sfly_wgt_products_container .sfly_wgt_product .sfly_wgt_product_custom {\n        text-align: center;\n        /*width: 100%;*/\n        display: none;\n        margin-top: 15px; }\n        .sfly_wgt.sfly_wgt_fullview.sfly_wgt_products_container .sfly_wgt_product .sfly_wgt_product_custom.inline {\n          display: inline-block;\n          margin-left: 20px; }\n  .sfly_wgt.sfly_wgt_fullview h6.sfly_wgt_fullview_title {\n    font-size: 18px;\n    text-align: center;\n    width: 100%;\n    margin: 0;\n    padding-top: 30px;\n    color: #6c747f;\n    clear: both;\n    float: left; }\n  .sfly_wgt.sfly_wgt_fullview .sfly_wgt_fullview_title_minor {\n    font-size: 14px;\n    text-align: center;\n    width: 100%;\n    margin: 0;\n    padding-top: 30px;\n    color: #6c747f;\n    clear: both;\n    float: left; }\n    .sfly_wgt.sfly_wgt_fullview .sfly_wgt_fullview_title_minor a {\n      margin-left: 15px;\n      padding: 5px 20px; }\n  .sfly_wgt.sfly_wgt_fullview .sfly_wgt_fullview_title_button {\n    float: right;\n    margin-top: 15px;\n    margin-left: 50px;\n    margin-right: 15px; }\n    .sfly_wgt.sfly_wgt_fullview .sfly_wgt_fullview_title_button a {\n      color: #444444; }\n  .sfly_wgt.sfly_wgt_fullview .sfly_wgt_fullview_bottombar {\n    border-top: 1px solid #c6c7c9;\n    padding-top: 10px;\n    padding-bottom: 10px;\n    position: absolute;\n    bottom: 0;\n    left: 0;\n    width: 100%;\n    text-align: center; }\n  .sfly_wgt.sfly_wgt_fullview .sfly_wgt_footer {\n    background-color: #f7f8fb;\n    border-top: 1px solid #e1e1e3;\n    position: absolute;\n    bottom: 0;\n    left: 0;\n    width: 100%;\n    height: 43px;\n    -webkit-border-bottom-right-radius: 10px;\n    -webkit-border-bottom-left-radius: 10px;\n    -moz-border-radius-bottomright: 10px;\n    -moz-border-radius-bottomleft: 10px;\n    border-bottom-right-radius: 10px;\n    border-bottom-left-radius: 10px; }\n    .sfly_wgt.sfly_wgt_fullview .sfly_wgt_footer .sfly_wgt_fullview_bottom_writing {\n      position: absolute;\n      bottom: 15px;\n      left: 30px;\n      /*width: 100%;\n      text-align: center;*/\n      color: #949494;\n      box-shadow: #ffffff; }\n    .sfly_wgt.sfly_wgt_fullview .sfly_wgt_footer .sfly_wgt_fullview_bottom_see_all {\n      position: absolute;\n      bottom: 15px;\n      right: 30px;\n      height: 16px;\n      color: #181512;\n      text-decoration: underline;\n      background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA4JpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDpGQkM0RDIwNDBBMjA2ODExOTEwOUNDNjQyQzQ0RUMwQyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDpEQTNGRjhGRTVBQkExMUU0QkY3Q0JBNzYwMzg3Nzg0QyIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDpEQTNGRjhGRDVBQkExMUU0QkY3Q0JBNzYwMzg3Nzg0QyIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ0MgMjAxNCAoTWFjaW50b3NoKSI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOjVkMDA0MGZjLTBjOWUtNGRiNy05MzNjLWYyMGY2MGIyYjQ2MiIgc3RSZWY6ZG9jdW1lbnRJRD0iYWRvYmU6ZG9jaWQ6cGhvdG9zaG9wOjIzNDQ3ZTJiLThiN2YtMTE3Ny1hNDMyLWM3MzNkODJmYmUxNyIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PjEzWncAAAEkSURBVHjaYvz//z8DMcAnOJYXSBkDsQkQqwOxJhCLsRChkRFI5QNxFxCzIsupqih9ZwEqwOmELWsXMwIxmH37zj3G8poWhl+/f8PlxcVEPjIR4XqQBRPaeyZvQNYMAkKCAg9YkGzD541cIBUC4zMzMzP8/fsX6ALR88guYMSCQZrtGRkZJ8AUOdhaMXQ0V/9lARqipam+g4VQyLOxsq4GOp0JZGt8dBhDkL/XMqDUlJTE6MOqyoqH8BqgramuePvufREJcTGGgpzUvzpaGhVA4R6w4Z6uoJj5wOAdFPMfhEHpAQtWfvrs+bcfP37eA7JtsakhlA7uSklK6AHpp0D8Heqt/7AoBtEsRETjHXySTAwUAvobAIpOZMCCFOf/B8QLAAEGAN/jesiECqnKAAAAAElFTkSuQmCC);\n      background-repeat: no-repeat;\n      background-position: left center;\n      padding-left: 25px;\n      padding-top: 2px;\n      display: none; }\n  .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container {\n    height: 100%;\n    width: 100%;\n    position: relative; }\n    .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.horiz-style .sfly_wgt_spread_mg {\n      padding-top: 80px !important; }\n    .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.horiz-style .sfly_wgt_product {\n      position: static !important;\n      top: auto !important;\n      left: auto !important;\n      width: auto !important; }\n    .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.photogifts_share_widget_style {\n      overflow: hidden; }\n      .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.photogifts_share_widget_style .sfly_wgt_product {\n        top: auto !important;\n        left: auto !important;\n        width: auto !important; }\n        .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.photogifts_share_widget_style .sfly_wgt_product canvas {\n          width: auto !important;\n          max-width: 100% !important; }\n        .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.photogifts_share_widget_style .sfly_wgt_product .sfly_wgt_product_price {\n          left: auto !important;\n          right: auto !important;\n          top: auto !important; }\n    .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.prints_share_widget_style {\n      overflow: hidden; }\n      .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.prints_share_widget_style .sfly_wgt_product {\n        top: auto !important;\n        left: auto !important;\n        width: 100% !important;\n        height: 290px !important; }\n        .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.prints_share_widget_style .sfly_wgt_product canvas {\n          width: auto !important;\n          max-width: 100% !important; }\n        .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.prints_share_widget_style .sfly_wgt_product .sfly_wgt_product_price {\n          left: auto !important;\n          right: auto !important;\n          top: auto !important; }\n    .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.photobook_share_widget_style {\n      overflow: hidden; }\n      .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.photobook_share_widget_style .sfly_wgt_spread_mg {\n        width: 100% !important; }\n      .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.photobook_share_widget_style .sfly_wgt_product {\n        top: auto !important;\n        left: auto !important;\n        width: 100% !important;\n        height: 290px !important; }\n        .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.photobook_share_widget_style .sfly_wgt_product canvas {\n          width: auto !important;\n          max-width: 100% !important; }\n        .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.photobook_share_widget_style .sfly_wgt_product .sfly_wgt_product_price {\n          left: auto !important;\n          right: auto !important;\n          top: auto !important; }\n        .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.photobook_share_widget_style .sfly_wgt_product .sfly-wgt-tl-create-photobook {\n          position: relative !important;\n          top: 0 !important;\n          right: auto !important; }\n    .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_listview_scroll_arrows {\n      z-index: 10;\n      position: absolute;\n      top: 0;\n      width: 100%; }\n      .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_listview_scroll_arrows .sfly_wgt_listview_scroll_arrow {\n        position: absolute;\n        top: 95px;\n        width: 35px;\n        height: 100px;\n        background-color: #fff;\n        opacity: 0.9;\n        filter: alpha(opacity=90);\n        cursor: pointer; }\n        .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_listview_scroll_arrows .sfly_wgt_listview_scroll_arrow.sfly_wgt_arrow_disabled {\n          opacity: 0.2;\n          filter: alpha(opacity=20); }\n        .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_listview_scroll_arrows .sfly_wgt_listview_scroll_arrow:not(.sfly_wgt_arrow_disabled):hover {\n          opacity: 1;\n          filter: alpha(opacity=100); }\n        .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_listview_scroll_arrows .sfly_wgt_listview_scroll_arrow.sfly_wgt_listview_scroll_left_arrow {\n          left: 0;\n          border-radius: 0px 5px 5px 0px;\n          background-image: url(\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABUAAAAaCAYAAABYQRdDAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyRpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoTWFjaW50b3NoKSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDo5MTU0MTVGRTE4RTcxMUU1OUVBMEE0MTBENzg2NTA2QiIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDo5MTU0MTVGRjE4RTcxMUU1OUVBMEE0MTBENzg2NTA2QiI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOjkxNTQxNUZDMThFNzExRTU5RUEwQTQxMEQ3ODY1MDZCIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjkxNTQxNUZEMThFNzExRTU5RUEwQTQxMEQ3ODY1MDZCIi8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+pypwAwAAAYBJREFUeNpi/P//PwO1AQuIaG9vJ0atOhAfA2IhLHITKisrC2EcJiItFwHirTgM3AjEJcgCxBjKAcSbgFgZi9xZII4G4r+kGMoIxAuB2BKL3CMg9gHir+gShAxtA+IwLOIfoQa+wKYJn6EpQFyBRfw31KLLuDTiMtQNiKfhkMsC4l34vIfNUB0gXgXErFjkOoB4DqGYRTdUApp0+LGoXQ3EVcSkP2RDuYF4CxDLYVF3HIjjgPg/KYYyA/FSIDbGouYuEPsB8Q9isynM0B4g9sci/w6IvYH4DSl5n5gcxUhqgQIzFJR3N2CRF4KGsyg5hoLybgwQn8GiRhlaaHCQ431QHvaF5ml0AMr7i4gNCvQwfQGNmI9Y1IaCil5yI+oK1IDfWOTKoWUCWbG/G5rHsYHp0LKBrCQ1B4d3WaBlgy656bQaagA64IcmNQlyDAXl9Xho3kcHclCDucnJUT+gef8uFjlQWbEMWnaQZCgDNO97QcsCdACysBclX9OiMQEQYABaI0UvOl+8HAAAAABJRU5ErkJggg==\");\n          background-repeat: no-repeat;\n          background-position: center;\n          -webkit-box-shadow: 1px 1px 3px 0px #ababab;\n          -moz-box-shadow: 1px 1px 3px 0px #ababab;\n          box-shadow: 1px 1px 3px 0px #ababab; }\n        .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_listview_scroll_arrows .sfly_wgt_listview_scroll_arrow.sfly_wgt_listview_scroll_right_arrow {\n          right: 0;\n          border-radius: 5px 0px 0px 5px;\n          background-image: url(\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABUAAAAaCAYAAABYQRdDAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyRpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoTWFjaW50b3NoKSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDo2RDAxOTM3RDE4RTcxMUU1OUVBMEE0MTBENzg2NTA2QiIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDo2RDAxOTM3RTE4RTcxMUU1OUVBMEE0MTBENzg2NTA2QiI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOjZEMDE5MzdCMThFNzExRTU5RUEwQTQxMEQ3ODY1MDZCIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjZEMDE5MzdDMThFNzExRTU5RUEwQTQxMEQ3ODY1MDZCIi8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+SFYyUwAAAXxJREFUeNq0lr9LQlEUx59ZIDgE4tDk4lpTLf0BthTVUkNBLS25NNTQc6+n4NDU1FLUklM/h/6BJqeaghanwBAahMDi9T1whLh8w3cu9oUP4j2X79N7z/doKo7jYNga/f0miqIjvOyQfR0wC14GGYZhGIw4a7vgmuzNgXuQT/JJXdNvsAaaZG9RH5ixmoq6YAG0SE2O4BSkrKaiNzX+ILVVcOBjKnpSgy92H2DLx1T0ALb/qB2Dko+p6ATUyPoYaIBJH9P+122Q9XFwByZ8TCV2G+CR1ArgBmStpqJPsAReSW0GnIO01VTU1lbrkNoyqPuY9o8i8O1TprxeTI7UrsCe1TSj2S+SmsyKdZ0diU0l62eafVctPeeu9esfghWyLrNhXmeF6Uwl4/tkvaez4dl6UXOacaayzgbT7U+BS824q6rOBFNLSZZvNduu5EEVa59m1bBAapL9zUEBcE0luxdgmuyVzC/qDDAlqq5Dg/1ES+u8J2rq//gz8SPAAOy5Ry+WVVC7AAAAAElFTkSuQmCC\");\n          background-repeat: no-repeat;\n          background-position: center;\n          -webkit-box-shadow: -1px 1px 3px 0px #ababab;\n          -moz-box-shadow: -1px 1px 3px 0px #ababab;\n          box-shadow: -1px 1px 3px 0px #ababab; }\n    .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_listview_spread_container {\n      width: 100%;\n      height: 100%;\n      overflow: hidden; }\n    .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_listview_spread_0 {\n      left: 0; }\n    .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_spread_mg {\n      transform: translateX(0px) translateZ(0px);\n      -webkit-transform: translateX(0px) translateZ(0px);\n      transition: all 0ms;\n      -webkit-transition: all 0ms;\n      position: relative;\n      overflow: hidden; }\n    .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_gifting {\n      text-align: center;\n      overflow-y: scroll;\n      -webkit-overflow-scrolling: touch; }\n      .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_gifting .sfly_wgt_spread_mg {\n        transform: none;\n        transition: inherit;\n        height: auto; }\n      .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_gifting .sfly_wgt_product {\n        width: 270px;\n        height: 300px;\n        margin-top: 20px;\n        margin-bottom: 20px;\n        box-sizing: border-box;\n        overflow: hidden;\n        float: none;\n        display: inline-block; }\n        @media only screen and (min-width: 320px) {\n          .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_gifting .sfly_wgt_product {\n            border-bottom: 1px solid #F5F5F5;\n            border-left: 1px solid #f5f5f5;\n            width: 50%;\n            margin: 0;\n            height: 190px; }\n            .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_gifting .sfly_wgt_product.sfly_wgt_product_placeholder {\n              background-color: #f5f5f5; } }\n        @media only screen and (min-width: 992px) {\n          .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_gifting .sfly_wgt_product {\n            margin-top: 20px;\n            margin-bottom: 20px;\n            width: 270px;\n            height: 300px;\n            border: 1px solid #ffffff; }\n            .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_gifting .sfly_wgt_product:hover {\n              border: 1px solid #b9c4ce;\n              -webkit-border-radius: 5px;\n              -moz-border-radius: 5px;\n              -ms-border-radius: 5px;\n              border-radius: 5px;\n              background-color: #fafafa; }\n            .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_gifting .sfly_wgt_product .sfly_wgt_product_hover_tl {\n              position: absolute;\n              bottom: 10px;\n              left: 65px; }\n            .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_gifting .sfly_wgt_product.sfly_wgt_product_placeholder {\n              width: 250px;\n              height: 280px;\n              margin: 10px;\n              background-color: #f5f5f5;\n              -webkit-border-radius: 5px;\n              -moz-border-radius: 5px;\n              -ms-border-radius: 5px;\n              border-radius: 5px; } }\n      .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_gifting .sfly_wgt_listview_scroll_arrows {\n        display: none; }\n      .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_gifting .sfly-wgt-listview-scrollbar-vertical {\n        right: 2px; }\n      .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_gifting .sfly_wgt_product_price {\n        width: 100%;\n        text-align: center; }\n    .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert {\n      text-align: center;\n      -webkit-overflow-scrolling: touch; }\n      .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_restriction {\n        position: absolute;\n        display: none;\n        top: 0px;\n        left: 0px;\n        width: 100%;\n        height: 100%;\n        background-color: rgba(255, 255, 255, 0.8);\n        z-index: 1000; }\n        .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_restriction .sfly_wgt_popup {\n          position: relative;\n          margin: 0 auto;\n          top: 50%;\n          margin-top: -40px;\n          width: 400px;\n          height: 80px;\n          display: block;\n          border: 1px solid #666666;\n          border-radius: 5px;\n          background-color: #ffffff;\n          -webkit-box-shadow: 0px 2px 6px 0px rgba(102, 102, 102, 0.75);\n          -moz-box-shadow: 0px 2px 6px 0px rgba(102, 102, 102, 0.75);\n          box-shadow: 0px 2px 6px 0px rgba(102, 102, 102, 0.75); }\n          .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_restriction .sfly_wgt_popup .sfly_wgt_bubble_warning {\n            display: inline-block;\n            width: 28px;\n            float: left;\n            height: 28px;\n            background-image: url(\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABwAAAAcCAYAAAByDd+UAAAAAXNSR0IArs4c6QAAAjZJREFUSA2tlj1vE0EQht85IztYFiGIrw6KABJC0NBDARQoQSBBBKJA/AOoqSkRH78gVEgJEhKg1FDR0EALbahAFLESAtjLvLeczx+3e7OGsbw7dzPzPrdz5z0LEs2tXJuHbN+Hcx3s7NySxWdfUyQkJTmHYfsTIH1f5zKgcVaWXry16miBzdzKlTO6sg8+myB+1aS3lsd8oHY0rdDDemtwaFcqCjbhGhctK60F1sKKKzBCoy2thM3sAc49AC48Adr7Cpx2WFdvaG8QWAmj/ImbwNw8MHsIOH69BNIzQCuBQRhFW7McvTU7hVfONdAJYBRWynqv0Rw/448j0BFgEozSISBjAegAmAyjaLaDY9gqoDlwKhgx0gjDisgYNHPPL50G+q+DP+qi8F9mQpVBVgYnd6aGub9bqu1i2ujLXQVC9DOd9X/Z65ymCjfgzD1Ud9NeOZTZSwBy6xP3KJOrL9/r47agdBv050ZJ/PG99GNerp0tkDVopvlJ7RwETt5WeS39uAx0v8RQTBt5kwyArDJD44gyOgZjYATIE/8NWgGj/mCn4QEtf4nqyzR4T9nS84+BxWVg/6m8ZmIIwJg3AeTJKPToZWD3YWBmDjim/rhFYEytBDIQhG6sM+xt61vh+bkGxqSJeziqELinB7SVzV3A+jvdsX6bYSYgk2ofJMPK/FUZVlgkBqEJMGrVtrQAcs6h6L3RsqE/wq0jsrT6eTgv5icBKeRe3diLre5TiHThWvdSYKz/AxVPCVFqnNnuAAAAAElFTkSuQmCC\");\n            margin-left: 40px;\n            margin-top: 25px; }\n          .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_restriction .sfly_wgt_popup .sfly_wgt_bubble_text {\n            font-weight: 500;\n            font-size: 13px;\n            color: #58595b;\n            font-family: \"Avenir LT\", Verdana, Arial, sans-serif;\n            float: left;\n            width: 300px;\n            text-align: left;\n            margin-left: 13px;\n            margin-top: 23px; }\n      .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_loading {\n        position: relative;\n        height: 458px;\n        margin: 0;\n        left: 0px; }\n        @media only screen and (min-width: 320px) {\n          .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_loading {\n            z-index: 10;\n            position: absolute;\n            height: 100%;\n            top: 0; } }\n        @media only screen and (min-width: 768px) {\n          .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_loading {\n            position: relative; } }\n        @media only screen and (min-width: 992px) {\n          .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_loading {\n            top: 0px;\n            z-index: 5; } }\n        .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_loading.sml_loader {\n          height: 314px; }\n        .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_loading.mobile {\n          height: 452px; }\n        .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_loading:after {\n          left: calc(50% - 50px);\n          top: calc(50% - 50px); }\n      .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_listview_embedded_title {\n        position: relative;\n        padding: 12px 0 8px 0;\n        width: 840px;\n        display: inline-block; }\n        @media only screen and (min-width: 320px) {\n          .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_listview_embedded_title {\n            width: 100%; } }\n        @media only screen and (min-width: 768px) {\n          .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_listview_embedded_title.mobile {\n            width: 566px; } }\n        .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_listview_embedded_title.pg_share {\n          background-color: transparent;\n          padding: 5px 0; }\n        .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_listview_embedded_title .sfly_wgt_special_offers {\n          display: inline-block;\n          line-height: 32px;\n          text-align: center;\n          margin: 0 auto;\n          background-color: #f8f8f8; }\n          @media only screen and (min-width: 320px) {\n            .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_listview_embedded_title .sfly_wgt_special_offers {\n              width: 100%; }\n              .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_listview_embedded_title .sfly_wgt_special_offers a {\n                margin: 0; } }\n          @media only screen and (min-width: 992px) {\n            .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_listview_embedded_title .sfly_wgt_special_offers {\n              width: auto; }\n              .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_listview_embedded_title .sfly_wgt_special_offers a {\n                -webkit-touch-callout: text;\n                -webkit-user-select: text;\n                -khtml-user-select: text;\n                -moz-user-select: text;\n                -ms-user-select: text;\n                -o-user-select: text;\n                user-select: text;\n                margin: 0 65px; } }\n          .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_listview_embedded_title .sfly_wgt_special_offers:before, .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_listview_embedded_title .sfly_wgt_special_offers:after {\n            content: \'\';\n            display: block;\n            position: absolute;\n            top: 50%;\n            margin-top: -17px;\n            width: 0;\n            height: 0;\n            border-top: 17px solid transparent;\n            border-bottom: 17px solid transparent; }\n          .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_listview_embedded_title .sfly_wgt_special_offers:before {\n            border-right: 17px solid transparent;\n            border-left: 17px solid #ffffff; }\n          .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_listview_embedded_title .sfly_wgt_special_offers:after {\n            left: 100%;\n            margin-left: -34px;\n            border-right: 17px solid #ffffff;\n            border-left: 17px solid transparent; }\n      .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_spread_mg {\n        transform: none;\n        transition: inherit;\n        position: relative;\n        display: block;\n        max-height: 100%;\n        overflow: auto; }\n        @media only screen and (min-width: 768px) {\n          .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_spread_mg {\n            display: inline-block; } }\n        @media only screen and (min-width: 992px) {\n          .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_spread_mg.pbook_cal .sfly_wgt_product {\n            width: 278px;\n            text-align: -webkit-center; } }\n        .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_spread_mg.pbook_cal .sfly_wgt_product .sfly_wgt_product_inner {\n          height: 65%;\n          margin-top: 30px; }\n        .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_spread_mg .sfly_wgt_spread_mg_footer {\n          position: absolute;\n          bottom: 16px;\n          left: 211px;\n          font-family: \"avenir-roman\", \"Avenir LT W01 35 Light\",Verdana,Arial,sans-serif;\n          font-size: 12px;\n          color: #929497;\n          width: 463px;\n          height: 9px;\n          white-space: nowrap; }\n        .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_spread_mg .sfly_wgt_product_category {\n          text-align: left;\n          color: #000;\n          font-weight: 900;\n          border-bottom: solid 1px #dddfe1;\n          width: 100%;\n          clear: both; }\n          .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_spread_mg .sfly_wgt_product_category span {\n            padding: 10px;\n            padding-left: 30px;\n            display: inline-block; }\n      .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_listview_spread_container {\n        position: relative;\n        overflow-y: auto; }\n        .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_listview_spread_container.pg_share {\n          max-height: 250px;\n          overflow-y: hidden; }\n          .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_listview_spread_container.pg_share.scroll {\n            overflow-y: auto; }\n          .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_listview_spread_container.pg_share .sfly_wgt_spread_mg {\n            display: table;\n            margin: 0 auto;\n            border-top: 4px solid transparent;\n            border-left: 4px solid transparent;\n            overflow: hidden; }\n            .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_listview_spread_container.pg_share .sfly_wgt_spread_mg .sfly_wgt_product {\n              border-bottom: 4px solid transparent;\n              border-right: 4px solid transparent; }\n              .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_listview_spread_container.pg_share .sfly_wgt_spread_mg .sfly_wgt_product:hover {\n                background-color: transparent; }\n      .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_gotostore {\n        position: relative;\n        height: 60px;\n        color: #336699;\n        opacity: 1; }\n        .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_gotostore span {\n          cursor: pointer;\n          position: relative;\n          line-height: 60px; }\n      .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_product {\n        width: 209px;\n        height: 247px;\n        box-sizing: border-box;\n        overflow: hidden;\n        float: left;\n        display: inline-block; }\n        @media only screen and (min-width: 768px) {\n          .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_product:not(.right) {\n            border-right: 1px solid #dddfe1; }\n            .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_product:not(.right):after {\n              content: \'\';\n              display: inline-block;\n              height: 90%;\n              float: right;\n              margin-top: 5%; }\n          .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_product:not(:first-child) {\n            border-right: 1px solid transparent; } }\n        @media only screen and (min-width: 992px) {\n          .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_product:not(.right) {\n            border-right: 1px solid #dddfe1; } }\n        .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_product .sfly_wgt_product_title h5 {\n          font-weight: 900;\n          font-size: 14px;\n          color: #2d3137;\n          font-family: \"Avenir LT\", Verdana, Arial, sans-serif; }\n        .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_product .sfly_wgt_product_price .price-wrapper {\n          font-weight: 500;\n          font-size: 12px;\n          color: #58595b;\n          font-family: \"Avenir LT\", Verdana, Arial, sans-serif; }\n        .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_product .sfly_wgt_product_hover_tl {\n          position: absolute;\n          bottom: 16px;\n          left: 50%;\n          margin-left: -70px; }\n          @media only screen and (min-width: 320px) {\n            .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_product .sfly_wgt_product_hover_tl {\n              top: 50%;\n              transform: translateY(-15px);\n              right: 30px; } }\n          @media only screen and (min-width: 640px) {\n            .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_product .sfly_wgt_product_hover_tl {\n              top: auto;\n              right: auto;\n              transform: none;\n              bottom: 16px;\n              left: 50%;\n              margin-left: -70px; } }\n        @media only screen and (min-width: 320px) {\n          .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_product {\n            width: 100%;\n            margin: 0;\n            height: 120px;\n            border-bottom: solid 1px #dddfe1; }\n            .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_product[data-ptype=\"prints\"] .sfly_wgt_product_title h5 {\n              color: #f05323; }\n            .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_product[data-ptype=\"prints\"] .sfly_wgt_product_price {\n              display: none; }\n            .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_product.sfly_wgt_product_placeholder {\n              background-color: #f5f5f5; }\n            .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_product .sfly_wgt_product_inner {\n              margin-left: 0px; }\n            .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_product .sfly_wgt_product_price {\n              bottom: auto;\n              width: auto;\n              margin-left: 180px; }\n              .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_product .sfly_wgt_product_price .price-sale-save, .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_product .sfly_wgt_product_price .sfly_wgt_product_price_coupon {\n                display: none; }\n            .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_product .sfly_wgt_product_title {\n              width: auto;\n              margin-left: 180px; }\n              .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_product .sfly_wgt_product_title h5 {\n                text-align: left;\n                font-size: 14px;\n                font-weight: 500; } }\n        @media only screen and (min-width: 640px) {\n          .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_product {\n            width: 278px;\n            height: 247px;\n            border-bottom: none; }\n            .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_product.sfly_wgt_product_placeholder {\n              width: 278px;\n              height: 247px;\n              background-color: #f5f5f5; }\n            .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_product .sfly_wgt_product_price .price-sale-save {\n              display: inline; }\n            .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_product .sfly_wgt_product_price .sfly_wgt_product_price_coupon {\n              display: block; }\n            .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_product .sfly_wgt_product_title h5 {\n              text-align: center;\n              font-size: 16px; } }\n        @media only screen and (min-width: 768px) {\n          .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_product {\n            width: 250px; } }\n        @media only screen and (min-width: 992px) {\n          .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_product {\n            width: 278px; } }\n      .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_listview_scroll_arrows {\n        display: none; }\n      .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly-wgt-listview-scrollbar-vertical {\n        right: 2px; }\n      .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_product_price {\n        width: 100%;\n        text-align: center; }\n      .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_textual_wrapper {\n        display: inline-block;\n        margin-top: 20px;\n        margin-bottom: 20px;\n        font-family: \"Avenir LT\", Verdana, Arial, sans-serif; }\n        .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_textual_wrapper .sfly_wgt_textual_area {\n          height: auto;\n          display: inline-block;\n          width: 270px;\n          text-align: left;\n          margin-left: 15px;\n          margin-bottom: 20px; }\n          .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_textual_wrapper .sfly_wgt_textual_area h5.sfly_wgt_textual_title {\n            font-size: 14px;\n            font-weight: 900;\n            margin-bottom: 6px;\n            color: #2d3137; }\n          .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_textual_wrapper .sfly_wgt_textual_area .sfly_wgt_textual_area_menu.floatLeft {\n            float: left; }\n          .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_textual_wrapper .sfly_wgt_textual_area .sfly_wgt_textual_area_menu ul {\n            width: 50%;\n            float: left;\n            color: #58595b;\n            font-weight: 500; }\n            .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_textual_wrapper .sfly_wgt_textual_area .sfly_wgt_textual_area_menu ul li {\n              font-size: 12px;\n              line-height: 20px;\n              cursor: pointer;\n              padding: 0; }\n              .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_textual_wrapper .sfly_wgt_textual_area .sfly_wgt_textual_area_menu ul li:hover, .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_textual_wrapper .sfly_wgt_textual_area .sfly_wgt_textual_area_menu ul li.hover {\n                color: #f05323; }\n          .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_textual_wrapper .sfly_wgt_textual_area .sfly_wgt_textual_order_prints {\n            text-align: center;\n            margin-top: 10px;\n            margin-bottom: 15px;\n            float: left;\n            font-size: 12px;\n            font-weight: 300; }\n            .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_textual_wrapper .sfly_wgt_textual_area .sfly_wgt_textual_order_prints.sfly-wgt-white-btn-sfly {\n              line-height: 20px; }\n          .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_textual_wrapper .sfly_wgt_textual_area .sfly_wgt_textual_order_prints_info {\n            float: left;\n            font-family: \"Avenir LT\", Verdana, Arial, sans-serif;\n            font-weight: 100;\n            font-size: 12px; }\n          .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_textual_wrapper .sfly_wgt_textual_area .sfly_wgt_textual_product_placeholder {\n            width: 130px;\n            height: 130px;\n            float: right;\n            margin-top: -23px;\n            margin-right: 5px;\n            cursor: pointer; }\n            .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_textual_wrapper .sfly_wgt_textual_area .sfly_wgt_textual_product_placeholder .sfly_wgt_product {\n              border: none;\n              height: 100%;\n              width: 100%;\n              display: none;\n              cursor: pointer; }\n              .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_textual_wrapper .sfly_wgt_textual_area .sfly_wgt_textual_product_placeholder .sfly_wgt_product:hover {\n                background-color: transparent; }\n              .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_textual_wrapper .sfly_wgt_textual_area .sfly_wgt_textual_product_placeholder .sfly_wgt_product:after {\n                border: none; }\n              .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_textual_wrapper .sfly_wgt_textual_area .sfly_wgt_textual_product_placeholder .sfly_wgt_product .sfly_wgt_product_inner {\n                display: block;\n                height: 100%;\n                width: 100%;\n                position: absolute;\n                bottom: 0px;\n                left: 0px;\n                overflow: hidden; }\n        @media only screen and (min-width: 768px) {\n          .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_textual_wrapper .sfly_wgt_textual_area {\n            margin-bottom: 30px;\n            border-right: 1px solid #dddfe1; }\n            .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_textual_wrapper .sfly_wgt_textual_area:not(:first-child) {\n              border: none; }\n            .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_textual_wrapper .sfly_wgt_textual_area.right {\n              margin-bottom: 0px; } }\n        @media only screen and (min-width: 992px) {\n          .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_textual_wrapper .sfly_wgt_textual_area {\n            margin-bottom: 20px; }\n            .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_textual_wrapper .sfly_wgt_textual_area:not(:first-child) {\n              border-right: 1px solid #dddfe1; }\n            .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_tlVert .sfly_wgt_textual_wrapper .sfly_wgt_textual_area.right {\n              border-right: none; } }\n    .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_product {\n      float: left;\n      z-index: 5;\n      height: 155px;\n      position: relative !important;\n      left: 0 !important;\n      top: 0 !important;\n      width: 100%; }\n      .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_product:hover {\n        cursor: pointer; }\n      .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_product .sfly_wgt_product_inner {\n        height: 70%;\n        display: flex;\n        justify-content: center;\n        position: relative !important; }\n        .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_product .sfly_wgt_product_inner canvas {\n          position: absolute;\n          width: auto;\n          height: auto; }\n      .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_product .sfly_wgt_product_price_mg h5 {\n        font-family: \"Avenir LT W01 35 Light\", \"Avenir LT\", Verdana, Arial, sans-serif;\n        color: #7f7f7f;\n        font-size: 13px;\n        text-align: center;\n        display: inline-block;\n        width: 180px; }\n      .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_product .sfly_wgt_product_price, .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_product .sfly_wgt_product_price_nav {\n        text-align: center;\n        color: #181512;\n        font-size: 12px;\n        font-weight: 300;\n        /*width: 100%;*/\n        position: relative;\n        width: 100%;\n        /*border: 1px solid red;*/ }\n        .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_product .sfly_wgt_product_price h5, .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_product .sfly_wgt_product_price span, .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_product .sfly_wgt_product_price_nav h5, .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_product .sfly_wgt_product_price_nav span {\n          margin: 0;\n          padding: 0;\n          font-family: \"Avenir LT\", Verdana, Arial, sans-serif; }\n        .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_product .sfly_wgt_product_price h5, .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_product .sfly_wgt_product_price_nav h5 {\n          font-weight: 600; }\n        .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_product .sfly_wgt_product_price span, .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_product .sfly_wgt_product_price_nav span {\n          font-weight: 300;\n          font-size: 11px;\n          font-family: \"Avenir LT W01\", \"Avenir LT\", Verdana, Arial, sans-serif; }\n          .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_product .sfly_wgt_product_price span.price-old, .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_product .sfly_wgt_product_price_nav span.price-old {\n            text-decoration: line-through; }\n          .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_product .sfly_wgt_product_price span.price-sale, .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_product .sfly_wgt_product_price_nav span.price-sale {\n            color: #C11111; }\n          .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_product .sfly_wgt_product_price span.price-wrapper, .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_product .sfly_wgt_product_price_nav span.price-wrapper {\n            line-height: 16px; }\n        .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_product .sfly_wgt_product_price.sfly_wgt_on_zoomout, .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_product .sfly_wgt_product_price_nav.sfly_wgt_on_zoomout {\n          font-size: 9px;\n          color: #666666; }\n        .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_product .sfly_wgt_product_price .sfly_wgt_product_price_coupon, .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_product .sfly_wgt_product_price_nav .sfly_wgt_product_price_coupon {\n          font-weight: 300;\n          font-size: 10px;\n          font-family: \"Avenir LT W01 55 Roman\", \"Avenir LT\", Verdana, Arial, sans-serif;\n          color: #C11111; }\n      .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_product .sfly_wgt_product_price_nav h5 {\n        display: inline-block; }\n      .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_product .sfly_wgt_product_hover {\n        display: none;\n        position: absolute;\n        background-color: #f2f2f2;\n        border-radius: 5px;\n        border: 1px solid #666666;\n        white-space: nowrap;\n        font-size: 13px;\n        width: 116px;\n        height: 30px;\n        line-height: 30px;\n        /*\n        &:hover{\n          background-color: $medium-gray;\n        }\n        */ }\n        .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_product .sfly_wgt_product_hover .sfly_wgt_search {\n          width: 20px;\n          height: 20px;\n          background: url(\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAIGNIUk0AAHolAACAgwAA+f8AAIDpAAB1MAAA6mAAADqYAAAXb5JfxUYAAARRSURBVHja1NlriNRVGMfxz6YVru1WlNrFSsxrViR2gSzL1W5IN0u6kEpQUEKI7wyFiiwKjIrKCCol6UUgRRe6WLgY3STUzEyyJERFa81cSyyt7MU8A8Ppvzvzn2Z21h/Mi3nOf+Z/vuc85znneU7TlKl3qFKD0YZLMRLD0B+t2IPf8T02YiVWYJcaq2/O54/CdMyIjjd18dxx8RmMiZiFg1iOF/AODtUC4Igcz92DzXgRE7rpfFc6ElPwFlZjUk8BnI1VeD5GtBYaiw+xBMfUE2B6dP78jLb9eBP34RKchOZwsxMxDjOxuAvfb4r2LzGiWoCmbhbxPDyc4SrbsDBGrzOH+1yPuQGW6idchXW1moG5WJB0/iAeitF6Okfni79dhgti1DuS9kHhUsNqATATjya27bFwHwzXqVaH8Eqsgc+StgF4Fy3/B2AMFiUjvxHj8UUNw/d2TI6IVKrheLZagD7h182Jv1+JLWqv/ZgWG1ypZsQ7cwPcnUSbA5gaEPXSAdyCrYn9yUr3qOJD/cK/S/V4hLh6axfuSmxn4aY8ALdHJChqa8ZCrqeW443ENjsPwJ2JfSH+0LNakHy/GEMrATgtHi5dXEv0vNbErl+6U99YCcCkJGy+j70ao9eS75dXAjA+sa3QOKXvvrASgNGJbW0DATbEsaOogZFXdAswJLFtbiDAXxmb5unlAFoTW6fGKl1/reUAWjIOXI1U+v6WcgCdeX7QA0rf/1s5gF8T27AGdr5Pxpr8uxxAumjPbSDAyEhJS9VRDmBDYmtrIEBbF7lDtwDtie2aKFA1QtOS7z+WywCLAH8mi+jWBnR+tEKxrFSrK9mJO6M8Uqr7o5LQk5qfUQH5oNLj9KLEfibm9GDnx+O2jJTz9UoBVuLjpO2ByIzqrVa8nDH6S7E7T048J84iRTWHaw2oc9xf6r+VuX0ZCU5ZgDV4ImNTe69OEH1j5K/LaJuXkehXVBean+FK4/CpQpG3VjoBb0cJJdUneKaaskrxOHszvknswyPdmy3/nUKqKTHbV3fR3h/HVwtQ3LqvwPrE3oyn8LVC1froHJ1uil12ucLlRndn/LH4SKHCXf6Pu6lOt+BVXNtF++4ohbTH7GwpyaaacCrOi7z2hgjNebQuBrKjWoBiR2bhMZVdROwLNzw2R0e3RwknC3B9FB068rhQmlw8F2HupSRf7cp/K+38XoXi2Rhchk0Zz5wTMzywWoCidiiU/4bikThkVaN/8LnCrc6QCJedMQsT8V3Gb8YExKBqXEiZxTYBF0WUOiPcrF+M7p74bMJX4dOryvj0yVFaGZXRtjECwc50M6lWa+tQgtkRM7Eio9wzOmaiLZ7L5UI9qZ0B8W1G26iAOKU3A1C49JuYkS0W0872CNO9FgB+Doj1GW0jAmJwbwYongomyb5+HY7FvR2gCDE5IlmptuHewwGAwjXU5JKo1xGHwR8OFwD4JSDao/Mb4N8BAAoy33YRQBHCAAAAAElFTkSuQmCC\") no-repeat;\n          display: inline-block;\n          background-size: cover;\n          position: relative;\n          left: 8px;\n          top: -1px;\n          margin-right: 8px;\n          vertical-align: middle; }\n        .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_product .sfly_wgt_product_hover.sfly_wgt_product_hover_tl {\n          display: none;\n          background-color: #f15d1b;\n          border: 1px solid #bc5119;\n          border-radius: 6px;\n          text-shadow: 1px 0px 1px #a30045;\n          color: #fff;\n          background-image: -webkit-linear-gradient(top, #e94d0f, #f57c3a);\n          /* For Chrome 25 and Safari 6, iOS 6.1, Android 4.3 */\n          background-image: -moz-linear-gradient(top, #e94d0f, #f57c3a);\n          /* For Firefox (3.6 to 15) */\n          background-image: -o-linear-gradient(top, #e94d0f, #f57c3a);\n          /* For old Opera (11.1 to 12.0) */\n          background-image: linear-gradient(to top, #e94d0f, #f57c3a);\n          /* Standard syntax; must be last */\n          text-align: center;\n          width: 140px; }\n          .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_product .sfly_wgt_product_hover.sfly_wgt_product_hover_tl .sfly_wgt_search {\n            display: none; }\n          .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_product .sfly_wgt_product_hover.sfly_wgt_product_hover_tl:hover {\n            background-image: -webkit-linear-gradient(top, #f0591d, #f57c3a);\n            /* For Chrome 25 and Safari 6, iOS 6.1, Android 4.3 */\n            background-image: -moz-linear-gradient(top, #f0591d, #f57c3a);\n            /* For Firefox (3.6 to 15) */\n            background-image: -o-linear-gradient(top, #f0591d, #f57c3a);\n            /* For old Opera (11.1 to 12.0) */\n            background-image: linear-gradient(to top, #f0591d, #f57c3a);\n            /* Standard syntax; must be last */ }\n      .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_product:hover {\n        cursor: pointer;\n        z-index: 10; }\n        .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_product:hover .sfly_wgt_product_price_mg h5 {\n          color: #181512; }\n    .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_listview_embedded_title {\n      position: absolute;\n      top: -5px;\n      left: 0;\n      width: 100%;\n      z-index: 10;\n      -webkit-touch-callout: none;\n      -webkit-user-select: none;\n      -khtml-user-select: none;\n      -moz-user-select: none;\n      -ms-user-select: none;\n      -o-user-select: none;\n      user-select: none; }\n      .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_listview_embedded_title h5, .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_listview_embedded_title h6 {\n        font-family: \"Avenir LT W01 35 Light\", \"Avenir LT\", Verdana, Arial, sans-serif; }\n      .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_listview_embedded_title h5 {\n        color: #f05323;\n        font-size: 20px;\n        text-align: center;\n        margin-top: 5px;\n        font-weight: bold; }\n        .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_listview_embedded_title h5.sfly_wgt_listview_embedded_title_tl {\n          color: #333333;\n          font-size: 18px;\n          margin-top: 20px;\n          margin-left: 75px;\n          display: inline-block;\n          text-align: left;\n          font-weight: normal;\n          cursor: pointer; }\n        .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_listview_embedded_title h5.sfly_wgt_listview_embedded_caption {\n          color: #58595d;\n          margin-top: 5px;\n          font-size: 22px;\n          font-weight: normal;\n          font-family: \"Avenir LT W01 35 Light\", \"Avenir LT\", Verdana, Arial, sans-serif;\n          text-align: left; }\n      .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_listview_embedded_title .embedded_signout {\n        color: #58595d;\n        text-align: center;\n        margin-top: 5px;\n        font-size: 22px;\n        font-weight: normal;\n        font-family: \"Avenir LT W01 35 Light\", \"Avenir LT\", Verdana, Arial, sans-serif; }\n        .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_listview_embedded_title .embedded_signout a {\n          color: #58595b;\n          font-weight: bold;\n          margin-left: 8px;\n          font-size: 12px;\n          font-family: \"Avenir LT W01 85 Heavy\", \"Avenir LT\", Verdana, Arial, sans-serif; }\n          .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_listview_embedded_title .embedded_signout a:hover {\n            color: #f05323; }\n      .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_listview_embedded_title .sfly-wgt-title {\n        display: block;\n        position: absolute;\n        top: 15px;\n        left: 30px;\n        width: 162px;\n        height: 55px;\n        background-image: url(\"https://d22bbwxztp2lry.cloudfront.net/productswidget/Shutterfly/sidewidget/images/prod/title-text.png\");\n        background-repeat: no-repeat;\n        background-size: contain;\n        background-position: center; }\n        .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_listview_embedded_title .sfly-wgt-title.holiday {\n          display: block;\n          position: absolute;\n          top: 15px;\n          left: 90px;\n          width: 393px;\n          height: 53px;\n          background-image: url(\"https://d22bbwxztp2lry.cloudfront.net/productswidget/Shutterfly/sidewidget/images/prod/holiday-title-text.png\");\n          background-repeat: no-repeat;\n          background-size: contain;\n          background-position: center; }\n        .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_listview_embedded_title .sfly-wgt-title.valentine {\n          top: 7px;\n          left: 15px;\n          width: 381px;\n          height: 72px;\n          background-image: url(\"https://d22bbwxztp2lry.cloudfront.net/productswidget/Shutterfly/sidewidget/images/prod/valentine-title-text.png\"); }\n        .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_listview_embedded_title .sfly-wgt-title.president {\n          top: 20px;\n          left: 15px;\n          width: 237px;\n          height: 53px;\n          background-image: url(\"https://d22bbwxztp2lry.cloudfront.net/productswidget/Shutterfly/sidewidget/images/prod/president-title-text.png\"); }\n      .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_listview_embedded_title h6 {\n        margin-left: 30px;\n        color: #333333;\n        font-size: 12px;\n        text-transform: uppercase; }\n        .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_listview_embedded_title h6.sfly_wgt_listview_embedded_title_tl {\n          display: inline-block;\n          text-align: left;\n          cursor: pointer; }\n      .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_listview_embedded_title .sfly_wgt_listview_embedded_title_actions {\n        position: absolute;\n        font-family: Avenir, Verdana, Arial, sans-serif;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        width: 142px;\n        height: 36px;\n        margin: 0;\n        top: 25px;\n        right: 20px;\n        border-radius: 4px;\n        background-color: transparent;\n        font-size: 12px;\n        font-weight: 700;\n        text-transform: uppercase;\n        text-decoration: none;\n        color: #58595b;\n        border: 1px solid #c6c7c9;\n        cursor: pointer;\n        box-sizing: border-box;\n        /*\n        #sfly_wgt_upp_select_main {\n          margin: 10px;\n        }\n        */ }\n        .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_listview_embedded_title .sfly_wgt_listview_embedded_title_actions .sfly_wgt_upp_select_main {\n          width: 100%;\n          height: 100%;\n          display: flex;\n          align-items: center;\n          justify-content: center; }\n        .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_listview_embedded_title .sfly_wgt_listview_embedded_title_actions.holiday {\n          color: #bf2829;\n          border: 1px solid #bf2829;\n          right: 69px; }\n        .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_listview_embedded_title .sfly_wgt_listview_embedded_title_actions.valentine {\n          color: #58595b;\n          border: 1px solid #d81669;\n          right: 20px;\n          top: 30px;\n          width: 156px; }\n        .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_listview_embedded_title .sfly_wgt_listview_embedded_title_actions.president {\n          color: #58595b;\n          border: 1px solid #c6c7c9;\n          right: 40px;\n          background-color: rgba(255, 255, 255, 0.05);\n          width: 142px; }\n        .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_listview_embedded_title .sfly_wgt_listview_embedded_title_actions a {\n          color: #336699;\n          text-decoration: none;\n          display: inline-block;\n          margin-top: 2px;\n          float: right; }\n          .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_listview_embedded_title .sfly_wgt_listview_embedded_title_actions a:hover {\n            text-decoration: underline; }\n        .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_listview_embedded_title .sfly_wgt_listview_embedded_title_actions a.sfly_wgt_question {\n          background-image: url(\"data:image/jpg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QMtaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjMtYzAxMSA2Ni4xNDU2NjEsIDIwMTIvMDIvMDYtMTQ6NTY6MjcgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLyIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDUzYgKE1hY2ludG9zaCkiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6MjQ0MEEyQTBCNkIxMTFFNDlGMjlBRUJCNENEQzgzMUMiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6NDUxMjY3QUFCNzI2MTFFNDlGMjlBRUJCNENEQzgzMUMiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDoyNDQwQTI5RUI2QjExMUU0OUYyOUFFQkI0Q0RDODMxQyIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDoyNDQwQTI5RkI2QjExMUU0OUYyOUFFQkI0Q0RDODMxQyIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/Pv/uAA5BZG9iZQBkwAAAAAH/2wCEAAEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQECAgICAgICAgICAgMDAwMDAwMDAwMBAQEBAQEBAgEBAgICAQICAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDA//AABEIABMAKQMBEQACEQEDEQH/xACQAAACAgMAAAAAAAAAAAAAAAAICQYHBAUKAQEBAAMBAQAAAAAAAAAAAAAACAQFBgMHEAAABQIEBAQEBwAAAAAAAAACAwQFBgEHERITFAAVFhchIwgYQSJTJTFRJCY2JwkRAAEDAgQEBAYBBQAAAAAAAAIBAwQFBgAREhUhExYHMUEiFGFSIyQ1CHFTNCVVF//aAAwDAQACEQMRAD8A7Wnd+l8+RPEoblkxQwJC8GsMZZLchTES6ZqkrhVrUPqt8U0FVnj4XAAwh06grQkIhmVplpiwxGmaTS+L0lDq2rJ0qrb8bcpuFbq4bq3ydfRgck5qwt7isqSVEZrpkCc06pJhgyh0ALN40BSrDBSrpMxtsYWTJa4EkRpAwqJMrdR5tAljSt43U9wFSgaj0S0BdTK+GOWn4cY02ZGp8N2fMJAiMNE4ZL4CACpES/BBRVxm02nzKtUWKVTwV2oSngaaBPE3HCQAFPiRKiJ/OFfyB49QN5ohGLyPA/UQljFznT+m7E+ml7ZreurXEFKJS5MszvPdhxMKUIRyNnThUhLLUEok4ziCwYjNGEM0Tpd93fSY13S1r402pOfYU2kONxTBhRU25FQnGqKPNbRDREMWxUgFM1JUS0KXA7Xdvq9MsCAlqHWKMz/lazcDLs5tyUJi27EpNMbRRNGHSVtSJs3TQHTLIQFVwbU3wnlsGwq4p0uujMLHst2xWOvpBr8KmeQXVsHOjXBpaipK33DZQhBMoUS5vyEtUBRU4ZZCgAyRCMqbk8bYvOuW3GS4Dl1KXZjNV26pRqkTbs2mSVIAR4JTaZSI6G62hoepUEkUFUtWWTe/bi2bxmFabcCjQO48ihJWKNMowusU2tQ0B11Y5wXlVYktW2XibUNCEYELiIOjU2zipsQzgfbTuhLFFnW1jhUwmYQUL6jA1lm0SuD60GqVy5mfGOpgg1UFL0igAdQNaiKPpXPlxpiwxoD6MNvbWqW9I1udLi3JaeVBZntaJ2mkkkjgiOaSVDsMxQeISdBQ8RptQ1AlIBmoHKIWAmGLClttVMjsHJrPlLiyFj7aB5tqW5CqZQolS6QtTFwLhVDSptCyzT9StaUzYU/PjRXTSDr9s1GhNkgOTYEiOhL4CrzRtoq5ceClnjqLHr7dqXrR7pdBXGqbVIkogTLMkjvtvKKZ8MyQMuPDjgUoNc/uP6PZJb1oRzFvvdbW25Frp5bODOiaP3bi0vj7ekixy6OhUnE7ZOsERRe2rKCElOIFQFDKjCMNPkVFuTqHtNIoEUZYXlTqckOTEjGjU5l9oBZUms1TShZc1lxFUCFctSqhIlBXJZvSXfuHdU9ynu9uqvV1qMKoTGyfpkmK+ZSUB/Si6iFC5MhpURwDTUoIKiqwy+cXttH7JsXows2xBbrj3/eY4oc4pRyVyGTxltXvTFI7jXTuU5q1jg6529raxl1WKz9VQpoWBPQYCsgNPelMt2BZzHaC0WEbuCuvNKbOsnXmQJxt2XNlmREfpAFTWZajPSjaKgZJ0HbetXfVe4kn9hL/AJKvWla8d8W5PLFiPIcBl6PAptPbEQbyNxxC5TQaW29ZO6SPUTP+KSxGuBl9QXLdaO817U7TzMetOrOrc2uHDpfoz71t/qZfl1MuPw4YYjtjuS9ZruS9pdHZHanL+4HcjHTLw/n/AOu5Z9bS+XDLj8OGGC84YYUH65Oie9DH1r7StpyRJt+oPcD7kc+2Oz5vb/8Ae+mcMNpuvLyamXxx4lHvTs3WDG8dK8rkjlzd03fwX/V/U5Pya+GWrLzxeH639Rf8+k9O9c8/3JauRsmwZaky/N/R9x/V5fqz05+WLE/z46a3txelPahynycnZfu13d1N8Zm7o96P3psMMNDU8rc58vjjx0HYfbudUNr6X9rw/H++99nqX+83D7jT8ufDXqy88cp+027+2pO99b++9We7bZteWhPx20/aa/n0+rRpz8sM44o7EdY//9k=\");\n          height: 19px;\n          width: 19px;\n          background-position: 1px 0px;\n          margin-left: 10px;\n          margin-top: 0; }\n          .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_listview_embedded_title .sfly_wgt_listview_embedded_title_actions a.sfly_wgt_question:hover {\n            background-position: 19px 0px; }\n        .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_listview_embedded_title .sfly_wgt_listview_embedded_title_actions .sfly_wgt_divider {\n          width: 1px;\n          height: 21px;\n          background-color: #cdcdcd;\n          float: right;\n          margin-left: 10px; }\n      .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_listview_embedded_title div.sfly_wgt_special_offers {\n        position: relative;\n        margin-top: 20px;\n        margin-left: 22px;\n        font-size: 12px;\n        color: #939598;\n        font-family: \"Avenir LT W01 85 Heavy\", \"Avenir LT\", Verdana, Arial, sans-serif; }\n        .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_listview_embedded_title div.sfly_wgt_special_offers a span {\n          color: #f05323; }\n    .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_listview_embedded_title_background.holiday {\n      display: block;\n      position: absolute;\n      top: -5px;\n      left: 0;\n      width: 980px;\n      height: 110px;\n      background-image: url(\"https://d22bbwxztp2lry.cloudfront.net/productswidget/Shutterfly/sidewidget/images/prod/holiday-title-background-image-1line.jpg\");\n      background-repeat: no-repeat;\n      background-size: contain;\n      background-position: top; }\n    .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_loading {\n      width: 100%;\n      height: 100%;\n      position: absolute;\n      top: 50%;\n      left: 50%;\n      z-index: 1;\n      white-space: nowrap; }\n      .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_loading.sfly_wgt_throbber {\n        z-index: 5; }\n      .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_loading.sfly_wgt_starting_side {\n        top: 0;\n        left: 0; }\n      .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_loading .sfly_wgt_item_placeholder {\n        width: 105px;\n        height: 130px;\n        display: none;\n        margin: 30px auto 0;\n        -webkit-animation-name: blink;\n        animation-name: blink;\n        -webkit-animation-duration: 0.6s;\n        animation-duration: 0.6s;\n        -webkit-animation-iteration-count: infinite;\n        animation-iteration-count: infinite;\n        -webkit-animation-timing-function: ease-in-out;\n        animation-timing-function: ease-in-out;\n        -webkit-animation-direction: alternate;\n        animation-direction: alternate; }\n        .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_loading .sfly_wgt_item_placeholder:first-child {\n          margin-top: 45px; }\n        .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_loading .sfly_wgt_item_placeholder span {\n          display: block;\n          background-color: #eee;\n          width: 100%; }\n          .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_loading .sfly_wgt_item_placeholder span.sfly_wgt_item_placeholder_prod {\n            height: 70%;\n            width: 90px;\n            margin: 0 auto; }\n          .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_loading .sfly_wgt_item_placeholder span.sfly_wgt_item_placeholder_line {\n            height: 6%;\n            margin-top: 8px; }\n            .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_loading .sfly_wgt_item_placeholder span.sfly_wgt_item_placeholder_line:last-child {\n              width: 60px;\n              margin: 0 auto;\n              margin-top: 8px; }\n        .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_loading .sfly_wgt_item_placeholder.sfly_wgt_item_placeholder_horiz {\n          width: 195px;\n          height: 190px;\n          margin-right: 40px;\n          margin-top: 75px; }\n          .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_loading .sfly_wgt_item_placeholder.sfly_wgt_item_placeholder_horiz:first-child {\n            margin-top: 75px;\n            margin-left: 50px; }\n          .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly_wgt_loading .sfly_wgt_item_placeholder.sfly_wgt_item_placeholder_horiz span.sfly_wgt_item_placeholder_prod {\n            width: 150px; }\n    .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_gifting .sfly_wgt_loading {\n      position: fixed; }\n    .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container.sfly_wgt_gifting .sfly_wgt_throbber_overlay {\n      position: fixed; }\n    .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly-wgt-mg-static-filler {\n      background-color: #ffffff;\n      opacity: 0.5;\n      filter: alpha(opacity=50); }\n    .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly-wgt-overlay-message {\n      position: absolute;\n      z-index: 50;\n      background-color: #f05323;\n      top: 38%;\n      width: 200px;\n      left: -200px;\n      overflow: hidden;\n      padding: 10px; }\n      .sfly_wgt.sfly_wgt_listview.sfly_wgt_listview_container .sfly-wgt-overlay-message a {\n        color: #fff; }\n  .sfly_wgt.sfly_wgt_listview.sfly_wgt_product_container {\n    display: block;\n    border: 1px solid orange;\n    margin: 10px;\n    padding: 10px;\n    width: 100px;\n    height: 100px;\n    float: left; }\n    .sfly_wgt.sfly_wgt_listview.sfly_wgt_product_container:hover {\n      /*background-color: #EEE;*/\n      cursor: pointer; }\n\n.sfly-wgt-lv-arrow-left, .sfly-wgt-lv-arrow-right, .sfly-wgt-lv-arrow-up, .sfly-wgt-lv-arrow-down {\n  width: 26px;\n  height: 21px;\n  background-repeat: no-repeat;\n  position: absolute;\n  cursor: pointer;\n  z-index: 100; }\n  .sfly-wgt-lv-arrow-left:hover, .sfly-wgt-lv-arrow-right:hover, .sfly-wgt-lv-arrow-up:hover, .sfly-wgt-lv-arrow-down:hover {\n    opacity: 0.9;\n    filter: alpha(opacity=90); }\n\n.sfly-wgt-lv-arrow-left, .sfly-wgt-lv-arrow-right {\n  width: 21px;\n  height: 26px; }\n\n.sfly-wgt-lv-arrow-left, .sfly-wgt-lv-arrow-right {\n  top: 134px; }\n\n.sfly-wgt-lv-arrow-up, .sfly-wgt-lv-arrow-down {\n  left: 76px; }\n\n.sfly-wgt-lv-arrow-left {\n  left: 15px;\n  background-image: url(\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABUAAAAaCAYAAABYQRdDAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyRpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoTWFjaW50b3NoKSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDo5MTU0MTVGRTE4RTcxMUU1OUVBMEE0MTBENzg2NTA2QiIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDo5MTU0MTVGRjE4RTcxMUU1OUVBMEE0MTBENzg2NTA2QiI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOjkxNTQxNUZDMThFNzExRTU5RUEwQTQxMEQ3ODY1MDZCIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjkxNTQxNUZEMThFNzExRTU5RUEwQTQxMEQ3ODY1MDZCIi8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+pypwAwAAAYBJREFUeNpi/P//PwO1AQuIaG9vJ0atOhAfA2IhLHITKisrC2EcJiItFwHirTgM3AjEJcgCxBjKAcSbgFgZi9xZII4G4r+kGMoIxAuB2BKL3CMg9gHir+gShAxtA+IwLOIfoQa+wKYJn6EpQFyBRfw31KLLuDTiMtQNiKfhkMsC4l34vIfNUB0gXgXErFjkOoB4DqGYRTdUApp0+LGoXQ3EVcSkP2RDuYF4CxDLYVF3HIjjgPg/KYYyA/FSIDbGouYuEPsB8Q9isynM0B4g9sci/w6IvYH4DSl5n5gcxUhqgQIzFJR3N2CRF4KGsyg5hoLybgwQn8GiRhlaaHCQ431QHvaF5ml0AMr7i4gNCvQwfQGNmI9Y1IaCil5yI+oK1IDfWOTKoWUCWbG/G5rHsYHp0LKBrCQ1B4d3WaBlgy656bQaagA64IcmNQlyDAXl9Xho3kcHclCDucnJUT+gef8uFjlQWbEMWnaQZCgDNO97QcsCdACysBclX9OiMQEQYABaI0UvOl+8HAAAAABJRU5ErkJggg==\"); }\n  .sfly-wgt-lv-arrow-left:hover {\n    background-image: url(\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABUAAAAaCAYAAABYQRdDAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyRpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoTWFjaW50b3NoKSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDo5MTU0MTYwMjE4RTcxMUU1OUVBMEE0MTBENzg2NTA2QiIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDo5MTU0MTYwMzE4RTcxMUU1OUVBMEE0MTBENzg2NTA2QiI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOjkxNTQxNjAwMThFNzExRTU5RUEwQTQxMEQ3ODY1MDZCIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjkxNTQxNjAxMThFNzExRTU5RUEwQTQxMEQ3ODY1MDZCIi8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+QX4AuwAAAYFJREFUeNpi/P//PwO1AQuI+BIsQIxadSA+BsRCWOQm8Kz9UAjjMBFpuQgQb8Vh4EYgLkEWIMZQDiDeBMTKWOTOAnE0EP8lxVBGIF4IxJZY5B4BsQ8Qf0WXIGRoGxCHYRH/CDXwBTZN+AxNAeIKLOK/oRZdxqURl6FuQDwNh1wWEO/C5z1shuoA8SogZsUi1wHEcwjFLLqhEtCkw49F7WogriIm/SEbyg3EW4BYDou640AcB8T/STGUGYiXArExFjV3gdgPiH8Qm01hhvYAsT8W+XdA7A3Eb0jJ+8TkKEZSCxSYoaC8uwGLvBA0nEXJMRSUd2OA+AwWNcrQQoODHO+D8rAvNE+jA1DeX0RsUKCH6QtoxHzEojYUiNvJjagrUAN+Y5Erh5YJZMX+bmgexwamQ8sGspLUHBzeZYGWDbrkptNqqAHogB+a1CTIMRSU1+OheR8dyEEN5iYnR/2A5v27WORAZcUyaNlBkqEM0LzvBS0L0AHIwl6UfE2LxgRAgAEASatFL0TnFBcAAAAASUVORK5CYII=\"); }\n\n.sfly-wgt-lv-arrow-right {\n  /*left: 940px;*/\n  right: 15px;\n  background-image: url(\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABUAAAAaCAYAAABYQRdDAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyRpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoTWFjaW50b3NoKSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDo2RDAxOTM3RDE4RTcxMUU1OUVBMEE0MTBENzg2NTA2QiIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDo2RDAxOTM3RTE4RTcxMUU1OUVBMEE0MTBENzg2NTA2QiI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOjZEMDE5MzdCMThFNzExRTU5RUEwQTQxMEQ3ODY1MDZCIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjZEMDE5MzdDMThFNzExRTU5RUEwQTQxMEQ3ODY1MDZCIi8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+SFYyUwAAAXxJREFUeNq0lr9LQlEUx59ZIDgE4tDk4lpTLf0BthTVUkNBLS25NNTQc6+n4NDU1FLUklM/h/6BJqeaghanwBAahMDi9T1whLh8w3cu9oUP4j2X79N7z/doKo7jYNga/f0miqIjvOyQfR0wC14GGYZhGIw4a7vgmuzNgXuQT/JJXdNvsAaaZG9RH5ixmoq6YAG0SE2O4BSkrKaiNzX+ILVVcOBjKnpSgy92H2DLx1T0ALb/qB2Dko+p6ATUyPoYaIBJH9P+122Q9XFwByZ8TCV2G+CR1ArgBmStpqJPsAReSW0GnIO01VTU1lbrkNoyqPuY9o8i8O1TprxeTI7UrsCe1TSj2S+SmsyKdZ0diU0l62eafVctPeeu9esfghWyLrNhXmeF6Uwl4/tkvaez4dl6UXOacaayzgbT7U+BS824q6rOBFNLSZZvNduu5EEVa59m1bBAapL9zUEBcE0luxdgmuyVzC/qDDAlqq5Dg/1ES+u8J2rq//gz8SPAAOy5Ry+WVVC7AAAAAElFTkSuQmCC\"); }\n  .sfly-wgt-lv-arrow-right:hover {\n    background-image: url(\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABUAAAAaCAYAAABYQRdDAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyRpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoTWFjaW50b3NoKSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDo5MTU0MTVGQTE4RTcxMUU1OUVBMEE0MTBENzg2NTA2QiIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDo5MTU0MTVGQjE4RTcxMUU1OUVBMEE0MTBENzg2NTA2QiI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOjZEMDE5MzdGMThFNzExRTU5RUEwQTQxMEQ3ODY1MDZCIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjZEMDE5MzgwMThFNzExRTU5RUEwQTQxMEQ3ODY1MDZCIi8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+RDUnEwAAAYBJREFUeNpi/P//PwO1AQsy50uwwAQglY9F3TsgtgTiW4QM5Fn7gYEJTawYiDdhUSsExNuAWIQYl6Ib+heIo4D4LBa1ylALOUg1FAS+ArEPED/CIgcKgoVAzEiqoSDwAmrwRyxyYUDcSo6hIHAZasAfLHKVQJxCjqEgsAuIM3HITQNiV3IMBYE5QNyJRZwViFcDsQ45hsK8uxqLOD8QbwViCXIMBWW7OCA+jkVODog3AzE3qYaCwA8g9gfiu1jkTIB4CRAzk2ooCLyGJrV3WOQCgLiHHENhQcFAbjrFBkSgESOERW4jEJeQaigHNO8rY5EDlRXR0LKDaENBeX0RNO+jg0fQcP5KqvfbgDgUiziobPCGlhUkhSkoj1dgEf8NLRuukBpRbtA8jg1kQcsGkmJfF4hXQfM4OuiAlgkkJSlQXt4CzdvoAGRRFanplBtqoBwWOVDejyeUAdANBeXdpUBsjEUtKM/7QcsAknJUD7TQwFZFg5LOG6ISNS0aEwABBgDcQUcvVTa6JgAAAABJRU5ErkJggg==\"); }\n\n.sfly-wgt-lv-arrow-up {\n  display: none;\n  top: 24px;\n  background-image: url(\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABoAAAAVCAYAAABYHP4bAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2hpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDowM0NBQTMwRjI1MjA2ODExODIyQUVDNDFBNjQwNDY1NiIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDpCREZDODc4RkU1QzgxMUU0OUMyQkQ3OERFNzc0QTc1OCIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDpCREZDODc4RUU1QzgxMUU0OUMyQkQ3OERFNzc0QTc1OCIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M2IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6NzBEQjU5NDA0MDIwNjgxMTgyMkFFQzQxQTY0MDQ2NTYiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6MDNDQUEzMEYyNTIwNjgxMTgyMkFFQzQxQTY0MDQ2NTYiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz6JKxZ8AAABcklEQVR42mJpa2tjoAdgIlE9MxD3QzEzKRpZSFDLDcRLgDgAylcE4mgg/kpNH0kA8QEkS0DAH4gPQuWoYpEOEJ8EYhMscsZQOR1KLXIF4iNALIdHjRxUjRu5FqUA8VYg5ifC1yA1W6B6iLaIEYhBaX42ELNikX8HxeiAFaqnHWoGXos4gHgFEFficNhdILYGYisoGxuogJrBgcsiESDeB8RhOAw4DsSWQHwDiG8CsQVUDBsIg5olgm6RGhCfgBqEDawGYicgfo0k9gYqthqHHkuomerIFoFcpoxDQycQhwPxDyxyP6ByHTj0gsw8hmyREBZFf4A4FRrm//GkuP/QOAWp/Y1FXghf8v4IxN5APIeEIgqk1geql6jk/QiIbYF4FxmF9C6o3keELDoLxOZAfJmCGuEy1IyzuCzaBMT2QPyCCtXPC6hZG9EtmgjEQcQW+UQCkFnBQDwBuT4qoFHF+heIC8mpYckGjP///6eLRQABBgD/RkXjLkVleAAAAABJRU5ErkJggg==\"); }\n  .sfly-wgt-lv-arrow-up:hover {\n    background-image: url(\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABoAAAAVCAYAAABYHP4bAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2hpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDowM0NBQTMwRjI1MjA2ODExODIyQUVDNDFBNjQwNDY1NiIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDpCRTIyMjVFNkU1QzgxMUU0OUMyQkQ3OERFNzc0QTc1OCIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDpCRTIyMjVFNUU1QzgxMUU0OUMyQkQ3OERFNzc0QTc1OCIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M2IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6NzBEQjU5NDA0MDIwNjgxMTgyMkFFQzQxQTY0MDQ2NTYiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6MDNDQUEzMEYyNTIwNjgxMTgyMkFFQzQxQTY0MDQ2NTYiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz4SXBJoAAABaUlEQVR42syVO0sDQRSFjTEQsBBCCquACNqkU9AoIgjaKCgRYmGr/0H/gI9KrbW0EFIp2qQQBfFRpEqjhU2qgCKICAGF9Rs5xRJm1t0kBC98sDv33nP2MdyJfeT7ujoR3RHr47An4lEaeyLU9sIxLOl+AFbhs51v1A9XPhMTi3CtXFuMsvAAo5bciHLZVo1m4QYyATUZ1cw1a7QGFxBmW5qac/WENorBFhxCwpJ/E42RUM+2NAKNknACm44He4ZJmNC1LTakkXQZpeESCg6BO8jBIzzBuNZsUZBWutFoCO4lZIsizMCLb+1Va0VHT06aw34j82SDjoZdWIG6JVdXbsfRazRv/UYpS9E3rOubewE7ztM/NbVflnwqaHu/wzwcRRhRpnZBvaG2dxWmoNTEkC6pt/qXURnGoNLCiVCRRtlldAbTUGvD8VOT1mmj0QHkw478kGG0lmH/d9z81xO26Yh5ntcRox8BBgCv7EUV9bA1wwAAAABJRU5ErkJggg==\"); }\n\n.sfly-wgt-lv-arrow-down {\n  bottom: 6px;\n  background-image: url(\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABoAAAAVCAYAAABYHP4bAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2hpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDowM0NBQTMwRjI1MjA2ODExODIyQUVDNDFBNjQwNDY1NiIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDpCREZDODc4QkU1QzgxMUU0OUMyQkQ3OERFNzc0QTc1OCIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDpCREZDODc4QUU1QzgxMUU0OUMyQkQ3OERFNzc0QTc1OCIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M2IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6NzBEQjU5NDA0MDIwNjgxMTgyMkFFQzQxQTY0MDQ2NTYiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6MDNDQUEzMEYyNTIwNjgxMTgyMkFFQzQxQTY0MDQ2NTYiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz5jFlHVAAABdUlEQVR42mJsa2tjoAdgYqATgFk0AYiZaWA+yMx+ZIvygXgdEHNT0RKQWWuBuAA96PyA+CAQS1DBEgmoWf644sgYiE8CsS4FluhCzTAmlBjkgPgwELuRYYkbVK8csamOH4i3AnEKCZaA1G6B6sWZ6t5hkWMB4tlA3AHEjHgsAMm1Q9WyYpF/h2yRJRDfxWFQORCvBGIOLHIcULkKHHpBZlohW3QLiC2A+DgODaFAvA+IRZHERKBioTj0HIeaeRM9jt4AsRMQr8Kh0RKqWQOI1YH4BFQMG1gFNesNcjwggx9AHAH1ciUWA5SB+CiULYTDElCcVgHxf0Kp7j9UYSoQ/8YiL4TDkt9QPZXolhAqVOcAsTcQfyQiaYPU+ED1kFV67wZiGyB+hEfNI6iaXZRWE1eA2ByIz2CROwuVu0Kt+ugFEDsA8QYksY1AbA+VIwhYSChivgJxCBD3QPklQPyXWM0sJBaaIIMLySnSGf///0+XqhwgwABJpkUGZ5l7eAAAAABJRU5ErkJggg==\"); }\n  .sfly-wgt-lv-arrow-down:hover {\n    background-image: url(\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABoAAAAVCAYAAABYHP4bAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2hpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDowM0NBQTMwRjI1MjA2ODExODIyQUVDNDFBNjQwNDY1NiIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDpCRTIyMjVFMkU1QzgxMUU0OUMyQkQ3OERFNzc0QTc1OCIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDpCREZDODc5MkU1QzgxMUU0OUMyQkQ3OERFNzc0QTc1OCIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M2IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6NzBEQjU5NDA0MDIwNjgxMTgyMkFFQzQxQTY0MDQ2NTYiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6MDNDQUEzMEYyNTIwNjgxMTgyMkFFQzQxQTY0MDQ2NTYiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz6fWjkYAAABdklEQVR42mL8HMTPQA/AxEAnALNoAhAz08B8kJn9yBblA/E6IOamoiUgs9YCcQF60PkB8UEglqCCJRJQs/xxxZExEJ8EYl0KLNGFmmFMKDHIAfFhIHYjwxI3qF45YlMdKM1vBeIUEiwBqd0C1Ysz1b3DIscCxLOBuAOIGfFYAJJrh6plxSL/DtkiSyC+i8OgciBeCcQcWOQ4oHIVOPSCzLRCtugWEFsA8XEcGkKBeB8QiyKJiUDFQnHoOQ418yZ6HL0BYicgXoVDoyVUswYQqwPxCagYNrAKatYb5HhABj+AOALq5UosBigD8VEoWwiHJaA4rQLi/4RS3X+owlQg/o1FXgiHJb+heirRLSFUqM4BYm8g/khE0gap8YHqIav03g3ENkD8CI+aR1A1uyitJq4AsTkQn8EidxYqd4Va9dELIHYA4g1IYhuB2B4qRxCwkFDEfAXiECDugfJLgPgvsZpZSCw0QQYXklOkM/7//58uVTlAgAEANOJEyE28jC0AAAAASUVORK5CYII=\"); }\n\n.sfly_wgt_fullview_products .sfly-wgt-lv-arrow-left, .sfly_wgt_fullview_products .sfly-wgt-lv-arrow-right {\n  top: auto;\n  bottom: 235px; }\n\n.sfly_wgt_listview_spread, .sfly_wgt_fullview_spread {\n  display: block;\n  position: absolute;\n  width: 100%;\n  /*left: -980px;*/\n  padding-top: 25px;\n  padding-bottom: 25px; }\n\n.sfly_wgt_listview_spread {\n  height: 100%;\n  z-index: 1; }\n\n.sfly_wgt_listview_paging_wrapper, .sfly_wgt_fullview_paging_wrapper {\n  position: absolute;\n  bottom: 10px;\n  text-align: center;\n  display: none; }\n  .sfly_wgt_listview_paging_wrapper .sfly_wgt_listview_paging_elem, .sfly_wgt_listview_paging_wrapper .sfly_wgt_fullview_paging_elem, .sfly_wgt_fullview_paging_wrapper .sfly_wgt_listview_paging_elem, .sfly_wgt_fullview_paging_wrapper .sfly_wgt_fullview_paging_elem {\n    background-color: #DDD;\n    -webkit-border-radius: 5px;\n    -moz-border-radius: 5px;\n    -ms-border-radius: 5px;\n    border-radius: 5px;\n    width: 5px;\n    height: 5px;\n    float: left;\n    margin: 3px;\n    display: inline-block; }\n    .sfly_wgt_listview_paging_wrapper .sfly_wgt_listview_paging_elem:hover, .sfly_wgt_listview_paging_wrapper .sfly_wgt_listview_paging_elem.selected, .sfly_wgt_listview_paging_wrapper .sfly_wgt_fullview_paging_elem:hover, .sfly_wgt_listview_paging_wrapper .sfly_wgt_fullview_paging_elem.selected, .sfly_wgt_fullview_paging_wrapper .sfly_wgt_listview_paging_elem:hover, .sfly_wgt_fullview_paging_wrapper .sfly_wgt_listview_paging_elem.selected, .sfly_wgt_fullview_paging_wrapper .sfly_wgt_fullview_paging_elem:hover, .sfly_wgt_fullview_paging_wrapper .sfly_wgt_fullview_paging_elem.selected {\n      background-color: #c6c7c9;\n      cursor: pointer; }\n\n.sfly_wgt_fullview_paging_wrapper {\n  bottom: 55px; }\n\n#sfly_wgt_openwin_container {\n  -webkit-touch-callout: none;\n  -webkit-user-select: none;\n  -khtml-user-select: none;\n  -moz-user-select: none;\n  -ms-user-select: none;\n  -o-user-select: none;\n  user-select: none;\n  position: fixed;\n  top: 100px;\n  right: 180px;\n  width: 720px;\n  height: 520px;\n  border: solid 1px #c6c7c9;\n  border-right: solid 1px #c4c4c4;\n  z-index: 6001;\n  background-color: #fff;\n  display: none; }\n  #sfly_wgt_openwin_container .sfly_wgt_arrow_book {\n    position: absolute;\n    top: 17px;\n    right: -1px;\n    background: #ffffff;\n    border: 0px solid #636363; }\n  #sfly_wgt_openwin_container .sfly_wgt_arrow_book:after, #sfly_wgt_openwin_container .sfly_wgt_arrow_book:before {\n    right: 100%;\n    top: 50%;\n    border: solid transparent;\n    content: \" \";\n    height: 0;\n    width: 0;\n    position: absolute;\n    pointer-events: none; }\n  #sfly_wgt_openwin_container .sfly_wgt_arrow_book:after {\n    border-color: rgba(255, 255, 255, 0);\n    border-right-color: #ffffff;\n    border-width: 10px;\n    margin-top: -10px; }\n  #sfly_wgt_openwin_container .sfly_wgt_arrow_book:before {\n    border-color: rgba(221, 221, 221, 0);\n    border-right-color: #c4c4c4;\n    border-width: 12px;\n    margin-top: -12px; }\n  #sfly_wgt_openwin_container #sfly_wgt_album_switch_select {\n    position: absolute;\n    top: 15px;\n    right: 15px;\n    z-index: 10; }\n  #sfly_wgt_openwin_container #sfly_wgt_upp {\n    position: absolute;\n    top: 15px;\n    right: 20px;\n    z-index: 1; }\n  #sfly_wgt_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_title {\n    position: absolute;\n    top: 15px;\n    left: 15px; }\n    #sfly_wgt_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_title h3 {\n      margin: 0;\n      font-family: \"Avenir LT W01 65 Medium\", \"Avenir LT\", Verdana, Arial, sans-serif;\n      color: #181512;\n      font-size: 14px; }\n    #sfly_wgt_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_title h4.price-wrapper {\n      font-family: \"Avenir LT W01 35 Light\", \"Avenir LT\", Verdana, Arial, sans-serif;\n      font-size: 11px;\n      margin: 0;\n      margin-top: 5px;\n      color: #676767; }\n      #sfly_wgt_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_title h4.price-wrapper span.price-old {\n        text-decoration: line-through;\n        color: #919191; }\n      #sfly_wgt_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_title h4.price-wrapper span.price-sale {\n        color: #C11111; }\n  #sfly_wgt_openwin_container #sfly_wgt_sideopen_container ul.sfly-wgt-book-nav li {\n    cursor: pointer; }\n  #sfly_wgt_openwin_container #sfly_wgt_sideopen_container ul.sfly-wgt-book-nav li:first-of-type {\n    background-color: #FFFFFF;\n    border-radius: 5px 0 0 5px; }\n    #sfly_wgt_openwin_container #sfly_wgt_sideopen_container ul.sfly-wgt-book-nav li:first-of-type div {\n      background-color: #c6c7c9;\n      border-radius: 5px 0 0 5px; }\n  #sfly_wgt_openwin_container #sfly_wgt_sideopen_container ul.sfly-wgt-book-nav li:last-of-type {\n    background-color: #FFFFFF;\n    border-radius: 0 5px 5px 0; }\n    #sfly_wgt_openwin_container #sfly_wgt_sideopen_container ul.sfly-wgt-book-nav li:last-of-type div {\n      background-color: #c6c7c9;\n      border-radius: 0 5px 5px 0; }\n  #sfly_wgt_openwin_container #sfly_wgt_sideopen_container ul.sfly-wgt-book-nav li.wgt-nav-selected {\n    background-color: #c6c7c9; }\n    #sfly_wgt_openwin_container #sfly_wgt_sideopen_container ul.sfly-wgt-book-nav li.wgt-nav-selected div {\n      background-color: #f05323;\n      width: 60px !important;\n      border-radius: 5px; }\n    #sfly_wgt_openwin_container #sfly_wgt_sideopen_container ul.sfly-wgt-book-nav li.wgt-nav-selected div:hover {\n      background-color: #dc4405; }\n  #sfly_wgt_openwin_container #sfly_wgt_sideopen_container ul.sfly-wgt-book-nav.draggable li.wgt-nav-selected div {\n    background-color: #dc4405; }\n  #sfly_wgt_openwin_container #sfly_wgt_sideopen_container .sfly-wgt-book-paging {\n    position: absolute;\n    width: 112px;\n    margin: 0 auto;\n    z-index: 1; }\n    #sfly_wgt_openwin_container #sfly_wgt_sideopen_container .sfly-wgt-book-paging #sfly_wgt_sideopen_arrow_left, #sfly_wgt_openwin_container #sfly_wgt_sideopen_container .sfly-wgt-book-paging #sfly_wgt_sideopen_arrow_right {\n      /*top: 285px;*/\n      position: static;\n      float: left;\n      width: 29px;\n      height: 30px;\n      background-repeat: no-repeat;\n      cursor: pointer;\n      z-index: 100;\n      opacity: 0.6;\n      filter: alpha(opacity=60); }\n      #sfly_wgt_openwin_container #sfly_wgt_sideopen_container .sfly-wgt-book-paging #sfly_wgt_sideopen_arrow_left:hover, #sfly_wgt_openwin_container #sfly_wgt_sideopen_container .sfly-wgt-book-paging #sfly_wgt_sideopen_arrow_right:hover {\n        opacity: 1;\n        filter: alpha(opacity=100); }\n      #sfly_wgt_openwin_container #sfly_wgt_sideopen_container .sfly-wgt-book-paging #sfly_wgt_sideopen_arrow_left.nonactive-arrow, #sfly_wgt_openwin_container #sfly_wgt_sideopen_container .sfly-wgt-book-paging #sfly_wgt_sideopen_arrow_right.nonactive-arrow {\n        opacity: 0.2;\n        filter: alpha(opacity=20);\n        cursor: default; }\n    #sfly_wgt_openwin_container #sfly_wgt_sideopen_container .sfly-wgt-book-paging #sfly_wgt_sideopen_arrow_right {\n      background-image: url(\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB0AAAAeCAYAAADQBxWhAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyRpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoTWFjaW50b3NoKSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDpEOEI4NkZFNUYyNTcxMUU0QkQ2OEQ5NEI0NjdDQjcwOSIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDpEOEI4NkZFNkYyNTcxMUU0QkQ2OEQ5NEI0NjdDQjcwOSI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkQ4Qjg2RkUzRjI1NzExRTRCRDY4RDk0QjQ2N0NCNzA5IiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOkQ4Qjg2RkU0RjI1NzExRTRCRDY4RDk0QjQ2N0NCNzA5Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+DGvphQAAA3BJREFUeNrcV0tPE1EUPrQWQRJaTLAxwWpbYilYYEEF48qdFkUthIoCMSzc+Q8kanCnC9cuXBB5gyAIwZUboil1AbQ8xqTFosZUo2lpYinl4TnjTBzLbWcKiSSe5Js7k9z5vrn3PO6ZrO3tbfjXpoJ9sH0RPaBk0t329oM4nENcQZxBHEdoERFEEPEWMYJ4fb+jIy7Hl5XOpyhGH9WGuIc4quD7vghzn6L4RsaiKGjBoR9RTs8mkwmMiJMWC+h0OsjJyYG1tTUIh8PwnuNgORCAAEKwWYQLhTnFoihox2EScdhgMECV3Q4VlZWyy5ydmQGPxwMfV1bo8QfiPAp7ZEVRsASHN4iCUzYbOOvrQa1WKw6Szc1NeD40BD6vlx6/I84mr/gvURTU4PCOttSGgg2NjbuO0IG+PvD5fOJW21E4kSplbpMgbamzoSGZZyMTUXr/GPKgVQi8O1cqpAU548i1piawlpYyyV6OjYFneho0Gg3cbGuDoqKilMKLCwvQ29NDtyFKMzGdpCu9RIIUpakEyRy1tWApKYFEIgG93d2wurqaci7xEB+aHnGRtb0OuhBh2hKmUvHBpdfrIRqNwrPOTj51UhmlmJQ/WbSKLsbfX5bWKEebW1shPz8fQqEQDA0OwtbWFnOuhK+KJcp7XavVKgoUEnSh78m3VBwmxseZ8yR8BpaoVlyFUlOr5M+L3Nxc8VbHEqXindY/UqMA6u7q4gPKXFzMBxjLYrGYeBtmiX7iySIRWUESogAiYQqoRpeLDzCWRf9E92eWKF8jJUWbaRQwA/39fADl5eXBjZaWtC6R8HlYohN04Tgu1ft8FXk1OQnc0hIfQNebm2UDj+ZK+ZMP8THEt4DfX0gTGflKPim44HAAQYkRj7DSr4jRHSvFEkUR9JDup6amWHlXkEntpfeJR7BH0o4i2fuPEd6VYBCG8Xjai9H7xEN8Am/a89Qq9Dza0rIyuOp0QnZ2tmKxeDwOI8PDsDA/L6ZhDa5ySUnnUCP4oJCOudPV1WArL5cV9M7NgdvtFjsH8mMdCroz6ZFO4PBC7JHMZjNYrFYwGY2gxR6JVr++vg4R7JECy8vALS6C3++X9kiXUTC4227wFuJOBt3gA8STXXWDSeJUQOuE44lOC9qFQ4ifiA9Ci0N5OIpisT31vf/Vb8UvAQYAWQljJ32HscEAAAAASUVORK5CYII=\"); }\n    #sfly_wgt_openwin_container #sfly_wgt_sideopen_container .sfly-wgt-book-paging #sfly_wgt_sideopen_arrow_left {\n      background-image: url(\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB0AAAAeCAYAAADQBxWhAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyRpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoTWFjaW50b3NoKSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDpEOEI4NkZFOUYyNTcxMUU0QkQ2OEQ5NEI0NjdDQjcwOSIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDpEOEI4NkZFQUYyNTcxMUU0QkQ2OEQ5NEI0NjdDQjcwOSI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkQ4Qjg2RkU3RjI1NzExRTRCRDY4RDk0QjQ2N0NCNzA5IiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOkQ4Qjg2RkU4RjI1NzExRTRCRDY4RDk0QjQ2N0NCNzA5Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+QscLnQAAA3BJREFUeNrsl89PE1EQx4dCEUyg1QQbE6y2JJaCBQ5UIJ48iaCoBZEfhoMHb/4HgBq86cGzB2IARTAIYiDevBBNUw9Ay481tFCsMdVoujVYSmVxZt2N63bb3ULiiUm++3a7b+ez772Zt9OsnZ0d+N+WtQ+V2u2engPYnEVdRtWhjqMMKBYVRL1DTaDe3O3ri+8JirAcbG6g7qCOahjEZ6FvP8J/ZQxFoA2bUVQFXVutVrCgTtpsYDQaIS8vDzY3NyESicAHhoHVQAACKMHmUNcQzGiGItCJzWvUYbPZDNVOJ1RWVakOc252FjweD3xcX6fL76h6BHtUoQgsxeYt6tAphwNczc2QnZ2tOUi2t7fhxdgY+LxeuvyGOiMf8T9QBOqxeU9T6kBgS2vrriP0+cgI+Hw+caqdCE6I93SyvrcISFPqamnJlBOQXtDzx9APWqXgN3mkQlrQYhxpa28He1lZSu+hUAge9/dDIpGA2ro6ON/QQD9z8kEsLS7Cs+FhOg1TmonpJO10kYAUpemALMvC06EhHmgrLYVz9fWpZo33Q/7QTKgLSh351yVHqYxS5MngIGxsbIDJZIKruOY6nS7tnFOKSf3LodV0sPx5syTjOA5GMTjC4TAUFhbC9a4u0Ov1qgst8VetBOVX3WAwKD48PTUF/pUVHtTR2cmDtZjEn1kJyt+lnUY1FzlOc0jn5+eLp0YlKCuum5I1NDby60MBNIIRGY1GNUFjsZh4GlGChugQZVnFhylgmjH3KIAIODQwkPIFpfbj78t9UoLye6Rk004ymnoKoIKCAj6gaLvjVKZa4s+jBJ2mA8MwaZ1QALV1dPABxSwv8wGWzqiP1D9ZjuT+K9TXgN9fRB3T5WtxcTF09/bKf6atLUsOFEb6BTWZNFLcomiB7tP5zMyM6rQpfSbleU1+BHsgrSjk28lDlHc9GIRxXK+9GD1Pfsif4Dft99Qu1DyGsvJyuOJyQW5urmZYPB6HifFxWFxYENOwFke5rKVyqBXWoIg+c6drasBRUaEK9M7Pg9vtFisHWscmBLozqZFOYPNSrJFKSkrAZreD1WIBA9ZINPqtrS1gsUYKrK4Cs7QEfr9fWiNdQmBwt9XgTVR3BtXgPdSjXVWDMjhtoE3C54m+FjQLB1E/UWtCiUN5OImw2P7fCtF+CzAAAYt06eg2xM8AAAAASUVORK5CYII=\"); }\n    #sfly_wgt_openwin_container #sfly_wgt_sideopen_container .sfly-wgt-book-paging .sfly-wgt-pages {\n      width: 50px;\n      font-size: 12px;\n      padding-top: 8px;\n      text-align: center;\n      float: left;\n      color: #919191; }\n  #sfly_wgt_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart {\n    position: absolute;\n    bottom: 5px;\n    width: 100%; }\n    #sfly_wgt_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart #sfly_wgt_sideopen_buttons {\n      position: absolute;\n      bottom: 38px;\n      right: 50px;\n      text-align: center; }\n      #sfly_wgt_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart #sfly_wgt_sideopen_buttons .sfly-wgt-lightlink {\n        color: #306293;\n        display: block;\n        margin-top: 15px; }\n        #sfly_wgt_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart #sfly_wgt_sideopen_buttons .sfly-wgt-lightlink:hover {\n          text-decoration: underline; }\n    #sfly_wgt_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart #sfly_wgt_sideopen_styles {\n      position: absolute;\n      bottom: 15px;\n      left: 38px;\n      height: 85px;\n      width: 550px; }\n      #sfly_wgt_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart #sfly_wgt_sideopen_styles .sfly-wgt-prod-style {\n        float: left;\n        border: solid 1px transparent;\n        margin-right: 15px;\n        padding: 5px;\n        cursor: pointer; }\n        #sfly_wgt_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart #sfly_wgt_sideopen_styles .sfly-wgt-prod-style:hover, #sfly_wgt_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart #sfly_wgt_sideopen_styles .sfly-wgt-prod-style.sfly-bookstyle-selected, #sfly_wgt_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart #sfly_wgt_sideopen_styles .sfly-wgt-prod-style.sfly-calstyle-selected {\n          border: solid 1px #f05323;\n          cursor: pointer; }\n          #sfly_wgt_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart #sfly_wgt_sideopen_styles .sfly-wgt-prod-style:hover .sfly_wgt_product_style_title, #sfly_wgt_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart #sfly_wgt_sideopen_styles .sfly-wgt-prod-style.sfly-bookstyle-selected .sfly_wgt_product_style_title, #sfly_wgt_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart #sfly_wgt_sideopen_styles .sfly-wgt-prod-style.sfly-calstyle-selected .sfly_wgt_product_style_title {\n            color: #f05323; }\n        #sfly_wgt_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart #sfly_wgt_sideopen_styles .sfly-wgt-prod-style .sfly_wgt_product_style_title {\n          text-align: center;\n          font-size: 10px;\n          margin: 0; }\n  #sfly_wgt_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_no_enough_photos_popup {\n    top: 200px;\n    left: 110px;\n    font-size: 14px;\n    width: 453px;\n    padding: 20px 20px 0px 20px;\n    font-family: \"Avenir LT W01 65 Medium\", \"Avenir LT\", Verdana, Arial, sans-serif; }\n    #sfly_wgt_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_no_enough_photos_popup div {\n      line-height: 25px; }\n    #sfly_wgt_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_no_enough_photos_popup #sfly_wgt_no_enough_photos_button {\n      text-align: right;\n      margin-top: 5px; }\n      #sfly_wgt_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_no_enough_photos_popup #sfly_wgt_no_enough_photos_button .sfly-wgt-orange-btn-sfly {\n        padding: 0 20px; }\n  #sfly_wgt_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products {\n    position: absolute;\n    top: 63px;\n    left: 55px; }\n    #sfly_wgt_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products.sfly-wgt-prints {\n      top: 72px; }\n  #sfly_wgt_openwin_container #sfly_wgt_sideopen_container .sfly_wgt_sideopen_product {\n    position: absolute;\n    text-align: center;\n    font-size: 12px;\n    width: 100%;\n    left: 0px; }\n    #sfly_wgt_openwin_container #sfly_wgt_sideopen_container .sfly_wgt_sideopen_product .sfly_wgt_product {\n      position: absolute; }\n      #sfly_wgt_openwin_container #sfly_wgt_sideopen_container .sfly_wgt_sideopen_product .sfly_wgt_product .sfly_wgt_product_inner {\n        position: relative;\n        cursor: pointer; }\n    #sfly_wgt_openwin_container #sfly_wgt_sideopen_container .sfly_wgt_sideopen_product .sfly_wgt_product_inner_action {\n      bottom: 5px;\n      position: relative; }\n      #sfly_wgt_openwin_container #sfly_wgt_sideopen_container .sfly_wgt_sideopen_product .sfly_wgt_product_inner_action .sfly_wgt_product_price {\n        bottom: 5px;\n        position: relative;\n        color: #336699;\n        z-index: 2; }\n        #sfly_wgt_openwin_container #sfly_wgt_sideopen_container .sfly_wgt_sideopen_product .sfly_wgt_product_inner_action .sfly_wgt_product_price strong {\n          color: #336699;\n          font-family: \"Avenir LT W01 85 Heavy\", \"Avenir LT\", Verdana, Arial, sans-serif;\n          font-size: 11px;\n          font-weight: 300; }\n          #sfly_wgt_openwin_container #sfly_wgt_sideopen_container .sfly_wgt_sideopen_product .sfly_wgt_product_inner_action .sfly_wgt_product_price strong:hover {\n            text-decoration: underline;\n            cursor: pointer; }\n  #sfly_wgt_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_container {\n    position: relative;\n    height: 260px; }\n    #sfly_wgt_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_container #sfly_wgt_sideopen_products_1 {\n      top: 63px; }\n    #sfly_wgt_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_container #sfly_wgt_sideopen_products_2 {\n      bottom: -25px; }\n    #sfly_wgt_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_container #sfly_wgt_product_buttons {\n      visibility: hidden; }\n  #sfly_wgt_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_more_styles_produts {\n    position: absolute;\n    bottom: 5px;\n    text-align: center;\n    width: 100%;\n    color: #336699; }\n    #sfly_wgt_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_more_styles_produts a, #sfly_wgt_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_more_styles_produts a:visited, #sfly_wgt_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_more_styles_produts a:active {\n      color: #336699; }\n    #sfly_wgt_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_more_styles_produts a:hover {\n      text-decoration: underline; }\n  #sfly_wgt_openwin_container #sfly_wgt_sideopen_container .sfly_wgt_bg_throbber {\n    display: none;\n    top: 225px;\n    left: 50%; }\n\n#sfly_wgt_full_overlay {\n  z-index: 6000;\n  height: 100%;\n  width: 100%;\n  background-color: #464646;\n  position: fixed;\n  top: 0;\n  left: 0;\n  opacity: 0.5;\n  filter: alpha(opacity=50);\n  display: none; }\n  #sfly_wgt_full_overlay.visible:not(.sfly_wgt_full_overlay) {\n    display: block; }\n\n#sfly_wgt_full_openwin_container {\n  -webkit-touch-callout: none;\n  -webkit-user-select: none;\n  -khtml-user-select: none;\n  -moz-user-select: none;\n  -ms-user-select: none;\n  -o-user-select: none;\n  user-select: none;\n  position: fixed;\n  left: 50%;\n  top: 50%;\n  height: 80%;\n  -moz-transform: translate(-50%, -50%);\n  -o-transform: translate(-50%, -50%);\n  -ms-transform: translate(-50%, -50%);\n  -webkit-transform: translate(-50%, -50%);\n  transform: translate(-50%, -50%);\n  border: 1px solid #c6c7c9;\n  border-radius: 8px;\n  overflow: hidden;\n  z-index: 0;\n  background-color: #fff;\n  display: block;\n  box-shadow: 4px 4px 4px rgba(51, 51, 51, 0.5);\n  opacity: 0;\n  visibility: hidden;\n  pointer-events: none;\n  -webkit-transition: visibility 0.5s, opacity 0.5s;\n  /* Safari */\n  transition: visibility 0.5s, opacity 0.5s; }\n  #sfly_wgt_full_openwin_container.sfly-wgt-modal-small-titles #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wgt_sideopen_title h2, #sfly_wgt_full_openwin_container.sfly-wgt-modal-x-small-titles #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wgt_sideopen_title h2 {\n    font-size: 16px; }\n  #sfly_wgt_full_openwin_container.sfly-wgt-modal-small-titles #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wgt_sideopen_title h3, #sfly_wgt_full_openwin_container.sfly-wgt-modal-x-small-titles #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wgt_sideopen_title h3 {\n    font-size: 12px; }\n  #sfly_wgt_full_openwin_container.sfly-wgt-modal-x-small-titles #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wgt_upp.sfly-wgt-mobile-btns {\n    position: absolute;\n    left: 25px;\n    top: 90px; }\n  #sfly_wgt_full_openwin_container.sfly-wgt-modal-x-small-titles #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products .sfly_wgt_product ul.sfly-wgt-cal-nav-horiz {\n    margin-top: 20px; }\n  #sfly_wgt_full_openwin_container.sfly-wgt-modal-x-small-titles #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart #sfly-wgt-book-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size {\n    padding: 0 !important; }\n  #sfly_wgt_full_openwin_container.sfly-wgt-modal-x-small-titles #sfly_wgt_sideopen_container .sfly_wgt_bg_throbber {\n    top: 260px;\n    left: 47%; }\n  #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded {\n    width: 100%;\n    height: 100%;\n    position: relative;\n    top: 0;\n    left: 0;\n    -moz-transform: translate(0, 0);\n    -o-transform: translate(0, 0);\n    -ms-transform: translate(0, 0);\n    -webkit-transform: translate(0, 0);\n    transform: translate(0, 0);\n    border: none;\n    border-radius: 0;\n    box-shadow: none;\n    visibility: visible;\n    pointer-events: auto; }\n    #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wg_sideopen_close {\n      display: none; }\n    #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded .sfly-wgt-orange-btn-sfly, #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded .sfly-wgt-white-btn-sfly {\n      font-size: 12px;\n      line-height: 16px;\n      padding: 9px 21px; }\n    #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container .sfly_wgt_bg_throbber {\n      top: 50%;\n      left: 50%; }\n    #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wgt_sideopen_title h2, #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wgt_sideopen_title h4 {\n      color: #58595b;\n      display: inline-block; }\n    #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wgt_sideopen_title.sfly-wgt-photobooks h2, #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wgt_sideopen_title.sfly-wgt-calendars h2 {\n      display: block; }\n    #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wgt_sideopen_title.sfly-wgt-photobooks h4, #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wgt_sideopen_title.sfly-wgt-calendars h4 {\n      display: inline-block;\n      font-family: \"Avenir LT W01 35 Light\", \"Avenir LT\", Verdana, Arial, sans-serif;\n      font-size: 12px; }\n      #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wgt_sideopen_title.sfly-wgt-photobooks h4 span.sub-title-page-num, #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wgt_sideopen_title.sfly-wgt-calendars h4 span.sub-title-page-num {\n        font-weight: 700; }\n    @media only screen and (min-width: 768px) and (max-width: 991px) {\n      #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wgt_sideopen_title h2 {\n        font-size: 14px; }\n      #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wgt_sideopen_title h4 {\n        font-size: 11px; } }\n    @media only screen and (max-width: 767px) {\n      #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wgt_sideopen_title {\n        top: 40px;\n        text-align: center;\n        width: 100%; }\n        #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wgt_sideopen_title h2 {\n          font-size: 18px; }\n        #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wgt_sideopen_title h4 {\n          font-size: 12px; } }\n    #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wgt_sideopen_title.sfly-wgt-products h2 {\n      font-size: 18px; }\n    #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wgt_sideopen_title.sfly-wgt-products h4 {\n      font-size: 14px; }\n    @media only screen and (min-width: 768px) and (max-width: 991px) {\n      #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wgt_sideopen_title.sfly-wgt-products h2 {\n        font-size: 14px; }\n      #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wgt_sideopen_title.sfly-wgt-products h4 {\n        font-size: 11px; } }\n    #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wgt_upp {\n      top: 35px; }\n      @media only screen and (max-width: 767px) {\n        #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wgt_upp {\n          z-index: 2; }\n          #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wgt_upp.sfly-wgt-photobooks {\n            position: fixed;\n            left: 50%;\n            -moz-transform: translate(-50%);\n            -o-transform: translate(-50%);\n            -ms-transform: translate(-50%);\n            -webkit-transform: translate(-50%);\n            transform: translate(-50%);\n            float: none;\n            top: auto; }\n            #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wgt_upp.sfly-wgt-photobooks .sfly-wgt-orange-btn-sfly {\n              display: none; }\n          #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wgt_upp.sfly-wgt-calendars {\n            position: fixed;\n            left: 50%;\n            -moz-transform: translate(-50%);\n            -o-transform: translate(-50%);\n            -ms-transform: translate(-50%);\n            -webkit-transform: translate(-50%);\n            transform: translate(-50%);\n            float: none;\n            top: auto; }\n            #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wgt_upp.sfly-wgt-calendars .sfly-wgt-orange-btn-sfly {\n              top: 350px;\n              position: relative; }\n          #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wgt_upp .sfly-wgt-white-btn-sfly {\n            display: none; } }\n    #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products.sfly-wgt-prints {\n      top: 0;\n      left: 0; }\n      #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products.sfly-wgt-prints .sfly_wgt_product {\n        position: relative;\n        top: 25%;\n        left: 50%;\n        -moz-transform: translate(-50%, -50%);\n        -o-transform: translate(-50%, -50%);\n        -ms-transform: translate(-50%, -50%);\n        -webkit-transform: translate(-50%, -50%);\n        transform: translate(-50%, -50%); }\n        #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products.sfly-wgt-prints .sfly_wgt_product .sfly_wgt_product_banner {\n          position: absolute;\n          top: 0;\n          right: 10px;\n          background-repeat: no-repeat; }\n          @media only screen and (max-width: 767px) {\n            #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products.sfly-wgt-prints .sfly_wgt_product .sfly_wgt_product_banner {\n              top: 15px; } }\n          #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products.sfly-wgt-prints .sfly_wgt_product .sfly_wgt_product_banner.no_photos {\n            right: -51px;\n            top: -51px; }\n            @media only screen and (max-width: 767px) {\n              #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products.sfly-wgt-prints .sfly_wgt_product .sfly_wgt_product_banner.no_photos {\n                right: -85px; } }\n            @media only screen and (min-width: 768px) and (max-width: 991px) {\n              #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products.sfly-wgt-prints .sfly_wgt_product .sfly_wgt_product_banner.no_photos {\n                top: -25px; } }\n        @media only screen and (min-width: 768px) and (max-width: 991px) {\n          #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products.sfly-wgt-prints .sfly_wgt_product {\n            top: 75px; } }\n        @media only screen and (max-width: 767px) {\n          #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products.sfly-wgt-prints .sfly_wgt_product {\n            top: 165px; } }\n        @media only screen and (min-width: 768px) and (max-width: 991px) {\n          #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products.sfly-wgt-prints .sfly_wgt_product .sfly_wgt_product_inner {\n            zoom: 0.8;\n            -moz-transform: scale(0.8); } }\n        @media only screen and (max-width: 767px) {\n          #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products.sfly-wgt-prints .sfly_wgt_product .sfly_wgt_product_inner {\n            zoom: 0.60;\n            -moz-transform: scale(0.6); } }\n        #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products.sfly-wgt-prints .sfly_wgt_product .sfly_wgt_product_inner_no_photos {\n          background-size: 100%;\n          width: 238px;\n          height: 248px;\n          background-repeat: no-repeat;\n          position: relative;\n          background-image: url(\"https://d22bbwxztp2lry.cloudfront.net/productswidget/Shutterfly/sidewidget/images/prod/widget/sfly_wgt_product_inner_no_photos.png\"); }\n          @media only screen and (max-width: 767px) {\n            #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products.sfly-wgt-prints .sfly_wgt_product .sfly_wgt_product_inner_no_photos {\n              width: 137px;\n              height: 144px;\n              margin-bottom: -20px; } }\n    #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products.sfly-wgt-photobooks {\n      height: 100%;\n      top: 0;\n      left: 0;\n      width: 100%; }\n      #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products.sfly-wgt-photobooks .sfly_wgt_product {\n        float: none;\n        position: relative;\n        top: 35%;\n        left: 50%;\n        -moz-transform: translate(-50%, -50%);\n        -o-transform: translate(-50%, -50%);\n        -ms-transform: translate(-50%, -50%);\n        -webkit-transform: translate(-50%, -50%);\n        transform: translate(-50%, -50%); }\n        @media only screen and (min-width: 768px) and (max-width: 991px) {\n          #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products.sfly-wgt-photobooks .sfly_wgt_product {\n            top: 28%; } }\n        #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products.sfly-wgt-photobooks .sfly_wgt_product .sfly_wgt_product_inner {\n          left: 50%;\n          -moz-transform: translate(-50%);\n          -o-transform: translate(-50%);\n          -ms-transform: translate(-50%);\n          -webkit-transform: translate(-50%);\n          transform: translate(-50%); }\n          @media only screen and (max-width: 767px) {\n            #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products.sfly-wgt-photobooks .sfly_wgt_product .sfly_wgt_product_inner {\n              left: auto;\n              -moz-transform: none;\n              -o-transform: none;\n              -ms-transform: none;\n              -webkit-transform: none;\n              transform: none; } }\n      #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products.sfly-wgt-photobooks .sfly-wgt-book-paging {\n        left: 50%;\n        -moz-transform: translate(-50%);\n        -o-transform: translate(-50%);\n        -ms-transform: translate(-50%);\n        -webkit-transform: translate(-50%);\n        transform: translate(-50%);\n        position: absolute;\n        bottom: 210px; }\n        @media only screen and (min-width: 992px) and (max-width: 1199px) {\n          #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products.sfly-wgt-photobooks .sfly-wgt-book-paging {\n            bottom: 240px; } }\n        @media only screen and (min-width: 768px) and (max-width: 991px) {\n          #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products.sfly-wgt-photobooks .sfly-wgt-book-paging {\n            bottom: 200px; } }\n        @media only screen and (max-width: 767px) {\n          #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products.sfly-wgt-photobooks .sfly-wgt-book-paging {\n            display: none; } }\n      #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products.sfly-wgt-photobooks ul.sfly-wgt-book-nav {\n        display: none; }\n      @media only screen and (max-width: 767px) {\n        #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products.sfly-wgt-photobooks {\n          z-index: 1; } }\n    #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products.sfly-wgt-calendars {\n      width: 100%;\n      height: 100%;\n      top: 0;\n      left: 0; }\n      #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products.sfly-wgt-calendars .sfly_wgt_product {\n        float: none;\n        position: relative;\n        top: 35%;\n        left: 50%;\n        -moz-transform: translate(-50%, -50%);\n        -o-transform: translate(-50%, -50%);\n        -ms-transform: translate(-50%, -50%);\n        -webkit-transform: translate(-50%, -50%);\n        transform: translate(-50%, -50%); }\n        @media only screen and (min-width: 768px) and (max-width: 991px) {\n          #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products.sfly-wgt-calendars .sfly_wgt_product {\n            top: 30%; }\n          @-moz-document url-prefix() {\n            #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products.sfly-wgt-calendars .sfly_wgt_product {\n              height: 292px; } } }\n        @media only screen and (max-width: 767px) {\n          #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products.sfly-wgt-calendars .sfly_wgt_product {\n            top: 200px;\n            float: left; }\n            #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products.sfly-wgt-calendars .sfly_wgt_product .sfly-wgt-cal-nav-horiz, #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products.sfly-wgt-calendars .sfly_wgt_product .sfly-wgt-calendar-paging {\n              display: none; } }\n        #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products.sfly-wgt-calendars .sfly_wgt_product .sfly_wgt_product_inner {\n          left: 50%;\n          -moz-transform: translate(-50%);\n          -o-transform: translate(-50%);\n          -ms-transform: translate(-50%);\n          -webkit-transform: translate(-50%);\n          transform: translate(-50%); }\n          @media only screen and (min-width: 768px) and (max-width: 991px) {\n            #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products.sfly-wgt-calendars .sfly_wgt_product .sfly_wgt_product_inner {\n              zoom: 0.7;\n              -moz-transform: scale(0.7);\n              -moz-transform-origin: -100% 0%; } }\n          @media only screen and (max-width: 767px) {\n            #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products.sfly-wgt-calendars .sfly_wgt_product .sfly_wgt_product_inner {\n              zoom: 0.8;\n              -moz-transform: scale(0.8);\n              -moz-transform-origin: -100% 0%;\n              left: auto;\n              -moz-transform: none;\n              -o-transform: none;\n              -ms-transform: none;\n              -webkit-transform: none;\n              transform: none; } }\n      @media only screen and (max-width: 767px) {\n        #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products.sfly-wgt-calendars {\n          z-index: 1; } }\n    #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_container #sfly_wgt_sideopen_products_inner_container {\n      padding: 0 25px 20px 25px;\n      box-sizing: border-box; }\n    #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container .sfly-wgt-prints-info {\n      bottom: 140px; }\n      #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container .sfly-wgt-prints-info h5 {\n        line-height: 30px; }\n      #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container .sfly-wgt-prints-info p {\n        line-height: 22px; }\n      @media only screen and (min-width: 768px) and (max-width: 991px) {\n        #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container .sfly-wgt-prints-info {\n          bottom: 120px; }\n          #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container .sfly-wgt-prints-info h5 {\n            font-size: 14px; }\n          #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container .sfly-wgt-prints-info p {\n            font-size: 11px; } }\n      @media only screen and (max-width: 767px) {\n        #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container .sfly-wgt-prints-info {\n          top: 258px;\n          bottom: inherit;\n          display: none; }\n          #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container .sfly-wgt-prints-info h5 {\n            font-size: 14px; }\n          #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container .sfly-wgt-prints-info p {\n            display: none; } }\n    #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container .sfly-wgt-order-prints {\n      bottom: 100px; }\n      @media only screen and (max-width: 767px) {\n        #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container .sfly-wgt-order-prints {\n          position: absolute;\n          bottom: inherit;\n          top: 356px;\n          font-size: 0.8em; } }\n      @media only screen and (min-width: 768px) and (max-width: 991px) {\n        #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container .sfly-wgt-order-prints {\n          bottom: 80px; } }\n    #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart {\n      height: 100px;\n      border-top-color: #c6c7c9; }\n      @media only screen and (max-width: 767px) {\n        #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart {\n          z-index: 3; } }\n      #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart .sfly_wgt_sideopen_bottompart_tabs {\n        display: none; }\n      #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart #sfly_wgt_sideopen_bottompart_tab_choose_style_content #sfly_wgt_sideopen_styles_left, #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart #sfly_wgt_sideopen_bottompart_tab_choose_style_content #sfly_wgt_sideopen_styles_right {\n        display: none; }\n      #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart #sfly_wgt_sideopen_bottompart_tab_choose_style_content #sfly_wgt_sideopen_styles_container {\n        overflow-x: hidden;\n        top: 15px; }\n        #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart #sfly_wgt_sideopen_bottompart_tab_choose_style_content #sfly_wgt_sideopen_styles_container #sfly_wgt_sideopen_styles {\n          margin-left: 20px; }\n      #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart #sfly_wgt_sideopen_bottompart_tab_choose_size_content {\n        display: none; }\n    #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container.use-new-style-guide #sfly_wgt_no_enough_photos_bubble {\n      left: 50%;\n      top: 48%;\n      -moz-transform: translate(-50%, -50%);\n      -o-transform: translate(-50%, -50%);\n      -ms-transform: translate(-50%, -50%);\n      -webkit-transform: translate(-50%, -50%);\n      transform: translate(-50%, -50%);\n      width: 290px;\n      height: auto;\n      border-radius: 6px;\n      border: solid 1px #979797;\n      text-align: center;\n      font-family: \"Avenir LT W01 65 Medium\", \"Avenir LT\", Verdana, Arial, sans-serif;\n      font-weight: 500;\n      font-size: 16px;\n      color: #58595b;\n      -moz-box-shadow: none;\n      -webkit-box-shadow: none;\n      box-shadow: none;\n      padding: 75px 60px; }\n      @media only screen and (max-width: 767px) {\n        #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container.use-new-style-guide #sfly_wgt_no_enough_photos_bubble {\n          padding: 15px 0;\n          top: 41%; } }\n      #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container.use-new-style-guide #sfly_wgt_no_enough_photos_bubble span#sfly_wgt_no_enough_photos_bubble_warning {\n        display: block;\n        width: 28px;\n        height: 28px;\n        margin-left: 50%;\n        margin-bottom: 16px;\n        -moz-transform: translateX(-50%);\n        -o-transform: translateX(-50%);\n        -ms-transform: translateX(-50%);\n        -webkit-transform: translateX(-50%);\n        transform: translateX(-50%);\n        background-image: url(\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABwAAAAcCAYAAAByDd+UAAAAAXNSR0IArs4c6QAAAu9JREFUSA2lVj1vE0EQnVnOUoyEQAJRRBEFFQklf4CKKi00SBR2gkMgNBQIiUimQsgSBZDEzgcdDZSIhoJ/AF1wR0cqCiSUGOHzDjN7vvXues85zEqnm5udN+9mZ+bmEP5hUedKBdTROunBHYZpxMoG0MxTbHzul3WjyhpSExSTbZJO1wHwHF/nif48MTrZK7lKG8Ls/A5RugSebwVGx3sl+Tx0IYa253cB0hpQ5P2MLq1lNoUu7AZaKSKYY5xd2CTqN7zI9NDY49fAOe3AwddVbEJuMea1kNAUCPZe8JGtcL5c4EesJs9EQb30Id+ujTaJSZM2UPV+USF575gD6e31E4C9l+Nk4nDmOd7a/2Qulpk2h/EdJacrBis+ImuM0ET2c3+DgXyMXmRDOP4a+XHlXGtIGyA+pI2C5RHa0jc5i5Ix/LfjROS4ncm7tFHQMh5hvPSDVyz9GG8ZSzix9EuTBIaRlkmG1cgF0q97pR9gp32kjLRO2wspV+9awhX1OCsQG+y0vifgzPE2EI6+Kya7F0/8BPxUW1y9oJckrMFU+KlAqBR/jl75zTvJEze5rh5aCyO7jW93IgJ/NJTe4sPleYZJhz1FjCIq1b9ota5slTFBvrPMoU+1bNcO26KeVVUMlOkI6JuCyht50tC/iYCjF4jAECWQZA9vd3m0BdXCpHtUNIY8Z/lpHFPZTIaQvGYybrls+YiD7jKHzrMvd5ibhXeB+dDQQnwYX+zT3fNQ2GQrfXLVzDVvCowgnIMviHjVXCyPdlxJpgrPRvElPp1lc+jowIyngomBoBax0f0g9rR1aZEUvXexUvGmQM5cvos33o21nBdhDjSG/BliYHu8ZXAutwNML1jZCIZMBvBajExMohHmTmK/GAz4wflrAQ14SOMD7sKzmf1//mLkpHI/rmXC0nexoTwxQte4sGUipe/iQjmaw9DIPEdbxuRsF4LSj+KHytIRin02Ow8fEekap19hMmhDerpV9IcWI/4LB1FAzJfde2kAAAAASUVORK5CYII=\"); }\n      #sfly_wgt_full_openwin_container.sfly_wgt_modal_embedded #sfly_wgt_sideopen_container.use-new-style-guide #sfly_wgt_no_enough_photos_bubble #sfly_wgt_no_enough_photos_bubble_arrow {\n        display: none; }\n  #sfly_wgt_full_openwin_container.non-visible {\n    opacity: 0;\n    visibility: hidden;\n    z-index: 0;\n    pointer-events: none; }\n  #sfly_wgt_full_openwin_container.visible {\n    opacity: 1;\n    visibility: visible;\n    z-index: 6001;\n    pointer-events: auto; }\n  #sfly_wgt_full_openwin_container .sfly_wgt_arrow_book {\n    position: absolute;\n    top: 17px;\n    right: -1px;\n    background: #ffffff;\n    border: 0px solid #636363; }\n  #sfly_wgt_full_openwin_container .sfly_wgt_arrow_book:after, #sfly_wgt_full_openwin_container .sfly_wgt_arrow_book:before {\n    right: 100%;\n    top: 50%;\n    border: solid transparent;\n    content: \" \";\n    height: 0;\n    width: 0;\n    position: absolute;\n    pointer-events: none; }\n  #sfly_wgt_full_openwin_container .sfly_wgt_arrow_book:after {\n    border-color: rgba(255, 255, 255, 0);\n    border-right-color: #ffffff;\n    border-width: 10px;\n    margin-top: -10px; }\n  #sfly_wgt_full_openwin_container .sfly_wgt_arrow_book:before {\n    border-color: rgba(221, 221, 221, 0);\n    border-right-color: #c4c4c4;\n    border-width: 12px;\n    margin-top: -12px; }\n  #sfly_wgt_full_openwin_container #sfly_wgt_album_switch_select {\n    position: absolute;\n    top: 15px;\n    right: 15px;\n    z-index: 10; }\n  #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container {\n    height: 100%; }\n    #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header {\n      height: 85px;\n      position: relative; }\n      #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wgt_sideopen_title {\n        display: inline-block;\n        position: absolute;\n        top: 25px;\n        left: 25px;\n        font-family: \"Avenir LT W01 35 Light\", Verdana, Arial, sans-serif;\n        font-size: 11px;\n        margin: 5px 0 0;\n        color: #666666; }\n        #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wgt_sideopen_title h2 {\n          margin: 0;\n          font-family: \"Avenir LT W01 35 Light\", \"Avenir LT\", Verdana, Arial, sans-serif;\n          color: #181512;\n          font-size: 20px;\n          padding: 0; }\n          #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wgt_sideopen_title h2 .sfly_wgt_tooltip_hover_area {\n            display: inline-block;\n            position: relative;\n            z-index: 6003; }\n            #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wgt_sideopen_title h2 .sfly_wgt_tooltip_hover_area:hover:not(.no-hover), #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wgt_sideopen_title h2 .sfly_wgt_tooltip_hover_area.force-hover:not(.no-hover) {\n              cursor: pointer;\n              color: #ed542f; }\n              #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wgt_sideopen_title h2 .sfly_wgt_tooltip_hover_area:hover:not(.no-hover) span.sfly_wgt_tooltip_triangle, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wgt_sideopen_title h2 .sfly_wgt_tooltip_hover_area.force-hover:not(.no-hover) span.sfly_wgt_tooltip_triangle {\n                border-top-color: #ed542f; }\n            #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wgt_sideopen_title h2 .sfly_wgt_tooltip_hover_area span.sfly_wgt_tooltip_triangle {\n              border-top: 6px solid #181512;\n              border-left: 6px solid transparent;\n              border-right: 6px solid transparent;\n              content: \"\";\n              height: 0;\n              left: 0;\n              display: inline-block;\n              width: 0;\n              vertical-align: middle; }\n              #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wgt_sideopen_title h2 .sfly_wgt_tooltip_hover_area span.sfly_wgt_tooltip_triangle #sfly_wgt_tooltip_container {\n                display: none;\n                color: #181512;\n                position: relative;\n                float: right;\n                line-height: normal;\n                top: 13px;\n                margin-right: -18px;\n                font-size: 15px;\n                min-width: 143px;\n                z-index: 6003;\n                border: 1px solid rgba(71, 71, 83, 0.35);\n                background-color: #FFF;\n                -webkit-border-radius: 6px;\n                -moz-border-radius: 6px;\n                -ms-border-radius: 6px;\n                border-radius: 6px;\n                -moz-box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);\n                -webkit-box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);\n                box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1); }\n                #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wgt_sideopen_title h2 .sfly_wgt_tooltip_hover_area span.sfly_wgt_tooltip_triangle #sfly_wgt_tooltip_container:after {\n                  content: \'\';\n                  position: absolute;\n                  top: -6px;\n                  right: 12px;\n                  width: 9px;\n                  height: 9px;\n                  border-left: 1px solid rgba(71, 71, 83, 0.35);\n                  border-top: 1px solid rgba(71, 71, 83, 0.35);\n                  transform: rotate(45deg);\n                  background: #fff; }\n                #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wgt_sideopen_title h2 .sfly_wgt_tooltip_hover_area span.sfly_wgt_tooltip_triangle #sfly_wgt_tooltip_container ul.sfly-wgt-tooltip-list {\n                  list-style-type: none;\n                  padding: 0;\n                  margin: 10px 0; }\n                  #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wgt_sideopen_title h2 .sfly_wgt_tooltip_hover_area span.sfly_wgt_tooltip_triangle #sfly_wgt_tooltip_container ul.sfly-wgt-tooltip-list li.sfly-wgt-book-choose-size {\n                    padding: 5px 10px;\n                    cursor: pointer; }\n                    #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wgt_sideopen_title h2 .sfly_wgt_tooltip_hover_area span.sfly_wgt_tooltip_triangle #sfly_wgt_tooltip_container ul.sfly-wgt-tooltip-list li.sfly-wgt-book-choose-size.sfly-wgt-book-choose-size-selected {\n                      color: #ed542f; }\n                    #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wgt_sideopen_title h2 .sfly_wgt_tooltip_hover_area span.sfly_wgt_tooltip_triangle #sfly_wgt_tooltip_container ul.sfly-wgt-tooltip-list li.sfly-wgt-book-choose-size:hover {\n                      background-color: #f6f8fb; }\n                    #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wgt_sideopen_title h2 .sfly_wgt_tooltip_hover_area span.sfly_wgt_tooltip_triangle #sfly_wgt_tooltip_container ul.sfly-wgt-tooltip-list li.sfly-wgt-book-choose-size .sfly-wgt-tooltip-choose-size-title {\n                      white-space: nowrap; }\n        #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wgt_sideopen_title #sfly_wgt_tooltip_container_background {\n          display: none;\n          position: fixed;\n          width: 100%;\n          height: 100%;\n          top: 0;\n          left: 0;\n          z-index: 6002; }\n        #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wgt_sideopen_title h3 {\n          margin: 0;\n          font-family: \"Avenir LT W01 65 Medium\", \"Avenir LT\", Verdana, Arial, sans-serif;\n          color: #181512;\n          font-size: 14px; }\n        #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wgt_sideopen_title h4.price-wrapper {\n          font-family: \"Avenir LT W01 35 Light\", \"Avenir LT\", Verdana, Arial, sans-serif;\n          font-size: 13px;\n          margin: 7px 0 0;\n          color: #666666; }\n          #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wgt_sideopen_title h4.price-wrapper span.price-old {\n            text-decoration: line-through;\n            color: #919191; }\n          #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wgt_sideopen_title h4.price-wrapper span.price-sale {\n            color: #C11111; }\n      #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wg_sideopen_close {\n        position: absolute;\n        top: 15px;\n        right: 15px;\n        z-index: 9;\n        height: 20px;\n        width: 20px; }\n        #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wg_sideopen_close:hover {\n          cursor: pointer; }\n          #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wg_sideopen_close:hover .sfly-wgt-qst-mark:after, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wg_sideopen_close:hover .sfly-wgt-qst-mark:before {\n            background: #F05323; }\n      #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wgt_upp {\n        position: relative;\n        top: 42px;\n        right: 50px;\n        display: inline-block;\n        float: right; }\n        #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wgt_upp #sfly_wgt_upp_select {\n          z-index: 9;\n          position: relative;\n          margin-right: 5px; }\n          #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wgt_upp #sfly_wgt_upp_select.hide-btn-in-selection-mode {\n            display: none; }\n    #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_border {\n      background-color: #f0f0f0;\n      height: 1px;\n      width: 90%;\n      position: absolute;\n      left: 5%;\n      bottom: 0; }\n    #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-book-choose-hightlights {\n      font-family: \"Avenir LT\", Verdana, Arial, sans-serif;\n      color: #181512;\n      font-size: 13px;\n      position: absolute;\n      right: 50px;\n      bottom: 115px; }\n      #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-book-choose-hightlights .checkbox_wrapper {\n        position: relative;\n        height: 16px;\n        width: 16px;\n        display: inline-block;\n        top: 3px; }\n        #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-book-choose-hightlights .checkbox_wrapper input[type=\"checkbox\"] {\n          opacity: 0;\n          height: 16px;\n          width: 16px;\n          position: absolute;\n          top: 0;\n          left: 0;\n          z-index: 9;\n          cursor: pointer;\n          display: block; }\n        #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-book-choose-hightlights .checkbox_wrapper input[type=\"checkbox\"] + label {\n          background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAGdJREFUOBFjPHnyjDcD4//5f//+E2UgATAzM71m+M+YyHDy1OlX799/+E8qAOkB6WUC2SwgwE+C3RClID0gvUwk60TTMGoAA8NoGAyKMADlqg8fPqIlUMJckB6QXhZQlrx1+zbZ2RkAyHJftKYyZE4AAAAASUVORK5CYII=) no-repeat;\n          height: 16px;\n          width: 16px;\n          display: inline-block;\n          padding: 0 0 0 0;\n          position: absolute;\n          top: 0;\n          left: 0;\n          z-index: 1; }\n        #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-book-choose-hightlights .checkbox_wrapper input[type=\"checkbox\"]:hover + label {\n          background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAGNJREFUOBFj/Bih6c3AwDT//+8fogwkAEZWjtcMDP8SGT5GaL/6fe7Af1IBSA9ILxPIZhZDexLshigF6QHpZSJZJ5qGUQOACQAtTEjmjhpAjUAE5ao/5w+SHPogPSC9jJRmZwBIalkzJ2OvRQAAAABJRU5ErkJggg==) no-repeat; }\n        #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-book-choose-hightlights .checkbox_wrapper input[type=\"checkbox\"]:checked + label {\n          background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAQFJREFUOBFj/Biq6s3w7//8/wz/RRlIAIwMjK8ZmBgTGT8Gq7wiVTPMHpAhTORqBhkC0ssEM41cmiQDWB0CGRhFpVHsItoANvdoBq6cbgaexqUMDGwccEOIMgCkmTO1Eazp58bZDAy/fmA3AOQ8kDORAbLm77PrGX7tBLoACbDA2eycYOcxickwfGfnAiskpBmkl/FDsPJ/mCFsHjEMnCkNYO7vY9sYWK28wGxsNoMlgASKASBBZFtBfHyaQfIIL4B4QAD2IyMjA0dyPcOPOQ0YfoaoQpAYLoBJMcmqMvx7fBvGxUnjjEZiNINMZQLnKpzm45cAZyZwlgRlTRIBLDsDANENVIBZS+J3AAAAAElFTkSuQmCC) no-repeat; }\n      #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-book-choose-hightlights.disabled {\n        opacity: 0.5; }\n        #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-book-choose-hightlights.disabled .checkbox_wrapper input[type=\"checkbox\"] {\n          cursor: default; }\n    #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_highlight_bubble {\n      display: none;\n      position: absolute;\n      bottom: 145px;\n      right: 50px;\n      z-index: 8;\n      padding: 10px 20px;\n      max-width: 210px;\n      max-height: 100px;\n      font-size: 14px;\n      font-family: \"Avenir LT W01 35 Light\", \"Avenir LT\", Verdana, Arial, sans-serif;\n      color: #181512;\n      border: 1px solid #f0f0f0;\n      border-radius: 5px;\n      background-color: #ffffff;\n      -webkit-box-shadow: 0 2px 6px 0 rgba(102, 102, 102, 0.75);\n      -moz-box-shadow: 0 2px 6px 0 rgba(102, 102, 102, 0.75);\n      box-shadow: 0 2px 6px 0 rgba(102, 102, 102, 0.75); }\n      #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_highlight_bubble .sfly_wgt_highlight_bubble_txt strong {\n        font-family: \"Avenir LT W01 85 Heavy\", \"Avenir LT\", Verdana, Arial, sans-serif; }\n      #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_highlight_bubble div {\n        line-height: 20px; }\n      #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_highlight_bubble #sfly_wgt_highlight_bubble_arrow {\n        width: 30px;\n        height: 30px;\n        position: absolute;\n        bottom: -30px;\n        right: 109px;\n        overflow: hidden;\n        box-shadow: 0 16px 10px -17px rgba(102, 102, 102, 0.75); }\n        #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_highlight_bubble #sfly_wgt_highlight_bubble_arrow:after {\n          content: \"\";\n          position: absolute;\n          width: 15px;\n          height: 15px;\n          background: #ffffff;\n          transform: rotate(45deg);\n          bottom: 22.5px;\n          left: 7.5px;\n          box-shadow: 3px 0px 6px -1px rgba(102, 102, 102, 0.75); }\n    #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-book-options, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-calendar-options {\n      position: relative;\n      font-family: \"Avenir LT W01 35 Light\", \"Avenir LT\", Verdana, Arial, sans-serif;\n      color: #181512; }\n      #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-book-options h3, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-calendar-options h3 {\n        font-size: 16px;\n        margin: 0; }\n      #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-book-options #sfly-wgt-book-choose-sizes, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-calendar-options #sfly-wgt-book-choose-sizes {\n        margin-top: 20px;\n        margin-left: 25px; }\n        #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-book-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-calendar-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size {\n          display: inline-block;\n          text-align: center;\n          padding: 0 36px;\n          cursor: pointer;\n          position: relative; }\n          #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-book-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size:hover, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-book-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size.sfly-wgt-book-choose-size-selected, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-calendar-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size:hover, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-calendar-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size.sfly-wgt-book-choose-size-selected {\n            color: #f05323; }\n            #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-book-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size:hover .sfly-wgt-book-choose-size-square, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-book-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size.sfly-wgt-book-choose-size-selected .sfly-wgt-book-choose-size-square, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-calendar-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size:hover .sfly-wgt-book-choose-size-square, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-calendar-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size.sfly-wgt-book-choose-size-selected .sfly-wgt-book-choose-size-square {\n              border-color: #f05323; }\n            #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-book-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size:hover .sfly-wgt-book-icon-wrapper .sfly-wgt-book-icon .sfly-wgt-book-icon-pages, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-book-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size.sfly-wgt-book-choose-size-selected .sfly-wgt-book-icon-wrapper .sfly-wgt-book-icon .sfly-wgt-book-icon-pages, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-calendar-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size:hover .sfly-wgt-book-icon-wrapper .sfly-wgt-book-icon .sfly-wgt-book-icon-pages, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-calendar-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size.sfly-wgt-book-choose-size-selected .sfly-wgt-book-icon-wrapper .sfly-wgt-book-icon .sfly-wgt-book-icon-pages {\n              border-bottom-color: #ed542f; }\n            #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-book-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size:hover .sfly-wgt-book-icon-wrapper .sfly-wgt-book-icon .sfly-wgt-book-icon-core, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-book-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size.sfly-wgt-book-choose-size-selected .sfly-wgt-book-icon-wrapper .sfly-wgt-book-icon .sfly-wgt-book-icon-core, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-calendar-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size:hover .sfly-wgt-book-icon-wrapper .sfly-wgt-book-icon .sfly-wgt-book-icon-core, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-calendar-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size.sfly-wgt-book-choose-size-selected .sfly-wgt-book-icon-wrapper .sfly-wgt-book-icon .sfly-wgt-book-icon-core {\n              border-color: #ed542f;\n              background-color: #ed542f; }\n              #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-book-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size:hover .sfly-wgt-book-icon-wrapper .sfly-wgt-book-icon .sfly-wgt-book-icon-core .sfly-wgt-book-icon-core-size-label, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-book-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size.sfly-wgt-book-choose-size-selected .sfly-wgt-book-icon-wrapper .sfly-wgt-book-icon .sfly-wgt-book-icon-core .sfly-wgt-book-icon-core-size-label, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-calendar-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size:hover .sfly-wgt-book-icon-wrapper .sfly-wgt-book-icon .sfly-wgt-book-icon-core .sfly-wgt-book-icon-core-size-label, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-calendar-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size.sfly-wgt-book-choose-size-selected .sfly-wgt-book-icon-wrapper .sfly-wgt-book-icon .sfly-wgt-book-icon-core .sfly-wgt-book-icon-core-size-label {\n                color: white; }\n            #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-book-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size:hover .sfly-wgt-book-icon-wrapper .sfly-wgt-book-icon .sfly-wgt-book-icon-spine, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-book-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size.sfly-wgt-book-choose-size-selected .sfly-wgt-book-icon-wrapper .sfly-wgt-book-icon .sfly-wgt-book-icon-spine, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-calendar-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size:hover .sfly-wgt-book-icon-wrapper .sfly-wgt-book-icon .sfly-wgt-book-icon-spine, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-calendar-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size.sfly-wgt-book-choose-size-selected .sfly-wgt-book-icon-wrapper .sfly-wgt-book-icon .sfly-wgt-book-icon-spine {\n              background-color: #ed542f; }\n            #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-book-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size:hover .sfly-wgt-book-icon-wrapper .sfly-wgt-book-icon-price, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-book-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size.sfly-wgt-book-choose-size-selected .sfly-wgt-book-icon-wrapper .sfly-wgt-book-icon-price, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-calendar-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size:hover .sfly-wgt-book-icon-wrapper .sfly-wgt-book-icon-price, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-calendar-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size.sfly-wgt-book-choose-size-selected .sfly-wgt-book-icon-wrapper .sfly-wgt-book-icon-price {\n              color: #58595b; }\n            #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-book-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size:hover .sfly-wgt-calendar-choose-size-calendar, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-book-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size.sfly-wgt-book-choose-size-selected .sfly-wgt-calendar-choose-size-calendar, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-calendar-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size:hover .sfly-wgt-calendar-choose-size-calendar, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-calendar-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size.sfly-wgt-book-choose-size-selected .sfly-wgt-calendar-choose-size-calendar {\n              background-image: url(\"https://d22bbwxztp2lry.cloudfront.net/productswidget/Shutterfly/sidewidget/images/prod/widget/sfly-wgt-calendar-choose-size-calendar-hover.png\"); }\n            #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-book-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size:hover .sfly-wgt-calendar-choose-size-deskcalendar, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-book-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size.sfly-wgt-book-choose-size-selected .sfly-wgt-calendar-choose-size-deskcalendar, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-calendar-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size:hover .sfly-wgt-calendar-choose-size-deskcalendar, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-calendar-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size.sfly-wgt-book-choose-size-selected .sfly-wgt-calendar-choose-size-deskcalendar {\n              background-image: url(\"https://d22bbwxztp2lry.cloudfront.net/productswidget/Shutterfly/sidewidget/images/prod/widget/sfly-wgt-calendar-choose-size-deskcalendar-hover.png\"); }\n            #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-book-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size:hover .sfly-wgt-book-icon-price, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-book-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size.sfly-wgt-book-choose-size-selected .sfly-wgt-book-icon-price, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-calendar-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size:hover .sfly-wgt-book-icon-price, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-calendar-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size.sfly-wgt-book-choose-size-selected .sfly-wgt-book-icon-price {\n              color: #58595b; }\n          #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-book-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size .sfly-wgt-book-choose-size-square, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-calendar-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size .sfly-wgt-book-choose-size-square {\n            border: 2px solid #181512;\n            display: inline-block; }\n          #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-book-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size .sfly-wgt-calendar-choose-size-calendar, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-calendar-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size .sfly-wgt-calendar-choose-size-calendar {\n            display: inline-block;\n            background: url(\"https://d22bbwxztp2lry.cloudfront.net/productswidget/Shutterfly/sidewidget/images/prod/widget/sfly-wgt-calendar-choose-size-calendar.png\") no-repeat center;\n            width: 39px;\n            height: 33.8px;\n            background-size: contain;\n            -webkit-transform: translate3d(0, 0, 0); }\n            #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-book-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size .sfly-wgt-calendar-choose-size-calendar.calendar-12x12, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-calendar-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size .sfly-wgt-calendar-choose-size-calendar.calendar-12x12 {\n              width: 45px;\n              height: 38px; }\n          #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-book-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size .sfly-wgt-calendar-choose-size-deskcalendar, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-calendar-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size .sfly-wgt-calendar-choose-size-deskcalendar {\n            display: inline-block;\n            background: url(\"https://d22bbwxztp2lry.cloudfront.net/productswidget/Shutterfly/sidewidget/images/prod/widget/sfly-wgt-calendar-choose-size-deskcalendar.png\") no-repeat center;\n            width: 40px;\n            height: 28px; }\n          #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-book-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size .sfly-wgt-book-choose-size-title, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-calendar-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size .sfly-wgt-book-choose-size-title {\n            font-size: 12px; }\n          #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-book-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size .sfly-wgt-book-icon-price, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-calendar-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size .sfly-wgt-book-icon-price {\n            line-height: 25px;\n            font-size: 11px;\n            font-weight: 300;\n            position: absolute;\n            white-space: nowrap;\n            left: 50%;\n            -moz-transform: translateX(-50%);\n            -o-transform: translateX(-50%);\n            -ms-transform: translateX(-50%);\n            -webkit-transform: translateX(-50%);\n            transform: translateX(-50%); }\n            #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-book-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size .sfly-wgt-book-icon-price span.price-old, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-calendar-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size .sfly-wgt-book-icon-price span.price-old {\n              text-decoration: line-through; }\n            #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-book-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size .sfly-wgt-book-icon-price span.price-sale, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-calendar-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size .sfly-wgt-book-icon-price span.price-sale {\n              color: #C11111; }\n          #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-book-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size .sfly-wgt-book-choose8x8, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-calendar-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size .sfly-wgt-book-choose8x8 {\n            width: 16px;\n            height: 16px; }\n          #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-book-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size .sfly-wgt-book-choose5x11, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-calendar-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size .sfly-wgt-book-choose5x11 {\n            width: 23.5px;\n            height: 8.5px; }\n          #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-book-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size .sfly-wgt-book-choose8x11, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-calendar-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size .sfly-wgt-book-choose8x11 {\n            width: 23.5px;\n            height: 16px; }\n          #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-book-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size .sfly-wgt-book-choose10x10, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-calendar-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size .sfly-wgt-book-choose10x10 {\n            width: 21px;\n            height: 21px; }\n          #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-book-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size .sfly-wgt-book-choose11x14, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-calendar-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size .sfly-wgt-book-choose11x14 {\n            width: 31px;\n            height: 23.5px; }\n          #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-book-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size .sfly-wgt-book-choose12x12, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-calendar-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size .sfly-wgt-book-choose12x12 {\n            width: 26px;\n            height: 26px; }\n          #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-book-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size .sfly-wgt-book-icon-wrapper, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-calendar-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size .sfly-wgt-book-icon-wrapper {\n            position: relative;\n            padding: 0 25px; }\n            #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-book-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size .sfly-wgt-book-icon-wrapper .sfly-wgt-book-icon, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-calendar-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size .sfly-wgt-book-icon-wrapper .sfly-wgt-book-icon {\n              position: relative; }\n              #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-book-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size .sfly-wgt-book-icon-wrapper .sfly-wgt-book-icon .sfly-wgt-book-icon-pages, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-calendar-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size .sfly-wgt-book-icon-wrapper .sfly-wgt-book-icon .sfly-wgt-book-icon-pages {\n                position: relative;\n                width: 0;\n                height: 0;\n                border-left: 35px solid transparent;\n                border-bottom: 10px solid #58595b;\n                margin-left: 5px; }\n                #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-book-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size .sfly-wgt-book-icon-wrapper .sfly-wgt-book-icon .sfly-wgt-book-icon-pages .sfly-wgt-book-icon-pages-hider, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-calendar-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size .sfly-wgt-book-icon-wrapper .sfly-wgt-book-icon .sfly-wgt-book-icon-pages .sfly-wgt-book-icon-pages-hider {\n                  position: absolute;\n                  border-left: 35px solid transparent;\n                  border-bottom: 10px solid white;\n                  bottom: -12px;\n                  left: -37px; }\n              #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-book-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size .sfly-wgt-book-icon-wrapper .sfly-wgt-book-icon .sfly-wgt-book-icon-core, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-calendar-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size .sfly-wgt-book-icon-wrapper .sfly-wgt-book-icon .sfly-wgt-book-icon-core {\n                position: relative;\n                width: 36px;\n                height: 36px;\n                border: 2px solid #58595b;\n                margin-top: 3px;\n                margin-left: 5px; }\n                #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-book-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size .sfly-wgt-book-icon-wrapper .sfly-wgt-book-icon .sfly-wgt-book-icon-core .sfly-wgt-book-icon-core-size-label, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-calendar-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size .sfly-wgt-book-icon-wrapper .sfly-wgt-book-icon .sfly-wgt-book-icon-core .sfly-wgt-book-icon-core-size-label {\n                  position: absolute;\n                  bottom: 4px;\n                  color: #58595b;\n                  font-size: 12px;\n                  font-family: \"Avenir LT W01 35 Light\", \"Avenir LT\", Verdana, Arial, sans-serif;\n                  font-weight: normal;\n                  -moz-transform: translateX(-50%);\n                  -o-transform: translateX(-50%);\n                  -ms-transform: translateX(-50%);\n                  -webkit-transform: translateX(-50%);\n                  transform: translateX(-50%);\n                  left: 50%; }\n              #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-book-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size .sfly-wgt-book-icon-wrapper .sfly-wgt-book-icon .sfly-wgt-book-icon-spine, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-calendar-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size .sfly-wgt-book-icon-wrapper .sfly-wgt-book-icon .sfly-wgt-book-icon-spine {\n                position: absolute;\n                width: 2px;\n                height: 40px;\n                background-color: #58595b;\n                top: 13px; }\n            #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-book-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size .sfly-wgt-book-icon-wrapper .sfly-wgt-book-icon-price, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-calendar-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size .sfly-wgt-book-icon-wrapper .sfly-wgt-book-icon-price {\n              line-height: 20px;\n              font-size: 11px;\n              font-weight: 300;\n              position: absolute;\n              white-space: nowrap;\n              left: 50%;\n              -moz-transform: translateX(-50%);\n              -o-transform: translateX(-50%);\n              -ms-transform: translateX(-50%);\n              -webkit-transform: translateX(-50%);\n              transform: translateX(-50%); }\n              #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-book-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size .sfly-wgt-book-icon-wrapper .sfly-wgt-book-icon-price span.price-old, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-calendar-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size .sfly-wgt-book-icon-wrapper .sfly-wgt-book-icon-price span.price-old {\n                text-decoration: line-through; }\n              #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-book-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size .sfly-wgt-book-icon-wrapper .sfly-wgt-book-icon-price span.price-sale, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-calendar-options #sfly-wgt-book-choose-sizes .sfly-wgt-book-choose-size .sfly-wgt-book-icon-wrapper .sfly-wgt-book-icon-price span.price-sale {\n                color: #C11111; }\n    #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-prints-options {\n      position: absolute;\n      top: 62%;\n      right: 100px;\n      font-family: \"Avenir LT W01 35 Light\", \"Avenir LT\", Verdana, Arial, sans-serif;\n      color: #181512; }\n      #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-prints-options #sfly-wgt-prints-choose-hightlights {\n        margin-top: 15px;\n        color: #666666;\n        font-size: 12px; }\n        #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-prints-options #sfly-wgt-prints-choose-hightlights input {\n          margin-bottom: 5px; }\n    #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container .sfly-wgt-prints-size-selector {\n      position: absolute;\n      left: 50%;\n      bottom: 16px;\n      transform: translate(-50%);\n      min-width: 327px; }\n      #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container .sfly-wgt-prints-size-selector ul.size-selector {\n        list-style-type: none;\n        margin: 0;\n        padding: 0; }\n        #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container .sfly-wgt-prints-size-selector ul.size-selector .selector-item {\n          min-height: 36px; }\n          #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container .sfly-wgt-prints-size-selector ul.size-selector .selector-item .label {\n            width: 100%;\n            font-size: 12px;\n            height: auto; }\n          #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container .sfly-wgt-prints-size-selector ul.size-selector .selector-item .radio {\n            display: inline-block;\n            width: 14px;\n            height: 14px;\n            border-radius: 100%;\n            background-color: white;\n            border: solid 1px #c6c7c9;\n            cursor: pointer;\n            margin: 2px 0; }\n            #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container .sfly-wgt-prints-size-selector ul.size-selector .selector-item .radio.selected {\n              width: 6px;\n              height: 6px;\n              border: 5px solid #f05323; }\n    #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container .sfly-wgt-order-prints {\n      position: absolute;\n      bottom: 30px;\n      left: 50%;\n      transform: translate(-50%); }\n    #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container .sfly-wgt-prints-info {\n      text-align: center;\n      position: absolute;\n      bottom: 100px;\n      width: 100%;\n      color: #4b525b;\n      font-family: \"avenir-roman\", \"Avenir LT W01 35 Light\", Verdana, Arial, sans-serif; }\n      #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container .sfly-wgt-prints-info h5 {\n        font-size: 18px;\n        line-height: 25px; }\n      #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container .sfly-wgt-prints-info p {\n        font-size: 14px;\n        line-height: 19px; }\n      #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container .sfly-wgt-prints-info label {\n        display: block; }\n      #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container .sfly-wgt-prints-info ul.sizeOptions {\n        list-style: none;\n        display: block; }\n      #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container .sfly-wgt-prints-info ul li {\n        float: left;\n        display: block;\n        width: 64px;\n        text-align: center; }\n    #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container ul.sfly-wgt-book-nav li {\n      cursor: pointer; }\n    #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container ul.sfly-wgt-book-nav li:first-of-type {\n      background-color: #FFFFFF;\n      border-radius: 5px 0 0 5px; }\n      #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container ul.sfly-wgt-book-nav li:first-of-type div {\n        background-color: #c6c7c9;\n        border-radius: 5px 0 0 5px; }\n    #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container ul.sfly-wgt-book-nav li:last-of-type {\n      background-color: #FFFFFF;\n      border-radius: 0 5px 5px 0; }\n      #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container ul.sfly-wgt-book-nav li:last-of-type div {\n        background-color: #c6c7c9;\n        border-radius: 0 5px 5px 0; }\n    #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container ul.sfly-wgt-book-nav li.wgt-nav-selected {\n      background-color: #c6c7c9; }\n      #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container ul.sfly-wgt-book-nav li.wgt-nav-selected div {\n        background-color: #f05323;\n        width: 60px !important;\n        border-radius: 5px; }\n      #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container ul.sfly-wgt-book-nav li.wgt-nav-selected div:hover {\n        background-color: #dc4405; }\n    #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container ul.sfly-wgt-book-nav.draggable li.wgt-nav-selected div {\n      background-color: #dc4405; }\n    #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container .sfly-wgt-book-paging {\n      position: absolute;\n      width: 112px;\n      margin: 0 auto;\n      z-index: 1; }\n      #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container .sfly-wgt-book-paging.sfly-wgt-calendar-paging {\n        position: relative;\n        width: 58px;\n        display: inline-block;\n        margin-left: 5px;\n        bottom: 5px; }\n      #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container .sfly-wgt-book-paging #sfly_wgt_sideopen_arrow_left, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container .sfly-wgt-book-paging #sfly_wgt_sideopen_arrow_right {\n        /*top: 285px;*/\n        position: static;\n        float: left;\n        width: 29px;\n        height: 30px;\n        background-repeat: no-repeat;\n        cursor: pointer;\n        z-index: 100;\n        opacity: 0.6;\n        filter: alpha(opacity=60); }\n        #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container .sfly-wgt-book-paging #sfly_wgt_sideopen_arrow_left:hover, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container .sfly-wgt-book-paging #sfly_wgt_sideopen_arrow_right:hover {\n          opacity: 1;\n          filter: alpha(opacity=100); }\n        #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container .sfly-wgt-book-paging #sfly_wgt_sideopen_arrow_left.nonactive-arrow, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container .sfly-wgt-book-paging #sfly_wgt_sideopen_arrow_right.nonactive-arrow {\n          opacity: 0.2;\n          filter: alpha(opacity=20);\n          cursor: default; }\n      #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container .sfly-wgt-book-paging #sfly_wgt_sideopen_arrow_right {\n        background-image: url(\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB0AAAAeCAYAAADQBxWhAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyRpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoTWFjaW50b3NoKSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDpEOEI4NkZFNUYyNTcxMUU0QkQ2OEQ5NEI0NjdDQjcwOSIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDpEOEI4NkZFNkYyNTcxMUU0QkQ2OEQ5NEI0NjdDQjcwOSI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkQ4Qjg2RkUzRjI1NzExRTRCRDY4RDk0QjQ2N0NCNzA5IiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOkQ4Qjg2RkU0RjI1NzExRTRCRDY4RDk0QjQ2N0NCNzA5Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+DGvphQAAA3BJREFUeNrcV0tPE1EUPrQWQRJaTLAxwWpbYilYYEEF48qdFkUthIoCMSzc+Q8kanCnC9cuXBB5gyAIwZUboil1AbQ8xqTFosZUo2lpYinl4TnjTBzLbWcKiSSe5Js7k9z5vrn3PO6ZrO3tbfjXpoJ9sH0RPaBk0t329oM4nENcQZxBHEdoERFEEPEWMYJ4fb+jIy7Hl5XOpyhGH9WGuIc4quD7vghzn6L4RsaiKGjBoR9RTs8mkwmMiJMWC+h0OsjJyYG1tTUIh8PwnuNgORCAAEKwWYQLhTnFoihox2EScdhgMECV3Q4VlZWyy5ydmQGPxwMfV1bo8QfiPAp7ZEVRsASHN4iCUzYbOOvrQa1WKw6Szc1NeD40BD6vlx6/I84mr/gvURTU4PCOttSGgg2NjbuO0IG+PvD5fOJW21E4kSplbpMgbamzoSGZZyMTUXr/GPKgVQi8O1cqpAU548i1piawlpYyyV6OjYFneho0Gg3cbGuDoqKilMKLCwvQ29NDtyFKMzGdpCu9RIIUpakEyRy1tWApKYFEIgG93d2wurqaci7xEB+aHnGRtb0OuhBh2hKmUvHBpdfrIRqNwrPOTj51UhmlmJQ/WbSKLsbfX5bWKEebW1shPz8fQqEQDA0OwtbWFnOuhK+KJcp7XavVKgoUEnSh78m3VBwmxseZ8yR8BpaoVlyFUlOr5M+L3Nxc8VbHEqXindY/UqMA6u7q4gPKXFzMBxjLYrGYeBtmiX7iySIRWUESogAiYQqoRpeLDzCWRf9E92eWKF8jJUWbaRQwA/39fADl5eXBjZaWtC6R8HlYohN04Tgu1ft8FXk1OQnc0hIfQNebm2UDj+ZK+ZMP8THEt4DfX0gTGflKPim44HAAQYkRj7DSr4jRHSvFEkUR9JDup6amWHlXkEntpfeJR7BH0o4i2fuPEd6VYBCG8Xjai9H7xEN8Am/a89Qq9Dza0rIyuOp0QnZ2tmKxeDwOI8PDsDA/L6ZhDa5ySUnnUCP4oJCOudPV1WArL5cV9M7NgdvtFjsH8mMdCroz6ZFO4PBC7JHMZjNYrFYwGY2gxR6JVr++vg4R7JECy8vALS6C3++X9kiXUTC4227wFuJOBt3gA8STXXWDSeJUQOuE44lOC9qFQ4ifiA9Ci0N5OIpisT31vf/Vb8UvAQYAWQljJ32HscEAAAAASUVORK5CYII=\"); }\n      #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container .sfly-wgt-book-paging #sfly_wgt_sideopen_arrow_left {\n        background-image: url(\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB0AAAAeCAYAAADQBxWhAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyRpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoTWFjaW50b3NoKSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDpEOEI4NkZFOUYyNTcxMUU0QkQ2OEQ5NEI0NjdDQjcwOSIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDpEOEI4NkZFQUYyNTcxMUU0QkQ2OEQ5NEI0NjdDQjcwOSI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkQ4Qjg2RkU3RjI1NzExRTRCRDY4RDk0QjQ2N0NCNzA5IiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOkQ4Qjg2RkU4RjI1NzExRTRCRDY4RDk0QjQ2N0NCNzA5Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+QscLnQAAA3BJREFUeNrsl89PE1EQx4dCEUyg1QQbE6y2JJaCBQ5UIJ48iaCoBZEfhoMHb/4HgBq86cGzB2IARTAIYiDevBBNUw9Ay481tFCsMdVoujVYSmVxZt2N63bb3ULiiUm++3a7b+ez772Zt9OsnZ0d+N+WtQ+V2u2engPYnEVdRtWhjqMMKBYVRL1DTaDe3O3ri+8JirAcbG6g7qCOahjEZ6FvP8J/ZQxFoA2bUVQFXVutVrCgTtpsYDQaIS8vDzY3NyESicAHhoHVQAACKMHmUNcQzGiGItCJzWvUYbPZDNVOJ1RWVakOc252FjweD3xcX6fL76h6BHtUoQgsxeYt6tAphwNczc2QnZ2tOUi2t7fhxdgY+LxeuvyGOiMf8T9QBOqxeU9T6kBgS2vrriP0+cgI+Hw+caqdCE6I93SyvrcISFPqamnJlBOQXtDzx9APWqXgN3mkQlrQYhxpa28He1lZSu+hUAge9/dDIpGA2ro6ON/QQD9z8kEsLS7Cs+FhOg1TmonpJO10kYAUpemALMvC06EhHmgrLYVz9fWpZo33Q/7QTKgLSh351yVHqYxS5MngIGxsbIDJZIKruOY6nS7tnFOKSf3LodV0sPx5syTjOA5GMTjC4TAUFhbC9a4u0Ov1qgst8VetBOVX3WAwKD48PTUF/pUVHtTR2cmDtZjEn1kJyt+lnUY1FzlOc0jn5+eLp0YlKCuum5I1NDby60MBNIIRGY1GNUFjsZh4GlGChugQZVnFhylgmjH3KIAIODQwkPIFpfbj78t9UoLye6Rk004ymnoKoIKCAj6gaLvjVKZa4s+jBJ2mA8MwaZ1QALV1dPABxSwv8wGWzqiP1D9ZjuT+K9TXgN9fRB3T5WtxcTF09/bKf6atLUsOFEb6BTWZNFLcomiB7tP5zMyM6rQpfSbleU1+BHsgrSjk28lDlHc9GIRxXK+9GD1Pfsif4Dft99Qu1DyGsvJyuOJyQW5urmZYPB6HifFxWFxYENOwFke5rKVyqBXWoIg+c6drasBRUaEK9M7Pg9vtFisHWscmBLozqZFOYPNSrJFKSkrAZreD1WIBA9ZINPqtrS1gsUYKrK4Cs7QEfr9fWiNdQmBwt9XgTVR3BtXgPdSjXVWDMjhtoE3C54m+FjQLB1E/UWtCiUN5OImw2P7fCtF+CzAAAYt06eg2xM8AAAAASUVORK5CYII=\"); }\n      #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container .sfly-wgt-book-paging .sfly-wgt-pages {\n        width: 50px;\n        font-size: 12px;\n        padding-top: 8px;\n        text-align: center;\n        float: left;\n        color: #919191; }\n    #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container.use-new-style-guide #sfly_wgt_sideopen_bottompart .sfly_wgt_sideopen_bottompart_tabs li.sfly_wgt_sideopen_bottompart_tab {\n      margin-top: -27px;\n      line-height: 15px; }\n    #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart {\n      position: absolute;\n      bottom: 0;\n      height: 110px;\n      width: 100%;\n      border-top: solid 1px #58595b; }\n      #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart ul.sfly_wgt_sideopen_bottompart_tabs {\n        list-style-type: none;\n        margin: 0;\n        padding: 0 0 0 25px;\n        position: absolute; }\n        #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart ul.sfly_wgt_sideopen_bottompart_tabs li.sfly_wgt_sideopen_bottompart_tab {\n          float: left;\n          position: relative;\n          font-family: \"Avenir LT W01 35 Light\", \"Avenir LT\", Verdana, Arial, sans-serif;\n          color: #181512;\n          font-size: 13px;\n          margin: -27px 5px 2px 0;\n          padding: 5px 15px;\n          letter-spacing: 0.5px;\n          -webkit-border-radius: 4px 4px 0 0;\n          -moz-border-radius: 4px 4px 0 0;\n          -ms-border-radius: 4px 4px 0 0;\n          border-radius: 4px 4px 0 0;\n          border: 1px solid #58595b;\n          cursor: pointer;\n          background-color: white;\n          min-width: 107px;\n          text-align: center;\n          line-height: 15px; }\n          #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart ul.sfly_wgt_sideopen_bottompart_tabs li.sfly_wgt_sideopen_bottompart_tab.sfly_wgt_tab_active {\n            background-color: white;\n            color: #ed542f;\n            border-bottom-color: white;\n            border-bottom-width: 1px; }\n      #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart .sfly_wgt_sideopen_bottompart_tab_content {\n        display: none; }\n        #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart .sfly_wgt_sideopen_bottompart_tab_content.sfly_wgt_tab_active {\n          display: block; }\n      #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart h3 {\n        font-family: \"Avenir LT W01 35 Light\", \"Avenir LT\", Verdana, Arial, sans-serif;\n        color: #181512;\n        font-size: 14px;\n        margin: 10px 0 10px 50px; }\n      #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart #sfly_wgt_sideopen_styles_left {\n        display: none;\n        position: absolute;\n        background: #868686;\n        height: 8px;\n        width: 24px;\n        top: 48px;\n        left: 20px;\n        cursor: pointer;\n        transform: rotate(-90deg); }\n        #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart #sfly_wgt_sideopen_styles_left:before {\n          border-bottom: 10px solid #868686;\n          border-left: 12px solid transparent;\n          border-right: 12px solid transparent;\n          content: \"\";\n          height: 0;\n          left: 0;\n          position: absolute;\n          top: -10px;\n          width: 0; }\n        #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart #sfly_wgt_sideopen_styles_left:after {\n          border-bottom: 11px solid white;\n          border-left: 12px solid transparent;\n          border-right: 12px solid transparent;\n          content: \"\";\n          height: 0;\n          left: 0;\n          position: absolute;\n          top: -3px;\n          width: 0; }\n        #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart #sfly_wgt_sideopen_styles_left:hover {\n          background: #ed542f; }\n          #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart #sfly_wgt_sideopen_styles_left:hover:before {\n            border-bottom-color: #ed542f; }\n      #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart #sfly_wgt_sideopen_styles_right {\n        display: none;\n        position: absolute;\n        background: #868686;\n        height: 8px;\n        width: 24px;\n        top: 48px;\n        right: 20px;\n        cursor: pointer;\n        transform: rotate(90deg); }\n        #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart #sfly_wgt_sideopen_styles_right:before {\n          border-bottom: 10px solid #868686;\n          border-left: 12px solid transparent;\n          border-right: 12px solid transparent;\n          content: \"\";\n          height: 0;\n          left: 0;\n          position: absolute;\n          top: -10px;\n          width: 0; }\n        #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart #sfly_wgt_sideopen_styles_right:after {\n          border-bottom: 11px solid white;\n          border-left: 12px solid transparent;\n          border-right: 12px solid transparent;\n          content: \"\";\n          height: 0;\n          left: 0;\n          position: absolute;\n          top: -3px;\n          width: 0; }\n        #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart #sfly_wgt_sideopen_styles_right:hover {\n          background: #ed542f; }\n          #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart #sfly_wgt_sideopen_styles_right:hover:before {\n            border-bottom-color: #ed542f; }\n      #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart #sfly_wgt_sideopen_buttons {\n        text-align: center;\n        display: inline-block;\n        width: 100px;\n        position: relative;\n        top: -30px;\n        height: 63px;\n        bottom: 0; }\n        #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart #sfly_wgt_sideopen_buttons .sfly-wgt-lightlink {\n          color: #306293;\n          display: block;\n          padding: 0;\n          margin: 0;\n          display: inline-block;\n          position: relative;\n          top: 8px; }\n          #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart #sfly_wgt_sideopen_buttons .sfly-wgt-lightlink:hover {\n            text-decoration: underline; }\n        #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart #sfly_wgt_sideopen_buttons .sfly-wgt-orange-btn-sfly {\n          font-size: 14px;\n          padding: 0px 20px 0px 20px;\n          color: #fff; }\n      #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart #sfly_wgt_sideopen_styles_container {\n        width: 880px;\n        height: 85px;\n        position: relative;\n        display: block;\n        overflow: hidden;\n        margin-left: 50px;\n        padding: 0;\n        top: 20px; }\n        #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart #sfly_wgt_sideopen_styles_container #sfly_wgt_sideopen_styles {\n          -webkit-transform: translate3d(0, 0, 0);\n          -moz-transform: translate3d(0, 0, 0);\n          -ms-transform: translate3d(0, 0, 0);\n          -o-transform: translate3d(0, 0, 0);\n          transform: translate3d(0, 0, 0);\n          transition: transform .7s ease-in-out;\n          position: relative;\n          top: 0;\n          left: 0;\n          display: block; }\n          #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart #sfly_wgt_sideopen_styles_container #sfly_wgt_sideopen_styles .sfly-wgt-prod-style {\n            display: inline-block;\n            margin-right: 15px;\n            padding: 5px;\n            cursor: pointer; }\n            #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart #sfly_wgt_sideopen_styles_container #sfly_wgt_sideopen_styles .sfly-wgt-prod-style.sfly-bookstyle-selected .sfly_wgt_product_style_title, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart #sfly_wgt_sideopen_styles_container #sfly_wgt_sideopen_styles .sfly-wgt-prod-style.sfly-calstyle-selected .sfly_wgt_product_style_title {\n              color: #f05323; }\n            #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart #sfly_wgt_sideopen_styles_container #sfly_wgt_sideopen_styles .sfly-wgt-prod-style.sfly-bookstyle-selected .sfly_wgt_product_inner, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart #sfly_wgt_sideopen_styles_container #sfly_wgt_sideopen_styles .sfly-wgt-prod-style.sfly-calstyle-selected .sfly_wgt_product_inner {\n              border-color: #f05323;\n              cursor: default; }\n            #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart #sfly_wgt_sideopen_styles_container #sfly_wgt_sideopen_styles .sfly-wgt-prod-style:hover:not(.sfly-bookstyle-selected, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart #sfly_wgt_sideopen_styles_container #sfly_wgt_sideopen_styles .sfly-wgt-prod-style.sfly-calstyle-selected) {\n              cursor: pointer; }\n              #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart #sfly_wgt_sideopen_styles_container #sfly_wgt_sideopen_styles .sfly-wgt-prod-style:hover:not(.sfly-bookstyle-selected, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart #sfly_wgt_sideopen_styles_container #sfly_wgt_sideopen_styles .sfly-wgt-prod-style.sfly-calstyle-selected) .sfly_wgt_product_inner {\n                border-color: #c6c7c9; }\n            #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart #sfly_wgt_sideopen_styles_container #sfly_wgt_sideopen_styles .sfly-wgt-prod-style .sfly_wgt_product_inner {\n              padding: 2px 2px 0px;\n              border: 2px solid transparent;\n              margin-bottom: 2px; }\n            #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart #sfly_wgt_sideopen_styles_container #sfly_wgt_sideopen_styles .sfly-wgt-prod-style .sfly_wgt_product_style_title {\n              text-align: center;\n              font-size: 10px;\n              margin: 0;\n              height: 0;\n              white-space: nowrap; }\n    #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_no_enough_photos_popup {\n      top: 200px;\n      left: 110px;\n      font-size: 14px;\n      width: 453px;\n      padding: 20px 20px 0px 20px;\n      font-family: \"Avenir LT W01 65 Medium\", \"Avenir LT\", Verdana, Arial, sans-serif; }\n      #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_no_enough_photos_popup div {\n        line-height: 25px; }\n      #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_no_enough_photos_popup #sfly_wgt_no_enough_photos_button {\n        text-align: right;\n        margin-top: 5px; }\n        #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_no_enough_photos_popup #sfly_wgt_no_enough_photos_button .sfly-wgt-orange-btn-sfly {\n          padding: 0 20px; }\n    #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_no_enough_photos_bubble {\n      display: none;\n      position: absolute;\n      top: 24px;\n      right: 355px;\n      font-size: 16px;\n      z-index: 7009;\n      padding: 10px 20px;\n      font-family: \"Avenir LT W01 65 Medium\", \"Avenir LT\", Verdana, Arial, sans-serif;\n      border: 1px solid #f0f0f0;\n      border-radius: 5px;\n      background-color: #ffffff;\n      -webkit-box-shadow: 0px 2px 6px 0px rgba(102, 102, 102, 0.75);\n      -moz-box-shadow: 0px 2px 6px 0px rgba(102, 102, 102, 0.75);\n      box-shadow: 0px 2px 6px 0px rgba(102, 102, 102, 0.75); }\n      #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_no_enough_photos_bubble div {\n        line-height: 25px; }\n      #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_no_enough_photos_bubble #sfly_wgt_no_enough_photos_bubble_warning {\n        display: inline-block;\n        width: 16px;\n        height: 16px;\n        background-image: url(\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAALEgAACxIB0t1+/AAAABR0RVh0Q3JlYXRpb24gVGltZQAzLzEvMTIfY+T1AAAAHHRFWHRTb2Z0d2FyZQBBZG9iZSBGaXJld29ya3MgQ1M1cbXjNgAAAdNJREFUOI2lks9rE0EcxT+zk03bGDc2a6kQAv4otWIw0oAB0eIvFEQRIgodQrAlUeqleChYf54iPYgieMhf4J8ieLDioYLI9KKFggcPu1Wquzs9SNIY0xrwwfcw3/fm8XgzwhjD/0BsRWglnwE3gRWgdOBVuNRNZ21x+ayQsdLexrtwaPrJN+C5VnJnTwZayQTQcCv3VkWfcJInLxalk3aBcq8JalYy5e04fr4YBT5R4LPnbmMYuK+VHN7WQCuZBebcyh3LhD7NkWknkyhMfAIW/pVgNp7dt9x/OJc3oU+5Vqdcq2NCn8HJ6riQ8rRW8kJXA63kKJZ1ZXBqZn8UeESB1xJFgQd26KSuVVaBulbS7ZZgYeDI0S9yVyJjwjVMuNYimufEsUJRurt/Abf+MNBKFhDiRKp0edwEHs1pGbTt3NpUFsu6oZUcBbC0kgPAi+S5iY/YgdNe3maCzZ2Vimf6c2MrzUKFVnJSxO2HQ49uH+pseDt8ffxy2YThrAXMOVdP/TSBT+dU5xepzi/+tTeBj3P9jAc8jQE5eyRtt0fuRDfOHknnge8xYOnH2w/rfflssVPUePD7+7c/aRPr7z+/AZJCK3kJqAMHgViPFRjgNTCzAdRU0ipWkL2EAAAAAElFTkSuQmCC\"); }\n      #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_no_enough_photos_bubble #sfly_wgt_no_enough_photos_bubble_arrow {\n        width: 30px;\n        height: 30px;\n        position: absolute;\n        top: 18px;\n        right: -30px;\n        transform: rotate(90deg);\n        overflow: hidden;\n        box-shadow: 0 16px 10px -17px rgba(102, 102, 102, 0.75); }\n        #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_no_enough_photos_bubble #sfly_wgt_no_enough_photos_bubble_arrow:after {\n          content: \"\";\n          position: absolute;\n          width: 15px;\n          height: 15px;\n          background: #ffffff;\n          transform: rotate(45deg);\n          top: 22.5px;\n          left: 7.5px;\n          box-shadow: -1px -3px 6px -1px rgba(102, 102, 102, 0.75); }\n    #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products {\n      position: relative;\n      top: 30px;\n      left: 55px; }\n      #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products.sfly-wgt-prints {\n        top: 39px; }\n    #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container .sfly_wgt_product {\n      float: left;\n      text-align: center;\n      position: relative; }\n      #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container .sfly_wgt_product .sfly_wgt_product_inner {\n        position: relative; }\n        #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container .sfly_wgt_product .sfly_wgt_product_inner canvas {\n          width: auto !important;\n          max-height: 90% !important;\n          margin: 10px;\n          box-sizing: border-box; }\n    #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container .sfly-wgt-photobooks .sfly_wgt_product .sfly_wgt_product_inner canvas {\n      width: 100% !important; }\n    #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container .sfy_wgt_product_border {\n      border: 1px solid #FFF;\n      border-radius: 5px;\n      overflow: hidden; }\n      #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container .sfy_wgt_product_border:hover {\n        border-color: #b7c2cd; }\n    #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container .sfly_wgt_product_inner_action {\n      position: absolute;\n      display: flex;\n      width: 100%;\n      justify-content: center;\n      align-items: center;\n      bottom: 25px !important; }\n      #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container .sfly_wgt_product_inner_action .sfly_wgt_product_price {\n        bottom: 0px;\n        position: relative;\n        color: #336699;\n        white-space: nowrap;\n        overflow: hidden;\n        text-overflow: ellipsis; }\n        #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container .sfly_wgt_product_inner_action .sfly_wgt_product_price strong {\n          color: #336699;\n          font-family: \"Avenir LT W01 85 Heavy\", \"Avenir LT\", Verdana, Arial, sans-serif;\n          font-size: 11px;\n          font-weight: 300; }\n          #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container .sfly_wgt_product_inner_action .sfly_wgt_product_price strong:hover {\n            text-decoration: underline;\n            cursor: pointer; }\n    #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_container {\n      overflow-y: scroll;\n      -webkit-overflow-scrolling: touch;\n      width: 100%;\n      height: calc(100% - 90px);\n      position: relative; }\n      #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_container #sfly_wgt_sideopen_products_container_space {\n        height: 10px; }\n      #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_container #sfly_wgt_sideopen_products_inner_container {\n        position: relative;\n        overflow: hidden;\n        padding: 0 25px 20px 25px;\n        box-sizing: border-box;\n        list-style: none;\n        display: inline-flex;\n        flex-wrap: wrap;\n        width: 100%; }\n        #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_container #sfly_wgt_sideopen_products_inner_container .sfly_wgt_product {\n          cursor: pointer; }\n          #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_container #sfly_wgt_sideopen_products_inner_container .sfly_wgt_product #sfly_wgt_product_buttons {\n            visibility: hidden;\n            position: absolute;\n            left: 50%;\n            bottom: 50%;\n            -moz-transform: translate(-50%, 50%);\n            -o-transform: translate(-50%, 50%);\n            -ms-transform: translate(-50%, 50%);\n            -webkit-transform: translate(-50%, 50%);\n            transform: translate(-50%, 50%); }\n          #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_container #sfly_wgt_sideopen_products_inner_container .sfly_wgt_product:hover #sfly_wgt_product_buttons {\n            visibility: visible; }\n          #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_container #sfly_wgt_sideopen_products_inner_container .sfly_wgt_product:hover .sfly_wgt_product_price {\n            visibility: hidden; }\n        #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_container #sfly_wgt_sideopen_products_inner_container .sfly_wgt_product_placeholder {\n          width: 100%;\n          height: 100%; }\n          #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_container #sfly_wgt_sideopen_products_inner_container .sfly_wgt_product_placeholder span {\n            display: block;\n            background-color: #eee;\n            width: 100%; }\n            #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_container #sfly_wgt_sideopen_products_inner_container .sfly_wgt_product_placeholder span.sfly_wgt_item_placeholder_prod {\n              height: 80%;\n              width: 100%; }\n            #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_container #sfly_wgt_sideopen_products_inner_container .sfly_wgt_product_placeholder span.sfly_wgt_item_placeholder_line {\n              height: 6%;\n              margin: 0 auto;\n              margin-top: 8px;\n              width: 40%; }\n    #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_more_styles_produts {\n      clear: both;\n      padding: 10px 0;\n      text-align: center;\n      width: 100%;\n      display: none; }\n      #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_more_styles_produts .sfly-wgt-lightlink {\n        color: #306293; }\n        #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_more_styles_produts .sfly-wgt-lightlink:hover {\n          text-decoration: underline; }\n    #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container .sfly_wgt_bg_throbber {\n      display: none;\n      top: 235px;\n      left: 50%; }\n    #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly-wgt-popup-disable-overlay {\n      display: none;\n      position: absolute;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      background-color: #ffffff;\n      opacity: 0.75;\n      filter: alpha(opacity=75);\n      z-index: 8; }\n    #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container .sfly-wgt-modal-load-more {\n      text-align: center; }\n      #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container .sfly-wgt-modal-load-more .sfly-wgt-modal-load-more-action {\n        cursor: pointer;\n        margin-top: 10px;\n        display: inline-block; }\n        #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container .sfly-wgt-modal-load-more .sfly-wgt-modal-load-more-action:hover {\n          text-decoration: underline; }\n\n.sfly-wgt-btn-sidemodule {\n  width: 30px;\n  height: 65px;\n  background-color: #e4e4e5;\n  /*border: solid 2px #fff;*/\n  border: none;\n  position: fixed;\n  z-index: 6001;\n  cursor: pointer;\n  display: none;\n  /*\n  -webkit-transition: right 0.5s ease;\n  -moz-transition: right 0.5s ease;\n  -o-transition: right 0.5s ease;\n  transition: right 0.5s ease;\n  */ }\n  .sfly-wgt-btn-sidemodule .sfly-wgt-side-foryou {\n    font-size: 11px;\n    width: 51px;\n    float: right;\n    margin-right: 0px;\n    margin-top: 19px;\n    text-align: center;\n    color: #868686;\n    opacity: 0;\n    filter: alpha(opacity=0); }\n  .sfly-wgt-btn-sidemodule.open-state {\n    background-image: url(\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAwAAAAOCAYAAAAbvf3sAAAACXBIWXMAAAsTAAALEwEAmpwYAAAMKmlDQ1BQaG90b3Nob3AgSUNDIHByb2ZpbGUAAHjarVd3VFR3t923zAxl6EVAytCbIL2I9C4ISIdYGGYGGMowTEHFbgxRMHaxYEWjIkaNBZBYEDXYgmDvQQ0qkRgs2FD5/hjAxO+9P95a77fWnbXvnn3O2eesu+66B9Dw4IrFhaQmUCSSSRIjQzjpGZkc1u8gQEAJtvDh8qTi4ISEWPyv5811EABwxYkrFhfi/3a0+AIpDyASAGTzpbwigDgE0EY8sUQGMNoBWE6ViWUA4zUAXUl6RibAVAKgm6vAxgB0sxXYBYCuJDkxFGCGAUpsLleSC6gnAOCU8nJlgLoYgIuILxQB6lsABPDyuHxAvRPAqKKiYj6gwQZgl/2PPLn/ypk9nJPLzR3Gil4AAEphQqm4kDsd/9+nqFA+VMMCADtPEpUIQBcgdhUUxyQCYAPEUVF2XDwAbYA4K+QDg/h2njwqZVDfw5OGZgLQB0jwuWExAIwBUl9ekBI8iN24EkChJ+OEsujkQZwtKU4czE+WCqThSUM4TxAdO5hzoagwbghvyhFGRAPQBMhDZXnJaQqf5OlSYWocAHWAbJcWJMUM6u+X5YXGDWkk8sQUAFYA+TpHEpGo0FAGRdKhvihnHjc8CYABQAXJ8pKjFLFUukCaHjvkjS8IC1d4oPgCUcqgZ0omloUkDsaWiwsTBvXUJkFhZKJiztR+aWnSUOxlmSR5cObUw3zuuASFf+qNWJaQrPBG04hFKMLAgRwcZKMY+RC29TT0gDP4TwS4kCAXAjgNMkMRaeBCAhG4SEIZ/oIIAkiH40LAhQQClEKET8Os4tcJOeBCglIIIEUBHkOCItqIDqD96Fg6gA6iA2g32of2HYrjaAxVZYYzw5hRzAim/bAPHopRiGJIIPxv7ksk4zGjg/GQcY3RybiFGBRCADkkEEA03Fkq/oAEwqH7KcL5kq+cczAenZAPTkWAbIjQPaShbWg32pMOof3pANoXHFqfNoIT7UH70MF0IO1He9K+/3IoH3bxZZZf1xNA9K8eB3l1B3XPQRfZw/5Dh1VfZwn9x4z4KEbM10pqIXWQaqVOUueoo1QDONQJqpG6SB2jGv7xJPwBCXKHqyVCABEKUAjhkMalzqXb5eN/VecOOpBAACkgE0yTAUBosXi6RJibJ+MEi8WFAk60iOc8iuPm4uoJpGdkchSvj1f6IAAQ+ue/cCXNgG8FQOR+4biWwJHHgM6bL5zlS4C9DDjWzpNLShUcDQAMqEADujCEKSxhBye4wQt+CEI4xiEeycjAZPCQhyJIMBUzMQ/lqMQyrMZ6bMY27MJPOIAGHMVJ/IoLaMc13EEnuvAMvXiDfoIgWIQaoUMYEmaENeFIuBE+RAARTsQSiUQGkUXkEiJCTswkviUqiRXEemIrUUv8TBwhThLniA7iFvGA6CZeEh9IimSTuqQJaUOOJn3IYDKGTCYnkblkCVlGLiCXkGvJGnIPWU+eJC+Q18hO8hnZR4FSpfQpc8qJ8qFCqXgqk8qhJNRsqoKqomqovVQT1UpdoTqpHuo9zaR1aA7tRPvRUXQKzaNL6Nn0Yno9vYuup0/TV+gHdC/9maHGMGY4MsYwohnpjFzGVEY5o4qxg3GYcYZxjdHFeMNkMvWZtkxvZhQzg5nPnMFczNzI3MdsZnYwHzH7WCyWIcuR5c+KZ3FZMlY5ax1rD+sE6zKri/VOSVXJTMlNKUIpU0mkNF+pSmm30nGly0pPlPqVNZWtlccoxyvzlacrL1XertykfEm5S7lfRUvFVsVfJVklX2WeylqVvSpnVO6qvFJVVbVQ9VWdoCpUnau6VnW/6lnVB6rv2dpsB3YoeyJbzl7C3sluZt9iv1JTU7NRC1LLVJOpLVGrVTuldl/tnbqOurN6tDpffY56tXq9+mX15xrKGtYawRqTNco0qjQOalzS6NFU1rTRDNXkas7WrNY8onlDs09LR8tVK16rSGux1m6tc1pPtVnaNtrh2nztBdrbtE9pP9KhdCx1QnV4Ot/qbNc5o9Oly9S11Y3Wzdet1P1Jt023V09bz0MvVW+aXrXeMb1OfUrfRj9av1B/qf4B/ev6H0aYjAgeIRixaMTeEZdHvDUYaRBkIDCoMNhncM3ggyHHMNywwHC5YYPhPSPayMFogtFUo01GZ4x6RuqO9BvJG1kx8sDI28aksYNxovEM423GF437TExNIk3EJutMTpn0mOqbBpnmm64yPW7abaZjFmAmNFtldsLsT44eJ5hTyFnLOc3pNTc2jzKXm281bzPvt7C1SLGYb7HP4p6liqWPZY7lKssWy14rM6vxVjOt6qxuWytb+1jnWa+xbrV+a2Nrk2bzvU2DzVNbA9to2zLbOtu7dmp2gXYldjV2V+2Z9j72BfYb7dsdSAdPhzyHaodLjqSjl6PQcaNjxyjGKN9RolE1o244sZ2CnUqd6pweOOs7xzrPd25wfj7aanTm6OWjW0d/dvF0KXTZ7nLHVdt1nOt81ybXl24Objy3arer7mruEe5z3BvdX3g4egg8Nnnc9NTxHO/5vWeL5ycvby+J116vbm8r7yzvDd43fHR9EnwW+5z1ZfiG+M7xPer7fozXGNmYA2P+9nPyK/Db7fd0rO1YwdjtYx/5W/hz/bf6dwZwArICtgR0BpoHcgNrAh8GWQbxg3YEPQm2D84P3hP8PMQlRBJyOORt6JjQWaHNYVRYZFhFWFu4dnhK+Prw+xEWEbkRdRG9kZ6RMyKboxhRMVHLo25Em0Tzomuje8d5j5s17nQMOyYpZn3Mw1iHWEls03hy/LjxK8ffjbOOE8U1xCM+On5l/L0E24SShF8mMCckTKie8DjRNXFmYmuSTtKUpN1Jb5JDkpcm30mxS5GntKRqpE5MrU19mxaWtiKtM310+qz0CxlGGcKMxkxWZmrmjsy+b8K/Wf1N10TPieUTr0+ynTRt0rnJRpMLJx+bojGFO+VgFiMrLWt31kduPLeG25cdnb0hu5cXylvDe8YP4q/idwv8BSsET3L8c1bkPM31z12Z250XmFeV1yMMFa4XvsiPyt+c/7YgvmBnwUBhWuG+IqWirKIjIm1Rgeh0sWnxtOIOsaO4XNxZMqZkdUmvJEayQ0pIJ0kbZboyseyi3E7+nfxBaUBpdem7qalTD07TmiaadnG6w/RF05+URZT9OIOewZvRMtN85ryZD2YFz9o6m5idPbtljuWcBXO65kbO3TVPZV7BvN/mu8xfMf/1t2nfNi0wWTB3waPvIr+rK1cvl5Tf+N7v+80L6YXChW2L3BetW/S5gl9xvtKlsqry42Le4vM/uP6w9oeBJTlL2pZ6Ld20jLlMtOz68sDlu1ZorShb8Wjl+JX1qzirKla9Xj1l9bkqj6rNa1TWyNd0ro1d27jOat2ydR/X562/Vh1SvW+D8YZFG95u5G+8vClo097NJpsrN3/YItxyc2vk1voam5qqbcxtpdseb0/d3vqjz4+1O4x2VO74tFO0s3NX4q7Ttd61tbuNdy+tI+vkdd17Ju5p/ynsp8a9Tnu37tPfV7kf++X7//w56+frB2IOtBz0Obj3kPWhDYd1DlfUE/XT63sb8ho6GzMaO46MO9LS5Nd0+BfnX3YeNT9afUzv2NLjKscXHB84UXair1nc3HMy9+Sjliktd06ln7p6esLptjMxZ87+GvHrqdbg1hNn/c8ePTfm3JHzPucbLnhdqL/oefHwb56/HW7zaqu/5H2psd23valjbMfxy4GXT14Ju/Lr1eirF67FXeu4nnL95o2JNzpv8m8+vVV468Xt0tv9d+beZdytuKd5r+q+8f2a3+1/39fp1XnsQdiDiw+THt55xHv07A/pHx+7FjxWe1z1xOxJ7VO3p0e7I7rb//zmz65n4mf9PeV/af214bnd80N/B/19sTe9t+uF5MXAy8WvDF/tfO3xuqUvoe/+m6I3/W8r3hm+2/Xe533rh7QPT/qnfmR9XPvJ/lPT55jPdweKBgbEXAkXAEABIHNygJc7AbUMQKcdUFFX7F8AAEKxMwKKb5D/GSt2NACAF7AzCEiZC8Q2A5uaAeu5ALsZSACQHATS3X34GjzSHHc3RS62BGC8Gxh4ZQKwmoBPkoGB/o0DA5+2A9QtoLlEsfcBAFMT2GIBAL9ZVt78ev/6D47Ga/BIEfcxAAAAIGNIUk0AAG11AABzoAAA/N0AAINkAABw6AAA7GgAADA+AAAQkOTsmeoAAADZSURBVHjalNIhTwNBEMXxX5dQUYPqN6jEI3A4RCsQJASHJCHo+wKncAhcTUUdJCBwBFuNReBRGARJU8y75NLckTBm82bmzWz+u4O6rnXEORYYRN9VVXUJpaP5EPNW8yOumuK2YYIHDKNXOMO6yzDGc074wBTf7YmNYYSnbIAvzPC5fd+CHSxxkNwPTvDWRaPgJtNggwu86ImCXf+IguugE5RzHP1lWAfdKrkh7rHfZxB0U7xH7+U9xn0GQXjcQjkJ6lGfQTacBq2gXga9vr/0GrSb6Blum+LvAKT5JxkK87/8AAAAAElFTkSuQmCC\");\n    background-repeat: no-repeat;\n    background-position: 13px 25px;\n    -webkit-border-top-left-radius: 40px;\n    -webkit-border-bottom-left-radius: 40px;\n    -moz-border-radius-topleft: 40px;\n    -moz-border-radius-bottomleft: 40px;\n    border-top-left-radius: 40px;\n    border-bottom-left-radius: 40px; }\n    .sfly-wgt-btn-sidemodule.open-state:hover {\n      background-image: url(\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAwAAAAOCAYAAAAbvf3sAAAACXBIWXMAAAsTAAALEwEAmpwYAAAMKmlDQ1BQaG90b3Nob3AgSUNDIHByb2ZpbGUAAHjarVd3VFR3t923zAxl6EVAytCbIL2I9C4ISIdYGGYGGMowTEHFbgxRMHaxYEWjIkaNBZBYEDXYgmDvQQ0qkRgs2FD5/hjAxO+9P95a77fWnbXvnn3O2eesu+66B9Dw4IrFhaQmUCSSSRIjQzjpGZkc1u8gQEAJtvDh8qTi4ISEWPyv5811EABwxYkrFhfi/3a0+AIpDyASAGTzpbwigDgE0EY8sUQGMNoBWE6ViWUA4zUAXUl6RibAVAKgm6vAxgB0sxXYBYCuJDkxFGCGAUpsLleSC6gnAOCU8nJlgLoYgIuILxQB6lsABPDyuHxAvRPAqKKiYj6gwQZgl/2PPLn/ypk9nJPLzR3Gil4AAEphQqm4kDsd/9+nqFA+VMMCADtPEpUIQBcgdhUUxyQCYAPEUVF2XDwAbYA4K+QDg/h2njwqZVDfw5OGZgLQB0jwuWExAIwBUl9ekBI8iN24EkChJ+OEsujkQZwtKU4czE+WCqThSUM4TxAdO5hzoagwbghvyhFGRAPQBMhDZXnJaQqf5OlSYWocAHWAbJcWJMUM6u+X5YXGDWkk8sQUAFYA+TpHEpGo0FAGRdKhvihnHjc8CYABQAXJ8pKjFLFUukCaHjvkjS8IC1d4oPgCUcqgZ0omloUkDsaWiwsTBvXUJkFhZKJiztR+aWnSUOxlmSR5cObUw3zuuASFf+qNWJaQrPBG04hFKMLAgRwcZKMY+RC29TT0gDP4TwS4kCAXAjgNMkMRaeBCAhG4SEIZ/oIIAkiH40LAhQQClEKET8Os4tcJOeBCglIIIEUBHkOCItqIDqD96Fg6gA6iA2g32of2HYrjaAxVZYYzw5hRzAim/bAPHopRiGJIIPxv7ksk4zGjg/GQcY3RybiFGBRCADkkEEA03Fkq/oAEwqH7KcL5kq+cczAenZAPTkWAbIjQPaShbWg32pMOof3pANoXHFqfNoIT7UH70MF0IO1He9K+/3IoH3bxZZZf1xNA9K8eB3l1B3XPQRfZw/5Dh1VfZwn9x4z4KEbM10pqIXWQaqVOUueoo1QDONQJqpG6SB2jGv7xJPwBCXKHqyVCABEKUAjhkMalzqXb5eN/VecOOpBAACkgE0yTAUBosXi6RJibJ+MEi8WFAk60iOc8iuPm4uoJpGdkchSvj1f6IAAQ+ue/cCXNgG8FQOR+4biWwJHHgM6bL5zlS4C9DDjWzpNLShUcDQAMqEADujCEKSxhBye4wQt+CEI4xiEeycjAZPCQhyJIMBUzMQ/lqMQyrMZ6bMY27MJPOIAGHMVJ/IoLaMc13EEnuvAMvXiDfoIgWIQaoUMYEmaENeFIuBE+RAARTsQSiUQGkUXkEiJCTswkviUqiRXEemIrUUv8TBwhThLniA7iFvGA6CZeEh9IimSTuqQJaUOOJn3IYDKGTCYnkblkCVlGLiCXkGvJGnIPWU+eJC+Q18hO8hnZR4FSpfQpc8qJ8qFCqXgqk8qhJNRsqoKqomqovVQT1UpdoTqpHuo9zaR1aA7tRPvRUXQKzaNL6Nn0Yno9vYuup0/TV+gHdC/9maHGMGY4MsYwohnpjFzGVEY5o4qxg3GYcYZxjdHFeMNkMvWZtkxvZhQzg5nPnMFczNzI3MdsZnYwHzH7WCyWIcuR5c+KZ3FZMlY5ax1rD+sE6zKri/VOSVXJTMlNKUIpU0mkNF+pSmm30nGly0pPlPqVNZWtlccoxyvzlacrL1XertykfEm5S7lfRUvFVsVfJVklX2WeylqVvSpnVO6qvFJVVbVQ9VWdoCpUnau6VnW/6lnVB6rv2dpsB3YoeyJbzl7C3sluZt9iv1JTU7NRC1LLVJOpLVGrVTuldl/tnbqOurN6tDpffY56tXq9+mX15xrKGtYawRqTNco0qjQOalzS6NFU1rTRDNXkas7WrNY8onlDs09LR8tVK16rSGux1m6tc1pPtVnaNtrh2nztBdrbtE9pP9KhdCx1QnV4Ot/qbNc5o9Oly9S11Y3Wzdet1P1Jt023V09bz0MvVW+aXrXeMb1OfUrfRj9av1B/qf4B/ev6H0aYjAgeIRixaMTeEZdHvDUYaRBkIDCoMNhncM3ggyHHMNywwHC5YYPhPSPayMFogtFUo01GZ4x6RuqO9BvJG1kx8sDI28aksYNxovEM423GF437TExNIk3EJutMTpn0mOqbBpnmm64yPW7abaZjFmAmNFtldsLsT44eJ5hTyFnLOc3pNTc2jzKXm281bzPvt7C1SLGYb7HP4p6liqWPZY7lKssWy14rM6vxVjOt6qxuWytb+1jnWa+xbrV+a2Nrk2bzvU2DzVNbA9to2zLbOtu7dmp2gXYldjV2V+2Z9j72BfYb7dsdSAdPhzyHaodLjqSjl6PQcaNjxyjGKN9RolE1o244sZ2CnUqd6pweOOs7xzrPd25wfj7aanTm6OWjW0d/dvF0KXTZ7nLHVdt1nOt81ybXl24Objy3arer7mruEe5z3BvdX3g4egg8Nnnc9NTxHO/5vWeL5ycvby+J116vbm8r7yzvDd43fHR9EnwW+5z1ZfiG+M7xPer7fozXGNmYA2P+9nPyK/Db7fd0rO1YwdjtYx/5W/hz/bf6dwZwArICtgR0BpoHcgNrAh8GWQbxg3YEPQm2D84P3hP8PMQlRBJyOORt6JjQWaHNYVRYZFhFWFu4dnhK+Prw+xEWEbkRdRG9kZ6RMyKboxhRMVHLo25Em0Tzomuje8d5j5s17nQMOyYpZn3Mw1iHWEls03hy/LjxK8ffjbOOE8U1xCM+On5l/L0E24SShF8mMCckTKie8DjRNXFmYmuSTtKUpN1Jb5JDkpcm30mxS5GntKRqpE5MrU19mxaWtiKtM310+qz0CxlGGcKMxkxWZmrmjsy+b8K/Wf1N10TPieUTr0+ynTRt0rnJRpMLJx+bojGFO+VgFiMrLWt31kduPLeG25cdnb0hu5cXylvDe8YP4q/idwv8BSsET3L8c1bkPM31z12Z250XmFeV1yMMFa4XvsiPyt+c/7YgvmBnwUBhWuG+IqWirKIjIm1Rgeh0sWnxtOIOsaO4XNxZMqZkdUmvJEayQ0pIJ0kbZboyseyi3E7+nfxBaUBpdem7qalTD07TmiaadnG6w/RF05+URZT9OIOewZvRMtN85ryZD2YFz9o6m5idPbtljuWcBXO65kbO3TVPZV7BvN/mu8xfMf/1t2nfNi0wWTB3waPvIr+rK1cvl5Tf+N7v+80L6YXChW2L3BetW/S5gl9xvtKlsqry42Le4vM/uP6w9oeBJTlL2pZ6Ld20jLlMtOz68sDlu1ZorShb8Wjl+JX1qzirKla9Xj1l9bkqj6rNa1TWyNd0ro1d27jOat2ydR/X562/Vh1SvW+D8YZFG95u5G+8vClo097NJpsrN3/YItxyc2vk1voam5qqbcxtpdseb0/d3vqjz4+1O4x2VO74tFO0s3NX4q7Ttd61tbuNdy+tI+vkdd17Ju5p/ynsp8a9Tnu37tPfV7kf++X7//w56+frB2IOtBz0Obj3kPWhDYd1DlfUE/XT63sb8ho6GzMaO46MO9LS5Nd0+BfnX3YeNT9afUzv2NLjKscXHB84UXair1nc3HMy9+Sjliktd06ln7p6esLptjMxZ87+GvHrqdbg1hNn/c8ePTfm3JHzPucbLnhdqL/oefHwb56/HW7zaqu/5H2psd23valjbMfxy4GXT14Ju/Lr1eirF67FXeu4nnL95o2JNzpv8m8+vVV468Xt0tv9d+beZdytuKd5r+q+8f2a3+1/39fp1XnsQdiDiw+THt55xHv07A/pHx+7FjxWe1z1xOxJ7VO3p0e7I7rb//zmz65n4mf9PeV/af214bnd80N/B/19sTe9t+uF5MXAy8WvDF/tfO3xuqUvoe/+m6I3/W8r3hm+2/Xe533rh7QPT/qnfmR9XPvJ/lPT55jPdweKBgbEXAkXAEABIHNygJc7AbUMQKcdUFFX7F8AAEKxMwKKb5D/GSt2NACAF7AzCEiZC8Q2A5uaAeu5ALsZSACQHATS3X34GjzSHHc3RS62BGC8Gxh4ZQKwmoBPkoGB/o0DA5+2A9QtoLlEsfcBAFMT2GIBAL9ZVt78ev/6D47Ga/BIEfcxAAAAIGNIUk0AAG11AABzoAAA/N0AAINkAABw6AAA7GgAADA+AAAQkOTsmeoAAADaSURBVHjalNIhS4NRFMbx3664sLK0T+Ci3WCzGbagIIjNKIhfxGawrSysiMIWbGJdti7YLVoMwpjleeFlvK/gKZfnnPOcc/nf2/k83dMQF5iiE33ff1hdQWloPsSk1jzHdVXcNgzxhG70EudYNxkGeM4J7xjhuz6xMvSwyAb4whgf2/ct2MEMB8n94ARvTTQKbjMNNrjEi5Yo2PWPKLgJOkE5wdFfhnXQLZPr4hH7bQZBN8Iqup/3GLQZBOFxDeUwqHttBtlwFrSCehb02v7Sa9Buose4q4q/AwCeGScZoJoGGQAAAABJRU5ErkJggg==\"); }\n  .sfly-wgt-btn-sidemodule[data-state=\"full\"] {\n    transform: rotate(180deg) translate(-31px);\n    -ms-transform: rotate(180deg) translate(-31px);\n    -webkit-transform: rotate(180deg) translate(-31px);\n    -moz-transform: rotate(180deg) translate(-31px); }\n  .sfly-wgt-btn-sidemodule[data-state=\"open\"] {\n    transition: width 0.2s; }\n  .sfly-wgt-btn-sidemodule[data-state=\"closed\"] {\n    width: 75px;\n    transition: width 0.2s; }\n    .sfly-wgt-btn-sidemodule[data-state=\"closed\"] .sfly-wgt-side-foryou {\n      transition: opacity 0.2s;\n      transition-delay: 0.2s;\n      opacity: 1;\n      filter: alpha(opacity=100); }\n  .sfly-wgt-btn-sidemodule:hover {\n    background-color: #d7d7d8; }\n\n.sfly-wgt-qst-mark:after, .sfly-wgt-qst-mark:before {\n  width: 2px;\n  height: 18px;\n  background: #4b525c;\n  position: absolute;\n  content: \'\';\n  left: 50%;\n  top: 50%;\n  z-index: 2;\n  margin: -9px 0 0 -1px;\n  -moz-transform: rotate(45deg);\n  -o-transform: rotate(45deg);\n  -ms-transform: rotate(45deg);\n  -webkit-transform: rotate(45deg);\n  transform: rotate(45deg); }\n.sfly-wgt-qst-mark:after {\n  -moz-transform: rotate(-45deg);\n  -o-transform: rotate(-45deg);\n  -ms-transform: rotate(-45deg);\n  -webkit-transform: rotate(-45deg);\n  transform: rotate(-45deg); }\n\n.sfy_wgt_messageBox {\n  position: absolute;\n  border: 1px solid #c6c7c9;\n  background: #fcfcfc;\n  -moz-border-radius: 10px;\n  border-radius: 10px;\n  font-family: \"Avenir LT W01 85 Heavy\", \"Avenir LT\", Verdana, Arial, sans-serif;\n  color: #383838;\n  font-size: 12px;\n  z-index: 1000000;\n  padding: 10px;\n  width: 326px;\n  height: 95px;\n  display: none; }\n  .sfy_wgt_messageBox h3 {\n    font-size: 14px;\n    color: #f05323;\n    margin: 5px 0 5px 0; }\n  .sfy_wgt_messageBox .sfy_wgt_learnMoreClose {\n    background-image: url(\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACkAAAATCAYAAAANgSQ9AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyRpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoTWFjaW50b3NoKSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDo0NTEyNjdBREI3MjYxMUU0OUYyOUFFQkI0Q0RDODMxQyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDo0NTEyNjdBRUI3MjYxMUU0OUYyOUFFQkI0Q0RDODMxQyI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOjQ1MTI2N0FCQjcyNjExRTQ5RjI5QUVCQjRDREM4MzFDIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjQ1MTI2N0FDQjcyNjExRTQ5RjI5QUVCQjRDREM4MzFDIi8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+Y6Sl8AAAA/9JREFUeNrUlstPG1cUh38zHj9awDwc8xCYCkVAeIYIimREd7Bg0U0lFl2w7CISD6UikZIIhMQiCypVCVXb/yCLIFVqF2zaVRcIBHKpeAtBQg0YY2wX/Jyxcc6ZMBZYjNMAi2ako+vx3Pvd87rnXCGVSuH//kiZf5DSksfjuUfScnx87FAUxWI0GmNWq/Wf0tLSv0hcgiAkrrLZVdnCeU+63W7nyspKb0lJyQMS0GKYTCbIsgyC4uDggOX7+vr6VxUVFTMfouB12GklNzY2vtzd3XW2tLQ8zsvL0yzHeSNEUVSBi4uLz8rLy2dqamp++y8KXpetKrmzs/MFg5xO50O27vT0VBUNxEJhSEsikcDs7OwEgyorK//MpuBNsCXOE5fL9U1HR0efJEmgPEEymbwASlt0BmKrGxoaHs7NzZU6HI4ZvRy9KbZIYVDsdnsfh4Eh8XhclfX1dZycnKiWhUIhDpn6nXOIv5vNZthstj7ONT0vEvvzy9jhrVXEw+/YSiSE6Ov1rGxxe3sbZWVl6gINwgoNDQ1hfHwcfr8fIyMjGB4eBs9VwWdAAmFra6tbT0ma35XJjr7ZgGdiEP4fn0IOHuHghyfwfjcI2b2pyxa9Xi/YUs0KnlRcXIzm5mbs7e1hdHQU+/v76OzsRFVVlRoiDUblAz6f746eksRuymSnCothudMKo/cN4s8fwESj7a4TORW3ddliOByGwWBIQ3gSvw8MDKCoqAj5+fmoq6tT3/nhDXkOC0Np/S09JflbJjspGPBJbz9gd8Cca4XVcRu5fY+gQNBliwxhRXkCC8P4fXJyEpFIBAUFBcjJycHU1BQODw/Tc3jkXKX1uoWdv2Wy5WgUgd+nIJs+hVjigJSbj/gfrxD06bNF9ha5Ne1mHjnMLFTX0N/fD6pbHDrEYjH1dPIcBgWDQfb0az0lib2ZyZb/9eM0FoG55i4MvYNQqhqgREOwpJK6bIFOcWp5eRmNjY2qElpZYK9RrVJ/80YMoE6gHiTekIUrQFtb21e1tbW/6BVxYv+ayRZjIdjKP4NCzONgAHmSCHORXZctVldXG+kUegKBQNoSlsLCQtUaVpDhnBasOG/GwkDqwb5sXYfY05exZckCH60/OjqCnEjCH09kZYtcLLu6uh5R8dyMUr6cT15+18LEI+co/8fta3V11d3d3f1ttsvGTbENY2NjoIb/N1lQMD8/X00lw8qVX+sKPGpe4FPK3l1bW/O0trb+3N7ePvm+vn0T7Au3oIWFhfvT09MvqEtIHG4+1Vo741PqfxeiRE9PzyCBfvqQW9B12ELmpZcssywtLX3NQkX8HtcqAvqoc7iop75samp6SfkZu8p98qps4WO4mb8VYADbpTk0UpnvHwAAAABJRU5ErkJggg==\");\n    width: 17px;\n    height: 17px;\n    display: inline-block;\n    position: absolute;\n    right: 5px;\n    top: 5px;\n    cursor: pointer;\n    background-position: 0px 18px; }\n    .sfy_wgt_messageBox .sfy_wgt_learnMoreClose:hover {\n      background-position: 18px 18px; }\n\n#sfly-wgt-background-overlay {\n  position: fixed;\n  top: 85px;\n  left: 0;\n  width: 100%;\n  height: 100%; }\n\n.sfly_wgt_bubble_new_upp {\n  position: absolute;\n  top: 28px;\n  right: 185px;\n  z-index: 7000;\n  padding: 10px 20px;\n  max-width: 220px;\n  font-size: 14px;\n  font-family: \"Avenir LT W01 35 Light\", \"Avenir LT\", Verdana, Arial, sans-serif;\n  border: 1px solid #f0f0f0;\n  border-radius: 5px;\n  background-color: #ffffff;\n  -webkit-box-shadow: 0px 2px 6px 0px rgba(102, 102, 102, 0.75);\n  -moz-box-shadow: 0px 2px 6px 0px rgba(102, 102, 102, 0.75);\n  box-shadow: 0px 2px 6px 0px rgba(102, 102, 102, 0.75); }\n  .sfly_wgt_bubble_new_upp div {\n    line-height: 20px; }\n  .sfly_wgt_bubble_new_upp .sfly_wgt_bubble_new_upp_title {\n    font-family: \"Avenir LT W01 85 Heavy\", \"Avenir LT\", Verdana, Arial, sans-serif;\n    font-size: 15px;\n    color: #f05323; }\n  .sfly_wgt_bubble_new_upp .sfly_wgt_bubble_new_upp_close {\n    text-align: right;\n    margin-top: 10px; }\n    .sfly_wgt_bubble_new_upp .sfly_wgt_bubble_new_upp_close div.sfly-wgt-orange-btn-sfly {\n      line-height: 22px;\n      padding: 0 18px;\n      font-family: \"Avenir LT W01 35 Light\", \"Avenir LT\", Verdana, Arial, sans-serif; }\n  .sfly_wgt_bubble_new_upp .sfly_wgt_bubble_new_upp_arrow {\n    width: 30px;\n    height: 30px;\n    position: absolute;\n    top: 8px;\n    right: -30px;\n    transform: rotate(90deg);\n    overflow: hidden;\n    box-shadow: 0 16px 10px -17px rgba(102, 102, 102, 0.75); }\n    .sfly_wgt_bubble_new_upp .sfly_wgt_bubble_new_upp_arrow:after {\n      content: \"\";\n      position: absolute;\n      width: 15px;\n      height: 15px;\n      background: #ffffff;\n      transform: rotate(45deg);\n      top: 22.5px;\n      left: 7.5px;\n      box-shadow: -1px -3px 6px -1px rgba(102, 102, 102, 0.75); }\n    .sfly_wgt_bubble_new_upp .sfly_wgt_bubble_new_upp_arrow.sfly_wgt_bubble_new_upp_arrow_hp {\n      top: -4px; }\n  .sfly_wgt_bubble_new_upp.sfly_wgt_bubble_new_upp_hp {\n    top: 5px;\n    right: 130px; }\n\n/* ==== TIMELINE        ====== */\n.timeline-product-wrapper {\n  width: 170px;\n  margin: 0 auto; }\n\n/* ==== LOADING ANIMATION ==== */\n.sfly-wgt-loading-wrapper {\n  width: 100%;\n  height: 100%;\n  background-color: #fff;\n  position: relative;\n  z-index: 50; }\n  .sfly-wgt-loading-wrapper .sfly-wgt-loading-inner {\n    width: 104px;\n    height: 78px;\n    position: relative;\n    margin: 0 auto; }\n  .sfly-wgt-loading-wrapper .sfly-wgt-loading-transp, .sfly-wgt-loading-wrapper .sfly-wgt-loading-bg {\n    width: 104px;\n    height: 78px;\n    position: absolute;\n    bottom: 0;\n    left: 0; }\n  .sfly-wgt-loading-wrapper .sfly-wgt-loading-bg {\n    height: 0;\n    background-color: #ee5628; }\n\n/* ==== END LOADING       ==== */\n/* ==== CLICK THROUGH MODAL == */\n.sfly_wgt_modal_wrapper {\n  width: 100%;\n  height: 100%;\n  position: fixed;\n  top: 0;\n  left: 0;\n  z-index: 10000; }\n  .sfly_wgt_modal_wrapper .sfly_wgt_modal_bg {\n    position: fixed;\n    top: 0;\n    left: 0;\n    width: 100%;\n    height: 100%;\n    background-color: #000;\n    opacity: 0.6;\n    filter: alpha(opacity=60); }\n  .sfly_wgt_modal_wrapper .sfly_wgt_transfer {\n    position: fixed;\n    top: 50%;\n    left: 50%;\n    margin-left: -249px;\n    margin-top: -157px;\n    width: 498px;\n    height: 313px;\n    z-index: 10;\n    background-image: url(\"https://d22bbwxztp2lry.cloudfront.net/productswidget/Shutterfly/sidewidget/images/prod/widget/sfly_wgt_transfer.png\"); }\n    .sfly_wgt_modal_wrapper .sfly_wgt_transfer .sfly_wgt_transfer_spinner {\n      position: absolute;\n      top: 220px;\n      left: 230px;\n      -webkit-animation-name: rotateClockwise;\n      animation-name: rotateClockwise;\n      -webkit-animation-duration: 1500ms;\n      animation-duration: 1500ms;\n      -webkit-animation-iteration-count: infinite;\n      animation-iteration-count: infinite;\n      -webkit-animation-timing-function: linear;\n      animation-timing-function: linear; }\n\n/* ==== END MODAL           == */\n/* ==== LOADING ANIMATION === */\n.sfly_wgt_loading .sfly_wgt_throbber {\n  display: block;\n  z-index: 15; }\n\n.sfly_wgt_throbber, .sfly_wgt_bg_throbber {\n  width: 100px;\n  height: 100px;\n  position: absolute;\n  top: 50%;\n  left: 50%;\n  margin-top: -50px;\n  margin-left: -50px; }\n  .sfly_wgt_throbber.cover, .sfly_wgt_bg_throbber.cover {\n    position: absolute; }\n\n.sfly_wgt_throbber:after, .sfly_wgt_bg_throbber:after {\n  display: block;\n  position: relative;\n  width: 100px;\n  height: 100px;\n  border-radius: 100%;\n  border-top: 6px solid #767d8d;\n  border-left: 6px solid #767d8d;\n  border-bottom: 6px solid #e7e7e9;\n  border-right: 6px solid #e7e7e9;\n  content: \'\';\n  opacity: 0.5;\n  filter: alpha(opacity=50);\n  -webkit-animation-name: rotateClockwise;\n  animation-name: rotateClockwise;\n  -webkit-animation-duration: 600ms;\n  animation-duration: 600ms;\n  -webkit-animation-iteration-count: infinite;\n  animation-iteration-count: infinite;\n  -webkit-animation-timing-function: linear;\n  animation-timing-function: linear; }\n\n#sfly_wgt_openwin_container .sfly_wgt_throbber_overlay, #sfly_wgt_full_openwin_container .sfly_wgt_throbber_overlay, #sfly_wgt_container .sfly_wgt_disable_overlay, .sfly_wgt_listview_container .sfly_wgt_throbber_overlay {\n  z-index: 1000;\n  height: 100%;\n  width: 100%;\n  background-color: #fff;\n  position: absolute;\n  top: 0;\n  left: 0;\n  opacity: 0.5;\n  filter: alpha(opacity=50); }\n\n#sfly_wgt_full_openwin_container .sfly_wgt_throbber_overlay {\n  z-index: 7000; }\n\n/* ==== END LOADING ANIM ==== */\n/* ==== STORE ANIMATION ==== */\n#sfly-wgt-store-flyout {\n  display: block;\n  width: 375px;\n  height: 120px;\n  background-color: #f05323;\n  position: absolute;\n  top: 80px;\n  left: -375px;\n  text-decoration: none; }\n  #sfly-wgt-store-flyout p {\n    padding: 30px;\n    font-size: 18px;\n    color: #fff; }\n    #sfly-wgt-store-flyout p.sfly-wgt-store-flyout-welcome {\n      padding: 15px; }\n    #sfly-wgt-store-flyout p.sfly-wgt-store-flyout-no-photos {\n      padding: 10px; }\n  #sfly-wgt-store-flyout.show {\n    transition: all 200ms;\n    -webkit-transition: all 200ms;\n    left: 0px; }\n\n/* ==== END STORE ANIMATION ==== */\n#sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container.use-new-style-guide #sfly_wgt_no_enough_photos_bubble {\n  right: 425px; }\n#sfly_wgt_full_openwin_container.sfly-wgt-modal-small-titles #sfly_wgt_sideopen_container.use-new-style-guide #sfly_wgt_no_enough_photos_bubble {\n  right: 315px; }\n\n#sfly_wgt_full_openwin_container #sfly_wgt_sideopen_left_pane {\n  font-family: \"Avenir LT\", Verdana, Arial, sans-serif;\n  display: none;\n  width: 200px;\n  height: 100%;\n  float: left;\n  padding: 30px;\n  box-sizing: border-box; }\n  #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_left_pane:after {\n    border-right: solid thin #b7c2cd;\n    position: absolute;\n    top: 10px;\n    bottom: 10px;\n    left: 200px;\n    content: \'\'; }\n  #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_left_pane #sfly_wgt_sideopen_left_pane_product_container {\n    height: 100%;\n    overflow-y: auto;\n    padding-right: 20px;\n    width: 150px; }\n    #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_left_pane #sfly_wgt_sideopen_left_pane_product_container #sfly-wgt-left-pane-content {\n      margin-top: 40px; }\n      #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_left_pane #sfly_wgt_sideopen_left_pane_product_container #sfly-wgt-left-pane-content ul.sfly-wgt-left-pane-category {\n        color: #181512;\n        font-size: 14px;\n        line-height: 20px;\n        font-weight: 700;\n        margin-top: 0;\n        margin-bottom: 20px; }\n        #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_left_pane #sfly_wgt_sideopen_left_pane_product_container #sfly-wgt-left-pane-content ul.sfly-wgt-left-pane-category li.sfly-wgt-left-pane-category-product {\n          cursor: pointer;\n          color: #58595b;\n          font-size: 12px;\n          font-weight: 300;\n          line-height: 18px; }\n          #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_left_pane #sfly_wgt_sideopen_left_pane_product_container #sfly-wgt-left-pane-content ul.sfly-wgt-left-pane-category li.sfly-wgt-left-pane-category-product.sfly-wgt-left-pane-category-product-selected {\n            color: #f05323;\n            font-weight: 500;\n            cursor: default; }\n          #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_left_pane #sfly_wgt_sideopen_left_pane_product_container #sfly-wgt-left-pane-content ul.sfly-wgt-left-pane-category li.sfly-wgt-left-pane-category-product:not(.sfly-wgt-left-pane-category-product-selected):hover {\n            color: #f05323;\n            font-weight: 300;\n            cursor: pointer; }\n#sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container.left-pane-visible {\n  width: calc(100% - 200px);\n  float: left; }\n  #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container.left-pane-visible #sfly_wgt_sideopen_products_header {\n    height: 75px; }\n    #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container.left-pane-visible #sfly_wgt_sideopen_products_header #sfly_wgt_sideopen_title {\n      top: 32px; }\n      #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container.left-pane-visible #sfly_wgt_sideopen_products_header #sfly_wgt_sideopen_title > h2, #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container.left-pane-visible #sfly_wgt_sideopen_products_header #sfly_wgt_sideopen_title > h4 {\n        display: inline-block; }\n    #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container.left-pane-visible #sfly_wgt_sideopen_products_header #sfly_wgt_upp {\n      top: 32px; }\n\n.no-scroll {\n  overflow: hidden;\n  position: absolute;\n  width: 100%; }\n\n/* new modal menu */\n.sfly-wgt-modal-sub-menu-content {\n  padding: 26px 13px;\n  text-align: left; }\n  .sfly-wgt-modal-sub-menu-content ul.sfly-wgt-left-pane-category {\n    color: #181512;\n    font-size: 14px;\n    line-height: 20px;\n    font-weight: 900;\n    margin-top: 0;\n    margin-bottom: 20px; }\n    @media (max-width: 991px) {\n      .sfly-wgt-modal-sub-menu-content ul.sfly-wgt-left-pane-category {\n        font-size: 12px; } }\n    .sfly-wgt-modal-sub-menu-content ul.sfly-wgt-left-pane-category .sfly-wgt-left-pane-category-title {\n      text-transform: uppercase;\n      color: #58595b;\n      font-weight: 700; }\n    .sfly-wgt-modal-sub-menu-content ul.sfly-wgt-left-pane-category li.sfly-wgt-left-pane-category-product {\n      width: 100%;\n      cursor: pointer;\n      color: #58595b;\n      font-size: 12px;\n      font-weight: 500;\n      line-height: 20px; }\n      @media (max-width: 991px) {\n        .sfly-wgt-modal-sub-menu-content ul.sfly-wgt-left-pane-category li.sfly-wgt-left-pane-category-product {\n          font-size: 10px; } }\n      .sfly-wgt-modal-sub-menu-content ul.sfly-wgt-left-pane-category li.sfly-wgt-left-pane-category-product .sfly-wgt-left-pane-category-product-title {\n        white-space: nowrap;\n        overflow: hidden;\n        text-overflow: ellipsis; }\n      .sfly-wgt-modal-sub-menu-content ul.sfly-wgt-left-pane-category li.sfly-wgt-left-pane-category-product.sfly-wgt-left-pane-category-product-selected {\n        color: #f05323;\n        font-weight: 500;\n        cursor: default; }\n      .sfly-wgt-modal-sub-menu-content ul.sfly-wgt-left-pane-category li.sfly-wgt-left-pane-category-product:not(.sfly-wgt-left-pane-category-product-selected):hover {\n        color: #f05323;\n        font-weight: 300;\n        cursor: pointer; }\n\n/* special fix for mobile safari in photos mobile view */\n.create-products-wrapper.mobile_safari .sfly_wgt_listview_spread_container {\n  padding-bottom: 59px; }\n\n/* end fix */\nhtml.sfly_wgt_mobile .magicshop_modal_wrapper .magicshop_modal_container .magicshop_modal_menu_wrapper .modal_category_list .modal_category_btn.calendar {\n  display: none; }\nhtml.sfly_wgt_mobile #sfly_wgt_full_openwin_container {\n  height: 100%;\n  left: 0;\n  top: 0;\n  -moz-transform: none;\n  -o-transform: none;\n  -ms-transform: none;\n  -webkit-transform: none;\n  transform: none;\n  border-radius: 0;\n  border: 0; }\n  html.sfly_wgt_mobile #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container {\n    /* for photobooks */ }\n    html.sfly_wgt_mobile #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container .sfy_wgt_product_border {\n      border-radius: 0;\n      border: 0;\n      border-bottom: 1px solid #c6c7c9;\n      border-right: 1px solid #c6c7c9;\n      box-sizing: border-box;\n      position: relative; }\n      html.sfly_wgt_mobile #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container .sfy_wgt_product_border .sfly_wgt_product_inner_action {\n        position: absolute;\n        -moz-transform: translate(-50%);\n        -o-transform: translate(-50%);\n        -ms-transform: translate(-50%);\n        -webkit-transform: translate(-50%);\n        transform: translate(-50%);\n        left: 50%;\n        width: 95%; }\n        html.sfly_wgt_mobile #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container .sfy_wgt_product_border .sfly_wgt_product_inner_action .sfly_wgt_product_price {\n          overflow: hidden;\n          white-space: nowrap;\n          width: 100%;\n          text-overflow: ellipsis; }\n          html.sfly_wgt_mobile #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container .sfy_wgt_product_border .sfly_wgt_product_inner_action .sfly_wgt_product_price strong {\n            line-height: 18px;\n            font-family: \"Avenir LT W01 35 Light\", \"Avenir LT\", Verdana, Arial, sans-serif;\n            color: #58595b;\n            white-space: nowrap; }\n          html.sfly_wgt_mobile #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container .sfy_wgt_product_border .sfly_wgt_product_inner_action .sfly_wgt_product_price .sfly_wgt_product_price_inner {\n            font-family: \"Avenir LT W01 35 Light\", \"Avenir LT\", Verdana, Arial, sans-serif;\n            font-size: 13px;\n            font-weight: 600;\n            line-height: 18px;\n            color: #58595b;\n            white-space: nowrap; }\n            html.sfly_wgt_mobile #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container .sfy_wgt_product_border .sfly_wgt_product_inner_action .sfly_wgt_product_price .sfly_wgt_product_price_inner span.price-old {\n              text-decoration: line-through;\n              color: #919191; }\n            html.sfly_wgt_mobile #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container .sfy_wgt_product_border .sfly_wgt_product_inner_action .sfly_wgt_product_price .sfly_wgt_product_price_inner span.price-sale {\n              color: #CC0000; }\n    html.sfly_wgt_mobile #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header {\n      height: 47px;\n      z-index: 2;\n      border: 0;\n      border-bottom: 1px solid #c6c7c9;\n      border-top: 1px solid #c6c7c9; }\n      html.sfly_wgt_mobile #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wgt_sideopen_title {\n        width: 100%;\n        top: 0;\n        left: 0;\n        text-align: center;\n        line-height: 47px;\n        margin: 0; }\n        html.sfly_wgt_mobile #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wgt_sideopen_title h2 {\n          font-size: 14px;\n          color: #58595b; }\n        html.sfly_wgt_mobile #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wgt_sideopen_title h3 {\n          text-align: left;\n          font-size: 16px;\n          line-height: 20px;\n          padding: 20px 0 0 20px; }\n          @media only screen and (max-width: 767px) {\n            html.sfly_wgt_mobile #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wgt_sideopen_title h3 {\n              text-align: center; } }\n        html.sfly_wgt_mobile #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wgt_sideopen_title h4 {\n          text-align: left;\n          font-size: 13px;\n          line-height: 20px;\n          padding: 5px 0 0 20px;\n          margin: 0; }\n      html.sfly_wgt_mobile #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wg_sideopen_close {\n        top: 0;\n        left: 0;\n        height: 100%;\n        width: 15%; }\n        html.sfly_wgt_mobile #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wg_sideopen_close .sfly-wgt-qst-mark:after, html.sfly_wgt_mobile #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wg_sideopen_close .sfly-wgt-qst-mark:before {\n          width: 2px;\n          height: 14px;\n          background: #4b525c;\n          position: absolute;\n          content: \'\';\n          left: 15px;\n          top: 7px;\n          z-index: 2;\n          margin: 0;\n          -moz-transform: rotate(45deg) translate(7px, 0);\n          -o-transform: rotate(45deg) translate(7px, 0);\n          -ms-transform: rotate(45deg) translate(7px, 0);\n          -webkit-transform: rotate(45deg) translate(7px, 0);\n          transform: rotate(45deg) translate(7px, 0); }\n        html.sfly_wgt_mobile #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wg_sideopen_close .sfly-wgt-qst-mark:after {\n          -moz-transform: rotate(-45deg) translate(-7px, 13px);\n          -o-transform: rotate(-45deg) translate(-7px, 13px);\n          -ms-transform: rotate(-45deg) translate(-7px, 13px);\n          -webkit-transform: rotate(-45deg) translate(-7px, 13px);\n          transform: rotate(-45deg) translate(-7px, 13px); }\n      html.sfly_wgt_mobile #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wgt_upp {\n        top: 0;\n        -moz-transform: translate(50%);\n        -o-transform: translate(50%);\n        -ms-transform: translate(50%);\n        -webkit-transform: translate(50%);\n        transform: translate(50%);\n        left: -50%;\n        z-index: 1; }\n        html.sfly_wgt_mobile #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wgt_upp #sfly_wgt_upp_select {\n          display: none; }\n        html.sfly_wgt_mobile #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_header #sfly_wgt_upp .sfly-wgt-orange-btn-sfly {\n          display: none;\n          width: 170px;\n          height: 22px;\n          line-height: 24px;\n          -moz-transform: translateY(-100%);\n          -o-transform: translateY(-100%);\n          -ms-transform: translateY(-100%);\n          -webkit-transform: translateY(-100%);\n          transform: translateY(-100%); }\n    html.sfly_wgt_mobile #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_container {\n      height: calc(100% - 49px); }\n      html.sfly_wgt_mobile #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_container #sfly_wgt_sideopen_products_container_space {\n        display: none; }\n      html.sfly_wgt_mobile #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_container #sfly_wgt_sideopen_products_inner_container {\n        padding: 0; }\n        html.sfly_wgt_mobile #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products_container #sfly_wgt_sideopen_products_inner_container .sfly_wgt_product:hover .sfly_wgt_product_price {\n          visibility: visible; }\n    html.sfly_wgt_mobile #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products {\n      height: calc(100% - 100px - 112px);\n      left: 0;\n      top: 51px; }\n      html.sfly_wgt_mobile #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products .sfly-wgt-book-paging {\n        display: none; }\n      html.sfly_wgt_mobile #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_products ul.sfly-wgt-book-nav {\n        display: none; }\n    html.sfly_wgt_mobile #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart {\n      height: 100px;\n      border-top-color: #c6c7c9; }\n      html.sfly_wgt_mobile #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart .sfly_wgt_sideopen_bottompart_tabs {\n        display: none; }\n      html.sfly_wgt_mobile #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart #sfly_wgt_sideopen_bottompart_tab_choose_style_content #sfly_wgt_sideopen_styles_left, html.sfly_wgt_mobile #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart #sfly_wgt_sideopen_bottompart_tab_choose_style_content #sfly_wgt_sideopen_styles_right {\n        display: none; }\n      html.sfly_wgt_mobile #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart #sfly_wgt_sideopen_bottompart_tab_choose_style_content #sfly_wgt_sideopen_styles_container {\n        overflow-x: scroll;\n        margin-left: 0;\n        top: 15px; }\n        html.sfly_wgt_mobile #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart #sfly_wgt_sideopen_bottompart_tab_choose_style_content #sfly_wgt_sideopen_styles_container #sfly_wgt_sideopen_styles {\n          margin-left: 20px; }\n      html.sfly_wgt_mobile #sfly_wgt_full_openwin_container #sfly_wgt_sideopen_container #sfly_wgt_sideopen_bottompart #sfly_wgt_sideopen_bottompart_tab_choose_size_content {\n        display: none; }\n@media only screen and (min-width: 320px) and (max-width: 767px) {\n  html.sfly_wgt_mobile .sfly_wgt_tlVert .sfly_wgt_product:after, html.sfly_wgt_mobile .sfly_wgt_tlVert .sfly_wgt_product:before {\n    width: 2px;\n    height: 8px;\n    background: #4b525c;\n    position: absolute;\n    content: \'\';\n    right: 15px;\n    top: 50%;\n    z-index: 2;\n    margin: -9px 0 0 -1px;\n    -moz-transform: rotate(45deg) translate(4px);\n    -o-transform: rotate(45deg) translate(4px);\n    -ms-transform: rotate(45deg) translate(4px);\n    -webkit-transform: rotate(45deg) translate(4px);\n    transform: rotate(45deg) translate(4px); }\n  html.sfly_wgt_mobile .sfly_wgt_tlVert .sfly_wgt_product:after {\n    -moz-transform: rotate(-45deg) translate(4px);\n    -o-transform: rotate(-45deg) translate(4px);\n    -ms-transform: rotate(-45deg) translate(4px);\n    -webkit-transform: rotate(-45deg) translate(4px);\n    transform: rotate(-45deg) translate(4px); }\n  html.sfly_wgt_mobile .sfly_wgt_tlVert .sfly_wgt_product[data-ptype=\"prints\"]:after, html.sfly_wgt_mobile .sfly_wgt_tlVert .sfly_wgt_product[data-ptype=\"prints\"]:before {\n    background: #f05323; } }\n@media only screen and (min-width: 640px) {\n  html.sfly_wgt_mobile .sfly_wgt_tlVert .sfly_wgt_product:not(.right):after {\n    border-right: 1px solid transparent !important; } }\nhtml.sfly_wgt_mobile .sfly_wgt_tlVert .sfly_wgt_loading {\n  position: fixed !important; }\nhtml.sfly_wgt_mobile #sfly_wgt_sideopen_products_inner_container .sfly_wgt_product:hover .sfly_wgt_product_price {\n  display: block !important; }\n\n.sfly_banner_new_badge {\n  position: absolute;\n  width: 38px;\n  height: 38px;\n  z-index: 10;\n  background: url(\"https://d22bbwxztp2lry.cloudfront.net/productswidget/Shutterfly/sidewidget/images/prod/widget/sfly_new_badge.png\") no-repeat;\n  background-size: contain;\n  cursor: default;\n  top: 6px;\n  left: 20px; }\n\n.sfly_banner_free_prints {\n  position: absolute;\n  width: 124px;\n  height: 124px;\n  z-index: 10;\n  background: url(\"https://d22bbwxztp2lry.cloudfront.net/productswidget/Shutterfly/sidewidget/images/prod/widget/sfly_banner_free_prints_may_27.png\") no-repeat;\n  background-size: contain;\n  cursor: default; }\n  @media only screen and (max-width: 767px) {\n    .sfly_banner_free_prints {\n      width: 90px;\n      height: 90px; } }\n  @media only screen and (min-width: 768px) and (max-width: 991px) {\n    .sfly_banner_free_prints {\n      width: 90px;\n      height: 90px; } }\n  .sfly_banner_free_prints.horizontal_magic {\n    width: 55px;\n    height: 55px;\n    top: -15px;\n    right: 10px;\n    background-image: url(\"https://d22bbwxztp2lry.cloudfront.net/productswidget/Shutterfly/sidewidget/images/prod/widget/horizontal_magic_free_prints.png\"); }\n\n.sfly-wgt-side-open .sfly_wgt_product {\n  display: flex; }\n.sfly-wgt-side-open .sfly_wgt_product_price {\n  display: flex;\n  flex-direction: column;\n  justify-content: flex-end; }\n.sfly-wgt-side-open canvas {\n  margin-top: -30px; }\n\n.isStoryBook#sfly_wgt_sideopen_bottompart {\n  border-top: solid 1px #c6c7c9 !important; }\n  .isStoryBook#sfly_wgt_sideopen_bottompart #sfly_wgt_sideopen_bottompart_tab_choose_style {\n    border-color: #c6c7c9 !important;\n    border-bottom-color: #fff !important; }\n  .isStoryBook#sfly_wgt_sideopen_bottompart #sfly_wgt_sideopen_bottompart_tab_choose_size {\n    display: none !important; }\n  .isStoryBook#sfly_wgt_sideopen_bottompart #sfly_wgt_sideopen_buttons {\n    width: 64px !important; }\n  .isStoryBook#sfly_wgt_sideopen_bottompart .sfly_wgt_product_style_title {\n    font-family: \"Avenir LT\",Verdana,Arial,sans-serif;\n    font-size: 11px;\n    font-weight: 500;\n    font-style: normal;\n    font-stretch: normal;\n    line-height: normal;\n    letter-spacing: normal;\n    text-align: center;\n    color: #58595b;\n    white-space: pre-wrap !important; }\n  .isStoryBook#sfly_wgt_sideopen_bottompart #sfly_wgt_sideopen_styles_container {\n    margin-left: 23px !important;\n    overflow: initial !important; }\n\n#sfly-printsetintercept-bookInfo #sfly-printsetintercept-bookFormat span.price-old {\n  text-decoration: line-through; }\n#sfly-printsetintercept-bookInfo #sfly-printsetintercept-bookFormat span.price-sale {\n  color: #C11111; }\n\n#sfly-printsetintercept-cartButton {\n  background: -webkit-gradient(linear, left top, left bottom, from(#6699CC), color-stop(90%, #5681AB));\n  background: -moz-linear-gradient(#6699CC, #5681AB 90%);\n  text-shadow: 0px -1px 1px #336699;\n  float: left; }\n\n#sfly-printsetintercept-cartButton.disable {\n  background: -webkit-gradient(linear, left top, left bottom, from(#6699CC), color-stop(90%, #5681AB));\n  background: -moz-linear-gradient(#6699CC, #5681AB 90%);\n  text-shadow: 0px -1px 1px #336699;\n  float: left;\n  opacity: 0.5;\n  cursor: not-allowed; }\n\n.sfly-printsetintercept-bookButton span {\n  font-family: arial,sans-serif;\n  font-weight: bold;\n  font-size: 15px; }\n\n#sfly-printsetintercept-previewButton:hover {\n  background: #DC4405; }\n\n#sfly-printsetintercept-cartButton:hover {\n  background: #517CA5; }\n\n#sfly-printsetintercept-previewButton.disable:hover {\n  background: -webkit-gradient(linear, left top, left bottom, from(#F05323), color-stop(90%, #CB3F16));\n  background: -moz-linear-gradient(#F05323, #CB3F16 90%);\n  text-shadow: 0px -1px 1px #BA2911;\n  cursor: not-allowed; }\n\n#sfly-printsetintercept-cartButton.disable:hover {\n  background: -webkit-gradient(linear, left top, left bottom, from(#6699CC), color-stop(90%, #5681AB));\n  background: -moz-linear-gradient(#6699CC, #5681AB 90%);\n  cursor: not-allowed; }\n\n.sfly-printsetintercept-bookButton a {\n  color: white;\n  text-decoration: none; }\n\n/*# sourceMappingURL=widget.css.map */\n/* === MIXINS === */\n/* ==== END MIXINS ==== */\n.msb_wrapper {\n  float: left;\n  font-size: 12px;\n  width: 210px;\n  -webkit-border-radius: 5px;\n  -moz-border-radius: 5px;\n  -ms-border-radius: 5px;\n  border-radius: 5px;\n  background: -webkit-gradient(linear, left top, left bottom, from(#fefefe), to(#F1F1F1));\n  background: -webkit-linear-gradient(#fefefe, #F1F1F1);\n  /* For Safari 5.1 to 6.0 */\n  background: -moz-linear-gradient(top, #fefefe, #F1F1F1);\n  background: -o-linear-gradient(#fefefe, #F1F1F1);\n  /* For Opera 11.1 to 12.0 */\n  background: linear-gradient(#fefefe, #F1F1F1);\n  /* Standard syntax */\n  filter: progid:DXImageTransform.Microsoft.gradient(startColorstr=\'#fefefe\', endColorstr=\'#F1F1F1\');\n  border: solid 1px #d9d8d8;\n  color: #919191;\n}\n\n.msb_wrapper .msb_facade {\n  float: left;\n  cursor: pointer;\n  background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABMAAAAQCAYAAAD0xERiAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2hpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDowMzgwMTE3NDA3MjA2ODExOTEwOTk4NDMwRUM5RDU3QSIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDo5MjcyNTNCRDFGMUIxMUU0QUREMzhBRTk1MDE2RTI4RiIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDo5MjcyNTNCQzFGMUIxMUU0QUREMzhBRTk1MDE2RTI4RiIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M2IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6NzI3Q0ZENUYyRTIxNjgxMTgyMkFEOTlDNTBENEFGQUUiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6MDM4MDExNzQwNzIwNjgxMTkxMDk5ODQzMEVDOUQ1N0EiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz6Iuth2AAABDElEQVR42mL8HMTPgAYMgZgZiP9D+dxAfIgBB+BZ+wHOZsFi0DkseuzxGYjNMG8g3gJlmwHxPyj7DBAfBGITLPolkfQwMEK9iWwQCDAheVMXiC/hcZAv0KtbkA2DaTAF4rNALATE2kD8FY8hnEB8GIhtgVgZaOBC9DD7CTXoDQPxAGQgw5dgAYwIAAFNpED/SkSYn4CFLQsum4DgARA/ImCYDZS2BXrzKhOaJCzR2RJhkAySxU9gsYbNVTeICCsFJFc9wGYYzOmEIkANyeJb6InWCEnhDyA2JmCYKpS2A7rqFbphnEgKz5CQLC5iy04zoPRpIg0BuWwbEH/ClTdnkOCis9gEmRioCAACDACvyzxVOSKRZQAAAABJRU5ErkJggg==);\n  background-repeat: no-repeat;\n  background-position: 12px 6px;\n  width: 210px;\n}\n\n.msb_wrapper .msb_facade.msb_facade_open {\n  /* Put anything needed */\n}\n\n.msb_wrapper .msb_facade span.msb_curr_value {\n  float: left;\n  margin: 7px 0px 5px 38px;\n  display: inline-block;\n  width: 150px;\n}\n\n.msb_wrapper .msb_facade .msb_arrow {\n  margin-top: 11px;\n  margin-right: 10px;\n  height: 6px;\n  width: 9px;\n  float: right;\n  background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAGCAYAAAARx7TFAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2hpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDowMzgwMTE3NDA3MjA2ODExOTEwOTk4NDMwRUM5RDU3QSIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDo4MDhCNTFGQTFGMDExMUU0QUREMzhBRTk1MDE2RTI4RiIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDo4MDhCNTFGOTFGMDExMUU0QUREMzhBRTk1MDE2RTI4RiIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M2IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6RUJDNzEyMjYxODIwNjgxMTgyMkFDQzZCNjJGMjI2QTQiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6MDM4MDExNzQwNzIwNjgxMTkxMDk5ODQzMEVDOUQ1N0EiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz6j6XlsAAAAXklEQVR42mJcunRpNwMDgwEDbvCUBUjMAOIzQCyARcEvIHZkAhJ3gTgWiP9jUVQCxMeYoJwtQNyKpmApEE8GMZiQBBuAeBeUfQmI02ASyIr+AnE0VEEIEH+DSQAEGAAU4hIW2YIJ7wAAAABJRU5ErkJggg==);\n}\n\n.msb_wrapper .msb_facade .msb_arrow.msb_arrow_up {\n  background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAGCAYAAAARx7TFAAAACXBIWXMAAAsTAAALEwEAmpwYAAAKT2lDQ1BQaG90b3Nob3AgSUNDIHByb2ZpbGUAAHjanVNnVFPpFj333vRCS4iAlEtvUhUIIFJCi4AUkSYqIQkQSoghodkVUcERRUUEG8igiAOOjoCMFVEsDIoK2AfkIaKOg6OIisr74Xuja9a89+bN/rXXPues852zzwfACAyWSDNRNYAMqUIeEeCDx8TG4eQuQIEKJHAAEAizZCFz/SMBAPh+PDwrIsAHvgABeNMLCADATZvAMByH/w/qQplcAYCEAcB0kThLCIAUAEB6jkKmAEBGAYCdmCZTAKAEAGDLY2LjAFAtAGAnf+bTAICd+Jl7AQBblCEVAaCRACATZYhEAGg7AKzPVopFAFgwABRmS8Q5ANgtADBJV2ZIALC3AMDOEAuyAAgMADBRiIUpAAR7AGDIIyN4AISZABRG8lc88SuuEOcqAAB4mbI8uSQ5RYFbCC1xB1dXLh4ozkkXKxQ2YQJhmkAuwnmZGTKBNA/g88wAAKCRFRHgg/P9eM4Ors7ONo62Dl8t6r8G/yJiYuP+5c+rcEAAAOF0ftH+LC+zGoA7BoBt/qIl7gRoXgugdfeLZrIPQLUAoOnaV/Nw+H48PEWhkLnZ2eXk5NhKxEJbYcpXff5nwl/AV/1s+X48/Pf14L7iJIEyXYFHBPjgwsz0TKUcz5IJhGLc5o9H/LcL//wd0yLESWK5WCoU41EScY5EmozzMqUiiUKSKcUl0v9k4t8s+wM+3zUAsGo+AXuRLahdYwP2SycQWHTA4vcAAPK7b8HUKAgDgGiD4c93/+8//UegJQCAZkmScQAAXkQkLlTKsz/HCAAARKCBKrBBG/TBGCzABhzBBdzBC/xgNoRCJMTCQhBCCmSAHHJgKayCQiiGzbAdKmAv1EAdNMBRaIaTcA4uwlW4Dj1wD/phCJ7BKLyBCQRByAgTYSHaiAFiilgjjggXmYX4IcFIBBKLJCDJiBRRIkuRNUgxUopUIFVIHfI9cgI5h1xGupE7yAAygvyGvEcxlIGyUT3UDLVDuag3GoRGogvQZHQxmo8WoJvQcrQaPYw2oefQq2gP2o8+Q8cwwOgYBzPEbDAuxsNCsTgsCZNjy7EirAyrxhqwVqwDu4n1Y8+xdwQSgUXACTYEd0IgYR5BSFhMWE7YSKggHCQ0EdoJNwkDhFHCJyKTqEu0JroR+cQYYjIxh1hILCPWEo8TLxB7iEPENyQSiUMyJ7mQAkmxpFTSEtJG0m5SI+ksqZs0SBojk8naZGuyBzmULCAryIXkneTD5DPkG+Qh8lsKnWJAcaT4U+IoUspqShnlEOU05QZlmDJBVaOaUt2ooVQRNY9aQq2htlKvUYeoEzR1mjnNgxZJS6WtopXTGmgXaPdpr+h0uhHdlR5Ol9BX0svpR+iX6AP0dwwNhhWDx4hnKBmbGAcYZxl3GK+YTKYZ04sZx1QwNzHrmOeZD5lvVVgqtip8FZHKCpVKlSaVGyovVKmqpqreqgtV81XLVI+pXlN9rkZVM1PjqQnUlqtVqp1Q61MbU2epO6iHqmeob1Q/pH5Z/YkGWcNMw09DpFGgsV/jvMYgC2MZs3gsIWsNq4Z1gTXEJrHN2Xx2KruY/R27iz2qqaE5QzNKM1ezUvOUZj8H45hx+Jx0TgnnKKeX836K3hTvKeIpG6Y0TLkxZVxrqpaXllirSKtRq0frvTau7aedpr1Fu1n7gQ5Bx0onXCdHZ4/OBZ3nU9lT3acKpxZNPTr1ri6qa6UbobtEd79up+6Ynr5egJ5Mb6feeb3n+hx9L/1U/W36p/VHDFgGswwkBtsMzhg8xTVxbzwdL8fb8VFDXcNAQ6VhlWGX4YSRudE8o9VGjUYPjGnGXOMk423GbcajJgYmISZLTepN7ppSTbmmKaY7TDtMx83MzaLN1pk1mz0x1zLnm+eb15vft2BaeFostqi2uGVJsuRaplnutrxuhVo5WaVYVVpds0atna0l1rutu6cRp7lOk06rntZnw7Dxtsm2qbcZsOXYBtuutm22fWFnYhdnt8Wuw+6TvZN9un2N/T0HDYfZDqsdWh1+c7RyFDpWOt6azpzuP33F9JbpL2dYzxDP2DPjthPLKcRpnVOb00dnF2e5c4PziIuJS4LLLpc+Lpsbxt3IveRKdPVxXeF60vWdm7Obwu2o26/uNu5p7ofcn8w0nymeWTNz0MPIQ+BR5dE/C5+VMGvfrH5PQ0+BZ7XnIy9jL5FXrdewt6V3qvdh7xc+9j5yn+M+4zw33jLeWV/MN8C3yLfLT8Nvnl+F30N/I/9k/3r/0QCngCUBZwOJgUGBWwL7+Hp8Ib+OPzrbZfay2e1BjKC5QRVBj4KtguXBrSFoyOyQrSH355jOkc5pDoVQfujW0Adh5mGLw34MJ4WHhVeGP45wiFga0TGXNXfR3ENz30T6RJZE3ptnMU85ry1KNSo+qi5qPNo3ujS6P8YuZlnM1VidWElsSxw5LiquNm5svt/87fOH4p3iC+N7F5gvyF1weaHOwvSFpxapLhIsOpZATIhOOJTwQRAqqBaMJfITdyWOCnnCHcJnIi/RNtGI2ENcKh5O8kgqTXqS7JG8NXkkxTOlLOW5hCepkLxMDUzdmzqeFpp2IG0yPTq9MYOSkZBxQqohTZO2Z+pn5mZ2y6xlhbL+xW6Lty8elQfJa7OQrAVZLQq2QqboVFoo1yoHsmdlV2a/zYnKOZarnivN7cyzytuQN5zvn//tEsIS4ZK2pYZLVy0dWOa9rGo5sjxxedsK4xUFK4ZWBqw8uIq2Km3VT6vtV5eufr0mek1rgV7ByoLBtQFr6wtVCuWFfevc1+1dT1gvWd+1YfqGnRs+FYmKrhTbF5cVf9go3HjlG4dvyr+Z3JS0qavEuWTPZtJm6ebeLZ5bDpaql+aXDm4N2dq0Dd9WtO319kXbL5fNKNu7g7ZDuaO/PLi8ZafJzs07P1SkVPRU+lQ27tLdtWHX+G7R7ht7vPY07NXbW7z3/T7JvttVAVVN1WbVZftJ+7P3P66Jqun4lvttXa1ObXHtxwPSA/0HIw6217nU1R3SPVRSj9Yr60cOxx++/p3vdy0NNg1VjZzG4iNwRHnk6fcJ3/ceDTradox7rOEH0x92HWcdL2pCmvKaRptTmvtbYlu6T8w+0dbq3nr8R9sfD5w0PFl5SvNUyWna6YLTk2fyz4ydlZ19fi753GDborZ752PO32oPb++6EHTh0kX/i+c7vDvOXPK4dPKy2+UTV7hXmq86X23qdOo8/pPTT8e7nLuarrlca7nuer21e2b36RueN87d9L158Rb/1tWeOT3dvfN6b/fF9/XfFt1+cif9zsu72Xcn7q28T7xf9EDtQdlD3YfVP1v+3Njv3H9qwHeg89HcR/cGhYPP/pH1jw9DBY+Zj8uGDYbrnjg+OTniP3L96fynQ89kzyaeF/6i/suuFxYvfvjV69fO0ZjRoZfyl5O/bXyl/erA6xmv28bCxh6+yXgzMV70VvvtwXfcdx3vo98PT+R8IH8o/2j5sfVT0Kf7kxmTk/8EA5jz/GMzLdsAAAAgY0hSTQAAeiUAAICDAAD5/wAAgOkAAHUwAADqYAAAOpgAABdvkl/FRgAAAFZJREFUeNpszrsJgEAURNGjoVaiWI25n578FCBsov0Zm6yisjeZ4XEZXhZC8KLEhg7nfcx9WdHGlJJG9LEPr/5INZbEanVLBY6Y//92FDnmuJSiwXQNAOA2C219LJL4AAAAAElFTkSuQmCC);\n}\n\n.msb_wrapper .msb_options_wrapper {\n  display: none;\n  float: left;\n  margin-top: 10px;\n  clear: both;\n  width: 100%;\n}\n\n.msb_wrapper .msb_options_wrapper .msb_option {\n  float: left;\n  cursor: pointer;\n  margin: 0;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  width: 100%;\n}\n\n.msb_wrapper .msb_options_wrapper .msb_option:hover {\n  background-color: #737373;\n}\n\n.msb_wrapper .msb_options_wrapper .msb_option:hover .msb_option_value {\n  color: #FFF;\n  font-weight: 500;\n}\n\n.msb_wrapper .msb_options_wrapper .msb_option .msb_option_value {\n  float: left;\n  color: #333333;\n  display: inline-block;\n  padding-top: 3px;\n}\n\n.msb_wrapper .msb_options_wrapper .msb_option .msb_checkbox {\n  width: 15px;\n  height: 16px;\n  float: left;\n  margin-right: 7px;\n  margin-left: 14px;\n  background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA8AAAAQCAYAAADJViUEAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2hpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDowMzgwMTE3NDA3MjA2ODExOTEwOTk4NDMwRUM5RDU3QSIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDo5MjcyNTNCOTFGMUIxMUU0QUREMzhBRTk1MDE2RTI4RiIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDo5MjcyNTNCODFGMUIxMUU0QUREMzhBRTk1MDE2RTI4RiIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M2IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6RUJDNzEyMjYxODIwNjgxMTgyMkFDQzZCNjJGMjI2QTQiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6MDM4MDExNzQwNzIwNjgxMTkxMDk5ODQzMEVDOUQ1N0EiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz510mYMAAABRElEQVR42qSSPa6CUBCF5/IftMKOisKWhgIqN+Ia3A5bYB9sgMaEjoQKbSQaDYTIz3vnJvi4ESyekwzF3PnuOXcYNgwD/Tck+iK+ghV8LpfLEEUR5XlOfd/Pq0gSOY5D+/2eNpsNQ43hzWEYDtvtlna7HcmyPAt3XUdxHFOWZXQ4HNjL9ul0It/3SdM0UhSFVFUVcqwFQUDn81m0DQgO2rYlxhjPaeAMyngSegUYtz6fT56SLNEvvgijV4BN06S6rnnTkjLApml47xuMQSEx1SUYzlarlQijADu6rnMYOQVHGNbflAFjEIZh8MlOrY8whgl4vV6LG3a73ejxeHDFqco4JNRwdr/f6Xq9isppmnI7rut+XJLj8ch7x+AbliQJX8+qqj7uMgSwnp7n/a0noizLoSgKrjAXcGTbNlmW9foVPwIMAAV0uLSid5I3AAAAAElFTkSuQmCC);\n}\n\n.msb_wrapper .msb_options_wrapper .msb_option .msb_checkbox.msb_selected {\n  background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA8AAAAQCAYAAADJViUEAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2hpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDowMzgwMTE3NDA3MjA2ODExOTEwOTk4NDMwRUM5RDU3QSIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDo5MjcyNTNCNTFGMUIxMUU0QUREMzhBRTk1MDE2RTI4RiIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDo5MjcyNTNCNDFGMUIxMUU0QUREMzhBRTk1MDE2RTI4RiIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M2IChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6RUJDNzEyMjYxODIwNjgxMTgyMkFDQzZCNjJGMjI2QTQiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6MDM4MDExNzQwNzIwNjgxMTkxMDk5ODQzMEVDOUQ1N0EiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz6Q5Ki2AAAB9UlEQVR42pySMWgTYRTH/1/uLkmTEPFwMd1aDQ4GbMADJ8cO3VQQMkhrBBGh7kIXnSzooJObUogZKtgtQl20nYQgDQSEDim0CWgTEhIvl8vdfX7vBYOhQbAfPO69u/f73v/ee0JKic6tCzjNCZ2CmVP2gRz9P8EFZSVlxxQIkt1sNmWhUECtVkMQBFOpc0Ef937sIjrsU/hVmcWVi8Ui0uk08vk8NE07SboOBmu3IUcgnXllBv9zo9GAZVkIh8PQdR2GYUyYv/kK8nCfKU/w5eukmmGCSL7neRj+PIL9YhXuty+j+OA7hqWNUb34GbyfXyTvGelh2XT70B3A/fQOcus14NgIjuvQL12Ft6HyfB+YScB99BLNj58nRxWLxdB3BnBm05Dmef4g9/fgFJ5D7u2orBAGd5/glznLuSdgapS4eAX+4zeQFkuDVnrLz+DmKsTla+qOEOLx+Bhm2fSCpEciEZUwg9DDdfjJswi2ixAL12EsLUNTI/SV/L8rj2FqWjQa5W4LISDuP0Vf+ZEbD0gaN4/gRCIxCXc6HfR6PSSTSe46GU9hZQ3sqZgkd7tdtNvtSbharbKcTCYzfUkArlqpVDj3zuZo5rye5XKZ19O27X8uNhXI5XLIZrNiDNNptVqyXq9zhWmHFKVSKZimKf68+y3AAGGIxt8s8ppVAAAAAElFTkSuQmCC);\n}\n\n.msb_wrapper .msb_options_wrapper .msb_btn_apply_wrapper {\n  margin: 0 auto;\n  width: 57px;\n}\n\n.msb_wrapper .msb_options_wrapper .msb_btn_apply_wrapper .msb_btn_apply {\n  text-align: center;\n  float: left;\n}\n\n.msb_wrapper .msb_options_wrapper .msb_btn_apply_wrapper .msb_btn_apply a {\n  margin-top: 15px;\n  margin-bottom: 10px;\n  /* Sfly style button */\n  display: inline-block;\n  padding: 0 10px;\n  font-weight: normal;\n  font-family: \"Avenir LT W01 85 Heavy\",verdana,arial,sans-serif;\n  font-size: 13px;\n  text-align: center;\n  vertical-align: middle;\n  cursor: pointer;\n  outline: 0;\n  line-height: 24px;\n  text-decoration: none;\n  box-shadow: 1px 1px 4px #CCC;\n  border-radius: 3px;\n  border: 0;\n  text-shadow: -1px -1px #ba2911;\n  color: white;\n  background-color: #f05323;\n  background-image: -webkit-gradient(linear, 50% 0, 50% 100%, color-stop(0%, #f05323), color-stop(100%, #cb3f16));\n  background-image: -webkit-linear-gradient(top, #f05323, #cb3f16);\n  background-image: -moz-linear-gradient(top, #f05323, #cb3f16);\n  background-image: -o-linear-gradient(top, #f05323, #cb3f16);\n  background-image: -ms-linear-gradient(top, #f05323, #cb3f16);\n  background-image: linear-gradient(top, #f05323, #cb3f16);\n}\n\n.msb_wrapper .msb_options_wrapper .msb_btn_apply_wrapper .msb_btn_apply a:hover {\n  color: white;\n  background-color: #dc4405;\n  text-decoration: none;\n  background-image: none;\n}\n\n.msb_wrapper .msb_divider {\n  width: 185px;\n  height: 1px;\n  border-bottom: solid 1px #c2c2c2;\n  margin: 0 auto;\n  padding-top: 3px;\n  clear: both;\n  display: none;\n}\n\n.msb_bg_click_catcher {\n  width: 100%;\n  height: 100%;\n  z-index: 9;\n  position: absolute;\n  top: 0;\n  left: 0;\n}\n');

require(["sdk"]);
    return require('sdk');
}));
