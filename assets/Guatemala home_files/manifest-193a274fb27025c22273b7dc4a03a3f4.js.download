domain="shutterfly.com",document.domain&&(document.domain=domain);var ThisLife=window.ThisLife=window.ThisLife||{},DEBUG=!1;ThisLife.isProd=!DEBUG,function(){var e=ThisLife,t="tlprod";e.pagePath=window.location.pathname.replace("/",""),e.loadScriptAsync=function(e,t){var i=document.createElement("script");i.type="text/javascript",i.async=!0,i.src="https:"===document.location.protocol&&t?t:e;var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(i,n)},e.Settings={localDev:!1,scheme:"https://",env:t,sflyEnv:"prod",apiUrl:"https://cmd.thislife.com/json",apiDomain:"cmd.thislife.com",apiSubDomain:"thislife.com",fbUrl:"https://graph.facebook.com/v2.9",productionApiUrl:"https://api.thislife.com/json",shareStatic:"d2qt3memdykk3c.cloudfront.net",prodStaticStream:"s1tlvafg1jorre.cloudfront.net",photosProdStatic:"d1ftt6yfh3p68d.cloudfront.net",imageExifUrl:"https://uniim1.shutterfly.com/ng/services/mediarender/THISLIFE",videoExifUrl:"https://prod-tl-meta.s3.amazonaws.com",ext:"com",prefix:"prod-tl-m-",pusherKey:"273596d4fcc4acc9e5af",shortUrl:"pix.sfly.com",socialUrl:"https://social.thislife.com",captionUrl:"https://io.thislife.com/caption",sflyDomain:"shutterfly.com",sflyApp:"https://www.shutterfly.com",sflyCmd:"https://cmd.shutterfly.com",sflySSOAppId:"17",sflyMediaCopyUrl:"//media.shutterfly.com/services/media/{0}/copy/bulk",sflyLoggerUrl:"//www.shutterfly.com/application/log.gif",iaImageUrl:"https://uniim1.shutterfly.com",tlDomain:domain,www:"https://photos.shutterfly.com",app:"https://photos.shutterfly.com",faceUrl:"https://prod-tl-face.s3.amazonaws.com/face",starterBoxUid:"5d06da25-9864-4d65-a139-2bb40bc1457c",s3VideoUrl:"https://d11uz9xpb15cq7.cloudfront.net",videoUrl:"rtmp://s1zc2rzcvinv02.cloudfront.net",cookieSuffix:"",sessionKey:"session_token_sec",perishableKey:"perishable_token_sec",scaAccount:"sflyprod",mtiTracking:{projectId:"01d30d21-721e-42aa-a01e-375a5d7e5861",url:"//fast.fonts.net/t/trackingCode.js"},facebookAppId:"178406241888",downloadUrl:"https://io.thislife.com/download",googleMapsApi:"AIzaSyDgpjeFKDQEIg7RL1nxe-jVXoMIhPEcT5Y",imageUploadUrl:"https://up7.shutterfly.com/upload/npc/v1/user/",pollPersonInfoInterval:15,maritzCXIdx:"UJJ3FE",branchIoKey:"key_live_nfwlg2V4nUnAtIehHW61zafgCAnYnfZV",apigeeApiKey:"uWrM911sdIvHivflYxyiHlGgmlgoaV0m",api2Domain:"api2.shutterfly.com",cdnRootUrl:"cdn.staticsfly.com",faqUrl:"https://shutterflycustomercare.force.com/helpcenter/s/topic/0TO1I000000UGjnWAG/my-photos",ssoEnv:"production"},e.Settings.emailIn=("tlprod"===t?"":t)+"thislife.com",e.SCArgs={}}(),function(){for(var e=0,t=["ms","moz","webkit","o"],i=0;i<t.length&&!window.requestAnimationFrame;++i)window.requestAnimationFrame=window[t[i]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[i]+"CancelAnimationFrame"]||window[t[i]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(t){var i=Date.now(),n=Math.max(0,16-(i-e)),o=window.setTimeout(function(){t(i+n)},n);return e=i+n,o}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})}(),/*! Copyright (c) 2013 Brandon Aaron (http://brandon.aaron.sh)
 * Licensed under the MIT License (LICENSE.txt).
 *
 * Version: 3.1.9
 *
 * Requires: jQuery 1.2.2+
 */
function(e){"function"==typeof define&&define.amd?define(["jquery"],e):"object"==typeof exports?module.exports=e:e(jQuery)}(function(e){function t(t){var r=t||window.event,l=a.call(arguments,1),u=0,c=0,d=0,h=0;if(t=e.event.fix(r),t.type="mousewheel","detail"in r&&(d=-1*r.detail),"wheelDelta"in r&&(d=r.wheelDelta),"wheelDeltaY"in r&&(d=r.wheelDeltaY),"wheelDeltaX"in r&&(c=-1*r.wheelDeltaX),"axis"in r&&r.axis===r.HORIZONTAL_AXIS&&(c=-1*d,d=0),u=0===d?c:d,"deltaY"in r&&(d=-1*r.deltaY,u=d),"deltaX"in r&&(c=r.deltaX,0===d&&(u=-1*c)),0!==d||0!==c){if(1===r.deltaMode){var p=e.data(this,"mousewheel-line-height");u*=p,d*=p,c*=p}else if(2===r.deltaMode){var f=e.data(this,"mousewheel-page-height");u*=f,d*=f,c*=f}return h=Math.max(Math.abs(d),Math.abs(c)),(!s||s>h)&&(s=h,n(r,h)&&(s/=40)),n(r,h)&&(u/=40,c/=40,d/=40),u=Math[u>=1?"floor":"ceil"](u/s),c=Math[c>=1?"floor":"ceil"](c/s),d=Math[d>=1?"floor":"ceil"](d/s),t.deltaX=c,t.deltaY=d,t.deltaFactor=s,t.deltaMode=0,l.unshift(t,u,c,d),o&&clearTimeout(o),o=setTimeout(i,200),(e.event.dispatch||e.event.handle).apply(this,l)}}function i(){s=null}function n(e,t){return c.settings.adjustOldDeltas&&"mousewheel"===e.type&&t%120===0}var o,s,r=["wheel","mousewheel","DOMMouseScroll","MozMousePixelScroll"],l="onwheel"in document||document.documentMode>=9?["wheel"]:["mousewheel","DomMouseScroll","MozMousePixelScroll"],a=Array.prototype.slice;if(e.event.fixHooks)for(var u=r.length;u;)e.event.fixHooks[r[--u]]=e.event.mouseHooks;var c=e.event.special.mousewheel={version:"3.1.9",setup:function(){if(this.addEventListener)for(var i=l.length;i;)this.addEventListener(l[--i],t,!1);else this.onmousewheel=t;e.data(this,"mousewheel-line-height",c.getLineHeight(this)),e.data(this,"mousewheel-page-height",c.getPageHeight(this))},teardown:function(){if(this.removeEventListener)for(var e=l.length;e;)this.removeEventListener(l[--e],t,!1);else this.onmousewheel=null},getLineHeight:function(t){return parseInt(e(t)["offsetParent"in e.fn?"offsetParent":"parent"]().css("fontSize"),10)},getPageHeight:function(t){return e(t).height()},settings:{adjustOldDeltas:!0}};e.fn.extend({mousewheel:function(e){return e?this.bind("mousewheel",e):this.trigger("mousewheel")},unmousewheel:function(e){return this.unbind("mousewheel",e)}})}),/*!
 * jquery.customSelect() - v0.4.1
 * http://adam.co/lab/jquery/customselect/
 * 2013-05-13
 *
 * Copyright 2013 Adam Coulombe
 * @license http://www.opensource.org/licenses/mit-license.html MIT License
 * @license http://www.gnu.org/licenses/gpl.html GPL2 License 
 */
function(e){"use strict";e.fn.extend({customSelect:function(t){if("undefined"==typeof document.body.style.maxHeight)return this;var i={customClass:"customSelect",mapClass:!0,mapStyle:!0},t=e.extend(i,t),n=t.customClass,o=function(i,n){var o=i.find(":selected"),r=n.children(":first"),l=o.html()||"&nbsp;";t.truncate&&l.length>t.truncate&&(l=l.substring(0,t.truncate)+"&hellip;"),r.html(l),o.attr("disabled")?n.addClass(s("DisabledOption")):n.removeClass(s("DisabledOption")),setTimeout(function(){n.removeClass(s("Open")),e(document).off("mouseup."+s("Open"))},60)},s=function(e){return n+e};return this.each(function(){var i=e(this),r=e("<span />").addClass(s("Inner")),l=e("<span />");i.after(l.append(r)),l.addClass(n),t.mapClass&&l.addClass(i.attr("class")),t.mapStyle&&l.attr("style",i.attr("style")),i.addClass("hasCustomSelect").on("update",function(){o(i,l);var e=parseInt(i.outerWidth(),10)-(parseInt(l.outerWidth(),10)-parseInt(l.width(),10));i.data("width")?e=i.data("width"):e+=40,l.css({display:"inline-block"});var t=l.outerHeight();i.attr("disabled")?l.addClass(s("Disabled")):l.removeClass(s("Disabled")),r.css({width:e,display:"inline-block"}),i.css({"-webkit-appearance":"menulist-button",width:l.outerWidth(),position:"absolute",zIndex:2,opacity:0,height:t,fontSize:l.css("font-size")})}).on("change",function(){l.addClass(s("Changed")),o(i,l)}).on("keyup",function(e){l.hasClass(s("Open"))?(13==e.which||27==e.which)&&o(i,l):(i.blur(),i.focus())}).on("mousedown",function(){l.removeClass(s("Changed"))}).on("mouseup",function(t){l.hasClass(s("Open"))||(e("."+s("Open")).not(l).length>0&&"undefined"!=typeof InstallTrigger?i.focus():(l.addClass(s("Open")),t.stopPropagation(),e(document).one("mouseup."+s("Open"),function(t){t.target!=i.get(0)&&e.inArray(t.target,i.find("*").get())<0?i.blur():o(i,l)})))}).focus(function(){l.removeClass(s("Changed")).addClass(s("Focus"))}).blur(function(){l.removeClass(s("Focus")+" "+s("Open"))}).hover(function(){l.addClass(s("Hover"))},function(){l.removeClass(s("Hover"))}).trigger("update")})}})}(jQuery),function(e){"function"==typeof define&&define.amd?define(["jquery"],e):e(jQuery)}(function(e){var t={wheelSpeed:10,wheelPropagation:!1,minScrollbarLength:null,useBothWheelAxes:!1,useKeyboard:!0,suppressScrollX:!1,suppressScrollY:!1,scrollXMarginOffset:0,scrollYMarginOffset:0};e.fn.perfectScrollbar=function(i,n){return this.each(function(){var o=e.extend(!0,{},t),s=e(this);if("object"==typeof i?e.extend(!0,o,i):n=i,"update"===n)return s.data("perfect-scrollbar-update")&&s.data("perfect-scrollbar-update")(),s;if("destroy"===n)return s.data("perfect-scrollbar-destroy")&&s.data("perfect-scrollbar-destroy")(),s;if(s.data("perfect-scrollbar"))return s.data("perfect-scrollbar");s.addClass("ps-container");var r,l,a,u,c,d,h,p,f,m,g=e("<div class='ps-scrollbar-x-rail'></div>").appendTo(s),v=e("<div class='ps-scrollbar-y-rail'></div>").appendTo(s),_=e("<div class='ps-scrollbar-x'></div>").appendTo(g),b=e("<div class='ps-scrollbar-y'></div>").appendTo(v),w=parseInt(g.css("bottom"),10),y=parseInt(v.css("right"),10),T=function(){var e=parseInt(m*(d-u)/(u-f),10);s.scrollTop(e),g.css({bottom:w-e})},L=function(){var e=parseInt(p*(c-a)/(a-h),10);s.scrollLeft(e),v.css({right:y-e})},S=function(e){return o.minScrollbarLength&&(e=Math.max(e,o.minScrollbarLength)),e},C=function(){g.css({left:s.scrollLeft(),bottom:w-s.scrollTop(),width:a,display:o.suppressScrollX?"none":"inherit"}),v.css({top:s.scrollTop(),right:y-s.scrollLeft(),height:u,display:o.suppressScrollY?"none":"inherit"}),_.css({left:p,width:h}),b.css({top:m,height:f})},k=function(){a=s.width(),u=s.height(),c=s.prop("scrollWidth"),d=s.prop("scrollHeight"),!o.suppressScrollX&&a+o.scrollXMarginOffset<c?(r=!0,h=S(parseInt(a*a/c,10)),p=parseInt(s.scrollLeft()*(a-h)/(c-a),10)):(r=!1,h=0,p=0,s.scrollLeft(0)),!o.suppressScrollY&&u+o.scrollYMarginOffset<d?(l=!0,f=S(parseInt(u*u/d,10)),m=parseInt(s.scrollTop()*(u-f)/(d-u),10)):(l=!1,f=0,m=0,s.scrollTop(0)),m>=u-f&&(m=u-f),p>=a-h&&(p=a-h),C()},M=function(e,t){var i=e+t,n=a-h;p=0>i?0:i>n?n:i,g.css({left:s.scrollLeft()}),_.css({left:p})},E=function(e,t){var i=e+t,n=u-f;m=0>i?0:i>n?n:i,v.css({top:s.scrollTop()}),b.css({top:m})},A=function(){var t,i;_.bind("mousedown.perfect-scrollbar",function(e){i=e.pageX,t=_.position().left,g.addClass("in-scrolling"),e.stopPropagation(),e.preventDefault()}),e(document).bind("mousemove.perfect-scrollbar",function(e){g.hasClass("in-scrolling")&&(L(),M(t,e.pageX-i),e.stopPropagation(),e.preventDefault())}),e(document).bind("mouseup.perfect-scrollbar",function(){g.hasClass("in-scrolling")&&g.removeClass("in-scrolling")}),t=i=null},P=function(){var t,i;b.bind("mousedown.perfect-scrollbar",function(e){i=e.pageY,t=b.position().top,v.addClass("in-scrolling"),e.stopPropagation(),e.preventDefault()}),e(document).bind("mousemove.perfect-scrollbar",function(e){v.hasClass("in-scrolling")&&(T(),E(t,e.pageY-i),e.stopPropagation(),e.preventDefault())}),e(document).bind("mouseup.perfect-scrollbar",function(){v.hasClass("in-scrolling")&&v.removeClass("in-scrolling")}),t=i=null},V=function(e,t){var i=s.scrollTop();if(0===e){if(!l)return!1;if(0===i&&t>0||i>=d-u&&0>t)return!o.wheelPropagation}var n=s.scrollLeft();if(0===t){if(!r)return!1;if(0===n&&0>e||n>=c-a&&e>0)return!o.wheelPropagation}return!0},I=function(){var e=!1;s.bind("mousewheel.perfect-scrollbar",function(t,i,n,a){o.useBothWheelAxes?l&&!r?s.scrollTop(a?s.scrollTop()-a*o.wheelSpeed:s.scrollTop()+n*o.wheelSpeed):r&&!l&&s.scrollLeft(n?s.scrollLeft()+n*o.wheelSpeed:s.scrollLeft()-a*o.wheelSpeed):(s.scrollTop(s.scrollTop()-a*o.wheelSpeed),s.scrollLeft(s.scrollLeft()+n*o.wheelSpeed)),k(),e=V(n,a),e&&t.preventDefault()}),s.bind("MozMousePixelScroll.perfect-scrollbar",function(t){e&&t.preventDefault()})},x=function(){var t=!1;s.bind("mouseenter.perfect-scrollbar",function(){t=!0}),s.bind("mouseleave.perfect-scrollbar",function(){t=!1});var i=!1;e(document).bind("keydown.perfect-scrollbar",function(e){if(t){var n=0,r=0;switch(e.which){case 37:n=-3;break;case 38:r=3;break;case 39:n=3;break;case 40:r=-3;break;default:return}s.scrollTop(s.scrollTop()-r*o.wheelSpeed),s.scrollLeft(s.scrollLeft()+n*o.wheelSpeed),k(),i=V(n,r),i&&e.preventDefault()}})},F=function(){var e=function(e){e.stopPropagation()};b.bind("click.perfect-scrollbar",e),v.bind("click.perfect-scrollbar",function(e){var t=parseInt(f/2,10),i=e.pageY-v.offset().top-t,n=u-f,o=i/n;0>o?o=0:o>1&&(o=1),s.scrollTop((d-u)*o),k()}),_.bind("click.perfect-scrollbar",e),g.bind("click.perfect-scrollbar",function(e){var t=parseInt(h/2,10),i=e.pageX-g.offset().left-t,n=a-h,o=i/n;0>o?o=0:o>1&&(o=1),s.scrollLeft((c-a)*o),k()})},D=function(){var t=function(e,t){s.scrollTop(s.scrollTop()-t),s.scrollLeft(s.scrollLeft()-e),k()},i={},n=0,o={},r=null,l=!1;e(window).bind("touchstart.perfect-scrollbar",function(){l=!0}),e(window).bind("touchend.perfect-scrollbar",function(){l=!1}),s.bind("touchstart.perfect-scrollbar",function(e){var t=e.originalEvent.targetTouches[0];i.pageX=t.pageX,i.pageY=t.pageY,n=(new Date).getTime(),null!==r&&clearInterval(r),e.stopPropagation()}),s.bind("touchmove.perfect-scrollbar",function(e){if(!l&&1===e.originalEvent.targetTouches.length){var s=e.originalEvent.targetTouches[0],r={};r.pageX=s.pageX,r.pageY=s.pageY;var a=r.pageX-i.pageX,u=r.pageY-i.pageY;t(a,u),i=r;var c=(new Date).getTime();o.x=a/(c-n),o.y=u/(c-n),n=c,e.preventDefault()}}),s.bind("touchend.perfect-scrollbar",function(){clearInterval(r),r=setInterval(function(){return Math.abs(o.x)<.01&&Math.abs(o.y)<.01?void clearInterval(r):(t(30*o.x,30*o.y),o.x*=.8,void(o.y*=.8))},10)})},U=function(){s.unbind(".perfect-scrollbar"),e(window).unbind(".perfect-scrollbar"),e(document).unbind(".perfect-scrollbar"),s.data("perfect-scrollbar",null),s.data("perfect-scrollbar-update",null),s.data("perfect-scrollbar-destroy",null),_.remove(),b.remove(),g.remove(),v.remove(),_=b=a=u=c=d=h=p=w=f=m=y=null},N=function(t){s.addClass("ie").addClass("ie"+t);var i=function(){var t=function(){e(this).addClass("hover")},i=function(){e(this).removeClass("hover")};s.bind("mouseenter.perfect-scrollbar",t).bind("mouseleave.perfect-scrollbar",i),g.bind("mouseenter.perfect-scrollbar",t).bind("mouseleave.perfect-scrollbar",i),v.bind("mouseenter.perfect-scrollbar",t).bind("mouseleave.perfect-scrollbar",i),_.bind("mouseenter.perfect-scrollbar",t).bind("mouseleave.perfect-scrollbar",i),b.bind("mouseenter.perfect-scrollbar",t).bind("mouseleave.perfect-scrollbar",i)},n=function(){C=function(){_.css({left:p+s.scrollLeft(),bottom:w,width:h}),b.css({top:m+s.scrollTop(),right:y,height:f}),_.hide().show(),b.hide().show()},T=function(){var e=parseInt(m*d/u,10);s.scrollTop(e),_.css({bottom:w}),_.hide().show()},L=function(){var e=parseInt(p*c/a,10);s.scrollLeft(e),b.hide().show()}};6===t&&(i(),n())},O="ontouchstart"in window||window.DocumentTouch&&document instanceof window.DocumentTouch,B=function(){var e=navigator.userAgent.toLowerCase().match(/(msie) ([\w.]+)/);e&&"msie"===e[1]&&N(parseInt(e[2],10)),k(),A(),P(),F(),O&&D(),s.mousewheel&&I(),o.useKeyboard&&x(),s.data("perfect-scrollbar",s),s.data("perfect-scrollbar-update",k),s.data("perfect-scrollbar-destroy",U)};return B(),s})}}),function(e){"use strict";function t(e){return e=String(e),e.charAt(0).toUpperCase()+e.slice(1)}function i(e,t){var i=-1,n=e.length;if(n==n>>>0)for(;++i<n;)t(e[i],i,e);else o(e,t)}function n(e){return e=c(e),/^(?:webOS|i(?:OS|P))/.test(e)?e:t(e)}function o(e,t){for(var i in e)r(e,i)&&t(e[i],i,e)}function s(e){return null==e?t(e):g.call(e).slice(8,-1)}function r(){return r=function(e,t){var i=null!=e&&(e.constructor||Object).prototype;return!!i&&t in Object(e)&&!(t in i&&e[t]===i[t])},"Function"==s(y)?r=function(e,t){return null!=e&&y.call(e,t)}:{}.__proto__==Object.prototype&&(r=function(e,t){var i=!1;return null!=e&&(e=Object(e),e.__proto__=[e.__proto__,e.__proto__=null,i=t in e][0]),i}),r.apply(this,arguments)}function l(e,t){var i=null!=e?typeof e[t]:"number";return!/^(?:boolean|number|string|undefined)$/.test(i)&&("object"==i?!!e[t]:!0)}function a(e){return String(e).replace(/([ -])(?!$)/g,"$1?")}function u(e,t){var n=null;return i(e,function(i,o){n=t(n,i,o,e)}),n}function c(e){return String(e).replace(/^ +| +$/g,"")}function d(t){function i(e){return u(e,function(e,i){return e||RegExp("\\b"+(i.pattern||a(i))+"\\b","i").exec(t)&&(i.label||i)})}function r(e){return u(e,function(e,i,n){return e||(i[O]||i[/^[a-z]+(?: +[a-z]+\b)*/i.exec(O)]||RegExp("\\b"+(n.pattern||a(n))+"(?:\\b|\\w*\\d)","i").exec(t))&&(n.label||n)})}function p(e){return u(e,function(e,i){return e||RegExp("\\b"+(i.pattern||a(i))+"\\b","i").exec(t)&&(i.label||i)})}function y(e){return u(e,function(e,i){var o=i.pattern||a(i);return!e&&(e=RegExp("\\b"+o+"(?:/[\\d.]+|[ \\w.]*)","i").exec(t))&&(P={6.2:"8",6.1:"Server 2008 R2 / 7","6.0":"Server 2008 / Vista",5.2:"Server 2003 / XP 64-bit",5.1:"XP",5.01:"2000 SP1","5.0":"2000","4.0":"NT","4.90":"ME"},/^Win/i.test(e)&&(P=P[/[\d.]+$/.exec(e)])&&(e="Windows "+P),e=n(String(e).replace(RegExp(o,"i"),i.label||i).replace(/ ce$/i," CE").replace(/hpw/i,"web").replace(/Macintosh/,"Mac OS").replace(/_PowerPC/i," OS").replace(/(OS X) [^ \d]+/i,"$1").replace(/\/(\d)/," $1").replace(/_/g,".").replace(/(?: BePC|[ .]*fc[ \d.]+)$/i,"").replace(/x86\.64/gi,"x86_64").split(" on ")[0])),e})}function M(e){return u(e,function(e,i){var o=i.pattern||a(i);return!e&&(e=RegExp("\\b"+o+" *\\d+[.\\w_]*","i").exec(t)||RegExp("\\b"+o+"(?:; *(?:[a-z]+[_-])?[a-z]+\\d+|[^ ();-]*)","i").exec(t))&&((e=String(i.label||e).split("/"))[1]&&!/[\d.]+/.test(e[0])&&(e[0]+=" "+e[1]),i=i.label||i,e=n(e[0].replace(RegExp(o,"i"),i).replace(RegExp("; *(?:"+i+"[_-])?","i")," ").replace(RegExp("("+i+")(\\w)","i"),"$1 $2"))),e})}function E(e){return u(e,function(e,i){return e||(RegExp(i+"(?:-[\\d.]+/|(?: for [\\w-]+)?[ /-])([\\d.]+[^ ();/_-]*)","i").exec(t)||0)[1]||null})}function A(){return this.description||""}t||(t=k);var P,V=t,I=[],x=null,F=t==k,D=F&&L&&"function"==typeof L.version&&L.version(),U=i([{label:"WebKit",pattern:"AppleWebKit"},"iCab","Presto","NetFront","Tasman","Trident","KHTML","Gecko"]),N=p(["Adobe AIR","Arora","Avant Browser","Camino","Epiphany","Fennec","Flock","Galeon","GreenBrowser","iCab","Iceweasel","Iron","K-Meleon","Konqueror","Lunascape","Maxthon","Midori","Nook Browser","PhantomJS","Raven","Rekonq","RockMelt","SeaMonkey",{label:"Silk",pattern:"(?:Cloud9|Silk-Accelerated)"},"Sleipnir","SlimBrowser","Sunrise","Swiftfox","WebPositive","Opera Mini","Opera","Chrome",{label:"Chrome Mobile",pattern:"CrMo"},{label:"Firefox",pattern:"(?:Firefox|Minefield)"},{label:"IE",pattern:"MSIE|rv"},"Safari"]),O=M(["BlackBerry",{label:"Galaxy S",pattern:"GT-I9000"},{label:"Galaxy S2",pattern:"GT-I9100"},"Google TV","iPad","iPod","iPhone","Kindle",{label:"Kindle Fire",pattern:"(?:Cloud9|Silk-Accelerated)"},"Nook","PlayBook","PlayStation Vita","TouchPad","Transformer","Xoom"]),B=r({Apple:{iPad:1,iPhone:1,iPod:1},Amazon:{Kindle:1,"Kindle Fire":1},Asus:{Transformer:1},"Barnes & Noble":{Nook:1},BlackBerry:{PlayBook:1},Google:{"Google TV":1},HP:{TouchPad:1},LG:{},Motorola:{Xoom:1},Nokia:{},Samsung:{"Galaxy S":1,"Galaxy S2":1},Sony:{"PlayStation Vita":1}}),H=y(["Android","CentOS","Debian","Fedora","FreeBSD","Gentoo","Haiku","Kubuntu","Linux Mint","Red Hat","SuSE","Ubuntu","Xubuntu","Cygwin","Symbian OS","hpwOS","webOS ","webOS","Tablet OS","Linux","Mac OS X","Macintosh","Mac","Windows 98;","Windows "]);if(U&&(U=[U]),B&&!O&&(O=M([B])),(P=/Google TV/.exec(O))&&(O=P[0]),/\bSimulator\b/i.test(t)&&(O=(O?O+" ":"")+"Simulator"),/^iP/.test(O)?(N||(N="Safari"),H="iOS"+((P=/ OS ([\d_]+)/i.exec(t))?" "+P[1].replace(/_/g,"."):"")):"Konqueror"!=N||/buntu/i.test(H)?B&&"Google"!=B&&/Chrome|Vita/.test(N+";"+O)?(N="Android Browser",H=/Android/.test(H)?H:"Android"):(!N||(P=!/\bMinefield\b/i.test(t)&&/Firefox|Safari/.exec(N)))&&(N&&!O&&/[\/,]|^[^(]+?\)/.test(t.slice(t.indexOf(P+"/")+8))&&(N=null),(P=O||B||H)&&(O||B||/Android|Symbian OS|Tablet OS|webOS/.test(H))&&(N=/[a-z]+(?: Hat)?/i.exec(/Android/.test(H)?H:P)+" Browser")):H="Kubuntu",D||(D=E(["(?:Cloud9|CrMo|Opera ?Mini|Raven|Silk(?!/[\\d.]+$))","Version",a(N),"(?:Firefox|Minefield|NetFront)"]),D||(D=(RegExp("(?:rv:(\\d+(\\.\\d+)+))","i").exec(t)||0)[1])),"iCab"==U&&parseFloat(D)>3?U=["WebKit"]:(P=/Opera/.test(N)&&"Presto"||/\b(?:Midori|Nook|Safari)\b/i.test(t)&&"WebKit"||!U&&/\bMSIE\b/i.test(t)&&(/^Mac/.test(H)?"Tasman":"Trident"))&&(U=[P]),F){if(l(e,"global"))if(v&&(P=v.lang.System,V=P.getProperty("os.arch"),H=H||P.getProperty("os.name")+" "+P.getProperty("os.version")),"object"==typeof exports&&exports)if(C==h&&"object"==typeof system&&(P=[system])[0]){H||(H=P[0].os||null);try{P[1]=require("ringo/engine").version,D=P[1].join("."),N="RingoJS"}catch(R){P[0].global==f&&(N="Narwhal")}}else"object"==typeof process&&(P=process)&&(N="Node.js",V=P.arch,H=P.platform,D=/[\d.]+/.exec(P.version)[0]);else"Environment"==s(e.environment)&&(N="Rhino");else"ScriptBridgingProxyObject"==s(P=e.runtime)?(N="Adobe AIR",H=P.flash.system.Capabilities.os):"RuntimeObject"==s(P=e.phantom)?(N="PhantomJS",D=(P=P.version||null)&&P.major+"."+P.minor+"."+P.patch):"number"==typeof w.documentMode&&(P=/\bTrident\/(\d+)/i.exec(t))&&(D=[D,w.documentMode],(P=+P[1]+4)!=D[1]&&(I.push("IE "+D[1]+" mode"),U[1]="",D[1]=P),D="IE"==N?String(D[1].toFixed(1)):D[0]);H=H&&n(H)}return D&&(P=/(?:[ab]|dp|pre|[ab]\d+pre)(?:\d+\+?)?$/i.exec(D)||/(?:alpha|beta)(?: ?\d)?/i.exec(t+";"+(F&&T.appMinorVersion))||/\bMinefield\b/i.test(t)&&"a")&&(x=/b/i.test(P)?"beta":"alpha",D=D.replace(RegExp(P+"\\+?$"),"")+("beta"==x?b:_)+(/\d+\+?/.exec(P)||"")),"Fennec"==N?N="Firefox Mobile":"Maxthon"==N&&D?D=D.replace(/\.[\d.]+/,".x"):"Silk"==N?(/Mobi/i.test(t)||(H="Android",I.unshift("desktop mode")),/Accelerated *= *true/i.test(t)&&I.unshift("accelerated")):"IE"==N&&(P=(/; *(?:XBLWP|ZuneWP)(\d+)/i.exec(t)||0)[1])?(N+=" Mobile",H="Windows Phone OS "+P+".x",I.unshift("desktop mode")):"IE"!=N&&(!N||O||/Browser|Mobi/.test(N))||"Windows CE"!=H&&!/Mobi/i.test(t)?"IE"==N&&F&&"object"==typeof external&&!external?I.unshift("platform preview"):/BlackBerry/.test(O)&&(P=(RegExp(O.replace(/ +/g," *")+"/([.\\d]+)","i").exec(t)||0)[1]||D)?(H="Device Software "+P,D=null):this!=o&&(F&&L||/Opera/.test(N)&&/\b(?:MSIE|Firefox)\b/i.test(t)||"Firefox"==N&&/OS X (?:\d+\.){2,}/.test(H)||"IE"==N&&(H&&!/^Win/.test(H)&&D>5.5||/Windows XP/.test(H)&&D>8||8==D&&!/Trident/.test(t)))&&!m.test(P=d.call(o,t.replace(m,"")+";"))&&P.name&&(P="ing as "+P.name+((P=P.version)?" "+P:""),m.test(N)?(/IE/.test(P)&&"Mac OS"==H&&(H=null),P="identify"+P):(P="mask"+P,N=S?n(S.replace(/([a-z])([A-Z])/g,"$1 $2")):"Opera",/IE/.test(P)&&(H=null),F||(D=null)),U=["Presto"],I.push(P)):N+=" Mobile",(P=(/\bAppleWebKit\/([\d.]+\+?)/i.exec(t)||0)[1])&&(P=[parseFloat(P.replace(/\.(\d)$/,".0$1")),P],"Safari"==N&&"+"==P[1].slice(-1)?(N="WebKit Nightly",x="alpha",D=P[1].slice(0,-1)):(D==P[1]||D==(/\bSafari\/([\d.]+\+?)/i.exec(t)||0)[1])&&(D=null),P=[P[0],(/\bChrome\/([\d.]+)/i.exec(t)||0)[1]],!F||/internal|\n/i.test(g.toString())&&!P[1]?(U[1]="like Safari",P=P[0],P=400>P?1:500>P?2:526>P?3:533>P?4:534>P?"4+":535>P?5:"5"):(U[1]="like Chrome",P=P[1]||(P=P[0],530>P?1:532>P?2:532.05>P?3:533>P?4:534.03>P?5:534.07>P?6:534.1>P?7:534.13>P?8:534.16>P?9:534.24>P?10:534.3>P?11:535.01>P?12:535.02>P?"13+":535.07>P?15:535.11>P?16:535.19>P?17:535.21>P?18:"19")),U[1]+=" "+(P+="number"==typeof P?".x":/[.+]/.test(P)?"":"+"),"Safari"==N&&(!D||parseInt(D)>45)&&(D=P)),D&&0==D.indexOf(P=/[\d.]+$/.exec(H))&&t.indexOf("/"+P+"-")>-1&&(H=c(H.replace(P,""))),U&&!/Avant|Nook/.test(N)&&(/Browser|Lunascape|Maxthon/.test(N)||/^(?:Adobe|Arora|Midori|Phantom|Rekonq|Rock|Sleipnir|Web)/.test(N)&&U[1])&&(P=U[U.length-1])&&I.push(P),I.length&&(I=["("+I.join("; ")+")"]),B&&O&&O.indexOf(B)<0&&I.push("on "+B),O&&I.push((/^on /.test(I[I.length-1])?"":"on ")+O),(P=/\b(?:AMD|IA|Win|WOW|x86_|x)64\b/i).test(V)&&!/\bi686\b/i.test(V)&&(H=H&&H+(P.test(H)?"":" 64-bit"),N&&(/WOW64/i.test(t)||F&&/\w(?:86|32)$/.test(T.cpuClass||T.platform))&&I.unshift("32-bit")),t||(t=null),{version:N&&D&&(I.unshift(D),D),name:N&&(I.unshift(N),N),os:H&&(N&&!(H==H.split(" ")[0]&&(H==N.split(" ")[0]||O))&&I.push(O?"("+H+")":"on "+H),H),description:I.length?I.join(" "):t,layout:U&&U[0],manufacturer:B,prerelease:x,product:O,ua:t,parse:d,toString:A}}var h=e,p="object"==typeof exports&&exports,f="object"==typeof global&&global&&(global==global.global?e=global:global),m=/Opera/,g={}.toString,v=/Java/.test(s(e.java))&&e.java,_=v?"a":"\u03b1",b=v?"b":"\u03b2",w=e.document||{},y={}.hasOwnProperty,T=e.navigator||{},L=e.operamini||e.opera,S=m.test(S=s(L))?S:L=null,C=this,k=T.userAgent||"";"function"==typeof define&&"object"==typeof define.amd&&define.amd?define(function(){return d()}):p?o(d(),function(e,t){p[t]=e}):e.platform=d()}(this),function(){var e;e=window.ThisLife=window.ThisLife||{},e.Helper={},e.Router={},e.Collection={},e.Controller={},e.Model={},e.View={},e.Sync={},e.Support={},e.Service={},e.View.Timeline={},e.View.Album={}}.call(this);/**
 * @license almond 0.3.1 Copyright (c) 2011-2014, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/jrburke/almond for details
 */
var requirejs,require,define;!function(e){function t(e,t){return v.call(e,t)}function i(e,t){var i,n,o,s,r,l,a,u,c,d,h,p=t&&t.split("/"),f=m.map,g=f&&f["*"]||{};if(e&&"."===e.charAt(0))if(t){for(e=e.split("/"),r=e.length-1,m.nodeIdCompat&&b.test(e[r])&&(e[r]=e[r].replace(b,"")),e=p.slice(0,p.length-1).concat(e),c=0;c<e.length;c+=1)if(h=e[c],"."===h)e.splice(c,1),c-=1;else if(".."===h){if(1===c&&(".."===e[2]||".."===e[0]))break;c>0&&(e.splice(c-1,2),c-=2)}e=e.join("/")}else 0===e.indexOf("./")&&(e=e.substring(2));if((p||g)&&f){for(i=e.split("/"),c=i.length;c>0;c-=1){if(n=i.slice(0,c).join("/"),p)for(d=p.length;d>0;d-=1)if(o=f[p.slice(0,d).join("/")],o&&(o=o[n])){s=o,l=c;break}if(s)break;!a&&g&&g[n]&&(a=g[n],u=c)}!s&&a&&(s=a,l=u),s&&(i.splice(0,l,s),e=i.join("/"))}return e}function n(t,i){return function(){var n=_.call(arguments,0);return"string"!=typeof n[0]&&1===n.length&&n.push(null),c.apply(e,n.concat([t,i]))}}function o(e){return function(t){return i(t,e)}}function s(e){return function(t){p[e]=t}}function r(i){if(t(f,i)){var n=f[i];delete f[i],g[i]=!0,u.apply(e,n)}if(!t(p,i)&&!t(g,i))throw new Error("No "+i);return p[i]}function l(e){var t,i=e?e.indexOf("!"):-1;return i>-1&&(t=e.substring(0,i),e=e.substring(i+1,e.length)),[t,e]}function a(e){return function(){return m&&m.config&&m.config[e]||{}}}var u,c,d,h,p={},f={},m={},g={},v=Object.prototype.hasOwnProperty,_=[].slice,b=/\.js$/;d=function(e,t){var n,s=l(e),a=s[0];return e=s[1],a&&(a=i(a,t),n=r(a)),a?e=n&&n.normalize?n.normalize(e,o(t)):i(e,t):(e=i(e,t),s=l(e),a=s[0],e=s[1],a&&(n=r(a))),{f:a?a+"!"+e:e,n:e,pr:a,p:n}},h={require:function(e){return n(e)},exports:function(e){var t=p[e];return"undefined"!=typeof t?t:p[e]={}},module:function(e){return{id:e,uri:"",exports:p[e],config:a(e)}}},u=function(i,o,l,a){var u,c,m,v,_,b,w=[],y=typeof l;if(a=a||i,"undefined"===y||"function"===y){for(o=!o.length&&l.length?["require","exports","module"]:o,_=0;_<o.length;_+=1)if(v=d(o[_],a),c=v.f,"require"===c)w[_]=h.require(i);else if("exports"===c)w[_]=h.exports(i),b=!0;else if("module"===c)u=w[_]=h.module(i);else if(t(p,c)||t(f,c)||t(g,c))w[_]=r(c);else{if(!v.p)throw new Error(i+" missing "+c);v.p.load(v.n,n(a,!0),s(c),{}),w[_]=p[c]}m=l?l.apply(p[i],w):void 0,i&&(u&&u.exports!==e&&u.exports!==p[i]?p[i]=u.exports:m===e&&b||(p[i]=m))}else i&&(p[i]=l)},requirejs=require=c=function(t,i,n,o,s){if("string"==typeof t)return h[t]?h[t](i):r(d(t,i).f);if(!t.splice){if(m=t,m.deps&&c(m.deps,m.callback),!i)return;i.splice?(t=i,i=n,n=null):t=e}return i=i||function(){},"function"==typeof n&&(n=o,o=s),o?u(e,t,i,n):setTimeout(function(){u(e,t,i,n)},4),c},c.config=function(e){return c(e)},requirejs._defined=p,define=function(e,i,n){if("string"!=typeof e)throw new Error("See almond README: incorrect module build, no module name");i.splice||(n=i,i=[]),t(p,e)||t(f,e)||(f[e]=[e,i,n])},define.amd={jQuery:!0}}(),function(){ThisLife.Helper=ThisLife.Helper||{},ThisLife.Helper.Platform={name:function(){return platform.name},version:function(){return parseFloat(platform.version)},majorVersion:function(){return parseInt(platform.version)},ie:function(){return"IE"===this.name()},ie8:function(){return this.ie()&&8===this.majorVersion()},ie9:function(){return this.ie()&&9===this.majorVersion()},ie10:function(){return this.ie()&&10===this.majorVersion()},ie11:function(){return this.ie()&&11===this.majorVersion()},msedge:function(){return bowser.msedge},firefox:function(){return"Firefox"===this.name()},chrome:function(){return"Chrome"===this.name()},safari:function(){return"Safari"===this.name()},windows:function(){return/(Windows)/.test(platform.os)},macOSX:function(){return/(Mac OS X)/.test(platform.os)},macOSX78:function(){return/Mac OS X 10.[7|8]/.test(platform.os)},macOSXVersion:function(){var e;return e=platform.os.match(/Mac OS X 10.(\d+)/),e&&e[1]?e[1]:null},android:function(){return/Android/.test(platform.os)},ios:function(){return/iphone|ipad|ipod/i.test(window.navigator.userAgent.toLowerCase())},mobile:function(){return/iphone|ipad|ipod|android|blackberry|mini|windows\sce|palm/i.test(window.navigator.userAgent.toLowerCase())},iDeviceName:function(){return window.navigator.userAgent.match(/iphone|ipad|ipod/i)},webkit:function(){return this.chrome()||this.safari()},flashVersion:function(){var e;return e="10.2",ThisLife.Helper.Platform.safari()&&ThisLife.Helper.Platform.version()>="534.50"&&swfobject.hasFlashPlayerVersion(e)&&(e="11.0"),ThisLife.Helper.Platform.firefox()&&(e="11.1"),ThisLife.Helper.Platform.firefox()&&ThisLife.Helper.Platform.majorVersion()<7&&(e="999"),e},osName:function(){return this.ios()?"ios":this.android()?"android":this.macOSX()?"osx":this.windows()?"win":"other"}},define("ThisLife.Helper.Platform",[],function(){return ThisLife.Helper.Platform})}.call(this),function(){ThisLife.Helper=ThisLife.Helper||{},ThisLife.Helper.Event={getTouches:function(e){var t,i,n,o,s;return i=e.originalEvent||e,s=(null!=(n=i.touches)?n.length:void 0)&&i.touches,t=(null!=(o=i.changedTouches)?o.length:void 0)&&i.changedTouches,s||t},fingersUsed:function(e){return this.getTouches(e).length},getTouchPos:function(e){var t,i,n;return i=n=0,t=this.getTouches(e),1===t.length&&(i=t[0].clientX,n=t[0].clientY),2===t.length&&(i=(t[0].clientX+t[1].clientX)/2,n=(t[0].clientY+t[1].clientY)/2),{x:i,y:n}},getFingersDistance:function(e){var t;return t=this.getTouches(e),2!==t.length?null:Math.hypot(t[0].clientX-t[1].clientX,t[0].clientY-t[1].clientY)}},define("ThisLife.Helper.Event",[],function(){return ThisLife.Helper.Event})}.call(this),function(){ThisLife.Helper.SflyPromos={getPromoCode:function(e){var t;return t=""+ThisLife.Settings.scheme+ThisLife.Settings.photosProdStatic+"/promos/sflypromos.json",ThisLife.Helper.SflyPromos.SiteCode?this.renderSiteCode(e):$.ajax({cache:!1,dataType:"json",url:t,success:function(t){return function(i){var n;return n=t.getTodaysPromo(i),ThisLife.Helper.SflyPromos.SitePromo=null!=n?n.SitePromo:void 0,ThisLife.Helper.SflyPromos.SiteCode=null!=n?n.SiteCode:void 0,t.renderSiteCode(e)}}(this),error:function(){return function(){return e?e(null):console.log("error getting promo codes")}}(this)})},renderSiteCode:function(e){return e?e():console.log("Today's Promo is: ",ThisLife.Helper.SflyPromos.SiteCode)},getTodaysPromo:function(e){var t;return t=_.find(e,function(e){var t,i,n;return n=new Date,t=ThisLife.Helper.Date.cleanYear(e.Date),i=new Date(t),ThisLife.Helper.Date.areEqualUTC(n,i)})}}}.call(this),function(){define("ThisLife.Helper.Object",[],function(){var e,t;return e={deepMerge:function(i,n){var o,s,r;if(i&&n&&"object"==typeof i&&"object"==typeof n&&!Array.isArray(i)&&!Array.isArray(n)){r=[];for(s in n)n[s]instanceof Date?(i[s]=new Date,r.push(i[s].setTime(n[s].getTime()))):"object"!=typeof n[s]||Array.isArray(n[s])?(o={},o[s]=n[s],r.push(t(i,o))):(i[s]||(o={},o[s]={},t(i,o)),r.push(e.deepMerge(i[s],n[s])));return r}},clone:function(t){var i,n,o,s,r,l,a,u;if("function"!=typeof t){if(null===t)return null;if(t instanceof Date)return n=new Date,n.setTime(t.getTime()),n;if(t instanceof Array){for(i=[],s=o=0,a=t.length;a>o;s=++o)r=t[s],i[s]=e.clone(r);return i}if(t instanceof Object){u={};for(l in t)t.hasOwnProperty(l)&&(u[l]=e.clone(t[l]));return u}return t}}},t=function(e,t){var i;for(i in t)e[i]=t[i]},e}),ThisLife.Helper.Object=require("ThisLife.Helper.Object")}.call(this),function(){define("ThisLife.Helper.OrderPrints",[],function(){var e={getProductsUrl:function(){return ThisLife.Settings.sflyApp+this.getProductsPath()},getProductsPath:function(){return"/orderpictures/start.sfly?cid="},getNxgenUrl:function(e,t){var i=e.person_uid;return ThisLife.Helper.String.formatString(ThisLife.Settings.sflyMediaCopyUrl,[i])+"?access_token="+t},shouldCopyToNxgen:function(e,t){return!!e.get("story_moment_created_by")&&e.get("story_moment_created_by")!=t},getLifeOwnerId:function(e){return e.person_uid!=e.owner_person_uid?e.owner_person_uid:e.person_uid},redirectToCart:function(e,t,i,n){if(null!=n){e=this.replacePhotoIdsInPrints(e,n);var o=document.createElement("form");o.setAttribute("action",this.getProductsUrl()),o.setAttribute("method","post"),o.setAttribute("style","display:none;");var s=document.createElement("input");s.setAttribute("type","text"),s.setAttribute("name","cid"),s.setAttribute("value","");var r=document.createElement("input");r.setAttribute("type","text"),r.setAttribute("name","uid"),r.setAttribute("value",t);var l=document.createElement("input");l.setAttribute("type","text"),l.setAttribute("value",e.length>0?e:""),l.setAttribute("name","shareIds");var a=document.createElement("input");a.setAttribute("type","text"),a.setAttribute("name","interceptSource"),a.setAttribute("value",i),o.appendChild(l),o.appendChild(s),o.appendChild(r),o.appendChild(a),$(o).appendTo("body"),$(o).submit()}},addToCart:function(e){var t=_.map(e,function(e){return e.id}),i=ThisLife.Model.User.getLifePermission(),n=i.person_uid,o="sflyphotos/prints/manualselect",s=this;this.sendToNxgen(e,i,function(e){s.redirectToCart(t,n,o,e)})},createPhotosMap:function(e){var t={};return e.forEach(function(e){t[e.mediaId]=e.mspPath.split(":")[1]}),t},replacePhotoIdsInPrints:function(e,t){var i=[];return e.forEach(function(e){i.push("undefined"!=typeof t[e]?t[e]:e)}),i.join(",")},sendToNxgen:function(e,t,i){var n=this,o=this.getLifeOwnerId(t),s=_.filter(e,function(e){return n.shouldCopyToNxgen(e,o)}),r=_.map(s,function(e){return{userId:e.get("story_moment_created_by")||o,mediaId:e.id}});r.length>0?ThisLife.app.session.getSessionToken().then(function(e){$.ajax({url:this.getNxgenUrl(t,e),type:"POST",crossDomain:!0,data:JSON.stringify(r),dataType:"json",contentType:"application/json",success:function(e){_.isFunction(i)&&i(n.createPhotosMap(e))},error:function(){i(null)}})}.bind(this)):_.isFunction(i)&&i({})}};return e}),ThisLife.Helper.OrderPrints=require("ThisLife.Helper.OrderPrints")}.call(this),function(){define("ThisLife.Mobile.PinchZoom",[],function(){var e,t;return t=function(e,t){return e>t-.1&&t+.1>e},e=function(e,t){if(null==t&&(t={}),!(e instanceof HTMLImageElement))throw new Error("Argument is required: a valid image element must be provided");if(!t.container&&!e.parentElement)throw new Error("Container is required: a container must be found or specified");return this.initialTransform=null,this.initialScale=1,this.initialTouchPos={x:0,y:0},this.currentScale=1,this.imageLastPos={x:0,y:0},this.lastTouch={time:null,position:{x:0,y:0},distance:null},this.options=_.extend(this.defaultOptions,t),this.image=e,this.container=this.options.container||this.image.parentElement,this.bindMethods(),this.bindEvents(),this.setupImage()},e.prototype={defaultOptions:{minZoom:1,maxZoom:2,tapZoomFactor:2,zoomOutFactor:1.1},bindMethods:function(){return this.touchStart=this.touchStart.bind(this),this.touchMove=this.touchMove.bind(this),this.touchEnd=this.touchEnd.bind(this)},bindEvents:function(){return this.image.addEventListener("touchstart",this.touchStart),this.image.addEventListener("touchmove",this.touchMove),this.image.addEventListener("touchend",this.touchEnd)},unbindEvents:function(){return this.image.removeEventListener("touchstart",this.touchStart),this.image.removeEventListener("touchmove",this.touchMove),this.image.removeEventListener("touchend",this.touchEnd)},setupImage:function(){return this.image.style.position="absolute"},getTouches:ThisLife.Helper.Event.getTouches,getTouchPos:ThisLife.Helper.Event.getTouchPos,getFingersDistance:ThisLife.Helper.Event.getFingersDistance,isZoomedIn:function(){return this.currentScale>1},getImageNewPos:function(e){var t,i,n,o,s,r,l,a,u,c;return o=e.scale,u=e.touchPos,l={x:this.initialTouchPos.x*o,y:this.initialTouchPos.y*o},t=this.getImageSize(),r={w:t.w*o,h:t.h*o},a=this.getContainerSize(),s={x:(r.w-t.w*this.initialScale)/2-(l.x-this.initialTouchPos.x*this.initialScale),y:(r.h-t.h*this.initialScale)/2-(l.y-this.initialTouchPos.y*this.initialScale)},n={x:this.initialTouchPos.x-u.x,y:this.initialTouchPos.y-u.y},i={x:Math.round(this.boundsTranslateX(this.initialTransform.translate[0].value-n.x+s.x,o)),y:Math.round(this.boundsTranslateY(this.initialTransform.translate[1].value-n.y+s.y,o))},c={x:r.w>a.w?i.x:0,y:r.h>a.h?i.y:0}},updateImage:function(e){var t,i,n,o,s,r,l;return o=e.scale,s=e.touchPos||{x:0,y:0},t=e.animate,n="no-transition",i=this.image.classList,t&&i.contains(n)&&i.remove(n),t||i.contains(n)||i.add(n),l=this.getImageNewPos({scale:o,touchPos:s}),r=this.getCurrentTransform(),r.translate=[{value:l.x,unit:r.translate[0].unit},{value:l.y,unit:r.translate[1].unit}],r.scale[0].value=o,this.image.style.transform=this.stringifyTransformProps(r),this.imageLastPos=l,this.currentScale=o},getCurrentTransform:function(){var e,t,i;return i={translate:[{value:0,unit:"px"},{value:0,unit:"px"}],scale:[{value:1,unit:""}]},e=this.image.style.transform||"",t=e.match(/[\w]+\([^\)]+\)/g),t&&t.forEach(function(e){var t,n,o;return t=e.match(/\w+(?=\()/g)[0],o=e.match(/(-*\d+[\.\d]*[^\s,\)\(]*)/g),n=function(e){var t;return t=e.match(/(-*\d+[\.\d]*)(\w+)?/),{value:Number(t[1]),unit:t[2]||""}},o=_.map(o,n),i[t]=o}),i},stringifyTransformProps:function(e){var t,i,n,o;return i=function(){var i;i=[];for(t in e)i.push({name:t,value:e[t]});return i}(),o=function(e,t){return e.push(""+t.value+t.unit),e},n=function(e,t){var i,n;return i=t.name,n=_.reduce(t.value,o,[]).join(", "),e.push(i+"("+n+")"),e},_.reduce(i,n,[]).join(" ")},sanitizedScale:function(e){var t,i,n;if(_.isNumber(e))return i=function(e){return function(t){return Math.max(e.options.minZoom,t)}}(this),t=function(e){return function(t){return Math.min(e.options.maxZoom,t)}}(this),(n=_.compose(i,t))(e)},boundsTranslateX:function(e,t){var i,n,o;return n=this.getImageSize(),o=this.getContainerSize(),i=Math.round((n.w*t-o.w)/2),e=Math.min(i,Math.max(-i,e)),e===-0&&(e=0),e},boundsTranslateY:function(e,t){var i,n,o;return n=this.getImageSize(),o=this.getContainerSize(),i=Math.round((n.h*t-o.h)/2),e=Math.min(i,Math.max(-i,e)),e===-0&&(e=0),e},pinchStart:function(e){return this.lastTouch.distance=this.getFingersDistance(e)},pinchMove:function(e){var t,i,n;return t=this.getFingersDistance(e),i=t*this.initialScale/this.lastTouch.distance,n=this.sanitizedScale(i),this.updateImage({scale:n,touchPos:this.getTouchPos(e)})},pinchEnd:function(){var e,i;return e=t(this.options.zoomOutFactor,this.currentScale),i=this.isZoomedIn()&&e,i?(this.updateImage({scale:1,animate:!0}),this.initialScale=1):void 0},touchStart:function(e){var t;t=this.fingersUsed(e),this.initialTouchPos=this.getTouchPos(e),this.initialTransform=this.getCurrentTransform(),1===t&&(this.isZoomedIn()&&this.panningStart(e),this.detectDoubleTap(e)),2===t&&this.pinchStart(e)},touchMove:function(e){var t;return e.preventDefault(),t=this.fingersUsed(e),1===t&&this.isZoomedIn()&&this.panningMove(e),2===t&&this.pinchMove(e)},touchEnd:function(e){return this.initialTouchPos=this.getTouchPos(e),this.initialTransform=this.getCurrentTransform(),this.initialScale=this.currentScale,this.pinchEnd(e)},detectDoubleTap:function(e){var t,i,n,o,s,r;return r={time:new Date,position:this.getTouchPos(e)},s=300,i=r.time-this.lastTouch.time<=s,t=r.position.x-this.lastTouch.position.x<10&&r.position.y-this.lastTouch.position.y<10,i&&t&&(this.isZoomedIn()?this.updateImage({scale:1,animate:!0}):(this.initialTouchPos=r.position,this.initialTransform=this.getCurrentTransform(),n=this.getImageSize(),o={x:n.w/2,y:n.h/2},this.updateImage({scale:this.options.tapZoomFactor,touchPos:o,animate:!0}))),this.lastTouch.position=r.position,this.lastTouch.time=r.time},panningStart:function(e){return this.lastTouch.position=this.getTouchPos(e)},panningMove:function(e){return this.updateImage({scale:this.currentScale,touchPos:this.getTouchPos(e)})},getImageSize:function(){return{w:this.image.offsetWidth||this.image.width,h:this.image.offsetHeight||this.image.height}},getContainerSize:function(){return{w:this.container.offsetWidth||this.container.width,h:this.container.offsetHeight||this.container.height}},fingersUsed:ThisLife.Helper.Event.fingersUsed,remove:function(){return this.unbindEvents()}},e}),ThisLife.Mobile||(ThisLife.Mobile={}),ThisLife.Mobile.PinchZoom=require("ThisLife.Mobile.PinchZoom")}.call(this),ThisLife.LogSmithManager=function(){function e(){function e(e){return 0===e||e?"_"+e:""}function t(){return a.userId||(a.appName=r.appName,a.appVer=r.appVersion,a.userId=ThisLife.currentLifeOwner,a.browserName=bowser.name,a.browserVersion=bowser.version,a.browserUserAgent=window.navigator.userAgent),a}function i(e){if(l.length>0){var i=new XMLHttpRequest,n="prod"==ThisLife.Settings.sflyEnv?r.prodUrl:r.preProdUrl.replace("{0}",ThisLife.Settings.sflyEnv),s={};i.open("POST",n,!0),i.setRequestHeader("Content-Type","application/json"),i.onreadystatechange=function(){i.readyState>=3&&("function"==typeof e&&e(),e=null)},s.metrics=l,s.attributes=t(),i.send(JSON.stringify(s)),l.splice(0)}else"function"==typeof e&&e(),o()}function n(){u||(s=setInterval(function(){i()},r.timeInterval),u=!0)}function o(){clearInterval(s),u=!1}var s,r={appName:"SUPERFLY",appVersion:2,services:{UPLOAD_SESSIONS:"uploadSessions",UPLOAD_IMAGE:"uploadV1",UPLOAD_VIDEO:"uploadVideo",SAVE_VIDEO:"saveVideo",DUPE_DELETED_PUSHER:"duplicateMomentDeletedPusher",MOMENT_CREATED_PUSHER:"momentCreatedPusher",UPLOAD_STATISTICS:"uploadStatistics"},preProdUrl:"https://logsmith.stage.shutterfly.com/env/{0}/metrics",prodUrl:"https://l.shutterfly.com/env/prod/metrics",timeInterval:15e3},l=[],a={},u=!1;return{APP_NAME:r.appName,APP_VERSION:r.appVersion,services:r.services,flushMetrics:function(e){i(e)},enqueueSessionMetrics:function(e){if(e){var t=e.category||"",i={},o=["uploaders",this.APP_NAME,this.APP_VERSION,"auth",t,"session",e.name];i.value=e.value,i.timestamp=e.timestamp,i.name=o.join("."),i.type="gauge",l.push(i),e.attributes&&(i.attributes=e.attributes),n()}},enqueueMetrics:function(t){if(t){var i=t.name||"",o=t.status||"";if(t.statusCode||t.errCode){var s=t.statusCode||"";t.status&&(o=t.status+"_"),i=o+s+e(t.errCode)}else i=o+"."+i;var r={},a=["uploaders",this.APP_NAME,this.APP_VERSION,"auth",t.category,t.type,i];r.value=t.value,r.timestamp=t.timestamp,r.name=a.join("."),r.type="gauge",l.push(r),n()}},enqueueGenericMetrics:function(e){if(e){var t={},i=["PHOTOSWEB",this.APP_VERSION,e.category,e.name];t.value=e.value,t.timestamp=e.timestamp,t.name=i.join("."),t.type="gauge",l.push(t),n()}},enqueuePusherMetrics:function(e){if(e){var t={},i=["PHOTOSWEB",this.APP_VERSION,"pusher"];i=i.concat([].concat(e.name)),t.value=e.value,t.timestamp=e.timestamp,t.name=i.join("."),t.type="gauge",e.attributes&&(t.attributes=e.attributes),l.push(t),n()}}}}return e()}(),define("Optimizely",[],function(){function e(e){var t=e+("prod"==r.sflyEnv?"_prod":"_stage");return t}function t(){return window.OptimizelyDatafile?(i||(i=window.optimizelyClient.createInstance({datafile:window.OptimizelyDatafile})),i):null}var i,n,o,s,r=ThisLife.Settings;return s={setUser:function(e,t){n=e,o=t},activateTest:function(i){var s=t();return s?s.activate(e(i),n,o):"control"},trackEvent:function(e,i){var s=t();s&&s.track(e,n,o,i)},setForcedVariation:function(i,o){var s=t();s&&s.setForcedVariation(e(i),n,o)}}}),ThisLife.Optimizely=require("Optimizely"),function(){String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)},Date.unix=function(e){return Math.round(1e-4*e)},Date.prototype.toUnix=function(){return Math.ceil(this/1e3)},Element.prototype.prependChild=function(e){return this.insertBefore(e,this.firstChild)}}.call(this),function(){$.fn.hasParent=function(e){var t;return e=$(e),t=!1,$(this[0]).parents().andSelf().each(function(){return-1!==$.inArray(this,e)?(t=!0,!1):void 0}),t}}.call(this),function(){var e;window.APIModel=Backbone.Model.extend({url:ThisLife.Settings.apiUrl,idAttribute:"uid",fetch:function(t){var i,n,o,s,r;return s=this,n=Date.now(),r=t.success,i=t.error,t.type="POST","jsonp"!==t.dataType&&null==t.jsonp&&(t.jsonp=!1),t.data=APIModel.transformData(t),t.success=function(e,o,l){var a;try{if(!s.set(s.parse(e,l),t))return!1}catch(u){if(a=u,"No Moment Found"===a)return void i(s,e);throw a}return r&&r(s,e,Date.now()-n),s.trigger("sync",s,e,t)},t.error=function(e,o){return"abort"!==o?(ThisLife.Helper.Error.errorHelper(e),i&&i(s,e,Date.now()-n),s.trigger("error",s,e,t)):void 0},null!=this._abortableRequestGroup&&this._abortableRequestGroup.abortAllForMethod(t.method),t.url=this.url+("?method="+t.method),o=(this.sync||Backbone.sync).call(this,"read",this,t),t.abortable&&(null==this._abortableRequestGroup&&(this._abortableRequestGroup=new e),this._abortableRequestGroup.add(t.method,o)),o},parse:function(e){return e.result.payload}}),ThisLife.Model.StatusModel=Backbone.Model.extend({url:ThisLife.Settings.scheme+"status."+ThisLife.Settings.tlDomain,fetch:function(e){return(this.sync||Backbone.sync).call(this,"read",this,e)}}),ThisLife.Model.FacebookModel=Backbone.Model.extend({url:function(){var e;return e=ThisLife.Model.User.get("facebook_access_token"),ThisLife.Settings.fbUrl+("/me/?fields=permissions&access_token="+e)},parse:function(e){var t,i,n,o,s;if(o={},e.permissions&&e.permissions.data)for(s=e.permissions.data,t=0,i=s.length;i>t;t++)n=s[t],"granted"===n.status&&(o[n.permission]=1);return o}}),ThisLife.Model.FacebookPermissions=ThisLife.Model.FacebookModel.extend({hasPermission:function(e){return this.get(e)}}),ThisLife.Model.ShutterflyCommandModel=Backbone.Model.extend({url:ThisLife.Settings.sflyCmd+"/commands/getpricevalue",fetch:function(e){var t,i;return t=this,i=e.success,e.type="GET",e.data="productSKU="+e.params,(this.sync||Backbone.sync).call(this,"read",this,e)},parse:function(e){return e.result.payload},getPrices:function(e,t){return this.fetch({params:e.join(),success:function(){return function(e,i){return t?t(i,e):void 0}}(this)})}}),ThisLife.Collection.ShareSitesGetUserSites=Backbone.Collection.extend({url:ThisLife.Settings.sflyCmd+"/commands/ofly/getusersites",getOptions:function(e){var t;return t={},t.type="GET",t.data={fields:"role",contentSource:"ThisLife",access_token:e,format:"js"},t},parse:function(e){var t;return null!=(t=e.result)?t.payload:void 0},getSites:function(e,t){var i;return i=_.extend(this.getOptions(e),{success:function(){return function(i,n){return t?t(i,n,e):void 0}}(this)}),this.fetch(i)}}),ThisLife.Collection.ShareSitesGetSectionList=Backbone.Collection.extend({url:ThisLife.Settings.sflyCmd+"/commands/ofly/site/section/list",getOptions:function(e,t){var i;return i={},i.type="GET",i.data={site:e,contentSource:"ThisLife",access_token:t,format:"js",sectionType:"PicturesSection,VideosSection"},i},parse:function(e){var t;return null!=(t=e.result)?t.payload:void 0},getSections:function(e,t){var i;return i=_.extend(this.getOptions(e.site,e.token),{success:function(){return function(e,i){return"function"==typeof t?t(e,i):void 0}}(this)}),this.fetch(i)}}),ThisLife.Model.ShareSitesAdd=Backbone.Model.extend({initialize:function(e,t){return this.url=t.url},parse:function(e){var t;return null!=(t=e.result)?t.payload:void 0},addToShareSite:function(e,t){return this.fetch({type:"POST",data:JSON.stringify(e),success:function(e,i){return"function"==typeof t?t(e,i):void 0}})}}),e=function(){function e(){this._requestsByMethod={}}return e.prototype.add=function(e,t){return null==this._requestsByMethod[e]&&(this._requestsByMethod[e]=[]),this._requestsByMethod[e].push(t),t.always(function(e){return function(){return e._removeCompleted()}}(this))},e.prototype.abortAllForMethod=function(e){var t,i,n,o;if(o=this._requestsByMethod[e],null!=o){for(t=0,i=o.length;i>t;t++)n=o[t],0<n.readyState&&4>n.readyState&&n.abort();return this._requestsByMethod[e]=o}},e.prototype._removeCompleted=function(){var e,t,i,n;t=this._requestsByMethod,n=[];for(e in t)i=t[e],i=_.filter(i,function(e){return!(4===e.readyState||"abort"===e.statusText)}),n.push(this._requestsByMethod[e]=i);return n},e}()}.call(this),function(){window.APIShortModel=Backbone.Model.extend({url:ThisLife.Settings.apiUrl,initialize:function(e){return null==e&&(e={}),e.url&&(this.url=e.url)},fetch:function(e){var t,i,n,o;return n=this,i=Date.now(),o=e.success,t=e.error,e.type="POST","jsonp"!==e.dataType&&null==e.jsonp&&(e.jsonp=!1),e.data=APIShortModel.transformData(e),e.success=function(e){return n.parse(e)?o?o(n,e,Date.now()-i):void 0:!1},e.error=function(o){return ThisLife.Helper.Error.errorHelper(o),n.trigger("error",n,o,e),t?t(n,o,Date.now()-i):void 0},e.url=this.url+("?method="+e.method),(this.sync||Backbone.sync).call(this,"read",this,e)},parse:function(e){var t;return t=e.result,t.payload?t.payload:t}})}.call(this),function(){window.APICollection=Backbone.Collection.extend({url:ThisLife.Settings.apiUrl,model:APIModel,fetch:function(e){var t,i;return t=this,i=e.success,e.type="POST",e.data=APICollection.transformData(e),e.success=function(n,o,s){return t[e.add?"add":"reset"](t.parse(n,s),e),i?i(t,n):void 0},e.error=function(i){return ThisLife.Helper.Error.errorHelper(i),t.trigger("error",t,i,e)},(this.sync||Backbone.sync).call(this,"read",this,e)},parse:function(e){var t;return t=e.result,t?t.payload:e}})}.call(this),function(){window.APIShortCollection=Backbone.Collection.extend({url:ThisLife.Settings.apiUrl,fetch:function(e){var t,i;return t=this,i=e.success,e.type="POST","jsonp"!==e.dataType&&null==e.jsonp&&(e.jsonp=!1),e.data=APIShortCollection.transformData(e),e.success=function(n,o,s){return t[e.add?"add":"reset"](t.parse(n,s),e),i?i(t,n):void 0},e.error=function(i){return ThisLife.Helper.Error.errorHelper(i),t.trigger("error",t,i,e)},(this.sync||Backbone.sync).call(this,"read",this,e)},parse:function(e){return e.result.payload},_prepareModel:function(e,t){var i;return _.isString(e)&&(e={name:e}),e instanceof Backbone.Model?e.collection||(e.collection=this):(i=e,e=new this.model(i,{collection:this}),e.validate&&!e._performValidation(i,t)&&(e=!1)),e}})}.call(this),function(){var e,t;t=[],e=function(){function e(){APIModel.transformData=_.bind(this.transformData,this),APIShortModel.transformData=_.bind(this.transformData,this),APICollection.transformData=_.bind(this.transformData,this),APIShortCollection.transformData=_.bind(this.transformData,this),_.bindAll(this,"logout")}return _.extend(e.prototype,Backbone.Events),e.prototype.setup=function(e){return this.onGetSubSource=e},e.prototype.getStoryInfo=function(e,t,i){return(new APIModel).fetch({method:"getStoryInfo",params:[e],success:function(e){return function(i,n){return n.result.success||e.error(n),"function"==typeof t?t(n,i):void 0}}(this),error:i})},e.prototype.getStoryDetail=function(e,t,i,n,o){return(new APIModel).fetch({method:"getStory",params:[i,e,t],success:function(){return function(e,t){return t.result.success?(e.loaded=!0,n(e)):o()}}(this),error:o})},e.prototype.getPersonInfo=function(e,t,i){return null==i&&(i=!1),ThisLife.app.session.getSessionToken().then(function(){return function(n){return(new APIModel).fetch({method:"getPersonInfo",params:[n,i],success:function(t,i){return"function"==typeof e?e(t,i):void 0},error:function(){return"function"==typeof t?t():void 0}})}}(this))},e.prototype.getExifData=function(e,t){return e.fetch({success:function(e,i){return"function"==typeof t?t(e,i):void 0},error:function(){return arguments}})},e.prototype.rotateMoment=function(e,t){return ThisLife.app.session.getSessionToken().then(function(i){return function(n){return(new APIModel).fetch({method:"rotateMoment",params:[n,e,t],success:function(e,t){return t.result.success?void 0:i.error(t)}})}}(this))},e.prototype.rotateMoments=function(e,t,i,n){return ThisLife.app.session.getSessionToken().then(function(o){return function(s){return(new APIModel).fetch({method:"moment.rotateMoments",params:[s,e,t],success:function(e,t){return"function"==typeof i&&i(e,t),t.result.success?void 0:o.error(t)},error:function(){return"function"==typeof n?n():void 0}})}}(this))},e.prototype.inviteToLife=function(e,t){return ThisLife.app.session.getSessionToken().then(function(){return function(i){var n;return(new APIModel).fetch({method:"inviteToLife",params:[i,[e],n=!1],success:function(e,i){return t?t(e,i):void 0}})}}(this))},e.prototype.getServerStatus=function(e){return(new ThisLife.Model.StatusModel).fetch({success:function(t,i){return e?e(t,i):void 0}})},e.prototype.deleteAccount=function(e,t){return ThisLife.app.session.getSessionToken().then(function(i){return function(n){return(new APIShortModel).fetch({method:"deleteAccount",params:[n,e],success:function(e,n){var o;return n.result.success||"invalid password."===(null!=(o=n.result.message)?o.toLowerCase():void 0)||i.error(n),t?t(n):void 0}})}}(this))},e.prototype.importSflyAll=function(e,t){return ThisLife.app.session.getSessionToken().then(function(i){return function(n){var o;return o=[n,ThisLife.lifeUid],i._importSfly(o,e,t)}}(this))},e.prototype.importSflyAlbum=function(e,t,i){return ThisLife.app.session.getSessionToken().then(function(n){return function(o){var s;return s=[o,ThisLife.lifeUid,{albumId:e}],n._importSfly(s,t,i)}}(this))},e.prototype.importSflyPhotos=function(e,t,i){return ThisLife.app.session.getSessionToken().then(function(n){return function(o){var s;return s=[o,ThisLife.lifeUid,{photos:e}],n._importSfly(s,t,i)}}(this))},e.prototype.importSharedStoryMoments=function(e,t,i,n){return ThisLife.app.session.getSessionToken().then(function(){return function(o){return(new APIShortModel).fetch({method:"importSharedStoryMoments",params:[o,e,t],success:function(e,t){return t.result.success?"function"==typeof i?i(t):void 0:"function"==typeof n?n(t):void 0},error:function(e,t){return"function"==typeof n?n(t):void 0}})}}(this))},e.prototype._importSfly=function(e,t,i){return(new APICollection).fetch({method:"importSfly",params:e,success:function(e){return function(n,o){if(o.result.success){if(t)return t(n,o)}else if(e.error(o),i)return i(o)}}(this)})},e.prototype.getLifeMembers=function(e,t){return ThisLife.app.session.getSessionToken().then(function(i){return function(n){var o,s;return s=APIModel.extend({idAttribute:"life_permission_uid"}),o=APICollection.extend({model:s}),(new o).fetch({method:"getLifeMembers",params:[n,ThisLife.lifeUid],success:function(n,o){return o.result.success?"function"==typeof e?e(n,o):void 0:("function"==typeof t&&t(n,o),i.error(o))},error:t})}}(this))},e.prototype.deleteLifePermission=function(e,t){return ThisLife.app.session.getSessionToken().then(function(i){return function(n){return(new APIShortModel).fetch({method:"deleteLifePermission",params:[n,e],success:function(e,n){return n.result.success?t?t(n):void 0:i.error(n)}})}}(this))},e.prototype.getServerTime=function(e,t){return(new APIShortModel).fetch({method:"getServerTime",params:[],success:function(i,n){var o;return o=n.result,o.success?e(o.payload):t()}})},e.prototype.getStartUpInfo=function(e,t){return ThisLife.app.session.getSessionToken().then(function(){return function(i){return ThisLife.app.controller("timing").startTimer("getStartupInfo"),(new APIShortModel).fetch({method:"getStartupInfo",params:[i,null,null,!0,!0],success:function(i,n){var o;return o=n.result,o.success?(ThisLife.app.controller("timing").endTimer("getStartupInfo",{success:!0,firstLoggedOut:ThisLife.firstLoggedOut}),e(o.payload)):(ThisLife.app.controller("timing").endTimer("getStartupInfo",{success:!1,firstLoggedOut:ThisLife.firstLoggedOut}),t(n))}})}}(this))},e.prototype.getRecentMoments=function(e,t,i){return ThisLife.app.session.getSessionToken().then(function(){return function(n){return(new APIModel).fetch({method:"getRecentMoments",params:[n,e],success:function(e,n){return n.result.success?"function"==typeof t?t(n.result.payload.moments):void 0:"function"==typeof i?i():void 0},error:function(){return"function"==typeof i?i():void 0}})}}(this))},e.prototype.getProductCreationMoments=function(e,t){return ThisLife.app.session.getSessionToken().then(function(){return function(i){return(new APIShortModel).fetch({method:"getProductCreationMoments",params:[i],success:function(i,n){return n.result.success?"function"==typeof e?e(n.result.payload):void 0:(error(n),"function"==typeof t?t():void 0)}})}}(this))},e.prototype.getZuoraRatePlans=function(e,t){return ThisLife.app.session.getSessionToken().then(function(){return function(i){return(new APIShortModel).fetch({method:"getZuoraRatePlans",params:[i,e],success:function(e,i){return t?t(i,e):void 0}})}}(this))},e.prototype.getAllZuoraRatePlans=function(e){return ThisLife.app.session.getSessionToken().then(function(){return function(t){return(new APIShortModel).fetch({method:"getAllZuoraRatePlans",params:[t],success:function(t,i){return e?e(i,t):void 0}})}}(this))},e.prototype.getSubscriptionInfo=function(e){return ThisLife.app.session.getSessionToken().then(function(t){return function(i){return(new APIShortModel).fetch({method:"getSubscriptionInfo",params:[i],success:function(i,n){var o;
return n.result.success?(ThisLife.Model.User.set({default_life_subscription:n.result.payload}),o=ThisLife.Model.User.get("default_life_subscription"),delete o.creditCardAddress1,delete o.creditCardAddress2,delete o.creditCardCity,delete o.creditCardCountry,delete o.creditCardExpirationMonth,delete o.creditCardExpirationYear,delete o.creditCardHolderName,delete o.creditCardMaskNumber,delete o.creditCardPostalCode,delete o.creditCardState,delete o.creditCardType,ThisLife.PubSub.trigger("api:subscriptionUpdated"),e?e(n,i):void 0):t.error(n)}})}}(this))},e.prototype.getSubscriptionBillingInfo=function(e,t){return ThisLife.app.session.getSessionToken().then(function(){return function(i){return(new APIShortModel).fetch({method:"getSubscriptionInfo",params:[i],success:function(i,n){return n.result.success?e(n.result.payload):"function"==typeof t?t(n):void 0},error:function(e,i){return"function"==typeof t?t(i):void 0}})}}(this))},e.prototype.setSubscriptionAutoRenew=function(e,t){return ThisLife.app.session.getSessionToken().then(function(i){return function(n){var o;return o=new APIModel,o.fetch({method:"setSubscriptionAutoRenew",params:[n,e],success:function(e,n){return n.result.success?t?t(n,e):void 0:i.error(n)}}),o}}(this))},e.prototype.updateSubscription=function(e,t){return ThisLife.app.session.getSessionToken().then(function(i){return function(n){var o,s;return s=null,o=new APIModel,o.fetch({method:"updateSubscription",params:[n,e,s],success:function(e,n){return n.result.success?t?t(n,e):void 0:i.error(n)}}),o}}(this))},e.prototype.getMomentSharedWith=function(e,t){return ThisLife.app.session.getSessionToken().then(function(i){return function(n){return(new APIModel).fetch({method:"getMomentSharedWith",params:[n,e],success:function(e,n){return n.result.success?t?t():void 0:i.error(n)}})}}(this))},e.prototype.setSubSource=function(e,i){return t[e]=i},e.prototype.clearSubSource=function(e){return delete t[e]},e.prototype.shareMoments=function(e,i){var n,o,s,r,l;return s=e.publish_photos?!0:!1,n=e.facebook_album_id||!1,o=e.facebook_new_album_name||!1,l={twitter:e.twitter,facebook:e.facebook,flickr:e.flickr,tumblr:e.tumblr,youtube:e.youtube,emails:e.emails,facebook_ids:e.facebookIds,publish_photos:s,short_url_only:e.urlOnly,cc:e.cc,facebook_album_id:n,facebook_new_album_name:o},r=null,ThisLife.app.session.getSessionToken().then(function(n){return function(o){return(new APIShortModel).fetch({method:"shareMoments",subSource:t.shareMoments,params:[o,e.momentUids,e.message,l,r,e.storyUid],success:function(e,t){return t.result.success||n.error(t),"function"==typeof i?i(t):void 0}})}}(this))},e.prototype.updatePerson=function(e,t){return ThisLife.app.session.getSessionToken().then(function(i){return function(n){return(new APIModel).fetch({method:"updatePerson",params:[n,e],success:function(e,n){return n.result.success?"function"==typeof t?t():void 0:i.error(n)}})}}(this))},e.prototype.resetPassword=function(e){var t;return t=ThisLife.Model.User.get("email"),(new APIModel).fetch({method:"resetPassword",params:[t],success:function(t){return function(i,n){return n.result.success?"function"==typeof e?e(i,n):void 0:t.error(n)}}(this)})},e.prototype.changePassword=function(e,t,i){return ThisLife.app.session.getSessionToken().then(function(n){return function(o){return(new APIShortModel).fetch({method:"changePassword",params:[o,e,t],success:function(e,t){return t.result.success||n.error(t),i?i(t.result.success):void 0}})}}(this))},e.prototype.logout=function(e,t){return ThisLife.app.session.getSessionToken().then(function(){return function(i){return(new APIShortModel).fetch({method:"logout",params:[i],success:e,error:t})}}(this))},e.prototype.shutterflyLogout=function(e){return ThisLife.Helper.URL.redirect(ThisLife.Helper.URL.formatUrl(ThisLife.Settings.sflyApp+"/signout/start.sfly",{re:encodeURIComponent(e),logout:!0,logoutSynchronously:!0}))},e.prototype.getLocationTaggings=function(e,t){return ThisLife.app.session.getSessionToken().then(function(i){return function(n){return(new APIShortModel).fetch({method:"getLocationTaggings",params:[n,[],e],success:function(e,n){return n.result.success||i.error(n),t?t(n.result.payload):void 0}})}}(this))},e.prototype.getSignedUrl=function(e,t){return ThisLife.app.session.getSessionToken().then(function(i){return function(n){return(new APIShortModel).fetch({method:"signUrl",params:[n,e],success:function(e,n){return n.result.success||i.error(n),t?t(n.result.payload.signedUrl):void 0}})}}(this))},e.prototype.intercom=function(){var e,t,i;return t=document.createElement("script"),t.type="text/javascript",t.async=!0,t.src="https://api.intercom.io/api/js/library.js",i=document.getElementsByTagName("script")[0],i.parentNode.insertBefore(t,i),e=new Date(ThisLife.Model.User.get("subscriptions")[0].created.date).toUnix(),window.intercomSettings={app_id:"jyy1fjd4",email:ThisLife.Model.User.get("email"),created_at:e,widget:{activator:"#IntercomDefaultWidget"}}},e.prototype.getMomentTags=function(e){return ThisLife.app.session.getSessionToken().then(function(t){return function(i){return ThisLife.Collection.momentTags.loaded&&!e?ThisLife.Collection.momentTags:ThisLife.Collection.momentTags.fetch({method:"getMomentTags",params:[i],success:function(e,i){return i.result.success?e.loaded=!0:t.error(i)}})}}(this))},e.prototype.getLocationTags=function(e){return ThisLife.app.session.getSessionToken().then(function(t){return function(i){return ThisLife.Collection.locationTags.loaded&&!e?ThisLife.Collection.locationTags:ThisLife.Collection.locationTags.fetch({method:"getLocationTags",params:[i],success:function(e,i){return i.result.success?e.loaded=!0:t.error(i)}})}}(this))},e.prototype.getMomentSet=function(e,t){return new Promise(function(i){return function(n,o){return ThisLife.app.session.getSessionToken().then(function(s){var r;return r=new APICollection,r.fetch({method:"getMomentSet",params:[s,e],success:function(e,n){return n.result.success?t?t(e,n):void 0:(i.error(n),o())}}),n(r)})}}(this))},e.prototype.getFullMomentSet=function(e,t,i,n){return ThisLife.app.session.getSessionToken().then(function(o){return function(s){return e.fetch({method:"getMomentSet",params:[s,[e.id],t,!0],success:function(e,t){return t.result.success?"function"==typeof i?i(e,t):void 0:("function"==typeof n&&n(),o.error(t))},error:n})}}(this))},e.prototype.getComments=function(e,t){return ThisLife.app.session.getSessionToken().then(function(i){return function(n){return(new APICollection).fetch({method:"getComments",params:[n,e],success:function(e,n){return n.result.success?t?t(e,n):void 0:i.error(n)}})}}(this))},e.prototype.getCommentsWithoutToken=function(e,t){return(new APICollection).fetch({method:"getCommentsWithoutToken",params:[e],success:function(e){return function(i,n){return n.result.success?t?t(i,n):void 0:e.error(n)}}(this)})},e.prototype.saveComment=function(e,t){return ThisLife.app.session.getSessionToken().then(function(i){return function(n){return(new APIModel).fetch({method:"saveComment",params:[n,e.moment_uid,e.comment,e.comment_uid],success:function(e,n){return n.result.success?t?t():void 0:i.error(n)}})}}(this))},e.prototype.deleteHeart=function(e,t){return ThisLife.app.session.getSessionToken().then(function(i){return function(n){return(new APIModel).fetch({method:"deleteHeart",params:[n,e],success:function(e,n){return n.result.success?t?t():void 0:i.error(n)}})}}(this))},e.prototype.mergePersonTags=function(e,t,i){return ThisLife.app.session.getSessionToken().then(function(n){return function(o){return(new APIModel).fetch({method:"mergePersonTags",params:[o,e,t],success:function(e,t){return t.result.success?"function"==typeof i?i(e,t):void 0:n.error(t)}})}}(this))},e.prototype.saveMomentTag=function(e,t,i,n){return ThisLife.app.session.getSessionToken().then(function(o){return function(s){return delete e.moment_taggings,(new APIShortModel).fetch({method:"saveMomentTag",params:[s,e,t],success:function(e,t){var s,r;return t.result.success?"function"==typeof i?i():void 0:("function"==typeof n&&n((null!=(s=t.result)?s.message:void 0)||(null!=(r=t.error)?r.message:void 0)),o.error(t))},error:n})}}(this))},e.prototype.deleteMomentTags=function(e){return ThisLife.app.session.getSessionToken().then(function(t){return function(i){return _.isObject(e)&&(e=[e.id]),(new APIShortModel).fetch({method:"deleteMomentTags",params:[i,e],success:function(e,i){return i.result.success?void 0:t.error(i)}})}}(this))},e.prototype.deleteMomentTaggings=function(e){return ThisLife.app.session.getSessionToken().then(function(t){return function(i){return(new APIShortModel).fetch({method:"deleteMomentTaggings",params:[i,e],success:function(e,i){return i.result.success?void 0:t.error(i)}})}}(this))},e.prototype.savePersonTagBeta=function(e,t,i,n){return null==t&&(t=null),ThisLife.app.session.getSessionToken().then(function(o){return function(s){return(new ThisLife.Model.PersonTag).fetch({method:"savePersonTag",params:[s,e,t],success:function(e,t){return t.result.success?(ThisLife.Collection.personTags.updateOrAdd(e.toJSON()),"function"==typeof i?i(e,t):void 0):("function"==typeof n&&n(e,t),o.error(t))},error:function(){return"function"==typeof n?n():void 0}})}}(this))},e.prototype.saveFaces=function(e,t){return ThisLife.app.session.getSessionToken().then(function(i){return function(n){return(new APICollection).fetch({method:"saveFaces",params:[n,e],success:function(e,n){return n.result.success?"function"==typeof t?t(e):void 0:i.error(n)}})}}(this))},e.prototype.deleteFaces=function(e,t){return ThisLife.app.session.getSessionToken().then(function(i){return function(n){return(new APIModel).fetch({method:"deleteFaces",params:[n,e],success:function(e,n){return n.result.success?"function"==typeof t?t(e,n):void 0:i.error(n)}})}}(this))},e.prototype.updatePersonTagFaces=function(e,t,i,n,o){return null==t&&(t=[]),null==i&&(i=[]),null==n&&(n=[]),ThisLife.app.session.getSessionToken().then(function(s){return function(r){return(new APIModel).fetch({method:"updatePersonTagFaces",params:[r,e,t,i,n],success:function(e,t){return t.result.success?"function"==typeof o?o(e,t):void 0:s.error(t)},error:function(){}})}}(this))},e.prototype.savePersonTag=function(e,t,i){throw null==t&&(t=!1),"This method is depricated"},e.prototype.quickSavePersonTag=function(e,t){return ThisLife.app.session.getSessionToken().then(function(i){return function(n){return(new APIShortModel).fetch({method:"savePersonTag",params:[n,e],success:function(n,o){return o.result.success?t?t(e):void 0:i.error(o)}})}}(this))},e.prototype.savePersonTagging=function(e){return ThisLife.app.session.getSessionToken().then(function(t){return function(i){return(new APIShortModel).fetch({method:"savePersonTagging",params:[i,e],success:function(e,i){return i.result.success?void 0:t.error(i)}})}}(this))},e.prototype.savePersonTaggingWithTag=function(e,t,i){return null==i&&(i=!1),ThisLife.app.session.getSessionToken().then(function(n){return function(o){return(new APIShortModel).fetch({method:"savePersonTaggingWithTag",params:[o,e,t,i],success:function(e,t){return t.result.success?void 0:n.error(t)}})}}(this))},e.prototype.deletePersonTag=function(e){return ThisLife.app.session.getSessionToken().then(function(t){return function(i){var n;return n=e.id||e,(new APIShortModel).fetch({method:"deletePersonTags",params:[i,n],success:function(e,i){return i.result.success?void 0:t.error(i)}})}}(this))},e.prototype.deletePersonTagging=function(e){return ThisLife.app.session.getSessionToken().then(function(t){return function(i){return(new APIShortModel).fetch({method:"deletePersonTagging",params:[i,e],success:function(e,i){return i.result.success?void 0:t.error(i)}})}}(this))},e.prototype.filterMomentsResults=function(e,t){return ThisLife.app.session.getSessionToken().then(function(i){return function(n){return(new APIModel).fetch({method:"filterMoments",params:[n,ThisLife.lifeUid,e.personTagUids,e.locationTagUids,e.month,e.year,e.activityTag],success:function(e,n){return n.result.success?t(e,n):i.error(n)}})}}(this))},e.prototype.filterMomentsNow=function(e,t){return ThisLife.app.session.getSessionToken().then(function(i){return function(n){return(new ThisLife.Model.FilterMoments).fetch({method:"filterMoments",params:[n,ThisLife.lifeUid],success:function(n,o){return o.result.success?null!=e?e.apply(t,arguments):void 0:i.error(o)}})}}(this))},e.prototype.sendText=function(e,t,i){var n;return e=e.replace(/[^\d.+]/g,""),n={pid:"Web",af_channel:"Web",c:"SFLY_twilio_photosupload",is_retargeting:"true"},(new APIModel).fetch({method:"message.sendMobileInstallLink",params:[e,n],success:function(e,n){return n.result.success?"function"==typeof t?t(e,n):void 0:"function"==typeof i?i(e,n):void 0},error:function(){return"function"==typeof i?i():void 0}})},e.prototype.createNote=function(e,t){return ThisLife.app.session.getSessionToken().then(function(i){return function(n){return(new APIModel).fetch({method:"createNote",params:[n,e],success:function(e,n){return n.result.success?(ThisLife.Model.masterStory.updateStory(ThisLife.currentStory.id),"function"==typeof t?t(e,n):void 0):i.error(n)}})}}(this))},e.prototype.updateNote=function(e,t){return ThisLife.app.session.getSessionToken().then(function(i){return function(n){return(new APIModel).fetch({method:"updateNote",params:[n,e],success:function(e,n){return n.result.success?(ThisLife.Model.masterStory.updateStory(ThisLife.currentStory.id),"function"==typeof t?t(e,n):void 0):i.error(n)}})}}(this))},e.prototype.deleteNotes=function(e,t){return ThisLife.app.session.getSessionToken().then(function(i){return function(n){return e=_.isArray(e)?e:[e],(new APIModel).fetch({method:"deleteNotes",params:[n,e],success:function(e,n){return n.result.success?(ThisLife.Model.masterStory.updateStory(ThisLife.currentStory.id),"function"==typeof t?t(e,n):void 0):i.error(n)}})}}(this))},e.prototype.saveVideo=function(e,t,i,n,o){return ThisLife.app.session.getSessionToken().then(function(s){return function(r){return e.life_uid=ThisLife.lifeUid,(new APIShortModel).fetch({method:"saveVideo",params:[r,e,t],headers:o,success:function(e,t,o){return t.result.success?"function"==typeof i?i(t,o):void 0:("function"==typeof s.error&&s.error(t),"function"==typeof n?n(t,o):void 0)},error:function(e,t,i){return"function"==typeof this.error&&this.error(t),"function"==typeof n?n(t,i):void 0}})}}(this))},e.prototype.restoreAllMoments=function(){return ThisLife.app.session.getSessionToken().then(function(e){return function(t){return(new APIShortModel).fetch({method:"moment.restoreAllMoments",params:[t],success:function(t,i){return i.result.success?void 0:e.error(i)}})}}(this))},e.prototype.saveMomentsProperty=function(e,t,i){return new Promise(function(n){return function(o,s){return ThisLife.app.session.getSessionToken().then(function(r){return"timeline"===t?i?(alert("DEPRICATED: use saveStoryMoments"),n.saveStoryMoments(ThisLife.storyUid,e)):(alert("DEPRICATED: use deleteStoryMoments"),n.deleteStoryMoments(ThisLife.storyUid,e)):(new APIShortModel).fetch({method:"saveMomentsProperty",params:[r,e,t,i],success:function(r,l){return l.result.success?("activity_tag"===t&&i&&ThisLife.PubSub.trigger("activityTags:update",i,e),o(l)):(n.error(l),s())}})})}}(this))},e.prototype.saveLocationTagWithTaggings=function(e,t){return ThisLife.app.session.getSessionToken().then(function(){return function(i){var n;return n=e.toJSON(),(new APIModel).fetch({method:"saveLocationTagWithTaggings",params:[i,n,t],success:function(){}})}}(this))},e.prototype.saveLocationTaggingAndTag=function(e,t){return ThisLife.app.session.getSessionToken().then(function(i){return function(n){var o,s,r;return o=t.name,s=t.uid,e||(e=ThisLife.Collection.locationTags.find(function(e){return(e.get("name")||"").toLowerCase()===(o||"").toLowerCase()})),_.include(null!=(r=e.attributes)?r.moment_uids:void 0,s)?void 0:(e.updateMomentUids(s),t={moment_uid:s,location_tag_uid:e.get("uid"),user_approved:!0,uid:$.Guid.New().toLowerCase()},(new APIShortModel).fetch({method:"saveLocationTaggingAndTag",params:[n,t,e.toJSON()],success:function(e,t){return t.result.success?void 0:i.error(t)}}))}}(this))},e.prototype.saveLocationTag=function(e,t,i,n){return ThisLife.app.session.getSessionToken().then(function(o){return function(s){var r;return n||(n=$.Guid.New().toLowerCase()),r={name:e,uid:n},i&&(r.lat=i),t&&(r["long"]=t),ThisLife.Collection.locationTags.get(n)||ThisLife.Collection.locationTags.add(r),(new APIShortModel).fetch({method:"saveLocationTag",params:[s,r],success:function(e,t){return t.result.success?void 0:o.error(t)}})}}(this))},e.prototype.deleteMoments=function(e){return ThisLife.app.session.getSessionToken().then(function(t){return function(i){return(new APIShortModel).fetch({method:"deleteMoments",params:[i,e],success:function(e,i){return i.result.success?void 0:t.error(i)}})}}(this))},e.prototype.defrostMoments=function(e){return ThisLife.app.session.getSessionToken().then(function(t){return function(i){return(new APIShortModel).fetch({method:"defrostMoments",params:[i,e],success:function(e,i){return i.result.success?void 0:t.error(i)}})}}(this))},e.prototype.dataWarehouseLog=function(e){return ThisLife.app.session.getSessionToken().then(function(t){return function(i){return(new APIShortModel).fetch({method:"dataWarehouse.log",params:[i,e],success:function(e,i){return i.result.success?void 0:t.error(i)}})}}(this))},e.prototype.getSuggestedFaceGroupCount=function(e){return ThisLife.app.session.getSessionToken().then(function(t){return function(i){return ThisLife.Model.suggestedGroupCount.fetch({method:"getSuggestedFaceGroupCount",params:[i,!0],success:function(i,n){return n.result.success?"function"==typeof e?e(i,n):void 0:t.error(n)}})}}(this))},e.prototype.getSuggestedPossibleMatches=function(e){return ThisLife.app.session.getSessionToken().then(function(){return function(t){return(new APIModel).fetch({method:"getSuggestedPossibleMatches",params:[t,e]})}}(this))},e.prototype.getSuggestedFaceGroup=function(e,t){return ThisLife.app.session.getSessionToken().then(function(i){return function(n){return(new ThisLife.Model.SuggestedPersonModel).fetch({method:"getSuggestedFaceGroup",params:[n,e],success:function(e,n){var o;return(null!=(o=n.result)?o.success:void 0)?"function"==typeof t?t(e,n):void 0:i.error(n)},error:function(){}})}}(this))},e.prototype.getSuggestedFaceGroupChunk=function(e,t,i){return ThisLife.app.session.getSessionToken().then(function(n){return function(o){return(new APIModel).fetch({method:"getBatchOfSuggestedFaceGroups",params:[o,t,e],success:function(e,t){var o,s;return s=_.map(e.get("suggestions"),function(e){var t;return t=new ThisLife.Model.SuggestedPersonModel,t.parseFromModel(e)}),(null!=(o=t.result)?o.success:void 0)?"function"==typeof i?i(s,t):void 0:n.error(t)},error:function(){}})}}(this))},e.prototype.getSpecificSuggestedFaceGroup=function(e,t,i){return ThisLife.app.session.getSessionToken().then(function(n){return function(o){return(new ThisLife.Model.SuggestedPersonModel).fetch({method:"getSpecificSuggestedFaceGroup",params:[o,t,e],success:function(e,t){var o;return(null!=(o=t.result)?o.success:void 0)?"function"==typeof i?i(e,t):void 0:n.error(t)},error:function(){}})}}(this))},e.prototype.updateSuggestedFaceGroup=function(e,t,i){return ThisLife.app.session.getSessionToken().then(function(n){return function(o){return(new APIModel).fetch({method:"updateSuggestedFaceGroup",params:[o,e,t,i],success:function(e,t){return t.result.success?void 0:n.error(t)}})}}(this))},e.prototype.deleteLocationTagging=function(e){return ThisLife.app.session.getSessionToken().then(function(t){return function(i){return(new APIShortModel).fetch({method:"deleteLocationTagging",params:[i,e],success:function(e,i){return i.result.success?void 0:t.error(i)}})}}(this))},e.prototype.deleteLocationTag=function(e){return ThisLife.app.session.getSessionToken().then(function(t){return function(i){var n,o;return n=(null!=(o=e.attributes)?o.uid:void 0)||e,(new APIShortModel).fetch({method:"deleteLocationTag",params:[i,n],success:function(e,i){var o;return i.result.success?null!=(o=ThisLife.Collection.locationTags)?o.remove(n):void 0:t.error(i)}})}}(this))},e.prototype.getContacts=function(){return ThisLife.app.session.getSessionToken().then(function(e){return function(t){var i;return i=APICollection.extend({parse:function(e){return _.flatten(e.result.payload)}}),(new i).fetch({method:"getContacts",params:[t,ThisLife.lifeUid],success:function(t,i){return i.result.success?void 0:e.error(i)}})}}(this))},e.prototype.getPersonTags=function(e,t,i){return null==t&&(t="face"),ThisLife.app.session.getSessionToken().then(function(n){return function(o){var s;return s=e?new APICollection:ThisLife.Collection.personTags,s.fetch({method:"personTag.getPersonTags",params:[o,e,t,1],success:function(t,o){var s;return e||(t.loaded=!0),(null!=(s=o.result)?s.success:void 0)?"function"==typeof i?i(t):void 0:n.error(o)}})}}(this))},e.prototype.getTags=function(){return ThisLife.app.session.getSessionToken().then(function(){return function(e){return(new APIModel).fetch({method:"getTags",params:[e],success:function(){}})}}(this))},e.prototype.getPersonTagsWithTaggings=function(e,t){return ThisLife.app.session.getSessionToken().then(function(i){return function(n){var o,s,r,l;return l=ThisLife.Collection.getPersonTagsWithTaggings,o=e?!0:!1,r={method:"getPersonTagsWithTaggings",params:[n,e||[],s=!0],add:o,success:function(e,n){var o;return e.loaded=!0,(null!=(o=n.result)?o.success:0)?t?t():void 0:i.error(n)}},l.fetch(r)}}(this))},e.prototype.getFacebookPermissions=function(e){return(new ThisLife.Model.FacebookPermissions).fetch({dataType:"jsonp",success:function(t,i){return e?e(t,i):void 0},error:function(){}})},e.prototype.combineContacts=function(){var e;return(e=ThisLife.Collection.contacts)?e:(e=ThisLife.Collection.contacts=new ThisLife.Collection.ContactsCollection,e.setupWithCollection(ThisLife.Collection.personTags),e)},e.prototype.getContactsWithoutFacebook=function(){var e;return e=new ThisLife.Collection.ContactsCollection,e.addEmails(),e.setupWithCollection(ThisLife.Collection.personTags),e},e.prototype.group=function(){return ThisLife.app.session.getSessionToken().then(function(e){return function(t){return(new APIShortModel).fetch({method:"group",params:[t,ThisLife.lifeUid],success:function(t,i){return i.result.success?void 0:e.error(i)}})}}(this))},e.prototype.deletePersonTags=function(e,t){return ThisLife.app.session.getSessionToken().then(function(i){return function(n){var o;return o=new APIShortModel,o.fetch({method:"deletePersonTags",params:[n,e],success:function(e,n){return n.result.success?"function"==typeof t?t(e,n):void 0:i.error(n)}})}}(this))},e.prototype.updateSession=function(e){return ThisLife.app.session.getSessionToken().then(function(){return function(t){return(new APIShortModel).fetch({method:"updateSession",params:[t,e],success:function(){return delete localStorage.ActivityTags,location.href=""+ThisLife.Settings.app}})}}(this))},e.prototype.shareStory=function(e){return ThisLife.app.session.getSessionToken().then(function(t){return function(i){return e.uid||(e.uid=e.story_permission_uid),(new APIModel).fetch({method:"saveStoryPermission",params:[i,e],success:function(e,i){return i.result.success?void 0:t.error(i)}})}}(this))},e.prototype.saveStory=function(e,t,i){return ThisLife.app.session.getSessionToken().then(function(n){return function(o){return(new APIModel).fetch({method:"saveStory",params:[o,e,t],success:function(e,t){return t.result.success?"function"==typeof i?i(t.result):void 0:n.error(t)}})}}(this))},e.prototype.lockAlbum=function(e,t,i){return ThisLife.app.session.getSessionToken().then(function(n){return function(o){var s;return s=t?"1":"0",(new APIModel).fetch({method:"album.lockAlbum",params:[o,e,s],success:function(e,t){return t.result.success?"function"==typeof i?i(t.result):void 0:n.error(t)}})}}(this))},e.prototype.saveStoryMoments=function(e,t,i){return ThisLife.app.session.getSessionToken().then(function(){return function(n){return(new APIModel).fetch({method:"saveStoryMoments",params:[n,e,t],success:function(e,t){return i?i(e,t):void 0}})}}(this))},e.prototype.deleteStoryMoments=function(e,t,i){return ThisLife.app.session.getSessionToken().then(function(){return function(n){return(new APIModel).fetch({method:"deleteStoryMoments",params:[n,e,t],success:function(e,t){return i?i(e,t):void 0}})}}(this))},e.prototype.copySharedMoments=function(e,t,i,n,o){return ThisLife.app.session.getSessionToken().then(function(){return function(s){return(new APIModel).fetch({method:"copySharedMoments",params:[s,e,i,t],success:function(e,t){return t.result.success?"function"==typeof n?n(e,t):void 0:"function"==typeof o?o(e,t):void 0},error:function(e,t){return"function"==typeof o?o(e,t):void 0}})}}(this))},e.prototype.getStories=function(){return ThisLife.Model.masterStory.fetchStories()},e.prototype.deleteStory=function(e){return ThisLife.app.session.getSessionToken().then(function(){return function(t){return(new APIModel).fetch({method:"deleteStory",params:[t,e],success:function(){}})}}(this))},e.prototype.deleteHiddenMoments=function(){return ThisLife.app.session.getSessionToken().then(function(){return function(e){return(new APIShortModel).fetch({method:"moment.deleteHidden",params:[e],success:function(e,t){return t.result.success?void 0:this.error(t)}})}}(this))},e.prototype.downloadMomentUrl=function(e,t,i){var n;return n={source:this.onGetSubSource()},t&&(n.storyUid=t),ThisLife.emailToken&&(n.storyEmailToken=ThisLife.emailToken),ThisLife.Helper.URL.getDownloadUrl(e,i,n)},e.prototype.momentDownloadMultiple=function(e,t,i,n){return ThisLife.app.session.getSessionToken().then(function(o){return function(s){return(new APIModel).fetch({method:"moment.downloadMultiple",params:[s,e,t],success:function(e,t){return t.result.success?"function"==typeof i?i(t.result):void 0:("function"==typeof n&&n(t.result),o.error(t))}})}}(this))},e.prototype.getUploadUrl=function(e,t,i){var n;return n={headers:["Keep-Alive: 115","Connection: keep-alive"],channel:"THISLIFE",files:e},ThisLife.app.session.getSessionToken().then(function(e){return function(o){return(new APIModel).fetch({method:"upload.sessions",params:[o,n,"web"],success:function(i,n,o){return i.get("links")?t?t(i.get("links"),o):void 0:"function"==typeof e.error?e.error(n):void 0},error:function(t,n,o){return"function"==typeof e.error&&e.error(n),"function"==typeof i?i(n,o):void 0}})}}(this))},e.prototype.getRelationships=function(e){return ThisLife.app.session.getSessionToken().then(function(t){return function(i){return(new APIModel).fetch({method:"personTagRelationship.getPersonTagRelationshipTypes",params:[i,null],success:function(i,n){return n.result.success>0?e?e(n.result.payload):void 0:t.error(n)}})}}(this))},e.prototype.saveRelationship=function(e,t){return ThisLife.app.session.getSessionToken().then(function(i){return function(n){return(new APIModel).fetch({method:"personTagRelationship.savePersonTagRelationship",params:[n,{person_tag_uid:e.person_tag_uid,relationship_type_uid:e.relationship_type_uid}],success:function(e,n){return n.result.success>0?(ThisLife.Collection.personTags.updateRelationship(e.toJSON()),t?t(n.result.payload):void 0):i.error(n)}})}}(this))},e.prototype.saveLogging=function(e){return ThisLife.app.session.getSessionToken().then(function(t){return function(i){return(new APIShortModel).fetch({method:"dataWarehouse.log",params:[i,e],success:function(e,i){return i.result.success?void 0:t.error(i)}})}}(this))},e.prototype.getSubscriptions=function(e){return ThisLife.app.session.getSessionToken().then(function(t){return function(i){return(new APICollection).fetch({method:"email.getSubscriptions",params:[i],success:function(i,n){return n.result.success?(e&&e(i,n),ThisLife.Model.User.set("email_prefs",i)):t.error(n)}})}}(this))},e.prototype.optIn=function(e,t){return ThisLife.app.session.getSessionToken().then(function(i){return function(n){return(new APICollection).fetch({method:"email.optIn",params:[n,e],success:function(e,n){return t&&t(n),n.result.success?void 0:i.error(n)}})}}(this))},e.prototype.optOut=function(e,t){return(new APICollection).fetch({method:"email.optOut",params:[e],success:function(e){return function(i,n){return t&&t(n),n.result.success?void 0:e.error(n)}}(this)})},e.prototype.getCropping=function(e,t,i){return ThisLife.app.session.getSessionToken().then(function(){return function(n){return(new APIModel).fetch({method:"moment.getMomentCropping",params:[n,e],success:function(e,n){return n.result.success?"function"==typeof t?t(n.result.payload):void 0:"function"==typeof i?i(n):void 0},error:function(){return"function"==typeof i?i():void 0}})}}(this))},e.prototype.setCropping=function(e,t,i,n){return ThisLife.app.session.getSessionToken().then(function(){return function(o){return(new APIModel).fetch({method:"moment.setMomentCropping",params:[o,e,t],success:function(e,t){return t.result.success?"function"==typeof i?i(t):void 0:"function"==typeof n?n(t):void 0},error:function(){return"function"==typeof n?n():void 0}})}}(this))},e.prototype.getMomentEffects=function(e,t,i){return ThisLife.app.session.getSessionToken().then(function(){return function(n){return(new APIModel).fetch({method:"moment.getMomentEffects",params:[n,e],success:function(e,n){return n.result.success?"function"==typeof t?t(n.result.payload):void 0:"function"==typeof i?i(n):void 0},error:function(e,t){return"function"==typeof i?i(t):void 0}})}}(this))},e.prototype.setMomentEffects=function(e,t,i,n,o){return ThisLife.app.session.getSessionToken().then(function(){return function(s){return(new APIModel).fetch({method:"moment.setMomentEffects",params:[s,e,t,i],success:function(e,t){return t.result.success?"function"==typeof n?n(t):void 0:"function"==typeof o?o(t):void 0},error:function(e,t){return"function"==typeof o?o(t):void 0}})}}(this))},e.prototype.getMomentRedEyeEffects=function(e,t,i){return ThisLife.app.session.getSessionToken().then(function(){return function(n){return(new APIModel).fetch({method:"moment.getMomentRedEyeEffects",params:[n,e],success:function(e,n){return n.result.success?"function"==typeof t?t(n.result.payload):void 0:"function"==typeof i?i(n):void 0},error:function(){return"function"==typeof i?i():void 0}})}}(this))},e.prototype.setMomentRedEyeEffects=function(e,t,i,n){return ThisLife.app.session.getSessionToken().then(function(){return function(o){return(new APIModel).fetch({method:"moment.setMomentRedEyeEffects",params:[o,e,t],success:function(e,t){return t.result.success?"function"==typeof i?i(t):void 0:"function"==typeof n?n(t):void 0},error:function(){return"function"==typeof n?n():void 0}})}}(this))},e.prototype.getFolders=function(e,t){return ThisLife.app.session.getSessionToken().then(function(){return function(i){return(new APIModel).fetch({method:"folder.getFolders",params:[i,ThisLife.lifeUid],success:function(i,n){return n.result.success?"function"==typeof e?e(n.result.payload):void 0:"function"==typeof t?t(n):void 0},error:function(e,i){return"function"==typeof t?t(i):void 0}})}}(this))},e.prototype.saveFolder=function(e,t,i){return ThisLife.app.session.getSessionToken().then(function(){return function(n){return e.lifeUid||(e.lifeUid=ThisLife.lifeUid),(new APIModel).fetch({method:"folder.saveFolder",params:[n,e],success:function(e,n){return n.result.success?"function"==typeof t?t(n.result.payload):void 0:"function"==typeof i?i(n):void 0},error:function(e,t){return"function"==typeof i?i(t):void 0}})}}(this))},e.prototype.deleteFolder=function(e,t,i){return ThisLife.app.session.getSessionToken().then(function(){return function(n){return(new APIModel).fetch({method:"folder.deleteFolder",params:[n,e],success:function(e,n){return n.result.success?"function"==typeof t?t(n):void 0:"function"==typeof i?i(n):void 0},error:function(e,t){return"function"==typeof i?i(t):void 0}})}}(this))},e.prototype.getAlbums=function(e,t){return ThisLife.app.session.getSessionToken().then(function(){return function(i){return(new APIModel).fetch({method:"album.getAlbums",params:[i,ThisLife.lifeUid],success:function(i,n){return n.result.success?"function"==typeof e?e(n.result.payload):void 0:"function"==typeof t?t(n):void 0},error:function(e,i){return"function"==typeof t?t(i):void 0}})}}(this))},e.prototype.getAlbumInviteLink=function(e,t,i){return ThisLife.app.session.getSessionToken().then(function(){return function(n){return(new APIModel).fetch({method:"album.getAlbumInviteLink",params:[n,{albumID:e},t],success:function(t,n){return i?i(e,n):void 0}})}}(this))},e.prototype.getAlbum=function(e,t,i,n,o){var s,r;return s=!1,r=!0,(new APIModel).fetch({method:"album.getAlbum",params:[i,e,"startupItem",t,s,r],success:function(e,t){return t.result.success?(e.loaded=!0,n(e)):o()
},error:o})},e.prototype.unshareAlbum=function(e,t){return ThisLife.app.session.getSessionToken().then(function(i){return(new APIModel).fetch({method:"album.unshareAlbum",params:[i,e],success:function(){return t?t(e):void 0}})})},e.prototype.deleteAlbumPermission=function(e,t,i){return(new APIModel).fetch({method:"album.deleteAlbumPermission",params:[ThisLife.sessionToken,e],success:function(e,i){return t?t(e,i):void 0},error:function(e,t){return i?i(e,t):void 0}})},e.prototype.saveAlbum=function(e,t,i,n){return ThisLife.app.session.getSessionToken().then(function(o){return(new APIModel).fetch({method:"album.saveAlbum",params:[o,e,t],success:function(e,t){return t.result.success?"function"==typeof i?i(t.result.payload):void 0:"function"==typeof n?n(t):void 0},error:function(e,t){return"function"==typeof n?n(t):void 0}})})},e.prototype.moveAlbum=function(e,t,i,n){return ThisLife.app.session.getSessionToken().then(function(o){return(new APIModel).fetch({method:"album.moveAlbumToFolder",params:[o,e,t],success:function(e,t){return t.result.success?"function"==typeof i?i(t.result.payload):void 0:"function"==typeof n?n(t):void 0},error:function(e,t){return"function"==typeof n?n(t):void 0}})})},e.prototype.copyAlbum=function(e,t,i,n){return ThisLife.app.session.getSessionToken().then(function(o){return(new APIModel).fetch({method:"album.copyAlbumToFolder",params:[o,e,t],success:function(e,t){return t.result.success?"function"==typeof i?i(t.result.payload):void 0:"function"==typeof n?n(t):void 0},error:function(e,t){return"function"==typeof n?n(t):void 0}})})},e.prototype.saveAlbumPermission=function(e,t,i){return ThisLife.app.session.getSessionToken().then(function(){return function(n){return(new APIModel).fetch({method:"album.saveAlbumPermission",params:[n,e],success:function(e,n){return n.result.success?"function"==typeof t?t(n):void 0:"function"==typeof i?i(n):void 0},error:function(e,t){return"function"==typeof i?i(t):void 0}})}}(this))},e.prototype.deleteAlbum=function(e,t,i){return ThisLife.app.session.getSessionToken().then(function(){return function(n){return(new APIModel).fetch({method:"deleteStory",params:[n,e],success:function(e,n){return n.result.success?"function"==typeof t?t(n):void 0:"function"==typeof i?i(n):void 0},error:function(e,t){return"function"==typeof i?i(t):void 0}})}}(this))},e.prototype.deleteAlbumPermission=function(e,t,i){return ThisLife.app.session.getSessionToken().then(function(){return function(n){return(new APIModel).fetch({method:"deleteStoryPermission",params:[n,e],success:function(e,n){return n.result.success?"function"==typeof t?t(n):void 0:"function"==typeof i?i(n):void 0},error:function(e,t){return"function"==typeof i?i(t):void 0}})}}(this))},e.prototype.deleteStoryPermission=function(e,t,i){return ThisLife.app.session.getSessionToken().then(function(){return function(n){return(new APIModel).fetch({method:"deleteStoryPermission",params:[n,e],success:function(e,n){return n.result.success?"function"==typeof t?t(n):void 0:"function"==typeof i?i(n):void 0}})}}(this))},e.prototype.multiFileDownload=function(e,t,i){return ThisLife.app.session.getSessionToken().then(function(){return function(n){return(new APIModel).fetch({method:"moment.getDownloadMultipleJobInfo",params:[n,e],success:function(e,n){return n.result.success?"function"==typeof t?t(n.result.payload):void 0:"function"==typeof i?i(n):void 0},error:function(e,t){return"function"==typeof i?i(t):void 0}})}}(this))},e.prototype.unfreezeMoments=function(e,t,i){return ThisLife.app.session.getSessionToken().then(function(){return function(n){return(new APIModel).fetch({method:"moment.unfreezeMoments",params:[n,[e]],success:function(e,n){return n.result.success?"function"==typeof t?t(n):void 0:"function"==typeof i?i(n):void 0},error:function(e,t){return"function"==typeof i?i(t):void 0}})}}(this))},e.prototype.getVideoMomentSet=function(e,t,i){return ThisLife.app.session.getSessionToken().then(function(){return function(n){return(new APIModel).fetch({method:"moment.getMomentSet",params:[n,[e]],success:function(e,n){return n.result.success?"function"==typeof t?t(n.result.payload):void 0:"function"==typeof i?i(n):void 0},error:function(e,t){return"function"==typeof i?i(t):void 0}})}}(this))},e.prototype.getPusherMessages=function(e,t,i,n){return ThisLife.app.session.getSessionToken().then(function(){return function(o){return(new APIModel).fetch({method:"pusher.message",params:[o,e,t,!0],success:function(e,t){return t.result.success?"function"==typeof i?i(t.result.payload):void 0:"function"==typeof n?n(t):void 0},error:function(e,t){return"function"==typeof n?n(t):void 0}})}}(this))},e.prototype.transformData=function(e){var t;return t=e.subSource||this.onGetSubSource(),JSON.stringify({method:e.method,params:e.params,headers:{"X-SFLY-SubSource":t},id:null})},e.prototype.moveAlbumMoments=function(e,t,i,n){return ThisLife.app.session.getSessionToken().then(function(){return function(o){return(new APIModel).fetch({method:"album.moveAlbumMoments",params:[o,e,t,i],success:function(e,t){return n?n(e,t):void 0}})}}(this))},e.prototype.getEventInfo=function(e,t,i,n){var o;return null==t&&(t="default"),o={eventName:e,argument:t},ThisLife.app.session.getSessionToken().then(function(){return function(e){return(new APIModel).fetch({method:"getEventInfo",params:[e,o],success:function(e,t){return t.result.success?i?i(e,t):void 0:"function"==typeof n?n():void 0}})}}(this))},e.prototype.getVividPix=function(e,t){return ThisLife.app.session.getSessionToken().then(function(){return function(i){return(new APIModel).fetch({method:"getVividPix",params:[i],success:function(i,n){return n.result.success?"function"==typeof e?e(n):void 0:"function"==typeof t?t(n):void 0},error:function(e,i){return"function"==typeof t?t(i):void 0}})}}(this))},e.prototype.setVividPix=function(e,t,i){return ThisLife.app.session.getSessionToken().then(function(){return function(n){return(new APIModel).fetch({method:"setVividPix",params:[n,e],success:function(e,n){return n.result.success?"function"==typeof t?t(n):void 0:"function"==typeof i?i(n):void 0},error:function(e,t){return"function"==typeof i?i(t):void 0}})}}(this))},e.prototype.getLifeFeatureFlows=function(e,t){return ThisLife.app.session.getSessionToken().then(function(){return function(i){return(new APIModel).fetch({method:"getLifeFeatureFlows",params:[i],success:function(i,n){return n.result.success?"function"==typeof e?e(n):void 0:"function"==typeof t?t(n):void 0},error:function(e,i){return"function"==typeof t?t(i):void 0}})}}(this))},e.prototype.setLifeFeatureFlow=function(e,t,i,n){return ThisLife.app.session.getSessionToken().then(function(){return function(o){return(new APIModel).fetch({method:"setLifeFeatureFlow",params:[o,e,t],success:function(e,t){return t.result.success?"function"==typeof i?i(t):void 0:"function"==typeof n?n(t):void 0},error:function(e,t){return"function"==typeof n?n(t):void 0}})}}(this))},e.prototype.setOnboarding=function(e,t,i){var n;return n=e?"1":"0",this.setLifeFeatureFlow("photos-onboarding",n,t,i)},e.prototype.setVerticalOnboarding=function(e,t,i){var n;return _.isObject(e)&&(n=JSON.stringify(e)),this.setLifeFeatureFlow("vertical",n,t,i)},e.prototype.setTrashConfirmation=function(e,t,i){var n,o;return n=ThisLife.appModel.getOnboardingFlows(),_.isObject(n)?(n.showTrashConfirmation=e?"1":"0",o=JSON.stringify(n),this.setLifeFeatureFlow("vertical",o,t,i)):void 0},e.prototype.error=function(e){var t,i,n,o;return t={},t.message=(null!=(i=e.result)?i.message:void 0)||(null!=(n=e.error)?n.message:void 0),t.errors=null!=(o=e.result)?o.errors:void 0,"Invalid token."===t.message?t.invalidToken=!0:"Life not found."===t.message?t.lifeNotFound=!0:/Access\sDenied/.test(t.message)?t.accessDenied=!0:/Limit\sreached/.test(t.message)&&(t.limitReached=!0,t.message="You\u2019ve reached the limit for email share. Please try again later."),this.trigger("error",t)},e}(),ThisLife.Service.core=e,ThisLife.Service.api=new e}.call(this),function(){ThisLife.Support.PubSub=function(){function e(){}return _.extend(e.prototype,Backbone.Events),e}()}.call(this),function(){var e=function(e,i){function n(){this.constructor=e}for(var o in i)t.call(i,o)&&(e[o]=i[o]);return n.prototype=i.prototype,e.prototype=new n,e.__super__=i.prototype,e},t={}.hasOwnProperty;ThisLife.AppPubSub=function(t){function i(){}return e(i,t),i}(ThisLife.Support.PubSub),ThisLife.PubSub=new ThisLife.AppPubSub,define("ThisLife.PubSub",[],function(){return ThisLife.PubSub})}.call(this),function(){define("ThisLife.AddressBook.Controllers.AddressBook",["ThisLife.AddressBook.Views.AddressBook"],function(e){var t;return t=function(){function t(){this.contactsList=[],this.groupsList=[],this.userHasGroups=!0,this.isAddressBookEmpty=!1,this._pSize=1e3,this._addrListUrl="https://"+ThisLife.Settings.api2Domain+"/v1/addressbook/"+ThisLife.Model.User.id+"/contacts/?pageSize="+this._pSize,this._addrGroupsUrl="https://"+ThisLife.Settings.api2Domain+"/v1/addressbook/"+ThisLife.Model.User.id+"/groups/complete/list",this._getContactsList(),this.appModalController=ThisLife.app.controller("appmodal").get("addressBook")}return _.extend(t.prototype,Backbone.Events),t.prototype.show=function(t){var i,n;return this.options=null!=t?t:{},null!=(n=this._view)&&n.remove(),this.options.cb=this.options.cb||function(){return ThisLife.log.error("Addrbook callback is not defined")},this.options.sendToList=this.options.sendToList||[],this._view=new e({controller:this,sendToList:this.options.sendToList,cb:this.options.cb}),i={width:"450",height:"416",fullPagePoint:"smallScreen",title:"Address Book",childView:this._view,disableClose:!0,buttons:[{type:"orange_button",onclick:this._sendRecipients.bind(this,!0),text:"ADD RECIPIENTS",subtext:0},{type:"back_button",onclick:this._sendRecipients.bind(this,!1),text:"BACK"}]},this.appModalController.renderView(i),this._view.render()},t.prototype._sendRecipients=function(e){var t,i;return i=[],e&&(i=function(){var e,i,n,o;for(n=this._view.sendToList,o=[],e=0,i=n.length;i>e;e++)t=n[e],t.selected===!0&&t.visible===!0&&t.disable===!1&&o.push({email:t.emailId,fName:t.fName,lName:t.lName});return o}.call(this)),this.options.cb(i),this.removeView()},t.prototype._getContactsList=function(){return this._fetchData()},t.prototype._getGroupsList=function(){return this._fetchData(!0)},t.prototype._fetchData=function(e){return ThisLife.app.session.getSessionToken().then(function(t){return function(i){var n;return n=e?t._addrGroupsUrl:t._addrListUrl,$.ajax({cache:!0,dataType:"json",url:n,beforeSend:function(e){e.setRequestHeader("SFLY-Apikey",ThisLife.Settings.apigeeApiKey),e.setRequestHeader("Authorization","Bearer "+i)},success:function(i){return t._parseData(i,e)},error:function(i){var n;return n="Error getting addrbook ",e?(t.userHasGroups=!1,n+="groups."):(t.options.cb(t.options.sendToList),t.removeView(),n+="contacts."),ThisLife.log.error(n,i.responseText)}})}}(this))},t.prototype.updateButtonSubText=function(e){return this.appModalController.updateButtonSubText("orange_button",e),e>0?this.appModalController.enableButton("orange_button"):this.appModalController.disableButton("orange_button")},t.prototype.removeView=function(){return this.appModalController.removeView()},t.prototype._parseData=function(e,t){var i;return t?(this.groupsList=e.items,_.isEmpty(this.groupsList)?(this.userHasGroups=!1,this._view.hideGroups()):void 0):(i=e.items,i=i.filter(function(e){return e.isSelf!==!0}),_.isEmpty(i)?(this.isAddressBookEmpty=!0,this.userHasGroups=!1):(this.contactsList=i,this._checkForGroups()))},t.prototype._checkForGroups=function(){var e,t,i,n,o;for(t=!1,o=this.contactsList,i=0,n=o.length;n>i;i++)if(e=o[i],e.groups.length>0){t=!0;break}return t?this._getGroupsList():this.userHasGroups=!1},t}()})}.call(this),function(){var e=[].indexOf||function(e){for(var t=0,i=this.length;i>t;t++)if(t in this&&this[t]===e)return t;return-1};define("ThisLife.AddressBook.Views.AddressBook",[],function(){var t;return t=Backbone.View.extend({className:"addressbook-view",events:{"click .groups_btn:not(.active)":"_showGroupsList","click .contacts_btn:not(.active)":"_showContactsList","click .contacts_list ul li:not(.disabled) input.c_list_checkbox":"_contactSelected","click .groups_list .group .group_header:not(.disabled) input.g_list_checkbox":"_groupSelected","click .groups_list .group .group_header:not(.disabled)":"_showHideGroup"},initialize:function(e){return this.options=null!=e?e:{},this.controller=this.options.controller,this.sendToList=[],this.createSendToList(this.options.sendToList),this.cb=this.options.cb,this.contactsIsRendered=!1,this.groupsIsRendered=!1,this.reRenderContacts=!1,this.reRenderGroups=!1,this},render:function(){return this.el.insertAdjacentHTML("afterbegin",this._template()),this._updateSendToCounter(),this._cacheElements(),this._showContactsList()},hideGroups:function(){return this.addressBookHeader.classList.add("collapse"),this.content.classList.add("no_header")},createSendToList:function(e){return this._addToList(!0,e)},_createEmailObj:function(e,t,i,n,o,s,r){return null==s&&(s=!0),null==r&&(r=!1),{emailId:e||"",selected:t,fName:i||"",lName:n||"",groups:o,visible:s,disable:r}},_showHideGroup:function(e){var t;return t=$(e.currentTarget).parent(),t.hasClass("visible")?(t.removeClass("visible"),t.next().removeClass("border-top")):(t.addClass("visible"),t.next().addClass("border-top"))},_updateSelected:function(e,t){var i;return i=this.sendToList.filter(function(t){return t.emailId===e}),_.isEmpty(i)||i[0].disable||(i[0].selected="undefined"==typeof t?!i[0].selected:t),this._updateSendToCounter()},_updateSendToCounter:function(){var e;return e=this.sendToList.filter(function(e){return e.selected&&e.visible&&!e.disable}),this.controller.updateButtonSubText(e.length.toString())},_checkIfExistsInList:function(e,t,i,n){var o;return o=this.sendToList.filter(function(t){return t.emailId===e}),_.isEmpty(o)?!1:(o[0].fName=t||"",o[0].lName=i||"",n&&!_.isEmpty(n)&&(o[0].groups=n),o[0].visible=!0,!0)},_addSendToList:function(e,t,i,n){return this._addToList(!1,e,t,i,n)},_addToList:function(e,t,i,n,o){var s,r,l;if(e)for(s=0,r=t.length;r>s;s++)l=t[s],this._validateEmail(l)&&this.sendToList.push(new this._createEmailObj(l,!0,"","",[],!1,!0));else this._checkIfExistsInList(t,i,n,o)||this.sendToList.push(new this._createEmailObj(t,!1,i,n,o));return!0},_contactSelected:function(e){return this.reRenderGroups=!0,this._updateSelected(e.currentTarget.id,void 0)},_groupSelected:function(e){var t,i,n,o,s,r,l;this.reRenderContacts=!0;try{for(i=$(e.currentTarget).closest(".group").find("ul li"),l=[],o=0,s=i.length;s>o;o++)r=i[o],t=$(r).attr("data"),l.push(_.isEmpty(t)?void 0:this._updateSelected(t,e.currentTarget.checked));return l}catch(a){n=a}},_cacheElements:function(){return this.addressBookHeader=this.el.querySelector(".header"),this.contactsButton=this.el.querySelector(".header .contacts_btn"),this.groupsButton=this.el.querySelector(".header .groups_btn"),this.content=this.el.querySelector(".content"),this.contactsList=this.el.querySelector(".content .contacts_list"),this.groupsList=this.el.querySelector(".content .groups_list")},_showContactsList:function(){return this.groupsButton.classList.remove("active"),this.contactsButton.classList.add("active"),this.contactsList.style.display="block",this.groupsList.style.display="none",this._renderContactsList()},_showGroupsList:function(){return this.contactsButton.classList.remove("active"),this.groupsButton.classList.add("active"),this.contactsList.style.display="none",this.groupsList.style.display="block",this._renderGroupsList()},_populateSendToListFromContactsList:function(){var e,t,i,n,o;for(o=this.controller.contactsList,t=0,i=o.length;i>t;t++)n=o[t],e=n.emails.filter(function(e){return e.isPrimary===!0}),"undefined"!=typeof e&&e.length>0&&this._addSendToList(e[0].emailAddress,n.firstName,n.lastName,n.groups);return this.sendToList=_.sortBy(this.sendToList,function(e){return e.fName+e.lName})},_canRenderContactsList:function(){if(this.contactsIsRendered&&!this.reRenderContacts)return!1;if(!this.contactsIsRendered){if(_.isEmpty(this.controller.contactsList))return this.controller.isAddressBookEmpty?(this.controller.appModalController.hideButton("orange_button"),this.contactsList.innerHTML=this._emptyTemplate(),this.content.classList.add("no_header")):_.delay(_.bind(this._renderContactsList,this),250),!1;this._populateSendToListFromContactsList()}return!0},_canRenderGroupsList:function(){if(!this.controller.userHasGroups)return!1;if(this.groupsIsRendered&&!this.reRenderGroups)return!1;if(!this.groupsIsRendered){if(_.isEmpty(this.controller.groupsList))return _.delay(_.bind(this._renderGroupsList,this),250),!1;this.controller.groupsList=_.sortBy(this.controller.groupsList,function(e){return e.name})}return!0},_renderContactsList:function(){var e,t,i,n,o,s;if(!this._canRenderContactsList())return!1;for(i="",o=this.sendToList,e=0,t=o.length;t>e;e++)n=o[e],n.visible&&(i+=this._listItem("",n.fName,n.lName,n.emailId,n.selected,n.disable));return s="<ul>"+i+"</ul>",this.contactsIsRendered?this.contactsList.innerHTML=null:(this.controller.userHasGroups||(this.addressBookHeader.classList.add("collapse"),this.content.classList.add("no_header")),this.addressBookHeader.classList.remove("hidden")),this.contactsList.innerHTML=s,this.contactsIsRendered=!0,this.reRenderContacts=!1,!0},_renderGroupsList:function(){var t,i,n,o,s,r,l,a,u,c,d,h,p,f,m;if(!this._canRenderGroupsList())return!1;for(n="",h=this.controller.groupsList,r=0,a=h.length;a>r;r++){for(o=h[r],c="",i=0,m=0,d=0,p=this.sendToList,l=0,u=p.length;u>l;l++)t=p[l],f=o.name,e.call(t.groups,f)>=0&&(i+=1,t.selected&&(m+=1),_.contains(this.options.sendToList,t.emailId)&&d++,c+=this._listItem(o.name,t.fName,t.lName,t.emailId));s=this._truncateString(o.name,40),n+='<div class="group" data="'+o.name+'">\n  <div class="group_header '+(i?"":"disabled")+" "+(d===i?"disableSelect":"")+'">\n    <div class="small-checkbox-wrap">\n      <input class="g_list_checkbox" id="'+o.name+'" type="checkbox" '+(i===m?"checked":"")+"  "+(d===i?"disabled":"")+'>\n      <label for="'+o.name+'"><span class=\'check-box\'><span></span></span></label>\n    </div>\n    <div class="group_name"> '+s+" ("+i+") </div>\n  </div>\n  <ul> "+c+" </ul>\n</div>"}return this.groupsIsRendered&&(this.groupsList.innerHTML=null),this.groupsList.innerHTML=n,this.groupsIsRendered=!0,this.reRenderGroups=!1,this._updateSendToCounter(),!0},_validateEmail:function(e){var t;return t=/^([a-zA-Z0-9_\.\-\+])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/,t.test(e)?!0:!1},_truncateString:function(e,t){return""!==$.trim(e)&&(e=e.length>t?e.substring(0,t-3)+"...":e),e},_listItem:function(e,t,i,n,o,s){var r,l,a,u,c;return null==s&&(s=!1),u=this._validateEmail(n),l=u&&!s?"":' class="disabled"',a=this._truncateString(t+" "+i,20),c=this._truncateString(n,25),r=e?"":'<div class="small-checkbox-wrap" '+(s?"style='visibility:visible'":"")+'>\n  <input class="c_list_checkbox" id="'+n+'" type="checkbox" '+(o?"checked":"")+" "+(s?"disabled":"")+'>\n  <label for="'+n+"\"><span class='check-box'><span></span></span></label>\n</div>",'<li data="'+n+'" '+l+">\n  "+r+'\n  <div class="dis_email_div">\n    <span>'+a+'</span>\n    <div class="emailId">'+c+"</div>\n  </div>\n</li>"},_emptyTemplate:function(){return'<div class="empty">\n  <span>You do not have any Address Book entries.</span>\n</div>'},_template:function(){return'<div class="header hidden">\n  <div class="primary_btn contacts_btn">\n    <div class="btn_text">\n      <div class="icon"></div>\n      <div class="label">Contacts</div>\n      <div class="underline"></div>\n    </div>\n  </div>\n\n  <div class="primary_btn groups_btn">\n    <div class="btn_text">\n      <div class="icon"></div>\n      <div class="label">Groups</div>\n      <div class="underline"></div>\n    </div>\n  </div>\n</div>\n<div class="content">\n  <div class="contacts_list">\n    <div class="loading"><div class="throbber throbber_large"><div class="throbber_overlay"></div></div></div>\n  </div>\n  <div class="groups_list">\n    <div class="loading"><div class="throbber throbber_large"><div class="throbber_overlay"></div></div></div>\n  </div>\n</div>'}})})}.call(this),function(){define("ThisLife.Auth.Controllers.Parent",["ThisLife.Auth.Controllers.Session","ThisLife.Auth.Controllers.Identity"],function(e,t){var i;return i=function(){function i(e){this.options=null!=e?e:{},this.useNewAuth=!1,this.session=null}return _.extend(i.prototype,Backbone.Events),i.prototype.getSession=function(i){var n;return null==i&&(i={}),n=new Promise(function(n){return window.evalUseNewAuth?window.evalUseNewAuth().then(function(o){return function(s){return o.useNewAuth=s,n(o.useNewAuth?new t(i):new e(i))}}(this))["catch"](function(){return function(t){return console.log("got an error calling evalUseNewAuth",t),n(new e(i))}}(this)):n(new e(i))})},i}()})}.call(this),function(){var e=[].slice;define("ThisLife.Auth.Controllers.Session",[],function(){var t,i,n,o,s;return t=1e3,o=6e5,i=15e5,n=1728e5,s=function(){function s(e){var t;this.options=null!=e?e:{},t=ThisLife.Settings,this._pollUrl=t.sflyApp+"/nonVisualSignin/start.sfly?version=2&outputFormat=postMessage&subdomain="+t.app.replace(".shutterfly.com",""),this._secCookieName="sflySec","prod"!==t.sflyEnv&&(this._secCookieName+="_"+ThisLife.Settings.sflyEnv),window.addEventListener("message",_.bind(this._handleLoginPostMessage,this),!1),this._pollNonVisualSignin(),this.finishedChecking=!1}return _.extend(s.prototype,Backbone.Events),s.prototype.gotoSignup=function(e){var t,i,n,o,s;return null==e&&(e=!1),this._clearIntervals(),s=ThisLife.Settings,t=e?"cid="+e+"&":"",n=ThisLife.app.router.fragment(),o=encodeURIComponent(s.www+"/"+n),i=new Date,i.setDate(i.getDate()+1),document.cookie="photos.superfly=true; path=/; domain="+this._cookieDomain+"; expires="+i.toUTCString(),window.location=s.sflyApp+"/forwardingSignup/start.sfly?"+t+"forwardToURL="+o},s.prototype.gotoLogin=function(e){var t,i,n,o;return null==e&&(e=""),o=ThisLife.Settings,i=ThisLife.app.router.fragment(),n=encodeURIComponent(o.www+"/"+i),e.length>0&&(t=i.indexOf("?")<0?"?":"&",n+=encodeURIComponent(t+"action="+e)),window.location=o.sflyApp+"/forwardingSignin/start.sfly?forwardToURL="+n},s.prototype.gotoLogout=function(e){return null==e&&(e=!1),this._clearIntervals(),ThisLife.LogSmithManager.flushMetrics(function(){return function(){var e;return e=ThisLife.Settings,window.location=e.sflyApp+"/signout/start.sfly"}}(this))},s.prototype.gotoForgotPassword=function(e){var t,i;return null==e&&(e=!1),this._clearIntervals(),t=e?"?email="+encodeURIComponent(e):"",i=ThisLife.Settings,window.location=i.sflyApp+"/secure/password_forgot.jsp"+t},s.prototype.gotoChangePassword=function(){var e,t,i;return this._clearIntervals(),i=ThisLife.Settings,e=ThisLife.app.router.fragment(),t=encodeURIComponent((i.www+"/"+e).replace(/^http(s)?:\/\//i,"")),window.location=i.sflyApp+"/secure/password_change.jsp?http="+t},s.prototype.isLoggedIn=function(){return!!this.loaded},s.prototype.getFailReason=function(){return this.failStatus},s.prototype.whenLoggedIn=function(){var t,i,n,o,s;return n=arguments[0],o=arguments[1],t=3<=arguments.length?e.call(arguments,2):[],null==o&&(o=this),i=_.bind(n,o),this.loaded?i.apply(null,t):(s=function(e){return function(){return i.apply(null,t),e.off("reset",s,e)}}(this),this.on("reset",s,this))},s.prototype.whenLoginFails=function(){var t,i,n,o,s;return n=arguments[0],o=arguments[1],t=3<=arguments.length?e.call(arguments,2):[],null==o&&(o=this),i=_.bind(n,o),this.failed?i.apply(null,t):(s=function(e){return function(){return i.apply(null,t),e.off("failed",s,e)}}(this),this.on("failed",s,this))},s.prototype.expiredSession=function(){return ThisLife.app.logout(!0)},s.prototype.forceSessionRefresh=function(){return ThisLife.log.debug("#### FORCING an immediate Session Poll @ "+new Date),this._pollNonVisualSignin()},s.prototype._getStartupInfo=function(){return this.options.getStartUpInfo?ThisLife.Service.api.getStartUpInfo(_.bind(this._handleLogin,this),_.bind(this._handleLoginFail,this)):this._handleLogin()},s.prototype._handleLogin=function(e){return this._bindEvents(),null==e||(ThisLife.app.controller("timing").startTimer("loadUser"),ThisLife.Model.User.load(e),ThisLife.app.controller("timing").endTimer("loadUser",{firstLoggedOut:ThisLife.firstLoggedOut}),this._validateOpenFlyToken(ThisLife.uploadToken))?(this.loaded=!0,this.trigger("reset")):void ThisLife.app.logout(!0)},s.prototype._handleLoginFail=function(e){var t,i;return this.options.allowNoSession?(this.failStatus="person not found"===e.errors?"NO_USER":"NO_SESSION",this.failed=!0,this.trigger("failed",status)):"person not found"===e.errors?this._gotoLightbox():(null!=(t=ThisLife.app)&&"function"==typeof t.controller&&null!=(i=t.controller("timing"))&&i.recordSessionEvents({event:"_getStartupInfo",err:"invalidToken",session_method:"_handleLoginFail"}),ThisLife.sessionToken=null,this._showLogin())},s.prototype._gotoLightbox=function(){return window.location=ThisLife.Settings.sflyApp+"/nav/mypics.sfly"},s.prototype._bindEvents=function(){return $(window).on("blur",function(e){return function(){return e._windowBlur()}}(this)),$(window).on("focus",function(e){return function(){return e._windowFocus()}}(this)),this._pollInterval=setInterval(_.bind(this._pollSession,this),t)},s.prototype._clearIntervals=function(){return clearInterval(this._pollInterval)},s.prototype._pollSession=function(){var e,t,n;return t="function"==typeof(e=ThisLife.app)._isUploading?e._isUploading():void 0,this._lockedByUpload&&!t&&(ThisLife.log.debug("#### Session Invalid - Upload Complete - Reloading window @ "+new Date),window.location.reload()),n=new Date,n-this._lastPoll<o?void 0:this._lockedByUpload?ThisLife.log.debug("#### Skipping Session Poll (Invalid but Uploading) @ "+n):null==this._lastBlur||new Date-this._lastBlur<i||t?(ThisLife.log.debug("#### Starting Session Poll @ "+n),this._pollNonVisualSignin()):(ThisLife.log.debug("#### Session Inactive - Go to Logout @ "+new Date),this.gotoLogout())},s.prototype._pollNonVisualSignin=function(){return null==this._nvp_frame&&(this._nvp_frame=$('<iframe id="nvp-frame" name="nvp-frame" style="position:absolute;top:0;left:0;width:1px;height:1px;z-index:0;"></iframe>'),this._nvp_frame.appendTo(document.body)),this._lastPoll=new Date,this._nvp_frame.attr("src",this._pollUrl+"&cb="+Math.random())},s.prototype._windowBlur=function(){return ThisLife.log.debug("#### Session Update - Window Inactive @ "+new Date),this._lastBlur=new Date},s.prototype._windowFocus=function(){return ThisLife.log.debug("#### Session Update - Window Active @ "+new Date),this._lastBlur=null},s.prototype._showLogin=function(){var e,t;return e=null,t=$.cookies.get(this._secCookieName),t&&(e=t.split(":")[1]),null==this.loginModal&&(this.loginModal=new ThisLife.Auth.Views.Login({email:e})),this.loginModal.show(),this.secondLogin&&this.loginModal.showLoginError(),this.secondLogin=!0},s.prototype._hideLogin=function(){var e;return null!=(e=this.loginModal)?e.remove():void 0},s.prototype._handleLoginPostMessage=function(e){var t,i;if(i=new RegExp("^"+ThisLife.Settings.sflyApp+"$"),i.test(e.origin)&&"message"===e.type){if(t=$.parseJSON(e.data),!t.hasOwnProperty("returnCode"))return;return null!=ThisLife.sessionToken?this._handlePollResponse(t):this._handleStartResponse(t)}},s.prototype._handlePollResponse=function(e){var t,i;return i=!0,1!==e.returnCode||ThisLife.sessionToken===e.oauthToken&&ThisLife.uploadToken===e.oflyToken?1!==e.returnCode&&(ThisLife.log.debug("####   oAuth token missing - Reloading page"),i=!1):e.uid===ThisLife.Model.User.id?(ThisLife.log.debug("####   oAuth token CHANGED - BUT SAME USER"),ThisLife.sessionToken=e.oauthToken,ThisLife.uploadToken=e.oflyToken):(ThisLife.log.debug("####   oAuth token CHANGED - Reloading page"),i=!1),i?void 0:("function"==typeof(t=ThisLife.app)._isUploading?t._isUploading():void 0)?(ThisLife.log.debug("####   Skipping reload - upload is active "),this._lockedByUpload=!0):window.location.reload()},s.prototype._handleStartResponse=function(e){return ThisLife.app.controller("timing").endTimer("pollNonVisualSignin",{},!0),1===e.returnCode?(ThisLife.app.controller("timing").endTimer("signin"),ThisLife.app.controller("timing").recordDeferredTime("pollNonVisualSignin",{signedIn:!0}),ThisLife.sessionToken=e.oauthToken,ThisLife.uploadToken=e.oflyToken,this._hideLogin(),this._getStartupInfo()):(ThisLife.app.controller("timing").deleteTimer("signin"),ThisLife.app.controller("timing").recordDeferredTime("pollNonVisualSignin",{signedIn:!1}),this.options.allowNoSession||(ThisLife.firstLoggedOut=!0,this._showLogin())),this.finishedChecking=!0,this.trigger("checked")},s.prototype._validateOpenFlyToken=function(e){var t;return e&&0!==e.length?(t=e.split("|"),t.length<3?(ThisLife.LogSmithManager.enqueueSessionMetrics({name:"openfly.malformated",value:1,timestamp:(new Date).getTime(),attributes:this.getSessionLoggingPayload()}),!1):new Date-new Date(t[1])>n?(ThisLife.LogSmithManager.enqueueSessionMetrics({name:"openfly.expired",value:1,timestamp:(new Date).getTime(),attributes:this.getSessionLoggingPayload()}),!1):!0):(ThisLife.LogSmithManager.enqueueSessionMetrics({name:"openfly.missing",value:1,timestamp:(new Date).getTime(),attributes:this.getSessionLoggingPayload()}),!1)},s.prototype.getSessionLoggingPayload=function(){return{persion_uid:ThisLife.Model.User.id,session_token:ThisLife.sessionToken,openfly:ThisLife.uploadToken}},s.prototype.sessionType=function(){return"legacy"},s.prototype.isChecking=function(){var t,i,n,o,s;return n=arguments[0],s=arguments[1],t=3<=arguments.length?e.call(arguments,2):[],null==n&&(n=null),null==s&&(s=this),i=_.bind(n,s),this.finishedChecking?i.apply(null,t):(o=function(e){return function(){return i.apply(null,t),e.off("checked",o,e)}}(this),this.on("checked",o,this))},s.prototype.getSessionToken=function(){return new Promise(function(e){return function(t,i){return ThisLife.sessionToken?t(ThisLife.sessionToken):(i("session.coffee: getSessionToken failed"),e.loaded=!1,e.options.allowNoSession?void 0:e._showLogin())}}(this))},s}()})}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}},t=function(e,t){function n(){this.constructor=e}for(var o in t)i.call(t,o)&&(e[o]=t[o]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e},i={}.hasOwnProperty;define("ThisLife.Auth.Controllers.Identity",["ThisLife.Auth.Controllers.Session"],function(i){var n;return n=function(i){function n(t){this.options=null!=t?t:{},this.gotoLogin=e(this.gotoLogin,this),this._checkLoggedIn(),this.finishedChecking=!1}return t(n,i),n.prototype._checkLoggedIn=function(){return this.finishedChecking=!1,window.$sflyAuth.getIdToken().then(function(e){return function(t){var i,n;null==t&&null!=(i=ThisLife.app)&&"function"==typeof i.controller&&null!=(n=i.controller("timing"))&&n.recordSessionEvents({event:"getIdToken",err:"no valid token",session_method:"_checkLoggedIn"}),ThisLife.sessionToken=t.jwtToken,e._getStartupInfo()}}(this))["catch"](function(e){return function(t){var i,n;return null!=(i=ThisLife.app)&&"function"==typeof i.controller&&null!=(n=i.controller("timing"))&&n.recordSessionEvents({event:"getIdToken",err:t,session_method:"_checkLoggedIn"}),e.finishedChecking=!0,e.trigger("checked"),e.options.allowNoSession?void 0:(ThisLife.firstLoggedOut=!0,e._showLogin())}}(this))},n.prototype._getStartupInfo=function(){return this.options.getStartUpInfo?ThisLife.Service.api.getStartUpInfo(_.bind(this._handleLogin,this),_.bind(this._handleLoginFail,this)):this._handleLogin()},n.prototype._handleLogin=function(e){return null!=e&&ThisLife.Model.User.load(e),this.loaded=!0,this.trigger("reset"),this.finishedChecking=!0,this.trigger("checked")},n.prototype._showLogin=function(e){return null==e&&(e="signin"),"signin"===e?window.$sflyAuth.showSignIn():window.$sflyAuth.showSignUp()},n.prototype.gotoLogin=function(e){return null==e&&(e=!1),e?n.__super__.gotoLogin.apply(this,arguments):this._showLogin()},n.prototype.gotoSignup=function(e,t){return null==e&&(e=!1),null==t&&(t=!1),t?void n.__super__.gotoSignup.call(this,e):this._showLogin("signup")},n.prototype.sessionType=function(){return"ip"},n.prototype.getSessionToken=function(){return new Promise(function(e){return function(t,i){return $sflyAuth.getIdToken().then(function(e){return t(e.jwtToken)})["catch"](function(t){return i(t),e.loaded=!1,e.options.allowNoSession?void 0:e._showLogin()})}}(this))},n.prototype.gotoLogout=function(){var e,t;return t=ThisLife.Settings,e=t.sflyApp+"/signout/start.sfly",ThisLife.app.isMobile&&(e+="?logout=true"),window.location.assign(e)},n.prototype.gotoChangePassword=function(){return window.$sflyAuth.changePassword()
},n}(i)})}.call(this),function(){var e,t,i;e=Backbone.View.extend({className:"popover_wrap new_popover_wrap expire_modal",events:{"click .orange-btn":"_clickSignin"},initialize:function(e){return this.options=e,this.render()},render:function(){return this.$el.html(i())},show:function(){return this.$el.appendTo(document.body)},_clickSignin:function(){var e;return"function"==typeof(e=this.options).callback?e.callback():void 0}}),i=function(){return'<div class=\'popover one_button_modal\'>\n  <h4>Oops, your session has expired</h4>\n  <div class="modal_information" style="padding-right: 50px;">\n    Please sign in to continue enjoying <br />your photos on Shutterfly.\n  </div>\n  <div class="action_btn_wrap clearfix">\n    <a class="orange-btn done-btn">Sign in</a>\n  </div>\n</div>'},ThisLife.Auth||(ThisLife.Auth={}),(t=ThisLife.Auth).Views||(t.Views={}),ThisLife.Auth.Views.Expire=e}.call(this),function(){var e,t,i,n;t=Backbone.View.extend({className:"modal_wrap login_modal",events:{"click .orange-btn":"_clickSubmit","click .sign-up-link":"_clickSignup","click .forgot-password":"_clickForgotPassword","keydown input":"_checkKeydown"},initialize:function(e){var t;return this.options=e,t=ThisLife.Settings,this.submitUrl=t.sflyApp+"/nonVisualSignin/start.sfly",this.subdomain=t.app.replace(".shutterfly.com",""),this.render(),ThisLife.app.controller("tracking").logSignInFormLoad()},render:function(){return this.$el.html(n(this.submitUrl,this.subdomain)),this.userInput=this.$el.find("input#login_username"),this.remember=this.$el.find("input#rememberUserName"),this.passInput=this.$el.find("input.password"),this.formEl=this.$el.find("form"),this.errorEl=this.$el.find(".modal_error")},show:function(){return this.$el.appendTo(document.body),null!=this.options.email&&""!==this.options.email?(this.userInput.val(this.options.email),this.remember.prop("checked",!0),this.passInput.focus()):this.userInput.focus(),ThisLife.app.controller("timing").recordLoadEvent("loadToLogin")},showLoginError:function(){return this.errorEl.show(),ThisLife.app.controller("tracking").logSignInFormError(e)},hideLoginError:function(){return this.errorEl.hide()},remove:function(){return ThisLife.Support.keyInformant.off("enter",this._clickSubmit,this),Backbone.View.prototype.remove.apply(this)},_clickSubmit:function(){return ThisLife.app.controller("timing").recordEvent("login"),ThisLife.app.controller("timing").startTimer("signin"),this.hideLoginError(),this.formEl.submit()},_clickSignup:function(){return this.hideLoginError(),ThisLife.app.session.gotoSignup()},_clickForgotPassword:function(){return this.hideLoginError(),ThisLife.app.session.gotoForgotPassword()},_checkKeydown:function(e){return ThisLife.Helper.Keyboard.isEnter(e.keyCode)?(this._clickSubmit(),!1):void 0}}),e="Something's not right. Please check your email or password, and try again.",n=function(t,i){return'<div class=\'modal_container\'>\n  <iframe id="nvl-frame" name="nvl-frame"></iframe>\n  <h4>Sign in to Shutterfly</h4>\n  <form method="POST" action="'+t+'" enctype="application/x-www-form-urlencoded" target="nvl-frame">\n    <input type="hidden" name="outputFormat" value="postMessage" />\n    <input type="hidden" name="subdomain" value="'+i+'" />\n    <div class="horz-rule"></div>\n    <div class="modal_error" style="display: none;">'+e+'</div>\n    <div class="modal_information">\n      <div class="input-label">Email</div>\n      <input type="email" id="login_username" name="userName" type="email" autocomplete="off" placeholder="Email" class="userName" />\n      <div>\n        <input id="rememberUserName" name="rememberUserName" type="checkbox" />\n        <label id="remember_email_text" for="rememberUserName">Remember my email address</label>\n      </div>\n      <div class="input-label">\n        Password\n        <a class="subtext forgot-password">Forgot Password?</a>\n      </div>\n      <input id="login_password" type="password" name="password" placeholder="Password" class="password"  />\n    </div>\n    <div class="action_btn_wrap clearfix">\n      <a class="orange-btn done-btn">Sign in</a>\n    </div>\n    <div class="horz-rule"></div>\n    <div class="modal_footer">\n      Don\'t have an account yet? <a class="sign-up-link">Sign up</a>\n    </div>\n  </form>\n</div>'},ThisLife.Auth||(ThisLife.Auth={}),(i=ThisLife.Auth).Views||(i.Views={}),ThisLife.Auth.Views.Login=t}.call(this),function(){var e,t;e=function(){function e(e){this.options=null!=e?e:{},_.bindAll(this,"showDownloadView","showErrorView")}return _.extend(e.prototype,Backbone.Events),e.prototype.show=function(e){var t;return null!=(t=this.view)&&t.remove(),ThisLife.Service.api.multiFileDownload(e,this.showDownloadView,this.showErrorView)},e.prototype.showDownloadView=function(e){return ThisLife.app.session.getSessionToken().then(function(t){return function(i){return null!=e.archives&&t.getArchiveMeta(e,i),null!=e.videos&&t.getVideoMeta(e,i),t.view=new ThisLife.Download.Views.Moment({controller:t,payload:e})}}(this))},e.prototype.showErrorView=function(){var e;return e=new ThisLife.View.Error({message:"The requested download is for another account. Please login with that account to access it."}),e.show()},e.prototype.getArchiveMeta=function(e){var t,i,n;return n=0,t=0,i=0,_.each(e.archives,function(o){var s,r,l,a;for(s=o.url.substr(o.url.lastIndexOf("/")+1),(l=s.indexOf("?"))&&(o.filename=s.substr(0,l)),o.size=o.metadata.size,a=[];t<e.images.length;){if(r=e.images[t],n+=parseInt(r.size),t++,n>i){o.cover_url=ThisLife.Helper.Image.imgUrl(r.uid,"x-small",null,r.owner_person_uid);break}a.push(void 0)}return a})},e.prototype.getVideoMeta=function(e){var t;return t={},null!=e.story_uid&&(t.story_uid=e.story_uid),_.each(e.videos,function(e){return e.cover_url=ThisLife.Helper.Image.imgUrl(e.uid,"x-small",null,e.owner_person_uid),e.url=ThisLife.Helper.URL.getDownloadUrl(e.uid,t)})},e.prototype.removeView=function(){return this.view=null},e}(),ThisLife.Download||(ThisLife.Download={}),(t=ThisLife.Download).Controllers||(t.Controllers={}),ThisLife.Download.Controllers.Moment=e}.call(this),function(){var e,t;e=function(){function e(e){this.options=null!=e?e:{},_.bindAll(this,"showVideoView","showErrorView")}return _.extend(e.prototype,Backbone.Events),e.prototype.show=function(e){var t;return null!=(t=this.view)&&t.remove(),ThisLife.Service.api.getVideoMomentSet(e.uid,this.showVideoView,this.showErrorView)},e.prototype.showVideoView=function(e){return ThisLife.app.session.getSessionToken().then(function(t){return function(i){return t.getVideoMeta(e[0],i),t.view=new ThisLife.Download.Views.Video({controller:t,payload:e[0]})}}(this))},e.prototype.showErrorView=function(){var e;return e=new ThisLife.View.Error({message:"The requested download is for another account. Please login with that account to access it."}),e.show()},e.prototype.getVideoMeta=function(e,t){var i;return i={},null!=e.story_uid&&(i.story_uid=e.story_uid),"available"===e.glacier_status&&(i.provideOriginal=!0),e.cover_url=ThisLife.Helper.Image.imgUrl(e.uid,"x-small",null,e.owner_person_uid),e.url=ThisLife.Helper.URL.getDownloadUrl(e.uid,t,i)},e.prototype.removeView=function(){return this.view=null},e}(),ThisLife.Download||(ThisLife.Download={}),(t=ThisLife.Download).Controllers||(t.Controllers={}),ThisLife.Download.Controllers.Video=e}.call(this),function(){var e,t,i;t=Backbone.View.extend({className:"popover_wrap new_popover_wrap download_modal",events:{"click .cancel_btn":"remove","click .close-btn":"remove"},initialize:function(e){return this.options=null!=e?e:{},this.subviews=[],this._render(),this._bindCallbacks()},_render:function(){return this.$el.html(this._template(this.options.payload.image_count,this.options.payload.video_count)),document.body.appendChild(this.el),this.$archiveList=this.$el.find(".popover_list_wrap.archives .list_container"),_.each(this.options.payload.archives,function(t){return function(i){var n;return n=new e(i),t.subviews.push(n),t.$archiveList.append(n.el)}}(this)),this.$videoList=this.$el.find(".popover_list_wrap.videos .list_container"),_.each(this.options.payload.videos,function(t){return function(i){var n;return n=new e(i),t.subviews.push(n),t.$videoList.append(n.el)}}(this))},_bindCallbacks:function(){return this.blurEventCallback=ThisLife.blurEvent(this.$el.find(".popover"),_.bind(this.remove,this)),ThisLife.Support.keyInformant.on("cancel",this.remove,this,!0)},_unbindCallbacks:function(){return ThisLife.removeBlurEvent(this.blurEventCallback),ThisLife.Support.keyInformant.off("cancel",this.remove,this)},remove:function(){return _.each(this.subviews,function(e){return e.remove()}),this._unbindCallbacks(),this.options.controller.removeView(),Backbone.View.prototype.remove.apply(this)},_template:function(e,t){var i,n;return i=null==e?"":'<div class="popover_list_wrap archives">\n<div class="list_header">Photos ('+e+')</div>\n    <div class="list_container"></div>\n</div>',n=t?'<div class="popover_list_wrap videos">\n  <div class="list_header">Videos ('+t+')</div>\n  <div class="list_container"></div>\n</div>':"",'<div class=\'popover one_button_modal\'>\n  <span class="close-btn"><img src="/assets/1px.gif"></span>\n  <div class="body">\n    <h4>Your downloads are ready!</h4>\n    <div class="popover_scroll_wrap">\n      '+i+"\n      "+n+"\n    </div>\n  </div>\n</div>"}}),ThisLife.Download||(ThisLife.Download={}),(i=ThisLife.Download).Views||(i.Views={}),ThisLife.Download.Views.Moment=t,e=Backbone.View.extend({className:"list_item",events:{"click .orange-btn":"downloadArchive","click .original":"requestOriginal"},initialize:function(e){return this.archive=e,this.render()},render:function(){return this.$el.html(this._template())},downloadArchive:function(){return ThisLife.Helper.URL.downloadViaIframe(this.archive.url)},requestOriginal:function(){return ThisLife.Service.api.unfreezeMoments(this.archive.uid),$(this.el.querySelector(".original")).addClass("selected"),$(this.el.querySelector(".original")).text("Original requested")},_template:function(){var e;return e="video"===this.archive.type&&this.archive.owner_person_uid===ThisLife.currentLifeOwner?"Request original":"",'<div class="archive_icon" style="background-image: url('+this.archive.cover_url+');"></div>\n<div class="archive_name">'+(this.archive.filename||"")+'</div>\n<div class="button_block">\n    <div class="original">'+e+'</div>\n    <div class="orange-btn">Download <br>High Quality</div>\n</div>'}})}.call(this),function(){var e,t;e=Backbone.View.extend({className:"popover_wrap new_popover_wrap video_download_modal",events:{"click .cancel_btn":"remove","click .close-btn":"remove","click .orange-btn":"downloadArchive","click .original":"requestOriginal"},initialize:function(e){return this.options=null!=e?e:{},this.subviews=[],this.payload=this.options.payload,this._render(),this._bindCallbacks()},_render:function(){return this.$el.html(this._template()),document.body.appendChild(this.el),this.cacheElements(),ThisLife.Service.api.getVideoMomentSet(this.payload.uid,_.bind(this.setVideoStatus,this))},cacheElements:function(){return this.original=this.$el.find(".original"),this.originalEl=this.el.querySelector(".original")},_bindCallbacks:function(){return this.blurEventCallback=ThisLife.blurEvent(this.$el.find(".popover"),_.bind(this.remove,this)),ThisLife.Support.keyInformant.on("cancel",this.remove,this,!0)},_unbindCallbacks:function(){return ThisLife.removeBlurEvent(this.blurEventCallback),ThisLife.Support.keyInformant.off("cancel",this.remove,this)},remove:function(){return _.each(this.subviews,function(e){return e.remove()}),this._unbindCallbacks(),this.options.controller.removeView(),Backbone.View.prototype.remove.apply(this)},downloadArchive:function(){return ThisLife.Helper.URL.downloadViaIframe(this.payload.url)},requestOriginal:function(){return ThisLife.Service.api.unfreezeMoments(this.payload.uid),$(this.el.querySelector(".original")).addClass("selected"),$(this.el.querySelector(".original")).text("Original requested")},setVideoStatus:function(e){var t;return t=e[0].glacier_status,"available"===t?($(this.el.querySelector(".original")).hide(),$(this.el.querySelector(".orange-btn")).addClass("download"),$(this.el.querySelector(".orange-btn")).text("Download")):"pending"===t?($(this.el.querySelector(".original")).text("In Progress"),$(this.el.querySelector(".original")).addClass("inprogress"),$(this.el.querySelector(".orange-btn")).hide()):($(this.el.querySelector(".original")).text("Request original"),this.originalEl.insertAdjacentHTML("beforebegin",this._getExpiredTemplate()))},_template:function(){return'<div class=\'popover one_button_modal\'>\n  <span class="close-btn"><img src="/assets/1px.gif"></span>\n  <div class="body">\n    <h4>Your download is ready!</h4>\n    <div class="popover_scroll_wrap">\n       <div class="archive_icon" style="background-image: url('+this.payload.cover_url+');"></div>\n          <div class="button_block">\n              <div class="original"></div>\n              <div class="orange-btn">Download <br>High Quality</div>\n          </div>\n    </div>\n  </div>\n</div>'},_getExpiredTemplate:function(){return'<div class="expired">Your request has expired.  You can request the original again.</div>\n<div class="arrow"></div>\n<div class="arrow border"></div>'}}),ThisLife.Download||(ThisLife.Download={}),(t=ThisLife.Download).Views||(t.Views={}),ThisLife.Download.Views.Video=e}.call(this),function(){var e,t,i;e="https://public-api.wordpress.com/rest/v1/sites/thislifehelp.wordpress.com/posts/?category=Photos%20FAQs",t=function(){function t(e){this.options=null!=e?e:{},this.posts=[],this._fetchData()}return _.extend(t.prototype,Backbone.Events),t.prototype.show=function(){var e;return null!=(e=this.view)&&e.teardown(),this.view=new ThisLife.Faqs.Views.Faqs({controller:this}),document.getElementById("tl_modal_container").appendChild(this.view.render().el),this},t.prototype._fetchData=function(){return $.ajax({cache:!0,dataType:"json",url:e,success:function(e){return function(t){return e.posts=t.posts}}(this)})},t}(),ThisLife.Faqs||(ThisLife.Faqs={}),(i=ThisLife.Faqs).Controllers||(i.Controllers={}),ThisLife.Faqs.Controllers.Faqs=t}.call(this),function(){var e,t,i,n,o;e=Backbone.View.extend({className:"faqs_modal tl_modal_wrap tl_modal_wrap_visible",events:{"click .close-btn":"teardown","click .post-list li":"_showFaqText","click .left-arrow":"_backToSettings"},initialize:function(e){return this.options=null!=e?e:{},this.controller=this.options.controller,this._bindEvents()},render:function(){return document.body.classList.add("faqs"),this.el.insertAdjacentHTML("afterbegin",o()),this._cacheElements(),this.renderFaqs(),this},renderFaqs:function(){return _.isEmpty(this.controller.posts)?_.delay(_.bind(this.renderFaqs,this),250):(this.faqs.insertAdjacentHTML("afterbegin",i(this.controller.posts)),this.el.querySelector(".post-list > li").classList.add("selected"),this.content.innerHTML=this.controller.posts[0].content)},teardown:function(){return document.body.classList.remove("faqs"),this._unbindEvents(),this.remove()},_bindEvents:function(){return ThisLife.Support.keyInformant.on("cancel",this.teardown,this),ThisLife.PubSub.on("modal:close",this.teardown,this)},_unbindEvents:function(){return ThisLife.Support.keyInformant.off("cancel",this.teardown,this),ThisLife.PubSub.off("modal:close",this.teardown)},_cacheElements:function(){return this.faqs=this.el.querySelector(".tl_modal_middle .faqs"),this.content=this.el.querySelector(".tl_modal_middle .faq_content > div")},_showFaqText:function(e){var t,i,n,o,s,r;for(t=e.currentTarget,s=t.getAttribute("post"),r=this.faqs.querySelectorAll(".post-list li"),n=0,o=r.length;o>n;n++)i=r[n],i.classList.remove("selected");return t.classList.add("selected"),this.content.innerHTML=this.controller.posts[s].content},_backToSettings:function(){return this.teardown(),ThisLife.app.router.navigate("settings")}}),o=function(){return'<div class="tl_modal_top">\n  <div class="left-arrow">Settings</div>\n  <h3>FAQ</h3>\n</div>\n\n<div class="tl_modal_middle">\n  <div class="faqs"></div>\n  <div class="faq_content"><div></div></div>\n</div>\n\n<div class="tl_modal_bottom">\n  <div class="tl_modal_bottom_left">\n    <ul class="faqs_links">\n      <li><a href="https://shutterfly-2.custhelp.com/app/answers/detail/a_id/1830" target="_blank">Help</a></li>\n      <li><a href="https://www.shutterflyinc.com/terms.html" target="_blank">Terms of Service</a></li>\n    </ul>\n  </div>\n  <div class="tl_modal_bottom_right">\n    <a class="close-btn small-btn gray-btn">Done</a>\n  </div>\n</div>'},i=function(e){var t,i,o,s,r;for(null==e&&(e=[]),s="",t=i=0,o=e.length;o>i;t=++i)r=e[t],s+=n(t,r);return"<ul class='post-list'>\n  "+s+"\n</ul>"},n=function(e,t){return'<li post="'+e+'">'+t.title+"</li>"},ThisLife.Faqs||(ThisLife.Faqs={}),(t=ThisLife.Faqs).Views||(t.Views={}),ThisLife.Faqs.Views.Faqs=e}.call(this),function(){define("ThisLife.Flyout.Controllers.Factory",["ThisLife.Flyout.Views.Flyout"],function(e){var t;return t=function(){function t(){}return t.prototype.show=function(t){return this.removeView(),this._view=new e(t)},t.prototype.removeView=function(){var e;return null!=(e=this._view)&&e.teardown(),this._view=null,this},t}()})}.call(this),function(){define("ThisLife.Flyout.Controllers.Flyout",["ThisLife.Flyout.Controllers.Factory"],function(e){var t;return t=function(){function t(){this.flyouts={}}return _.extend(t.prototype,Backbone.Events),t.prototype.get=function(t){return this.flyouts[t]?this.flyouts[t]:this.flyouts[t]=new e},t.prototype.remove=function(e){return null!=this.flyouts[e]&&(this.flyouts[e].removeView(),delete this.flyouts[e]),this},t.prototype.keep=function(e){return _.each(this.flyouts,function(t){return function(i,n){return n!==e?t.remove(n):void 0}}(this))},t.prototype.list=function(){return this.flyouts},t}()})}.call(this),function(){define("ThisLife.Flyout.Views.Flyout",["ThisLife.Flyout.Views.FlyoutItem"],function(e){var t;return t=Backbone.View.extend({className:"flyout-view",initialize:function(e){return this.options=null!=e?e:{},this._itemViews=[],this._render(),this._cacheElements(),this._renderItems(),this._setClassnames(),this._setStyles(),this._bindEvents(),this},_render:function(){var e;return this.el.insertAdjacentHTML("beforeend",this._getTemplate()),(null!=(e=this.options.classes)?e.length:void 0)&&this._appendClasses(),this},_appendClasses:function(){var e,t,i,n,o;for(n=this.options.classes,o=[],t=0,i=n.length;i>t;t++)e=n[t],o.push(this.el.classList.add(e));return o},_cacheElements:function(){return this._arrowBoxEl=this.el.querySelector(".arrow_box"),this._listEl=this.el.querySelector(".list"),this._titleEl=this.el.querySelector(".title")},_renderItems:function(){var t,i,n,o,s,r;if(null!=this.options.title&&(this._titleEl.classList.remove("hidden"),this._titleEl.textContent=this.options.title),null!=this.options.items&&0!==(null!=(o=this.options.items)?o.length:void 0)||null==this.options.title||""===this.options.title||this._titleEl.classList.remove("hidden"),this.options.items&&Array.isArray(this.options.items))for(this.el.classList.add("flyout-menu"),s=this.options.items,t=0,n=s.length;n>t;t++)i=s[t],r=new e(i),this._itemViews.push(r),this._listEl.appendChild(r.el)},_setClassnames:function(){null!=this.options.arrowAlign&&""!==this.options.arrowAlign&&this._arrowBoxEl.classList.add(this.options.arrowAlign)},_setStyles:function(){var e,t,i,n,o,s;return e=this.el,s=(null!=(i=this.options.styles)?i["default"]:void 0)||this.options.styles||{},t=(null!=(n=this.options.styles)?n.mobile:void 0)||{},o=function(t){var i;for(i in t)e.style[i]=t[i]},o(s),_.isEmpty(t)?void 0:(this._isMobileScreen()&&o(t),window.addEventListener("resize",function(e){return function(){var i;return i=e._isMobileScreen()?t:s,o(i)}}(this)))},_isMobileScreen:function(){return window.innerWidth<=480},_bindEvents:function(){var e,t,i,n;for(i=this._itemViews,e=0,t=i.length;t>e;e++)n=i[e],n.on("selected",this._onItemSelected,this);return this._bindBlurEvent()},_unbindEvents:function(){var e,t,i,n;for(i=this._itemViews,e=0,t=i.length;t>e;e++)n=i[e],n.off(null,null,this);return this._unbindBlurEvent()},_bindBlurEvent:function(){return this.blurEventCallback=ThisLife.blurEvent(this.$el,_.bind(this.hide,this))},_unbindBlurEvent:function(){return null!=this.blurEventCallback?ThisLife.removeBlurEvent(this.blurEventCallback):void 0},_onItemSelected:function(e){var t,i;return i=this._getViewByOptions(e),"radio"===(t=e.type)&&this.deselectAllExcept(e),"function"==typeof e.onClick&&e.onClick(e),this.hide()},deselectAllExcept:function(e){var t,i,n,o;for(n=this._itemViews,t=0,i=n.length;i>t;t++)o=n[t],o.options.name===e.name&&o.options.value!==e.value&&o.deselect()},_getViewByOptions:function(e){var t;return e?(t=this._itemViews.filter(function(t){return t.options.type===e.type&&t.options.value===e.value}),t[0]||null):null},hide:function(){var e;return this.el.classList.add("hidden"),this._unbindBlurEvent(),"function"==typeof(e=this.options).onHide?e.onHide():void 0},show:function(){return this.el.classList.remove("hidden"),this._unbindBlurEvent(),this._bindBlurEvent()},teardown:function(){var e;return"function"==typeof(e=this.options).onHide&&e.onHide(),this._unbindEvents(),this.remove()},_getTemplate:function(){return'<div class="arrow_box"></div>\n<div class="title hidden"></div>\n<ul class="list"></ul>'}})})}.call(this),function(){define("ThisLife.Flyout.Views.FlyoutItem",function(){var e;return e=Backbone.View.extend({tagName:"li",className:"flyout-item-view",ITEM_TYPES:{NORMAL:"normal",RADIO:"radio",CHECKBOX:"checkbox",DIVIDER:"divider"},events:{click:"_onClick"},initialize:function(e){return this.options=null!=e?e:{},this._render(),this._cacheElements(),this.options.selected&&this.select(),this.options.disabled&&this.disable(),this},_render:function(){var e;return this.el.insertAdjacentHTML("beforeend",this._getTemplate()),this.el.classList.add(this.options.type),(null!=(e=this.options.classes)?e.length:void 0)?this._appendClasses():void 0},_appendClasses:function(){var e,t,i,n,o;for(n=this.options.classes,o=[],t=0,i=n.length;i>t;t++)e=n[t],o.push(this.el.classList.add(e));return o},_cacheElements:function(){return this._labelEl=this.el.querySelector(".label")},_onClick:function(e){return e.preventDefault(),e.stopPropagation(),this.select()},select:function(){return this.isEnabled()?(this.el.classList.add("selected"),this.trigger("selected",this.options)):void 0},deselect:function(){return this.el.classList.remove("selected")},enable:function(){return this.el.classList.remove("disabled")},disable:function(){return this.el.classList.add("disabled")},isEnabled:function(){return!this.el.classList.contains("disabled")},getType:function(){return this.options.type},teardown:function(){return this.remove()},_getTemplate:function(){var e;return e="",this.options.icon&&(e='<span class="icon '+this.options.icon+'"></span>'),e+'\n<span class="label">'+this.options.label+"</span>"}})})}.call(this),function(){var e=[].indexOf||function(e){for(var t=0,i=this.length;i>t;t++)if(t in this&&this[t]===e)return t;return-1},t=[].slice;ThisLife.Model.Gifting=ThisLife.Model.Gifting||{},ThisLife.Model.Gifting.ModelController=APIModel.extend({USER_SELECTION_EXPIRY_TIMEOUT:3600,initialize:function(e){return null==e&&(e={}),this.loaded=!1,this.momentsLoaded=!1,this.personsLoaded=!1,this.giftedPersonsLoaded=!1,this.relationshipsLoaded=!1,this.defaultPersonsLoaded=!1,this.defaultGiftedLoaded=!1,this.defaultMomentsLoaded=!1,this.parentView=e.parentView||null,ThisLife.Collection.moments.whenLoaded(function(t){return function(){var i;return i=new ThisLife.Collection.Gifting.Moments(e.eventInfo.get("moments")),i.setStrategy(e.strategy),t.set("moments",i),t.momentsLoaded=!0,t.trigger("dataArrived")}}(this)),ThisLife.Collection.personTags.whenLoaded(function(t){return function(){var i,n,o;return o=0===ThisLife.Collection.personTags.length?8:6,i=new ThisLife.Collection.Gifting.Persons(t._slicePersons(e.eventInfo.get("persons"),e.eventInfo.get("gifted"),o)),i.whenLoaded(function(){return t.set("persons",i),t.personsLoaded=!0,t.trigger("dataArrived")}),n=new ThisLife.Collection.Gifting.GiftedPersons(e.eventInfo.get("gifted")),n.whenLoaded(function(){return t.set("gifted",n),t.giftedPersonsLoaded=!0,t.trigger("dataArrived")})}}(this)),ThisLife.Collection.relationships.whenLoaded(function(e){return function(){return e.relationshipsLoaded=!0,e.trigger("dataArrived")}}(this)),this.on("dataArrived defaultApplied",this.waitForBind.bind(this))},_slicePersons:function(t,i,n){var o,s,r,l,a,u,c,d,h,p;for(o=_.pluck(i,"guid"),s=t.length-n,a=[],r=u=h=t.length-1;0>=h?0>=u:u>=0;r=0>=h?++u:--u)s>0&&(p=t[r].guid,e.call(o,p)<0&&(s-=1,a.push(r)));for(c=0,d=a.length;d>c;c++)l=a[c],t.splice(l,1);return t},allDefaultsLoaded:function(){return this.defaultPersonsLoaded&&this.defaultGiftedLoaded&&this.defaultMomentsLoaded},whenLoaded:function(){var e,i,n;return i=arguments[0],n=arguments[1],e=3<=arguments.length?t.call(arguments,2):[],this.loaded?i.apply(n,e):this.on("dataArrived",function(t){return function(){return t.momentsLoaded&&t.personsLoaded&&t.giftedPersonsLoaded&&t.relationshipsLoaded?i.apply(n,e):void 0}}(this))},whenDefaultsApplied:function(){var e,i,n;return i=arguments[0],n=arguments[1],e=3<=arguments.length?t.call(arguments,2):[],this.on("defaultApplied",function(t){return function(){return t.allDefaultsLoaded()?(i.apply(n,e),t.off("defaultApplied")):void 0}}(this))},waitForBind:function(){return this.momentsLoaded&&this.personsLoaded&&this.giftedPersonsLoaded&&this.relationshipsLoaded?this.bindEvents():void 0},bindEvents:function(){return this.get("moments").on("change add remove",_.debounce(this.onMomentsChange.bind(this),200)),this.get("persons").on("change add remove",_.debounce(this.onPersonsChange.bind(this),200)),this},applyDefaultPersons:function(e){var t;return this.hasValidSavedSelection()&&!e?(t=this.get("persons").applySavedSelection(this.loadUserSelection().selectedPersons),0===t&&this.get("persons").trigger("change"),this.defaultPersonsApplied()):(this.get("persons").applyDefaults(),this.defaultPersonsApplied())},defaultPersonsApplied:function(){return this.defaultPersonsLoaded=!0,this.trigger("defaultApplied"),this.savePersonSelection()},applyDefaultGifted:function(e){return e?(this.get("gifted").applySavedSelection(this.parentView,e),this.defaultGiftedApplied()):this.hasValidSavedSelection()?(this.loadUserSelection().giftedPerson&&this.get("gifted").applySavedSelection(this.parentView,this.loadUserSelection().giftedPerson),this.defaultGiftedApplied()):(this.get("gifted").applyDefaults(this.parentView),this.defaultGiftedApplied())},defaultGiftedApplied:function(){return this.defaultGiftedLoaded=!0,this.trigger("defaultApplied")},applyDefaultMoments:function(e){var t,i;return this.hasValidSavedSelection()&&!e?(t=this.loadUserSelection(),i=this.get("moments").applySavedSelection(t.selectedMoments),this.defaultMomentsApplied()):this.defaultMomentsApplied()},defaultMomentsApplied:function(){return this.defaultMomentsLoaded=!0,this.trigger("defaultApplied"),this.saveMomentSelection()},onMomentsChange:function(){return this.saveMomentSelection(),this.trigger("change:moments")},onPersonsChange:function(){return this.savePersonSelection(),this.trigger("change:persons")},hasValidSavedSelection:function(){var e;return e=this.loadUserSelection(),e&&null!=e.expire&&e.expire>=this.getCurrentTime()},hasValidSavedMomentSelection:function(){var e;return e=this.loadUserSelection(),e&&null!=e.expire&&e.expire>=this.getCurrentTime()&&e.selectedMoments},saveMomentSelection:function(){var e;return this.allDefaultsLoaded()?(e={selectedPersons:this.get("persons").getPersonsOnly().toJSON(),selectedMoments:this.get("moments").getVisibleOnly(!1).toJSON()},this.saveUserSelection(e)):void 0},savePersonSelection:function(){var e,t;return this.allDefaultsLoaded()?(e=this.loadUserSelection(),t={selectedPersons:this.get("persons").getPersonsOnly().toJSON(),selectedMoments:(null!=e?e.selectedMoments:void 0)||null},this.saveUserSelection(t)):void 0},saveUserSelection:function(e){return this.allDefaultsLoaded()?(e.giftedPerson=this.parentView.giftedPerson,e.expire=this.getCurrentTime()+this.USER_SELECTION_EXPIRY_TIMEOUT,ThisLife.appModel.setGiftingUserSelection(e)):void 0},loadUserSelection:function(){return ThisLife.appModel.getGiftingUserSelection()},getCurrentTime:function(){return Math.floor((new Date).getTime()/1e3)},addGiftedToPersons:function(e){var t;return t=function(t){return function(i){return null==i&&(i=null),t.get("persons").addAndSelect(e,i),_.defer(function(){return t.get("persons").findWhere({guid:e}).select(),t.defaultGiftedApplied()})}}(this),this.get("moments").addGiftedHeroMoments(e,this.get("gifted"),this.get("persons"),t)},removeGiftedFromPersons:function(e,t){return this.get("moments").setMaxPersons(8),this.get("moments").deselectAllGiftedMoments(!0),this.get("persons").removeAndDeselect(e),"function"==typeof t?t():void 0}})}.call(this),function(){ThisLife.Model.Gifting=ThisLife.Model.Gifting||{},ThisLife.Model.Gifting.Moment=APIModel.extend({idAttribute:"id",defaults:{isSelected:!1,ofPerson:!0,ofGifted:!1,hidden:!0},initialize:function(){return this.set("model",ThisLife.Collection.moments.get(this.get("id")))},select:function(){return this.set("isSelected",!0),this.show()},deselect:function(){return this.set("isSelected",!1)},isSelected:function(){return this.get("isSelected")},toggleSelection:function(){return this.get("isSelected")?this.deselect():this.select()},ofPerson:function(){return this.get("ofPerson")},ofPersonOnly:function(){return this.get("ofPerson")&&!this.get("ofGifted")},ofGifted:function(){return this.get("ofGifted")},ofGiftedOnly:function(){return this.get("ofGifted")&&!this.get("ofPerson")},hasHero:function(e){return-1!==this.get("people").indexOf(e)&&1===this.get("numFaces")},getId:function(){return this.get("id")},setAsGifted:function(){return this.set("ofGifted",!0)},hide:function(){return this.set("hidden",!0)},show:function(){return this.set("hidden",!1)},isHidden:function(){return this.get("hidden")}})}.call(this),function(){ThisLife.Model.Gifting=ThisLife.Model.Gifting||{},ThisLife.Model.Gifting.Person=APIModel.extend({defaults:{isSelected:!1,role:"none"},initialize:function(){return"person"===this.get("type")&&this.initPersonTag(),"suggestion"===this.get("type")?this.initSuggestion():void 0},initSuggestion:function(){return this.trigger("model:completed")},initPersonTag:function(){return this.set("model",ThisLife.Collection.personTags.get(this.get("guid"))),_.defer(function(e){return function(){return e.trigger("model:completed")}}(this))},toggleSelection:function(){return this.set("isSelected",!this.get("isSelected"))},select:function(){return this.set("isSelected",!0)},deselect:function(){return this.set("isSelected",!1)},getFaceUrl:function(){return ThisLife.Helper.Image.faceUrl(this.get("faceId"))},getId:function(){return this.get("guid")},getType:function(){return this.get("type")}})}.call(this),function(){ThisLife.Collection.Gifting=ThisLife.Collection.Gifting||{},ThisLife.Collection.Gifting.Moments=APICollection.extend({model:ThisLife.Model.Gifting.Moment,MAX_PERSONS:8,initialize:function(){return this.resetSelectionCounters(),this.strategy=ThisLife.Collection.Gifting.Moments.STRATEGY_HERO_FIRST},setStrategy:function(e){return this.strategy=e},getSelectedOnly:function(e){var t;return null==e&&(e=!0),t=new Backbone.Collection,_.each(this.models,function(e){return e.get("isSelected")?t.add(e):void 0}),e?this.shuffleMoments(t):t},getVisibleOnly:function(e){var t;return null==e&&(e=!0),t=new Backbone.Collection,_.each(this.models,function(e){return e.isHidden()?void 0:t.add(e)}),e?this.shuffleMoments(t):t},shuffleMoments:function(e){var t,i,n,o;for(n={},o=new Backbone.Collection,e.each(function(){return function(e){var t;return 1===e.get("numFaces")?(t=e.get("people")[0],n.hasOwnProperty(t)||(n[t]=[]),n[t].push(e)):(n.hasOwnProperty("groupshot")||(n.groupshot=[]),n.groupshot.push(e))}}(this)),i=0,t=function(){return function(e,t){return e.getId()>t.getId()?1:-1}}(this),_.each(n,function(){return function(e){return e.sort(t)}}(this));i<e.length;)_.each(n,function(){return function(e){return 0===Object.keys(e).length?!0:(o.add(e.shift()),i++)}}(this));return o},selectMoments:function(e,t,i){var n,o;return null==i&&(i=!0),o=e.getSelectedOnly(),n=_.pluck(o.toJSON(),"guid"),this.selectByPersonsOnly(n,i,function(e){return function(){return t?e.applySavedSelection(t):void 0}}(this))},selectByPersonsOnly:function(e,t,i){return e.length===this.MAX_PERSONS?(this.selectAllPersonMoments(),void this.trigger("change")):0===e.length?(this.deselectAllMoments(t),void this.trigger("change")):(this.resetSelectionCounters(),this.deselectAllPersonMoments(t),this.strategy===ThisLife.Collection.Gifting.Moments.STRATEGY_GROUPSHOT_FIRST?(this.selectNonHeroMomentsExclusively(e),this.selectPersonHeroMoments(e)):(this.selectPersonHeroMoments(e),this.selectNonHeroMoments(e)),_.defer(function(){return function(){return null!=i?i():void 0
}}(this)))},selectNonHeroMoments:function(e){return this.selectAllPersonsTogether(e),this.hasEnoughPhotos()||(this.selectOnlyPersonsTogether(e),this.hasEnoughPhotos())?void 0:this.selectPersonsWithOthers(e)},selectNonHeroMomentsExclusively:function(e){return this.selectAllPersonsTogether(e),this.hasEnoughPhotos()?void 0:this.selectOnlyPersonsTogether(e)},addGiftedHeroMoments:function(e,t,i,n){return t.where({guid:e}).length||i.where({guid:e}).length?"function"==typeof n?n():void 0:(this.setMaxPersons(9),ThisLife.Collection.personTags.getMomentUidsFromFaces(e,function(t){return function(o){var s,r,l;return s=new Backbone.Collection(ThisLife.Collection.moments.filter(function(e){return-1!==o.indexOf(e.get("uid"))})),s.comparator=function(e){return-parseInt(e.get("moment_date"))},s.sort(),r=_.map(s.first(50),function(e){return e.get("uid")}),l=0!==i.where({guid:e}).length,t.addMomentsByUid(r,5,l,n)}}(this)))},addMomentsByUid:function(e,t,i,n){return null==t&&(t=null),null==i&&(i=!1),ThisLife.Service.api.getMomentSet(e,function(i){return function(o){return null!=o&&(t?(o.comparator=function(e){return-parseInt(e.get("moment_date_timestamp"))/Math.pow(10,e.get("faces").length)},o.sort(),o=o.first(t)):o=o.first(o.length),_.each(o,function(e){var t;return t={id:parseInt(e.get("uid")),numFaces:e.get("faces").length,people:_.pluck(e.get("faces"),"person_tag_uid"),ofPerson:!0,isSelected:!0,hidden:!1},i.add(t,{merge:!0})})),"function"==typeof n?n(e):void 0}}(this))},findHeroMoments:function(e){var t;return t=[],_.each(this.models,function(i){return i.hasHero(e)?t.push(i.getId()):void 0}),t},selectMomentsAsGifted:function(e){return _.each(this.models,function(t){return-1!==e.indexOf(t.getId())?(t.select(),t.setAsGifted()):void 0})},deselectAllPersonMoments:function(e){return null==e&&(e=!1),_.each(this.models,function(t){return t.ofPerson()?(e&&t.hide(),t.deselect()):void 0})},deselectAllMoments:function(e){return null==e&&(e=!1),_.each(this.models,function(t){return e&&t.hide(),t.deselect()})},selectAllMoments:function(e){return null==e&&(e=!1),_.each(this.models,function(t){return e&&t.isHidden()?void 0:t.select()})},selectAllPersonMoments:function(){return _.each(this.models,function(e){return e.ofPerson()?e.select():void 0})},deselectAllGiftedMoments:function(e){return null==e&&(e=!1),_.each(this.models,function(t){return t.ofGiftedOnly()?(e&&t.hide(),t.deselect()):void 0})},selectGiftedPersonMoments:function(e){return _.each(this.models,function(t){return t.ofGifted()&&-1!==t.get("people").indexOf(e)?t.select():void 0})},selectPersonHeroMoments:function(e){return this.hasEnoughPhotos()?void 0:_.each(e,function(e){return function(t){var i;return i=0,_.each(e.models,function(n){var o;return n.ofPerson()&&(o=_.intersection(n.get("people"),[t]),o.length>0&&n.get("numFaces")===o.length&&1===o.length)?(0===e.selectionCounters.hero?(n.select(),e.selectionCounters.hero++,e.selectionCounters.moments.push(n.getId())):n.show(),i++):void 0}),0===i?e.selectNonHeroMoments([t]):void 0}}(this))},selectAllPersonsTogether:function(e){var t;return t=0,_.each(this.models,function(i){return function(n){var o;return n.ofPerson()&&(o=_.intersection(n.get("people"),e),o.length>1&&n.get("numFaces")===o.length&&o.length===e.length)?(i.selectionCounters.allPersons<=2?(n.select(),i.selectionCounters.allPersons++,i.selectionCounters.moments.push(n.getId())):n.show(),t++):void 0}}(this)),t},selectOnlyPersonsTogether:function(e){var t;return t=0,_.each(this.models,function(i){return function(n){var o;return n.ofPerson()&&(o=_.intersection(n.get("people"),e),o.length>1&&n.get("numFaces")===o.length&&o.length<e.length&&!i.hasEnoughPhotos()&&!n.isSelected())?(i.selectionCounters.onlySomePersons<=1?(n.select(),i.selectionCounters.onlySomePersons++,i.selectionCounters.moments.push(n.getId())):n.show(),t++):void 0}}(this)),t},selectPersonsWithOthers:function(e){var t;return t=0,this.comparator=function(e){return-e.get("numFaces")},this.sort(),_.each(this.models,function(i){return function(n){var o;return n.ofPerson()&&(o=_.intersection(n.get("people"),e),o.length>0&&n.get("numFaces")>o.length&&o.length<=e.length&&!i.hasEnoughPhotos()&&!n.isSelected())?(n.select(),i.selectionCounters.someOthers++,i.selectionCounters.moments.push(n.getId()),t++):void 0}}(this)),t},applyDefaults:function(){var e;return e=0,_.each(this.models,function(t){return t.get("selected")?(t.select(),e++):t.deselect()}),e},applySavedSelection:function(e){var t,i;return t=0,i=new Backbone.Collection(e),_.each(this.models,function(e){var n,o;return o=e.getId(),n=i.get(o),null!=n&&n.get("isSelected")&&!e.isHidden()?(e.select(),t++):e.deselect()}),t},logMoments:function(){return _.each(this.models,function(){return function(e){return console.log(">>> ",e.getId(),"gifted:",e.ofGifted(),"person:",e.ofPerson())}}(this))},resetSelectionCounters:function(){return this.selectionCounters={hero:0,allPersons:0,onlySomePersons:0,someOthers:0,moments:[]}},checkSelectionCountersForHeroStrategy:function(){var e,t,i;return e=this.selectionCounters.allPersons+this.selectionCounters.onlySomePersons+this.selectionCounters.someOthers,t=this.selectionCounters.hero,i=.5,0===t?e>6:e>=Math.floor(i*t)},checkSelectionCountersForGroupshotStrategy:function(){var e,t;return e=this.selectionCounters.allPersons+this.selectionCounters.onlySomePersons+this.selectionCounters.someOthers,t=this.selectionCounters.hero,0===e?t>6:e+t>=10},hasEnoughPhotos:function(){return this.strategy===ThisLife.Collection.Gifting.Moments.STRATEGY_GROUPSHOT_FIRST?this.checkSelectionCountersForGroupshotStrategy():this.checkSelectionCountersForHeroStrategy()},setMaxPersons:function(e){return this.MAX_PERSONS=e}}),ThisLife.Collection.Gifting.Moments.STRATEGY_HERO_FIRST=1,ThisLife.Collection.Gifting.Moments.STRATEGY_GROUPSHOT_FIRST=2}.call(this),function(){var e=[].slice;ThisLife.Collection.Gifting=ThisLife.Collection.Gifting||{},ThisLife.Collection.Gifting.Persons=APICollection.extend({model:ThisLife.Model.Gifting.Person,initialize:function(){return this.on("model:completed",this.onModelCompleted,this)},getSelectedOnly:function(){var e;return e=new Backbone.Collection,_.each(this.models,function(t){return t.get("isSelected")?e.add(t):void 0}),e},getPersonsOnly:function(){var e;return e=new Backbone.Collection,_.each(this.models,function(t){return"person"===t.getType?e.add(t):void 0}),0===e.length?this:e},whenLoaded:function(){var t,i,n;return i=arguments[0],n=arguments[1],t=3<=arguments.length?e.call(arguments,2):[],this.loaded?i.apply(n,t):this.on("personLoadingCompleted",function(){return function(){return i.apply(n,t)}}(this))},onModelCompleted:function(){return this.completed?this.completed++:this.completed=1,this.completed===this.models.length?(this.loaded=!0,this.trigger("personLoadingCompleted")):void 0},applyDefaults:function(){return _.each(this.models,function(e){return e.get("selected")?e.select():void 0})},applySavedSelection:function(e){var t,i;return t=0,i=new Backbone.Collection(e.models?e.models:e),_.each(this.models,function(e){var n;return(null!=(n=i.findWhere({guid:e.getId()}))?n.get("isSelected"):void 0)?(e.select(),t++):void 0}),t},addAndSelect:function(e,t){var i,n,o;return i=this.findWhere({guid:e}),i?i.select():(n=ThisLife.Collection.personTags.get(e),o={faceId:n.get("face"),guid:e,selected:!0,type:"gifted"},t&&(o.moment=t[0],o.moments=t),this.add(o))},removeAndDeselect:function(e){var t;return t=this.findWhere({guid:e}),"person"===t.getType()?t.deselect():t.destroy()}})}.call(this),function(){ThisLife.Collection.Gifting=ThisLife.Collection.Gifting||{},ThisLife.Collection.Gifting.GiftedPersons=ThisLife.Collection.Gifting.Persons.extend({applyDefaults:function(e){return e?_.each(this.models,function(){return function(t){return t.get("default")?e.selectGiftedPerson(t.get("guid")):void 0}}(this)):void 0},applySavedSelection:function(e,t){return e&&t?e.selectGiftedPerson(t):void 0},initialize:function(){return 0===this.length&&(this.loaded=!0,this.trigger("personLoadingCompleted")),this.on("model:completed",this.onModelCompleted,this)}})}.call(this),function(){var e,t;e=function(){function e(){ThisLife.PubSub.on("state:change",this._stateChange,this)}return _.extend(e.prototype,Backbone.Events),e.prototype.show=function(e,t,i){var n;switch(null==i&&(i={}),null!=(n=this._view)&&n.remove(),e){case"mothersday2017":return this.renderMothersDay(t,i);case"fathersday2016":return this.renderFathersDay(t,i);case"holidays2016":return this.renderHolidays(t,i);default:return ThisLife.app.router.navigate("/")}},e.prototype._stateChange=function(e){var t;return"gifting"!==e.name?(null!=(t=this._view)&&t.remove(),this._view=null):void 0},e.prototype.renderMothersDay=function(e,t){var i;return null==t&&(t={}),i=(null!=t?t.person:void 0)||null,this._view=new ThisLife.View.GiftingView({event:"2017-mothers-day",person:i,strategy:ThisLife.Collection.Gifting.Moments.STRATEGY_GROUPSHOT_FIRST}),$("body").append(this._view.render({page:e}).el)},e.prototype.renderFathersDay=function(e,t){var i;return null==t&&(t={}),i=(null!=t?t.person:void 0)||null,this._view=new ThisLife.View.GiftingView({event:"2016-fathers-day",person:i}),$("body").append(this._view.render({page:e}).el)},e.prototype.renderHolidays=function(e,t){var i;return null==t&&(t={}),i=(null!=t?t.person:void 0)||null,this._view=new ThisLife.View.GiftingView({event:"2016-holidays",person:i,strategy:ThisLife.Collection.Gifting.Moments.STRATEGY_GROUPSHOT_FIRST}),$("body").append(this._view.render({page:e}).el)},e}(),ThisLife.Gifting||(ThisLife.Gifting={}),(t=ThisLife.Gifting).Controllers||(t.Controllers={}),ThisLife.Gifting.Controllers.Gifting=e}.call(this),function(){var e,t,i,n,o,s,r,l,a,u,c,d;ThisLife.View.GiftingView=Backbone.View.extend({id:"gifting-container",events:{"click .gifting-mobile-nav .gifting-nav-link":"navigateToSecondPage","click .gifting-mobile-nav .gifting-prev":"navigateToFirstPage","click .main-gifting-title-back-btn":"navigateToLibrary","click .info.relationship .text":"editRelationship","click .info.relationship":"editRelationship","focus input.mother-name":"setupAutocomplete","click .moment-selection-wrapper":"toggleMomentDebug","click .auto-complete-person":"changePerson","click .gifting-recipe-selection-item":"changeRecipe","click .clear-all-moment-selection":"toggleMomentSelection","click .go-to-store-btn":"goToStore","click .gifting-back-to-top-wrapper":"backToTop"},initialize:function(e){return this._checkBrowser(),this.mobileBreakpoint=768,this.isMobile=$(window).width()<this.mobileBreakpoint,this.currPage=1,this.continueCallback=e.continueTo,this.collection=null,this.rendered=!1,this.mgLoaded=!1,this.noHeader=!1,this.toredown=!1,this.giftedPerson=null,this.modelLoaded=!1,this.needRedirectToPage2=!1,this.navEnabled=!1,this.selectionState=1,this.selectionTexts=["Deselect All","Select All"],this.noCacheOnInit=!0,this.trackingEnabled=!1,this.giftedPersonParam=e.person||null,this.textsEngine=new ThisLife.View.Gifting.Helpers.Texts.GiftingTexts(e.event),this.config=new ThisLife.View.Gifting.Helpers.Config.GiftingConfig(e.event),this.currentFragment=this._getCurrentFragmentUrl(),this.personJustChanged=!1,this.event=e.event,this.useGoldTheme=!1,this.usePinkTheme=!1,this.useFloatingTitle=!1,"2016-holidays"===this.event&&(this.useGoldTheme=!0,this.$el.addClass("gold-theme")),"2017-mothers-day"===this.event&&(this.usePinkTheme=!0,this.$el.addClass("pink-theme"),this.useFloatingTitle=!0),this.debug=window.location.href.indexOf("debug")>-1,this.relationshipsToInclude=this.config.getRelationships(),null!=e.event?ThisLife.Service.api.getEventInfo(e.event,"default",function(t){return function(i){var n;return t.model=new ThisLife.Model.Gifting.ModelController({eventInfo:i,parentView:t,strategy:e.strategy||ThisLife.Collection.Gifting.Moments.STRATEGY_HERO_FIRST}),t.noCacheOnInit=!t.model.hasValidSavedSelection(),t.savedMomentSelection=t.model.hasValidSavedMomentSelection()?t.model.loadUserSelection().selectedMoments:null,t.bindEvents(),n=function(){return t.removeURLParams(),t.initializeMenu(),t.bindModelEvents(),t.model.whenDefaultsApplied(function(){return t.modelLoaded=!0,t.loadMagicshop(t.getFilteredCollection())})},t.model.whenLoaded(function(){return t.rendered?n():t.on("rendered",function(){return n()})},t)}}(this),function(e){return function(){return e._redirectToStore()}}(this)):void 0},bindEvents:function(){return $(window).on("resize.gifting",_.throttle(this.onResize.bind(this),200)),$(window).on("resize.gifting",_.debounce(this.afterResize.bind(this),200)),$(window).on("resize.gifting scroll.gifting touchmove.gifting",_.throttle(this.checkHeaderVisibility.bind(this),200)),ThisLife.PubSub.on("state:change",this.teardown.bind(this,!1)),this},bindModelEvents:function(){return this.model.on("change:moments",_.debounce(this.onMomentsChange.bind(this),1e3)),this.model.on("change:moments",this.adjustSelectionText.bind(this)),this.model.on("change:persons",_.debounce(this.onPersonsChange.bind(this),1e3))},unbindEvents:function(){return $(window).off("resize.gifting"),$(window).off("scroll.gifting"),$(window).off("touchmove.gifting"),this},onResize:function(){return this.handleModesTransition(),this.resizeMainContainer(),this},checkHeaderVisibility:function(){return this.isMobile?($(window).scrollTop()>500?this.$el.find(".gifting-back-to-top-wrapper").fadeIn():this.$el.find(".gifting-back-to-top-wrapper").fadeOut(),this):void 0},afterResize:function(){var e,t,i;return t=this.isMobile&&$(window).width()>=this.mobileBreakpoint,e=!this.isMobile&&$(window).width()<this.mobileBreakpoint,i=t||e,this.isMobile=$(window).width()<this.mobileBreakpoint,this.resizeMainContainer(),i?(this.hideMG(),this.renderMagicshop(),this.renderMomentSelection()):void 0},handleModesTransition:function(){return $(this.leftPane).show(),$(this.rightPane).show(),this},onMomentsChange:function(){var e;return this.hideMG(),this.renderMagicshop(),this.personJustChanged?(this.renderMomentSelection(this.personJustChanged),this.personJustChanged=!1,this.momentSelectionContainer.show().removeClass("gifting-mock-moment-section")):null!=(e=this.magicshop)?e.trackClick("gifting-moment"):void 0},onPersonsChange:function(){var e,t,i,n,s;return this.trackingEnabled&&null!=(s=this.magicshop)&&s.trackClick("gifting-person"),this.personJustChanged=!0,this.renderPeopleSelection(!1),t=20,e=8,n=this.isMobile?t:e,i=Math.max(this.model.get("moments").getSelectedOnly().length,n),this.momentSelectionContainer.html(o(i)).addClass("gifting-mock-moment-section"),_.defer(function(e){return function(){return e.selectMoments()}}(this))},selectMoments:function(){var e;return e=this.model.get("moments"),e?e.selectMoments(this.model.get("persons"),this.savedMomentSelection):void 0},cacheElements:function(){return this.leftPane=this.$el.find(".left-pane"),this.rightPane=this.$el.find(".right-pane"),this.header=this.$el.find(".gifting-header"),this.rightPaneMg=this.$el.find(".right-pane-mg-wrapper"),this.mgWrapper=this.$el.find(".mg-wrapper"),this.throbberWrapper=this.$el.find(".throbber-wrapper"),this.leftPaneMenuWrap=this.leftPane.find(".left-pane-menu-wrapper"),this.personSelectionWrap=this.leftPaneMenuWrap.find(".person-selection-wrapper"),this.peopleSelectionWrap=this.leftPaneMenuWrap.find(".people-selection-wrapper"),this.momentSelectionWrap=this.leftPane.find(".moment-selection-wrapper"),this.mobileNav=this.$el.find(".left-pane-mobile-nav"),this.scrollingHeaders=this.$el.find(".scrolling-headers-wrapper")},backToTop:function(){var e;return e=0,$("html, body").animate({scrollTop:e})},resizeMainContainer:function(){var e;return this.isMobile?(this.rightPane.addClass("mobile"),this.$el.css("height","100%").removeClass("no-header")):(this.rightPane.removeClass("mobile"),e=$(window).height()-$("#tl_primary_bar").height()-1,e&&e>0?(this.$el.css("height",e+"px").addClass("no-header"),this.revealBackgroundHeader()):void 0)},revealBackgroundHeader:function(){return $("#tl_modal_container").css("top","51px"),this.noHeader=!0},hideBackgroundHeader:function(){return this.noHeader?($("#tl_modal_container").css("top","0"),this.noHeader=!1):void 0},render:function(e){var i,n,o;return this.options=null!=e?e:{},this._resetScroll(),n=this.config.getRecipes(),o=this.textsEngine.getProductTypeToggleTexts(),this.useGoldTheme&&_.each(o,function(){return function(e,t){return o[t]="<span class='golden-bullet'>&#8226;</span>"+e+"<span class='golden-bullet'>&#8226;</span>"}}(this)),i=this.textsEngine.getMainTitle(),this.useFloatingTitle&&(i="",this.addFloatingTitle(this.textsEngine.getMainTitle())),this.$el.html(t(i,o,n,this.isMobile,this.textsEngine.getPeopleSelectionTitle(),this.usePinkTheme)),this.cacheElements(),this.updateViewAccordingToEvent(),this.scrollingHeaders.html(c()),this.resizeMainContainer(),this.rendered=!0,this.trigger("rendered"),this.debug&&this.momentSelectionWrap.show(),this},addFloatingTitle:function(e){return $("body").append(i(e)),$("#floating-gifting-title").show()},removeFloatingTitle:function(){return $("#floating-gifting-title").remove()},updateViewAccordingToEvent:function(){return"2016-holidays"===this.event?$(this.personSelectionWrap).hide():void 0},enableNext:function(){return this.$el.find(".gifting-nav-link").removeClass("disabled"),this.navEnabled=!0},initializeMenu:function(){return this.hasPersonTags=ThisLife.Collection.personTags.length>0,this.personSelectionWrap.empty(),this.model.applyDefaultGifted(this.giftedPersonParam),this.recipeCheckboxWrap=this.$el.find(".gifting-recipe-selection"),this.renderPeopleSelection(),this.renderMomentSelection()},renderMotherSelection:function(){return this.personSelectionWrap.html(a(this.textsEngine.getInputPlaceholder(),1)),this.relationshipWrapEl=this.personSelectionWrap.find(".mother-relationship-dropdown .info.relationship"),this.nameWrapEl=this.personSelectionWrap.find(".mother-name"),this.autoCompleteWrapEl=this.personSelectionWrap.find(".auto-complete-person-wrapper"),this.grandmotherCheckbox=this.$el.find(".grandma-checkbox"),this.recipeCheckboxWrap=this.$el.find(".gifting-recipe-selection"),_.defer(function(e){return function(){return e.model.applyDefaultGifted(e.giftedPersonParam),null!=e.chosenRelationship&&"15"===e.chosenRelationship?e.selectRecipe(!1):void 0}}(this))},renderPeopleSelection:function(e){var t,i,n;return null==e&&(e=!0),this.peopleSelectionWrap.empty(),n=1,t=this.textsEngine.getPeopleSelectionTitle(),this.peopleSelectionWrap.html(u(t)),this.peopleThumbCont=this.peopleSelectionWrap.find(".people-thumb-container"),i=this.model.get("persons"),i.each(function(e){return function(t){var i;return i=new ThisLife.View.Gifting.PersonView({model:t}),e.peopleThumbCont.append(i.render().el)}}(this)),_.defer(function(t){return function(){return e?t.model.applyDefaultPersons(t.giftedPersonParam):void 0}}(this))},renderMomentSelection:function(e){var t,i,n,o,l,a,u,d,h,p,f,m,g;return null==e&&(e=!0),d=this.model.get("persons"),p=d.getSelectedOnly(),o=this.model.get("moments"),n=20,i=8,l=82,m=2,0===p.length?(u=this.isMobile?n:i,this.momentSelectionWrap.html(r(u,m)),this.cacheMomentSelectionElements(),this.isMobile&&(t=Math.round(n/2)*l,this.momentSelectionContainer.css("width",t),this.momentSelectionContainerOuter.css("overflow","hidden")),this.model.applyDefaultMoments(this.giftedPersonParam),o.deselectAllMoments()):(g=o.getVisibleOnly(),h=o.getSelectedOnly(),f=0===h.models.length?this.selectionTexts[1]:this.selectionTexts[0],this.momentSelectionWrap.html(s(g,m,f)),this.selectAllAction=$(this.momentSelectionWrap).find(".clear-all-moment-selection"),this.scrollingHeaders.html(c(g)),this.cacheMomentSelectionElements(),this.momentSelectionContainer.empty(),this.isMobile?(t=Math.round(g.models.length/2)*l,t<$(window).width()&&(t=$(window).width()-50),this.momentSelectionContainer.css("width",t)):this.momentSelectionContainer.css("width","100%"),a=[],this.momentSelectionContainer.fadeIn(200),_.each(g.models,function(e){return function(t){return t.isHidden()?void 0:a.push(e.loadAndRenderMoment(t))}}(this)),$.when.apply(null,a).done(function(t){return function(){return e&&t.noCacheOnInit&&t.shouldApplyMomentSelectionOnInit()?(t.noCacheOnInit=!1,_.defer(function(){return o.deselectAllMoments(),o.applyDefaults()})):void 0}}(this)))},shouldApplyMomentSelectionOnInit:function(){return"2016-holidays"===this.event?!0:!1},cacheMomentSelectionElements:function(){return this.momentSelectionContainerOuter=this.$(".moment-selection-container-outer"),this.momentSelectionContainer=this.$(".moment-selection-container")},loadAndRenderMoment:function(e){var t,i,n,o,s;return t=$.Deferred(),i=e.get("id"),(n=ThisLife.Collection.moments.get(i))?(o=n.getImageSize("x-small"),s=new Image,s.onload=function(i){return function(){var n;return n=new ThisLife.View.Gifting.MomentView({model:e}),i.momentSelectionContainer.append(n.render().el),_.defer(function(){return t.resolve()})}}(this),s.onerror=function(){return function(){return ThisLife.log.debug("Failed loading moment:",e.get("id")," | url:",o),t.resolve()}}(this),s.src=o,t.promise()):void ThisLife.log.debug("Moment does not exist in timeline:",e.get("id"))},toggleMomentSelection:function(){return 0===this.selectionState?(this.selectAllMoments(),this.setSelectedState(1)):(this.deselectAllMoments(),this.setSelectedState(0))},deselectAllMoments:function(){var e;return e=this.model.get("moments"),e.deselectAllMoments()},selectAllMoments:function(){var e;return e=this.model.get("moments"),e.selectAllMoments(!0)},setSelectedState:function(e){return this.selectionState=e,this.selectAllAction?this.selectAllAction.html(this.selectionTexts[1-e]):void 0},adjustSelectionText:function(){var e,t;return e=this.model.get("moments"),t=e.getSelectedOnly(!1),this.setSelectedState(0===t.length?0:1)},toggleMomentDebug:function(){return this.debug?this.momentSelectionContainerOuter.toggle():void 0},initializeDropdowns:function(){var e;return null!=(e=this.relationshipDD)&&e.teardown(),this.relationshipDD=new ThisLife.View.CustomSelect({id:"relationship_dropdown",defaultText:"She's my...",source:ThisLife.Collection.relationships.getFilteredCollection(this.relationshipsToInclude),selected:this.model.get("relationship_type_uid"),dontShowTitles:!0,useGroupDivider:!0,longText:!0,useTouch:this.isMobile}),this.relationshipWrapEl[0].querySelector(".dropdown").appendChild(this.relationshipDD.el),this.relationshipDD.selectItem(this.model.get("relationship_type_uid")),this.relationshipDD.on("selected",this.onRelationshipSelect,this)},editRelationship:function(){return this.blurRelationship=ThisLife.blurEvent(this.relationshipWrapEl,_.bind(this.closeEditRelationship,this))},closeEditRelationship:function(e){return null==e&&(e=!0),this.relationshipDD.isOpen()&&this.relationshipDD.close(e),this.blurRelationship?ThisLife.removeBlurEvent(this.blurRelationship):void 0},onRelationshipSelect:function(){var e,t,i;if(i=this.relationshipWrapEl.find(".text"),this.relationshipWrapEl.find(".text").addClass("selected"),t=i.text(),i.text("My "+t),e=$(this.grandmotherCheckbox).prop("checked"),"Grandmother"===t){if(this.grandmotherCheckbox.prop("checked",!0),!e)return this.grandmotherCheckbox.trigger("change")}else if(this.grandmotherCheckbox.prop("checked",!1),e)return this.grandmotherCheckbox.trigger("change")},shorthand:function(e){var t,i,n;return n=this,i=_.bind(this.processAutocomplete,this),t={source:ThisLife.Service.api.combineContacts().toJSON(),value:"name",parent:this.$(".name_dropdown-scroll-area"),num:4,show:function(){return n.$("#name_dropdown-gifting").show(),$.fn.shorthand.Constructor.prototype.show.call(this)},sorted:!1,hide:function(){return n.$("#name_dropdown-gifting").hide(),$.fn.shorthand.Constructor.prototype.hide.call(this)},template:d,menu:'<ul class="gifting_dropdown suggestions"></ul>',selectCallback:i,caseSensitive:!1,blurTimeout:300},e.shorthand(t)},setupAutocomplete:function(){var e;return e=this.el.querySelector("input.mother-name"),e.shorthand||this.shorthand($(e)),e},processAutocomplete:function(e){var t;return t=e.data().item,null==t.uid?(ThisLife.log.debug(" >> Problem with processAutocomplete()",e),void this.nameEl.blur()):this.selectGiftedPerson(t.uid)},selectGiftedPerson:function(t){var i,n;return this.giftedPerson=t,(n=ThisLife.Collection.personTags.get(t))?(i={face:n.getDefaultFaceUrl(),name:n.get("name")},this.autoCompleteWrapEl.html(e(i)),this.nameWrapEl.hide(),this.autoCompleteWrapEl.show(),this.model.addGiftedToPersons(this.giftedPerson)):void 0},getRelationshipForPerson:function(e,t){var i,n;return i=ThisLife.Collection.personTags.get(e),null!=i&&(n=i.get("relationship_type_uid"),this.chosenRelationship=-1!==_.indexOf(_.flatten(this.relationshipsToInclude),n)?i.get("relationship_type_uid"):null),"function"==typeof t?t():void 0},changePerson:function(e){var t;if("person-face"!==$(e.target)[0].className)return t=function(e){return function(){return e.nameWrapEl.val(""),e.nameWrapEl.show(),e.autoCompleteWrapEl.hide()}}(this),this.grandmotherCheckbox.prop("checked",!1).trigger("change"),this.model.removeGiftedFromPersons(this.giftedPerson,t),this.giftedPerson=null,this.selectMoments(),this.nameWrapEl.focus()},changeRecipe:function(e){var t;return t=$(e.target),t.hasClass("selected")?void 0:($(this.recipeCheckboxWrap).find(".gifting-recipe-selection-item").removeClass("selected"),t.addClass("selected"),this.magicshop.changeRecipe(t.attr("data-recipe")),this.renderMagicshop())},selectRecipe:function(e){return null!=this.recipeCheckboxWrap?($(this.recipeCheckboxWrap).find(".gifting-recipe-selection-item").removeClass("selected"),e?$(this.recipeCheckboxWrap).find(".gifting-recipe-selection-item-main").addClass("selected"):$(this.recipeCheckboxWrap).find(".gifting-recipe-selection-item-grand").addClass("selected")):void 0},changePage:function(e){return this.currPage=e,2===e?ThisLife.app.router.navigate(this.currentFragment+"/page2",{trigger:!1}):ThisLife.app.router.navigate(this.currentFragment,{trigger:!1})},navigateToSecondPage:function(){return this.navEnabled&&($(this.leftPane).hide(),$(this.rightPane).show(),this.changePage(2),this.renderMagicshop(),this.hideMG()),this},navigateToFirstPage:function(){return $(this.leftPane).show(),$(this.rightPane).hide(),this.changePage(1),this},navigateToLibrary:function(){return this.teardown()},removeURLParams:function(){var e;return e=this._getCurrentFragmentUrlWithoutQuery(),ThisLife.app.router.navigate(e,{trigger:!1})},hideMG:function(){return $(this.mgWrapper).css("opacity","0"),$(this.throbberWrapper).show()},showMG:function(){return $(this.mgWrapper).css("opacity","1"),$(this.throbberWrapper).hide(),this.isMobile?this.showGoToStore():void 0},mgCallback:function(e){return"finished_view_render"===e.action?this.showMG():void 0},getFilteredCollection:function(){return this.model.get("moments").getSelectedOnly()},createCollectionForMg:function(e){var t;return t=new Backbone.Collection,e.models.forEach(function(e){return t.add(e.get("model"))}),t},loadMagicshop:function(e){return this.magicshop=new ThisLife.View.MagicShopGifting({el:this.mgWrapper,fullView:!1,view:"homepage",prodType:"homepage",callback:_.bind(this.mgCallback,this),collection:this.createCollectionForMg(e),gifting:!0}),this.mgLoaded=!0,this.trigger("mg-loaded"),null!=this.chosenRelationship&&this.chosenRelationship===this.config.getGrandRelationship()?(this.magicshop.changeRecipe(this.config.getGrandRecipeName()),this.selectRecipe(!1)):this.magicshop.changeRecipe(this.config.getNormalRecipeName())},renderMagicshop:function(){return this.trackingEnabled=!0,_.defer(function(e){return function(){var t;return t=e.createCollectionForMg(e.getFilteredCollection()),e.mgLoaded?e.magicshop.renderWithMoments(t):e.on("mg-loaded",function(){return e.magicshop.renderWithMoments(t),e.off("mg-loaded")})}}(this))},teardown:function(e){return null==e&&(e=!0),!this.toredown&&(this.toredown=!0,this.unbindEvents(),$("body").removeClass("gifting"),this.$el.remove(),e&&ThisLife.app.router.navigateToLibrary(),this.useFloatingTitle)?this.removeFloatingTitle():void 0},_navigateIfNeeded:function(){return this.needRedirectToPage2?(this.navigateToSecondPage(),this.needRedirectToPage2=!1):void 0},_browserSupported:function(){return!(bowser.msie&&parseFloat(bowser.version)<=10)},_checkBrowser:function(){return this._browserSupported()?void 0:this._redirectToStore()},_redirectToStore:function(){return window.location=this.config.getStorePageURL()||ThisLife.Settings.sflyApp+"/store"},goToStore:function(){return window.location=this.config.getStorePageURL()||ThisLife.Settings.sflyApp+"/store"},showGoToStore:function(){return $(this.rightPane).find(".right-pane-go-to-store").show()},_getCurrentFragmentUrl:function(){var e;return e=ThisLife.app.router.fragment().split("/"),[e[0],e[1]].join("/")},_getCurrentFragmentUrlWithoutQuery:function(){var e;return e=ThisLife.app.router.fragment().split("?"),e[0]},_elementIsVisible:function(e){var t;return"function"==typeof jQuery&&e instanceof jQuery&&(e=e[0]),"undefined"!=typeof e?(t=e.getBoundingClientRect(),t.top>=0&&t.left>=0&&t.bottom<=$(window).height()&&t.right<=$(window).width()):void 0},_scrollIntoView:function(e,t){var i,n,o;return null==t&&(t=0),i=26,n=10,o=$(e).offset().top-n-(t-1)*i,$("html, body").animate({scrollTop:o})},_resetScroll:function(){return $(document).scrollTop(0)}}),t=function(e,t,i,o,s,r){var a,u;return u=o?"mobile":"",a=""===e?"hide-title":"",'<div class="main-gifting-title">\n  <h2 class="'+a+'">'+e+'</h2>\n  <div class="main-gifting-title-back-btn back_btn">Back to Timeline</div>\n</div>\n<div class="gifting-wrapper">\n  <div class="left-pane gifting-pane">\n    <div class=\'left-pane-mobile-nav gifting-mobile-nav '+a+"'>\n      <!-- span class='gifting-nav-link disabled'>Next</span-->\n      <h2 class=\""+a+'">'+e+'</h2>\n    </div>\n    <div class="left-pane-menu-wrapper">\n        <div class="person-selection-wrapper">'+l(s)+'</div>\n        <div class="people-selection-wrapper"></div>\n        <div class="moment-selection-wrapper"></div>\n    </div>\n\n  </div>\n  <div class="right-pane gifting-pane '+u+'">\n    '+n(t,i,r)+'\n    <h4 class="right-pane-title gifting-header-item '+a+"\">\n      Here are our best suggestions:\n    </h4>\n    <!-- div class='right-pane-mobile-nav gifting-mobile-nav'>\n      <div class='gifting-prev gifting-header-link'><div class=\"back_btn\"></div></div>\n      <h2>"+e+'</h2>\n    </div -->\n    <div class="right-pane-mg-wrapper">\n      <div class="throbber-wrapper">\n        <div class="loading"><div class="throbber throbber_large"><div class="throbber_overlay"></div></div></div>\n      </div>\n      <div class="mg-wrapper"></div>\n    </div>\n    <div class="right-pane-go-to-store">\n      If you haven\'t found what you\'re looking for\n      <div class="go-to-store-btn orange-btn">GO TO STORE</div>\n    </div>\n  </div>\n</div>\n<div class="scrolling-headers-wrapper"></div>'},i=function(e){return'<div id="floating-gifting-title">\n  <h2>'+e+"</h2>\n</div>"},l=function(e){return'<div class="people-selection-wrapper gifting-mock-people-section">\n  <h4>'+e+':</h4>\n  <div class="people-thumb-container">\n    <div class="gifting-person gifting-mock-person"><div class="gifting-person-thumb-wrapper gifting-mock-circle"></div></div>\n    <div class="gifting-person gifting-mock-person"><div class="gifting-person-thumb-wrapper gifting-mock-circle"></div></div>\n    <div class="gifting-person gifting-mock-person"><div class="gifting-person-thumb-wrapper gifting-mock-circle"></div></div>\n    <div class="gifting-person gifting-mock-person"><div class="gifting-person-thumb-wrapper gifting-mock-circle"></div></div>\n    <div class="gifting-person gifting-mock-person"><div class="gifting-person-thumb-wrapper gifting-mock-circle"></div></div>\n    <div class="gifting-person gifting-mock-person"><div class="gifting-person-thumb-wrapper gifting-mock-circle"></div></div>\n    <!--div class="gifting-person gifting-mock-person"><div class="gifting-person-thumb-wrapper gifting-mock-circle"></div></div-->\n  </div>\n</div>\n<div class="moment-selection-wrapper gifting-mock-moment-section">\n    <h4 class="gifting-header-item">\n        We found 0 photos:\n    </h4>\n    <div class="moment-selection-container-outer">\n        <div class="moment-selection-container gifting-mock-moment-section" style="width: 100%;">\n            '+o()+"\n        </div>\n    </div>\n</div>"},o=function(e){var t,i,n,o;for(null==e&&(e=8),o="",t=i=1,n=e;n>=1?n>=i:i>=n;t=n>=1?++i:--i)o+='<div class="gifting-moment">\n    <div class="gifting-moment-thumb-wrapper">\n    </div>\n</div>';return o},a=function(e,t){return'<h4 class="gifting-header-item">'+t+'. Who is this gift for:</h4>\n<!-- div class="mothers-dropdwon"></div-->\n<input type="text" class="mother-name" placeholder="'+e+'"/>\n<div class="name_dropdown dropdown" id="name_dropdown-gifting">\n  <div class="name_dropdown-scroll-area"></div>\n</div>\n<div class="auto-complete-person-wrapper" style="display:none"></div>\n<!--div class="mother-relationship-dropdown">\n  <div class="row">\n      <div class="info relationship editable">\n        <span class="dropdown gifting"></span>\n      </div>\n  </div>\n</div-->'
},u=function(e){return'<h4 class="gifting-header-item">'+e+':</h4>\n<div class="people-thumb-container"></div>'},d='<% var face = default_face_url || "/assets/people/defaultPerson.png" %>\n<% var email = email || null %>\n<% var uid = uid || null %>\n\n<li class="item" data-facebook-uid="<%= facebook_uid %>" data-uid ="<%= uid %>" data-email="<%= email %>">\n  <div class="item-wrapper">\n    <img src="<%= face %>" class="avatar">\n    <a class="name"></a>\n  </div>\n</li>',s=function(e,t,i){var n,o;return n=e.length,o=1===n?"":"s",'<h4 class="gifting-header-item">\n  We found '+n+" photo"+o+':\n</h4>\n<div class="clear-all clear-all-moment-selection">\n  '+i+'\n</div>\n<div class="moment-selection-container-outer">\n  <div class="moment-selection-container"></div>\n</div>'},r=function(e){var t,i,n,o;for(null==e&&(e=8),o='<h4>\n  We found 0 photos:\n</h4>\n<div class="moment-selection-container-outer">\n  <div class="empty-moment-selection-msg">Please select people to see their photos</div>\n  <div class="moment-selection-container">',t=i=1,n=e;n>=1?n>=i:i>=n;t=n>=1?++i:--i)o+="<div class='gifting-moment empty'></div>";return o+="  </div>\n</div>"},e=function(e){return'<div class="auto-complete-person">\n  <div class="person-face" style=\'background-image: url('+e.face+')\'></div>\n  <h3 class="person-name">'+e.name+"</h3>\n</div>"},n=function(e,t,i){var n,o,s,r,l,a,u;for(null==i&&(i=!0),u=i?"auto":Math.floor(100/t.length)+"%",r='<h4 class="right-pane-title gifting-header-item gifting-recipe-selection-title"> 3. What\'s the occasion?</h4>\n<div class="gifting-recipe-selection-wrapper">\n  <div class="gifting-recipe-selection">',n=o=0,s=t.length-1;s>=0?s>=o:o>=s;n=s>=0?++o:--o)l=0===n?"selected":"",a=0===n?"left":n===t.length-1?"right":"",r+='<div class="gifting-recipe-selection-item gifting-recipe-selection-item-main '+l+" "+a+'" style="width: '+u+'" data-recipe="'+t[n]+'">'+e[n]+"</div>";return r+="  </div>\n</div>"},c=function(){return'<div class="gifting-back-to-top-wrapper">\n  <div class="gifting-back-to-top">\n    Back to top<span class="gifting-back-to-top-arrow"></span>\n  </div>\n</div>'},ThisLife.PubSub.on("showGifting",function(e){var t;return t=new ThisLife.View.GiftingView(e),$("body").append(t.render().el)})}.call(this),function(){var e;ThisLife.View.Gifting=ThisLife.View.Gifting||{},ThisLife.View.Gifting.PersonView=Backbone.View.extend({className:"gifting-person",model:ThisLife.Model.Gifting.Person,events:{"click .gifting-person-thumb-wrapper":"toggleSelection"},initialize:function(e){return null==e&&(e={}),this.model.on("change:isSelected",this.render,this)},render:function(){var t;return t={faceUrl:this.model.getFaceUrl(),isSelected:this.model.get("isSelected")},this.$el.html(e(t)),this},toggleSelection:function(){return this.model.toggleSelection()}}),e=function(e){var t,i,n;return t=e.faceUrl||"",i=e.isSelected,n=i?"selected":"",'<div class="gifting-person-thumb-wrapper '+n+'">\n  <div class="gifting-person-thumb" style="background-image: url('+t+')"></div>\n  <div class="gifting-person-checkcircle checkcircle"><div class="tick"></div></div>\n</div>'}}.call(this),function(){var e;ThisLife.View.Gifting=ThisLife.View.Gifting||{},ThisLife.View.Gifting.MomentView=Backbone.View.extend({className:"gifting-moment",model:ThisLife.Model.Gifting.Moment,events:{"click .gifting-moment-thumb-wrapper":"toggleSelection"},initialize:function(e){return null==e&&(e={}),this.model.on("change:isSelected",this.render,this)},render:function(){var t,i,n,o;return o=this.model.get("id"),t=ThisLife.Collection.moments.get(o),i=t.getImageSize("x-small"),n={momentUrl:i,isSelected:this.model.get("isSelected")},this.$el.html(e(n)),this},toggleSelection:function(){return this.model.toggleSelection()}}),e=function(e){var t,i;return t=e.momentUrl||"",i=e.isSelected?"selected":"",'<div class="gifting-moment-thumb-wrapper '+i+'">\n  <div class="gifting-moment-thumb-overlay"></div>\n  <div class="gifting-moment-thumb" style="background-image: url('+t+')"></div>\n  <div class="gifting-moment-checkcircle checkcircle"><div class="tick"></div></div>\n</div>'}}.call(this),function(){var e,t,i=function(e,t){function i(){this.constructor=e}for(var o in t)n.call(t,o)&&(e[o]=t[o]);return i.prototype=t.prototype,e.prototype=new i,e.__super__=t.prototype,e},n={}.hasOwnProperty;t=function(){function e(e){this.event=e}return e.prototype.getMainTitle=function(){throw"Need to implement getMainTitle"},e.prototype.getProductTypeToggleTexts=function(){throw"Need to implement getProductTypeToggleTexts"},e.prototype.getInputPlaceholder=function(){throw"Need to implement getInputPlaceholder"},e.prototype.getPeopleSelectionTitle=function(){throw"Need to implement getPeopleSelectionTitle"},e}(),e=function(e){function t(e){this.event=e,this.loadTextsEngine()}return i(t,e),t.prototype.loadTextsEngine=function(){return this.engine=this.getTextsHelper()},t.prototype.getTextsHelper=function(){switch(this.event){case"2017-mothers-day":return new ThisLife.View.Gifting.Helpers.Texts.MothersDayTexts;case"2016-fathers-day":return new ThisLife.View.Gifting.Helpers.Texts.FathersDayTexts;case"2016-holidays":return new ThisLife.View.Gifting.Helpers.Texts.CardsTexts}},t.prototype.getMainTitle=function(){return this.engine.getMainTitle()},t.prototype.getProductTypeToggleTexts=function(){return this.engine.getProductTypeToggleTexts()},t.prototype.getInputPlaceholder=function(){return this.engine.getInputPlaceholder()},t.prototype.getPeopleSelectionTitle=function(){return this.engine.getPeopleSelectionTitle()},t}(t),ThisLife.View.Gifting=ThisLife.View.Gifting||{},ThisLife.View.Gifting.Helpers=ThisLife.View.Gifting.Helpers||{},ThisLife.View.Gifting.Helpers.Texts=ThisLife.View.Gifting.Helpers.Texts||{},ThisLife.View.Gifting.Helpers.Texts.TextsInterface=t,ThisLife.View.Gifting.Helpers.Texts.GiftingTexts=e}.call(this),function(){var e,t=function(e,t){function n(){this.constructor=e}for(var o in t)i.call(t,o)&&(e[o]=t[o]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e},i={}.hasOwnProperty;e=function(e){function i(){return i.__super__.constructor.apply(this,arguments)}return t(i,e),i.prototype.getMainTitle=function(){return"Father's Day gifts"},i.prototype.getProductTypeToggleTexts=function(){return["Father's Gifts","Grandfather's Gifts"]},i.prototype.getInputPlaceholder=function(){return"Type his name"},i}(ThisLife.View.Gifting.Helpers.Texts.TextsInterface),ThisLife.View.Gifting=ThisLife.View.Gifting||{},ThisLife.View.Gifting.Helpers=ThisLife.View.Gifting.Helpers||{},ThisLife.View.Gifting.Helpers.Texts=ThisLife.View.Gifting.Helpers.Texts||{},ThisLife.View.Gifting.Helpers.Texts.FathersDayTexts=e}.call(this),function(){}.call(this),function(){var e,t=function(e,t){function n(){this.constructor=e}for(var o in t)i.call(t,o)&&(e[o]=t[o]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e},i={}.hasOwnProperty;e=function(e){function i(){return i.__super__.constructor.apply(this,arguments)}return t(i,e),i.prototype.getMainTitle=function(){return"JUST FOR MOM"},i.prototype.getProductTypeToggleTexts=function(){return["Mother's Gifts","Grandmother's Gifts"]},i.prototype.getInputPlaceholder=function(){return"Type her name"},i.prototype.getPeopleSelectionTitle=function(){return"WHO SHOULD BE ON THE GIFT"},i}(ThisLife.View.Gifting.Helpers.Texts.TextsInterface),ThisLife.View.Gifting=ThisLife.View.Gifting||{},ThisLife.View.Gifting.Helpers=ThisLife.View.Gifting.Helpers||{},ThisLife.View.Gifting.Helpers.Texts=ThisLife.View.Gifting.Helpers.Texts||{},ThisLife.View.Gifting.Helpers.Texts.MothersDayTexts=e}.call(this),function(){var e,t=function(e,t){function n(){this.constructor=e}for(var o in t)i.call(t,o)&&(e[o]=t[o]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e},i={}.hasOwnProperty;e=function(e){function i(){return i.__super__.constructor.apply(this,arguments)}return t(i,e),i.prototype.getMainTitle=function(){return"Holiday Cards"},i.prototype.getProductTypeToggleTexts=function(){return["HOLIDAY","CHRISTMAS","HANUKKAH"]},i.prototype.getInputPlaceholder=function(){return"Type a name"},i}(ThisLife.View.Gifting.Helpers.Texts.TextsInterface),ThisLife.View.Gifting=ThisLife.View.Gifting||{},ThisLife.View.Gifting.Helpers=ThisLife.View.Gifting.Helpers||{},ThisLife.View.Gifting.Helpers.Texts=ThisLife.View.Gifting.Helpers.Texts||{},ThisLife.View.Gifting.Helpers.Texts.CardsTexts=e}.call(this),function(){var e,t,i=function(e,t){function i(){this.constructor=e}for(var o in t)n.call(t,o)&&(e[o]=t[o]);return i.prototype=t.prototype,e.prototype=new i,e.__super__=t.prototype,e},n={}.hasOwnProperty;e=function(){function e(e){this.event=e}return e.prototype.getRelationships=function(){throw"Need to implement getRelationships"},e.prototype.getNormalRecipeName=function(){throw"Need to implement getNormalRecipeName"},e.prototype.getGrandRecipeName=function(){throw"Need to implement getGrandRecipeName"},e.prototype.getRecipes=function(){throw"Need to implement getRecipes"},e.prototype.getTargetProductNameTitle=function(){throw"Need to implement getTargetProductName"},e}(),t=function(e){function t(e){this.event=e,this.loadConfigEngine()}return i(t,e),t.prototype.loadConfigEngine=function(){return this.engine=this.getConfigHelper()},t.prototype.getConfigHelper=function(){switch(this.event){case"2017-mothers-day":return new ThisLife.View.Gifting.Helpers.Config.MothersDayConfig;case"2016-fathers-day":return new ThisLife.View.Gifting.Helpers.Config.FathersDayConfig;case"2016-holidays":return new ThisLife.View.Gifting.Helpers.Config.CardsConfig}},t.prototype.getRelationships=function(){return this.engine.getRelationships()},t.prototype.getGrandRelationship=function(){return this.engine.getGrandRelationship()},t.prototype.getNormalRecipeName=function(){return this.engine.getNormalRecipeName()},t.prototype.getGrandRecipeName=function(){return this.engine.getGrandRecipeName()},t.prototype.getRecipes=function(){return this.engine.getRecipes()},t.prototype.getTargetProductNameTitle=function(){return this.engine.getTargetProductNameTitle()},t.prototype.getStorePageURL=function(){return this.engine.getStorePageURL()},t}(e),ThisLife.View.Gifting=ThisLife.View.Gifting||{},ThisLife.View.Gifting.Helpers=ThisLife.View.Gifting.Helpers||{},ThisLife.View.Gifting.Helpers.Config=ThisLife.View.Gifting.Helpers.Config||{},ThisLife.View.Gifting.Helpers.Config.ConfigInterface=e,ThisLife.View.Gifting.Helpers.Config.GiftingConfig=t}.call(this),function(){var e,t=function(e,t){function n(){this.constructor=e}for(var o in t)i.call(t,o)&&(e[o]=t[o]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e},i={}.hasOwnProperty;e=function(e){function i(){return i.__super__.constructor.apply(this,arguments)}return t(i,e),i.prototype.getRelationships=function(){return[["02","04","15","19","25"],["08","21","27","23","29","10","12","32"]]},i.prototype.getGrandRelationship=function(){return"15"},i.prototype.getNormalRecipeName=function(){return"gifting_father"},i.prototype.getGrandRecipeName=function(){return"gifting_grandpa"},i.prototype.getRecipes=function(){return["gifting_father","gifting_grandpa"]},i.prototype.getStorePageURL=function(){return ThisLife.Settings.sflyApp+"/fathers-day-gift-ideas"},i.prototype.getTargetProductNameTitle=function(){return"the gift"},i}(ThisLife.View.Gifting.Helpers.Config.ConfigInterface),ThisLife.View.Gifting=ThisLife.View.Gifting||{},ThisLife.View.Gifting.Helpers=ThisLife.View.Gifting.Helpers||{},ThisLife.View.Gifting.Helpers.Config=ThisLife.View.Gifting.Helpers.Config||{},ThisLife.View.Gifting.Helpers.Config.FathersDayConfig=e}.call(this),function(){}.call(this),function(){var e,t=function(e,t){function n(){this.constructor=e}for(var o in t)i.call(t,o)&&(e[o]=t[o]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e},i={}.hasOwnProperty;e=function(e){function i(){return i.__super__.constructor.apply(this,arguments)}return t(i,e),i.prototype.getRelationships=function(){return[["02","04","15","19","25"],["08","21","27","23","29","10","12","32"]]},i.prototype.getGrandRelationship=function(){return"15"},i.prototype.getNormalRecipeName=function(){return"gifting"},i.prototype.getGrandRecipeName=function(){return"gifting_gm"},i.prototype.getRecipes=function(){return["gifting","gifting_gm"]},i.prototype.getStorePageURL=function(){return ThisLife.Settings.sflyApp+"/store"},i.prototype.getTargetProductNameTitle=function(){return"the gift"},i}(ThisLife.View.Gifting.Helpers.Config.ConfigInterface),ThisLife.View.Gifting=ThisLife.View.Gifting||{},ThisLife.View.Gifting.Helpers=ThisLife.View.Gifting.Helpers||{},ThisLife.View.Gifting.Helpers.Config=ThisLife.View.Gifting.Helpers.Config||{},ThisLife.View.Gifting.Helpers.Config.MothersDayConfig=e}.call(this),function(){var e,t=function(e,t){function n(){this.constructor=e}for(var o in t)i.call(t,o)&&(e[o]=t[o]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e},i={}.hasOwnProperty;e=function(e){function i(){return i.__super__.constructor.apply(this,arguments)}return t(i,e),i.prototype.getRelationships=function(){return[["02","04","15","19","25"],["08","21","27","23","29","10","12","32"]]},i.prototype.getGrandRelationship=function(){return"15"},i.prototype.getNormalRecipeName=function(){return"gifting_holiday"},i.prototype.getGrandRecipeName=function(){return"gifting_christmas"},i.prototype.getRecipes=function(){return["gifting_holiday","gifting_christmas","gifting_hanukkah"]},i.prototype.getStorePageURL=function(){return ThisLife.Settings.sflyApp+"/cards-stationery/holiday-cards"},i.prototype.getTargetProductNameTitle=function(){return"your card"},i}(ThisLife.View.Gifting.Helpers.Config.ConfigInterface),ThisLife.View.Gifting=ThisLife.View.Gifting||{},ThisLife.View.Gifting.Helpers=ThisLife.View.Gifting.Helpers||{},ThisLife.View.Gifting.Helpers.Config=ThisLife.View.Gifting.Helpers.Config||{},ThisLife.View.Gifting.Helpers.Config.CardsConfig=e}.call(this),function(){define("ThisLife.Progress.Views.Progress",[],function(){var e;return e=Backbone.View.extend({className:"new_popover_wrap bottom_toast progress_popover",initialize:function(e){return this.options=null!=e?e:{},this.render()},render:function(){return this.rendered?void 0:(this.$el.html(this.template()),document.body.appendChild(this.el),this.rendered=!0)},remove:function(){return this.rendered=!1,Backbone.View.prototype.remove.apply(this)},template:function(){return'<div class="progress_popover_wrap">\n  <!-- main body content -->\n  <div class="spinner_wrapper">\n    <div class="circular_spinner orange_small"></div>\n  </div>\n  <div class="message">\n    <div>\n      <h4 id="progress-text">'+this.progressText+"</h4>\n    </div>\n  </div>\n</div>"}})})}.call(this),function(){define("ThisLife.ImportProgress.Controllers.ImportProgress",["ThisLife.ImportProgress.Views.ImportProgress"],function(e){var t;return t=function(){function t(){}return _.extend(t.prototype,Backbone.Events),t.prototype.removeView=function(){var e;return null!=(e=this.view)&&e.remove(),this.view=void 0},t.prototype.getView=function(t){return this.view=new e(t)},t.prototype.removeServiceText=function(e){return this.view.removeServiceText(e)},t.prototype.addServiceText=function(e){return this.view.addServiceText(e)},t}()})}.call(this),function(){define("ThisLife.ImportProgress.Views.ImportProgress",["ThisLife.Progress.Views.Progress"],function(e){var t;return t=e.extend({className:"new_popover_wrap bottom_toast progress_popover import_progress",initialize:function(e){return this.options=null!=e?e:{},this.progressText="Importing from "+this.options.service+"...",this.render(),this.progressTextEl=this.el.querySelector("#progress-text")},addServiceText:function(e){return this.progressText=this.progressText.replace("..."," "+e+"..."),this.updateProgressText()},removeServiceText:function(e){return this.progressText=this.progressText.replace(e,""),this.updateProgressText()},updateProgressText:function(){return this.progressTextEl.innerHTML=this.progressText}})})}.call(this),function(){define("ThisLife.LifeTouch.Views.WelcomeOverlay",[],function(){var e;return e=Backbone.View.extend({className:"lifetouch-welcome-overlay",events:{"click .got-it-btn":"_close"},initialize:function(e){return null==e&&(e={}),this.render(),this},render:function(){return this.el.insertAdjacentHTML("beforeend",this._getTemplate()),this},_close:function(){return this.remove(),ThisLife.app.controller("onboarding").setLifeFeatureFlow("lifetouch")},_getTemplate:function(){return'<div class="lifetouch-welcome-modal">\n  <h4 class="title">Welcome to Shutterfly Photos</h4>\n  <p class="text">Now it\u2019s easier than ever to hold on to the moments you love and do more with them.</p>\n  <p class="text">Shutterfly Photos gives you a safe place for your memories. With unlimited free storage, all your photos are available in one place, quick to find and accessible from any device.</p>\n  <div class="footer">\n    <div class="got-it-btn">GOT IT</div>\n  </div>\n</div>'}})})}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}};define("ThisLife.Migration.Controllers.MigrationHandler",["ThisLife.Migration.Views.MigrationProgress"],function(t){var i;return i=function(){function i(){this.pollErrorHandler=e(this.pollErrorHandler,this),this.pollSuccessHandler=e(this.pollSuccessHandler,this),this.pollGetPersonInfo=e(this.pollGetPersonInfo,this),this.isMigrating=!0,this.view=new t,this.pollGetPersonInfo()}return _.extend(i.prototype,Backbone.Events),i.prototype.pollGetPersonInfo=function(){ThisLife.log.debug("%c Poll person info for migration status ","background-color: yellow; color:red;"),ThisLife.Service.api.getPersonInfo(this.pollSuccessHandler,this.pollErrorHandler,!0)},i.prototype.pollSuccessHandler=function(e){var t,i;ThisLife.log.debug("%c Success: Polling person info! ","background-color:blue; color:white;"),i=null,t=e.get("migration_status"),"sfly"===t||"sfly_migrated"===t||"tl_migrated"===t?(ThisLife.log.debug("%c Migrated ","background-color:green; color:white;"),ThisLife.Model.User.set("migration_status",t),this.view.remove(),this.isMigrating=!1,"migrationAlbums"===ThisLife.app.currentState.name&&ThisLife.app.controller("albums_migration").tearDownMigrationView()):(ThisLife.log.debug("%c Not Migrated ","background-color:red; color:white;"),i=setTimeout(this.pollGetPersonInfo,1e3*ThisLife.Settings.pollPersonInfoInterval))},i.prototype.pollErrorHandler=function(){return ThisLife.log.debug("%c Error: Polling person info! ","background-color: black; color:red;")},i}()})}.call(this),function(){define("ThisLife.Migration.Controllers.MigrationAlbumsController",["ThisLife.Migration.View.MigrationAlbumsView"],function(e){var t;return t=function(){function t(){this.view=new e}return _.extend(t.prototype,Backbone.Events),t.prototype.showMigrationView=function(){return this._setState(),this.view.render()},t.prototype.tearDownMigrationView=function(){return this.view.remove(),"migrationAlbums"===ThisLife.app.currentState.name?Backbone.history.loadUrl("albums"):void 0},t.prototype._setState=function(){var e;return e="migrationAlbums",ThisLife.app.setState(e)},t}()})}.call(this),function(){define("ThisLife.Migration.Views.MigrationProgress",["ThisLife.Progress.Views.Progress"],function(e){var t;return t=e.extend({initialize:function(e){return this.options=null!=e?e:{},this.progressText="Preparing a new photos experience...",this.render()}})})}.call(this),function(){define("ThisLife.Migration.View.MigrationAlbumsView",[],function(){var e;return e=Backbone.View.extend({render:function(){return this.$el=$(this.template()),$("#demo").append(this.$el)},template:function(){return"<div id='migration_albums'>\n  <div class='migration_albums_view'>\n    <div class='spinner_container'>\n      <div class=\"spinner_wrapper\">\n        <div class=\"circular_spinner orange_xlarge\"></div>\n      </div>\n      <p>Updating your photos...</p>\n    </div>\n  </div>\n</div>"}})})}.call(this),function(){define("ThisLife.AppModal.Controllers.AppModal",["ThisLife.AppModal.Controllers.Factory"],function(e){var t;return t=function(){function t(){this.modalList={}}return _.extend(t.prototype,Backbone.Events),t.prototype.get=function(t){return null!=this.modalList[t]?this.modalList[t]:(this.modalList[t]=new e,this.modalList[t])},t.prototype.destroy=function(e){return null!=this.modalList[e]?(this.modalList[e].removeView(),delete this.modalList[e]):void 0},t.prototype.list=function(){return this.modalList},t}()})}.call(this),function(){define("ThisLife.AppModal.Controllers.Factory",["ThisLife.AppModal.Views.AppModal","ThisLife.AppModal.Views.AppModalSidebar"],function(e,t){var i;return i=function(){function i(){this.options={}}return _.extend(i.prototype,Backbone.Events),i.prototype.renderView=function(i){return this.removeView(),i&&"object"==typeof i&&_.extend(this.options,i),this.options.sidebarView?(this._view=new t(this.options),this.options.sidebarView.parentController=this):this._view=new e(this.options),this._view.controller=this,this.options.childView.parentController=this,this},i.prototype.removeView=function(){var e,t;return null!=(e=this._view)&&e._unbindEvents(),null!=(t=this._view)&&t.remove(),delete this._view,this},i.prototype.updateButtonSubText=function(e,t){return e&&t&&this._view.updateButtonSubText(e,t),this},i.prototype.updateButtonText=function(e,t){return e&&t&&this._view.updateButtonText(e,t),this},i.prototype.hideButton=function(e){return e?this._view.hideButton(e):void 0},i.prototype.showButton=function(e){return e?this._view.showButton(e):void 0},i.prototype.disableButton=function(e){return this._view.disableButton(e),this},i.prototype.enableButton=function(e){return this._view.enableButton(e),this},i}()})}.call(this),function(){define("ThisLife.AppModal.Views.AppModal",[],function(){var e,t;return e=Backbone.View.extend({className:"popover_wrap new_popover_wrap tl_modal_wrap_visible",events:{"click .close-modal":"removeModal"},initialize:function(e){return this.options=e,this.render(),this._bindEvents(),this},_bindEvents:function(){var e,t,i,n,o,s;if(ThisLife.Support.keyInformant.on("cancel",this.removeModal,this),null!=(o=this.options)?o.buttons:void 0){for(s=this.options.buttons,i=0,n=s.length;n>i;i++)e=s[i],t=this.el.querySelector("."+e.type),t.addEventListener("click",e.onclick,!1);return this}},_unbindEvents:function(){var e,t,i,n,o,s;if(ThisLife.Support.keyInformant.off("cancel",this.removeModal,this),null!=(o=this.options)?o.buttons:void 0){for(s=this.options.buttons,i=0,n=s.length;n>i;i++)e=s[i],t=this.el.querySelector("."+e.type),t.removeEventListener("click",e.onclick);return this}},cacheElements:function(){return this.appModalWrap=this.el.querySelector(".app_modal_wrap"),this.middleSection=this.el.querySelector(".middle_section"),this.bottomSection=this.el.querySelector(".bottom_section"),this},render:function(){return ThisLife.app.controller("timeline").disableScroll(),this.el.insertAdjacentHTML("beforeend",this.template()),this.cacheElements(),this.options.childView&&this.middleSection.appendChild(this.options.childView.el),this.options.leftButtonView&&this.bottomSection.appendChild(this.options.leftButtonView.el),document.body.appendChild(this.el),this.options.fullPagePoint&&("smallScreen"===this.options.fullPagePoint?this.appModalWrap.classList.add("small_screen"):"mediumScreen"===this.options.fullPagePoint?this.appModalWrap.classList.add("medium_screen"):"largeScreen"===this.options.fullPagePoint&&this.appModalWrap.classList.add("large_screen")),this},remove:function(){var e,t;return null!=(e=this.options.childView)&&e.remove(),null!=(t=this.options.leftButtonView)&&t.remove(),Backbone.View.prototype.remove.apply(this),ThisLife.app.controller("timeline").enableScroll()},removeModal:function(e){var t,i;return(null!=(t=this.options)?t.onClose:void 0)?this.options.onClose(e):this.controller.removeView(),null!=(i=this.options)&&"function"==typeof i.onRemove?i.onRemove():void 0},updateButtonSubText:function(e,t){return e&&t?this.el.querySelector("."+e+" .sub_text").textContent=t:void 0},enableButton:function(e){var t;return e?(t=this.el.querySelector("."+e),t.classList.remove("disabled")):void 0},disableButton:function(e){var t;return e?(t=this.el.querySelector("."+e),t.classList.add("disabled")):void 0},hideButton:function(e){var t;return e?(t=this.el.querySelector("."+e),$(t).hide()):void 0},showButton:function(e){var t;return e?(t=this.el.querySelector("."+e),$(t).show()):void 0},updateButtonText:function(e,t){var i,n;return e&&t?(i=this.el.querySelector("."+e),n=i.querySelector(".sub_text"),i.textContent=t,i.append(n)):void 0},template:function(){var e,i,n,o,s,r;return e=this.options.backButton?'<a href="javascript:;" class="back_button close-modal">'+this.options.backButton+"</a>":"",i=this.options.disableClose?"":'<a class="close-modal" href="javascript:;"><span class="close-btn"></span></a>',n=this.options.modalClass?this.options.modalClass:"",s=this.options.width?"width: "+this.options.width+"px;":"",o=this.options.height?"height: "+this.options.height+"px;":"",'<div class="app_modal_wrap">\n  <div class="app_modal '+n+'" style="'+s+" "+o+'">\n    '+i+'\n    <div class="top_section">\n      <div class="title">'+this.options.title+'</div>\n    </div>\n    <div class="middle_section"></div>\n    <div class="bottom_section">\n      '+((null!=(r=this.options.buttons)?r.length:void 0)>0?t(this.options.buttons):void 0)+"\n      "+e+"\n    </div>\n  </div>\n</div>"}}),t=function(e){var t,i,n,o,s;for(o="",i=0,n=e.length;n>i;i++)t=e[i],s=t.noSubtext?"":'<span class="count sub_text">'+(void 0===t.subtext?"":t.subtext)+"</span>",o+='<a href="javascript:;" class="'+t.type+'">'+t.text+"\n  "+s+"\n  \n</a>";return o},e})}.call(this),function(){var e=function(e,i){function n(){this.constructor=e}for(var o in i)t.call(i,o)&&(e[o]=i[o]);return n.prototype=i.prototype,e.prototype=new n,e.__super__=i.prototype,e},t={}.hasOwnProperty;define("ThisLife.AppModal.Views.AppModalSidebar",["ThisLife.AppModal.Views.AppModal"],function(t){var i,n;return i=function(t){function i(){return i.__super__.constructor.apply(this,arguments)}return e(i,t),i.prototype.className="app_modal_sidebar popover_wrap new_popover_wrap tl_modal_wrap_visible",i.prototype.events={"click .close-modal":"removeModal"},i.prototype.initialize=function(e){return i.__super__.initialize.call(this,e),this},i.prototype.cacheElements=function(){return this.appModalWrap=this.el.querySelector(".app_modal_wrap"),this.middleSection=this.el.querySelector(".middle_section"),this.sidebarSection=this.el.querySelector(".sidebar_section"),this},i.prototype.render=function(){var e;return null!=(e=ThisLife.app.controller("timeline"))&&e.disableScroll(),this.el.insertAdjacentHTML("beforeend",this.template()),this.cacheElements(),this.options.childView&&(_.isArray(this.options.childView)?this.options.childView.forEach(function(e){return function(t){return e.middleSection.appendChild(t.el)}}(this)):this.middleSection.appendChild(this.options.childView.el)),this.options.sidebarView&&this.sidebarSection.appendChild(this.options.sidebarView.el),document.body.appendChild(this.el),this.options.fullPagePoint&&("smallScreen"===this.options.fullPagePoint?this.appModalWrap.classList.add("small_screen"):"mediumScreen"===this.options.fullPagePoint?this.appModalWrap.classList.add("medium_screen"):"largeScreen"===this.options.fullPagePoint&&this.appModalWrap.classList.add("large_screen")),this},i.prototype.remove=function(){var e,t,i;return _.isArray(this.options.childView)?this.options.childView.forEach(function(){return function(e){return e.remove()}}(this)):null!=(e=this.options.childView)&&e.remove(),null!=(t=this.options.sidebarView)&&t.remove(),Backbone.View.prototype.remove.apply(this),null!=(i=ThisLife.app.controller("timeline"))?i.enableScroll():void 0},i.prototype.template=function(){var e,t,i,o,s,r;return e=this.options.backButton?'<a href="javascript:;" class="back_button close-modal">'+this.options.backButton+"</a>":"",t=this.options.disableClose?"":'<a class="close-modal" href="javascript:;"><span class="close-btn"></span></a>',i=this.options.modalClass?this.options.modalClass:"",s=this.options.width?"width: "+this.options.width+"px;":"",o=this.options.height?"height: "+this.options.height+"px;":"",'<div class="app_modal_wrap">\n  <div class="app_modal '+i+'" style="'+s+" "+o+'">\n    '+t+'\n    <div class="sidebar_section"></div>\n    <div class="middle_section"></div>\n    <div class="bottom_section">\n      '+((null!=(r=this.options.buttons)?r.length:void 0)>0?n(this.options.buttons):void 0)+"\n      "+e+"\n    </div>\n  </div>\n</div>"},i}(t),n=function(e){var t,i,n,o,s;for(o="",i=0,n=e.length;n>i;i++)t=e[i],s=t.noSubtext?"":'<span class="count sub_text">'+(void 0===t.subtext?"":t.subtext)+"</span>",o+='<a href="javascript:;" class="'+t.type+'">'+t.text+"\n  "+s+"\n  \n</a>";return o},i})}.call(this),function(){var e,t;e=function(){function e(){ThisLife.PubSub.on("state:change",this._stateChange,this)}return _.extend(e.prototype,Backbone.Events),e.prototype.show=function(e,t){var i;return null==t&&(t={}),null!=(i=this._view)&&i.remove(),this._view=new ThisLife.MomentView.Views.Mobile(t)},e.prototype._stateChange=function(e){var t,i,n;return"fullview"!==e.name?("fullview"===(null!=(t=e.previous)?t.name:void 0)&&null!=(i=this._view)&&i.focusOnMoment(),null!=(n=this._view)&&n.remove(),this._view=null):void 0},e.prototype.startSlideshow=function(){var e;return null!=(e=this._view)?e.startSlideshow():void 0},e}(),ThisLife.MomentView||(ThisLife.MomentView={}),(t=ThisLife.MomentView).Controllers||(t.Controllers={}),ThisLife.MomentView.Controllers.Moment=e}.call(this),function(){var e,t,i;t=200,e=Backbone.View.extend({className:"moment-view-wrapper mobile",events:{"click .moment-view-btn.close":"_close","click .download":"_downloadMoment","click .save":"_saveMoment","click .moment-view-make-product":"_openMagicShop","click .share":"_shareEmail","click .full_view_btn.slideshow":"_toggleSlideshow","touchstart .moment-view-stage":"_onTouchStart","touchend .moment-view-stage":"_onTouchEnd"},initialize:function(e){return this.options=null!=e?e:{},this.fullViewPubSub=_.extend({},Backbone.Events),this.isVideo=!1,this.lastTouch={time:null,position:{x:0,y:0}},this.render(),this.cacheElements(),this._bindEvents(),this._fetchImage(),this._prefetchImages(),this.initPinchZoom()},_bindEvents:function(){return ThisLife.app.isMobile||ThisLife.Support.keyInformant.on("cancel",this._close,this,!0),this.fullViewPubSub.on("slideshow:stop",this.stopSlideshow,this).on("slideshow:next",this.gotoNextMoment,this).on("slideshow:prev",this.gotoPrevMoment,this)},_unbindEvents:function(){return this.fullViewPubSub.off(null,null,this),ThisLife.Support.keyInformant.off("cancel",this._close,this)},remove:function(){var e,t;return this.stopSlideshow(),this._unbindEvents(),null!=(e=this.modal)&&e.remove(),null!=(t=this.pinchZoom)&&t.remove(),Backbone.View.prototype.remove.apply(this)},render:function(){return this.$el.appendTo(document.body),this.$el.html(this._template()),ThisLife.app.session.whenLoggedIn(function(e){return function(){return e.options.moment?e.options.moment.get("story_moment_created_by")===ThisLife.currentLifeOwner?($(".moment-view-make-product").css("display","flex"),$(".share").css("display","flex")):void 0:($(".moment-view-make-product").css("display","flex"),$(".share").css("display","flex"))}}(this))},cacheElements:function(){return this.momentStageEl=this.el.querySelector(".moment-view-stage"),this.momentImageEl=this.el.querySelector(".moment-image")},initPinchZoom:function(){var e,t;return e=require("ThisLife.Mobile.PinchZoom"),t={container:this.momentStageEl},this.pinchZoom=new e(this.momentImageEl,t)},updateFMV:function(e){return this.options=e,this._fetchImage(),this._prefetchImages()},_isFMV:function(){var e;return"fullview"===ThisLife.app.currentState.name&&(null!=(e=ThisLife.app.currentState.previous)?e.library:void 0)},gotoPrevMoment:function(e){var t,i,n;return this._isFMV()?(n=ThisLife.app.controller("visual_search").searchResultsHidden()?ThisLife.app.controller("timeline").getPreviousObject(this.options.moment_uid):ThisLife.app.controller("visual_search").getPreviousObject(this.options.moment_uid),t=null!=(i=ThisLife.app.library)?i.getCollection().getModel(n):void 0):t=this.getPreviousMoment(),this.redirectToMoment(t,e)},gotoNextMoment:function(e){var t,i,n;return this._isFMV()?(n=ThisLife.app.controller("visual_search").searchResultsHidden()?ThisLife.app.controller("timeline").getNextObject(this.options.moment_uid):ThisLife.app.controller("visual_search").getNextObject(this.options.moment_uid),t=null!=(i=ThisLife.app.library)?i.getCollection().getModel(n):void 0):t=this.getNextMoment(),this.redirectToMoment(t,e)
},redirectToMoment:function(e,i){return e?((null!=i?i.fade:void 0)||this.slideshowActive?(this.fadeOut(),clearTimeout(this.fadeTimer),this.fadeTimer=setTimeout(function(t){return function(){return t.redirectToNewView(e,i)}}(this),t)):this.redirectToNewView(e,i),!0):!1},getNextMoment:function(){return this.getMoment("Next")},getPreviousMoment:function(){return this.getMoment("Previous")},getMoment:function(e){var t,i,n,o,s,r;return n="get"+e+"Moment",i=void 0!==(null!=(s=ThisLife.app.controllers)?s.story:void 0),this.options.inStory?i?(t=this.options.moment_uid,ThisLife.app.controller("story")[n](t)):(o=ThisLife.app.album[n](this.options.moment.id),ThisLife.app.album.getMoment(o)):(t=this.options.moment_uid,null!=(r=ThisLife.app.library)?r.getCollection()[n](t):void 0)},focusOnMoment:function(e){return"peopleFiltered"!==ThisLife.app.currentState.name?ThisLife.app.currentState.library||ThisLife.app.currentState.filtered?ThisLife.app.library.centerOnMoment(this.options.moment_uid,e):"albums"===ThisLife.app.currentState.name&&null!=ThisLife.app.album.getCurrentAlbum()?ThisLife.app.album.centerOnMoment(this.options.moment_uid,e):void 0:void 0},redirectToNewView:function(e,t){return t=_.extend({},this.options,{moment_uid:e.id}),!this._isFMV()&&t.hasOwnProperty("album_uid")?ThisLife.app.router.navigateToFullView(t.album_uid,e.id,this.getRedirectOptions(t)):ThisLife.app.router.navigateToFullView(e.id,this.getRedirectOptions(t)),this.updateFMV(t)},getRedirectOptions:function(e){return null==e&&(e={}),_.extend(e,{replace:!0,slideshowActive:this.slideshowActive})},_close:function(){var e;return this.remove(),null!=(null!=(e=ThisLife.app.currentState)?e.previous:void 0)?ThisLife.app.router.back():ThisLife.app.router.navigate("/")},_addFetchingState:function(){return this.$el.addClass("fetching")},_removeFetchingState:function(){return this.$el.removeClass("fetching")},_prefetchImages:function(){return this._preloadImage(this.getPreviousMoment()),this._preloadImage(this.getNextMoment())},_preloadImage:function(e){var t,i,n,o,s;return null==e&&(e={}),"getImageSize"in e!=!1?(t=this.momentStageEl.clientHeight,s=this.momentStageEl.clientWidth,n=ThisLife.Helper.Image.imageSize(Math.min(t,s),Math.max(t,s)),o=e.getImageSize(n),i=new Image,i.src=o,i):void 0},_fetchImage:function(){var e,t,i;return i=function(e){return function(){return e._renderImage(),e._showSaveButton()}}(this),t=function(e){return function(){var t,i,n;return null!=(null!=(t=ThisLife.app.currentState)?t.previous:void 0)?ThisLife.app.router.back():"story"===(null!=(i=ThisLife.app.currentState)?i.name:void 0)&&(null!=(n=ThisLife.app.currentState)?n.options.invite_token:void 0)?e.remove():ThisLife.app.router.navigate("/")}}(this),this.options.moment?(e=_.extend({},this.options.moment.attributes,{parse:!0}),e.created_by_uid=e.story_moment_created_by,this.moment=new ThisLife.Model.FullMoment(e),this._renderImage(),this._showSaveButton()):(this.moment=new ThisLife.Model.FullMoment({uid:this.options.moment_uid}),ThisLife.Service.api.getFullMomentSet(this.moment,this.options.album_uid,i,t))},_renderImage:function(){var e,t,i,n;if(e=this.momentStageEl.clientHeight,n=this.momentStageEl.clientWidth,i=ThisLife.Helper.Image.imageSize(Math.min(e,n),Math.max(e,n)),this._setImageSource(this.moment.getImageSize(i)),null!=this.options.share&&("facebook"===(t=this.options.share)||"email"===t)){if("facebook"===this.options.share&&ThisLife.app.isMobile&&!ThisLife.Model.User.get("facebook_access_token"))return;this._shareModal(this.options.share)}return this.isVideo="video"===this.moment.get("moment_type"),this.isVideo?(this.$el.find(".moment-view-close")[0].classList.add("video-view"),this._addVideoView(this.moment)):void 0},_showSaveButton:function(){return ThisLife.app.isMobile&&this.moment.get("created_by_uid")!==ThisLife.currentLifeOwner?this.$el.find(".save").removeClass("hidden"):void 0},_shareModal:function(e){var t,i;return t=new ThisLife.Collection.FMVCollection,t.add(this.moment),null!=(i=this.modal)&&i.remove(),this.modal=new ThisLife.View.ActionBarModal({collection:t,type:e,share:!0,fmv:!0,album_uid:this.options.album_uid}),document.body.appendChild(this.modal.render().el),this.modal.modalFocus()},_downloadMoment:function(){var e,t;if(ThisLife.app.controller("tracking").logFMVDownloadClicked(),ThisLife.app.isMobile&&this.isVideo)return alert("Please download from desktop browser");t=this.options.inStory?ThisLife.storyUid:null;try{return ThisLife.app.session.getSessionToken().then(function(e){return function(i){var n,o;return n=e.options.moment_uid||(null!=(o=e.options.moment.attributes)?o.uid:void 0),window.location=ThisLife.Service.api.downloadMomentUrl(n,t,i)}}(this))}catch(i){if(e=i,"Unspecified error."!==e.message)throw e}},_shareEmail:function(){var e,t,i;return t=new ThisLife.Collection.FMVCollection,t.add(this.moment),e={collection:t},i={width:"450",fullPagePoint:"mediumScreen",title:"Share via email",childView:new ThisLife.View.actionBar.email(e),buttons:[{type:"orange_button",onclick:this.shareMail,text:"SHARE WITH",subtext:0}]},ThisLife.app.controller("appmodal").get("emailShare").renderView(i).disableButton("orange_button"),ThisLife.app.controller("tracking").logFMVShare("email")},shareMail:function(){return ThisLife.PubSub.trigger("actionBar:share")},_saveMoment:function(){var e,t;if(!this._saving)return t=function(e){return function(){var t;return t={close:!1,position:"bottom-left",slim:!0,style:"light",title:"PHOTO SAVED"},e._saving=!1,e.$el.find(".moment-view-btn.download").hide(),ThisLife.app.controller("toast")["new"](t)}}(this),e=function(e){return function(){return e._saving=!1}}(this),this._saving=!0,ThisLife.app.controller("tracking").logFMVSave(),ThisLife.Service.api.importSharedStoryMoments(this.options.album_uid,[this.options.moment_uid],t,e)},_setImageSource:function(e){var t,i;return i=function(e){return function(){return e.momentImageEl.style.cssText=e.momentImageEl.width>e.momentStageEl.clientWidth?"width: "+e.momentStageEl.clientWidth+"px;":e.momentImageEl.height>e.momentStageEl.clientHeight?"height: "+e.momentStageEl.clientHeight+"px;":e.momentStageEl.clientWidth-e.momentImageEl.width>e.momentStageEl.clientHeight-e.momentImageEl.height?"height: "+e.momentStageEl.clientHeight+"px;":"width: "+e.momentStageEl.clientWidth+"px;",$(e.momentImageEl).off("load",i)}}(this),t=function(e){return function(){return e._removeFetchingState(),i(),e.slideshowActive?(e.slideshowView.restart(),e.fadeIn(),e.fullViewPubSub.trigger("slideshow:momentChanged",e.moment.get("moment_type"))):void 0}}(this),this._addFetchingState(),$(this.momentImageEl).on("load",t),this.momentImageEl.src=e},_addVideoView:function(e){var t,i,n,o;return i=this.momentStageEl.clientHeight,o=this.momentStageEl.clientWidth,n=e.get("story_moment_created_by")||ThisLife.currentLifeOwner,t={height:i,width:o},this.videoView=new ThisLife.MomentView.Views.Video({el:this.momentStageEl,model:e,dimensions:t,ownerUid:n}),_.defer(function(){return afterglow.initVideoElements()})},_toggleSlideshow:function(){return this.slideshowActive?void 0:this.startSlideshow()},startSlideshow:function(){return this.fullViewPubSub.trigger("slideshow:started"),this.slideshowActive=!0,this.slideshowView?this.slideshowView.start(this.moment.get("moment_type")):this.slideshowView=new ThisLife.View.FullView.Slideshow({el:this.el,parentPubSub:this.fullViewPubSub,type:this.moment.get("moment_type")}),this},_openMagicShop:function(){var e;return ThisLife.View.magicShop.doneShopping(),e=new Backbone.Collection,e.add(this.moment),ThisLife.View.magicShop.startShopping(e,"photogifts"),ThisLife.app.controller("tracking").logClickFMVMobileCreateProduct()},stopSlideshow:function(){return this.slideshowActive?(clearTimeout(this.fadeTimer),this.el.classList.remove("fade_out"),this.slideshowView.teardown(),this.slideshowActive=!1):void 0},fadeOut:function(){return this.el.classList.add("fade_out")},fadeIn:function(){return this.el.classList.add("fade_out"),_.delay(function(e){return function(){return e.el.classList.remove("fade_out")}}(this),0)},_onTouchStart:function(e){var t;return this.lastTouch.time=Date.now(),t=ThisLife.Helper.Event.fingersUsed(e),1===t&&(this.lastTouch.position=ThisLife.Helper.Event.getTouchPos(e)),!1},_onTouchEnd:function(e){var t;return t=ThisLife.Helper.Event.fingersUsed(e),1===t&&(this._isZoomedIn()||this.handleSwiping(e)),!1},handleSwiping:function(e){var t,i,n,o,s;if(s={time:Date.now(),position:ThisLife.Helper.Event.getTouchPos(e)},t=s.position.x-this.lastTouch.position.x,i=s.time-this.lastTouch.time,o=t>=100,n=-100>=t,250>=i){if((o||n)&&this.slideshowActive&&this.fadeOut(),o)return this.gotoPrevMoment();if(n)return this.gotoNextMoment()}},_isZoomedIn:function(){return this.pinchZoom.currentScale>1},_template:function(){return'<div class="moment-view-stage">\n  <img class="moment-image" />\n  <!-- or video player goes here -->\n  <div class="fullview-spinner"></div>\n</div>\n<div class="moment-view-close">\n  <div class="moment-view-btn close"><div class="icon"></div></div>\n</div>\n\n<div class="bottom-bar">\n  <div class="moment-view-make-product"><span>Make Product</span></div>\n    \n  <div class="share"><span>Share</span></div>\n  \n  <div class="download"><span>Download</span></div>\n  \n  <div class="full_view_btn slideshow">\n    <div class="full_view_hover_tooltip_wrap"></div>\n    <div class="icon"></div>\n    <canvas width="44" height="44" id="slideshow_progress"></canvas>\n  </div>\n\n  <div class="save hidden"><span>Save to Account</span></div>\n</div>'}}),ThisLife.MomentView||(ThisLife.MomentView={}),(i=ThisLife.MomentView).Views||(i.Views={}),ThisLife.MomentView.Views.Mobile=e}.call(this),function(){define("ThisLife.MomentView.Views.Video",[],function(){var e;return e=Backbone.View.extend({className:"moment_view_video",initialize:function(e){return this.dimensions=e.dimensions,this.ownerUid=e.ownerUid,this.render(),this},render:function(){return this.$el.html(this.template(this.model,this.ownerUid,this.dimensions)),afterglow.initVideoElements(),this.videoElm=this.$el.find("video"),this.videoPlayer=afterglow.getPlayer("video-"+this.model.id),this},remove:function(){return this.videoPause(),afterglow.destroyPlayer("video-"+this.model.id),Backbone.View.prototype.remove.apply(this),this},videoPlay:function(){var e;return null!=(e=this.videoPlayer)?e.play():void 0},videoPause:function(){var e;return null!=(e=this.videoPlayer)?e.pause():void 0},template:function(e,t,i){var n,o,s;return o=ThisLife.Helper.Image.imageUrlDim(e.id,i,e.get("effects_modified_date"),t),s=ThisLife.Settings.s3VideoUrl+"/"+t+"/"+e.id+"_small.mp4",n=ThisLife.MediaPlayerHelper.videoUrlDim(e.id,t,i.height,e.get("height"),null,null,!1,0),'<video class="afterglow" id="video-'+e.id+'" height="'+i.height+'" width="'+i.width+'" data-skin="dark" poster="'+o+'">\n  <source type="video/mp4" src="'+n+'" data-quality="hd" />\n  <source type="video/mp4" src="'+s+'" />\n</video>'}})}),ThisLife.MomentView.Views.Video=require("ThisLife.MomentView.Views.Video")}.call(this),function(){define("ThisLife.Selection.Collections.Selection",["ThisLife.Helper.String"],function(e){var t;return t=Backbone.Collection.extend({initialize:function(e){return this._limit=e,this},add:function(e,t){return null==t&&(t={}),e=this._validateCollection(e),Backbone.Collection.prototype.add.call(this,e,{silent:!0}),this.trigger("add",e,this,t),this.clearShareUrl(),this._applyLastDate(e),this._applyLastMoment(e),this},remove:function(e,t){return null==t&&(t={}),e=this._validateModels(e),Backbone.Collection.prototype.remove.call(this,e,{silent:!0}),this.trigger("remove",e,this,t),this.clearShareUrl(),this._deselectModels(e),this},reset:function(){return this.remove(this.models),this.lastDate=null,this.lastMoment=null},getModel:function(e){return this.get(e)},hasModel:function(e){return this.get(e.id)},getModelsByType:function(e){return"image"===e||"video"===e?_.filter(this.models,function(t){return t.get("moment_type")===e}):!1},getNextMoment:function(e){var t,i,n,o;return this.length<=1&&this.get(e)?null:(n=this.where({hidden:!1}),i=this.get(e),t=n.indexOf(i),o=n[t+1],o||(o=n[0]),o)},getPreviousMoment:function(e){var t,i,n,o;return this.length<=1&&this.get(e)?null:(n=this.where({hidden:!1}),i=this.get(e),t=n.indexOf(i),o=n[t-1],o||(o=n[n.length-1]),o)},getOnlyMyMoments:function(){return this.filter(function(e){return e.canEdit()})},containsMyMoments:function(){var e;return e=this.find(function(e){return e.canEdit()}),e?!0:!1},containsOnlyMyMoments:function(){var e;return e=_.some(this.models,function(e){return!e.canEdit()}),!e},containsVideos:function(){return!!this.find(function(e){return e.isVideo()})},containsOthersMoments:function(){var e;return e=this.find(function(e){return!e.canEdit()}),e?!0:!1},getImages:function(){return this._getModelsByType("image")},getVideos:function(){return this._getModelsByType("video")},videoCount:function(){return this.getVideos().length},imageCount:function(){return this.getImages().length},hasMoment:function(e){return this.get(e.id)},getDescription:function(){return e.pluralizePhotosVideos(this.models)},clearShareUrl:function(){return this.shareUrl=null},setShareUrl:function(e){return 1===this.models.length?this.models[0].shareUrl=e:this.shareUrl=e},getShareUrl:function(){return 1===this.models.length?this.models[0].shareUrl:this.shareUrl},_isAtLimit:function(){return this._limit<=this.length},_willBeOverlimitAdding:function(e){var t;return t=_.difference(e,this.models),this._limit<this.length+t.length},_validateCollection:function(e){return this._isAtLimit()?[]:(e=this._validateModels(e),e=_.difference(e,this.models),e=_.filter(e,function(e){return!e.get("hidden")}),0===e.length||this._willBeOverlimitAdding(e)?[]:e)},_validateModels:function(e){return e=_.isArray(e)?e.slice():[e]},_getModelsByType:function(e){return"image"===e||"video"===e?_.filter(this.models,function(t){return t.get("moment_type")===e&&t.get("hidden")===!1}):!1},_applyLastDate:function(e){var t,i,n,o;for(o=[],t=0,i=e.length;i>t;t++)n=e[t],n.selectMoment(!0),o.push(null!=n.day?this.lastDate=n.day.getDate(n):this.lastDate=n.get("moment_date"));return o},_applyLastMoment:function(e){var t,i,n,o;for(o=[],t=0,i=e.length;i>t;t++)n=e[t],n.selectMoment(!0),o.push(this.lastMoment=n);return o},_deselectModels:function(e){var t,i,n,o;for(o=[],t=0,i=e.length;i>t;t++)n=e[t],o.push(n.selectMoment(!1));return o}})})}.call(this),function(){define("ThisLife.Selection.Controllers.Selection",["ThisLife.Selection.Helpers.Actions","ThisLife.Selection.Collections.Selection","ThisLife.Selection.Views.CreateButtons","ThisLife.Selection.Views.Magicshop","ThisLife.View.ModalAlert","ThisLife.Selection.Views.Selection","ThisLife.Selection.Views.SelectionBar","ThisLife.Selection.Views.SelectionBin","ThisLife.Selection.Views.Timeline","ThisLife.Selection.Views.AlbumCover"],function(e,t,i,n,o,s,r,l,a,u){var c,d,h,p;return c=1e3,d="selection",p={magicshop:n,selection:s,timeline:a,albumCover:u},h=function(){function i(){this._collection=new t(c),this._actions=new e({collection:this._collection})}return _.extend(i.prototype,Backbone.Events),i.prototype.start=function(e){var t,i,n,o,s;return this.options=null!=e?e:{},null!=(i=this._view)&&i.remove(),this._type=this.options.viewType||d,t=new p[this._type](_.extend({selection:this},this.options)),s=_.extend({selection:this,childView:t},this.options),this.options.storyUid&&(this._album=ThisLife.Model.Albums.Master.getAlbumById(this.options.storyUid)),this._view=new r(s),document.body.appendChild(this._view.render().el),this._type===d&&(this._view.childView.renderIcons(),this._view.childView.hideAddToAlbum()),this.containVideos=this._view.childView.selection.getCollection().containsVideos(),this._active=!0,this.options.collection&&(o=_.pluck(this.options.collection.models,"id"),ThisLife.app.controller("timeline").updateOptions({read_only:!0}),ThisLife.app.controller("timeline").updateObjects(o,{selected:!0,disabled:!0}),ThisLife.app.library.centerOnMoment(null!=(n=this.options.model)?n.get("uid"):void 0,!1,this.options.replaceUrl,"library")),this.trigger("start"),this.trigger("change:active",!0),ThisLife.PubSub.trigger("selection:scrubber"),this},i.prototype.done=function(){var e,t,i,n,o;if(this._active)return this.options.collection&&ThisLife.app.controller("timeline").updateOptions({read_only:!1}),ThisLife.app.controller("timeline").updateObjects(_.pluck(this._collection.models,"id"),{selected:!1}),"function"==typeof(e=ThisLife.app.album).updateObjects&&e.updateObjects(_.pluck(this._collection.models,"id"),{selected:!1}),this._album=null,this._collection.reset(),null!=(i=this._buttons)&&i.teardown(),this._buttons=null,null!=(n=this._view)&&n.remove(),this._view=null,this._active=!1,this._type=null,this.closeSelectionBin(),this.options.collection&&(0===this.options.collection.getNumPhotosAndVideos()&&(t=null),o=_.pluck(this.options.collection.models,"id"),ThisLife.app.controller("timeline").updateObjects(o,{selected:!1,disabled:!1}),ThisLife.app.router.navigateToAlbum(this.options.storyUid,{replace:!0,trigger:!1}),ThisLife.app.setState("albums",{view:"album",album_uid:this.options.storyUid,moment_uid:t})),null!=ThisLife.app.controller("visual_search").search&&this.options.storyUid&&ThisLife.app.controller("visual_search")._clearFilters(),this.options={},this.trigger("done"),this.trigger("change:active",!1),ThisLife.PubSub.trigger("selection:scrubber"),this},i.prototype.doneShopping=function(){var e,t;return null!=(t=this._view)&&"function"==typeof(e=t.childView).doneShopping?e.doneShopping():void 0},i.prototype.openSelectionBin=function(){var e,t;return e={selection:this},this._binview=new l(e),document.body.appendChild(this._binview.render().el),this._actions._sendMetrics("openBin"),setTimeout(function(e){return function(){return e._binview.el.querySelector(".selection_bin").classList.add("show")}}(this),100),this.disableCloseButton(),null!=(t=this._buttons)?t.disable():void 0},i.prototype.closeSelectionBin=function(){return this._binview&&(this._actions._sendMetrics("closeBin"),this._binview.el.querySelector(".selection_bin").classList.remove("show")),setTimeout(function(e){return function(){var t;return null!=(t=e._binview)&&t.teardown(),e._binview=null}}(this),200)},i.prototype.getSelectionBin=function(){return this._binview},i.prototype.isSpecialtySelection=function(){var e;return"magicshop"===(e=this._type)||"timeline"===e},i.prototype.disableCloseButton=function(){var e;return null!=(e=document.body.querySelector(".selection-bar .close"))?e.classList.add("disabled"):void 0},i.prototype.disableSelectionActions=function(){return document.getElementById("library_view").classList.add("disabled"),document.body.querySelector(".selection-bar").classList.add("disabled")},i.prototype.enableSelectionActions=function(){return document.getElementById("library_view").classList.remove("disabled"),document.body.querySelector(".selection-bar").classList.remove("disabled")},i.prototype.removeSelectedFromView=function(){var e,t;return null!=(e=this._view)&&e.childView.removeSelectedFromView(),null!=(t=this._buttons)?t.enable():void 0},i.prototype.getType=function(){var e;return null!=(e=this.options)?e.viewType:void 0},i.prototype.getAlbum=function(){return this._album},i.prototype.getAlbumCollection=function(){var e;return null!=(e=this.options)?e.collection:void 0},i.prototype.getCollection=function(){return this._collection},i.prototype.getSelectedMoments=function(){return this._collection.getImages()},i.prototype.addModels=function(e,t){var i,n,s;return null==t&&(t={}),this._collection._willBeOverlimitAdding(e)?(s=new o({template:"overLimitEditTemplate",item:c}),s.show()):(this._active||(n=ThisLife.app.album.albumState?ThisLife.app.album.getCurrentAlbum().isFriendsAlbum():!1,this.start({storyUid:t.storyUid,viewType:t.viewType,viewTypeOption:t.viewTypeOption,isAlbumShared:n})),this._collection.add(e),this.trigger("change:model_count",this.getCount()),t.silent||(ThisLife.app.controller("timeline").updateObjects(_.pluck(e,"id"),{selected:!0}),"function"==typeof(i=ThisLife.app.album).updateObjects&&i.updateObjects(_.pluck(e,"id"),{selected:!0}))),this},i.prototype.removeModels=function(e){var t;return this._collection.remove(e),ThisLife.app.controller("timeline").updateObjects(_.pluck(e,"id"),{selected:!1}),"function"==typeof(t=ThisLife.app.album).updateObjects&&t.updateObjects(_.pluck(e,"id"),{selected:!1}),this.isEmpty()&&(this.isSpecialtySelection()?this.closeSelectionBin():this.done()),this.trigger("change:model_count",this.getCount()),this},i.prototype.toggleModels=function(e,t){var i,n,o,s,r,l,a,u,c;if(null==t&&(t={}),a=this._collection.get(e.id))this.removeModels([e]);else if(null!=(l=t.event)?l.shiftKey:void 0){if(s=null!=e.day?e.day.getDate(e):e.collection.getDate(e),(i=this._collection).lastDate||(i.lastDate=s),t.storyUid)r=ThisLife.app.album.getCollection().getPhotosAndVideosForDateRange(s,this._collection.lastDate);else for(r=[],c=ThisLife.app.controller("timeline").getObjectRange(e.id,this._collection.lastMoment.id),n=0,o=c.length;o>n;n++)u=c[n],r.push(ThisLife.app.library.getCollection().getModel(u));this.addModels(r,{storyUid:t.storyUid})}else this.addModels([e],{storyUid:t.storyUid});return this},i.prototype.isActive=function(){return this._active},i.prototype.isEmpty=function(){return!this._collection.length},i.prototype.hasModel=function(e){return this._collection.hasModel(e)},i.prototype.getCount=function(){return this._collection.length},i.prototype.getImages=function(){return this._collection.getImages()},i.prototype.imageCount=function(){return this._collection.getImages().length},i.prototype.getVideos=function(){return this._collection.getVideos()},i.prototype.videoCount=function(){return this._collection.getVideos().length},i.prototype.isMomentSelected=function(e){return this.hasModel(e)},i.prototype.getActions=function(){return this._actions},i}()})}.call(this),function(){var e=[].indexOf||function(e){for(var t=0,i=this.length;i>t;t++)if(t in this&&this[t]===e)return t;return-1};define("ThisLife.Selection.Helpers.Actions",["ThisLife.View.ActionBarModal","ThisLife.View.Error","ThisLife.View.ModalAlert","ThisLife.Helper.OrderPrints","ThisLife.PubSub","ThisLife.View.SpinnerModal","ThisLife.Selection.Helpers.Actions.Collage","ThisLife.Helper.Features"],function(t,i,n,o,s,r,l,a){var u;return u=function(){function u(e){this._collection=e.collection,this._options={}}return _.extend(u.prototype,Backbone.Events),u.prototype.perform=function(e){var t;if(this._validatePerformAction(e.action))return e.actionCallback=this.actionCallback,null!=e.params.storyUid&&(this._options.sourceAlbumUID=e.params.storyUid),t=this._actionToMethod(e.action),this._sendMetrics(e.action),this[t](e.params)},u.prototype._actionToMethod=function(e){var t;return t="_"+e},u.prototype._validatePerformAction=function(e){var t;return this._collection.containsMyMoments()?!0:["products","orderPrints","createCollageSquare","createCollageLandscape","createCollagePortrait","changeAlbumCover","download","save","copyToAlbum"].indexOf(e)>=0?!0:(t=new n({template:"actionPermissionError"}),document.body.appendChild(t.render().el),!1)},u.prototype._checkOwnership=function(){var e;return this._collection.containsOthersMoments()?(e=new n({template:"actionPermissionWarning"}),document.body.appendChild(e.render().el)):void 0},u.prototype._renderModal=function(e,i){var n,o;return this._removeModal(),n={callback:null,collection:this._collection,closeOnStateChange:!0,share:!1,type:e},o=_.extend(n,i),this._modal=new t(o),document.body.appendChild(this._modal.render().el),this._modal.modalFocus(),o.closeOnStateChange?(s.on("state:change",this._removeModal,this),s.on("modal:show",this._removeModal,this)):void 0},u.prototype._removeModal=function(){var e;return null!=(e=this._modal)&&e.remove(),this._modal=void 0,s.off("state:change",this._removeModal,this),s.off("modal:show",this._removeModal,this)},u.prototype._sendRequest=function(e,t,i,n,o){var s,r,l;return n||(n=function(e){var t;return null!=(t=e.result)?t.success:void 0}),l=this._showProgressSpinner.apply(this,[e,t,null!=o?o.noConfirmation:void 0,null!=o?o.callback:void 0,null!=o?o.progressText:void 0]),r=function(e){return function(t,s){return n(s)?(l(),"function"==typeof i&&i(),(null!=o?o.triggerDone:void 0)?e.trigger("done"):void 0):l(!0)}}(this),s=function(){return function(){return l(!0)}}(this),t.push(r),t.push(s),ThisLife.Service.api[e].apply(ThisLife.Service.api,t),this},u.prototype._showProgressSpinner=function(e,t,i,o,s){var l,a,u;return u=new r({progressText:s}),document.body.appendChild(u.el),a=this._collection.getOnlyMyMoments().length,l=function(s){var r;return u.teardown(),o?o(s):(r=new n,r.spinnerActive=!1,s?(document.body.appendChild(r.renderLoadingTemplate().el),r.changeInnerHTML.call(r,"apiSoftErrorTemplate")):i?void 0:(document.body.appendChild(r.renderLoadingTemplate().el),r.changeInnerHTML.call(r,e,{data:t,length:a}),_.delay(function(){return r.teardown()},n.CONFIRMATION_DELAY)))},ThisLife.Helper.Scripts.postpone(l,500)},u.prototype._sendMetrics=function(e){return ThisLife.app.controller("tracking").logClickSelectionAction(e)},u.prototype._addToAlbum=function(){return this._renderModal("timeline_add"),this},u.prototype._addDirectToAlbum=function(e){var t,i,n,o,s,r;return ThisLife.Model.masterStory.updateStory(e.storyUid),n=function(t){var i,n,o,s,l,a,u,c;if(null!=(u=t.result)?u.success:void 0)return n=ThisLife.Model.Albums.Master.getAlbumById(e.storyUid),null!=n&&n.addPendingUploads(r),a=r.length>1?" PHOTOS":" PHOTO",i="albums"===ThisLife.app.currentState.name?" COPIED":" ADDED TO ALBUM",ThisLife.app.controller("toast")["new"]({title:r.length+a+i,style:"light",position:"bottom-left"}),ThisLife.app.controller("selection").done(),!0;for(c=t.result.errors,s=0,l=c.length;l>s;s++)if(o=c[s],"This moment already exists in the specified story."!==o.message)return!1;return!0},t=e.collection?e.collection:this._collection.getOnlyMyMoments(),r=t.models?_.pluck(t.models,"id"):_.pluck(t,"id"),s=function(){return e.navigateToAlbum?(ThisLife.app.controller("selection").done(),ThisLife.app.router.navigateToAlbum(e.storyUid)):void 0},i=ThisLife.app.album.getCurrentAlbum(),o="albums"===ThisLife.app.currentState.name?"Copying to album ...":"Adding to album ...",i&&i.isFriendsAlbum()?i.isFriendsAlbum()?this._sendRequest("copySharedMoments",[this._options.sourceAlbumUID,e.storyUid,r],s,n,{noConfirmation:!0,progressText:o,triggerDone:e.triggerDone}):void 0:this._sendRequest("saveStoryMoments",[e.storyUid,r],s,n,{noConfirmation:!0,progressText:o,triggerDone:e.triggerDone})},u.prototype._removeFromAlbum=function(e){var t,i,o;return i=e.storyUid,t=function(t){return function(){var n,o,s,r,l;return null!=e.uids?l=e.uids:(o=t._collection.getOnlyMyMoments(),l=_.pluck(o,"id")),ThisLife.Model.masterStory.updateStory(i),ThisLife.app.album.removeMoments(i,l),n=function(e){var t,i;return(null!=(t=e.result)?t.success:void 0)?!0:(null!=(i=e.result)?i.errors:void 0)?!1:!0},r=function(){return e.navigateToAlbum?(ThisLife.app.controller("selection").done(),ThisLife.app.router.navigateToAlbum(e.storyUid)):void 0},s="Removing photo....",t._sendRequest("deleteStoryMoments",[i,l],r,n,{triggerDone:!0,callback:e.callback,progressText:s}),t._checkOwnership(),ThisLife.app.controller("selection").done()}}(this),o=new n({template:"removeFromStory",callback:t}),document.body.appendChild(o.render().el),this},u.prototype._copyToAlbum=function(){return this._renderModal("timeline_add",{copyMoment:!0}),this},u.prototype._moveToAlbum=function(){return this._renderModal("moment_move"),this},u.prototype._changeAlbumCover=function(e){var t,i;return i=this._collection.models,t=ThisLife.Model.Albums.Master.getAlbumById(e.storyUid),null!=t&&(null!=i?i.length:void 0)>0&&t.changeCover(i[0]),ThisLife.app.controller("selection").done(),this},u.prototype._shareEmail=function(){var e,t;return e={collection:this._collection},t={width:"450",fullPagePoint:"smallScreen",title:"Share via email",childView:new ThisLife.View.actionBar.email(e),buttons:[{type:"orange_button",onclick:this._shareMail,text:"SHARE WITH",subtext:0}]},ThisLife.app.controller("appmodal").get("emailShare").renderView(t).disableButton("orange_button")},u.prototype._shareMail=function(){return ThisLife.PubSub.trigger("actionBar:share")},u.prototype._shareSites=function(){return ThisLife.Service.TmsTracking.trackShareAction(),this._modal=new ThisLife.View.PostToShareSites({collection:this._collection}),document.body.appendChild(this._modal.render().el),ThisLife.PubSub.on("state:change",this._removeModal,this),ThisLife.PubSub.on("modal:show",this._removeModal,this),this},u.prototype._shareFacebook=function(){return this._showShareModal("facebook")},u.prototype._shareTwitter=function(){return this._showShareModal("twitter")},u.prototype._shareTumblr=function(){return this._showShareModal("tumblr")},u.prototype._shareLink=function(){return this._showShareModal("link")},u.prototype._showShareModal=function(e,t){return null==t&&(t=!0),ThisLife.Service.TmsTracking.trackShareAction(),this._renderModal(e,{closeOnStateChange:t,share:!0})},u.prototype._favorite=function(e){var t,i,n,o,s,r,l,a,u,c,d,h,p;for(u=(null!=e?e.models:void 0)?e.models:this._collection.getOnlyMyMoments(),i=!1,p=!1,d=u[0].get("rating"),o=!1,n=0,r=u.length;r>n;n++)if(a=u[n],h=a.get("rating"),h!==d){o=!0;break}for(s=0,l=u.length;l>s;s++)a=u[s],h=a.get("rating"),h?o||(a.saveRating(3-h),p=!0):(a.saveRating(3),i=!0);return t=function(e){return ThisLife.app.controller("toast")["new"]({title:e,style:"light",position:"bottom-left"}),ThisLife.app.controller("selection").done()},p&&(c=u.length+" "+ThisLife.Helper.String.pluralizePhotosVideos(u).toUpperCase(),t(c+" REMOVED FROM FAVORITES")),i&&(c=u.length+" "+ThisLife.Helper.String.pluralizePhotosVideos(u).toUpperCase(),t(c+" ADDED TO FAVORITES")),this._checkOwnership(),this},u.prototype._trash=function(){var e,t;return e=this._collection.getOnlyMyMoments(),t=_.pluck(e,"id"),ThisLife.app.controller("selection").removeModels(e),ThisLife.app.controller("trash")["delete"](t),this._checkOwnership(),this},u.prototype._rotate90=function(){return this._rotate(90)},u.prototype._rotate180=function(){return this._rotate(180)},u.prototype._rotate270=function(){return this._rotate(270)},u.prototype._rotate=function(e){var t,i,n,o;return null==e&&(e=90),o=this._collection.getVideos(),this._collection.remove(o),t=this._collection.getOnlyMyMoments(),n=_.pluck(t,"id"),e&&"number"==typeof e||(e=90),i=function(t){return function(){var i;return t._checkOwnership(),ThisLife.app.library.rotateMoments(n,e),ThisLife.app.album.rotateMoments(n,e),i=n.length>1?" PHOTOS":" PHOTO",ThisLife.app.controller("toast")["new"]({title:n.length+i+" ROTATED",style:"light",position:"bottom-left"}),ThisLife.app.controller("selection").done()}}(this),this._sendRequest("rotateMoments",[n,e],i,null,{noConfirmation:!0,progressText:"Rotating photos..."}),this},u.prototype._tag=function(){return this._renderModal("tags"),this},u.prototype._changeDate=function(){return this._renderModal("date",{callback:_.bind(this._setDate,this)}),ThisLife.app.isMobile&&document.getElementById("mobileDateLabel").focus(),this},u.prototype._setDate=function(t){var i,n,o,s,r,l,a,u,c,d,h,p;if(!(e.call(t.split("/"),"default")>=0)){for(a=this._collection.getOnlyMyMoments(),p=_.pluck(a,"id"),c=p.length>1?" PHOTOS":" PHOTO",ThisLife.app.library.dateMoments(p,t),o=0,r=a.length;r>o;o++)u=a[o],u.updateDate(t,{silent:!0});if(d=this._showProgressSpinner("momentUpdates","",!0,"","Updating dates ..."),n=new Date(t+" GMT"),ThisLife.app.album.isActive())for(s=0,l=p.length;l>s;s++)if(h=p[s],u=ThisLife.app.album.getMoment(h),null!=u){"function"==typeof(i=ThisLife.app.album).refreshView&&i.refreshView();break}return ThisLife.Service.api.saveMomentsProperty(p,"moment_change_day",n.toUnix()).then(function(e){return function(t){var i;return e._checkOwnership(),(null!=(i=t.result)?i.success:void 0)?(d(),ThisLife.app.controller("toast")["new"]({title:"DATE UPDATED FOR "+p.length+c,style:"light",position:"bottom-left"}),ThisLife.app.controller("selection").done()):d(!0)}}(this))["catch"](function(){return function(){return d(!0)}}(this))}},u.prototype._download=function(e){var t,o,s,r,l,a,u,c;if(l=e.storyUid,s=500,1===this._collection.length)ThisLife.app.session.getSessionToken().then(function(e){return function(t){var i;return i=e._collection.models[0].id,window.location=ThisLife.Service.api.downloadMomentUrl(i,l,t),window.setTimeout(function(){return ThisLife.app.controller("toast")["new"]({title:"1 PHOTO DOWNLOADED",style:"light",position:"bottom-left"}),ThisLife.app.controller("selection").done()},1500)}}(this));else{if(u=("function"==typeof(t=this._collection).getImages?t.getImages().length:void 0)?"function"==typeof(o=this._collection).getImages?o.getImages().length:void 0:e.totalMedia,u>s)return c=new n({template:"overLimitDownloadTemplate",item:s}),void c.show();
a=function(e){return function(){return c.teardown(),e._renderModal("download",{closeOnStateChange:!1,shared:!0}),ThisLife.app.controller("selection").done()}}(this),r=function(e){var t,n;return c.teardown(),ThisLife.log.error("multi-file download failed",e),n="Job pending"===e.message?"Another download job you've initiated is in progress. Please wait until you receive an email from that download job before initiating another download.":'Error occurred with download. Please try again. Contact customer service at <a href="mailto:help@cs.thislife.com">help@cs.thislife.com</a> if problem persists.',t=new i({message:n}),t.show()},c=new n,document.body.appendChild(c.renderLoadingTemplate().el),ThisLife.Service.api.momentDownloadMultiple(this._collection.pluck("uid"),l,a,r)}return this},u.prototype._save=function(e){var t,i,n;if(!this._saving)return n=_.pluck(this._collection.models,"id"),i=function(e){return function(){var t,i,o;return i="PHOTO SAVED",t="1 photo has been saved",n.length>1&&(i="PHOTOS SAVED",t=n.length+" photos have been saved"),o={close:!0,position:"bottom-left",style:"light",title:i,text:t},e._saving=!1,ThisLife.app.controller("toast")["new"](o)}}(this),t=function(e){return function(){return e._saving=!1}}(this),this._saving=!0,ThisLife.Service.api.copySharedMoments(e.storyUid,null,n,i,t)},u.prototype._products=function(){return a.whenReady("magicshop",function(e){return function(t){return t&&ThisLife.View.magicShop.productsPreloaded.prints.widget.loadMagicShop("prints"),setTimeout(function(){return ThisLife.View.magicShop.startShopping(e._collection)},250)}}(this))},u.prototype._orderPrints=function(){return o.addToCart(this._collection.getImages())},u.prototype._createCollage=function(){return l.addToCart(this._collection.getImages(),"square")},u.prototype._createCollageSquare=function(){return l.addToCart(this._collection.getImages(),"square")},u.prototype._createCollagePortrait=function(){return l.addToCart(this._collection.getImages(),"portrait")},u.prototype._createCollageLandscape=function(){return l.addToCart(this._collection.getImages(),"landscape")},u.prototype._addRecentUploadsToStory=function(e,t,i){return ThisLife.Model.masterStory.updateStory(e),this._addDirectToAlbum({storyUid:e,triggerDone:!1,collection:t,navigateToAlbum:i})},u}()})}.call(this),define("ThisLife.Selection.Helpers.Actions.Collage",["ThisLife.Helper.OrderPrints","ThisLife.Selection.Helpers.Actions.CollageLayouts"],function(e,t){function i(){return{info:{size:"",style:5146},photoStrip:[],pages:[]}}function n(){return{type:"page",pageNum:2,canvas:{layout:{},backgroundId:"bg_rec_sfly_white",photosBehindCanvas:2}}}return _.extend({},e,{addToCart:function(e,t){var i=this;this.userId=ThisLife.Model.User.id,this.life=ThisLife.Model.User.getLifePermission(),this.sendToNxgen(e,this.life,function(n){var o=i.buildProject(e,n,t);i.saveProjectJson(o)})},getProductsPath:function(){return"/pb/?product=ss#/?fromLocation=ThisLife&uid="+this.userId+"&initProjectGUID="+this.projectId+"&reportSrc=sflyphotos/collage/manualselect"},getMagicCSUrl:function(){var e=ThisLife.Settings.sflyEnv,t="magic.photoccino.com/SaveProjectJson";return"prod"!=e&&(t=e+"-"+t),"//"+t},buildProject:function(e,t,o){var s=0,r=i(),l=n(),a={count:e.length,s:[],l:[],p:[]};switch(o){case"landscape":r.info.size="7x9";break;case"portrait":r.info.size="11x8",r.info.style=5296;break;case"square":default:r.info.size="10x10"}return r.info.userId=this.userId,r.pages.push(l),_.each(e,function(e){var i=e.id,n=e.get("height"),o=e.get("width");t.hasOwnProperty(e.id)&&(i=t[e.id]),s++,r.photoStrip.push({areaOfInterest:[0,0,1,1],photoId:i,photoRefId:s,url:ThisLife.Helper.Image.imgUrl(i,"medium",e.get("effects_modified_date"),ThisLife.currentLifeOwner)}),o>n?a.l.push(s):n>o?a.p.push(s):a.s.push(s)}),l.canvas.layout=this.selectLayout(a,o),r},selectLayout:function(e,i){var n,o=null;switch(i){case"landscape":n=t.getLandscape(e.count);break;case"portrait":n=t.getPortrait(e.count);break;case"square":default:n=t.getSquare(e.count)}for(var s=0;s<n.length;s++)if(n[s].config.p.length<=e.p.length&&n[s].config.l.length<=e.l.length){o={layoutId:n[s].id,photos:this.assignPhotos(n[s].config,e)};break}return o||(o={layoutId:n[n.length-1].id,photos:this.assignPhotos(n[n.length-1].config,e)}),ThisLife.log.debug("COLLAGE - using layout "+o.layoutId),o},assignPhotos:function(e,t){function i(e){return n[e]<t[e].length?(n[e]++,t[e][n[e]-1]):null}for(var n={l:0,p:0,s:0},o=[],s=0;s<e.l.length;s++)o[e.l[s]]={photoRefId:i("l")||i("s")||i("p"),finalCrop:[0,0,1,1]};for(var s=0;s<e.p.length;s++)o[e.p[s]]={photoRefId:i("p")||i("s")||i("l"),finalCrop:[0,0,1,1]};for(var s=0;s<e.s.length;s++)o[e.s[s]]={photoRefId:i("s")||i("l")||i("p"),finalCrop:[0,0,1,1]};return o},saveProjectJson:function(e){ThisLife.app.session.getSessionToken().then(function(t){var i={userId:this.userId,token:t,projectJsonStr:JSON.stringify({book:e})};$.ajax({url:this.getMagicCSUrl(),type:"POST",crossDomain:!0,data:JSON.stringify(i),contentType:"application/x-www-form-urlencoded; charset=UTF-8",dataType:"text",success:_.bind(this.saveProjectSuccess,this),error:_.bind(this.saveProjectError,this)})}.bind(this))},saveProjectSuccess:function(e){var t=JSON.parse(e);if(1==t.success){this.projectId=t.productId;var i=this.getProductsUrl();window.location=i}},saveProjectError:function(e){ThisLife.log.error("Collage: Error from creation path server",e)}})}),define("ThisLife.Selection.Helpers.Actions.CollageLayouts",[],function(){function e(e){for(var t,i,n=0;n<e.length;n++){t=e[n],t.config={l:[],p:[],s:[]};for(var o=0;o<t.pattern.length;o++)i=t.pattern[o],t.config.hasOwnProperty(i)&&t.config[i].push(o)}return e}var t={square:[[{id:"10x10_everyday_00_00L00P04S_a_page",pattern:"s"}],[{id:"10x10_everyday_00_00L01P00S_a_page",pattern:"p"},{id:"10x10_everyday_00_01L00P00S_a_page",pattern:"l"},{id:"10x10_universal_00_00L00P01S_z_page",pattern:"s"}],[{id:"10x10_neoclassic_01_01L01P00S_a_page",pattern:"lp"},{id:"10x10_universal_00_02L00P00S_a_page",pattern:"ll"},{id:"10x10_neoclassic_00_00L02P00S_a_page",pattern:"pp"},{id:"10x10_universal_00_00L00P02S_b_page",pattern:"ss"}],[{id:"10x10_universal_00_02L01P00S_a_page",pattern:"llp"},{id:"10x10_universal_00_01L00P02S_a_page",pattern:"lpp"},{id:"10x10_portfolio_00_03L00P00S_c_page",pattern:"lll"},{id:"10x10_everyday_00_00L03P00S_a_page",pattern:"ppp"},{id:"10x10_universal_00_00L00P03S_a_page",pattern:"sss"}],[{id:"10x10_modern_01_00L02P02S_c_page",pattern:"lppl"},{id:"10x10_modern-white_00_01L03P00S_a_page",pattern:"lppp"},{id:"10x10_universal_00_03L01P00S_a_page",pattern:"spss"},{id:"10x10_everyday_00_00L00P04S_a_page",pattern:"ssss"}],[{id:"10x10_neoclassic_00_05L00P00S_b_page",pattern:"lpppp"},{id:"10x10_neoclassic_00_04L01P00S_a_page",pattern:"pllll"},{id:"10x10_everyday_01_01L04P00S_a_page",pattern:"pslpp"},{id:"10x10_universal_01_00L00P05S_b_page",pattern:"sssss"}],[{id:"10x10_portfolio_01_06L00P00S_a_page",pattern:"llllll"},{id:"10x10_modern-white_01_00L06P00S_a_page",pattern:"pppppp"},{id:"10x10_playful_01_03L03P00S_b_page",pattern:"lpppll"},{id:"10x10_neoclassic_00_03L03P00S_a_page",pattern:"pppsss"},{id:"10x10_universal_01_02L00P04S_a_page",pattern:"slssls"}],[{id:"10x10_portfolio_00_06L01P00S_a_page",pattern:"pllllll"},{id:"10x10_universal_00_01L04P02S_a_page",pattern:"pppppls"}],[{id:"10x10_portfolio_01_00L08P00S_a_page",pattern:"pppppppp"},{id:"10x10_portfolio_00_03L05P00S_a_page",pattern:"plpplplp"},{id:"10x10_universal_00_03L00P05S_a_page",pattern:"ssssslll"}],[{id:"10x10_universal_01_09L00P00S_z_page",pattern:"lllllllll"},{id:"10x10_universal_00_06L03P00S_a_page",pattern:"lllllpppl"},{id:"10x10_universal_00_00L00P09S_c_page",pattern:"sssssssss"}]],landscape:[[{id:"7x9_universal_00_00L00P04S_z_page",pattern:"s"}],[{id:"7x9_everyday_00_00L01P00S_a_page",pattern:"p"},{id:"7x9_universal_00_01L00P00S_c_page",pattern:"l"}],[{id:"7x9_universal_00_02L00P00S_a_page",pattern:"ll"},{id:"7x9_universal_00_00L02P00S_b_page",pattern:"pp"},{id:"7x9_everyday_01_01L01P00S_b_page",pattern:"lp"},{id:"7x9_universal_00_00L00P02S_b_page",pattern:"ss"}],[{id:"7x9_portfolio_00_03L00P00S_c_page",pattern:"lll"},{id:"7x9_universal_00_00L01P02S_a_page",pattern:"pll"},{id:"7x9_everyday_00_00L03P00S_a_page",pattern:"ppp"},{id:"7x9_universal_00_01L00P02S_a_page",pattern:"lss"}],[{id:"7x9_everyday_00_00L00P04S_a_page",pattern:"llll"},{id:"7x9_universal_00_03L01P00S_a_page",pattern:"lpll"},{id:"7x9_universal_00_01L03P00S_a_page",pattern:"pppl"},{id:"7x9_universal_00_02L02P00S_z_page",pattern:"lssl"},{id:"7x9_universal_00_00L00P04S_z_page",pattern:"ssss"}],[{id:"7x9_neoclassic_00_05L00P00S_b_page",pattern:"lllll"},{id:"7x9_portfolio_00_04L01P00S_a_page",pattern:"pllll"},{id:"7x9_everyday_01_02L03P00S_a_page",pattern:"sssll"},{id:"7x9_neoclassic_01_01L00P04S_a_page",pattern:"lssss"}],[{id:"7x9_everyday_01_06L00P00S_a_page",pattern:"llllll"},{id:"7x9_universal_00_00L06P00S_a_page",pattern:"pppppp"},{id:"7x9_neoclassic_00_03L03P00S_a_page",pattern:"pppsss"},{id:"7x9_modern_01_00L00P06S_b_page",pattern:"ssssss"}],[{id:"7x9_modern_00_01L04P02S_a_page",pattern:"ppppppl"}],[{id:"7x9_universal_00_03L00P05S_a_page",pattern:"llllllll"},{id:"7x9_portfolio_01_00L08P00S_a_page",pattern:"pppppppp"},{id:"7x9_portfolio_00_03L05P00S_a_page",pattern:"slsslsls"}],[{id:"7x9_portfolio_01_09L00P00S_a_page",pattern:"lllllllll"},{id:"7x9_universal_00_00L00P09S_b_page",pattern:"sssssssss"}]],portrait:[[{id:"11x8_universal_00_00L02P02S_a_page",pattern:"s"}],[{id:"11x8_universal_00_01L00P00S_c_page",pattern:"l"},{id:"11x8_universal_00_00L00P01S_a_page",pattern:"p"},{id:"11x8_universal_00_00L00P01S_z_page",pattern:"s"}],[{id:"11x8_modern_00_02L00P00S_a_page",pattern:"ll"},{id:"11x8_neoclassic_00_00L02P00S_a_page",pattern:"pp"},{id:"11x8_everyday_02_01L01P00S_a_page",pattern:"lp"},{id:"11x8_universal_00_00L00P02S_b_page",pattern:"ss"}],[{id:"11x8_portfolio_00_03L00P00S_b_page",pattern:"lll"},{id:"11x8_universal_00_00L01P02S_a_page",pattern:"ppp"},{id:"11x8_universal_00_02L01P00S_a_page",pattern:"llp"},{id:"11x8_universal_00_01L00P02S_a_page",pattern:"lss"}],[{id:"11x8_neoclassic_01_04L00P00S_b_page",pattern:"llll"},{id:"11x8_neoclassic_00_03L01P00S_a_page",pattern:"plll"},{id:"11x8_modern_01_02L02P00S_a_page",pattern:"lppl"},{id:"11x8_universal_00_01L01P02S_a_page",pattern:"pplp"},{id:"11x8_universal_00_00L00P04S_a_page",pattern:"pppp"},{id:"11x8_universal_00_00L02P02S_a_page",pattern:"pssp"},{id:"11x8_neoclassic_00_00L04P00S_a_page",pattern:"psss"}],[{id:"11x8_modern-white_00_04L01P00S_a_page",pattern:"ppllp"},{id:"11x8_neoclassic_00_05L00P00S_a_page",pattern:"sllll"},{id:"11x8_neoclassic_00_05L00P00S_b_page",pattern:"lssss"}],[{id:"11x8_universal_00_02L02P02S_a_page",pattern:"pllppp"},{id:"11x8_portfolio_01_00L06P00S_a_page",pattern:"pppppp"},{id:"11x8_neoclassic_06_00L00P06S_a_page",pattern:"ssssss"}],[{id:"11x8_portfolio_00_06L01P00S_a_page",pattern:"pllllll"},{id:"11x8_universal_00_01L04P02S_a_page",pattern:"ppplppp"},{id:"11x8_portfolio_00_06L01P00S_a_page",pattern:"pssssss"}],[{id:"11x8_portfolio_00_03L05P00S_a_page",pattern:"pppplppp"}],[{id:"11x8_universal_00_00L00P09S_a_page",pattern:"ppppppppp"},{id:"11x8_universal_00_00L00P09S_c_page",pattern:"sssssssss"}]]};return{getSquare:function(i){return e(t.square[Math.min(i,9)])},getLandscape:function(i){return e(t.landscape[Math.min(i,9)])},getPortrait:function(i){return e(t.portrait[Math.min(i,9)])}}}),function(){define("ThisLife.Selection.Views.CreateButtons",["ThisLife.View.SecondaryBar.CreateBtns"],function(e){var t;return t=Backbone.View.extend({className:"secondary-create-buttons",initialize:function(t){return this.options=null!=t?t:{},this.buttons=new e({selection:this.options.selection,library:ThisLife.app.library,responsiveBP:767}),this},disable:function(){return this.buttons.disableButtons()},enable:function(){return this.buttons.enableButtons()},render:function(){return this.$el.html(this._template()),this},teardown:function(){return this.buttons.remove(),this.remove()},_template:function(){return this.buttons.render().el}})})}.call(this),function(){define("ThisLife.Selection.Views.SelectionBar",[],function(){var e;return e=Backbone.View.extend({className:"selection-bar",events:{"click .close":"_closeSelection"},initialize:function(e){return this.options=null!=e?e:{},this.childView=this.options.childView,this["default"]=this.options["default"],"select_pb"===this["default"]&&(this.mgCallbacks={cancel:this.options.cancelCallback}),"albumCover"===this.options.viewType&&(this.mgCallbacks={cancel:this.options.cancelCallback}),this._bindEvents(),this},render:function(){return this.$el.html(this._template()),this.options.childView&&this.el.querySelector(".selection-content").appendChild(this.options.childView.render().el),document.body.classList.add("select_mode"),this._sendMetrics(),this},remove:function(){var e;return null!=(e=this.childView)&&e.remove(),this.childView=null,this._unbindEvents(),document.body.classList.remove("select_mode"),Backbone.View.prototype.remove.apply(this)},_bindEvents:function(){return ThisLife.Support.keyInformant.on("cancel",this._keyCancel,this)},_unbindEvents:function(){return ThisLife.Support.keyInformant.off("cancel",this._keyCancel,this)},_keyCancel:function(){var e;return this.el.querySelector(".close").classList.contains("disabled")||null!=(e=this.mgCallbacks)&&"function"==typeof e.cancel&&e.cancel(),this.options.selection.done()},_closeSelection:function(){var e,t;return this.el.querySelector(".close").classList.contains("disabled")?void 0:(null!=(e=this.mgCallbacks)&&"function"==typeof e.cancel&&e.cancel(),null!=(t=this.options.childView)&&t.remove(),this.options.selection.done(),ThisLife.PubSub.trigger("selection:closed"))},_sendMetrics:function(){return ThisLife.app.controller("tracking").logClickOpenSelectionBar()},_template:function(){return'<div class="selection-content"></div>\n<a href="javascript:;" class="close"></a>'}})})}.call(this),function(){define("ThisLife.Selection.Views.SelectionBin",["ThisLife.Selection.Views.SelectionBinModel"],function(e){var t;return t=Backbone.View.extend({className:"click_blocker",events:{click:function(e){return e.target.classList.contains("click_blocker")?this.teardown():void 0}},initialize:function(e){return null==e&&(e={}),this.selection=e.selection},render:function(){return this.$el.html(this.template),this.el.querySelector(".selection_bin").classList.add(this.selection.getType()),this.addMoments(),this._cacheElement(),this._bindEvents(),this},_cacheElement:function(){return this.scrollbarEl=this.el.querySelector(".popover_content.scrollbar")},_bindEvents:function(){return ThisLife.Support.keyInformant.on("cancel",this._keyCancel,this)},_unbindEvents:function(){return ThisLife.Support.keyInformant.off("cancel",this._keyCancel,this)},_keyCancel:function(){return this.teardown()},addMoments:function(){var t,i,n,o,s,r,l;for(r=this.el.querySelector("ul"),t=this.selection.getCollection(),s=t.models,i=0,n=s.length;n>i;i++)o=s[i],l=new e({model:o,selection:this.selection}),r.appendChild(l.el);return this},teardown:function(){return this.selection.removeSelectedFromView(),this.enableCloseButton(),this._unbindEvents(),this.remove()},enableCloseButton:function(){var e;return null!=(e=document.body.querySelector(".selection-bar .close"))?e.classList.remove("disabled"):void 0},template:function(){return'<div class="selection_popover_dropdown selection_bin">\n  <div class="popover_content scrollbar">\n    <ul></ul>\n  </div>\n</div>'}})})}.call(this),function(){define("ThisLife.Selection.Views.SelectionBinModel",[],function(){var e,t;return e=100,t=Backbone.View.extend({tagName:"li",className:"moment-scroll-item image",events:{"click .closebtn":"removeMoment"},initialize:function(e){return null==e&&(e={}),this.selection=e.selection,this.render(),this},render:function(){return this.$el.html(this.template(this.model)),this},removeMoment:function(e){var t;return e.stopImmediatePropagation(),this.selection.toggleModels(this.model,e),t=this.el.querySelector(".image_container"),t.style.opacity=0,this.el.classList.add("transition"),_.defer(function(e){return function(){return e.el.classList.add("remove"),_.delay(function(){return e.teardown()},150)}}(this))},teardown:function(){return this.remove()},template:function(t){var i,n;return i=t?t.getImage(e):"",n="video"===(null!=t?t.get("moment_type"):void 0)?'<div class="play_btn"></div>':"",'<div class="image_container selected" style="background-image:url('+i+')">\n   <div class="closebtn"></div>\n   '+n+"\n </div>"}})})}.call(this),function(){define("ThisLife.Selection.Views.Magicshop",[],function(){var e;return e=Backbone.View.extend({className:"magicshop",events:{"click .selection-btn.view-selected":"openSelectionBin","click .add-photos":"addPhotos"},initialize:function(e){var t;return this.options=null!=e?e:{},this.selection=this.options.selection,this.type=null!=(t=this.options.viewTypeOption)?t.toLowerCase():void 0,this},bindEvents:function(){return this.selection.on("change:model_count",this.updateCount,this)},render:function(){return this.$el.html(this._template()),this.cacheElements(),this.bindEvents(),this._setTitle(),this.selection.getCount()>0&&this.updateCount(this.selection.getCount()),this},cacheElements:function(){return this.count=this.el.querySelector(".view-selected .selected-count"),this.selectedView=this.el.querySelector(".view-selected"),this.addPhotos=this.el.querySelector(".add-photos"),this},updateCount:function(e){return 0===parseInt(e)?(this.selectedView.classList.add("empty"),this.addPhotos.classList.add("empty")):(this.selectedView.classList.remove("empty"),this.addPhotos.classList.remove("empty")),this.count.textContent=e},openSelectionBin:function(){return this.selectedView.classList.contains("empty")?void 0:document.querySelector(".click_blocker")?(this.removeSelectedFromView(),this.selection.closeSelectionBin()):(this.selection.openSelectionBin(),this.addSelectedToView())},removeSelectedFromView:function(){return this.selectedView.classList.remove("selected")},addSelectedToView:function(){return setTimeout(function(e){return function(){return e.selectedView.classList.add("selected")}}(this),100)},addPhotos:function(){return this.selection.isEmpty()?void 0:this.options.doneCallback()},_setTitle:function(){var e;return e=this.el.querySelector(".selection_title"),e.innerHTML="photobook"===this.type?"Select at least 20 photos for your book.":"calendar"===this.type?"Select at least 12 photos for you calendar.":"Select photos for your product."},_template:function(){return'<div class="selection_title"></div>\n<a href="javascript:;" class="selection-btn view-selected empty">\n  View Selected <span class="selected-count">0</span>\n</a>\n<a href="javascript:;" class="selection-btn add-photos empty">\n  Add Photos\n</a>\n\n'}})})}.call(this),function(){define("ThisLife.Selection.Views.Selection",["ThisLife.Helper.Features","ThisLife.Helper.Platform"],function(e,t){var i,n;return i={addToAlbum:{action:"addToAlbum","class":"add-to-album",label:"Add to Album"},changeDate:{action:"changeDate","class":"change-date",label:"Change Date"},copyToAlbum:{action:"copyToAlbum","class":"copy-to-album",label:"Copy to album"},createCollage:{action:"createCollage","class":"collage",label:"Digital Collage"},createCollageLandscape:{action:"createCollageLandscape","class":"collage-landscape",label:"Landscape"},createCollagePortrait:{action:"createCollagePortrait","class":"collage-portrait",label:"Portrait"},createCollageSquare:{action:"createCollageSquare","class":"collage-square",label:"Square"},download:{action:"download","class":"download",label:"Download"},email:{action:"shareEmail","class":"share-email",label:"Email"},facebook:{action:"shareFacebook","class":"share-fb",label:"Facebook"},favorite:{action:"favorite","class":"favorite",label:"Favorite"},link:{action:"shareLink","class":"share-link",label:"Link"},manageAlbums:{action:"manageAlbum","class":"manage-albums"},more:{action:"more","class":"more"},moveToAlbum:{action:"moveToAlbum","class":"move-to-album",label:"Move to album"},rotate:{action:"rotate","class":"rotate"},rotateLeft:{label:"Rotate Left",action:"rotate270","class":"rotate-left"},rotateRight:{label:"Rotate Right",action:"rotate90","class":"rotate-right"},removeFromAlbum:{action:"removeFromAlbum","class":"remove-from-album",label:"Remove from album"},save:{action:"save","class":"save-to-account",label:"Save to Account"},share:{action:"share","class":"share",label:"Share"},shareSite:{action:"shareSites","class":"share-sites",label:"Share Sites"},tag:{action:"tag","class":"tag",label:"Tag"},trash:{action:"trash","class":"trash",label:"Add to trash"}},n=Backbone.View.extend({className:"selection",events:{"click .selection-btn:not(.view-selected)":"clickAction","click .selection-btn.view-selected":"openSelectionBin","mouseover .selection-btn":"showTooltip","mouseout .selection-btn":"hideTooltip","mouseenter .flyout-view":"keepFlyout","mouseleave .flyout-view":"hideFlyout"},initialize:function(e){var i,n;return this.options=null!=e?e:{},this.selection=this.options.selection,this._actions=this.selection.getActions(),this.options.state=ThisLife.app.currentState.name,this.flyoutController=ThisLife.app.controller("flyout").get("selection"),i=["favorite","createCollage","share","addToAlbum","manageAlbums","download","rotate","tag","changeDate","save","trash"],n=[],n.push("albums"===this.options.state?"addToAlbum":"manageAlbums"),this.options.isAlbumShared||n.push("save"),t.mobile()&&n.push("share","download","tag"),this.actions=_.difference(i,n),this.orderOrPrints=window.innerWidth>768?"order-prints":"products",this},bindEvents:function(){return this.selection.on("change:model_count",this.updateCount,this),this.debounceResize=_.debounce(_.bind(this.renderIcons,this),100),ThisLife.PubSub.on("resize",this.debounceResize,this)},unbindEvents:function(){return this.selection.off("change:model_count",this.updateCount,this),ThisLife.PubSub.off("resize",this.debounceResize,this)},render:function(){return this.$el.html(this._template()),this.$el.addClass("disableCollage"),e.whenReady("collage",function(e){return function(t){return t?e.$el.removeClass("disableCollage"):void 0}}(this)),this.bindEvents(),this.cacheElements(),this},remove:function(){return this.unbindEvents(),n.__super__.remove.apply(this)},cacheElements:function(){return this.actionsEl=this.el.querySelector(".selection-actions"),this.count=this.el.querySelector(".view-selected .selected-count"),this.selectedView=this.el.querySelector(".view-selected"),this.productsEl=this.el.querySelector(".products"),this.productsOverlayEl=this.el.querySelector(".products-overlay"),this},renderIcons:function(){for(var e,t,n;this.actionsEl.firstChild;)this.actionsEl.firstChild.remove();return n=this._getIconsPosition(),e=n[0],t=n[1],e.reverse().forEach(function(e){return function(t){var n;return n=e._createIcon(i[t]["class"],i[t].action),e.actionsEl.appendChild(n)}}(this)),this.configureMoreFlyout(t)},configureMoreFlyout:function(e){var t,n,o,s;return this.moreIcons=[],0!==e.length?(t=["removeFromAlbum","copyToAlbum","moveToAlbum"],o=["rotateRight","rotateLeft"],s=["email","link","shareSite"],n=["createCollageSquare","createCollageLandscape","createCollagePortrait"],e.forEach(function(e){return function(r){switch(r){case"manageAlbums":t.forEach(function(t){return e.moreIcons.push({label:i[t].label,action:i[t].action,icon:i[t]["class"],classes:[],onClick:e.flyoutAction.bind(e)})});break;case"rotate":o.forEach(function(t){return e.moreIcons.push({label:i[t].label,action:i[t].action,icon:i[t]["class"],classes:[],onClick:e.flyoutAction.bind(e)})});break;case"share":s.forEach(function(t){return e.moreIcons.push({label:i[t].label,action:i[t].action,icon:i[t]["class"],classes:[],onClick:e.flyoutAction.bind(e)})});break;case"createCollage":e.el.classList.contains("disableCollage")||ThisLife.app.isMobile||n.forEach(function(t){return e.moreIcons.push({label:i[t].label,action:i[t].action,icon:i[t]["class"],classes:[],onClick:e.flyoutAction.bind(e)})});break;default:return e.moreIcons.push({label:i[r].label,action:i[r].action,icon:i[r]["class"],classes:[],onClick:e.flyoutAction.bind(e)})}}}(this))):void 0},_getIconsPosition:function(){var e,t,i,n,o;return e=this.actionsEl.offsetWidth,i=56,o=Math.floor(e/i),o<this.actions.length&&o--,t=this.actions.slice(0,o),n=this.actions.slice(o),n.length>0&&t.push("more"),[t,n]},_createIcon:function(e,t){var i;return i=document.createElement("span"),i.setAttribute("data-action",t),i.classList.add("selection-btn"),i.classList.add(e),i},doneShopping:function(){return this.productsEl.classList.remove("selected"),this.selection.enableSelectionActions()},hideAddToAlbum:function(){return ThisLife.app.isMigrating()?this.el.querySelector(".selection-btn.add-to-album").classList.add("hidden"):void 0},removeSelectedFromView:function(){return this.selectedView.classList.remove("selected")},addSelectedToView:function(){return setTimeout(function(e){return function(){return e.selectedView.classList.add("selected")}}(this),100)},updateCount:function(e){return this.count.textContent=e,this.refreshSelectionBar()},refreshSelectionBar:function(){var e;return e=this.el.querySelector(".selection-actions .rotate"),e?this.selection.getCollection().containsVideos()&&e?e.classList.add("hidden"):e.classList.remove("hidden"):void 0},openSelectionBin:function(){return this.selection.getSelectionBin()?(this.removeSelectedFromView(),this.selection.closeSelectionBin()):(this.selection.openSelectionBin(),this.addSelectedToView())},clickAction:function(e){var t,i,n,o,s,r,l,a,u,c,d,h;return i=e.target,t=i.getAttribute("data-action"),null===t||i.classList.contains("disabled")?void 0:"more"===t?i.classList.contains("active")?(null!=(o=this._flyout)&&o.teardown(),this._flyout=null,i.classList.remove("active")):(null!=(n=this._flyout)&&n.teardown(),this._flyout=this.openMoreFlyout(i),i.classList.add("active"),i.appendChild(this._flyout.el)):"manageAlbum"===t?i.classList.contains("active")?(null!=(r=this._flyout)&&r.teardown(),this._flyout=null,i.classList.remove("active")):(null!=(s=this._flyout)&&s.teardown(),this._flyout=this.openManageAlbumFlyout(i),i.classList.add("active"),i.appendChild(this._flyout.el)):"share"===t?i.classList.contains("active")?(null!=(a=this._flyout)&&a.teardown(),this._flyout=null,i.classList.remove("active")):(null!=(l=this._flyout)&&l.teardown(),this._flyout=this.openShareFlyout(i),i.classList.add("active"),i.appendChild(this._flyout.el)):"rotate"===t?i.classList.contains("active")?(null!=(c=this._flyout)&&c.teardown(),this._flyout=null,i.classList.remove("active")):(null!=(u=this._flyout)&&u.teardown(),this._flyout=this.openRotateFlyout(i),i.classList.add("active"),i.appendChild(this._flyout.el)):"createCollage"===t?i.classList.contains("active")?(null!=(h=this._flyout)&&h.teardown(),this._flyout=null,i.classList.remove("active")):(null!=(d=this._flyout)&&d.teardown(),this._flyout=this.openCollageFlyout(i),i.classList.add("active"),i.appendChild(this._flyout.el)):("products"===t&&(i.classList.add("selected"),this.selection.disableSelectionActions()),this.performAction(t,e))},performAction:function(e,t){var i;return null==e&&(i=t.target,e=i.getAttribute("data-action")),this.selection.getSelectionBin()&&(this.removeSelectedFromView(),this.selection.closeSelectionBin()),this._actions.perform({action:e,params:{storyUid:this.options.storyUid}})},showTooltip:function(e){var t,i,n,o,s,r,l,a,u,c,d;return n=e.target,ThisLife.app.isMobile||n.classList.contains("active")?void 0:(t=n.getAttribute("data-action"),"manageAlbum"===t||"more"===t||"share"===t||"createCollage"===t||"rotate"===t?this._flyoutDelay?(clearTimeout(this._flyoutDelay),this._flyoutDelay=null,"manageAlbum"===t&&"manageAlbum"!==this._flyout.options.action?(null!=(o=this._flyout)&&o.teardown(),this._flyout=this.openManageAlbumFlyout(n)):"more"===t&&"more"!==this._flyout.options.action?(null!=(s=this._flyout)&&s.teardown(),this._flyout=this.openMoreFlyout(n)):"share"===t&&"share"!==this._flyout.options.action?(null!=(r=this._flyout)&&r.teardown(),this._flyout=this.openShareFlyout(n)):"createCollage"===t&&"createCollage"!==this._flyout.options.action?(null!=(l=this._flyout)&&l.teardown(),this._flyout=this.openCollageFlyout(n)):"rotate"===t&&"rotate"!==this._flyout.options.action&&(null!=(a=this._flyout)&&a.teardown(),this._flyout=this.openRotateFlyout(n)),n.appendChild(this._flyout.el)):(null!=(u=this._flyout)&&u.teardown(),this._flyout=function(){switch(t){case"manageAlbum":return this.openManageAlbumFlyout(n);case"more":return this.openMoreFlyout(n);case"share":return this.openShareFlyout(n);case"createCollage":return this.openCollageFlyout(n);case"rotate":return this.openRotateFlyout(n)}}.call(this),n.appendChild(this._flyout.el)):(d=function(){switch(t){case"addToAlbum":return"ADD TO ALBUM";case"favorite":return"FAVORITE";case"trash":return"ADD TO TRASH";case"tag":return"TAG";case"changeDate":return"CHANGE DATE";case"download":return"DOWNLOAD";case"save":return"SAVE TO ACCOUNT"}}())?(null!=(c=this._flyout)&&c.teardown(),this._flyout=null,i=t.replace(/[A-Z]/g,function(e){return"-"+e.toLowerCase()}),this._tooltip=this.flyoutController.show({title:d,classes:[i]}),n.appendChild(this._tooltip.el)):void 0)},keepFlyout:function(){return this._flyoutDelay?(clearTimeout(this._flyoutDelay),this._flyoutDelay=null):void 0},hideTooltip:function(e){var t,i,n;return i=e.target,t=i.getAttribute("data-action"),"manageAlbum"!==t&&"more"!==t&&"share"!==t&&"rotate"!==t||i.classList.contains("active")||(this._flyoutDelay=setTimeout(function(e){return function(){var t;return null!=(t=e._flyout)&&t.teardown(),e._flyout=null,e._flyoutDelay=null}}(this),200)),null!=(n=this._tooltip)&&n.teardown(),this._tooltip=null},hideFlyout:function(e){var t,i;for(t=e.target,i=t.parentNode;!i.classList.contains("selection-btn");)i=i.parentNode;return i.classList.contains("active")?void 0:this._flyoutDelay=setTimeout(function(e){return function(){var t;return null!=(t=e._flyout)&&t.teardown(),e._flyout=null,e._flyoutDelay=null}}(this),200)},openMoreFlyout:function(e){return this.flyoutController.show({title:"MORE",action:"more",styles:{"margin-left":"12px"},items:this.moreIcons,onHide:function(){return e.classList.remove("active")}})},openManageAlbumFlyout:function(e){var t;return t=[{label:"Remove",action:"removeFromAlbum",icon:"remove-from-album",onClick:_.bind(this.flyoutAction,this)},{label:"Copy to...",action:"copyToAlbum",icon:"copy-to-album",onClick:_.bind(this.flyoutAction,this)},{label:"Move to...",action:"moveToAlbum",icon:"move-to-album",onClick:_.bind(this.flyoutAction,this)}],this.options.isAlbumShared&&(t=_.filter(t,function(e){return"copyToAlbum"!==e.action})),this.flyoutController.show({title:"MANAGE ALBUMS",action:"manageAlbum",styles:{width:"168px"},items:t,onHide:function(){return e.classList.remove("active")}})},openCollageFlyout:function(e){return this.flyoutController.show({title:"DIGITAL COLLAGE",action:"createCollage",styles:{width:"168px"},items:[{label:"Square",action:"createCollageSquare",icon:"collage-square",onClick:_.bind(this.flyoutAction,this)},{label:"Landscape",action:"createCollageLandscape",icon:"collage-landscape",onClick:_.bind(this.flyoutAction,this)},{label:"Portrait",action:"createCollagePortrait",icon:"collage-portrait",onClick:_.bind(this.flyoutAction,this)}],onHide:function(){return e.classList.remove("active")}})},openShareFlyout:function(e){return this.flyoutController.show({title:"SHARE",action:"share",styles:{width:"168px"},items:[{label:"Email",action:"shareEmail",icon:"share-email",onClick:_.bind(this.flyoutAction,this)},{label:"Link",action:"shareLink",icon:"share-link",classes:["yg-hidden-xs"],onClick:_.bind(this.flyoutAction,this)},{label:"Share Sites",action:"shareSites",icon:"share-sites",classes:["yg-hidden-xs"],onClick:_.bind(this.flyoutAction,this)}],onHide:function(){return e.classList.remove("active")}})},openRotateFlyout:function(e){return this.flyoutController.show({title:"ROTATE",action:"rotate",styles:{width:"168px"},items:[{label:"Rotate Right",action:"rotate90",icon:"rotate-right",onClick:_.bind(this.flyoutAction,this)},{label:"Rotate Left",action:"rotate270",icon:"rotate-left",onClick:_.bind(this.flyoutAction,this)}],onHide:function(){return e.classList.remove("active")}})},flyoutAction:function(e){return this.performAction(e.action),ThisLife.app.controller("flyout").keep("selection")},_template:function(){var e;return e=ThisLife.View.magicShop?!0:!1,'<a href="javascript:;" data-action="products" class="selection-btn products'+(e?"":" hidden")+'">Products</a>\n<a href="javascript:;" data-action="orderPrints" class="selection-btn order-prints yg-hidden-xs yg-hidden-sm '+(e?"":" hidden")+'">Order Prints</a>\n\n<div class="selection-actions"></div>\n\n<a href="javascript:;" class="selection-btn view-selected">\n  View Selected<span class="selected-count"></span>\n</a>\n\n<div class="products-overlay"></div>'
}})})}.call(this),function(){define("ThisLife.Selection.Views.Timeline",["ThisLife.Selection.Helpers.Actions","ThisLife.Helper.String"],function(){var e;return e=Backbone.View.extend({className:"timeline",events:{"click .add-to-album":"addToAlbum","click .selection-btn.view-selected":"openSelectionBin"},initialize:function(e){return this.options=null!=e?e:{},this.selection=this.options.selection,this._actions=this.selection.getActions(),this},bindEvents:function(){return this.selection.on("change:model_count",this.updateCount,this)},render:function(){return this.$el.html(this._template()),this.cacheElements(),this.bindEvents(),this},cacheElements:function(){return this.count=this.el.querySelector(".view-selected .selected-count"),this.selectedView=this.el.querySelector(".view-selected"),this.addPhotos=this.el.querySelector(".add-to-album"),this},updateCount:function(e){return 0===parseInt(e)?(this.selectedView.classList.add("empty"),this.addPhotos.classList.add("empty")):(this.selectedView.classList.remove("empty"),this.addPhotos.classList.remove("empty")),this.count.textContent=e},openSelectionBin:function(){return this.selectedView.classList.contains("empty")?void 0:document.querySelector(".click_blocker")?(this.removeSelectedFromView(),this.selection.closeSelectionBin()):(this.selection.openSelectionBin(),this.addSelectedToView())},removeSelectedFromView:function(){return this.selectedView.classList.remove("selected")},addSelectedToView:function(){return setTimeout(function(e){return function(){return e.selectedView.classList.add("selected")}}(this),100)},addToAlbum:function(){return this.selection.isEmpty()?void 0:this._actions.perform({action:"addDirectToAlbum",params:{navigateToAlbum:!0,storyUid:this.options.storyUid,triggerDone:!0}})},_template:function(){var e,t,i;return e=this.options.selection.getAlbum(),t=ThisLife.Helper.String.escapeHtml(e.get("name")),i=ThisLife.Model.User.isPaidAccount()?"Photos and Videos":"Photos",'<span class="header">Select '+i+'<span> to add to "'+t+'"</span></span>\n\n<a href="javascript:;" class="selection-btn view-selected empty">\n  View Selected <span class="selected-count">0</span>\n</a>\n\n<a href="javascript:;" class="selection-btn add-to-album empty">Add to Album</a>'}})})}.call(this),function(){define("ThisLife.Selection.Views.AlbumCover",["ThisLife.Selection.Helpers.Actions","ThisLife.Helper.String"],function(){var e;return e=Backbone.View.extend({className:"albumCover",initialize:function(e){return this.options=null!=e?e:{},this.selection=this.options.selection,this._actions=this.selection.getActions(),this},render:function(){return this.$el.html(this._template()),this.bindEvents(),this},bindEvents:function(){return this.selection.on("change:model_count",this._momentSelected,this)},unbindEvents:function(){return this.selection.off("change:model_count",null,null)},remove:function(){return this.unbindEvents(),Backbone.View.prototype.remove.apply(this)},_momentSelected:function(){var e;return this._actions.perform({action:"changeAlbumCover",params:{storyUid:this.options.storyUid,triggerDone:!0}}),"function"==typeof(e=this.options).doneCallback?e.doneCallback():void 0},_template:function(){var e,t;return e=this.options.selection.getAlbum(),t=ThisLife.Helper.String.escapeHtml(e.get("name")),'<span class="header">\n  <span class="text large">Select cover photo for "'+t+'".</span>\n  <span class="text small">Select cover photo.</span>\n</span>'}})})}.call(this),function(){var e,t;e=function(){function e(){}return _.extend(e.prototype,Backbone.Events),e.prototype.startSlides=function(e){return this.view=new ThisLife.Slideshow.Views.Slideshow({controller:this,addClassName:e.className}),this.container=e.container,this.slides=e.slides,this.userType=e.userType,this.showSlide(e.startAtSlide||0),document.body.appendChild(this.view.el)},e.prototype.showSlide=function(e){return this.teardownCurrentSlide(),this.slideView=new this.slides[e](this),this.view.showSlide(this.slideView.el),this.currentSlide=e,0===this.currentSlide?this.view.hideLeftArrow():this.view.showLeftArrow(),this.currentSlide===this.slides.length-1?this.view.hideRightArrow():this.view.showRightArrow()},e.prototype.goLeft=function(){return 0!==this.currentSlide?this.showSlide(this.currentSlide-1):void 0},e.prototype.goRight=function(){return this.currentSlide<this.slides.length-1?this.showSlide(this.currentSlide+1):void 0},e.prototype.teardown=function(){return this.teardownCurrentSlide(),this.view.teardown()},e.prototype.teardownCurrentSlide=function(){return this.slideView?(this.slideView.teardown(),this.slideView=null):void 0},e}(),ThisLife.Slideshow||(ThisLife.Slideshow={}),(t=ThisLife.Slideshow).Controllers||(t.Controllers={}),ThisLife.Slideshow.Controllers.Slideshow=e}.call(this),function(){var e,t,i;e=Backbone.View.extend({className:"slideshow popover_wrap",events:function(){return{"mouseup .left_arrow":"goLeft","mouseup .right_arrow":"goRight"}},initialize:function(e){return this.options=e,this.controller=this.options.controller,this.render(),this.cacheElements(),this.bindEvents()},bindEvents:function(){return ThisLife.Support.keyInformant.on("left",this.goLeft,this,!0),ThisLife.Support.keyInformant.on("right",this.goRight,this,!0)},unbindEvents:function(){return ThisLife.Support.keyInformant.off("left",this.goLeft,this,!0),ThisLife.Support.keyInformant.off("right",this.goRight,this,!0)},cacheElements:function(){return this.leftArrow=this.el.querySelector(".left_arrow"),this.rightArrow=this.el.querySelector(".right_arrow"),this.slideDiv=this.el.querySelector(".slide_container")},render:function(){return this.el.insertAdjacentHTML("afterbegin",i(this.options.addClassName)),this},showSlide:function(e){return this.slideDiv.appendChild(e)},goLeft:function(){return this.controller.goLeft()},goRight:function(){return this.controller.goRight()},hideLeftArrow:function(){return $(this.leftArrow).addClass("hidden")},hideRightArrow:function(){return $(this.rightArrow).addClass("hidden")},showLeftArrow:function(){return $(this.leftArrow).removeClass("hidden")},showRightArrow:function(){return $(this.rightArrow).removeClass("hidden")},teardown:function(){return this.unbindEvents(),this.remove()}}),i=function(e){return null==e&&(e=""),'<div class="slideshow_container '+e+"\">\n  <div class='arrow left_arrow'></div>\n  <div class=\"slide_container\"></div>\n  <div class='arrow right_arrow'></div>\n</div>"},ThisLife.Slideshow||(ThisLife.Slideshow={}),(t=ThisLife.Slideshow).Views||(t.Views={}),ThisLife.Slideshow.Views.Slideshow=e}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}};define("ThisLife.Timeline.Controllers.Timeline",["PMCHeimdall","ThisLife.Helper.Features","ThisLife.PubSub","ThisLife.Timeline.Views.Banners.EmptyTimeline","ThisLife.Timeline.Views.Upload"],function(t,i,n,o,s){var r;return r=function(){function r(){this.updateObjects=e(this.updateObjects,this),n.on("state:change",this._stateChange,this),this.layout_size="large",this.sort_attr="moment_date",i.whenReady("upp",function(e){return function(t){return e.useUPP=t}}(this))}return _.extend(r.prototype,Backbone.Events),r.prototype._setHeimdallOptions=function(e){var t;return t={},t=ThisLife.app.isMobile?{top:[{"class":"favorite"},{"class":"view",action:"view"}]}:{top:[{"class":"favorite",action:"favorite"},{"class":"view",action:"view"}],bottom:[{"class":"delete",action:"delete"}]},this._heimdallOptions={clickCallback:_.bind(this._clickHandler,this),trackingCallback:_.bind(this._heimdallTracking,this),container:e,environment:ThisLife.Settings.sflyEnv,layout:"VerticalTimeline",layout_options:{date_summary:{mobile:!0},default_size:this.layout_size,group_by_attr:this.sort_attr,lock_drawer:ThisLife.app.isMobile,moment_icons:t,object_id_attr:"uid",object_sizes:{small:{min_height:125,max_height:150},large:{min_height:200,max_height:300},mobile:{min_height:125,max_height:180}},reverse_sort:!0,sort_by_attr:this.sort_attr},life_uid:null,scrubber:"Yearly",scrubber_options:{vertical:!0},topbar_options:{size_change:!0,sort:!0}}},r.prototype._updateDom=function(){var e;return document.documentElement.classList.add("heimdall"),document.getElementById("library-vertical").classList.add("vertical"),e=document.getElementById("tl_bottom_bar"),e.classList.add("vertical"),e.querySelector(".help_btn").classList.remove("hidden-xs")},r.prototype._showOnboarding=function(){var e;return("function"==typeof(e=ThisLife.Collection.moments).getMomentCount?e.getMomentCount():void 0)>0&&!ThisLife.app.ignoreOnboarding?setTimeout(function(){return function(){var e,t;return(null!=(e=ThisLife.app.currentState)?e.library:void 0)&&"library"===(null!=(t=ThisLife.app.currentState)?t.fragment:void 0)&&!ThisLife.app.controller("onboarding").onboardingViewShown()&&!ThisLife.app.controller("selection").isActive()&&ThisLife.appModel.getOnboardingFlows()?ThisLife.app.controller("onboarding").show(ThisLife.appModel.getOnboardingFlows()):void 0}}(this),250):void 0},r.prototype._centerTimeline=function(){var e,t,i,n;if(null!=(e=ThisLife.app.currentState)?e.library:void 0){if(null!=(t=ThisLife.app.currentState.options)?t.momentUid:void 0)return this.centerOnMoment(ThisLife.app.currentState.options.momentUid);if(null!=(i=ThisLife.app.currentState.options)?i.momentDate:void 0)return n=ThisLife.Helper.Date.parseYYYYMMDD(ThisLife.app.currentState.options.momentDate),this.centerOnDate(n.getTime())}},r.prototype._showTimeline=function(){var e;return this.timeline||(e=ThisLife.Collection.moments.moment_array,null==e&&(e=[]),this.timeline=new t(e,this._heimdallOptions),this._updateBanners(),_.defer(function(e){return function(){return e._centerTimeline()}}(this))),ThisLife.app.controller("visual_search").show()},r.prototype.show=function(){var e;return e=document.getElementById("library-vertical"),this._setHeimdallOptions(e),ThisLife.app.whenReady(function(t){return function(){return t._updateDom(),t._heimdallOptions.life_uid=ThisLife.currentLifeOwner,ThisLife.Collection.moments.whenLoaded(function(){return t._showTimeline(),_.defer(function(){return t._showOnboarding(e)})})}}(this))},r.prototype.remove=function(){var e,t;return document.getElementById("library-vertical").classList.remove("vertical"),e=document.getElementById("tl_bottom_bar"),e.classList.remove("vertical"),e.querySelector(".help_btn").classList.add("hidden-xs"),null!=(t=this.timeline)&&t.clearObjects(),this.timeline=null},r.prototype.upload=function(e,t){var i,n,o;return null==t&&(t=!1),this.useUPP?(ThisLife.app.router.navigateToLibrary(),n=ThisLife.app.controller("uploader"),n.initUPP({labelsContext:"upload"})):(o=new s(e),t?(null!=(i=this._view)&&i.remove(),this._view=o,document.body.appendChild(this._view.el)):o)},r.prototype.getLayoutSize=function(){return this.layout_size},r.prototype.setLayoutSize=function(e,t){return null==t&&(t=!0),"large"===e||"mobile"===e||"small"===e?(this.layout_size=e,t&&this.updateOptions({default_size:e}),!0):!1},r.prototype.getLayoutSort=function(){return this.sort_attr},r.prototype.setLayoutSort=function(e,t){return null==t&&(t=!0),"moment_date"===e||"upload_date"===e?(this.sort_attr=e,t&&this.updateOptions({group_by_attr:e,sort_by_attr:e}),!0):!1},r.prototype.getNextObject=function(e,t){return null!=this.timeline?this.timeline.nextObject(e,t):void 0},r.prototype.getPreviousObject=function(e,t){return null!=this.timeline?this.timeline.previousObject(e,t):void 0},r.prototype.getObjectRange=function(e,t){return null!=this.timeline?this.timeline.objectRange(e,t):void 0},r.prototype.addObjects=function(e){var t;if(null==e&&(e=[]),null!=this.timeline){_.isArray(e)||(e=[e]);try{return this.timeline.addObjects(e),this._updateBanners()}catch(i){switch(t=i,t.message){case"No objects added.":break;default:throw t}}}},r.prototype.removeObjects=function(e){return null==e&&(e=[]),null!=this.timeline?(_.isArray(e)||(e=[e]),this.timeline.removeObjects(e),this._updateBanners()):void 0},r.prototype.momentEdited=function(e,t){var i,n,o,s,r;return null!=this.timeline&&(n=ThisLife.Collection.moments.getModel(e),null!=n&&(t._explicitType&&delete t._explicitType,t.__className&&delete t.__className,r={},o=!1,s=["rating","width","height","hidden"],i=_.keys(t),_.each(i,function(e){return n.get(e)!==t[e]&&-1!==_.indexOf(s,e)?(r[e]=t[e],o=!0):void 0}),o))?(ThisLife.Collection.moments.setModel(e,t),this.updateObjects(e,r)):void 0},r.prototype.updateObjects=function(e,t){var i,n,o,s,r;if(null!=this.timeline&&this.timeline.getObjectCount()>0){for(_.isArray(e)||(e=[e]),s=[],i=0,n=e.length;n>i;i++)o=e[i],s.push(_.extend({uid:o},t));return r=this.timeline.updateObjects(s),this._updateBanners(),0!==r||this.useUPP||ThisLife.app.router.navigateToAdd({replace:!0,trigger:!0}),ThisLife.app.controller("visual_search").updateObjects(s)}},r.prototype.updateOptions=function(e){var t;return null==e&&(e={}),null!=(t=this.timeline)?t.updateLayoutOptions(e):void 0},r.prototype.centerOnMoment=function(e){return null!=this.timeline?this.timeline.scrollToObject(e):void 0},r.prototype.centerOnDate=function(e){return null!=this.timeline?this.timeline.scrollToDate(e):void 0},r.prototype.scrollToDate=function(e,t){return null!=this.timeline?this.timeline.scrollToDate(e,t):void 0},r.prototype.disableScroll=function(){var e;return null!=(e=this.timeline)?e.disableScroll():void 0},r.prototype.enableScroll=function(){var e;return null!=(e=this.timeline)?e.enableScroll():void 0},r.prototype._stateChange=function(e){var t,i,n,o,s,r,l,a,u;return"timeline"!==e.name&&(this.timeline&&(null!=(t=this._heimdallOptions)&&null!=(i=t.banners)?i.header:void 0)&&"1"===ThisLife.appModel.getOnboarding()&&(this._heimdallOptions.banners.header=void 0,this.timeline.updateOptions({banners:{header:this._heimdallOptions.banners.header}})),null!=(n=this._view)&&n.remove(),this._view=null,null!=(o=ThisLife.app.controller("onboarding"))&&o.hide()),e.library&&this._showOnboarding(),"library"===e.name&&"albums"===(null!=(s=e.previous)?s.name:void 0)&&"album"===(null!=(r=e.previous)&&null!=(l=r.options)?l.view:void 0)&&(null!=(a=ThisLife.app.controller("selection"))?a.isActive():void 0)&&null!=(u=ThisLife.app.controller("selection"))?u.done():void 0},r.prototype._updateBanners=function(){var e,t;return t=!1,0===ThisLife.Collection.moments.getNumVisible()?(t=!0,this._emptyView=new o,e={el:this._emptyView.el,height:180}):(this._emptyView&&(t=!0,this._emptyView.teardown(),this._emptyView=null),e=null),t?this.timeline.updateLayoutOptions(_.extend({},{banners:{footer:e}})):void 0},r.prototype._heimdallTracking=function(e){return e.constructor===Array?_.each(e,function(e){return function(t){return e._trackMetric(t)}}(this)):this._trackMetric(e)},r.prototype._trackMetric=function(e){if("time"===e.type){if("firstPhoto"===e.name)return ThisLife.app.controller("timing").loadOrLoginEvent("Timeline",e.value)}else if("click"!==e.type)return ThisLife.app.controller("tracking").logClickTimeline(e.name,e.type)},r.prototype._clickHandler=function(e,t,i){var n,o,s,r,l,a,u,c,d,h,p;for(_.isArray(e)||(e=[e]),s=[],r=0,a=e.length;a>r;r++)p=e[r],s.push(ThisLife.Collection.moments.getModel(p));switch(t){case"delete":ThisLife.app.controller("trash")["delete"](e),ThisLife.app.controller("selection").removeModels(s);break;case"favorite":for(l=0,u=s.length;u>l;l++)c=s[l],c.saveRating(3-c.get("rating"));break;case"layout-change":h=i.size,this.setLayoutSize(h,!1);break;case"play":this._playVideo(s[0]);break;case"click":ThisLife.app.controller("selection").toggleModels(s[0],{event:i});break;case"select":s.length>1?(n=_.every(s,function(e){return ThisLife.app.controller("selection").hasModel(e)}),n?ThisLife.app.controller("selection").removeModels(s):ThisLife.app.controller("selection").addModels(s)):ThisLife.app.controller("selection").toggleModels(s[0],{event:i});break;case"sort":o="moment_date"===i?"momentDate":"uploadDate",ThisLife.Collection.moments.setSort(o),this.setLayoutSort(i,!1);break;case"view":null==(null!=(d=ThisLife.app.controller("selection"))?d.getAlbumCollection():void 0)&&ThisLife.app.router.navigateToFullView(s[0].id)}},r.prototype._playVideo=function(e){var t;return null!=e?(_.contains(_.pluck(afterglow.lightboxtriggers,"playerid"),"video-"+e.id)||(document.body.insertAdjacentHTML("beforeend",this._playerTemplate(e)),afterglow.prepareLightboxVideos(),null!=(t=$("#video-container-"+e.id))&&t.remove()),afterglow.play("video-"+e.id),ThisLife.app.isMobile&&this.el.classList.add("mobile_hover"),_.defer(function(){return function(){var t;null!=(t=document.getElementById("video-"+e.id))&&t.focus(),afterglow.getPlayer("video-"+e.id)&&(afterglow.getPlayer("video-"+e.id).on("ended",function(){document.getElementById("video-"+e.id).focus()}),afterglow.getPlayer("video-"+e.id).on("error",function(){$("#video-"+e.id).click(function(){afterglow.closeLightbox()})}))}}(this))):void 0},r.prototype._playerTemplate=function(e,t){var i,n,o;return null==t&&(t={width:e.get("width"),height:e.get("height")}),n=e.get("story_moment_created_by")||ThisLife.currentLifeOwner,i=ThisLife.Settings.s3VideoUrl+"/"+n+"/"+e.id+"_medium.mp4",o=ThisLife.Settings.s3VideoUrl+"/"+n+"/"+e.id+"_small.mp4",'<div id="video-container-'+e.id+'" style="display: none;">\n  <a class="afterglow action_video" href="#video-'+e.id+'"></a>\n  <video id="video-'+e.id+'" data-skin="dark" width="'+t.width+'" height="'+t.height+'" data-autoresize="fit">\n    <source type="video/mp4" src="'+i+'" data-quality="hd">\n    <source type="video/mp4" src="'+o+'">\n  </video>\n</div>'},r}()})}.call(this),function(){define("ThisLife.Timeline.Views.Upload",["ThisLife.Timeline.Views.Widgets.AddFromTimeline","ThisLife.Timeline.Views.Widgets.EmptyPeople","ThisLife.Timeline.Views.Widgets.EmptyTags","ThisLife.Timeline.Views.Widgets.SendLink","ThisLife.Timeline.Views.Widgets.SocialImport","ThisLife.Timeline.Views.Widgets.Uploader","ThisLife.Uploader.Views.Uploader"],function(e,t,i,n,o,s,r){var l,a;return a={AddFromTimeline:e,EmptyPeople:t,EmptyTags:i,SendLink:n,SocialImport:o,Uploader:s},l=Backbone.View.extend({className:"dropandselect_upload",initialize:function(e){return this.options=null!=e?e:{},this.momentsText=this.options.momentsText,this.noWidgetHeader=this.options.noWidgetHeader,this.widgetHeader=this.options.widgetHeader,this.widgets=this.options.widgets,ThisLife.Collection.moments.on("change:hidden",this._onCollectionChangeHidden,this),0!==ThisLife.Collection.moments.getMomentCount()&&ThisLife.app.isPreviousState("trash")?void ThisLife.app.router.navigate("library"):this.render()},_onCollectionChangeHidden:function(e){return!e.get("hidden")&&ThisLife.app.isSameFragment("add")&&1===ThisLife.Collection.moments.getMomentCount()?ThisLife.app.router.navigate("library"):void 0},render:function(){var e;return this.subviews=[],this.$el.html(this._template()),this.uploadView=new r,null!=(e=this.el.querySelector(".upload-buttons"))&&e.appendChild(this.uploadView.el),Dropzone.dragAndDropSupport||($(this.el.querySelector(".header-text")).text(""),$(this.el.querySelector(".suffix-text")).text("")),this.uploadContainerEl=this.el.querySelector("div.upload-container"),this.headerTextEl=this.el.querySelector("div.upload-container div.dropzone-content .header-text"),this.widgetPlaceholderEl=this.el.querySelector("div.upload-container .right"),this._appendWidgets()},_appendWidgets:function(){var e,t,i,n,o,s,r,l,u,c;if(_.isEmpty(this.widgets))this._defaultWidgets();else for(o=this.widgets,e=0,i=o.length;i>e;e++)c=o[e],this.subviews.push(new a[c]);for(s=this.subviews,l=[],t=0,n=s.length;n>t;t++)u=s[t],l.push(null!=(r=this.widgetPlaceholderEl)?r.appendChild(u.el):void 0);return l},_defaultWidgets:function(){var e,t,i,r;return ThisLife.Helper.Platform.macOSX()?(e=new s({title:"Automatic uploads from your Mac",uploader:"Desktop Uploader",imageClass:"laptop_macbook",rootClass:"mac-uploader-widget"}),ThisLife.Helper.Platform.macOSXVersion()>=10&&(t=new s({title:"Export directly from Photos",uploader:"Photos Extension",imageClass:"mac_photos_extension",rootClass:"photos-extension-uploader-widget"}))):ThisLife.Helper.Platform.windows()&&(e=new s({title:"Automatic uploads from your PC",uploader:"Desktop Uploader",imageClass:"laptop_windows",rootClass:"windows-uploader-widget"})),i=new n,r=new o,this.subviews.push(i),this.subviews.push(r)},remove:function(){return _.each(this.subviews,function(e){return e.remove()}),Backbone.View.prototype.remove.apply(this)},_template:function(){var e;return null==this.momentsText&&(this.momentsText="Drag and drop to upload anytime, anywhere!"),e=this.noWidgetHeader?"":this.widgetHeader?"<h1>"+this.widgetHeader+"</h1>":"<h1>Other ways to upload</h1>",'<div class="upload-container">\n  <div class="left">\n    <div class="dropzone-content">\n      <div class=\'cloud-upload-image\'></div>\n      <div class=\'header-text\'>\n        '+this.momentsText+"\n      </div>\n      <!-- Upload buttons holder-->\n      <div class='upload-buttons-parent'>\n        <div class='upload-buttons'></div>\n      </div>\n    </div>\n  </div>\n  <!-- Widget Placeholder-->\n  <div class=\"right\">"+e+"</div>\n</div>"}})})}.call(this),function(){define("ThisLife.Timeline.Views.Banners.EmptyTimeline",[],function(){var e;return e=Backbone.View.extend({className:"banner empty-timeline",initialize:function(){return this.render(),this},render:function(){return this.el.insertAdjacentHTML("afterbegin",this._template()),this},teardown:function(){return this.remove()},_template:function(){return'<div class="content-wrap">\n  <div class="header">Unlimited free photos storage</div>\n  <div class="message">Click Upload or Drag and Drop to start uploading.</div>\n  <div class="message-mweb">You don\'t have any photos yet. Click upload <div class="upload-icon"></div> to start uploading.</div>\n</div>'}})})}.call(this),function(){define("ThisLife.Timeline.Views.Widgets.SendLink",[],function(){var e;return e=Backbone.View.extend({className:"widget-base widget-send-link",events:{"click .send-link":"sendLink","click .warning-icon":"resetInput","click .wrong-number":"wrongNumber","keypress .phone-input":"enterToSend"},initialize:function(){return this.render(),this.cacheElements()},render:function(){return this.$el.html(this._template())},cacheElements:function(){return this.input=this.el.querySelector(".phone-input"),this.content=this.el.querySelector(".send-link-content"),this.wrapper=this.el.querySelector(".send-to-phone"),this.tooltip=this.el.querySelector(".warning-tooltip"),this.overlay=this.el.querySelector(".success-overlay"),this},enterToSend:function(e){return 13===e.keyCode?this.sendLink():void 0},resetInput:function(){return this.clearInvalid(),this.input.focus()},clearInvalid:function(){var e;return this.input.value="",null!=(e=this.wrapper)?e.classList.remove("invalid"):void 0},wrongNumber:function(){return this.content.classList.remove("success"),this.resetInput()},sendLink:function(){return this.input?(this.phoneNumber=this.input.value,this.input.setAttribute("disabled","disabled"),ThisLife.Helper.Validate.phone(this.phoneNumber)?ThisLife.Service.api.sendText(this.phoneNumber,_.bind(this.onSuccess,this),_.bind(this.onError,this)):void this.onError()):void 0},onSuccess:function(){return this.input.removeAttribute("disabled","disabled"),this.content.classList.add("success"),this.overlay.querySelector(".phone-number").innerText=this.phoneNumber,ThisLife.app.controller("tracking").logClickUploadOption("app send")},onError:function(){return this.input.removeAttribute("disabled","disabled"),this.wrapper.classList.add("invalid"),$(this.tooltip).text("Invalid number, try again")},_template:function(){return'<h2>Easily get photos from your phone</h2>\n<div class="send-link-content">\n  <ul class="device-list">\n    <li class="shutterfly"></li>\n    <li class="apple"></li>\n    <li class="android"></li>\n    <li class="amazon"></li>\n  </ul>\n  <div class="info">\n    <div>Send a link to your phone to install the app</div>\n    <div class="send-to-phone">\n      <input type="text" class="phone-input" placeholder="Phone number" />\n      <span class="gray-btn send-link">Send</span>\n      <div class="warning-icon"></div>\n      <div class="warning-tooltip"></div>\n    </div>\n  </div>\n  <div class="success-overlay">\n    <div class="checkcircle"></div>\n    <div class="phone-number"></div>\n    <div>\n      <span class="wrong-number">Wrong number?</span>\n    </div>\n  </div>\n</div>'}})})}.call(this),function(){define("ThisLife.Timeline.Views.Widgets.Uploader",[],function(){var e;return e=Backbone.View.extend({className:"widget-base uploader-widget",events:{"click div.step-one-action a.orange-btn":"download","click div.step-two-action a.show-instructions":"showInstructions","click div.step-two-action a:not(.show-instructions)":"tryAgain"},initialize:function(e){return this.options=null!=e?e:{},this.render()},render:function(){return this.$el.html(this._template())},download:function(){return ThisLife.Helper.URL.downloadViaIframe("mac_photos_extension"===this.options.imageClass?ThisLife.Settings.macPhotosExtensionUrl():ThisLife.Settings.uploaderUrl()),this._toggleViews(!1)},tryAgain:function(){return this._toggleViews(!0)},showInstructions:function(){return ThisLife.Helper.URL.open("shutterfly_mac_photos_extension_instructions",ThisLife.Settings.macPhotosExtnInstructionsUrl())},_toggleViews:function(e){var t;return t="div.uploader-widget div."+this.options.rootClass,e?(document.querySelector(t+" div.step-one").classList.remove("hidden"),document.querySelector(t+" div.step-two").classList.add("hidden")):(document.querySelector(t+" div.step-one").classList.add("hidden"),document.querySelector(t+" div.step-two").classList.remove("hidden"))},_template:function(){var e,t,i,n,o;return n=this.options.title,e=this.options.imageClass,o=this.options.uploader,i=this._stepTwoLinksTemplate(),t=this.options.rootClass,'<div class="'+t+'">\n  <div class="step-one">\n    <h2>'+n+'</h2>\n    <div class="'+e+'"></div>\n    <div class="step-one-action">\n      <a class="orange-btn">Get '+o+'</a>\n    </div>\n  </div>\n  <div class="step-two hidden">\n    <h2>Thanks!</h2>\n    <p>Please check your download directory for the '+o+' installer.</p>\n    <div class="step-two-action">\n      '+i+"\n    </div>\n  </div>\n</div>"},_stepTwoLinksTemplate:function(){return"mac_photos_extension"===this.options.imageClass?'<a class="show-instructions">Detailed instructions</a> <span>-</span> <a>Try again</a>':"<a>Try again</a>"}})})}.call(this),function(){define("ThisLife.Timeline.Views.Widgets.SocialImport",[],function(){var e;return e=Backbone.View.extend({className:"widget-base social-import-widget",events:{"click ul.social-icons li":"showSocialImportModal"},initialize:function(){return this.render()},render:function(){return this.$el.html(this._template())},showSocialImportModal:function(e){var t;return t=e.currentTarget.className,ThisLife.app.controller("tracking").logClickUploadOption(t),ThisLife.app.showModal("social_import_widget",{tab:t},!0)},_template:function(){return'<h2>Connect to the places you store your Photos</h2>\n<ul class="social-icons">\n  <li class="facebook"></li>\n  <li class="instagram"></li>\n  <li class="flickr"></li>\n  <li class="smugmug"></li>\n  <li class="picasa"></li>\n</ul>'}})})}.call(this),function(){define("ThisLife.Timeline.Views.Widgets.AddFromTimeline",[],function(){var e;return e=Backbone.View.extend({className:"widget-base add-from-timeline-widget",events:{"click div.add-from-timeline-widget div.footer a.flat-orange-btn":"addFromTimeline"},initialize:function(e){return this.album=e.album,this.render()},render:function(){return this.$el.html(this._template())},addFromTimeline:function(){var e,t,i;return t=this.album.getCollection().getFirstPhotoOrVideo(),null!=t&&(e=ThisLife.Collection.moments.get(t.id),null==e&&(i=new Date(ThisLife.Helper.Date.humanDateUTC(t.get("moment_date"))),e=_.find(ThisLife.Collection.moments.models,function(e){var t;return t=new Date(ThisLife.Helper.Date.humanDateUTC(e.get("moment_date"))),ThisLife.Helper.Date.areEqual(t,i)}))),ThisLife.app.controller("selection").start({collection:this.album.getCollection(),models:e,replaceUrl:!0,storyUid:ThisLife.storyUid,viewType:"timeline"})},_template:function(){return'<h2>Select from All Photos</h2>\n<!--image-->\n<div class="add-from-timeline-image"></div>\n<div class="footer">\n  <a class="flat-orange-btn">Select from All Photos</a>\n</div>'}})})}.call(this),function(){define("ThisLife.Timeline.Views.Widgets.EmptyPeople",[],function(){var e;return e=Backbone.View.extend({className:"widget-base empty-people-help-widget",initialize:function(e){return this.options=null!=e?e:{},this.render()},render:function(){return this.$el.html(this._template())},_template:function(){return"<h2>What is People view?</h2>\n<div class='text'>\n We automatically find similar faces for you. This allows you to easily search and find the photos of the people you love.\n</div>\n</div>"}})})}.call(this),function(){define("ThisLife.Timeline.Views.Widgets.EmptyTags",[],function(){var e;return e=Backbone.View.extend({className:"widget-base empty-tags-help-widget",initialize:function(e){return this.options=null!=e?e:{},this.render()},render:function(){return this.$el.html(this._template())},_template:function(){return"<h2>What is Tags view?</h2>\n<div class='text'>\n  Tag photos with whatever you choose. Use the tags in your search to find photos easily.\n</div>\n</div>"}})})}.call(this),function(){define("ThisLife.Tracking.Controllers.Tracking",["ThisLife.Tracking.Controllers.DTLController","ThisLife.Tracking.Controllers.SCController"],function(e,t){var i,n;return i="generic event",n=function(){function n(){}return n.prototype._isDTLEnabled=function(){return window.DTLSiteFeatureEnabled},n.prototype.setup=function(i){return this._hasLoggedFirstPage=!1,this._isDTLEnabled()?e.setup(i):t.setup(i)},n.prototype.logPageEvent=function(t,i,n){var o,s,r,l,a,u,c,d,h,p,f,m,g,v;if(t&&"string"==typeof t)return"appalbum"===t&&(null!=n&&null!=(r=n.options)?r.album_uid:void 0)&&(o=null!=(l=ThisLife.app)&&"function"==typeof l.controller&&null!=(a=l.controller("albums"))?a.getAlbumById(n.options.album_uid):void 0,o&&(s=o.isOwner(ThisLife.Model.User.id)?"my album":"shared album",g={albumType:s})),i||(t=t.split("/")[0]),t=t.split("?")[0],this._isDTLEnabled()?("sign in confirmation"!==(null!=(u=window.BaseADTMD)&&null!=(c=u.event)&&null!=(d=c.eventInfo)?d.eventName:void 0)||this._hasLoggedFirstPage||(v=null!=(h=window.BaseADTMD)&&null!=(p=h.session)&&null!=(f=p.visitorDetails)?f.customerId:void 0,this.logSignInConfirmation(v)),e.logPageEvent(t,g)):null!=(m=ThisLife.SC)&&m.logPageEvent(t),this._hasLoggedFirstPage=!0},n.prototype.logClickAlbumsChangeSort=function(t){var n,o,s;return o="Sort:click-"+t,this._isDTLEnabled()?(n=e.createEventData(i,o),e.logEvent(n,{method:"logClickAlbumsChangeSort"})):null!=(s=ThisLife.SC)?s.logStoreLinkClick({pageName:"appfolder",linkName:o}):void 0},n.prototype.logClickAlbumsCoverAction=function(t){var n,o,s;return o="AlbumAction:click-"+t,this._isDTLEnabled()?(n=e.createEventData(i,o),e.logEvent(n,{method:"logClickAlbumsCoverAction"})):null!=(s=ThisLife.SC)?s.logNavigationClick({pageName:"appfolder",linkName:o}):void 0},n.prototype.logAlbumGridItemEvent=function(t){var n,o,s,r;return s={albumActionHover:"AlbumAction:hover"},(o=s[t])?this._isDTLEnabled()?(n=e.createEventData(i,o),e.logEvent(n,{method:"logAlbumGridItemEvent"})):null!=(r=ThisLife.SC)?r.logNavigationClick({pageName:"appfolder",linkName:o}):void 0:void 0},n.prototype.logClickAlbumAction=function(t){var n,o,s;switch(t){case"select_album":case"month_pill":o="Select:click-"+t;break;case"small_view":case"large_view":o="View:click-"+t}if(o)return this._isDTLEnabled()?(n=e.createEventData(i,o),e.logEvent(n,{method:"logClickAlbumAction"})):null!=(s=ThisLife.SC)?s.logLinkClick({pageName:"sflyphotos/appalbum",linkName:o}):void 0},n.prototype.logClickAlbumActionMenu=function(t,n){var o,s,r;switch(t){case"sort":s="AlbumMenu:sort-"+n;break;default:s="AlbumMenu:click-"+t}return this._isDTLEnabled()?(o=e.createEventData(i,s),e.logEvent(o,{method:"logClickAlbumActionMenu"})):null!=(r=ThisLife.SC)?r.logLinkClick({pageName:"sflyphotos/appalbum",linkName:s}):void 0},n.prototype.logClickAlbumHeader=function(t){var n,o,s;switch(t){case"add_photos":case"slideshow":case"share":case"print_all":case"make_book":case"make_product":case"change_cover":case"save":case"download":o="AlbumHeader:click-"+t;break;case"select_album":case"month_pill":o="Select:click-"+t;break;case"small_view":case"large_view":o="View:click-"+t}if(o)return this._isDTLEnabled()?(n=e.createEventData(i,o),e.logEvent(n,{method:"logClickAlbumHeader"})):null!=(s=ThisLife.SC)?s.logLinkClick({pageName:"sflyphotos/appalbum",linkName:o}):void 0
},n.prototype.logClickShareAddressBook=function(){var t,n,o;return n="ShareEmail:click-AddressBook",this._isDTLEnabled()?(t=e.createEventData(i,n),e.logEvent(t,{method:"logClickShareAddressBook"})):null!=(o=ThisLife.SC)?o.logLinkClick({pageName:"sflyphotos/applibrary/ShareEmail",linkName:n}):void 0},n.prototype.logSharePost=function(t){var n,o,s,r;if(t&&"string"==typeof t)return o="Select:post-Share"+t.capitalize(),this._isDTLEnabled()?(n=e.createEventData(i,o),e.logEvent(n,{method:"logSharePost"})):(s="albums"===ThisLife.app.currentState.name?"appalbum":"applibrary",null!=(r=ThisLife.SC)?r.logLinkClick({pageName:s,linkName:o}):void 0)},n.prototype.logAlbumShare=function(t,n){var o,s,r,l;return null==n&&(n={}),r={postEmail:"Albums:post-ShareEmail",postFacebook:"Albums:post-ShareFacebook",clickFacebook:"Albums:click-ShareFacebook",clickLink:"Albums:click-ShareLink"},(s=r[t])?this._isDTLEnabled()?(o=e.createEventData(i,s,n),e.logEvent(o,{method:"logAlbumShare"})):(o=_.extend({pageName:"appfolder",linkName:s},n),null!=(l=ThisLife.SC)?l.logLinkClick(o):void 0):void 0},n.prototype.logAlbumUnshare=function(){var t;if(this._isDTLEnabled())return t=e.createEventData(i,"Unshare"),e.logEvent(t,{method:"logAlbumUnshare"})},n.prototype.logAlbumShareStatus=function(t){var n,o;return this._isDTLEnabled()?(n=e.createEventData(i,"share album:"+t),e.logEvent(n,{method:"logAlbumShareStatus"})):(n={pageName:"sflyphotos/applibrary",linkName:"share album:"+t},null!=(o=ThisLife.SC)?o.logLinkClick(n):void 0)},n.prototype.logClickFMVEdit=function(){var t,n,o;return n="click: edit",this._isDTLEnabled()?(t=e.createEventData(i,n),e.logEvent(t,{method:"logClickFMVEdit"})):null!=(o=ThisLife.SC)?o.logLinkClick({pageName:"sflyphotos/appfull",linkName:n}):void 0},n.prototype.logClickFMVDelete=function(){var t,n,o;return n="DeleteMoment:click",this._isDTLEnabled()?(t=e.createEventData(i,n),e.logEvent(t,{method:"logClickFMVDelete"})):null!=(o=ThisLife.SC)?o.logNavigationClick({pageName:"appfull",linkName:n}):void 0},n.prototype.logFMVSave=function(){var t,n,o;return n="Moment:click-Save",this._isDTLEnabled()?(t=e.createEventData(i,n),e.logEvent(t,{method:"logFMVSave"})):null!=(o=ThisLife.SC)?o.logNavigationClick({pageName:"appfull",linkName:n}):void 0},n.prototype.logFMVShare=function(t){var n,o,s,r;if(this._isDTLEnabled()&&"string"==typeof t&&""!==t&&(s={email:"Email",link:"Link",share_sites:"Sites",facebook:"Facebook"},r=s[t]))return o="Select:click-Share"+r+"_FMV",n=e.createEventData(i,o),e.logEvent(n,{method:"logFMVShare"})},n.prototype.logClickFMVMobileCreateProduct=function(){var t,n,o;return n="Mobile-MakeProduct:click",this._isDTLEnabled()?(t=e.createEventData(i,n),e.logEvent(t,{method:"logClickFMVMobileCreateProduct"})):null!=(o=ThisLife.SC)?o.logNavigationClick({pageName:"appfull",linkName:n}):void 0},n.prototype.logClickOpenSelectionBar=function(){var t,n,o,s;return n="Select",this._isDTLEnabled()?(t=e.createEventData(i,n),e.logEvent(t,{method:"logClickOpenSelectionBar"})):(o="albums"===ThisLife.app.currentState.name?"appalbum":"applibrary",null!=(s=ThisLife.SC)?s.logNavigationClick({pageName:o,linkName:n}):void 0)},n.prototype.logClickSelectionAction=function(t){var n,o,s,r,l;return s={products:"Select:click-Products",orderPrints:"Select:click-OrderPrints",openBin:"Select:open-SelectionBin",closeBin:"Select:close-SelectionBin",addToAlbum:"Select:click-AddToAlbum",removeFromAlbum:"Select/Album:click-RemoveFromAlbum",moveToAlbum:"Select/Album:click-MoveToAlbum",copyToAlbum:"Select/Album:click-CopyToAlbum",favorite:"Select:click-Favorite",trash:"Select:click-Delete",rotate:"Select:click-Rotate",tag:"Select:click-Tag",changeDate:"Select:click-ChangeDate",download:"Select:click-Download",save:"Select:click-Save",shareEmail:"Select:click-ShareEmail",shareLink:"Select:click-ShareLink",shareSites:"Select:click-ShareSites",shareFacebook:"Select:click-ShareFacebook",shareTwitter:"Select:click-ShareTwitter",shareTumblr:"Select:click-ShareTumblr"},o=s[t]||"Selection:"+t,this._isDTLEnabled()?(n=e.createEventData(i,o),e.logEvent(n,{method:"logClickSelectionAction"})):(r="albums"===ThisLife.app.currentState.name?"appalbum/Select":"applibrary/Select",null!=(l=ThisLife.SC)?l.logNavigationClick({pageName:r,linkName:o}):void 0)},n.prototype.logClickTimeline=function(t,n){var o,s,r,l;return"remove"===n&&(n="RemoveFromAlbum"),r={click:"Moment:click-"+n,"double-click":"Moment:double-click-"+n,"layout-change":"View:click-"+n+"_view","scroll-to":"Scrubber:click-scrub_bar","scroll-drag":"Scrubber:drag-scrub_bar","select-group":"Select:click-"+n+"_pill",sort:"Sort:click-"+n},(s=r[t])?this._isDTLEnabled()?"click"!==t||"RemoveFromAlbum"!==n&&"delete"!==n&&"favorite"!==n?(o=e.createEventData(i,s),e.logEvent(o,{method:"logClickTimeline"})):window._satellite.track(s):null!=(l=ThisLife.SC)?l.logNavigationClick({pageName:"applibrary",linkName:s}):void 0:void 0},n.prototype.logClickTrashRestoreAll=function(){var t,n,o;return n="restore all moments",this._isDTLEnabled()?(t=e.createEventData(i,n),e.logEvent(t,{method:"logClickTrashRestoreAll"})):null!=(o=ThisLife.SC)?o.logPageLinkClick({pageName:"apptrash",linkName:n}):void 0},n.prototype.logClickTrashEmptyAll=function(){var t,n,o;return n="empty trash can",this._isDTLEnabled()?(t=e.createEventData(i,n),e.logEvent(t,{method:"logClickTrashEmptyAll"})):null!=(o=ThisLife.SC)?o.logPageLinkClick({pageName:"apptrash",linkName:n}):void 0},n.prototype.logClickTrashClose=function(){var e;if(!this._isDTLEnabled())return null!=(e=ThisLife.SC)?e.logPageLinkClick({pageName:"apptrash",linkName:"close trash modal"}):void 0},n.prototype.logClickUploadToastViewUpload=function(){var e;if(!this._isDTLEnabled())return null!=(e=ThisLife.SC)?e.logPageLinkClick({pageName:"uploadprogressmodal",linkName:"recently uploaded - view uploaded"}):void 0},n.prototype.logClickUploadToastButton=function(t){var n,o,s,r,l;return s={addToAlbum:"AddToAlbum:click",viewUploaded:"ViewUploaded:click"},(o=s[t])?this._isDTLEnabled()?(n=e.createEventData(i,o),e.logEvent(n,{method:"logClickUploadToastButton"})):(r="albums"===ThisLife.app.currentState.name?"appalbum":"applibrary",null!=(l=ThisLife.SC)?l.logNavigationClick({pageName:r,linkName:o}):void 0):void 0},n.prototype.logUploadPhotos=function(){var e,t;if(this._isDTLEnabled())try{return window._satellite.track("uniup upload")}catch(i){return e=i,t={area:"dtm",exception:e.message,method:"logUploadPhotos"},ThisLife.app.controller("timing").recordInfo("exception",t)}},n.prototype.logClickUploadOption=function(t){var n,o;if(this._isDTLEnabled())return o="upload options:"+t,n=e.createEventData(i,o),e.logEvent(n,{method:"logClickUploadOption"})},n.prototype.logClickVisualSearchOpen=function(){var t,n,o;return n="photos search initiate",this._isDTLEnabled()?(t=e.createEventData(i,n),e.logEvent(t,{method:"logClickVisualSearchOpen"})):null!=(o=ThisLife.SC)?o.logVisualSearchOpenClick({pageName:"sflyphotos/applibrary",linkName:n,events:"event120"}):void 0},n.prototype.logClickVisualSearchEvent=function(t,n){var o,s,r,l;return r={search_window_closed:"photos search close",clear_all_clicked:"photos search exit:clear all",cleared_last_pill:"photos search exit:clear filter",filter_selected:"photos search filter:"+n,search_term_typed:"photos search:typed",show_fewer_click:"photos search show fewer:"+n,show_all_click:"photos search show all:"+n,selection_pill_count:"Search:click-select_all"},(s=r[t])?this._isDTLEnabled()?(o=e.createEventData(i,s),e.logEvent(o,{method:"logClickVisualSearchEvent"})):null!=(l=ThisLife.SC)?l.logLinkClick({pageName:"sflyphotos/applibrary",linkName:s}):void 0:void 0},n.prototype.logClickVisualSearchSelectMoment=function(t){var i;return this._isDTLEnabled()?e.logEvent({event:{eventInfo:{eventName:"photos search_photo selected"},eventDetails:{filteredSelected:t}}},{method:"logClickVisualSearchSelectMoment"}):null!=(i=ThisLife.SC)?i.logSearchMomentClick({pageName:"applibrary",linkName:"Select",eVar59:t}):void 0},n.prototype.logClickVisualSearchDateHeader=function(t){var n,o,s,r;return s={"select-date":"Search:click-date_header"},(o=s[t])?this._isDTLEnabled()?(n=e.createEventData(i,o),e.logEvent(n,{method:"logClickVisualSearchDateHeader"})):null!=(r=ThisLife.SC)?r.logNavigationClick({pageName:"applibrary",linkName:o}):void 0:void 0},n.prototype.logSignInFormLoad=function(){return this._isDTLEnabled()?e.logEvent({event:{eventInfo:{eventName:"form view"},eventDetails:{formName:"sign in"}}},{method:"logSignInFormLoad"}):void 0},n.prototype.logSignInFormError=function(t){return this._isDTLEnabled()?e.logEvent({event:{eventInfo:{eventName:"form error"},eventDetails:{formName:"sign in",formerror:t}}},{method:"logSignInFormError"}):void 0},n.prototype.logSignInFormSubmit=function(t,i,n,o){return this._isDTLEnabled()?e.logEvent({event:{eventInfo:{eventName:"sign in confirmation"},visitorInfo:{registrationDate:t,lastOrderDate:i,lastUploadDate:n,hasPurchased:o}}},{method:"logSignInFormSubmit"}):void 0},n.prototype.logSignInConfirmation=function(t){return this._isDTLEnabled()?e.logEvent({event:{eventInfo:{eventName:"sign in confirmation"},visitorDetails:{visitorId:"",visitorType:"signedIn",customerId:t}}}):void 0},n.prototype.logUpgradeModal=function(t){var i;return i="appupgrade",this._isDTLEnabled()?e.logEvent({event:{eventInfo:{eventName:"modal_dialog load"},eventDetails:{eventLocation:i}}},{method:"logUpgradeModal"}):ThisLife.SC.init({pageName:i,events:"ProdView",products:t})},n.prototype.logClickUpgradePlan=function(e){return this._isDTLEnabled()?void 0:ThisLife.SC.logLinkClick({pageName:"appupgrade",linkName:e})},n.prototype.logSearchPeopleTagSaved=function(){return this._isDTLEnabled()?e.logEvent({event:{eventInfo:{eventName:"generic event"},eventDetails:{eventLocation:"photos search people tag saved"}}},{method:"logSearchPeopleTagSaved"}):void 0},n.prototype.logUPPLaunchSource=function(t){return this._isDTLEnabled()?e.logEvent({event:{eventInfo:{eventName:"generic event"},eventDetails:{eventLocation:"UPPLaunch:"+t}}},{method:"logUPPLaunchSource"}):void 0},n.prototype.logSignInClicked=function(){return this._isDTLEnabled()?e.logEvent({event:{eventInfo:{eventName:"generic event"},eventDetails:{eventLocation:"photos tl:sign_in"}}},{method:"logSignInClicked"}):void 0},n.prototype.logPrivateAccountError=function(){var t,n;return(n="private account error")&&this._isDTLEnabled()?(t=e.createEventData(i,n),e.logEvent(t,{method:"logPrivateAccountError"})):void 0},n.prototype.logSignUpClicked=function(){return this._isDTLEnabled()?e.logEvent({event:{eventInfo:{eventName:"generic event"},eventDetails:{eventLocation:"photos tl:sign_in"}}},{method:"logSignUpClicked"}):void 0},n.prototype.logShareWidgetEvent=function(t){var i;if(this._isDTLEnabled())return i=function(i){var n,o,s,r,l,a,u,c,d,h;return h=i.view,n=i.event,l=i.launchTrigger,d=i.value,r="launch"===n,s=r?"share widget load":"generic event",a={common:{setCollaborate:"share: Collaborate "+(d?"yes":"no")},home:{clickEmailField:"share "+t+": email click",clickViaLink:"share "+t+": link click",clickFacebook:"share "+t+": facebook click"},copyViaLink:{clickCopyLinkButton:"share "+t+": link share",clickLink:"share "+t+": link share"},facebook:{clickShare:"share "+t+": facebook share"},email:{clickSend:"share "+t+": email share"},options:{setCollaborate:"sharing options: Collaborate "+(d?"yes":"no"),clickInviteMore:"sharing options: invite more",clickCopyLinkButton:"sharing options: copy link"},"options/leaveAlbum":{clickLeave:"sharing options: leave"},"options/unshareAlbum":{clickUnshareAlbum:"sharing options: stop share"}},o=r?l:null!=(c=a[h])?c[n]:void 0,n&&o?(u={event:{eventInfo:{eventName:s},eventDetails:{eventLocation:o}}},r&&(u.event.eventDetails.modalName="share "+t+" widget"),e.logEvent(u,{method:"logShareWidgetEvent"})):void 0}},n.prototype.logFMVDownloadClicked=function(){var t,n,o,s;return n="Moment:click-Download",this._isDTLEnabled()?(t=e.createEventData(i,n),e.logEvent(t,{method:"logFMVDownloadClicked"})):(o="albums"===ThisLife.app.currentState.name?"appalbum/appfull":"applibrary/appfull",null!=(s=ThisLife.SC)?s.logLinkClick({pageName:o,linkName:n}):void 0)},n.prototype.setTestVariation=function(e){var t;if(!this._isDTLEnabled())return null!=(t=ThisLife.SC)?t.setTestVariation(e):void 0},n}()})}.call(this),function(){define("ThisLife.Tracking.Controllers.DTLController",["ThisLife.Helper.Object"],function(e){var t;return t={setup:function(t){return this._cachedBase=this._getBaseData(),window.SFLY_DTL=e.clone(this._cachedBase),"function"==typeof t?t():void 0},_getBaseData:function(){var t,i,n,o,s;return t={},window.BaseADTMD&&"object"==typeof window.BaseADTMD?(window.BaseADTMD.noClobber&&(t.noClobber=window.BaseADTMD.noClobber),window.BaseADTMD.env&&(t.env=window.BaseADTMD.env),window.BaseADTMD.page&&(t.page=e.clone(window.BaseADTMD.page)),window.BaseADTMD.session&&"object"==typeof window.BaseADTMD.session&&(t.session=e.clone(window.BaseADTMD.session),o=null!=(i=ThisLife.Model)&&null!=(n=i.User)&&"function"==typeof n.get?n.get("uid"):void 0,o&&window.BaseADTMD.session.visitorDetails&&"object"==typeof window.BaseADTMD.session.visitorDetails&&(s=e.clone(window.BaseADTMD.session.visitorDetails),e.deepMerge(s,{visitorType:"signedIn",customerId:o||""}),t.session.visitorDetails=s)),t):t},logEvent:function(i,n){var o,s,r;s={};try{return o=window.$omnitureDTL.clone(this._cachedBase),e.deepMerge(s,o),e.deepMerge(s,i),window.$omnitureDTL.processOmnitureJSPData(function(){}),window.$omnitureDTL.putOmnitureJSPData(location.origin,s)}catch(l){return r=l,t._logErrorException(r.message,n.method)}},logPageEvent:function(i,n){var o,s,r,l,a;switch(null==n&&(n={}),s={},i){case"story":case"appstory":i="story_invite";break;case"appalbum":l={page:{pageInfo:{albumType:n.albumType}}}}a={page:{pageInfo:{pageName:"sflyphotos/"+i,pageType:"sflyphotos pages",siteSection:"sflyphotos"}}};try{return o=window.$omnitureDTL.clone(this._cachedBase),e.deepMerge(s,o),e.deepMerge(s,a),l&&"object"==typeof l&&e.deepMerge(s,l),window.$omnitureDTL.removeOmnitureJSPData(location.origin,"page"),window.$omnitureDTL.processOmnitureJSPData(function(){}),window.$omnitureDTL.putOmnitureJSPData(location.origin,s)}catch(u){return r=u,t._logErrorException(r.message,"logPageEvent_"+i)}},createEventData:function(t,i,n){var o;return null==n&&(n={}),o={event:{eventInfo:{eventName:t},eventDetails:{eventLocation:i}}},e.deepMerge(o.event.eventDetails,n),o},_logErrorException:function(e,t){var i,n,o;return i={area:"dtm",exception:e,method:t},null!=(n=ThisLife.app)&&"function"==typeof n.controller&&null!=(o=n.controller("timing"))?o.recordInfo("exception",i):void 0}}})}.call(this),function(){define("ThisLife.Tracking.Controllers.SCController",[],function(){var e;return e={setup:function(e){var t;return t=document.createElement("script"),t.type="text/javascript",t.src=ThisLife.manifest.sitecatalyst,t.onload=function(){return ThisLife.SCArgs.skipAutoLog=!0,ThisLife.SCArgs.pageName=ThisLife.pagePath,ThisLife.SC.init(ThisLife.SCArgs),"function"==typeof e?e(!0):void 0},t.onerror=function(){return"function"==typeof e?e(!1):void 0},document.getElementsByTagName("head")[0].appendChild(t)}}})}.call(this),function(){var e=[].indexOf||function(e){for(var t=0,i=this.length;i>t;t++)if(t in this&&this[t]===e)return t;return-1};define("ThisLife.Trash.Controllers.Trash",["ThisLife.Helper.Features","ThisLife.PubSub","ThisLife.Trash.Views.Trash","ThisLife.Trash.Views.UndoFlyout","ThisLife.Trash.Views.TrashConfirmation"],function(t,i,n,o,s){var r;return r=function(){function r(e){this.options=null!=e?e:{},this._collection={},this._deleteLock={},this._actionLock=!1,this.moments=[],t.whenReady("upp",function(e){return function(t){return e.useUPP=t}}(this)),i.on("state:change",this._stateChange,this)}return _.extend(r.prototype,Backbone.Events),r.prototype.show=function(){var e;return null!=(e=this._view)&&e.remove(),this._view=new n({controller:this}),document.body.appendChild(this._view.render().el),this},r.prototype.hide=function(){var e;return null!=(e=this._view)?e.remove():void 0},r.prototype.setDeleteLock=function(e){var t,i,n;for(t=0,i=e.length;i>t;t++)n=e[t],this._deleteLock[n]=new Date;return this},r.prototype.clearDeleteLock=function(){return this._deleteLock={}},r.prototype.hasDeleteLock=function(e){return null!=this._deleteLock[e]&&new Date-this._deleteLock[e]<1e4},r.prototype.isDeleting=function(){return this.moments.length>0},r.prototype.hasActionLock=function(){return this._actionLock},r.prototype._stateChange=function(e){var t;return"trash"===(null!=(t=e.previous)?t.name:void 0)?this.hide():void 0},r.prototype.clearUndoFlyout=function(){return ThisLife.app.controller("toast").clear(this._toast_guid),this._expireUndoFlyout()},r.prototype.clearTrashConfirmation=function(){var e;return e=function(e){return function(){return e._actionLock=!1,ThisLife.appModel.showTrashConfirmation=!1,ThisLife.app.controller("toast").clear(e._toast_confirmation),e._toast_confirmation=null}}(this),this._actionLock=!0,ThisLife.Service.api.setTrashConfirmation(!1,e,e)},r.prototype._renderUndoFlyout=function(e){return this._toast_guid?ThisLife.app.controller("toast").updateView(this._toast_guid,{uids:e}):this._toast_guid=ThisLife.app.controller("toast")["new"]({closeCallback:this._expireUndoFlyout.bind(this),view:o,view_options:{uids:e}})},r.prototype._renderTrashConfirmation=function(){return this._toast_confirmation?void 0:this._toast_confirmation=ThisLife.app.controller("toast")["new"]({closeCallback:null,view:s,view_options:{},timeout:0})},r.prototype._expireUndoFlyout=function(){var e;return e=function(e){return function(){var t;return e._actionLock=!1,null!=(t=e._view)?t._setUpdateBanner(!1):void 0}}(this),this._actionLock=!0,this._toast_guid=null,this.moments.length?(ThisLife.Service.api.saveMomentsProperty(this.moments,"hidden",!0).then(e,e),this.moments=[]):void 0},r.prototype["delete"]=function(e,t){var i,n;return null==t&&(t=!1),n=ThisLife.app.currentState,"albums"===n.name&&n.fragment.indexOf("album")>=0&&this._deleteAlbum(e),this._deleteLibrary(e),ThisLife.app.controller("timeline").updateObjects(e,{hidden:!0,selected:!1}),"function"==typeof(i=ThisLife.app.album).updateObjects&&i.updateObjects(e,{hidden:!0,selected:!1}),this.setDeleteLock(e),t?this._expireUndoFlyout():(this._renderUndoFlyout(e),ThisLife.appModel.showTrashConfirmation&&this._renderTrashConfirmation()),ThisLife.View.bottomBar.addDeleteIcon(),ThisLife.Collection.moments.getNumVisible()<1&&ThisLife.View.magicShop.hide(),ThisLife.app.controller("uploader").forceUpdate()},r.prototype._deleteAlbum=function(e){var t,i,n,o,s,r;for(this._collection.album=t=ThisLife.app.album.getCollection(),s=[],i=0,n=e.length;n>i;i++)r=e[i],o=t.get(r),o&&o.canEdit()&&(t.setModel(o,{hidden:!0},{ignoreForLayout:!0}),s.push(o));return ThisLife.app.album.hideMoments(this.moments,!0),ThisLife.app.album.noMoments()&&!this.useUPP?ThisLife.app.router.navigateToAlbumUpload(ThisLife.storyUid):void 0},r.prototype._deleteLibrary=function(e){var t,i,n,o,s,r;for(this._collection.library=t=ThisLife.Collection.moments,s=[],i=0,n=e.length;n>i;i++)r=e[i],o=t.get(r),o?(t.setModel(o.id,{hidden:!0},{ignoreForLayout:!0}),s.push(this.moments.push(r))):s.push(void 0);return s},r.prototype.restore=function(e,t){var i;return null==t&&(t=!0),i=ThisLife.app.currentState,"albums"===i.name&&i.fragment.indexOf("album")>=0&&this._restoreAlbum(e),this._restoreLibrary(e),ThisLife.app.controller("timeline").updateObjects(e,{hidden:!1}),this._removeFromTrashedMoments(e),this.setDeleteLock(e),t&&ThisLife.Service.api.saveMomentsProperty(e,"hidden",!1),ThisLife.View.bottomBar.addDeleteIcon(),ThisLife.Collection.moments.getNumVisible()>0&&ThisLife.View.magicShop.show(),ThisLife.app.controller("uploader").forceUpdate()},r.prototype._restoreAlbum=function(e){var t,i,n,o,s,r,l,a,u,c,d;if(u=[],i=this._collection.album||ThisLife.app.album.getCollection(),c=ThisLife.app.currentState,!(c.fragment.indexOf("add")>=0)){for(s=0,l=e.length;l>s;s++)d=e[s],a=i.get(d),i.setModel(a,{hidden:!1},{ignoreForLayout:!0}),u.push(a);return ThisLife.app.album.restoreMoments(u)}for(o=!i.getMoments().length,n=0,r=e.length;r>n;n++)d=e[n],a=i.get(d),a&&a.canEdit()&&(i.setModel(a,{hidden:!1},{ignoreForLayout:!0}),u.push(a));return o?(t=ThisLife.app.album.getCurrentAlbum(),t.addPendingUploads(_.pluck(u,"id")),t.updateAfterShow=!0,ThisLife.app.router.navigateToAlbum(t.id,{trigger:!0,replace:!0})):void 0},r.prototype._restoreLibrary=function(e){var t,i,n,o,s,r,l;for(t=this._collection.library||ThisLife.Collection.moments,s=[],r=[],i=0,n=e.length;n>i;i++)l=e[i],o=t.get(l),o?(t.setModel(o.id,{hidden:!1},{ignoreForLayout:!0}),r.push(s.push(o))):r.push(void 0);return r},r.prototype._removeFromTrashedMoments=function(t){var i,n,o,s,r;for(s=[],o=this.moments,i=0,n=o.length;n>i;i++)r=o[i],e.call(t,r)<0&&s.push(r);return this.moments=s},r}()})}.call(this),function(){define("ThisLife.Trash.Views.Trash",["ThisLife.Trash.Views.TrashOverlay","ThisLife.Trash.Views.TrashTimerNotification","PMCHeimdall"],function(e,t,i){var n;return n=Backbone.View.extend({className:"trash-view",events:{"click .close":"teardown","click .restore-all:not(.disabled)":"restoreAll","click .empty-trash:not(.disabled)":"emptyTrash"},initialize:function(e){return null==e&&(e={}),this.controller=e.controller,this.collection=ThisLife.Collection.moments,this.count=this.collection.getNumHidden(),this.controller.clearUndoFlyout(),this},render:function(){return this.$el.html(this._template()),this._cacheElements(),document.body.classList.add("trash"),_.defer(function(e){return function(){return e._createHeimdallLayout(),e._bindEvents()}}(this)),this},teardown:function(){return this._unbindEvents(),this.remove(),document.body.classList.remove("trash"),ThisLife.app.controller("tracking").logClickTrashClose(),ThisLife.app.router.back()},clickHandler:function(e,t){switch(t){case"restore":return this.controller.restore(e)}},restoreAll:function(){var e;return this._setButtonStyle(!0),e=this.collection.getHidden(),_.defer(function(t){return function(){return t.controller.restore(_.pluck(e,"id"),!1)}}(this)),ThisLife.app.controller("tracking").logClickTrashRestoreAll(),ThisLife.Service.api.restoreAllMoments()},emptyTrash:function(){var e,t;return ThisLife.app.controller("tracking").logClickTrashEmptyAll(),e=function(e){return function(){return e.emptyTrashCallback()}}(this),t=new ThisLife.View.ModalAlert({template:"emptyTrashCan",callback:e}),$(document.body).append(t.render().el)},emptyTrashCallback:function(){var e,t,i,n,o;if(this.count>0){for(ThisLife.Service.api.deleteHiddenMoments(),n=this.collection.getHidden(),o=[],e=0,t=n.length;t>e;e++)i=n[e],o.push(i.quickDelete());return o}},_cacheElements:function(){return this._countEl=this.el.querySelector(".action-menu .count span"),this._restoreAllEl=this.el.querySelector(".restore-all"),this._emptyAllEl=this.el.querySelector(".empty-trash")},_bindEvents:function(){return ThisLife.Support.keyInformant.on("cancel",this.teardown,this),this.collection.on("change:hidden",this._onCollectionChangeHidden,this).on("remove",this._onRemoveCollectionChange,this),this},_unbindEvents:function(){return ThisLife.Support.keyInformant.off("cancel",this.teardown,this),this.collection.off(null,null,this),this},_onRemoveCollectionChange:function(e){return this.count--,this._updateForRemovedMoments([e]),this._updateCount(this.count)},_onCollectionChangeHidden:function(e){return e.get("hidden")===!0?(this.count++,this._updateForAddedMoments([e])):(this.count--,this._updateForRemovedMoments([e])),this._updateCount(this.count)},_updateForAddedMoments:function(e){var t;return t=[],_.each(e,function(e){var i;return i=_.extend({},e.attributes),i.hidden=!1,t.push(i)}),this._squareView.addObjects(t)},_updateForRemovedMoments:function(e){var t;return t=[],_.each(e,function(e){return t.push(e.id)}),this._squareView.removeObjects(t)},_updateCount:function(e){return this._countEl.textContent=e,this._setButtonStyle()},_createHeimdallLayout:function(){var n,o,s,r,l,a;return r=this.collection.getHidden(),o=o||document.getElementById("library-vertical"),l=[],_.each(r,function(e){var t;return t=_.extend({},e.attributes),t.hidden=!1,t.moment_date*=1e3,t.upload_date*=1e3,l.push(t)}),n=new t,s=n.updateDimensions(o.getBoundingClientRect()),a={actionbar_options:{sections:{left:[{view:"date-summary",options:{hide_checkmark:!0}}]}},container:this.el.querySelector(".trash-grid"),environment:ThisLife.Settings.sflyEnv,layout:"VerticalCondensed",layout_options:{banners:{header:{el:n.el,width:s.width,height:s.height,updateDimensions:n.updateDimensions}},date_summary:{hide_checkmark:!0},default_size:"small",group_objects:!0,object_sizes:{small:{min_height:175,max_height:175}},offsets:{top:82,left:20,right:20,object:6},overlay:e,view_type:"square"},life_uid:ThisLife.currentLifeOwner,scrubber:"Basic",scrubber_options:{show_markers:!1,show_needle:!1,show_tooltip:!1,vertical:!0},clickCallback:_.bind(this.clickHandler,this)},this._squareView=new i(l,a)},_setUpdateBanner:function(e){return null==e&&(e=!0),e?this.el.querySelector(".pending-updates").classList.add("show"):this.el.querySelector(".pending-updates").classList.remove("show")},_setButtonStyle:function(e){return null==e&&(e=!1),0===this.count||e?(this._restoreAllEl.classList.add("disabled"),this._emptyAllEl.classList.add("disabled")):(this._restoreAllEl.classList.remove("disabled"),this._emptyAllEl.classList.remove("disabled"))},_template:function(){return'<div class="action-menu">\n  <div class="pending-updates">Please wait. Adding photos to trash...</div>\n  <div class="count"><span>'+this.count+'</span> Deleted Items</div>\n  <div class="action-wrapper">\n    <div class="gray-btn restore-all">Restore All</div>\n    <div class="gray-btn empty-trash">Empty Trash</div>\n  </div>\n  <div class="close"></div>\n</div>\n\n<div class="trash-grid"></div>'}})})}.call(this),function(){define("ThisLife.Trash.Views.TrashOverlay",[],function(){var e;return e=Backbone.View.extend({className:"trash-overlay",render:function(){return this.$el.html(this.template()),this},template:function(){return'<div action="restore" class="orange-btn restore-button">Restore</div>'}})})}.call(this),function(){define("ThisLife.Trash.Views.TrashTimerNotification",[],function(){var e;return e=Backbone.View.extend({className:"trash-timer-notification",initialize:function(){return this.render(),this},render:function(){return this.$el.html(this._getTemplate()),this},updateDimensions:function(e){var t;return t=e.width<480?{height:38,width:260}:{height:20,width:500}},_getTemplate:function(){return'<div class="trash-message">Items in the trash are permanently deleted after 30 days</div>'}})})}.call(this),function(){define("ThisLife.Trash.Views.UndoFlyout",[],function(){var e;return e=Backbone.View.extend({className:"trash-tooltip",events:{"click .undo":"_restore"},initialize:function(e){return null==e&&(e={}),this._reset(),this.moments=e.uids,this},render:function(){return this.$el.html(this._template(this.moments)),this.cacheElements(),this},cacheElements:function(){return this.text=this.el.querySelector(".trash_num")},update:function(e){return e.uids?(this.moments=_.union(this.moments,e.uids),this.text.textContent=1===this.moments.length?this.moments.length+" item has":this.moments.length+" items have"):void 0},teardown:function(e){return null==e&&(e=!1),this._reset(),this.remove()},_reset:function(){return this.moments=[]},_restore:function(){return ThisLife.app.controller("trash").restore(this.moments,!1),ThisLife.app.controller("trash").clearUndoFlyout()},_template:function(e){var t;return t=1===e.length?e.length+" item has":e.length+" items have",'<div class="wrapper">\n  <span class="trash_num">'+t+'</span> been added to trash <span class="undo"><a>Undo</a></span>\n</div>'}})})}.call(this),function(){define("ThisLife.Trash.Views.TrashConfirmation",[],function(){var e;return e=Backbone.View.extend({className:"trash-tooltip",events:{"click .ok":"_restore"},initialize:function(e){return null==e&&(e={}),this},render:function(){return this.$el.html(this._template()),this},teardown:function(e){return null==e&&(e=!1),this.remove()},_restore:function(){return ThisLife.app.controller("trash").clearTrashConfirmation()},_template:function(){return'<div class="wrapper">\n  Photos added to trash will be deleted after 30 days <span class="ok"><a>OK</a></span>\n</div>'}})})}.call(this);/*
 *
 * More info at [www.dropzonejs.com](http://www.dropzonejs.com)
 *
 * Copyright (c) 2012, Matias Meno
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 *
 */
var Dropzone,Emitter,camelize,contentLoaded,detectVerticalSquash,drawImageIOSFix,noop,without,slice=[].slice,extend1=function(e,t){function i(){this.constructor=e}for(var n in t)hasProp.call(t,n)&&(e[n]=t[n]);return i.prototype=t.prototype,e.prototype=new i,e.__super__=t.prototype,e},hasProp={}.hasOwnProperty;noop=function(){},Emitter=function(){function e(){}return e.prototype.addEventListener=e.prototype.on,e.prototype.on=function(e,t){return this._callbacks=this._callbacks||{},this._callbacks[e]||(this._callbacks[e]=[]),this._callbacks[e].push(t),this},e.prototype.emit=function(){var e,t,i,n,o,s;if(n=arguments[0],e=2<=arguments.length?slice.call(arguments,1):[],this._callbacks=this._callbacks||{},i=this._callbacks[n])for(o=0,s=i.length;s>o;o++)t=i[o],t.apply(this,e);return this},e.prototype.removeListener=e.prototype.off,e.prototype.removeAllListeners=e.prototype.off,e.prototype.removeEventListener=e.prototype.off,e.prototype.off=function(e,t){var i,n,o,s,r;if(!this._callbacks||0===arguments.length)return this._callbacks={},this;if(n=this._callbacks[e],!n)return this;if(1===arguments.length)return delete this._callbacks[e],this;for(o=s=0,r=n.length;r>s;o=++s)if(i=n[o],i===t){n.splice(o,1);break}return this},e}(),Dropzone=function(e){function t(e,n){var o,s,r;if(this.element=e,this.version=t.version,this.defaultOptions.previewTemplate=this.defaultOptions.previewTemplate.replace(/\n*/g,""),this.clickableElements=[],this.listeners=[],this.files=[],"string"==typeof this.element&&(this.element=document.querySelector(this.element)),!this.element||null==this.element.nodeType)throw new Error("Invalid dropzone element.");if(this.element.dropzone)throw new Error("Dropzone already attached.");if(t.instances.push(this),this.element.dropzone=this,o=null!=(r=t.optionsForElement(this.element))?r:{},this.options=i({},this.defaultOptions,o,null!=n?n:{}),this.options.forceFallback||!t.isBrowserSupported())return this.options.fallback.call(this);if(null==this.options.url&&(this.options.url=this.element.getAttribute("action")),!this.options.url)throw new Error("No URL provided.");if(this.options.acceptedFiles&&this.options.acceptedMimeTypes)throw new Error("You can't provide both 'acceptedFiles' and 'acceptedMimeTypes'. 'acceptedMimeTypes' is deprecated.");this.options.acceptedMimeTypes&&(this.options.acceptedFiles=this.options.acceptedMimeTypes,delete this.options.acceptedMimeTypes),this.options.method=this.options.method.toUpperCase(),(s=this.getExistingFallback())&&s.parentNode&&s.parentNode.removeChild(s),this.options.previewsContainer!==!1&&(this.previewsContainer=this.options.previewsContainer?t.getElement(this.options.previewsContainer,"previewsContainer"):this.element),this.options.clickable&&(this.clickableElements=this.options.clickable===!0?[this.element]:t.getElements(this.options.clickable,"clickable")),this.init()}var i,n;return extend1(t,e),t.prototype.Emitter=Emitter,t.prototype.events=["drop","dragstart","dragend","dragenter","dragover","dragleave","addedfile","addedfiles","removedfile","thumbnail","error","errormultiple","processing","processingmultiple","uploadprogress","totaluploadprogress","sending","sendingmultiple","success","successmultiple","canceled","canceledmultiple","complete","completemultiple","reset","maxfilesexceeded","maxfilesreached","queuecomplete"],t.prototype.defaultOptions={url:null,method:"post",withCredentials:!1,parallelUploads:2,uploadMultiple:!1,maxFilesize:256,paramName:"file",createImageThumbnails:!0,maxThumbnailFilesize:10,thumbnailWidth:120,thumbnailHeight:120,filesizeBase:1e3,maxFiles:null,params:{},clickable:!0,ignoreHiddenFiles:!0,acceptedFiles:null,acceptedMimeTypes:null,autoProcessQueue:!0,autoQueue:!0,addRemoveLinks:!1,previewsContainer:null,hiddenInputContainer:"body",capture:null,dictDefaultMessage:"Drop files here to upload",dictFallbackMessage:"Your browser does not support drag'n'drop file uploads.",dictFallbackText:"Please use the fallback form below to upload your files like in the olden days.",dictFileTooBig:"File is too big ({{filesize}}MiB). Max filesize: {{maxFilesize}}MiB.",dictInvalidFileType:"You can't upload files of this type.",dictResponseError:"Server responded with {{statusCode}} code.",dictCancelUpload:"Cancel upload",dictCancelUploadConfirmation:"Are you sure you want to cancel this upload?",dictRemoveFile:"Remove file",dictRemoveFileConfirmation:null,dictMaxFilesExceeded:"You can not upload any more files.",accept:function(e,t){return t()},init:function(){return noop},forceFallback:!1,fallback:function(){var e,i,n,o,s,r;for(this.element.className=this.element.className+" dz-browser-not-supported",s=this.element.getElementsByTagName("div"),i=0,n=s.length;n>i;i++)e=s[i],/(^| )dz-message($| )/.test(e.className)&&(o=e,e.className="dz-message");return o||(o=t.createElement('<div class="dz-message"><span></span></div>'),this.element.appendChild(o)),r=o.getElementsByTagName("span")[0],r&&(null!=r.textContent?r.textContent=this.options.dictFallbackMessage:null!=r.innerText&&(r.innerText=this.options.dictFallbackMessage)),this.element.appendChild(this.getFallbackForm())},resize:function(e){var t,i,n;return t={srcX:0,srcY:0,srcWidth:e.width,srcHeight:e.height},i=e.width/e.height,t.optWidth=this.options.thumbnailWidth,t.optHeight=this.options.thumbnailHeight,null==t.optWidth&&null==t.optHeight?(t.optWidth=t.srcWidth,t.optHeight=t.srcHeight):null==t.optWidth?t.optWidth=i*t.optHeight:null==t.optHeight&&(t.optHeight=1/i*t.optWidth),n=t.optWidth/t.optHeight,e.height<t.optHeight||e.width<t.optWidth?(t.trgHeight=t.srcHeight,t.trgWidth=t.srcWidth):i>n?(t.srcHeight=e.height,t.srcWidth=t.srcHeight*n):(t.srcWidth=e.width,t.srcHeight=t.srcWidth/n),t.srcX=(e.width-t.srcWidth)/2,t.srcY=(e.height-t.srcHeight)/2,t},drop:function(){return this.element.classList.remove("dz-drag-hover")},dragstart:noop,dragend:function(){return this.element.classList.remove("dz-drag-hover")},dragenter:function(){return this.element.classList.add("dz-drag-hover")},dragover:function(){return this.element.classList.add("dz-drag-hover")},dragleave:function(){return this.element.classList.remove("dz-drag-hover")},paste:noop,reset:function(){return this.element.classList.remove("dz-started")},addedfile:function(e){var i,n,o,s,r,l,a,u,c,d,h,p,f;if(this.element===this.previewsContainer&&this.element.classList.add("dz-started"),this.previewsContainer){for(e.previewElement=t.createElement(this.options.previewTemplate.trim()),e.previewTemplate=e.previewElement,this.previewsContainer.appendChild(e.previewElement),u=e.previewElement.querySelectorAll("[data-dz-name]"),i=0,s=u.length;s>i;i++)a=u[i],a.textContent=e.name;for(c=e.previewElement.querySelectorAll("[data-dz-size]"),n=0,r=c.length;r>n;n++)a=c[n],a.innerHTML=this.filesize(e.size);for(this.options.addRemoveLinks&&(e._removeLink=t.createElement('<a class="dz-remove" href="javascript:undefined;" data-dz-remove>'+this.options.dictRemoveFile+"</a>"),e.previewElement.appendChild(e._removeLink)),h=function(i){return function(n){return n.preventDefault(),n.stopPropagation(),e.status===t.UPLOADING?t.confirm(i.options.dictCancelUploadConfirmation,function(){return i.removeFile(e)}):i.options.dictRemoveFileConfirmation?t.confirm(i.options.dictRemoveFileConfirmation,function(){return i.removeFile(e)}):i.removeFile(e)}}(this),d=e.previewElement.querySelectorAll("[data-dz-remove]"),f=[],o=0,l=d.length;l>o;o++)p=d[o],f.push(p.addEventListener("click",h));return f}},removedfile:function(e){var t;return e.previewElement&&null!=(t=e.previewElement)&&t.parentNode.removeChild(e.previewElement),this._updateMaxFilesReachedClass()},thumbnail:function(e,t){var i,n,o,s;if(e.previewElement){for(e.previewElement.classList.remove("dz-file-preview"),o=e.previewElement.querySelectorAll("[data-dz-thumbnail]"),i=0,n=o.length;n>i;i++)s=o[i],s.alt=e.name,s.src=t;return setTimeout(function(){return function(){return e.previewElement.classList.add("dz-image-preview")}}(this),1)}},error:function(e,t){var i,n,o,s,r;if(e.previewElement){for(e.previewElement.classList.add("dz-error"),"String"!=typeof t&&t.error&&(t=t.error),s=e.previewElement.querySelectorAll("[data-dz-errormessage]"),r=[],i=0,n=s.length;n>i;i++)o=s[i],r.push(o.textContent=t);return r}},errormultiple:noop,processing:function(e){return e.previewElement&&(e.previewElement.classList.add("dz-processing"),e._removeLink)?e._removeLink.textContent=this.options.dictCancelUpload:void 0},processingmultiple:noop,uploadprogress:function(e,t){var i,n,o,s,r;if(e.previewElement){for(s=e.previewElement.querySelectorAll("[data-dz-uploadprogress]"),r=[],i=0,n=s.length;n>i;i++)o=s[i],r.push("PROGRESS"===o.nodeName?o.value=t:o.style.width=t+"%");return r}},totaluploadprogress:noop,sending:noop,sendingmultiple:noop,success:function(e){return e.previewElement?e.previewElement.classList.add("dz-success"):void 0},successmultiple:noop,canceled:function(e){return this.emit("error",e,"Upload canceled.")},canceledmultiple:noop,complete:function(e){return e._removeLink&&(e._removeLink.textContent=this.options.dictRemoveFile),e.previewElement?e.previewElement.classList.add("dz-complete"):void 0},completemultiple:noop,maxfilesexceeded:noop,maxfilesreached:noop,queuecomplete:noop,addedfiles:noop,previewTemplate:'<div class="dz-preview dz-file-preview">\n  <div class="dz-image"><img data-dz-thumbnail /></div>\n  <div class="dz-details">\n    <div class="dz-size"><span data-dz-size></span></div>\n    <div class="dz-filename"><span data-dz-name></span></div>\n  </div>\n  <div class="dz-progress"><span class="dz-upload" data-dz-uploadprogress></span></div>\n  <div class="dz-error-message"><span data-dz-errormessage></span></div>\n  <div class="dz-success-mark">\n    <svg width="54px" height="54px" viewBox="0 0 54 54" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns">\n      <title>Check</title>\n      <defs></defs>\n      <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" sketch:type="MSPage">\n        <path d="M23.5,31.8431458 L17.5852419,25.9283877 C16.0248253,24.3679711 13.4910294,24.366835 11.9289322,25.9289322 C10.3700136,27.4878508 10.3665912,30.0234455 11.9283877,31.5852419 L20.4147581,40.0716123 C20.5133999,40.1702541 20.6159315,40.2626649 20.7218615,40.3488435 C22.2835669,41.8725651 24.794234,41.8626202 26.3461564,40.3106978 L43.3106978,23.3461564 C44.8771021,21.7797521 44.8758057,19.2483887 43.3137085,17.6862915 C41.7547899,16.1273729 39.2176035,16.1255422 37.6538436,17.6893022 L23.5,31.8431458 Z M27,53 C41.3594035,53 53,41.3594035 53,27 C53,12.6405965 41.3594035,1 27,1 C12.6405965,1 1,12.6405965 1,27 C1,41.3594035 12.6405965,53 27,53 Z" id="Oval-2" stroke-opacity="0.198794158" stroke="#747474" fill-opacity="0.816519475" fill="#FFFFFF" sketch:type="MSShapeGroup"></path>\n      </g>\n    </svg>\n  </div>\n  <div class="dz-error-mark">\n    <svg width="54px" height="54px" viewBox="0 0 54 54" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns">\n      <title>Error</title>\n      <defs></defs>\n      <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" sketch:type="MSPage">\n        <g id="Check-+-Oval-2" sketch:type="MSLayerGroup" stroke="#747474" stroke-opacity="0.198794158" fill="#FFFFFF" fill-opacity="0.816519475">\n          <path d="M32.6568542,29 L38.3106978,23.3461564 C39.8771021,21.7797521 39.8758057,19.2483887 38.3137085,17.6862915 C36.7547899,16.1273729 34.2176035,16.1255422 32.6538436,17.6893022 L27,23.3431458 L21.3461564,17.6893022 C19.7823965,16.1255422 17.2452101,16.1273729 15.6862915,17.6862915 C14.1241943,19.2483887 14.1228979,21.7797521 15.6893022,23.3461564 L21.3431458,29 L15.6893022,34.6538436 C14.1228979,36.2202479 14.1241943,38.7516113 15.6862915,40.3137085 C17.2452101,41.8726271 19.7823965,41.8744578 21.3461564,40.3106978 L27,34.6568542 L32.6538436,40.3106978 C34.2176035,41.8744578 36.7547899,41.8726271 38.3137085,40.3137085 C39.8758057,38.7516113 39.8771021,36.2202479 38.3106978,34.6538436 L32.6568542,29 Z M27,53 C41.3594035,53 53,41.3594035 53,27 C53,12.6405965 41.3594035,1 27,1 C12.6405965,1 1,12.6405965 1,27 C1,41.3594035 12.6405965,53 27,53 Z" id="Oval-2" sketch:type="MSShapeGroup"></path>\n        </g>\n      </g>\n    </svg>\n  </div>\n</div>'},i=function(){var e,t,i,n,o,s,r;for(s=arguments[0],o=2<=arguments.length?slice.call(arguments,1):[],e=0,i=o.length;i>e;e++){n=o[e];for(t in n)r=n[t],s[t]=r}return s},t.prototype.getAcceptedFiles=function(){var e,t,i,n,o;for(n=this.files,o=[],t=0,i=n.length;i>t;t++)e=n[t],e.accepted&&o.push(e);return o},t.prototype.getRejectedFiles=function(){var e,t,i,n,o;for(n=this.files,o=[],t=0,i=n.length;i>t;t++)e=n[t],e.accepted||o.push(e);return o},t.prototype.getFilesWithStatus=function(e){var t,i,n,o,s;for(o=this.files,s=[],i=0,n=o.length;n>i;i++)t=o[i],t.status===e&&s.push(t);return s},t.prototype.getQueuedFiles=function(){return this.getFilesWithStatus(t.QUEUED)},t.prototype.getUploadingFiles=function(){return this.getFilesWithStatus(t.UPLOADING)},t.prototype.getAddedFiles=function(){return this.getFilesWithStatus(t.ADDED)},t.prototype.getActiveFiles=function(){var e,i,n,o,s;for(o=this.files,s=[],i=0,n=o.length;n>i;i++)e=o[i],(e.status===t.UPLOADING||e.status===t.QUEUED)&&s.push(e);return s},t.prototype.init=function(){var e,i,n,o,s,r,l;for("form"===this.element.tagName&&this.element.setAttribute("enctype","multipart/form-data"),this.element.classList.contains("dropzone")&&!this.element.querySelector(".dz-message")&&this.element.appendChild(t.createElement('<div class="dz-default dz-message"><span>'+this.options.dictDefaultMessage+"</span></div>")),this.clickableElements.length&&(l=function(e){return function(){return e.hiddenFileInput&&e.hiddenFileInput.parentNode.removeChild(e.hiddenFileInput),e.hiddenFileInput=document.createElement("input"),e.hiddenFileInput.setAttribute("type","file"),(null==e.options.maxFiles||e.options.maxFiles>1)&&e.hiddenFileInput.setAttribute("multiple","multiple"),e.hiddenFileInput.className="dz-hidden-input",null!=e.options.acceptedFiles&&e.hiddenFileInput.setAttribute("accept",e.options.acceptedFiles),null!=e.options.capture&&e.hiddenFileInput.setAttribute("capture",e.options.capture),e.hiddenFileInput.style.visibility="hidden",e.hiddenFileInput.style.position="absolute",e.hiddenFileInput.style.top="0",e.hiddenFileInput.style.left="0",e.hiddenFileInput.style.height="0",e.hiddenFileInput.style.width="0",document.querySelector(e.options.hiddenInputContainer).appendChild(e.hiddenFileInput),e.hiddenFileInput.addEventListener("change",function(){var t,i,n,o;if(i=e.hiddenFileInput.files,i.length)for(n=0,o=i.length;o>n;n++)t=i[n],e.addFile(t);return e.emit("addedfiles",i),l()})}}(this))(),this.URL=null!=(s=window.URL)?s:window.webkitURL,r=this.events,i=0,n=r.length;n>i;i++)e=r[i],this.on(e,this.options[e]);return this.on("uploadprogress",function(e){return function(){return e.updateTotalUploadProgress()}}(this)),this.on("removedfile",function(e){return function(){return e.updateTotalUploadProgress()}}(this)),this.on("canceled",function(e){return function(t){return e.emit("complete",t)}}(this)),this.on("complete",function(e){return function(){return 0===e.getAddedFiles().length&&0===e.getUploadingFiles().length&&0===e.getQueuedFiles().length?setTimeout(function(){return e.emit("queuecomplete")},0):void 0}}(this)),o=function(e){return e.stopPropagation(),e.preventDefault?e.preventDefault():e.returnValue=!1},this.listeners=[{element:this.element,events:{dragstart:function(e){return function(t){return e.emit("dragstart",t)}}(this),dragenter:function(e){return function(t){return o(t),e.emit("dragenter",t)}}(this),dragover:function(e){return function(t){var i;try{i=t.dataTransfer.effectAllowed}catch(n){}return t.dataTransfer.dropEffect="move"===i||"linkMove"===i?"move":"copy",o(t),e.emit("dragover",t)}}(this),dragleave:function(e){return function(t){return e.emit("dragleave",t)}}(this),drop:function(e){return function(t){return o(t),e.drop(t)}}(this),dragend:function(e){return function(t){return e.emit("dragend",t)}}(this)}}],this.clickableElements.forEach(function(e){return function(i){return e.listeners.push({element:i,events:{click:function(n){return(i!==e.element||n.target===e.element||t.elementInside(n.target,e.element.querySelector(".dz-message")))&&e.hiddenFileInput.click(),!0}}})}}(this)),this.enable(),this.options.init.call(this)},t.prototype.destroy=function(){var e;return this.disable(),this.removeAllFiles(!0),(null!=(e=this.hiddenFileInput)?e.parentNode:void 0)&&(this.hiddenFileInput.parentNode.removeChild(this.hiddenFileInput),this.hiddenFileInput=null),delete this.element.dropzone,t.instances.splice(t.instances.indexOf(this),1)},t.prototype.updateTotalUploadProgress=function(){var e,t,i,n,o,s,r,l;if(r=0,s=0,e=this.getActiveFiles(),e.length){for(o=this.getActiveFiles(),i=0,n=o.length;n>i;i++)t=o[i],r+=t.upload.bytesSent,s+=t.upload.total;l=100*r/s}else l=100;return this.emit("totaluploadprogress",l,s,r)},t.prototype._getParamName=function(e){return"function"==typeof this.options.paramName?this.options.paramName(e):""+this.options.paramName+(this.options.uploadMultiple?"["+e+"]":"")},t.prototype.getFallbackForm=function(){var e,i,n,o;return(e=this.getExistingFallback())?e:(n='<div class="dz-fallback">',this.options.dictFallbackText&&(n+="<p>"+this.options.dictFallbackText+"</p>"),n+='<input type="file" name="'+this._getParamName(0)+'" '+(this.options.uploadMultiple?'multiple="multiple"':void 0)+' /><input type="submit" value="Upload!"></div>',i=t.createElement(n),"FORM"!==this.element.tagName?(o=t.createElement('<form action="'+this.options.url+'" enctype="multipart/form-data" method="'+this.options.method+'"></form>'),o.appendChild(i)):(this.element.setAttribute("enctype","multipart/form-data"),this.element.setAttribute("method",this.options.method)),null!=o?o:i)},t.prototype.getExistingFallback=function(){var e,t,i,n,o,s;for(t=function(e){var t,i,n;for(i=0,n=e.length;n>i;i++)if(t=e[i],/(^| )fallback($| )/.test(t.className))return t},o=["div","form"],i=0,n=o.length;n>i;i++)if(s=o[i],e=t(this.element.getElementsByTagName(s)))return e},t.prototype.setupEventListeners=function(){var e,t,i,n,o,s,r;for(s=this.listeners,r=[],i=0,n=s.length;n>i;i++)e=s[i],r.push(function(){var i,n;i=e.events,n=[];for(t in i)o=i[t],n.push(e.element.addEventListener(t,o,!1));return n}());return r},t.prototype.removeEventListeners=function(){var e,t,i,n,o,s,r;for(s=this.listeners,r=[],i=0,n=s.length;n>i;i++)e=s[i],r.push(function(){var i,n;i=e.events,n=[];for(t in i)o=i[t],n.push(e.element.removeEventListener(t,o,!1));return n}());return r},t.prototype.disable=function(){var e,t,i,n,o;for(this.clickableElements.forEach(function(e){return e.classList.remove("dz-clickable")}),this.removeEventListeners(),n=this.files,o=[],t=0,i=n.length;i>t;t++)e=n[t],o.push(this.cancelUpload(e));return o},t.prototype.enable=function(){return this.clickableElements.forEach(function(e){return e.classList.add("dz-clickable")}),this.setupEventListeners()},t.prototype.filesize=function(e){var t,i,n,o,s,r,l,a;if(s=0,r="b",e>0){for(a=["TB","GB","MB","KB","b"],i=n=0,o=a.length;o>n;i=++n)if(l=a[i],t=Math.pow(this.options.filesizeBase,4-i)/10,e>=t){s=e/Math.pow(this.options.filesizeBase,4-i),r=l;break}s=Math.round(10*s)/10}return"<strong>"+s+"</strong> "+r},t.prototype._updateMaxFilesReachedClass=function(){return null!=this.options.maxFiles&&this.getAcceptedFiles().length>=this.options.maxFiles?(this.getAcceptedFiles().length===this.options.maxFiles&&this.emit("maxfilesreached",this.files),this.element.classList.add("dz-max-files-reached")):this.element.classList.remove("dz-max-files-reached")},t.prototype.drop=function(e){var t,i;e.dataTransfer&&(this.emit("drop",e),t=e.dataTransfer.files,this.emit("addedfiles",t),t.length&&(i=e.dataTransfer.items,i&&i.length&&null!=i[0].webkitGetAsEntry?this._addFilesFromItems(i):this.handleFiles(t)))},t.prototype.paste=function(e){var t,i;if(null!=(null!=e&&null!=(i=e.clipboardData)?i.items:void 0))return this.emit("paste",e),t=e.clipboardData.items,t.length?this._addFilesFromItems(t):void 0},t.prototype.handleFiles=function(e){var t,i,n,o;for(o=[],i=0,n=e.length;n>i;i++)t=e[i],o.push(this.addFile(t));return o},t.prototype._addFilesFromItems=function(e){var t,i,n,o,s;for(s=[],n=0,o=e.length;o>n;n++)i=e[n],s.push(null!=i.webkitGetAsEntry&&(t=i.webkitGetAsEntry())?t.isFile?this.addFile(i.getAsFile()):t.isDirectory?this._addFilesFromDirectory(t,t.name):void 0:null!=i.getAsFile?null==i.kind||"file"===i.kind?this.addFile(i.getAsFile()):void 0:void 0);return s},t.prototype._addFilesFromDirectory=function(e,t){var i,n,o;return i=e.createReader(),n=function(e){return"undefined"!=typeof console&&null!==console&&"function"==typeof console.log?console.log(e):void 0},(o=function(e){return function(){return i.readEntries(function(i){var n,s,r;if(i.length>0){for(s=0,r=i.length;r>s;s++)n=i[s],n.isFile?n.file(function(i){return e.options.ignoreHiddenFiles&&"."===i.name.substring(0,1)?void 0:(i.fullPath=t+"/"+i.name,e.addFile(i))}):n.isDirectory&&e._addFilesFromDirectory(n,t+"/"+n.name);o()}return null},n)}}(this))()},t.prototype.accept=function(e,i){return e.size>1024*this.options.maxFilesize*1024?i(this.options.dictFileTooBig.replace("{{filesize}}",Math.round(e.size/1024/10.24)/100).replace("{{maxFilesize}}",this.options.maxFilesize)):t.isValidFile(e,this.options.acceptedFiles)?null!=this.options.maxFiles&&this.getAcceptedFiles().length>=this.options.maxFiles?(i(this.options.dictMaxFilesExceeded.replace("{{maxFiles}}",this.options.maxFiles)),this.emit("maxfilesexceeded",e)):this.options.accept.call(this,e,i):i(this.options.dictInvalidFileType)},t.prototype.addFile=function(e){return e.upload={progress:0,total:e.size,bytesSent:0},this.files.push(e),e.status=t.ADDED,this.emit("addedfile",e),this._enqueueThumbnail(e),this.accept(e,function(t){return function(i){return i?(e.accepted=!1,t._errorProcessing([e],i)):(e.accepted=!0,t.options.autoQueue&&t.enqueueFile(e)),t._updateMaxFilesReachedClass()}}(this))},t.prototype.enqueueFiles=function(e){var t,i,n;for(i=0,n=e.length;n>i;i++)t=e[i],this.enqueueFile(t);return null},t.prototype.enqueueFile=function(e){if(e.status!==t.ADDED||e.accepted!==!0)throw new Error("This file can't be queued because it has already been processed or was rejected.");return e.status=t.QUEUED,this.options.autoProcessQueue?setTimeout(function(e){return function(){return e.processQueue()}}(this),0):void 0},t.prototype._thumbnailQueue=[],t.prototype._processingThumbnail=!1,t.prototype._enqueueThumbnail=function(e){return this.options.createImageThumbnails&&e.type.match(/image.*/)&&e.size<=1024*this.options.maxThumbnailFilesize*1024?(this._thumbnailQueue.push(e),setTimeout(function(e){return function(){return e._processThumbnailQueue()}}(this),0)):void 0},t.prototype._processThumbnailQueue=function(){return this._processingThumbnail||0===this._thumbnailQueue.length?void 0:(this._processingThumbnail=!0,this.createThumbnail(this._thumbnailQueue.shift(),function(e){return function(){return e._processingThumbnail=!1,e._processThumbnailQueue()}}(this)))},t.prototype.removeFile=function(e){return e.status===t.UPLOADING&&this.cancelUpload(e),this.files=without(this.files,e),this.emit("removedfile",e),0===this.files.length?this.emit("reset"):void 0},t.prototype.removeAllFiles=function(e){var i,n,o,s;for(null==e&&(e=!1),s=this.files.slice(),n=0,o=s.length;o>n;n++)i=s[n],(i.status!==t.UPLOADING||e)&&this.removeFile(i);return null},t.prototype.createThumbnail=function(e,t){var i;return i=new FileReader,i.onload=function(n){return function(){return"image/svg+xml"===e.type?(n.emit("thumbnail",e,i.result),void(null!=t&&t())):n.createThumbnailFromUrl(e,i.result,t)}}(this),i.readAsDataURL(e)},t.prototype.createThumbnailFromUrl=function(e,t,i,n){var o;return o=document.createElement("img"),n&&(o.crossOrigin=n),o.onload=function(t){return function(){var n,s,r,l,a,u,c,d;return e.width=o.width,e.height=o.height,c=t.options.resize.call(t,e),null==c.trgWidth&&(c.trgWidth=c.optWidth),null==c.trgHeight&&(c.trgHeight=c.optHeight),n=document.createElement("canvas"),s=n.getContext("2d"),n.width=c.trgWidth,n.height=c.trgHeight,drawImageIOSFix(s,o,null!=(r=c.srcX)?r:0,null!=(l=c.srcY)?l:0,c.srcWidth,c.srcHeight,null!=(a=c.trgX)?a:0,null!=(u=c.trgY)?u:0,c.trgWidth,c.trgHeight),d=n.toDataURL("image/png"),t.emit("thumbnail",e,d),null!=i?i():void 0}}(this),null!=i&&(o.onerror=i),o.src=t},t.prototype.processQueue=function(){var e,t,i,n;if(t=this.options.parallelUploads,i=this.getUploadingFiles().length,e=i,!(i>=t)&&(n=this.getQueuedFiles(),n.length>0)){if(this.options.uploadMultiple)return this.processFiles(n.slice(0,t-i));for(;t>e;){if(!n.length)return;this.processFile(n.shift()),e++}}},t.prototype.processFile=function(e){return this.processFiles([e])},t.prototype.processFiles=function(e){var i,n,o;for(n=0,o=e.length;o>n;n++)i=e[n],i.processing=!0,i.status=t.UPLOADING,this.emit("processing",i);return this.options.uploadMultiple&&this.emit("processingmultiple",e),this.uploadFiles(e)},t.prototype._getFilesWithXhr=function(e){var t,i;return i=function(){var i,n,o,s;for(o=this.files,s=[],i=0,n=o.length;n>i;i++)t=o[i],t.xhr===e&&s.push(t);return s}.call(this)},t.prototype.cancelUpload=function(e){var i,n,o,s,r,l,a;if(e.status===t.UPLOADING){for(n=this._getFilesWithXhr(e.xhr),o=0,r=n.length;r>o;o++)i=n[o],i.status=t.CANCELED;for(e.xhr.abort(),s=0,l=n.length;l>s;s++)i=n[s],this.emit("canceled",i);this.options.uploadMultiple&&this.emit("canceledmultiple",n)}else((a=e.status)===t.ADDED||a===t.QUEUED)&&(e.status=t.CANCELED,this.emit("canceled",e),this.options.uploadMultiple&&this.emit("canceledmultiple",[e]));return this.options.autoProcessQueue?this.processQueue():void 0},n=function(){var e,t;return t=arguments[0],e=2<=arguments.length?slice.call(arguments,1):[],"function"==typeof t?t.apply(this,e):t},t.prototype.uploadFile=function(e){return this.uploadFiles([e])},t.prototype.uploadFiles=function(e){var o,s,r,l,a,u,c,d,h,p,f,m,g,v,_,b,w,y,T,L,S,C,k,M,E,A,P,V,I,x,F,D,U,N;for(N=new XMLHttpRequest,f=0,_=e.length;_>f;f++)o=e[f],o.xhr=N;L=n(this.options.method,e),D=n(this.options.url,e),N.open(L,D,!0),N.withCredentials=!!this.options.withCredentials,x=null,r=function(t){return function(){var i,n,s;for(s=[],i=0,n=e.length;n>i;i++)o=e[i],s.push(t._errorProcessing(e,x||t.options.dictResponseError.replace("{{statusCode}}",N.status),N));return s}}(this),F=function(t){return function(i){var n,s,r,l,a,u,c,d,h;if(null!=i)for(d=100*i.loaded/i.total,s=0,l=e.length;l>s;s++)o=e[s],o.upload={progress:d,total:i.total,bytesSent:i.loaded};else{for(n=!0,d=100,r=0,a=e.length;a>r;r++)o=e[r],(100!==o.upload.progress||o.upload.bytesSent!==o.upload.total)&&(n=!1),o.upload.progress=d,o.upload.bytesSent=o.upload.total;if(n)return}for(h=[],c=0,u=e.length;u>c;c++)o=e[c],h.push(t.emit("uploadprogress",o,d,o.upload.bytesSent));return h}}(this),N.onload=function(i){return function(n){var o,s;if(e[0].status!==t.CANCELED&&4===N.readyState){if(x=N.responseText,N.getResponseHeader("content-type")&&~N.getResponseHeader("content-type").indexOf("application/json"))try{x=JSON.parse(x)}catch(o){n=o,x="Invalid JSON response from server."}return F(),200<=(s=N.status)&&300>s?i._finished(e,x,n):r()}}}(this),N.onerror=function(){return function(){return e[0].status!==t.CANCELED?r():void 0}}(this),k=null!=(M=N.upload)?M:N,k.onprogress=F,u={Accept:"application/json","Cache-Control":"no-cache","X-Requested-With":"XMLHttpRequest"},this.options.headers&&i(u,this.options.headers);for(l in u)a=u[l],a&&N.setRequestHeader(l,a);if(s=new FormData,this.options.params){E=this.options.params;for(g in E)U=E[g],s.append(g,U)}for(m=0,b=e.length;b>m;m++)o=e[m],this.emit("sending",o,N,s);if(this.options.uploadMultiple&&this.emit("sendingmultiple",e,N,s),"FORM"===this.element.tagName)for(A=this.element.querySelectorAll("input, textarea, select, button"),v=0,w=A.length;w>v;v++)if(d=A[v],h=d.getAttribute("name"),p=d.getAttribute("type"),"SELECT"===d.tagName&&d.hasAttribute("multiple"))for(P=d.options,T=0,y=P.length;y>T;T++)C=P[T],C.selected&&s.append(h,C.value);else(!p||"checkbox"!==(V=p.toLowerCase())&&"radio"!==V||d.checked)&&s.append(h,d.value);for(c=S=0,I=e.length-1;I>=0?I>=S:S>=I;c=I>=0?++S:--S)s.append(this._getParamName(c),e[c],e[c].name);return this.submitRequest(N,s,e)},t.prototype.submitRequest=function(e,t){return e.send(t)},t.prototype._finished=function(e,i,n){var o,s,r;for(s=0,r=e.length;r>s;s++)o=e[s],o.status=t.SUCCESS,this.emit("success",o,i,n),this.emit("complete",o);return this.options.uploadMultiple&&(this.emit("successmultiple",e,i,n),this.emit("completemultiple",e)),this.options.autoProcessQueue?this.processQueue():void 0},t.prototype._errorProcessing=function(e,i,n){var o,s,r;for(s=0,r=e.length;r>s;s++)o=e[s],o.status=t.ERROR,this.emit("error",o,i,n),this.emit("complete",o);return this.options.uploadMultiple&&(this.emit("errormultiple",e,i,n),this.emit("completemultiple",e)),this.options.autoProcessQueue?this.processQueue():void 0},t}(Emitter),Dropzone.version="4.2.0",Dropzone.options={},Dropzone.optionsForElement=function(e){return e.getAttribute("id")?Dropzone.options[camelize(e.getAttribute("id"))]:void 0},Dropzone.instances=[],Dropzone.forElement=function(e){if("string"==typeof e&&(e=document.querySelector(e)),null==(null!=e?e.dropzone:void 0))throw new Error("No Dropzone found for given element. This is probably because you're trying to access it before Dropzone had the time to initialize. Use the `init` option to setup any additional observers on your Dropzone.");return e.dropzone},Dropzone.autoDiscover=!0,Dropzone.discover=function(){var e,t,i,n,o,s;for(document.querySelectorAll?i=document.querySelectorAll(".dropzone"):(i=[],e=function(e){var t,n,o,s;for(s=[],n=0,o=e.length;o>n;n++)t=e[n],s.push(/(^| )dropzone($| )/.test(t.className)?i.push(t):void 0);return s},e(document.getElementsByTagName("div")),e(document.getElementsByTagName("form"))),s=[],n=0,o=i.length;o>n;n++)t=i[n],s.push(Dropzone.optionsForElement(t)!==!1?new Dropzone(t):void 0);return s},Dropzone.blacklistedBrowsers=[/opera.*Macintosh.*version\/12/i],Dropzone.isBrowserSupported=function(){var e,t,i,n,o;if(e=!0,window.File&&window.FileReader&&window.FileList&&window.Blob&&window.FormData&&document.querySelector)if("classList"in document.createElement("a"))for(n=Dropzone.blacklistedBrowsers,t=0,i=n.length;i>t;t++)o=n[t],o.test(navigator.userAgent)&&(e=!1);else e=!1;else e=!1;return e},without=function(e,t){var i,n,o,s;for(s=[],n=0,o=e.length;o>n;n++)i=e[n],i!==t&&s.push(i);return s},camelize=function(e){return e.replace(/[\-_](\w)/g,function(e){return e.charAt(1).toUpperCase()})},Dropzone.createElement=function(e){var t;return t=document.createElement("div"),t.innerHTML=e,t.childNodes[0]},Dropzone.elementInside=function(e,t){if(e===t)return!0;for(;e=e.parentNode;)if(e===t)return!0;return!1},Dropzone.getElement=function(e,t){var i;if("string"==typeof e?i=document.querySelector(e):null!=e.nodeType&&(i=e),null==i)throw new Error("Invalid `"+t+"` option provided. Please provide a CSS selector or a plain HTML element.");return i},Dropzone.getElements=function(e,t){var i,n,o,s,r,l,a,u,c;if(e instanceof Array){o=[];try{for(r=0,a=e.length;a>r;r++)n=e[r],o.push(this.getElement(n,t))}catch(s){i=s,o=null}}else if("string"==typeof e)for(o=[],c=document.querySelectorAll(e),l=0,u=c.length;u>l;l++)n=c[l],o.push(n);else null!=e.nodeType&&(o=[e]);if(null==o||!o.length)throw new Error("Invalid `"+t+"` option provided. Please provide a CSS selector, a plain HTML element or a list of those.");return o},Dropzone.confirm=function(e,t,i){return window.confirm(e)?t():null!=i?i():void 0},Dropzone.isValidFile=function(e,t){var i,n,o,s,r;if(!t)return!0;for(t=t.split(","),s=e.type,i=s.replace(/\/.*$/,""),n=0,o=t.length;o>n;n++)if(r=t[n],r=r.trim(),"."===r.charAt(0)){if(-1!==e.name.toLowerCase().indexOf(r.toLowerCase(),e.name.length-r.length))return!0}else if(/\/\*$/.test(r)){if(i===r.replace(/\/.*$/,""))return!0}else if(s===r)return!0;return!1},"undefined"!=typeof jQuery&&null!==jQuery&&(jQuery.fn.dropzone=function(e){return this.each(function(){return new Dropzone(this,e)})}),"undefined"!=typeof module&&null!==module?module.exports=Dropzone:window.Dropzone=Dropzone,Dropzone.ADDED="added",Dropzone.QUEUED="queued",Dropzone.ACCEPTED=Dropzone.QUEUED,Dropzone.UPLOADING="uploading",Dropzone.PROCESSING=Dropzone.UPLOADING,Dropzone.CANCELED="canceled",Dropzone.ERROR="error",Dropzone.SUCCESS="success",detectVerticalSquash=function(e){var t,i,n,o,s,r,l,a,u,c;for(l=e.naturalWidth,r=e.naturalHeight,i=document.createElement("canvas"),i.width=1,i.height=r,n=i.getContext("2d"),n.drawImage(e,0,0),o=n.getImageData(0,0,1,r).data,c=0,s=r,a=r;a>c;)t=o[4*(a-1)+3],0===t?s=a:c=a,a=s+c>>1;
return u=a/r,0===u?1:u},drawImageIOSFix=function(e,t,i,n,o,s,r,l,a,u){var c;return c=detectVerticalSquash(t),e.drawImage(t,i,n,o,s,r,l,a,u/c)},contentLoaded=function(e,t){var i,n,o,s,r,l,a,u,c;if(o=!1,c=!0,n=e.document,u=n.documentElement,i=n.addEventListener?"addEventListener":"attachEvent",a=n.addEventListener?"removeEventListener":"detachEvent",l=n.addEventListener?"":"on",s=function(i){return"readystatechange"!==i.type||"complete"===n.readyState?(("load"===i.type?e:n)[a](l+i.type,s,!1),!o&&(o=!0)?t.call(e,i.type||i):void 0):void 0},r=function(){var e,t;try{u.doScroll("left")}catch(t){return e=t,void setTimeout(r,50)}return s("poll")},"complete"!==n.readyState){if(n.createEventObject&&u.doScroll){try{c=!e.frameElement}catch(d){}c&&r()}return n[i](l+"DOMContentLoaded",s,!1),n[i](l+"readystatechange",s,!1),e[i](l+"load",s,!1)}},Dropzone._autoDiscoverFunction=function(){return Dropzone.autoDiscover?Dropzone.discover():void 0},contentLoaded(window,Dropzone._autoDiscoverFunction),Dropzone.prototype.defaultOptions.directoryUpload=Dropzone.directoryUploadSupport,Dropzone.prototype.clickableElementsToUploadDirectory=[],Dropzone.prototype.setupDirectoryUploadInput=function(){if(Dropzone.directoryUploadSupport){if(this.options.directoryUpload&&(this.clickableElementsToUploadDirectory=this.options.directoryUpload===!0?[this.element]:Dropzone.getElements(this.options.directoryUpload,"directoryUpload")),this.hiddenFileInput&&this.options.directoryUpload&&(this.hiddenDirectoryUploadInput&&this.hiddenDirectoryUploadInput.parentNode.removeChild(this.hiddenDirectoryUploadInput),this.hiddenDirectoryUploadInput=this.hiddenFileInput.cloneNode(!1),this.hiddenDirectoryUploadInput)){document.querySelector(this.options.hiddenInputContainer).appendChild(this.hiddenDirectoryUploadInput),this.hiddenDirectoryUploadInput.setAttribute("webkitdirectory",""),this.hiddenDirectoryUploadInput.setAttribute("mozdirectory",""),this.hiddenDirectoryUploadInput.setAttribute("directory","");var e=function(e){return function(){e.hiddenDirectoryUploadInput.addEventListener("change",function(){var t,i,n,o;if(i=e.hiddenDirectoryUploadInput.files,i.length)for(n=0,o=i.length;o>n;n++){if(t=i[n],e.options.ignoreHiddenFiles){for(var s=t.webkitRelativePath.split("/"),r=!1,l=0;l<s.length;l++)if("."===s[l].substring(0,1)){r=!0;break}if(r)continue}if(e.addFile(t),t.errorCode===Dropzone.ERROR_CODES.EXCEEDED_MAX_NUM_OF_FILES)break}e.emit("addedfiles",i),e.hiddenDirectoryUploadInput.value=""})}}(this);e()}var t=this.listeners.length;this.clickableElementsToUploadDirectory.forEach(function(e){return function(t){return e.listeners.push({element:t,events:{click:function(i){return(t!==e.element||i.target===e.element||Dropzone.elementInside(i.target,e.element.querySelector(".dz-message")))&&e.hiddenDirectoryUploadInput.click(),!0}}})}}(this));var i=function(e){return function(){var i,n,o,s,r,l,a;for(l=e.listeners,a=[],o=t,s=l.length;s>o;o++)i=l[o],a.push(function(){var e,t;e=i.events,t=[];for(n in e)r=e[n],t.push(i.element.addEventListener(n,r,!1));return t}());return a}}(this);i()}},Dropzone.prototype.destroy=function(){var e;return this.disable(),this.removeAllFiles(!0),(null!=(e=this.hiddenFileInput)?e.parentNode:void 0)&&(this.hiddenFileInput.parentNode.removeChild(this.hiddenFileInput),this.hiddenFileInput=null),(null!=(e=this.hiddenDirectoryUploadInput)?e.parentNode:void 0)&&(this.hiddenDirectoryUploadInput.parentNode.removeChild(this.hiddenDirectoryUploadInput),this.hiddenDirectoryUploadInput=null),delete this.element.dropzone,Dropzone.instances.splice(Dropzone.instances.indexOf(this),1)},Dropzone.prototype.drop=function(e){Dropzone.dragAndDropSupport&&ThisLife.Helper.Features.whenReady("upp",function(t){if(!(t&&Shr&&Shr.Dialog&&Shr.Dialog.isOpen())){var i,n;e.dataTransfer&&(this.emit("drop",e),i=e.dataTransfer.files,i.length&&(n=e.dataTransfer.items,n&&n.length&&null!=n[0].webkitGetAsEntry?this._addFilesFromItems(n):(this.handleFiles(i),this.emit("addedfiles",i))))}}.bind(this))},Dropzone.prototype._addFilesFromItems=function(e){var t=this,i=[],n=function(e,t,i){return $.when.apply($,$.map(e,function(e){return o(e,t,i)})).pipe(function(){return Array.prototype.concat.apply([],arguments)})},o=function(e,t,i){var o,s=$.Deferred(),r=function(t){t&&!t.entry&&(t.entry=e),s.resolve([t])},l=function(a){n(a,[],i+e.name+"/").done(function(e){t=t.concat(e),a.length>0&&null!=o?o.readEntries(l,r):s.resolve(t)}).fail(r)};return i=i||"",e.isFile?e._file?(e._file.fullPath=i+e._file.name,s.resolve(e._file)):e.file(function(e){e.fullPath=i+e.name,s.resolve(e)},r):e.isDirectory?(o=e.createReader(),o.readEntries(l,r)):s.resolve([]),s.promise()};return n($.map(e,function(e){return null!=e.webkitGetAsEntry&&(entry=e.webkitGetAsEntry())&&entry?(entry._file=e.getAsFile(),entry):e.getAsEntry()}),i).done(function(e){var i,n,o;if(e.length>0){for(i=0,n=e.length;n>i&&(o=e[i],t.options.ignoreHiddenFiles&&"."===o.name.substring(0,1)||(t.addFile(o),o.errorCode!==Dropzone.ERROR_CODES.EXCEEDED_MAX_NUM_OF_FILES));i++);t.emit("addedfiles",e)}})},Dropzone.prototype.defaultOptions.removedfile=function(e){return e.previewElement&&(null!=(_ref=e.previewElement)&&_ref.parentNode?_ref.parentNode.removeChild(e.previewElement):e.previewElement=null),this._updateMaxFilesReachedClass()},Dropzone.prototype.createThumbnailFromUrl=function(e,t,i,n){try{var o;return o=document.createElement("img"),n&&(o.crossOrigin=n),o.onload=function(t){return function(){try{var n,s,r,l,a,u,c,d;if(e.width=o.width,e.height=o.height,c=t.options.resize.call(t,e),null==c.trgWidth&&(c.trgWidth=c.optWidth),null==c.trgHeight&&(c.trgHeight=c.optHeight),n=document.createElement("canvas"),s=n.getContext("2d"),n.width=c.trgWidth,n.height=c.trgHeight,drawImageIOSFix(s,o,null!=(r=c.srcX)?r:0,null!=(l=c.srcY)?l:0,c.srcWidth,c.srcHeight,null!=(a=c.trgX)?a:0,null!=(u=c.trgY)?u:0,c.trgWidth,c.trgHeight),d=n.toDataURL("image/png"),t.emit("thumbnail",e,d),null!=i)return i()}catch(h){ThisLife.log.debug("In dropzone_extension.js createThumbnailFromUrl() img.onload : "+h)}}}(this),null!=i&&(o.onerror=i),o.src=t}catch(s){ThisLife.log.debug("In dropzone_extension.js createThumbnailFromUrl(): "+s)}},drawImageIOSFix=function(e,t,i,n,o,s,r,l,a,u){var c;try{return c=detectVerticalSquash(t),e.drawImage(t,i,n,o,s,r,l,a,u/c)}catch(d){ThisLife.log.debug("In dropzone_extension.js drawImageIOSFix(): "+d)}},Dropzone.prototype.createThumbnail=function(e,t){try{var i;return i=new FileReader,i.onload=function(n){return function(){try{return"image/svg+xml"===e.type?(n.emit("thumbnail",e,i.result),void(null!=t&&t())):n.createThumbnailFromUrl(e,i.result,t)}catch(o){ThisLife.log.debug("In dropzone_extension.js createThumbnail() fileReader.onload : "+o)}}}(this),i.readAsDataURL(e)}catch(n){ThisLife.log.debug("In dropzone_extension.js createThumbnail(): "+n)}},Dropzone.prototype.defaultOptions.thumbnail=function(e,t){var i,n,o,s;if(e.previewElement){for(e.previewElement.classList.remove("dz-file-preview"),o=e.previewElement.querySelectorAll("[data-dz-thumbnail]"),i=0,n=o.length;n>i;i++)s=o[i],s.alt=e.name,s.src=t;return setTimeout(function(){return function(){return e.previewElement?e.previewElement.classList.add("dz-image-preview"):void 0}}(this),1)}},Dropzone.ERROR_CODES={BROWSER_INCOMPATIBLE_FOR_DIR_DROP:0,EXCEEDED_MAX_NUM_OF_FILES:1,INVALID_FILE_TYPE:2,INVALID_IMAGE_FILE_SIZE:3,INVALID_VIDEO_FILE_SIZE:4,EXCEEDED_MAX_NUM_OF_TRIES:5,ABORTED:6,DUPLICATED:7,SAVE_FAILED:8,ZERO_IMAGE_FILE_SIZE:9},Dropzone.prototype.accept=function(e,t){var i,n=require("ThisLife.Uploader.Helpers.Upload");return!e.type&&!Dropzone.directoryUploadSupport||!e.type&&Dropzone.directoryUploadSupport&&e.size%4096==0?(e.errorCode=Dropzone.ERROR_CODES.BROWSER_INCOMPATIBLE_FOR_DIR_DROP,t(this.options.dictInvalidFileType)):null!=this.options.maxFiles&&this.getAcceptedFiles().length>=this.options.maxFiles?(e.errorCode=Dropzone.ERROR_CODES.EXCEEDED_MAX_NUM_OF_FILES,t(this.options.dictMaxFilesExceeded.replace("{{maxFiles}}",this.options.maxFiles)),this.emit("maxfilesexceeded",e)):Dropzone.isValidFile(e,this.options.acceptedFiles)?(i=n.isImage(e.name))===!0&&e.size>1024*this.options.maxFilesize*1024?(e.errorCode=Dropzone.ERROR_CODES.INVALID_IMAGE_FILE_SIZE,t(this.options.dictFileTooBig.replace("{{fileName}}",e.name).replace("{{filesize}}",Math.round(e.size/1024/10.24)/100).replace("{{maxFilesize}}",this.options.maxFilesize))):!i&&e.size>1024*this.options.videoMaxFileSize*1024?(e.errorCode=Dropzone.ERROR_CODES.INVALID_VIDEO_FILE_SIZE,t(this.options.dictFileTooBig.replace("{{fileName}}",e.name).replace("{{filesize}}",Math.round(e.size/1024/10.24)/100).replace("{{maxFilesize}}",this.options.videoMaxFileSize))):0==e.size?(e.errorCode=Dropzone.ERROR_CODES.ZERO_IMAGE_FILE_SIZE,t(this.options.dictFileZero.replace("{{fileName}}",e.name))):this.options.accept.call(this,e,t):(e.errorCode=Dropzone.ERROR_CODES.INVALID_FILE_TYPE,t(this.options.dictInvalidFileType))},Dropzone.prototype.addFile=function(e){return e.upload={progress:0,total:e.size,bytesSent:0},this.files.push(e),e.status=Dropzone.ADDED,this.emit("addedfile",e),this.accept(e,function(t){return function(i){return i?(e.accepted=!1,t._errorProcessing([e],i)):(e.accepted=!0,t.options.autoQueue&&(t._enqueueThumbnail(e),t.enqueueFile(e))),t._updateMaxFilesReachedClass()}}(this))},Dropzone.prototype.handleFiles=function(e){var t,i,n,o=[];for(i=0,n=e.length;n>i&&(t=e[i],o.push(this.addFile(t)),t.errorCode!==Dropzone.ERROR_CODES.EXCEEDED_MAX_NUM_OF_FILES);i++);return o},Dropzone.prototype.enqueueFiles=function(e){var t,i,n;for(i=0,n=e.length;n>i;i++)t=e[i],this._enqueueThumbnail(t),this.enqueueFile(t);return null},Dropzone.prototype.init=function(){var e,t,i,n,o,s,r;for("form"===this.element.tagName&&this.element.setAttribute("enctype","multipart/form-data"),this.element.classList.contains("dropzone")&&!this.element.querySelector(".dz-message")&&this.element.appendChild(Dropzone.createElement('<div class="dz-default dz-message"><span>'+this.options.dictDefaultMessage+"</span></div>")),this.clickableElements.length&&(r=function(e){return function(){return e.hiddenFileInput&&e.hiddenFileInput.parentNode.removeChild(e.hiddenFileInput),e.hiddenFileInput=document.createElement("input"),e.hiddenFileInput.setAttribute("type","file"),(null==e.options.maxFiles||e.options.maxFiles>1)&&e.hiddenFileInput.setAttribute("multiple","multiple"),e.hiddenFileInput.className="dz-hidden-input",null!=e.options.acceptedFiles&&e.hiddenFileInput.setAttribute("accept",e.options.acceptedFiles),null!=e.options.capture&&e.hiddenFileInput.setAttribute("capture",e.options.capture),e.hiddenFileInput.style.visibility="hidden",e.hiddenFileInput.style.position="absolute",e.hiddenFileInput.style.top="0",e.hiddenFileInput.style.left="0",e.hiddenFileInput.style.height="0",e.hiddenFileInput.style.width="0",document.querySelector(e.options.hiddenInputContainer).appendChild(e.hiddenFileInput),e.hiddenFileInput.addEventListener("change",function(){var t,i,n,o;if(i=e.hiddenFileInput.files,i.length)for(n=0,o=i.length;o>n&&(t=i[n],e.addFile(t),t.errorCode!==Dropzone.ERROR_CODES.EXCEEDED_MAX_NUM_OF_FILES);n++);return e.emit("addedfiles",i),r()})}}(this))(),this.URL=null!=(o=window.URL)?o:window.webkitURL,s=this.events,t=0,i=s.length;i>t;t++)e=s[t],this.on(e,this.options[e]);return this.on("uploadprogress",function(e){return function(){return e.updateTotalUploadProgress()}}(this)),this.on("removedfile",function(e){return function(){return e.updateTotalUploadProgress()}}(this)),this.on("canceled",function(e){return function(t){return e.emit("complete",t)}}(this)),this.on("complete",function(e){return function(){return 0===e.getAddedFiles().length&&0===e.getUploadingFiles().length&&0===e.getQueuedFiles().length?setTimeout(function(){return e.emit("queuecomplete")},0):void 0}}(this)),n=function(e){return e.stopPropagation(),e.preventDefault?e.preventDefault():e.returnValue=!1},this.listeners=[],Dropzone.dragAndDropSupport&&this.listeners.push({element:this.element,events:{dragstart:function(e){return function(t){return e.emit("dragstart",t)}}(this),dragenter:function(e){return function(t){return n(t),e.emit("dragenter",t)}}(this),dragover:function(e){return function(t){var i;try{i=t.dataTransfer.effectAllowed}catch(o){}return t.dataTransfer.dropEffect="move"===i||"linkMove"===i?"move":"copy",n(t),e.emit("dragover",t)}}(this),dragleave:function(e){return function(t){return e.emit("dragleave",t)}}(this),drop:function(e){return function(t){return n(t),e.drop(t)}}(this),dragend:function(e){return function(t){return e.emit("dragend",t)}}(this)}}),this.clickableElements.forEach(function(e){return function(t){return e.listeners.push({element:t,events:{click:function(i){return(t!==e.element||i.target===e.element||Dropzone.elementInside(i.target,e.element.querySelector(".dz-message")))&&e.hiddenFileInput.click(),!0}}})}}(this)),this.enable(),this.options.init.call(this)},function(){var e=document.createElement("input");e.type="file",Dropzone.directoryUploadSupport=!!("webkitdirectory"in(e||document.querySelectorAll("input[type=file]")[0]))&&!bowser.msedge}(),function(){Dropzone.dragAndDropSupport=!bowser.msedge}();var originalProcessQueue=Dropzone.prototype.processQueue;Dropzone.prototype.processQueue=function(){originalProcessQueue.call(this);try{this._processThumbnailQueue()}catch(e){ThisLife.log.debug("In dropzone_extension.js processQueue(): "+e)}},Dropzone.prototype._processThumbnailQueue=function(){try{if(this._thumbnailProcessCounter=this._thumbnailProcessCounter||0,this._thumbnailProcessCounter>=this.options.parallelUploads+1||0===this._thumbnailQueue.length)return void(this._thumbnailProcessCounter=0);if(this._processingThumbnail)return;return this._processingThumbnail=!0,this.createThumbnail(this._thumbnailQueue.shift(),function(e){return function(){try{return e._thumbnailProcessCounter++,e._processingThumbnail=!1,e._processThumbnailQueue()}catch(t){ThisLife.log.debug("In dropzone_extension.js createThumbnail() callback: "+t)}}}(this))}catch(e){ThisLife.log.debug("In dropzone_extension.js _processThumbnailQueue(): "+e)}};var originalUploadFiles=Dropzone.prototype.uploadFiles;Dropzone.prototype.uploadFiles=function(e){var t;if("temp"==this.options.url){var i,n,o;for(o=[],i=0,n=e.length;n>i;i++)t=e[i],o.push(this._errorProcessing(e,555),null);return o}originalUploadFiles.apply(this,arguments)};var originalSubmitRequest=Dropzone.prototype.submitRequest;Dropzone.prototype.submitRequest=function(e,t,i){t.has&&!t.has(this.options.paramName)&&i&&1==i.length&&t.append(this.options.paramName,i[0],i[0].name),e.setRequestHeader("X-OPENFLY-Authorization",ThisLife.uploadToken),e.setRequestHeader("X-OPENFLY-VERSION","1.0"),originalSubmitRequest.apply(this,arguments)},function(){var e={}.hasOwnProperty;define("ThisLife.Uploader.Helpers.Upload",[],function(){var t;return t={mediaTypes:{TYPE_VIDEO:"video",TYPE_TEXT:"text",TYPE_IMAGE:"image",TYPE_MILESTONE:"milestone"},mediaInfo:{IMAGE:{jpeg:{momentType:"image",mediaType:"ImageMedia",mimeType:"image/jpeg",ext:".jpeg"},jpg:{momentType:"image",mediaType:"ImageMedia",mimeType:"image/jpeg",ext:".jpg"}},VIDEO:{flv:{momentType:"video",mediaType:"VideoMedia",mimeType:"video/x-flv",ext:".flv"},mp4:{momentType:"video",mediaType:"VideoMedia",mimeType:"video/mp4",ext:".mp4"},mp2:{momentType:"video",mediaType:"VideoMedia",mimeType:"video/mpeg",ext:".mp2"},mpeg:{momentType:"video",mediaType:"VideoMedia",mimeType:"video/mpeg",ext:".mpeg"},mpg:{momentType:"video",mediaType:"VideoMedia",mimeType:"video/mpeg",ext:".mpg"},mov:{momentType:"video",mediaType:"VideoMedia",mimeType:"video/quicktime",ext:".mov"},qt:{momentType:"video",mediaType:"VideoMedia",mimeType:"video/quicktime",ext:".qt"},asf:{momentType:"video",mediaType:"VideoMedia",mimeType:"video/x-la-asf",ext:".asf"},avi:{momentType:"video",mediaType:"VideoMedia",mimeType:"video/x-msvideo",ext:".avi"},movie:{momentType:"video",mediaType:"VideoMedia",mimeType:"video/x-sgi-movie",ext:".movie"},m4v:{momentType:"video",mediaType:"VideoMedia",mimeType:"video/x-m4v",ext:".m4v"},dv:{momentType:"video",mediaType:"VideoMedia",mimeType:"video/x-dv",ext:".dv"},mts:{momentType:"video",mediaType:"VideoMedia",mimeType:"video/x-mts",ext:".mts"},m2ts:{momentType:"video",mediaType:"VideoMedia",mimeType:"video/x-m2ts",ext:".m2ts"},"3gpp":{momentType:"video",mediaType:"VideoMedia",mimeType:"video/x-3gpp",ext:".3gpp"},"3gp":{momentType:"video",mediaType:"VideoMedia",mimeType:"video/x-3gp",ext:".3gp"},wmv:{momentType:"video",mediaType:"VideoMedia",mimeType:"video/x-ms-wmv",ext:".wmv"}}},_fileItem:function(){var e;return e=this.getUniqueId(),{uniqueId:e,uid:e,url:"",moment_type:this.mediaTypes.TYPE_IMAGE,life_uid:ThisLife.lifeUid,retryCount:0}},getUniqueId:function(){return(new Date).valueOf()+""+(new Date).getUTCMilliseconds()+parseInt(1e10*Math.random(),10)},getAcceptableFileTypes:function(){var t,i,n,o,s,r;r="",t=1;try{t=ThisLife.Model.User.getAllowedMediaType()}catch(l){ThisLife.log.debug("MomentHelper.getAcceptableFileTypes(): looks like User info has not been loaded yet.")}o=this.mediaInfo.IMAGE;for(n in o)e.call(o,n)&&(i=o[n],r+=i.ext+",");if(t>1){s=this.mediaInfo.VIDEO;for(n in s)e.call(s,n)&&(i=s[n],r+=i.ext+",")}return(null!=r?r.lastIndexOf(","):void 0)&&(r=r.slice(0,-1)),ThisLife.log.debug("MomentHelper.getAcceptableFileTypes(): Uploader AcceptedTypes: "+r),r},isImage:function(e){return this.getMomentType(this.getFileExtension(e.toLowerCase()))===this.mediaTypes.TYPE_IMAGE},getUploadObject:function(e){var t,i;return i=this.isImage(e.name),t=this._fileItem(),t.moment_type=this.getMomentType(this.getFileExtension(e.name.toLowerCase())),e.uniqueId=t.uniqueId,t.moment_type===this.mediaTypes.TYPE_VIDEO?this._getVideoUploadObject(e,t):this._getImageUploadObject(e,t),t},_getVideoUploadObject:function(e,t){var i;return i=e.lastModified/1e3,_.extend(t,{name:e.name,size:e.size,group:"VIDEO_SOURCE",type:"BLOB",lastModifiedDate:i,metadata_date:i,moment_date:i,albumId:e.albumId?e.albumId:"",status:e.status,accepted:e.accepted,accessKey:"",acl:"",signature:"",policy:"",success_action_status:"201",key:"",source:"html5app"})},_getImageUploadObject:function(e,t){return _.extend(t,{name:e.name,size:e.size,albumId:e.albumId?e.albumId:"",status:e.status,accepted:e.accepted,channel:"THISLIFE"})},getMomentType:function(e){return this.mediaInfo.VIDEO[e]?this.mediaTypes.TYPE_VIDEO:this.mediaInfo.IMAGE[e]?this.mediaTypes.TYPE_IMAGE:void 0},getFileExtension:function(e){return e.slice(e.lastIndexOf(".")+1,e.length).toLowerCase()},getSFlyHeaders:function(e,t){var i,n;return n={"SFLY-Application-Name":ThisLife.LogSmithManager.APP_NAME,"SFLY-Application-Version":ThisLife.LogSmithManager.APP_VERSION},e.sfly_transaction_id&&(n["SFLY-TransactionId"]=e.sfly_transaction_id),t&&(i="WEBSITE-COMPUTER",bowser.tablet?i="WEBSITE-TABLET":bowser.mobile&&(i="WEBSITE-PHONE"),n["SFLY-Experience-Type"]=i,n["SFLY-Upload-Source"]="UPLOAD",n["SFLY-Browser"]=bowser.name,n["SFLY-Browser-Version"]=bowser.version),n},getUUID:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t,i;return t=16*Math.random()|0,i="x"===e?t:3&t|8,i.toString(16)})},setSFlyTransactionId:function(e,t,i){var n;return n=10>i?"000":100>i?"00":1e3>i?"0":"",e.sfly_transaction_id=ThisLife.lifeUid+"-"+t+"-"+n+i}}})}.call(this),function(){define("ThisLife.Uploader.TrackingFiles",[],function(){var e;return e=function(){function e(){this.categories=["summary"],this.os="other",ThisLife.Helper.Platform.macOSX()?this.os="mac":ThisLife.Helper.Platform.windows()?this.os="windows":ThisLife.Helper.Platform.android()?this.os="android":ThisLife.Helper.Platform.ios()&&(this.os="ios"),this.categories.push("os."+this.os),this.device="desktop",bowser.mobile?this.device="phone":bowser.tablet&&(this.device="tablet"),this.categories.push("device."+this.device),this.browser="other",bowser.chrome?this.browser="chrome":bowser.firefox?this.browser="firefox":bowser.safari?this.browser="safari":bowser.msie?this.browser="ie":bowser.msedge&&(this.browser="edge"),this.categories.push("browser."+this.browser)}return e.prototype.reportUploadSuccess=function(e){var t,i,n,o,s,r;for(i=(new Date).getTime(),s=this.categories,r=[],n=0,o=s.length;o>n;n++)t=s[n],ThisLife.LogSmithManager.enqueueMetrics({status:"success",name:"size_bytes",value:e.trackSize,type:e.type,timestamp:i,category:t}),r.push(ThisLife.LogSmithManager.enqueueMetrics({status:"success",name:"time_ms",value:e.trackTime,type:e.type,timestamp:i,category:t}));return r},e.prototype.reportUploadFail=function(e){var t,i,n,o,s,r;for(i=(new Date).getTime(),s=this.categories,r=[],n=0,o=s.length;o>n;n++)t=s[n],r.push(ThisLife.LogSmithManager.enqueueMetrics({value:1,timestamp:i,category:t,type:e.type,status:e.status||"",statusCode:e.statusCode,errCode:e.errCode}));return r},e}()})}.call(this),function(){define("ThisLife.Uploader.TrackingSession",[],function(){var e;return e=function(){function e(e){this.categories=["summary"],this.os="other",ThisLife.Helper.Platform.macOSX()?this.os="mac":ThisLife.Helper.Platform.windows()?this.os="windows":ThisLife.Helper.Platform.android()?this.os="android":ThisLife.Helper.Platform.ios()&&(this.os="ios"),this.categories.push("os."+this.os),this.device="desktop",bowser.mobile?this.device="phone":bowser.tablet&&(this.device="tablet"),this.categories.push("device."+this.device),this.browser="other",bowser.chrome?this.browser="chrome":bowser.firefox?this.browser="firefox":bowser.safari?this.browser="safari":bowser.msie?this.browser="ie":bowser.msedge&&(this.browser="edge"),this.categories.push("browser."+this.browser),this.startTime=(new Date).getTime(),this.startCount=e.count,this.failLogged=!1,this.reportSessionStart()}return e.prototype.reportSessionStart=function(){var e,t,i,n,o;for(this.sessionStarted=!0,n=this.categories,o=[],t=0,i=n.length;i>t;t++)e=n[t],o.push(ThisLife.LogSmithManager.enqueueSessionMetrics({value:this.startCount,timestamp:this.startTime,category:e,name:"start"}));return o},e.prototype.reportSessionEnd=function(e){var t,i,n,o,s,r,l,a,u,c;if(this.sessionStarted){for(this.sessionStarted=!1,n=(new Date).getTime(),c=n-this.startTime,s=e.uploadedImagesSize/1024,u=c/1e3,t=e.uploadedImagesCount<3?"single":"multiple",l=this.categories,a=[],o=0,r=l.length;r>o;o++)i=l[o],ThisLife.LogSmithManager.enqueueSessionMetrics({name:"end",value:e.uploadedImagesCount,timestamp:n,category:i}),ThisLife.LogSmithManager.enqueueSessionMetrics({name:t+".time_ms",value:c,timestamp:n,category:i}),ThisLife.LogSmithManager.enqueueSessionMetrics({name:t+".size_bytes",value:e.uploadedImagesSize,timestamp:n,category:i}),a.push(ThisLife.LogSmithManager.enqueueSessionMetrics({name:t+".kbps",value:s/u,timestamp:n,category:i}));return a}},e.prototype.reportSessionFail=function(){var e,t,i,n,o;if(!this.failLogged){for(t=(new Date).getTime(),o=this.categories,i=0,n=o.length;n>i;i++)e=o[i],ThisLife.LogSmithManager.enqueueSessionMetrics({value:1,timestamp:t,name:"failed",category:e});return this.failLogged=!0}},e.prototype.reportSessionAppend=function(e){var t,i,n,o,s,r;for(i=(new Date).getTime(),s=this.categories,r=[],n=0,o=s.length;o>n;n++)t=s[n],r.push(ThisLife.LogSmithManager.enqueueSessionMetrics({value:e.count,timestamp:i,category:t,name:"append"}));return r},e.prototype.reportSessionCancel=function(){var e,t,i,n,o,s;if(!this.failLogged){for(t=(new Date).getTime(),o=this.categories,s=[],i=0,n=o.length;n>i;i++)e=o[i],s.push(ThisLife.LogSmithManager.enqueueSessionMetrics({timestamp:t,category:e,name:"cancel",value:1}));return s}},e}()})}.call(this),function(){define("ThisLife.Uploader.Controllers.Uploader",["ThisLife.Uploader.Views.Dropzone","ThisLife.Uploader.Controllers.PhotosUploader","ThisLife.Uploader.Views.Progress","ThisLife.Uploader.Helpers.Upload","ThisLife.Uploader.Views.UPP","ThisLife.Uploader.Controllers.VideosUploader","ThisLife.Helper.Features"],function(e,t,i,n,o,s,r){var l;return l=function(){function l(){this.photosUploadController=new t({uploadController:this}),this.videosUploadController=new s({uploadController:this}),r.whenReady("upp",function(e){return function(t){return e.useUPP=t,e.initViews(),e.initUPP(),e.setup(),e.setCollectionCount()}}(this)),this.thumbnailProcessorCount=0,this.maxNoOfTries=2,this.uniupErrCodesDontRetry={500:["2002","2005","2013"]},this.uniupDupeCheckErrCode={status:409,errorCode:"1024"},this.uniupFormatErrCode={status:417,errorCode:"1027"},this.unauthorizedErrCode=401}return _.extend(l.prototype,Backbone.Events),l.prototype.setUseUPP=function(e){return this.useUPP=e},l.prototype.initUPP=function(e){return null==e&&(e={}),this.useUPP?o.bootstrap(e):void 0},l.prototype.initViews=function(){return this.dropzone=new e({controller:this}),this.useUPP?void 0:this.uploadProgressModal=new i({controller:this})},l.prototype.remove=function(){var e;return null!=(e=this.uploadProgressModal)&&e.remove(),this.dropzone.remove(),Backbone.View.prototype.remove.apply(this)},l.prototype.setup=function(){return this.allCurrentFiles={},this.failedOrSkippedFiles={},this.tempFailedFiles={},this.uploadedSoFarFiles={},this.uploadedButDeletedDupeFiles={},this.fileItems={},this.autoUploads=[],this.mostRecentUploads=[],this.savedMomentsCount=0,this.dupesCount=0,this.destinationAlbums=[],this.destinationAlbumsCounts={},this.uploadStartTime=void 0,this.uploadingVideos=!1},l.prototype.setCollectionCount=function(){this.collectionCount=ThisLife.Collection.moments.length},l.prototype.resetFileQueues=function(){var e;ThisLife.log.debug("UploaderController: resetFileQueues()"),this.isUploading()?ThisLife.log.debug("UploaderController: resetFileQueues(), cannot reset file queues, upload still in progress."):(ThisLife.log.debug("UploaderController: resetFileQueues(), resetting as nothing is being uploaded."),this.setup(),this.uploadStartTime=Date.now(),(null!=(e=this.uploadProgressModal)?e.isDisplayed():void 0)&&this.uploadProgressModal.hide())},l.prototype.startUpload=function(){return this.dropzone.dz.enqueueFiles(_.filter(this.dropzone.dz.files,function(e){var t;return e.status===Dropzone.ADDED&&e.accepted&&(null!=(t=ThisLife.uploader.fileItems[e.uniqueId])?t.canUpload:void 0)}))},l.prototype.upp=function(e){return null==e&&(e={}),o.show(e)},l.prototype.forceUpdate=function(){return o.forceUpdate()},l.prototype.addedFiles=function(e){var t,i,o,s,r,l,a,u,c,d,h,p,f,m,g;for(ThisLife.log.debug("UploaderController.addedFiles() start",e),this.resetFileQueues(),g=[],d=!1,l=!1,h=!1,t=0,a=0,o=n.getUUID(),s="albums"===ThisLife.app.currentState.name?ThisLife.app.album.getCurrentAlbum():null,"storyLandingUpload"===ThisLife.app.currentState.name&&(s=ThisLife.Model.Albums.Master.getAlbumById(ThisLife.currentStory)),i=void 0,s&&!s.isLocked()?(ThisLife.log.debug("Current album uid : "+s.get("uid")),this.destinationAlbums.push(s.get("uid")),this.destinationAlbumsCounts[s.get("uid")]=ThisLife.app.album.noMoments(),i=s.get("uid")):s&&s.isLocked()&&(h=!0),this.autoUploads=[],u=0,c=e.length;c>u;u++)if(r=e[u],r.accepted)i&&(r.albumId=i),this.useUPP?this.autoUploads.push(r):(m=n.getUploadObject(r),this.fileItems[m.uniqueId]=m,this.updateAllCurrentFilesList(m),m.moment_type===n.mediaTypes.TYPE_VIDEO?(this.uploadingVideos=!0,m.canUpload=!1,g.push(m)):(this.photosUploadController.setImageUploadUrl(m),m.canUpload=!0,a++,n.setSFlyTransactionId(m,o,a))),t++;else if(ThisLife.log.debug("Sorry, "+r.name+" is not an accepted file. Error Code : "+r.errorCode),r.errorCode&&r.errorCode>1&&r.errorCode!==Dropzone.ERROR_CODES.ZERO_IMAGE_FILE_SIZE&&(this.updateFailedOrSkippedFilesList(r),this.updateAllCurrentFilesList(r)),r.errorCode===Dropzone.ERROR_CODES.EXCEEDED_MAX_NUM_OF_FILES){if(d=!0,t===this.dropzone.dz.options.maxFiles)break}else r.errorCode===Dropzone.ERROR_CODES.BROWSER_INCOMPATIBLE_FOR_DIR_DROP&&(l=!0);return this.useUPP?this.upp({albumId:i,files:this.autoUploads,bypass:!0}):(g.length>0&&this.videosUploadController.getVideoUploadUrls(g),a>0&&(this.photosUploadController.onDzAddedFiles(a),this.startUpload()),(t>0||_.size(this.allCurrentFiles)-t>0&&!(null!=(p=this.uploadProgressModal)?p.isDisplayed():void 0))&&this.uploadProgressModal.renderUploadState(),t>0&&ThisLife.PubSub.trigger("upload:start"),null!=(f=this.uploadProgressModal)&&f.handleErrors({uploadingFiles:t>0,showReadOnlyAccessError:h,showMaxFilesError:d,showFolderDropError:l})),ThisLife.log.debug("UploaderController.addedFiles() end")},l.prototype.processing=function(e){var t,i,n,o,s;ThisLife.log.debug("UploaderController: in processing event handler start, "+e.name+" "+e.uniqueId),t=this.fileItems[e.uniqueId],t&&(this.dropzone.dz.options.url=t.url,o=null!=(i=this.uploadProgressModal)?i.getThumbnailElement():void 0,null!=(n=this._getControllerByMomentType(e))&&n.onDzProcessing(e,t),e.previewElement&&o&&(window.setTimeout(function(){var t;if(o)try{o.innerHTML="",o.appendChild&&o.appendChild(e.previewElement)}catch(i){t=i}},600*s),s++,s===this.dropzone.dz.options.parallelUploads&&(s=0)),ThisLife.log.debug("UploaderController: in processing event handler end, "+e.name+" "+e.uniqueId))},l.prototype.sending=function(e,t,i){var n;return null!=(n=this._getControllerByMomentType(e))?n.onDzSending(e,t,i):void 0},l.prototype.success=function(e,t){var i;return null!=(i=this._getControllerByMomentType(e))?i.onDzSuccess(e,t):void 0},l.prototype.error=function(e,t,i){var o,s,r,l,a,u,c,d,h,p,f,m,g,v,_,b,w,y,T;if(null!=e){if((null!=i?i.status:void 0)===this.uniupDupeCheckErrCode.status&&(w=JSON.parse(i.response),c=w.context.mediaId?w.context.mediaId+"":w.context.mediaIds[0]+"",u=ThisLife.Collection.moments.get(c),null!=u))return e.status=Dropzone.SUCCESS,void this.success(e,w);if(ThisLife.log.debug("UploaderController: on error"),e.accepted&&e.uniqueId&&(a=this.fileItems[e.uniqueId]))if(y=i?i.status:0,T=Date.now()-a.initTime,"object"==typeof t&&(r=t.errorCode,l=t.errorDescription,s=y===this.uniupDupeCheckErrCode.status&&(null!=(d=t.context)&&null!=(h=d.mediaIds)?h.length:void 0)>0?t.context.mediaIds[0]:void 0,s&&this.mostRecentUploads.push({id:s+"",moment_type:a.moment_type,isDuplicate:!0,uniqueId:a.uniqueId})),this.updateTempFailedFiles(e,y,r),this.tempFailedFiles[e.uniqueId]){if(ThisLife.log.debug("UploaderController: on error - upload failed for "+e.name+". No of tries so far: "+this.tempFailedFiles[e.uniqueId].noOfTries),ThisLife.log.debug("UploaderController: trying to upload "+e.name+" again."),this.dropzone.dz.options.url=a.url,e.status=Dropzone.UPLOADING,a.retryCount++,this.dropzone.dz.uploadFile(e),y===this.unauthorizedErrCode)return null!=(p=ThisLife.app)&&"function"==typeof p.controller&&null!=(f=p.controller("timing"))&&f.recordSessionEvents({event:"uploader",err:this.unauthorizedErrCode,session_method:"error"}),"function"==typeof(o=ThisLife.app.session).forceSessionRefresh?o.forceSessionRefresh():void 0}else if(a.initTime&&0!==a.initTime&&e.status!==Dropzone.CANCELED&&(a.moment_type===n.mediaTypes.TYPE_IMAGE?(null!=(m=this.photosUploadController.uploaderTrackingSession)&&m.reportSessionFail(),null!=(g=this.photosUploadController.uploaderTrackingFiles)&&g.reportUploadFail({type:"photo",statusCode:y,errCode:r})):null!=(v=this.videosUploadController.uploadTrackingFiles)&&v.reportUploadFail({type:"video",status:"upload",statusCode:y,errCode:r}),y===this.unauthorizedErrCode))return null!=(_=ThisLife.app)&&"function"==typeof _.controller&&null!=(b=_.controller("timing"))&&b.recordSessionEvents({event:"uploader",err:this.unauthorizedErrCode,session_method:"error"}),ThisLife.app.logout()}},l.prototype.queuecomplete=function(){var e;this.dropzone.dz.getUploadingFiles().length<=0&&(this.isUploading()||this.dropzone.dz.removeAllFiles(!1),this.uploadingVideos||(this.toggleActions(),this.setCollectionCount()),null!=(e=this.photosUploadController)&&e.onDzQueueComplete())},l.prototype.momentUploadComplete=function(){var e,t,i,n;null!=(e=this.uploadProgressModal)&&e.removeErrorModals(),this.uploadStartTime&&(null!=(t=this.photosUploadController.uploaderTrackingSession)&&t.reportSessionEnd({uploadedImagesCount:this.photosUploadController.uploadedImagesCount,uploadedImagesSize:this.photosUploadController.uploadedImagesSize}),this.uploadStartTime=void 0),null!=(i=this.uploadProgressModal)&&i.momentUploadComplete(),ThisLife.PubSub.trigger("upload:complete"),null!=(n=ThisLife.View.magicShop)&&"function"==typeof n.show&&n.show()},l.prototype.toggleActions=function(){var e,t,i,n,o,s,r;if(this.isSaving()||(this.momentUploadComplete(),null!=(n=this.uploadProgressModal)&&n.enableActions()),e=this.getCurrentAlbumDetails(),i=e.currentAlbumIdInView,t=e.currentAlbum,null!=(o=this.uploadProgressModal)&&o.toggleAddToAlbumBtnDisplay(e.canShowAddToAlbum),i&&this.destinationAlbums.indexOf(i)>-1?null!=(s=this.uploadProgressModal)&&s.toggleViewNewBtn(!0):null!=(r=this.uploadProgressModal)&&r.toggleViewNewBtn(!1),i&&this.destinationAlbums.indexOf(i)>-1&&"upload"===ThisLife.app.currentState.options.view){if(this.destinationAlbumsCounts[i])return t.set("moment_count",1),t.set("visible_moment_count",1),ThisLife.app.router.navigateToAlbum(ThisLife.app.currentState.options.album_uid,{replace:!0,trigger:!0})
}else if("timeline"===ThisLife.app.currentState.name&&0===this.collectionCount)return ThisLife.app.router.navigateToLibrary()},l.prototype.getCurrentAlbumDetails=function(){var e,t,i;return t="albums"===ThisLife.app.currentState.name?ThisLife.app.album.getCurrentAlbum():null,t&&!t.isViewOnly()&&(i=t.get("uid")),e=0===_.size(this.mostRecentUploads)||i&&this.destinationAlbums.indexOf(i)>-1?!1:!0,{currentAlbum:t,currentAlbumIdInView:i,canShowAddToAlbum:e}},l.prototype.getRecentUploads=function(){return this.mostRecentUploads},l.prototype.getAllCurrentFiles=function(){return this.allCurrentFiles},l.prototype.getFailedOrSkippedFiles=function(){return this.failedOrSkippedFiles},l.prototype.getFailedOrSkippedFilesCount=function(){var e,t,i;for(i=_.keys(this.failedOrSkippedFiles),e=0,t=0;t<i.length;)e+=_.size(this.failedOrSkippedFiles[i[t]]),t++;return e},l.prototype.getUnacceptedFilesCount=function(){return _.size(this.failedOrSkippedFiles[Dropzone.ERROR_CODES.INVALID_FILE_TYPE])+_.size(this.failedOrSkippedFiles[Dropzone.ERROR_CODES.INVALID_IMAGE_FILE_SIZE])+_.size(this.failedOrSkippedFiles[Dropzone.ERROR_CODES.INVALID_VIDEO_FILE_SIZE])},l.prototype.getUploadedSoFarFiles=function(){return this.uploadedSoFarFiles},l.prototype.getUploadedButDeletedDupeFiles=function(){return this.uploadedButDeletedDupeFiles},l.prototype.isUploading=function(){var e;return e=null!=o?o.checkUploadStatus():void 0,e||_.size(this.getAllCurrentFiles())>this.getFailedOrSkippedFilesCount()+_.size(this.getUploadedSoFarFiles())},l.prototype.isSaving=function(){return!(!this.isUploading()&&this.savedMomentsCount+this.dupesCount>=_.size(this.getUploadedSoFarFiles()))},l.prototype.getSavedMomentCount=function(){return this.savedMomentsCount},l.prototype.getDupesCount=function(){return this.dupesCount},l.prototype.updateTempFailedFiles=function(e,t,i){var n;n=e.uniqueId,n&&(this.tempFailedFiles[n]?0===t||401===t||t>=500&&-1===this.uniupErrCodesDontRetry[500].indexOf(i)?this.tempFailedFiles[n].noOfTries++:this.tempFailedFiles[n].noOfTries=this.maxNoOfTries+1:this.tempFailedFiles[n]={noOfTries:0===t||401===t||t>=500&&-1===this.uniupErrCodesDontRetry[500].indexOf(i)?1:this.maxNoOfTries+1,name:e.name,status:e.status,uniqueId:n},this.tempFailedFiles[n].noOfTries>this.maxNoOfTries&&(e.errorCode=t===this.uniupDupeCheckErrCode.status&&i===this.uniupDupeCheckErrCode.errorCode?Dropzone.ERROR_CODES.DUPLICATED:t===this.uniupFormatErrCode.status&&i===this.uniupFormatErrCode.errorCode?Dropzone.ERROR_CODES.INVALID_FILE_TYPE:Dropzone.ERROR_CODES.EXCEEDED_MAX_NUM_OF_TRIES,this.updateFailedOrSkippedFilesList(e),delete this.tempFailedFiles[n]),e.status===Dropzone.CANCELED&&delete this.tempFailedFiles[n])},l.prototype.updateFailedOrSkippedFilesList=function(e){var t;e&&(t=null!=e.uniqueId?e.uniqueId:n.getUniqueId(),e.uniqueId=t,this.failedOrSkippedFiles[e.errorCode]=this.failedOrSkippedFiles[e.errorCode]||{},this.failedOrSkippedFiles[e.errorCode][t]=this.failedOrSkippedFiles[e.errorCode][t]||{name:e.name,status:e.status,uniqueId:t,errorCode:e.errorCode},delete this.uploadedSoFarFiles[t])},l.prototype.updateUploadedButDeletedDupeFilesList=function(e){var t;t=e.uniqueId,t&&!this.uploadedButDeletedDupeFiles[t]&&(this.uploadedButDeletedDupeFiles[t]={name:e.name,status:e.status,uniqueId:t,errorCode:Dropzone.ERROR_CODES.DUPLICATED})},l.prototype.updateUploadedSoFarFilesList=function(e){var t;t=e.uniqueId,t&&!this.uploadedSoFarFiles[t]&&(this.uploadedSoFarFiles[t]={name:e.name}),this.failedOrSkippedFiles[e.errorCode]&&delete this.failedOrSkippedFiles[e.errorCode][t],delete this.tempFailedFiles[t]},l.prototype.updateAllCurrentFilesList=function(e){null==e.uniqueId||this.allCurrentFiles[e.uniqueId]||(this.allCurrentFiles[e.uniqueId]={name:e.name,moment_type:e.moment_type})},l.prototype._getControllerByMomentType=function(e){var t;return(t=e.moment_type||this.fileItems[e.uniqueId].moment_type)?t===n.mediaTypes.TYPE_VIDEO?this.videosUploadController:this.photosUploadController:void 0},l.prototype.updateSavedMomentCount=function(e,t){return this.videosUploadController.updateSavedMomentCount(e,t)},l.prototype.abort=function(){var e,t,i,n,o,s,r;if(ThisLife.log.debug("UploaderController: abort()"),null!=this.dropzone.dz){for(e=this.dropzone.dz.getAcceptedFiles(),this.dropzone.dz.options.autoProcessQueue=!1,this.dropzone.dz.removeAllFiles(!0),i=0,n=e.length;n>i;i++)t=e[i],t.status!==Dropzone.SUCCESS&&(t.errorCode||(t.errorCode=Dropzone.ERROR_CODES.ABORTED),this.updateFailedOrSkippedFilesList(t));this.dropzone.dz.options.autoProcessQueue=!0,null!=(o=this.photosUploadController.uploaderTrackingSession)&&o.reportSessionCancel(),null!=(s=this.photosUploadController.uploaderTrackingSession)&&s.reportSessionEnd({uploadedImagesCount:this.photosUploadController.uploadedImagesCount,uploadedImagesSize:this.photosUploadController.uploadedImagesSize}),this.uploadStartTime=void 0}return null!=(r=this.uploadProgressModal)?r.removeErrorModals():void 0},l}()})}.call(this),function(){define("ThisLife.Uploader.Controllers.PhotosUploader",["ThisLife.Uploader.Helpers.Upload","ThisLife.Uploader.TrackingSession","ThisLife.Uploader.TrackingFiles"],function(e,t,i){var n;return n=function(){function n(e){this.options=null!=e?e:{},this.uploadController=this.options.uploadController}return _.extend(n.prototype,Backbone.Events),n.prototype.onDzAddedFiles=function(e){var n;return this.imageFileCount=e,(null!=(n=this.uploaderTrackingSession)?n.sessionStarted:void 0)?this.uploaderTrackingSession.reportSessionAppend({count:this.imageFileCount}):this.uploaderTrackingSession=new t({count:this.imageFileCount}),this.uploaderTrackingFiles||(this.uploaderTrackingFiles=new i),this.uploadStartTime=(new Date).getTime(),this.updateUploadedImagesMetrics(!0)},n.prototype.onDzProcessing=function(t,i){var n;return ThisLife.log.debug("PhotosUploaderController: in processing event handler start "+t.name+" "+t.uniqueId),this.uploadController.dropzone.dz.options.headers=e.getSFlyHeaders(i,!0),n=document.createElement("div"),n.appendChild(document.createElement("span")),n.className="dz-image-thumbnail",t.previewElement=n,ThisLife.log.debug("PhotosUploaderController: in processing event handler end "+t.name+" "+t.uniqueId)},n.prototype.onDzSending=function(e){var t;return ThisLife.log.debug("PhotosUploaderController: in sending event handler start "+e.name+" "+e.uniqueId),t=this.uploadController.fileItems[e.uniqueId],t&&(t.initTime=Date.now()),ThisLife.log.debug("PhotosUploaderController: in sending event handler end "+e.name+" "+e.uniqueId)},n.prototype.onDzSuccess=function(e,t){var i,n,o,s,r,l,a,u,c,d,h;return ThisLife.log.debug("PhotosUploaderController: in Success event handler for "+e.name,e,t),c=t,(o=this.uploadController.fileItems[e.uniqueId])?(s=409===t.httpStatus,h=Date.now()-o.initTime,this.uploadController.updateUploadedSoFarFilesList(e),this.updateUploadedImagesMetrics(!1,e.size),this.uploadController.uploadProgressModal.updateUploadProgress(),this.uploadController.savedMomentsCount++,c.mediaId?(l=this.responseToMoment(t),l.filename=e.name,this.uploadController.mostRecentUploads.push({id:c.mediaId+"",moment_type:o.moment_type,isDuplicate:!1,uniqueId:o.uniqueId})):s&&(u=c.context.mediaId?c.context.mediaId+"":c.context.mediaIds[0]+"",l=ThisLife.Collection.moments.get(u),this.uploadController.mostRecentUploads.push({id:u,moment_type:"image",isDuplicate:!1,uniqueId:o.uniqueId}),l.set({hidden:!1}),c.context.uploadedDate&&(d=new Date(c.context.uploadedDate).getTime()/1e3,l.set({upload_date:d}))),this.uploaderTrackingFiles.reportUploadSuccess({trackTime:h,trackSize:o.size,type:"photo"}),ThisLife.Collection.moments.get(l.uid||l.id)||(r=ThisLife.Collection.moments.addMoment(l),ThisLife.Model.User.updateMomentCount(r,!0)),i="albums"===ThisLife.app.currentState.name?ThisLife.app.album.getCurrentAlbum():null,"storyLandingUpload"===ThisLife.app.currentState.name&&(i=ThisLife.Model.Albums.Master.getAlbumById(ThisLife.currentStory)),i&&!i.isLocked()&&(n=i.get("uid"),n===e.albumId)?s?(a=l.toJSON(),ThisLife.app.album.addMoments(n,[a])):ThisLife.app.album.addMoments(n,[l]):void 0):void 0},n.prototype.responseToMoment=function(t){var i;return i={},i.enhanced=!1,i.height=t.height,i.hidden=!1,i.highlight=!1,i.item_type="moment",i.moment_date=t.capturedDate/1e3,i.moment_type="image",i.month_cover=!1,i.orig_file_extension=e.getFileExtension(t.locationSpec),i.original_filename=t.locationSpec,i.rating=0,i.uid=t.mediaId+"",i.upload_date=t.uploadDate/1e3,i.width=t.width,i},n.prototype.setImageUploadUrl=function(e){var t;return t=ThisLife.Settings.imageUploadUrl+ThisLife.currentLifeOwner,t+="?name="+encodeURIComponent(e.name),t+="&size="+e.size.toString(),t+="&hidden=false",t+="&collectionId="+ThisLife.lifeUid,t+="&verifyDupe=true",t+="&uploadSource=html5app",e.albumId&&(t+="&albumId="+e.albumId),e.url=t},n.prototype.updateUploadedImagesMetrics=function(e,t){return e?(this.uploadedImagesCount=0,this.uploadedImagesSize=0):(this.uploadedImagesCount++,t?this.uploadedImagesSize+=t:void 0)},n.prototype.onDzQueueComplete=function(){return this.errorLogged=!1},n}()})}.call(this),function(){define("ThisLife.Uploader.Controllers.VideosUploader",["ThisLife.Uploader.Helpers.Upload","ThisLife.Uploader.TrackingFiles"],function(e,t){var i;return i=function(){function i(e){this.options=null!=e?e:{},this.uploadController=this.options.uploadController}return _.extend(i.prototype,Backbone.Events),i.prototype.onDzProcessing=function(e){var t;return ThisLife.log.debug("VideosUploaderController: in processing event handler start "+e.name+" "+e.uniqueId),t=document.createElement("div"),t.className="dz-video-thumbnail",e.previewElement=t,ThisLife.log.debug("VideosUploaderController: in processing event handler end "+e.name+" "+e.uniqueId)},i.prototype.onDzSending=function(e,t,i){var n;return ThisLife.log.debug("VideosUploaderController: in sending event handler start "+e.name+" "+e.uniqueId),i.append("Filename",e.name),(n=this.uploadController.fileItems[e.uniqueId])?(n.initTime=Date.now(),this._appendFormDataParams(i,n),ThisLife.log.debug("VideosUploaderController: in sending event handler end "+e.name+" "+e.uniqueId)):void 0},i.prototype.onDzSuccess=function(e,t){var i,n,o;return ThisLife.log.debug("VideosUploaderController: in Success event handler for "+e.name,e,t),(i=this.uploadController.fileItems[e.uniqueId])?(this.uploadController.updateUploadedSoFarFilesList(e),this.uploadController.uploadProgressModal.updateUploadProgress(),o=this._prepareResponseObject(i),n=this._prepareMomentObject(i),this._saveVideoAfterUploaded(n,o,i)):void 0},i.prototype.updateSavedMomentCount=function(e,t){var i,n;return i=this.uploadController.dupesCount,n=_.find(this.uploadController.mostRecentUploads,function(i){return function(n){var o,s;if(n&&e){if(o=i.uploadController.fileItems[n.uniqueId],n.id===e)return n.isDuplicate=!0,n.id=t,!0;if(n.id===e.id)return o&&null!=(s=i.uploaderTrackingFiles)&&s.reportUploadSuccess({type:"video",trackSize:o.size,trackTime:Date.now()-o.origTime}),!0}return!1}}(this)),e&&n&&this.uploadController.savedMomentsCount++,i!==this.uploadController.dupesCount&&(this.uploadController.mostRecentUploads=_.filter(this.uploadController.mostRecentUploads,function(e){return!e.isDuplicate})),this.uploadController.toggleActions(),this.uploadController.setCollectionCount()},i.prototype.getVideoUploadUrls=function(e){var i,n;return i=function(e){return function(t){var i,n,o;if(null!==e.uploadController.dropzone.dz&&t&&t.length>0){for(n=0;n<t.length;)o=t[n],i=e.uploadController.fileItems[o.uid],i=_.extend(i,{url:o.url,sfly_transaction_id:o.X_SFLY_TransactionId,accessKey:o.accessKey,policy:o.policy,signature:o.signature,acl:o.acl,key:o.key,canUpload:!0}),n++;return e.uploadController.startUpload()}}}(this),n=function(e){return function(t){return e.uploaderTrackingFiles.reportUploadFail({type:"video",status:"getUrl",statusCode:t.status,errCode:t.errorCode}),e.uploadController.uploadProgressModal.isDisplayed()&&e.uploadController.uploadProgressModal.hide(),e.uploadController.momentUploadComplete()}}(this),this.uploaderTrackingFiles||(this.uploaderTrackingFiles=new t),ThisLife.Service.api.getUploadUrl(e,i,n)},i.prototype._saveVideoAfterUploaded=function(t,i,n){var o,s,r;return r=n.uniqueId,s=e.getSFlyHeaders(n),o=function(i){return function(o){var s,l;if(o){if(l=o.status||0===o.status?o.status:200,n&&(n.origTime=n.initTime,n.initTime=Date.now()),null!=(s=o.result)?!s.success:!0)return n.errorCode=Dropzone.ERROR_CODES.SAVE_FAILED,i.uploadController.updateFailedOrSkippedFilesList(n),i.uploadController.mostRecentUploads=_.filter(i.uploadController.mostRecentUploads,function(e){return e.uniqueId!==r}),i.uploadController.isSaving()||i.uploadController.momentUploadComplete(),i.uploaderTrackingFiles.reportUploadFail({type:"video",status:"saveVideo",statusCode:"fail",errCode:n.errorCode});if(o.result.payload&&o.result.payload.moment_uid&&(i.uploadController.mostRecentUploads.push({id:o.result.payload.moment_uid+"",moment_type:t.moment_type,isDuplicate:!1,uniqueId:r}),t.moment_type===e.mediaTypes.TYPE_VIDEO))return i.uploadController.uploadProgressModal.updateMainMessage()}}}(this),ThisLife.Service.api.saveVideo(t,i,o,o,s)},i.prototype._getFileItemByUniqueId=function(e){var t,i,n,o;for(o=this._files,i=0,n=o.length;n>i;i++)if(t=o[i],t.uniqueId===e)return t;return null},i.prototype._prepareMomentObject=function(e){var t;return t={uid:e.uid,life_uid:e.life_uid,moment_type:e.moment_type,moment_date:e.moment_date,metadata_date:e.metadata_date,source:e.source,albumId:e.albumId}},i.prototype._prepareResponseObject=function(e){var t;return t={key:e.key,name:e.name,size:e.size}},i.prototype._appendFormDataParams=function(e,t){return e.append("policy",t.policy),e.append("signature",t.signature),e.append("AWSAccessKeyId",t.accessKey),e.append("key",t.key),e.append("acl",t.acl),e.append("success_action_status",t.success_action_status)},i}()})}.call(this),function(){var e,t;e=Backbone.View.extend({className:"dz-drag-hover-overlay",initialize:function(){return this.open=!1},render:function(){return ThisLife.Helper.Features.whenReady("upp",function(e){return function(t){return e.useUPP=t,$(e.el).html(e.template()).show()}}(this)),this},show:function(){return this.useUPP&&Shr&&Shr.Dialog&&Shr.Dialog.isOpen()?!1:this.open?void 0:(document.body.appendChild(this.render().el),this.open=!0)},hide:function(){return this.open?($(this.el).hide(),this.open=!1):void 0},template:function(){var e;return e=ThisLife.Model.User.isPaidAccount()?"photos and videos":"photos","  <div class='dz-drag-hover-wrap'>\n    <div class=\"content\">\n      <div class='image'>\n        <!-- Cloud icon -->\n      </div>\n      <div class='header-text'>\n        Drag "+e+" to upload\n      </div>\n    </div>\n</div>"}}),ThisLife.Uploader||(ThisLife.Uploader={}),(t=ThisLife.Uploader).View||(t.View={}),ThisLife.Uploader.View.DropzoneOverlay=e}.call(this),function(){define("ThisLife.Uploader.Views.Dropzone",["ThisLife.Uploader.Helpers.Upload"],function(e){var t;return t=Backbone.View.extend({initialize:function(t){return this.options=null!=t?t:{},this.controller=this.options.controller,this.render(),this.bindEvents(),this.dz=new Dropzone("body",{maxFiles:1e3,maxFilesize:75,videoMaxFileSize:2048,maxThumbnailFilesize:5,createImageThumbnails:!1,previewTemplate:"<div><img data-dz-thumbnail /></div>",thumbnailWidth:140,thumbnailHeight:140,dictFileTooBig:"{{fileName}} is too big ({{filesize}}MiB). Max filesize: {{maxFilesize}}MiB.",dictFileZero:"{{fileName}} is 0 bytes",parallelUploads:3,clickable:"#moment_dropzone_clickable",directoryUpload:"#directory_upload_clickable",previewsContainer:this.getPreviewsContainer(),autoQueue:!1,acceptedFiles:e.getAcceptableFileTypes(),overLay:this.dropzoneOverlay,url:"temp",init:this._dzInitCallback}),this.initDropzoneEvents()},render:function(){var e,t;return e=document.createElement("a"),e.setAttribute("id","moment_dropzone_clickable"),document.body.appendChild(e),Dropzone.directoryUploadSupport&&(t=document.createElement("a"),t.setAttribute("id","directory_upload_clickable"),document.body.appendChild(t)),this.dropzoneOverlay=new ThisLife.Uploader.View.DropzoneOverlay},bindEvents:function(){return ThisLife.PubSub.on("api:subscriptionUpdated",this.updateDzAcceptedFiles,this)},remove:function(){var e;return this.dz.destroy(),null!=(e=this.dropzoneOverlay)&&e.remove(),Backbone.View.prototype.remove.apply(this)},_dzInitCallback:function(){var e,t;return this.setupDirectoryUploadInput(),e=!1,Dropzone.dragAndDropSupport?(document.addEventListener("dragstart",function(){return e=!0}),document.addEventListener("dragend",function(){return e=!1}),t=[],this.on("dragenter",function(i){return function(n){var o;if(!(ThisLife.app.controller("uploader").useUPP&&Shr&&Shr.Dialog&&Shr.Dialog.isOpen()))return t.unshift(n.type),e?void 0:null!=(o=i.options.overLay)?o.show():void 0}}(this)),this.on("dragover",function(){return function(e){return ThisLife.app.controller("uploader").useUPP&&Shr&&Shr.Dialog&&Shr.Dialog.isOpen()?void 0:t.unshift(e.type)}}(this)),this.on("dragend",function(e){return function(){var i;if(!(ThisLife.app.controller("uploader").useUPP&&Shr&&Shr.Dialog&&Shr.Dialog.isOpen()))return t.splice(0),null!=(i=e.options.overLay)?i.hide():void 0}}(this)),this.on("dragleave",function(e){return function(){var i;if(!(ThisLife.app.controller("uploader").useUPP&&Shr&&Shr.Dialog&&Shr.Dialog.isOpen()))return t.length>0&&"dragover"===t[0]?(t.splice(0),null!=(i=e.options.overLay)?i.hide():void 0):void 0}}(this)),this.on("drop",function(e){return function(){var i;if(!(ThisLife.app.controller("uploader").useUPP&&Shr&&Shr.Dialog&&Shr.Dialog.isOpen()))return t.splice(0),null!=(i=e.options.overLay)?i.hide():void 0}}(this))):void 0},initDropzoneEvents:function(){return this.dz.on("addedfiles",function(e){return function(t){return e.controller.addedFiles(t)}}(this)),this.dz.on("processing",function(e){return function(t){return e.controller.processing(t)}}(this)),this.dz.on("sending",function(e){return function(t,i,n){return e.controller.sending(t,i,n)}}(this)),this.dz.on("success",function(e){return function(t,i){return e.controller.success(t,i)}}(this)),this.dz.on("error",function(e){return function(t,i,n){return e.controller.error(t,i,n)}}(this)),this.dz.on("queuecomplete",function(e){return function(t){return e.controller.queuecomplete(t)}}(this))},getPreviewsContainer:function(){return this.dzPreviewContainerEl=document.createElement("div"),this.dzPreviewContainerEl.setAttribute("class","dropzone-previews"),this.dzPreviewContainerEl},updateDzAcceptedFiles:function(){return ThisLife.log.debug("DropzoneView: onSubscriptionUpdated -> updateDzAcceptedFiles()"),null!=this.dz?(this.dz.options.acceptedFiles=e.getAcceptableFileTypes(),this.dz.hiddenFileInput.setAttribute("accept",this.dz.options.acceptedFiles)):void 0}})})}.call(this),function(){var e,t;e=Backbone.View.extend({events:{"click .file-upload-btn":"clickFileUpload","click .folder-upload-btn":"clickFolderUpload"},initialize:function(){return this.render()},render:function(){return this.$el.html(this.template()),this.fileUploadButton=$("#moment_dropzone_clickable"),this.folderUploadButton=$("#directory_upload_clickable")},clickFileUpload:function(){return $(this.fileUploadButton)[0].click()},clickFolderUpload:function(){return $(this.folderUploadButton)[0].click()},template:function(){var e;return e="",Dropzone.directoryUploadSupport&&(e="<a class='flat-orange-btn folder-upload-btn'>Select folders</a>"),"<a class='flat-orange-btn file-upload-btn'>Select files</a>\n"+e}}),ThisLife.Uploader||(ThisLife.Uploader={}),(t=ThisLife.Uploader).View||(t.View={}),ThisLife.Uploader.View.Uploader=e,define("ThisLife.Uploader.Views.Uploader",[],function(){return e})}.call(this),function(){define("ThisLife.Uploader.Views.Progress",[],function(){var e;return e=Backbone.View.extend({className:"new_popover_wrap bottom_toast upload_progress_popover",initialize:function(e){var t;return this.options=null!=e?e:{},this.open=!1,this.controller=this.options.controller,this.dropzone=null!=(t=this.controller)?t.dropzone:void 0,this.readOnlyAccessErrorModal=new ThisLife.Uploader.View.Error({template:"readOnlyAccessError"}),this.maxFilesExceededErrorModal=new ThisLife.Uploader.View.Error({template:"maxFilesError"}),this.folderDropErrorModal=Dropzone.directoryUploadSupport?null:new ThisLife.Uploader.View.Error({template:"folderDropError"}),this.bindEvents()},events:{"click .cancel-upload":"cancelUpload","click div.after-upload .close-btn":"hide","click div.upload-status .close-btn":"hide","click div.after-upload div.errors .failed-sofar":"viewSkipped","click div.after-upload div.errors a.continue":"continue","click div.after-upload div.results a.add-to-album:not(.disabled)":"addToAlbum","click div.after-upload div.results a.view-new:not(.disabled)":"viewPhotos"},render:function(){return this.rendered||($(this.el).html(this.template()).show(),$(document.body).append(this.el),this.cacheElements(),this.rendered=!0),$(this.el).show()},hide:function(){return this.open=!1,this.disableActions(),this.el.classList.remove("visible"),this.hideFatalErrors(),$(this.el).hide()},bindEvents:function(){return ThisLife.PubSub.on("uploadProgress:requireUpdate",this.onMomentsDeleted,this)},unbindEvents:function(){return ThisLife.PubSub.off("uploadProgress:requireUpdate",this.onMomentsDeleted,this)},onMomentsDeleted:function(){return 0===ThisLife.Collection.moments.length&&this.isDisplayed()?this.hide():void 0},cacheElements:function(){return this.mainMessageEl=this.el.querySelector("div.main-message p.text"),this.importSoFarEl=this.el.querySelector("span.import-sofar"),this.importTotalEl=this.el.querySelector("span.import-total"),this.uploaderBarEl=this.el.querySelector("div.progress-bar"),this.thumbnailEl=this.el.querySelector(".upload-status .thumbnail"),this.afterUploadErrorsContainerEl=this.el.querySelector("div.after-upload div.errors"),this.failedSoFarEl=this.el.querySelector(".failed-sofar"),this.importedTotalEl=this.el.querySelector(".total-uploads"),this.skippedFilesEl=this.el.querySelector("div.skipped-files-list"),this.continueBtn=this.el.querySelector("div.after-upload div.errors a.continue"),this.afterUploadResultsContainerEl=this.el.querySelector("div.after-upload div.results"),this.uploadSuccessMessageEl=this.el.querySelector("div.upload-success-message"),this.processingStateEl=this.el.querySelector("div.after-upload div.results div.processing-state"),this.addToAlbumBtnEl=this.el.querySelector("div.after-upload div.results a.add-to-album"),this.viewNewBtnEl=this.el.querySelector("div.after-upload div.results a.view-new"),this.fatalErrorsEl=this.el.querySelector("div.fatal-errors"),this.folderDropErrorEl=this.el.querySelector("div.folder-drop-error"),this.maxFilesErrorEl=this.el.querySelector("div.max-files-error"),this.readOnlyAccessErrorEl=this.el.querySelector("div.read-only-access-error")},remove:function(){var e;return this.readOnlyAccessErrorModal.remove(),this.maxFilesExceededErrorModal.remove(),null!=(e=this.folderDropErrorModal)&&e.remove(),this.unbindEvents(),this.open=!1,Backbone.View.prototype.remove.apply(this)},updateUploadProgress:function(){var e,t,i,n,o;return i=this.controller.getFailedOrSkippedFilesCount(),o=_.size(this.controller.getUploadedSoFarFiles()),e=_.size(this.controller.getAllCurrentFiles()),n=this.controller.getUnacceptedFilesCount(),t=0===o&&1===e?100:Math.floor((o+i)/e*100),this.importSoFarEl.innerHTML=o===e-n?o:1+o,this.uploaderBarEl.style.width=t+"%",100===t?_.delay(function(e){return function(){return e.uploaderBarEl.classList.add("complete")}}(this),250):void 0},momentUploadComplete:function(){return ThisLife.log.debug("In upload_progress momentUploadComplete() : uploads queue completed."),this.open&&!this.controller.isUploading()?(this.uploaderBarEl.style.width="0",this.importSoFarEl.innerHTML="1",this.onUploadComplete()):void 0},updateMainMessage:function(){return!this.controller.isUploading()&&this.controller.isSaving()?(this.mainMessageEl.innerHTML="Processing...",this.el.classList.remove("uploading")):void 0},renderUploadState:function(){var e,t,i;return i=_.size(this.controller.getUploadedSoFarFiles()),e=_.size(this.controller.getAllCurrentFiles()),t=this.controller.getUnacceptedFilesCount(),(!this.open||this.controller.isUploading())&&(this.render(),0===i&&e-t===1?(this.uploaderBarEl.style.width="100%",this.uploaderBarEl.classList.add("complete")):this.uploaderBarEl.classList.remove("complete"),ThisLife.PubSub.trigger("startImportAnimation"),this.importSoFarEl.innerHTML=1+i,this.mainMessageEl.innerHTML="Uploading...",this.el.classList.add("uploading"),this._toggleUploadStatus(!0)),this.importTotalEl.innerHTML=e-t,this.open=!0},isDisplayed:function(){return this.open},onUploadComplete:function(){var e,t,i;if(this.open)return t=this.controller.getFailedOrSkippedFilesCount()+_.size(this.controller.getUploadedButDeletedDupeFiles()),i=_.size(this.controller.getUploadedSoFarFiles())-_.size(this.controller.getUploadedButDeletedDupeFiles()),e=_.size(this.controller.getAllCurrentFiles()),this.uploadSuccessMessageEl.innerHTML=1===i?"1 upload completed":i+" uploads completed",this.importedTotalEl.innerHTML=ThisLife.Helper.String.pluralize(e-t,"upload")+" completed",this.failedSoFarEl.innerHTML=t>0?1===t?"1 upload error":t+" upload errors":"",ThisLife.app.controller("tracking").logUploadPhotos(i),this._toggleUploadStatus(!1)},_toggleUploadStatus:function(e){var t;return e?this.el.classList.add("upload-in-progress"):(this.controller.isSaving()&&this.disableActions(),this.el.classList.remove("upload-in-progress"),this.skippedFilesEl.innerHTML="",t=this.controller.getFailedOrSkippedFilesCount()+_.size(this.controller.getUploadedButDeletedDupeFiles()),t>0?(this.afterUploadErrorsContainerEl.classList.remove("invisible"),this.importedTotalEl.classList.remove("invisible"),this.continueBtn.classList.remove("invisible"),this.afterUploadResultsContainerEl.classList.remove("visible")):(this.afterUploadErrorsContainerEl.classList.add("invisible"),this.afterUploadResultsContainerEl.classList.add("visible")),ThisLife.PubSub.trigger("stopImportAnimation"))},viewSkipped:function(){var e,t,i,n,o;return _.size(this.controller.getRecentUploads())<=0&&this.continueBtn.classList.add("invisible"),n=_.map(this.controller.getFailedOrSkippedFiles()[Dropzone.ERROR_CODES.INVALID_FILE_TYPE],function(e){return"<li>"+e.name+"</li>"}),e=_.map(this.controller.getFailedOrSkippedFiles()[Dropzone.ERROR_CODES.ABORTED],function(e){return"<li>"+e.name+"</li>"}),o=_.map(this.controller.getFailedOrSkippedFiles()[Dropzone.ERROR_CODES.EXCEEDED_MAX_NUM_OF_TRIES],function(e){return"<li>"+e.name+"</li>"}),o=o.concat(_.map(this.controller.getFailedOrSkippedFiles()[Dropzone.ERROR_CODES.SAVE_FAILED],function(e){return"<li>"+e.name+"</li>"})),i=_.map(this.controller.getFailedOrSkippedFiles()[Dropzone.ERROR_CODES.INVALID_IMAGE_FILE_SIZE],function(e){return"<li>"+e.name+"</li>"}),i=i.concat(_.map(this.controller.getFailedOrSkippedFiles()[Dropzone.ERROR_CODES.INVALID_VIDEO_FILE_SIZE],function(e){return"<li>"+e.name+"</li>"})),t=_.map(this.controller.getFailedOrSkippedFiles()[Dropzone.ERROR_CODES.DUPLICATED],function(e){return"<li>"+e.name+"</li>"}),t=t.concat(_.map(this.controller.getUploadedButDeletedDupeFiles(),function(e){return"<li>"+e.name+"</li>"})),n=""!==n.join("")?"<li class='header'>File not supported</li>"+n.join(""):"",e=""!==e.join("")?"<li class='header'>User stopped the upload</li>"+e.join(""):"",o=""!==o.join("")?"<li class='header'>Failed to upload</li>"+o.join(""):"",i=""!==i.join("")?"<li class='header'>File exceeds size limit</li>"+i.join(""):"",t=""!==t.join("")?"<li class='header'>Duplicates detected</li>"+t.join(""):"",this.skippedFilesEl.innerHTML="<ul>"+n+e+o+i+t+"</ul>"},"continue":function(){return _.size(this.controller.getRecentUploads())<=0?this.hide():(this.afterUploadErrorsContainerEl.classList.add("invisible"),this.afterUploadResultsContainerEl.classList.add("visible"))},enableActions:function(){var e,t,i,n;return this.controller.isSaving()?void 0:(null!=(e=this.processingStateEl)&&e.classList.add("invisible"),null!=(t=this.viewNewBtnEl)&&t.classList.remove("invisible"),null!=(i=this.addToAlbumBtnEl)&&i.classList.remove("disabled"),null!=(n=this.viewNewBtnEl)?n.classList.remove("disabled"):void 0)},disableActions:function(){var e,t,i,n,o;return null!=(e=this.processingStateEl)&&e.classList.remove("invisible"),null!=(t=this.addToAlbumBtnEl)&&t.classList.add("invisible"),null!=(i=this.viewNewBtnEl)&&i.classList.add("invisible"),null!=(n=this.addToAlbumBtnEl)&&n.classList.add("disabled"),null!=(o=this.viewNewBtnEl)?o.classList.add("disabled"):void 0},toggleAddToAlbumBtnDisplay:function(e){var t,i,n;return e&&!("function"==typeof(t=ThisLife.app).isMigrating?t.isMigrating():void 0)?null!=(i=this.addToAlbumBtnEl)?i.classList.remove("invisible"):void 0:null!=(n=this.addToAlbumBtnEl)?n.classList.add("invisible"):void 0},toggleViewNewBtn:function(e){return null!=this.viewNewBtnEl?e?(this.viewNewBtnEl.textContent="View Album",this.viewNewBtnEl.classList.add("view-album")):(this.viewNewBtnEl.textContent="View Uploaded",this.viewNewBtnEl.classList.remove("view-album")):void 0},viewPhotos:function(){var e,t;return this._sendMetrics("viewUploaded"),this.viewNewBtnEl.classList.contains("view-album")?(t=ThisLife.app.album.getCurrentAlbum(),e=this.controller.destinationAlbums.length?this.controller.destinationAlbums[0]:t,ThisLife.app.router.navigateToAlbum(e)):(ThisLife.app.controller("tracking").logClickUploadToastViewUpload(),ThisLife.app.router.navigateToLibrary(),ThisLife.Collection.moments.whenLoaded(function(){return ThisLife.Collection.moments.setSort("uploadDate"),ThisLife.PubSub.trigger("update:sort","uploadDate")})),this.hide()},addToAlbum:function(){var e,t;return this._sendMetrics("addToAlbum"),_.size(this.controller.getRecentUploads())>0?(t=new ThisLife.View.ActionBarModal({collection:this.controller.getRecentUploads(),fmv:!1,type:"timeline_add",share:!1,recentUploads:!0}),document.body.appendChild(t.render().el),t.modalFocus()):(e=new ThisLife.View.ModalAlert({template:"invalidStoryMomentsToAddToAlbum"}),$(document.body).append(e.render().el),_.delay(function(){return function(){return e.teardown()}}(this),3e3)),this.hide()},cancelUpload:function(){return this.controller.abort(),this.enableActions(),this.onUploadComplete(),this.toggleAddToAlbumBtnDisplay(this.controller.getCurrentAlbumDetails().canShowAddToAlbum)},getThumbnailElement:function(){return this.thumbnailEl},handleErrors:function(e){var t,i;return(e.showReadOnlyAccessError||e.showMaxFilesError||e.showFolderDropError)&&this.showFatalErrors(),e.showReadOnlyAccessError&&this.showReadOnlyAccessError(e.uploadingFiles),e.showMaxFilesError&&this.showMaxFilesError(e.uploadingFiles,null!=(t=this.dropzone)&&null!=(i=t.dz)?i.options.maxFiles:void 0),e.showFolderDropError&&!Dropzone.directoryUploadSupport?this.showFolderDropError(e.uploadingFiles):void 0},showReadOnlyAccessError:function(e){var t;return null!=(t=this.readOnlyAccessErrorModal)&&t.setFileUploadingStatus(e),this._showError(this.readOnlyAccessErrorModal,this.readOnlyAccessErrorEl)},showMaxFilesError:function(e,t){return this.maxFilesExceededErrorModal.setMaxFilesCount(t),this.maxFilesExceededErrorModal.setFileUploadingStatus(e),this._showError(this.maxFilesExceededErrorModal,this.maxFilesErrorEl)},showFolderDropError:function(e){var t;return null!=(t=this.folderDropErrorModal)&&t.setFileUploadingStatus(e),this._showError(this.folderDropErrorModal,this.folderDropErrorEl)},_showError:function(e,t){return t&&!e.isDisplayed()?($(t).append(e.render().el),$(t).show()):void 0},_hideError:function(e){return e?$(e).hide():void 0},hideFatalErrors:function(){var e,t;return this._hideError(this.readOnlyAccessErrorEl),this._hideError(this.maxFilesErrorEl),this._hideError(this.folderDropErrorEl),this.readOnlyAccessErrorModal.teardown(),this.maxFilesExceededErrorModal.teardown(),null!=(e=this.folderDropErrorModal)&&e.teardown(),null!=(t=this.fatalErrorsEl)?t.classList.add("invisible"):void 0},showFatalErrors:function(){var e;return this.open||(this.render(),this.el.classList.add("errors-only")),null!=(e=this.fatalErrorsEl)?e.classList.remove("invisible"):void 0},removeErrorModals:function(){var e;return!this.controller.isUploading()&&(e=function(e){return function(){var t;return e.readOnlyAccessErrorModal.remove(),e.maxFilesExceededErrorModal.remove(),null!=(t=e.folderDropErrorModal)&&t.remove(),e.hideFatalErrors()}}(this),this.readOnlyAccessErrorModal.isDisplayed()||this.maxFilesExceededErrorModal.isDisplayed()||this.folderDropErrorModal&&this.folderDropErrorModal.isDisplayed())?this.readOnlyAccessErrorModal.options.uploadingFiles||this.maxFilesExceededErrorModal.options.uploadingFiles||this.folderDropErrorModal&&this.folderDropErrorModal.options.uploadingFiles?e():setTimeout(function(){return e()
},6e3):void 0},_sendMetrics:function(e){return ThisLife.app.controller("tracking").logClickUploadToastButton(e)},template:function(){return'<div class="fatal-errors invisible">\n  <div class="folder-drop-error"></div>\n  <div class="max-files-error"></div>\n  <div class="read-only-access-error"></div>\n</div>\n<div class="progress_popover_wrap">\n  <!-- main body content -->\n  <div class="content">\n    <div class="upload-status">\n      <span class="close-btn invisible"><img src="/assets/1px.gif"></span>\n      <div class="thumbnail">\n      </div>\n      <div class="progress">\n        <div class="main-message">\n          <p class="text">Uploading...</p>\n        </div>\n        <div class="upload-controls">\n          <a class="orange-btn cancel-upload" title="Cancel upload">Stop</a>\n        </div>\n        <div class="bar-container">\n          <div class="counts">\n            <div class="import-sofar-toal" ><span class="import-sofar"></span> of <span class="import-total"></span></div>\n          </div>\n          <div class="bar">\n            <div class="uploader-shadow"></div>\n            <div id="uploader-bar" class="progress-bar" style="width: 0%"></div>\n          </div>\n        </div>\n      </div>\n    </div>\n    <div class="after-upload">\n      <span class="close-btn"><img src="/assets/1px.gif"></span>\n      <div class="errors">\n        <div class="left">\n          <div class="check-mark-holder"></div>\n          <div class="check-mark"></div>\n        </div>\n        <div class="right">\n          <div class="main-message">\n            <span class="total-uploads"></span>\n            <div class="failed-sofar"></div>\n          </div>\n          <div class="skipped-files-list"></div>\n        </div>\n        <div class="footer">\n          <div class="actions">\n            <a class="orange-btn continue">Continue</a>\n          </div>\n        </div>\n      </div>\n      <div class="results">\n        <div class="left">\n          <div class="check-mark-holder"></div>\n          <div class="check-mark"></div>\n        </div>\n        <div class="right">\n          <div class="main-message">\n            <div class="upload-success-message"></div>\n          </div>\n        </div>\n        <div class="footer">\n          <div class="processing-state">Processing...</div>\n          <div class="actions">\n            <a class="gray-btn add-to-album disabled">Add to Album</a>\n            <a class="orange-btn view-new disabled">View Uploaded</a>\n          </div>\n        </div>\n      </div>\n    </div>\n  </div>\n</div>'}})})}.call(this),function(){var e,t,i;e=Backbone.View.extend({className:"new_popover_wrap upload_error_popover",initialize:function(e){return this.options=null!=e?e:{},this.displayed=!1},events:{"click div.upload_error_popover div.content .close-btn":"teardown","click div.max-files-error-popover-wrap div.content div.action a.orange-btn:not(.disabled)":"downloadDesktopUploader"},render:function(){var e;return e=i[this.options.template](this.options),$(this.el).html(e).show(),this.displayed=!0,this},teardown:function(){return this.displayed=!1,this.options.maxFiles=0,this.options.uploadingFiles=null,$(this.el).hide()},downloadDesktopUploader:function(){return ThisLife.Helper.URL.downloadViaIframe(ThisLife.Settings.uploaderUrl())},setMaxFilesCount:function(e){return this.options.maxFiles=e},setFileUploadingStatus:function(e){return this.options.uploadingFiles=e},isDisplayed:function(){return this.displayed}},i={readOnlyAccessError:function(){return'<div class="read-only-access-error-popover-wrap" >\n   <div class="content">\n      <span class="close-btn"><img src="/assets/1px.gif"></span>\n      <div>\n         <div class="header">\n            This album is read-only\n         </div>\n         <div class="error-message">\n            The friend who shared this album with you did not give you permission to add  to this album.\n         </div>\n      </div>\n   </div>\n</div>'},maxFilesError:function(e){return'<div class="max-files-error-popover-wrap" >\n   <div class="content">\n      <span class="close-btn"><img src="/assets/1px.gif"></span>\n      <div>\n         <div class="header">\n            Please select fewer files\n         </div>\n         <div class="error-message">\n            We allow '+e.maxFiles+' files per upload. Try the Desktop Uploader to upload more.\n         </div>\n         <div class="action">\n            <a class="orange-btn">Get the Desktop Uploader</a>\n         </div>\n      </div>\n   </div>\n</div>'},folderDropError:function(e){var t;return t=e.uploadingFiles?"":"invisible",'<div class="folder-drop-error-popover-wrap" >\n   <div class="content">\n      <span class="close-btn"><img src="/assets/1px.gif"></span>\n      <div>\n        <div class="header">\n          Are you trying to drop a folder?\n        </div>\n        <div class="error-message">\n          This browser only supports drag and drop of individual files. If you\u2019d like to drop folders, use the Chrome browser.\n        </div>\n        <div class="suffix-message '+t+'">\n          The individual files you have dropped will be uploaded.\n        </div>\n        <div class="action">\n          <a class="orange-btn" href="https://www.google.com/chrome/browser/desktop/index.html" target="_blank">Get Chrome Browser</a>\n        </div>\n      </div>\n    </div>\n</div>'}}),ThisLife.Uploader||(ThisLife.Uploader={}),(t=ThisLife.Uploader).View||(t.View={}),ThisLife.Uploader.View.Error=e}.call(this),define("ThisLife.Uploader.Views.UPP",["ThisLife.View.ActionBarModal"],function(e){var t={get _context(){return _.isEmpty(i)&&this._defaultContext(),i},set _context(e){i=e},get _uppOpened(){return s},set _uppOpened(e){s=e}},i={},n=!1,o=!1,s=!1;return _.extend(t,{bootstrap:function(e){if(this.bootstrapOptions=e,"undefined"==typeof window.Shr){n=!1,o=!1,window.MomentDbClient=require("MomentDbClient"),window.PMCHeimdall=require("PMCHeimdall");var t="prod"===ThisLife.Settings.sflyEnv?"":ThisLife.Settings.sflyEnv+".",i="//www."+t+"shutterfly.com/score/bootstrap.js",s=document.createElement("script");if(s.type="text/javascript",s.src=i,String.prototype.startsWith||(String.prototype.startsWith=function(e,t){return this.substr(!t||0>t?0:+t,e.length)===e}),s.readyState){var r=this;s.onreadystatechange=function(){delete s.onreadystatechange,Shr.Score.load(r.getUserInfoCb.bind(r,"bootstrapLoaded")),Shr.Score.getUserInfo(r.getUserInfoCb.bind(r,"bootstrapGetInfo"))}}else{var r=this;s.onload=function(){delete s.onload,Shr.Score.load(r.getUserInfoCb.bind(r,"bootstrapLoaded")),Shr.Score.getUserInfo(r.getUserInfoCb.bind(r,"bootstrapGetInfo"))}}document.body.appendChild(s),this._bindEventListener()}else this.getUserInfoCb();var l=document.createElement("input");l.setAttribute("type","file"),l.setAttribute("name","upp_filepicker"),l.setAttribute("class","shrMCITF photosWeb"),l.setAttribute("value"," "),l.onchange=this.filePickerCb.bind(this),l.onclick=this.initialize.bind(this),l.setAttribute("accept",this._getInputAcceptList()),l.setAttribute("multiple",""),document.body.appendChild(l)},initialize:function(){Shr&&Shr.Dialogs&&Shr.Dialogs.UniversalPicker&&(document.body.onfocus=Shr.Dialogs.UniversalPicker.checkFilePicker)},filePickerCb:function(e,t){e&&e.target.files&&e.target.files.length?Shr&&Shr.Dialogs&&Shr.Dialogs.UniversalPicker&&Shr.Dialogs.UniversalPicker.filePickerCb(e,t):Shr.Dialogs.UniversalPicker.checkFilePicker()},getUserInfoCb:function(e){e&&(this[e]=!0)},checkUploadStatus:function(){var e,t=!1;return window.Shr&&window.Shr.Dialogs&&window.Shr.Dialogs.UniversalPicker&&(e=window.Shr.Dialogs.UniversalPicker.getStatus(),_.find(e,function(e){t=e._started&&!e._done&&!e._failed})),t},forceUpdate:function(){this._context.forceUpdate=!0},show:function(e){"undefined"==typeof e.files&&(e.files=[]);var t=_.extend({},this._context);if(t.labelsContext=e.labelsContext,"undefined"!=typeof e.albumId){t.bgActions={complete:{albumId:e.albumId,callback:this._addToAlbumCallback.bind(this)},onError:this._onError.bind(this)},t.destination={albumId:e.albumId};var i,n=ThisLife.app.controller("albums").getCurrentAlbum();if(n&&n.id===e.albumId){var o=ThisLife.app.controller("albums").getCollection();i=o.models}else n=ThisLife.Model.Albums.Master.getAlbumById(e.albumId),i=n.moments;i=i.map(function(e){return{id:e.id||e.uid,path:"sfly"}}),t.selection=i,t.toTimelineOnly=!1,t.sources.sfly.hide=e.show_sfly?!1:!0,t.skipSelections=!0}else t.bgActions={complete:{buttons:[{text:"ADD TO ALBUM",callback:this._modalAddToAlbumCallback.bind(this)}]},onError:this._onError.bind(this)},t.selection=[],t.skipSelections=!1,t.sources.sfly.hide=!0,t.toTimelineOnly=!0;e.files.length>0&&(t.selection=t.selection.concat(e.files));var s=ThisLife.Model.User.isPaidAccount();s!==t.enableVideos&&(t.enableVideos=s),"undefined"!=typeof e.context&&(t.path=e.context),t.bypass=!!e.bypass,t.filepicker=!!e.filepicker,this._uppOpened?(Shr.Dialogs.UniversalPicker.updateContext(t,!0),Shr.Dialogs.UniversalPicker.reopen()):(Shr.Dialog.show("UniversalPicker",t),this._uppOpened=!0),this._context.forceUpdate=!1}}),_.extend(t,{_defaultContext:function(){var e={category:"photosweb",nonProductCreation:!0,enableVideos:!1,maxCount:1e3,newBgUpload:!0,sources:{myComputer:{requiresSignin:!0},sfly:{hide:!0,hideAlbums:!0},sites:{hide:!1}}};this._context=e},_bindEventListener:function(){window.addEventListener("Shr.Dialogs.UniversalPicker",this._uppEventHandler.bind(this))},_uppEventHandler:function(e){"done"===e.detail.type&&Shr.Dialogs.UniversalPicker.clearSelections()},_addToAlbumCallback:function(e,t){if(e=e.map(function(e){return e.moment_type=e.type||"image",e.uid=e.id,e.uniqueId=e.mPath,e}),e=e.filter(function(e){return e.source&&"myComputer"!=e.source.id?!0:!1}),e.length){var i=_.pluck(e,"id");ThisLife.Service.api.saveStoryMoments(t,i)}},_onError:function(){ThisLife.app.logout(!0)},_modalAddToAlbumCallback:function(t){t=t.map(function(e){return e.moment_type=e.type,e.uniqueId=e.mPath,e});var i=new e({collection:t,fmv:!1,recentUploads:!0,share:!1,type:"timeline_add"});document.body.appendChild(i.render().el),i.modalFocus()},_okCallback:function(e){this._context=e},_getInputAcceptList:function(){var e=["image/jpeg"];return ThisLife.Model.User.isPaidAccount()&&e.push("video/*"),(ThisLife.Helper.Platform.firefox()||ThisLife.Helper.Platform.safari())&&(e.concat([".jpg",".jpeg"]),ThisLife.Model.User.isPaidAccount()&&e.concat([".flv",".mp4",".mp2",".mpeg",".mpg",".mov",".qt",".asf",".avi",".movie",".m4v",".dv",".mts",".m2ts",".3gpp",".3gp",".wmv"])),e.join(",")}}),t}),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}};define("ThisLife.VisualSearch.Controllers.VisualSearch",["VisualSearchUMD","PMCHeimdall","ThisLife.VisualSearch.Views.Empty","ThisLife.PubSub","ThisLife.VisualSearch.Views.UnnamedBanner"],function(t,i,n,o,s){var r;return r=function(){function r(t){this.options=null!=t?t:{},this.renderEmptyView=e(this.renderEmptyView,this),this.container=document.getElementById("search-results-parent"),this.timelineContainer=document.getElementById("library-vertical"),this.unnamedBanner=null,this.searchConfig={env:ThisLife.Settings.sflyEnv,token:ThisLife.sessionToken,lifeUid:ThisLife.lifeUid,ownerId:ThisLife.currentLifeOwner,container:document.querySelector(".visual-search-parent"),fullWidthContainer:document.querySelector("#tl_secondary_bar"),options:{fullWidgetHeight:this.timelineContainer.clientHeight+46}},this.searchCallbacks={momentOutput:_.bind(this._momentOutput,this),updateMomentOutput:_.bind(this._updateMomentOutput,this),getMomentModel:_.bind(this._getMomentModel,this),addNoScroll:_.bind(this._addNoScroll,this),removeNoScroll:_.bind(this._removeNoScroll,this),toggleMobileClass:function(){},clearFilters:_.bind(this._clearFilters,this),selectionPillClick:_.bind(this._selectionPillClick,this),trackingCallback:_.bind(this._trackingCallback,this)},o.on("state:change",this._stateChange,this),o.on("banner:remove",this._removeBanner,this)}return _.extend(r.prototype,Backbone.Events),r.prototype.show=function(){return this.bindEvents(),this.search=new t({config:this.searchConfig,callbacks:this.searchCallbacks}),this.search.render()},r.prototype._clearFilters=function(){var e,t,i,n,o,s,r;return this.searchConfig.container.classList.add("vs-hidden"),this.searchConfig.container.classList.remove("vs-closed"),this.searchConfig.container.classList.remove("vs-open"),this.timelineContainer.classList.remove("hidden"),this.container.classList.add("hidden"),null==this.searchResults||0===Object.keys(null!=(t=this.searchResults)&&null!=(i=t.layout)?i.objects:void 0).length?!1:(e=null!=(n=this.searchResults)?n.getIdForScrolledObject():void 0,null!=(o=this.searchResults)&&o.clearObjects(),this.collection=[],this.search.updateAllMomentsSelected(ThisLife.app.controller("selection").getCount()===(null!=(s=ThisLife.Collection.moments.models)?s.length:void 0)),this.search.resetFilters(),this.search.updateDisplayMode("hidden"),null!=e&&ThisLife.app.controller("timeline").centerOnMoment(e),document.body.removeEventListener("keydown",this.modalKeys,!1),this.unbindEvents(),null!=(r=this.unnamedBanner)&&r.remove(),this.unnamedBanner=null)},r.prototype._selectionPillClick=function(){var e,t,i,n,o,s;if(!ThisLife.Helper.Platform.mobile()){for(s=null!=this.searchResults&&null!=this.searchResults.layout.objects&&Object.keys(this.searchResults.layout.objects).length>0?Object.keys(this.searchResults.layout.objects):this.search.store.getState().moments,_.isArray(s)||(s=[s]),t=[],i=0,n=s.length;n>i;i++)o=s[i],t.push(ThisLife.Collection.moments.getModel(o));return e=_.every(t,function(e){return ThisLife.app.controller("selection").hasModel(e)}),e?(ThisLife.app.controller("selection").removeModels(t),this.search.updateAllMomentsSelected(!1)):(ThisLife.app.controller("selection").addModels(t),this.search.updateAllMomentsSelected(!0))}},r.prototype._searchClickHandler=function(e,t,i){var n,o,s,r,l,a,u,c,d,h,p,f,m,g,v,b,w,y;for(_.isArray(e)||(e=[e]),s=[],l=0,c=e.length;c>l;l++)y=e[l],s.push(ThisLife.Collection.moments.getModel(y));switch(t){case"select-date":return p=s[0],w=ThisLife.app.controller("timeline"),u=w.getLayoutSort(),v=new Date(1e3*p.get(u)),r=v.toISOString().slice(0,10).replace(/-/g,""),this._clearFilters(),w.scrollToDate(r,!0);case"delete":ThisLife.app.controller("selection").removeModels(s),ThisLife.app.controller("trash")["delete"](e);break;case"favorite":for(a=0,d=s.length;d>a;a++)h=s[a],h.saveRating(3-h.get("rating"));break;case"layout-change":b=i.size,ThisLife.app.controller("timeline").setLayoutSize(b);break;case"play":ThisLife.app.controller("timeline")._playVideo(s[0]);break;case"click":this.anySelected()||(i={pageName:"applibrary",linkName:"Select",eVar59:null!=(f=this.search.store)?f.getState().selectedFilters.length:void 0},ThisLife.app.controller("tracking").logClickVisualSearchSelectMoment((null!=(m=this.search.store)?m.getState().selectedFilters.length:void 0)||0)),ThisLife.app.controller("selection").toggleModels(s[0],{event:i}),this.search.updateAllMomentsSelected(this.allSelected());break;case"select":s.length>1?(n=_.every(s,function(e){return ThisLife.app.controller("selection").hasModel(e)}),n?ThisLife.app.controller("selection").removeModels(s):ThisLife.app.controller("selection").addModels(s)):ThisLife.app.controller("selection").toggleModels(s[0],{event:i}),this.search.updateAllMomentsSelected(this.allSelected());break;case"sort":o="moment_date"===i?"momentDate":"uploadDate",ThisLife.Collection.moments.setSort(o),ThisLife.app.controller("timeline").setLayoutSort(o);break;case"view":null==(null!=(g=ThisLife.app.controller("selection"))?g.getAlbumCollection():void 0)&&ThisLife.app.router.navigateToFullView(s[0].id)}},r.prototype._updateMomentOutput=function(e,t){var i,n,o;if(o=function(e){return function(t){return e.searchResults.updateScrubberOptions({disableScroll:t})}}(this),t.remove&&this.unnamedBanner){if(n=this.unnamedBanner.removeThumbnail(e),!n)return null!=(i=this.unnamedBanner)&&i.remove(),this.unnamedBanner=null}else if(!t.remove)return null!=this.unnamedBanner?this.unnamedBanner.addThumbnail(e):this.unnamedBanner=new s(e,{scrollCallback:o})},r.prototype._getMomentModel=function(e){return ThisLife.app.library.getCollection().get(e)},r.prototype._updateUnnamedBanner=function(){var e,t;return t={},e=75,t=null!=this.unnamedBanner?{banners:{header:{el:this.unnamedBanner.el,height:e}}}:{banners:{header:null}},this.searchResults.updateOptions(t)},r.prototype._momentOutput=function(e,t,n){var o,s,r,l,a,u,c;return s={},s=ThisLife.app.isMobile?{top:[{"class":"favorite"},{"class":"view",action:"view"}]}:{top:[{"class":"favorite",action:"favorite"},{"class":"view",action:"view"}],bottom:[{"class":"delete",action:"delete"}]},r={clickCallback:_.bind(this._searchClickHandler,this),trackingCallback:_.bind(this._heimdallTracking,this),container:this.container,environment:ThisLife.Settings.sflyEnv,layout:"VerticalTimeline",layout_options:{date_summary:{mobile:!0},default_size:ThisLife.app.controller("timeline").getLayoutSize(),group_by_attr:ThisLife.app.controller("timeline").getLayoutSort(),lock_drawer:ThisLife.app.isMobile,moment_icons:s,object_id_attr:"uid",object_sizes:{small:{min_height:125,max_height:150},large:{min_height:225,max_height:275},mobile:{min_height:125,max_height:180}},reverse_sort:!0,sort_by_attr:ThisLife.app.controller("timeline").getLayoutSort()},life_uid:ThisLife.currentLifeOwner,scrubber:"Yearly",scrubber_options:{vertical:!0},topbar_options:{size_change:!0,sort:!0}},e?this.showLoading():(this.hideLoading(),"hidden"===n?(0===(null!=(l=this.search.store)?l.getState().selectedFilters.length:void 0)?(this._clearFilters(),o=this._getDates(ThisLife.Collection.moments.models),this.search.updateDates(o),this.searchConfig.container.classList.add("vs-hidden"),this.searchConfig.container.classList.remove("vs-closed"),this.searchConfig.container.classList.remove("vs-open")):this.renderEmptyView(),void ThisLife.app.controller("timing").deleteTimer("vsOpenToFilter")):("open"===n&&(o=this._getDates((null!=(a=this.collection)?a.length:void 0)>0?this.collection:ThisLife.Collection.moments.models),this.search.updateDates(o),this.searchConfig.container.classList.add("vs-open"),this.searchConfig.container.classList.remove("vs-closed"),this.searchConfig.container.classList.remove("vs-hidden"),document.body.addEventListener("keydown",this.modalKeys,!1),ThisLife.app.controller("timing").startTimer("vsOpenToFilter")),"closed"===n&&(this.searchConfig.container.classList.add("vs-closed"),this.searchConfig.container.classList.remove("vs-hidden"),this.searchConfig.container.classList.remove("vs-open"),document.body.removeEventListener("keydown",this.modalKeys,!1),this.collection=this._getCollection(t),this.collection.length>0)?(this.clearEmptyView(),this.searchResults?(c={default_size:ThisLife.app.controller("timeline").getLayoutSize(),group_by_attr:ThisLife.app.controller("timeline").getLayoutSort(),sort_by_attr:ThisLife.app.controller("timeline").getLayoutSort()},this.searchResults.updateOptions(c)):this.searchResults=new i([],r),null!=(u=this.searchResults)&&(u.firstImageLoaded=!1),this.searchResults.setFirstImageLoaded(!1),this.searchResults.clearObjects(),this.searchResults.addObjects(this.collection),this._updateUnnamedBanner(),this.search.updateAllMomentsSelected(this.allSelected()),o=this._getDates(this.collection),this.search.updateDates(o),this.container.classList.remove("hidden"),this.timelineContainer.classList.add("hidden")):void 0))},r.prototype._getCollection=function(e){var t,i,n,o,s,r;for(t=[],i=0,n=e.length;n>i;i++)r=e[i],o=ThisLife.Collection.moments.getModel(r),null!=o&&(s=_.extend({},o.attributes),delete s.child,delete s.collection,s.hasOwnProperty("moment_date")&&(s.moment_date*=1e3),s.hasOwnProperty("upload_date")&&(s.upload_date*=1e3),ThisLife.app.controller("selection").isMomentSelected(o)&&(s.selected=!0),t.push(s));return t},r.prototype._addNoScroll=function(){return document.body.classList.contains("no-scroll")?void 0:document.body.classList.add("no-scroll")},r.prototype._removeNoScroll=function(){return document.body.classList.contains("no-scroll")?document.body.classList.remove("no-scroll"):void 0},r.prototype._heimdallTracking=function(e){return e.constructor===Array?_.each(e,function(e){return function(t){return e._trackMetric(t)}}(this)):this._trackMetric(e)},r.prototype._trackMetric=function(e){return"time"===e.type&&"firstPhoto"===e.name&&ThisLife.app.controller("timing").endTimer("vsFirstPhotoLoadedAfterFilterSelection"),ThisLife.app.controller("tracking").logClickVisualSearchDateHeader(e.name)},r.prototype._trackingCallback=function(e){var t;switch(e.name){case"search_window_closed":case"clear_all_clicked":case"cleared_last_pill":ThisLife.app.controller("timing").deleteTimer("vsOpenToFilter");break;case"filter_selected":ThisLife.app.controller("timing").endTimer("vsOpenToFilter",{filterType:e.type,filterCount:null!=(t=this.search.store)?t.getState().selectedFilters.length:void 0}),ThisLife.app.controller("timing").startTimer("vsFirstPhotoLoadedAfterFilterSelection")}return ThisLife.app.controller("tracking").logClickVisualSearchEvent(e.name,e.type),"search_window_opened"===e.name?ThisLife.app.controller("tracking").logClickVisualSearchOpen():void 0},r.prototype.getResults=function(){return null!=this.searchResults?this.searchResults:void 0},r.prototype.renderEmptyView=function(){return this._emptyView?void 0:(this._emptyView=new n({controller:this}),this.container.childNodes.forEach(function(e){e.classList.add("hidden")}),this.container.appendChild(this._emptyView.render().el))},r.prototype.clearEmptyView=function(){var e;return null!=(e=this._emptyView)&&e.teardown(),this.container.childNodes.forEach(function(e){e.classList.remove("hidden")})},r.prototype.isLoading=function(){return!!this.loading},r.prototype.showLoading=function(){var e;return null!=(e=this.loading)&&e.remove(),this.loading=new ThisLife.View.Timeline.Loading,this.container.appendChild(this.loading.render().el),this.container.classList.contains("hidden")?this.container.classList.remove("hidden"):void 0},r.prototype.hideLoading=function(){var e;return null!=(e=this.loading)&&e.remove(),this.loading=null},r.prototype.updateObjects=function(e){var t,i,n;return i=!1,null!=this.getResults()?(n=null!=(t=this.getResults())?t.updateObjects(e):void 0,0!==n||this.container.classList.contains("hidden")||this.renderEmptyView(),_.defer(function(e){return function(){var t;return e.search.updateAllMomentsSelected(0===Object.keys(e.getResults().layout.objects).length?ThisLife.app.controller("selection").getCount()===(null!=(t=ThisLife.Collection.moments.models)?t.length:void 0):e.allSelected())}}(this))):_.defer(function(e){return function(){var t;return e.search.updateAllMomentsSelected(ThisLife.app.controller("selection").getCount()===(null!=(t=ThisLife.Collection.moments.models)?t.length:void 0))}}(this))},r.prototype.allSelected=function(){var e,t,i;return this.searchResults.layout.objects.length>ThisLife.app.controller("selection").getCount()?!1:(i=_.pluck(this.searchResults.layout.objects,"uid"),t=_.pluck(ThisLife.app.controller("selection").getCollection().models,"id"),e=0===_.difference(i.sort(),t.sort()).length)},r.prototype.anySelected=function(){var e,t,i;return 0===ThisLife.app.controller("selection").getCount()?!1:(i=_.pluck(this.searchResults.layout.objects,"uid"),t=_.pluck(ThisLife.app.controller("selection").getCollection().models,"id"),e=_.intersection(i,t).length>0)},r.prototype.modalKeys=function(e){var t;return t=[37,38,39,40],t.indexOf(e.keyCode)>-1?e.stopPropagation():void 0},r.prototype.getNextObject=function(e,t){return null!=this.searchResults&&Object.keys(this.searchResults.layout.objects).length>0?this.searchResults.nextObject(e,t):void 0},r.prototype.getPreviousObject=function(e,t){return null!=this.searchResults&&Object.keys(this.searchResults.layout.objects).length>0?this.searchResults.previousObject(e,t):void 0},r.prototype.searchResultsHidden=function(){return this.container.classList.contains("hidden")},r.prototype.bindEvents=function(){return this.updateWidgetHeightWait=_.debounce(_.bind(this.updateWidgetHeight,this),200),$(window).on("resize",this.updateWidgetHeightWait)},r.prototype.unbindEvents=function(){return null!=this.updateWidgetHeightWait?$(window).off("resize",this.updateWidgetHeightWait):void 0},r.prototype.updateWidgetHeight=function(){return null!=this.search&&_.isFunction(this.search.updateWidgetHeight)?(this.search.config.options.fullWidgetHeight=this.timelineContainer.clientHeight+46,this.search.updateWidgetHeight(this.timelineContainer.clientHeight+46)):void 0},r.prototype._stateChange=function(e){return"library"===e.name?this.bindEvents():this.unbindEvents()},r.prototype._removeBanner=function(e){var t;return null!=(t=this.unnamedBanner)?t._remove_personcard(e):void 0},r.prototype.updateSelectedFilter=function(e,t){return null==this.search||null==t?!1:this.search.updateSelectedFilter(e,t)},r.prototype.mergeFilters=function(e,t){return null!=this.search&&null!=e&&null!=t&&_.isFunction(this.search.mergeFilters)?this.search.mergeFilters(e.id,t.id):!1},r.prototype._getDates=function(e){var t,i,n;return n=_.filter(e,function(e){return!e.hidden&&!("function"==typeof e.get?e.get("hidden"):void 0)}),t=_.groupBy(n,function(e){var t,i,n,o;return i=e.moment_date||1e3*e.get("moment_date"),t=new Date(i),n=t.getUTCMonth(),o=t.getUTCFullYear(),n+" "+o}),i=_.groupBy(Object.keys(t),function(e){var t,i;return t=e.split(" "),i=t[1]})},r}()})}.call(this),function(){define("ThisLife.VisualSearch.Views.Empty",[],function(){var e;return e=Backbone.View.extend({className:"empty-results",initialize:function(e){return null==e&&(e={}),this.controller=e.controller,this},render:function(){return this.$el.html(this._template()),this.delegateEvents(),this},teardown:function(){return this.controller._emptyView=null,this.remove()},_template:function(){return'<div class="no-results-container">\n  <div class="no-results-img"></div>\n  <div class="no-results-text">\n    <p>Sorry, no results found.<br/>Please remove some parameters.</p>\n  </div>\n</div>'}})})}.call(this),function(){define("ThisLife.VisualSearch.Views.UnnamedBanner",["ThisLife.People.Controllers.Merge"],function(e){var t,i;return t=Backbone.View.extend({className:"banner unnamed",events:{"blur input.name":"blurName","focus input.name":"focusName","keypress input.name":"onNameKeypress","click input.name":"setupAutoComplete",mouseleave:"onMouseout"},initialize:function(e,t){return this.scrollCallback=t.scrollCallback,this.cardsCount=4,this.filters={},this.filters[e.id]=e,this.render(),this},addThumbnail:function(e){return this.filters[e.id]=e,this.render()},removeThumbnail:function(e){return this.filters[e.id]?(delete this.filters[e.id],_.size(this.filters)?(this.render(),!0):!1):void 0},render:function(){return this.resize(document.body.clientWidth),this.$el.html(this._getTemplate()),this.debounced=_.debounce(_.bind(this.resizeRender,this),100),$(window).on("resize",this.debounced)},resizeRender:function(){var e;return e=this.cardsCount,this.resize(document.body.clientWidth),e!==this.cardsCount?this.render():void 0},resize:function(e){var t;return t=257,this.cardsCount=Math.min(Math.round(e/t),4)},remove:function(){return $(window).off("resize",this.debounced)},_remove_personcard:function(e){var t,i,n,o,s;for(o=this.el.children,s=[],t=0,i=o.length;i>t;t++)n=o[t],s.push(e===n.id?n.remove():void 0);return s},focusName:function(e){return this.originalName=e.target.value},blurName:function(e){var t,i;if(!this.autocompleteOpen)return i=e.target.value,t=e.target.id,""!==i&&this.savePersonName(t,i,e.target),this},onNameKeypress:function(e){return ThisLife.Helper.Keyboard.isEnter(e.keyCode)&&this.blurName(e),ThisLife.Helper.Keyboard.isEscape(e.keyCode)?e.target.val(this.originalName):void 0},saveSelectedPerson:function(e){var t,i;return i=e[0].value,t=e[0].id,this.savePersonName(t,i,e[0])},savePersonName:function(e,t,i){var n,o,s,r;return r=ThisLife.Collection.personTags.get(e),n=ThisLife.Collection.personTags.findName(t),s=t&&""!==t&&!n,o=this.filters[e],s?("unnamed"===r.get("name")&&ThisLife.app.controller("tracking").logSearchPeopleTagSaved(),r.save("name",ThisLife.Helper.String.escapeHtml(t)),ThisLife.app.controller("visual_search").updateSelectedFilter(e,{title:t}),void(o.title=t)):n&&r.id!==n.id?("unnamed"===r.get("name")&&ThisLife.app.controller("tracking").logSearchPeopleTagSaved(),this.mergeTags(r,ThisLife.Collection.personTags.get(n.id),i)):void 0},mergeTags:function(t,i,n){var o,s,r;return o=function(e){return function(){return n.value=e.originalName}}(this),r=function(e){return function(n,o){return ThisLife.app.controller("visual_search").mergeFilters(t,i),e.removeThumbnail({id:t.id,thumb:t.faceUrl}),e.addThumbnail({id:i.id,thumb:i.faceUrl,title:o})}}(this),s=new e,s.renderView({source:t,dest:i,cancelCallback:o,successCallback:r})},setupAutoComplete:function(e){var t;return t=e.target,t.shorthand?void 0:this.shorthand($(t))},shorthand:function(e){var t,n,o,s;return s=this,o=_.bind(this.saveSelectedPerson,this),n=e.parent().find(".face_identify_dropdown-scroll-area"),t={source:ThisLife.Service.api.combineContacts().toJSON(),value:"name",parent:$(n),num:-1,show:function(){var t;return $(n).show(),t=document.getElementsByClassName("banner-container")[0],null!=t&&t.classList.add("front"),s.scrollCallback(!0),s.autocompleteOpen=!0,e.focusout(),$.fn.shorthand.Constructor.prototype.show.call(this)},blur:function(e){return ThisLife.Helper.Keyboard.isEscape(e.keyCode)?this.hide():void 0},sorted:!1,hide:function(){var e;return $(n).hide(),e=document.getElementsByClassName("banner-container")[0],null!=e&&e.classList.remove("front"),s.scrollCallback(!1),s.autocompleteOpen=!1,$.fn.shorthand.Constructor.prototype.hide.call(this)},save:function(){return s.saveSelectedPerson()},template:i,menu:'<ul class="people_dropdown suggestions"></ul>',selectCallback:o,caseSensitive:!1},e.shorthand(t)},_getTemplate:function(){var e,t;return t="",e=0,_.find(this.filters,function(i){return function(n){var o,s,r;return s=n.thumb,o=n.id,r="unnamed"===n.title?"":n.title,t+='<div class="person_card" id="'+o+'">\n   <div class="image_wrap">\n    <div class="image" style="background-image: url('+s+')"></div>\n   </div>\n  <input type="text" class="name editable shorthand_input" value="'+r+"\" spellcheck='false' id=\""+o+"\" placeholder=\"Who's this?\">\n  <!-- autofill -->\n  <div class='face_identify_dropdown'>\n    <div class='face_identify_dropdown-scroll-area'></div>\n  </div>\n</div>\n",e++,e===i.cardsCount}}(this)),t}}),i='<% var uid = uid || ""; var default_face_url = default_face_url || "/assets/people/defaultPerson.png" %>\n<li data-facebook-uid="<%= facebook_uid %>" data-uid="<%= uid %>" class="suggestion-item">\n    <img src="<%= default_face_url %>" class="avatar" />\n    <a class="person-name"></a>\n</li>',t})}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}};define("ThisLife.Onboarding.Controllers.Onboarding",["ThisLife.Onboarding.Views.Onboarding"],function(t){var i;return i=function(){function i(){this.clickCb=e(this.clickCb,this)}return _.extend(i.prototype,Backbone.Events),i.prototype.show=function(e){var i,n,o,s,r,l,a,u,c;return a=_.pick(e,"v","s","p"),ThisLife.app.isMobile&&(a=_.pick(e,"v","s")),this.onboardingFlows=a,l=_.uniq(_.values(this.onboardingFlows)),1===l.length&&1===l[0]?!1:(s={className:"photos",headline:"All your Shutterfly photos and albums are here",buttonText:"Got It"},c={className:"upload",headline:"Here\u2019s where you upload<br/>Photo storage is always free and unlimited",buttonText:"Got It"},r={className:"search",headline:"Easily find the photos you need",buttonText:"Try It"},o={className:"people",headline:"Manage your people, tags and settings here",buttonText:"Got It"},n=[s,c,o,r],0===ThisLife.Collection.moments.getMomentCount()&&(c.buttonText="Try It",n=[s,o,c],1===e.v)?!1:(1===e.v&&(n=[o,r]),1===e.v&&1===e.p&&(n=[r]),ThisLife.app.isMobile&&(s.headline="All your Shutterfly photos and albums are here.",n=[s,r]),1!==e.v||1!==e.s||ThisLife.app.isMobile||(n=[o],this.clickCb(null,"people")),u=function(e){return function(t){return e.setLifeFeatureFlow(t)}}(this),i=function(e){return function(t){return null==t&&(t=null),t&&e.updateLifeFlow(t),e.view=null}}(this),this.view=new t({flow:n,doneCallback:i,updateCallback:u,clickCallback:this.clickCb})))},i.prototype.hide=function(){var e;return null!=(e=this.view)&&e.remove(),this.view=null},i.prototype.onboardingViewShown=function(){return this.view?!0:!1},i.prototype.updateLifeFlow=function(e){return"search"===e&&($(".vs-finder-icon").click(),this.setLifeFeatureFlow("search")),"upload"===e&&($(".secondarybar-upload").click(),this.setLifeFeatureFlow("vertical")),"photos"===e&&ThisLife.app.isMobile&&this.setLifeFeatureFlow("vertical"),"people"===e?(this.clickCb("people",null),this.setLifeFeatureFlow("people")):void 0
},i.prototype.setLifeFeatureFlow=function(e,t){var i,n,o,s;switch(null==t&&(t=1),i=this.onboardingFlows||{},s=1===t?1:0,e){case"vertical":i.v=s;break;case"search":i.s=s;break;case"people":i.p=s;break;case"lifetouch":i.l=s}return ThisLife.Service.api.setVerticalOnboarding(i),o="v","search"===e&&(o="s"),"people"===e&&(o="p"),"lifetouch"===e&&(o="l"),null!=(n=this.onboardingFlows)&&(n[o]=s),ThisLife.appModel.setOnboardingFlows(i)},i.prototype.clickCb=function(e,t){return $(".account_dropdown").removeClass("visible"),"people"!==t||$(".account_dropdown").hasClass("visible")||_.defer(function(){return function(){var e;return e=document.getElementsByClassName("menu_item account_dropdown")[0],null!=e?e.classList.add("visible"):void 0}}(this)),"people"===e&&this.setLifeFeatureFlow("people"),ThisLife.app.isMobile&&"photos"===e?this.setLifeFeatureFlow("vertical"):void 0},i.prototype._resetOnboardingStates=function(){return this.setLifeFeatureFlow("people",0),this.setLifeFeatureFlow("search",0),this.setLifeFeatureFlow("vertical",0),this.setLifeFeatureFlow("lifetouch",0)},i}()})}.call(this),function(){define("ThisLife.Onboarding.Views.Onboarding",[],function(){var e;return e=Backbone.View.extend({className:"onboarding-background",events:{"click .onboarding-button":"nextScreen"},initialize:function(e){return null==e&&(e={}),this.flow=e.flow,this.currentFlowIndex=0,this.currentScreen=this.flow[this.currentFlowIndex],this.updateCallback=e.updateCallback,this.doneCallback=e.doneCallback,this.clickCallback=e.clickCallback,this.render(),this._bindEvents(),this},render:function(){return this.$el.html(this._template()),ThisLife.app.isMobile&&this.el.classList.add("mobile"),document.body.appendChild(this.el),this._cacheElements(),this},_cacheElements:function(){return this.onboardingSpotlight=this.el.querySelector(".onboarding-spotlight"),this.onboardingWrapper=this.el.querySelector(".onboarding-wrapper"),this.onboardingHeadline=this.el.querySelector(".onboarding-headline"),this.onboardingButton=this.el.querySelector(".onboarding-button")},nextScreen:function(){var e;return this.currentFlowIndex===this.flow.length-1?(this.teardown(!0),!1):(this.onboardingWrapper.classList.add("moving"),e=this.currentScreen.className,"upload"===e&&this.updateCallback("vertical"),this.clickCallback(e,this.flow[this.currentFlowIndex+1].className),this.currentFlowIndex++,this.currentScreen=this.flow[this.currentFlowIndex],this.onboardingWrapper.classList.add(this.currentScreen.className),this.onboardingWrapper.classList.remove(e),setTimeout(function(e){return function(){return e.updateElements(),e.onboardingWrapper.classList.remove("moving")}}(this),400))},updateElements:function(){return this.onboardingHeadline.innerHTML=this.currentScreen.headline,this.onboardingButton.innerHTML=this.currentScreen.buttonText},teardown:function(e){return null==e&&(e=!1),this._unbindEvents(),e?(this.onboardingWrapper.classList.add("last-screen"),setTimeout(function(e){return function(){return e.remove(),e.doneCallback(e.currentScreen.className)}}(this),200),!0):(this.doneCallback(),this.remove())},_template:function(){return'<div class="onboarding-wrapper '+this.currentScreen.className+'">\n  <div class="onboarding-spotlight"></div>\n  <div class="onboarding-info">\n    <div class="onboarding-arrow"></div>\n    <div class="onboarding-headline">'+this.currentScreen.headline+'</div>\n    <a class="onboarding-button">'+this.currentScreen.buttonText+"</a>\n  </div>\n</div>"},_bindEvents:function(){return ThisLife.Support.keyInformant.on("cancel",this.nextScreen,this,!0)},_unbindEvents:function(){return ThisLife.Support.keyInformant.off("cancel",this.nextScreen,this,!0)}})})}.call(this),function(){define("ThisLife.Tags.Controllers.Tags",["ThisLife.PubSub","ThisLife.Tags.Views.Header"],function(e,t){var i;return i=function(){function e(e){this.options=null!=e?e:{},this._collection={}}return _.extend(e.prototype,Backbone.Events),e.prototype.show=function(e){var i,n;return null!=(i=this._mainView)&&i.remove(),null!=(n=this._header)&&n.remove(),"people"===e&&(this._header=new t({type:e,controller:this,placeholder:"Search person"}),this._mainView=ThisLife.View.peopleSection=new ThisLife.View.PeopleSection({collection:ThisLife.Collection.personTags,header:this._header})),"tags"===e&&(this._header=new t({type:e,controller:this,placeholder:"Search tag"}),this._mainView=new ThisLife.View.TagsView({collection:ThisLife.Collection.momentTags,header:this._header})),this},e}()})}.call(this),function(){define("ThisLife.Tags.Views.Header",[],function(){var e;return e=Backbone.View.extend({className:"tags_header",events:{"keyup input":"keyupListener","focus input":"inputFocus","blur input":"inputBlur","click .search_input_wrap .icon_delete":"clearSearch","click .breadcrumb_bar .bc_back_wrapper":"clickedBack"},initialize:function(e){return null==e&&(e={}),this.controller=e.controller,this._type=e.type,this._label=e.label||this._type.charAt(0).toUpperCase()+this._type.slice(1),this._placeholder=e.placeholder||"Search "+this._label,this},render:function(){return this.el.insertAdjacentHTML("afterbegin",this._template()),this.setInformationIcon(),this},setInformationIcon:function(){var e,t;return"tags"===this._type?!1:(t='<svg viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><title>icons/notifications/information</title><defs><path d="M11 2c-4.963 0-9 4.037-9 9s4.037 9 9 9 9-4.037 9-9-4.037-9-9-9m0 20C4.935 22 0 17.065 0 11S4.935 0 11 0s11 4.935 11 11-4.935 11-11 11M9.5 7a1.5 1.5 0 1 1 3 0 1.5 1.5 0 0 1-3 0zm1.5 9.25c-.69 0-1.25-.56-1.25-1.25v-4a1.25 1.25 0 0 1 2.5 0v4c0 .69-.56 1.25-1.25 1.25z" id="icons/notifications/information-path-1-12077"/></defs><g id="icons/notifications/information-icon-library-12077" fill="none" fill-rule="evenodd"><g id="icons/notifications/information-notifications-12077" transform="translate(-20 -153)"><g id="icons/notifications/information-icons/notifications/information-12077" transform="translate(20 153)"><mask id="icons/notifications/information-mask-2-12077" fill="#fff"><use xlink:href="#icons/notifications/information-path-1-12077"/></mask><use id="icons/notifications/information-information-12077" fill="#2D3137" xlink:href="#icons/notifications/information-path-1-12077"/><g id="icons/notifications/information-color-/-18.-black_000000-12077" mask="url(#icons/notifications/information-mask-2-12077)" fill="#000"><path id="icons/notifications/information-black_000000-12077" d="M0 0h22v22H0z"/></g></g></g></g></svg>',e=this.el.querySelector(".bc_informational"),e.innerHTML=t)},teardown:function(){return this.remove()},clickedBack:function(){return this.teardown(),ThisLife.app.router.navigateToLibrary()},_template:function(){return'          <div class="breadcrumb_bar '+this._type+'">\n	<div class="bc_back_wrapper">\n		<span class="bc_arrow"></span>\n		<span class="bc_back_btn">Back to All Photos</span>\n	</div>\n	<div class="bc_label">'+this._label+'</div>\n      	    <div class="wrapper-bc_informational">\n              <div class="bc_informational">i</div>\n              <div class="message_info disabled_tooltip">\n                  We automatically detect faces for you to make searching easy.<br/><br/>\n                  Faces are updated and grouped every time you upload new photos.\n              </div>\n            </div>\n</div>\n          <div class="secondary_bar '+this._type+'">\n            <div class="search_input_wrap">\n              <input class="search_'+this._type+'_input" type="text" placeholder="'+this._placeholder+'"/>\n              <div class="icon"></div>\n              <div class="icon_delete"></div>\n            </div>\n          </div>'}})})}.call(this),function(){define("ThisLife.Timing.Controllers.Timing",["ThisLife.Helper.Features"],function(e){var t;return t=function(){function t(e){this.options=null!=e?e:{},this.logger=SFJSLogger("PMC_Web",{resource:ThisLife.Settings.sflyLoggerUrl}),this.timers={},this.baseTimers={},this.stateFlags={},this.version=1}return _.extend(t.prototype,Backbone.Events),t.prototype.startTimer=function(e){var t;return this.timers[e]?!1:(t=performance.now(),this.timers[e]={startTime:t},!0)},t.prototype.endTimer=function(e,t,i){var n;return null==t&&(t={}),this.timers[e]?(n=performance.now()-this.timers[e].startTime,i?(this.timers[e].options=t,this.timers[e].duration=n):(this.recordTime(e,n,t),delete this.timers[e]),!0):!1},t.prototype.recordDeferredTime=function(e,t){return this.timers[e]?(t&&(this.timers[e].options=t),this.recordTime(e,this.timers[e].duration,this.timers[e].options),delete this.timers[e],!0):!1},t.prototype.deleteTimer=function(e){return this.timers[e]?(delete this.timers[e],!0):!1},t.prototype.recordLoadEvent=function(e,t){return this.recordTime(e,performance.now(),t)},t.prototype.recordTime=function(t,i,n){var o,s,r,l,a,u,c,d,h,p,f,m;return null==n&&(n={}),s=_.extend(n,{user_browser:bowser.name+bowser.version,platform:ThisLife.Helper.Platform.osName()}),null!=("undefined"!=typeof ThisLife&&null!==ThisLife&&null!=(r=ThisLife.Collection)?r.moments:void 0)&&ThisLife.Collection.moments.loaded&&(s.moments_in_account=ThisLife.Collection.moments.getMomentCount()),null!=("undefined"!=typeof ThisLife&&null!==ThisLife&&null!=(l=ThisLife.Model)&&null!=(a=l.Albums)&&null!=(u=a.Master)?u.albumCollection:void 0)&&(s.albums_in_account=ThisLife.Model.Albums.Master.albumCollection.length),("undefined"!=typeof ThisLife&&null!==ThisLife&&null!=(c=ThisLife.app)&&null!=(d=c.currentState)?d.albums:void 0)&&"album"===(null!=(h=ThisLife.app.currentState.options)?h.view:void 0)&&null!=("undefined"!=typeof ThisLife&&null!==ThisLife&&null!=(p=ThisLife.currentStory)?p.moments:void 0)&&(s.moments_in_album=ThisLife.currentStory.moments.length),null!=("undefined"!=typeof ThisLife&&null!==ThisLife&&null!=(f=ThisLife.Model)&&null!=(m=f.User)?m.id:void 0)&&(s.personUid=ThisLife.Model.User.id),o=e.getFeatures(),Object.keys(o).map(function(e){return s[e]=o[e]}),s.version=this.version,this.logger.metric(t,i,s)},t.prototype.recordInfo=function(e,t){var i,n;return t.user_browser=bowser.name+bowser.version,t.platform=ThisLife.Helper.Platform.osName(),t.timestamp=Date.now(),t.version=this.version,null!=("undefined"!=typeof ThisLife&&null!==ThisLife&&null!=(i=ThisLife.Model)&&null!=(n=i.User)?n.id:void 0)&&(t.personUid=ThisLife.Model.User.id,t.email=ThisLife.Model.User.get("email")),this.logger.info(e,t)},t.prototype.recordEvent=function(e){return this.baseTimers[e]=performance.now()},t.prototype.loadOrLoginEvent=function(e,t){return ThisLife.firstLoggedOut?this.timeSinceEvent("loginTo"+e,"login",t):this.recordLoadEvent("loadTo"+e)},t.prototype.loadOrNavigateEvent=function(e,t){var i;return this.stateFlags["loadTo"+e]?this.loadOrLoginEvent(e,t):this.stateFlags["navigateTo"+e]?(i="navigate"+e,this.timeSinceEvent("navigateTo"+e,i,t),delete this.baseTimers[i]):void 0},t.prototype.timeSinceEvent=function(e,t,i){var n,o;return this.baseTimers[t]?(i=i||performance.now(),o=i-this.baseTimers[t],n={sanity:!0},i<this.baseTimers[t]&&(n.sanity=!1,n.insaneTimestamp=i,n.insaneBaseTimer=this.baseTimers[t],n.insaneEvent=t),this.recordTime(e,o,n),!0):!1},t.prototype.getStateFlags=function(){return this.stateFlags},t.prototype.setStateFlags=function(e){return this.stateFlags.loadToAlbum=!1,this.stateFlags.loadToAlbums=!1,this.stateFlags.navigateToAlbum=!1,this.stateFlags.navigateToAlbums=!1,e.albums?"album"===e.fragment.split("/")[0]?e.previous?(this.stateFlags.navigateToAlbum=!0,this.stateFlags.loadToAlbum=!1):(this.stateFlags.loadToAlbum=!0,this.stateFlags.navigateToAlbum=!1):e.previous?(this.stateFlags.navigateToAlbums=!0,this.stateFlags.loadToAlbums=!1):(this.stateFlags.loadToAlbums=!0,this.stateFlags.navigateToAlbums=!1):void 0},t.prototype.recordSessionEvents=function(e){return ThisLife.app.session.getSessionToken().then(function(t){return function(i){return null!=e.err&&(e.err=JSON.stringify(e.err)),e.token=i,e.useNewAuth=window.UseNewAuth,t.recordInfo("session",e)}}(this))},t}()})}.call(this),define("ThisLife.Toast.Controllers.Toast",["ThisLife.Toast.Views.Container","ThisLife.Toast.Views.Toast"],function(e,t){function i(){this.container=null,this.toasts={}}var n={close:!1,position:"top-right",style:"dark",timeout:3e3};return i.prototype["new"]=function(i){"undefined"==typeof i&&(i={});var o=_.uniqueId("pmc-toast-"),s=_.extend({},n,{guid:o},i);null===this.container&&(this.container=new e(s),document.body.appendChild(this.container.render().el));var r=new t(s);return this.container.el.appendChild(r.render().el),this.toasts[o]=r,o},i.prototype.updateText=function(e,t){"undefined"==typeof t&&(t={}),e&&this.toasts.hasOwnProperty(e)&&this.toasts[e].updateText(t)},i.prototype.updateView=function(e,t){"undefined"==typeof t&&(t={}),e&&this.toasts.hasOwnProperty(e)&&this.toasts[e].updateView(t)},i.prototype.clear=function(e){"undefined"==typeof e?_.each(this.toasts,function(e,t){e.teardown(),delete this.toasts[t]}.bind(this)):this.toasts.hasOwnProperty(e)&&(this.toasts[e].teardown(),delete this.toasts[e]),null!==this.container&&0===Object.keys(this.toasts).length&&(document.body.removeChild(this.container.el),this.container.teardown(),this.container=null)},i}),define("ThisLife.Toast.Views.Container",[],function(){var e=Backbone.View.extend({className:"pmc-toast-container",initialize:function(e){return"undefined"==typeof e&&(e={}),this._addStyles(e),this},render:function(){return this},teardown:function(){this.remove()},_addStyles:function(e){this.el.classList.add(e.position),this.el.classList.add(e.style)}});return e}),define("ThisLife.Toast.Views.Toast",[],function(){var e=Backbone.View.extend({className:"pmc-toast",events:{"click .close":"close",mouseout:"resetTimer",mouseover:"clearTimer"},initialize:function(e){return"undefined"==typeof e&&(e={}),this.options=e,this.timeout=null,this},render:function(){if(this.options.view&&"function"==typeof this.options.view?(this.view=new this.options.view(this.options.view_options),this.el.appendChild(this.view.render().el)):(this.options.title&&(this.el.setAttribute("data-title",this.options.title),this.el.classList.add("title")),this.options.text&&(this.el.innerText=this.options.text)),this.options.close){var e=document.createElement("div");e.classList.add("close"),this.el.appendChild(e)}return this.options.slim&&this.el.classList.add("slim"),this.el.setAttribute("data-guid",this.options.guid),this.options.timeout&&this.startTimer(),this},updateText:function(e){this.el.textContent=e.text,this.resetTimer()},updateView:function(e){this.view&&"function"==typeof this.view.update&&this.view.update(e),this.resetTimer()},close:function(){ThisLife.app.controller("toast").clear(this.options.guid)},teardown:function(){this.options.closeCallback&&"function"==typeof this.options.closeCallback&&this.options.closeCallback(),this.view&&"function"==typeof this.view.teardown&&this.view.teardown(),this.clearTimer(),this.remove()},startTimer:function(){this.timeout=setTimeout(this._timeoutOver.bind(this),this.options.timeout)},clearTimer:function(){this.timeout&&(clearTimeout(this.timeout),this.timeout=null)},resetTimer:function(){this.options.timeout&&(this.clearTimer(),this.startTimer())},_timeoutOver:function(){ThisLife.app.controller("toast").clear(this.options.guid)}});return e}),function(){var e,t,i=function(e,t){return function(){return e.apply(t,arguments)}};define("ThisLife.Application",["ThisLife.Helper.Features","ThisLife.Helper.Scripts"],function(n,o){return ThisLife.Application=function(){function s(){this._loadLifeFeatureFlow=i(this._loadLifeFeatureFlow,this);var e;this.ignoreOnboarding=!1,e=!1}return s.prototype.controllers={},s.prototype.controllerMap={addressbook:"ThisLife.AddressBook.Controllers.AddressBook",albums_migration:"ThisLife.Migration.Controllers.MigrationAlbumsController",albums:"ThisLife.Albums.Controllers.Albums",appmodal:"ThisLife.AppModal.Controllers.AppModal",auth_parent:"ThisLife.Auth.Controllers.Parent",download:ThisLife.Download.Controllers.Moment,faqs:ThisLife.Faqs.Controllers.Faqs,flyout:"ThisLife.Flyout.Controllers.Flyout",fullview:"ThisLife.FullView.Controllers.FullView",gifting:ThisLife.Gifting.Controllers.Gifting,importProgress:"ThisLife.ImportProgress.Controllers.ImportProgress",migration:"ThisLife.Migration.Controllers.MigrationHandler",moment:ThisLife.MomentView.Controllers.Moment,onboarding:"ThisLife.Onboarding.Controllers.Onboarding",selection:"ThisLife.Selection.Controllers.Selection",slideshow:ThisLife.Slideshow.Controllers.Slideshow,tags:"ThisLife.Tags.Controllers.Tags",timeline:"ThisLife.Timeline.Controllers.Timeline",timing:"ThisLife.Timing.Controllers.Timing",toast:"ThisLife.Toast.Controllers.Toast",tracking:"ThisLife.Tracking.Controllers.Tracking",trash:"ThisLife.Trash.Controllers.Trash",uploader:"ThisLife.Uploader.Controllers.Uploader",video:ThisLife.Download.Controllers.Video,visual_search:"ThisLife.VisualSearch.Controllers.VisualSearch"},s.prototype.controller=function(e){return this.controllers[e]||(this.controllers[e]="string"==typeof this.controllerMap[e]?new(require(this.controllerMap[e])):new this.controllerMap[e]),this.controllers[e]},s.prototype.start=function(){return ThisLife.app.controller("timing").recordLoadEvent("loadToStart"),this._initSession()},s.prototype.onBeforeUnload=function(){return this.forceExit?void 0:this._isUploading()?"You have uploads in progress. If you close Shutterfly Photos, your current uploads will stop.":this._isDeleting()?"You have changes in progress. If you close Shutterfly Photos, your changes will not be saved.":void 0},s.prototype.deleteAccount=function(e,t){return this.whenReady(function(i){return function(){return i._ignoreUploads(),ThisLife.Service.api.deleteAccount(e,function(e){var n;return n=function(){return i._appModel.clear(function(){return ThisLife.app.session.gotoLogout()})},e.result.success?window.momentLoaderClient.clearMoments(n,n):"function"==typeof t?t(e.result.message):void 0})}}(this))},s.prototype.immediateLogout=function(){return this._appModel.clearSession(),ThisLife.app.session.gotoLogout()},s.prototype.logout=function(e,t){return null==t&&(t=!1),this.whenReady(function(i){return function(){var n;return n=function(){var e;return i._ignoreUploads(),ThisLife.PubSub.trigger("addLoader"),i._appModel.clearSession(),e=function(){return ThisLife.app.session.gotoLogout(t)},window.momentLoaderClient.clearMoments(e,e)},!e&&i._isUploading()?i._appView.confirmLogout(n):n()}}(this))},s.prototype.refresh=function(){return this.whenReady(function(e){return function(){var t;return t=function(){var t,i,n;return e._ignoreUploads(),n=e.router,ThisLife.PubSub.trigger("addLoader"),n.navigateToIndex({trigger:!1}),null!=(t=ThisLife.app)&&"function"==typeof t.controller&&null!=(i=t.controller("timing"))&&i.recordSessionEvents({event:"refresh",err:"app reload",session_method:"refresh"}),window.location.reload()},e._isUploading()?e._appView.confirmRefresh(t):t()}}(this))},s.prototype._loadLifeFeatureFlow=function(){var e,t;return e=!1,this._appModel.showTrashConfirmation=!0,t={v:1,p:1,s:1},this.whenReady(function(i){return function(){return ThisLife.Service.api.getLifeFeatureFlows(function(n){var o,s,r,l;if((null!=n?n.result.payload:void 0)&&Array.isArray(null!=n?n.result.payload:void 0))for(l=n.result.payload,o=0,r=l.length;r>o;o++)s=l[o],"photos-onboarding"===s.key&&"1"===s.value&&(e=!0),"vertical"===s.key&&(_.isObject(JSON.parse(s.value))&&(t=_.extend(t,JSON.parse(s.value))),"0"===s.value&&(t="{v:0, p:0, s:0}"),t.showTrashConfirmation&&"0"===t.showTrashConfirmation&&(i._appModel.showTrashConfirmation=!1));return e&&ThisLife.Collection.moments.getMomentCount()>0?"1"!==i._appModel.getOnboarding()&&i._appModel.setOnboarding("1"):!e&&i.useUPP&&(i.ignoreOnboarding=!0),i._appModel.setOnboardingFlows(t)})}}(this))},s.prototype.lifeNotFound=function(){return this._appModel.clearSession(),this._appView.lifeNotFound()},s.prototype.invalidToken=function(){return this._appModel.clearSession(),this._appView.invalidToken()},s.prototype._handleLogin=function(){var e;return this._setupLifePermission(),ThisLife.Collection.TagsCollection.load(),("tl"===(e=ThisLife.Model.User.get("migration_status"))||"tl_inprogress"===e||"sfly_inprogress"===e)&&(ThisLife.migrationCtrl=ThisLife.app.controller("migration")),this.controller("tracking").setup(),this._appStart()},s.prototype._setup=function(){var e;return ThisLife.app.controller("timing").startTimer("setup"),(bowser.ios||bowser.android)&&(this.isMobile=!0,$("body").addClass("mobile_override")),e=ThisLife.Settings.enableLog(),ThisLife.log=new ThisLife.Support.Log(e),ThisLife.performanceMonitor=new ThisLife.Support.PerformanceMonitor(e,ThisLife.log),ThisLife.log.debug("app setup - init app"),ThisLife.Support.GlobalErrorHandler.init(_.bind(this._uncaughtErrorHandler,this),ThisLife.Settings.enableGlobalErrorHandler()),ThisLife.Support.keyInformant=new ThisLife.Support.KeyInformant,this.filter=new ThisLife.Filter,this.browserConfig=ThisLife.AppBrowser.create(),ThisLife.DelayedExecution=new ThisLife.Helper.DelayedExecution,ThisLife.app.controller("fullview").setup(),this._bindEvents(),this._configLibraries(),ThisLife.appModel=this._appModel=new ThisLife.AppModel({skipRetry:this.isMobile}),ThisLife.app.controller("timing").endTimer("setup")},s.prototype._appStart=function(){return ThisLife.app.controller("timing").startTimer("appStart"),ThisLife.log.debug("app setup - start app"),this.library=new ThisLife.Library,this.album=ThisLife.app.controller("albums"),this.router.start(),ThisLife.app.controller("timing").endTimer("appStart",{firstLoggedOut:ThisLife.firstLoggedOut}),n.whenReady("upp",function(e){return function(t){return e.useUPP=t,e._loadLocalData(),e._loadLifeFeatureFlow(),e._loadAdditionalLibraries(),ThisLife.uploader=ThisLife.app.controller("uploader"),e.socialToken=new ThisLife.Support.SocialImportToken}}(this))},s.prototype._loadAdditionalLibraries=function(){return o.loadFaceBookSDK()},s.prototype._configLibraries=function(){return Backbone.emulateHTTP=!0,Pusher.log=this._pusherLogHandler},s.prototype._bindEvents=function(){return $(document).ready(_.bind(this._domReadyHandler,this)),$(window).on("resize",this._resizeHandler),$(window).on("focus",this._focusHandler)},s.prototype._setupLifePermission=function(){var e;return ThisLife.app.controller("timing").startTimer("setupLifePermission"),e=ThisLife.Model.User.getLifePermission(),ThisLife.currentLifeOwner=e.owner_person_uid,ThisLife.lifeUid=e.life_uid,ThisLife.app.controller("timing").endTimer("setupLifePermission",{firstLoggedOut:ThisLife.firstLoggedOut})},s.prototype._loadLocalData=function(){var e;return ThisLife.app.controller("timing").startTimer("loadMomentData"),ThisLife.log.debug("app setup - start load local data"),ThisLife.MomentDBClient=require("MomentDbClient"),e={env:ThisLife.Settings.sflyEnv,trackingCallback:_.bind(this._logMomentSync,this)},window.momentLoaderClient?window.momentLoaderClient.setRequestParams(e):(window.momentLoaderClientSingleton=new ThisLife.MomentDBClient(e),window.momentLoaderClient=momentLoaderClientSingleton.getInstance()),window.momentLoaderClient.loadMoments({oauthToken:ThisLife.sessionToken,lifeUid:ThisLife.lifeUid},_.bind(this._momentSyncCompleteHandler,this),_.bind(this._momentSyncErrorHandler,this))},s.prototype.whenReady=function(e){return this._isReady?e():(this._readyHandlers=this._readyHandlers||[],this._readyHandlers.push(e))},s.prototype.setState=function(e,t){var i;return this.closeModal(),this._isSameState(e)?void 0:(i=this.currentState,this.currentState=this._createState(e,i,t),this.currentState.library&&(this.lastLibraryState=this.currentState),ThisLife.PubSub.trigger("state:change",this.currentState),ThisLife.PubSub.trigger("state:changeTo:"+e,this.currentState),i&&ThisLife.PubSub.trigger("state:changeFrom:"+i.name,this.currentState),ThisLife.app.controller("timing").setStateFlags(this.currentState))},s.prototype.preStateChange=function(e){var t;if(!this._isSameState(e))return t=this._createState(e,this.currentState),ThisLife.PubSub.trigger("state:preChange",t),ThisLife.PubSub.trigger("state:preChangeTo:"+e,t)},s.prototype.isPreviousState=function(e){var t;return e===(null!=(t=this.currentState.previous)?t.name:void 0)},s.prototype.defaultStateName=function(){return"library"},s.prototype.showModal=function(e,t,i){var n,o;if(e!==(null!=(o=this.currentModal)?o.name:void 0)||i)return this.currentState||this.setState(this.defaultStateName()),n=this.currentModal,this.currentModal={name:e,options:t},this.transitioningToNewModal=!0,n&&(ThisLife.PubSub.trigger("modal:close:"+n.name),ThisLife.PubSub.trigger("modal:close")),this.transitioningToNewModal=!1,ThisLife.PubSub.trigger("modal:show:"+e,this.currentModal),ThisLife.PubSub.trigger("modal:show",this.currentModal)},s.prototype.closeModal=function(){var e;if(!this.transitioningToNewModal&&this.currentModal)return e=this.currentModal.name,this.currentModal=null,ThisLife.PubSub.trigger("modal:close:"+e),ThisLife.PubSub.trigger("modal:close")},s.prototype.loadMaritzCXSurvey=function(){var e,t,i,n;return t=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight,i=t&&t>900?(t-700)/2:0,n="menubar=1,resizable=1,width=560,height=760,top="+i,e=window.open("https://shutterfly.allegiancetech.com/cgi-bin/qwebcorporate.dll?idx="+ThisLife.Settings.maritzCXIdx+"&UID="+ThisLife.Model.User.id+"&Reported_URL=photos.shutterfly.com","mcxSurvey",n),null!=e&&e.focus(),!0},s.prototype._isSameState=function(e){return null!=this.currentState&&e===this.currentState.name&&this.router.fragment()===this.currentState.fragment},s.prototype.isSameFragment=function(e){return null!=this.currentState&&e===this.currentState.fragment&&this.router.fragment()===this.currentState.fragment},s.prototype._createState=function(e,t,i){return{name:e,previous:t,filtered:"peopleFiltered"===e||"tagsFiltered"===e||"placesFiltered"===e,library:"library"===e,stories:"stories"===e||"storiesFollowing"===e,story:"story"===e||"storyFollowing"===e,albums:"albums"===e,options:i,fragment:this.router.fragment()}},s.prototype._ready=function(){var e,t,i,n;if(this._isReady=!0,this._readyHandlers)for(n=this._readyHandlers,t=0,i=n.length;i>t;t++)(e=n[t])();return this._readyHandlers=void 0},s.prototype._logMomentSync=function(e){var t;return t=(new Date).getTime(),_.each(e,function(){return function(e){return ThisLife.LogSmithManager.enqueueGenericMetrics({name:e.name,value:e.value,timestamp:t,category:"momentsSync"})}}(this)),this._momentDBTrackingData=e},s.prototype._momentSyncCompleteHandler=function(e){return ThisLife.app.controller("timing").endTimer("loadMomentData",{success:!0,firstLoggedOut:ThisLife.firstLoggedOut},!0),ThisLife.app.session.getSessionToken().then(function(t){return function(i){var n;return ThisLife.app.controller("timing").startTimer("momentSyncCompleteHandler"),t._ready(),ThisLife.appModel.saveMoments(e.moments),ThisLife.app.controller("timing").recordDeferredTime("loadMomentData"),t.socialToken=new ThisLife.Support.SocialImportToken,ThisLife.Helper.setupServices(i),t._fetchPeopleData(),t._startPusher(),ThisLife.notificationList("validate"),n=new ThisLife.Model.Overlimit,n.check(),_.each(t._momentDBTrackingData,function(e){return ThisLife.app.controller("timing").recordTime("momentDB_"+e.name,e.value,{firstLoggedOut:ThisLife.firstLoggedOut})}),ThisLife.app.controller("timing").endTimer("momentSyncCompleteHandler",{firstLoggedOut:ThisLife.firstLoggedOut})}}(this))},s.prototype._momentSyncErrorHandler=function(e){return ThisLife.app.controller("timing").endTimer("loadMomentData",{success:!1,firstLoggedOut:ThisLife.firstLoggedOut}),ThisLife.log.error("app setup - moment sync error",e),(null!=e?e.networkError:void 0)?this.refresh():(null!=e?e.forceRefresh:void 0)?this.refresh():this._appView.momentSyncError()},s.prototype._fetchPeopleData=function(){return ThisLife.Service.api.getSuggestedFaceGroupCount(),ThisLife.Service.api.getRelationships(function(){return function(e){var t,i,n;for(t=0,n=e.length;n>t;t++)i=e[t],ThisLife.Collection.relationships.add(i);return ThisLife.Collection.relationships.trigger("reset")}}(this))},s.prototype._initViews=function(){return ThisLife.app.controller("timing").startTimer("initViews"),ThisLife.Helper.DOM.addMany(document.documentElement,this.browserConfig.cssClassName),this._appView=new ThisLife.View.App,ThisLife.app.controller("timing").endTimer("initViews")},s.prototype._initRouter=function(){return ThisLife.app.controller("timing").startTimer("initRouter"),this.router=this.isMobile?new ThisLife.AppRouterMobile:new ThisLife.AppRouter,ThisLife.app.controller("timing").endTimer("initRouter")},s.prototype._initServices=function(){return ThisLife.app.controller("timing").startTimer("initServices"),ThisLife.Service["import"]=new ThisLife.Service.Import,ThisLife.Service.api.setup(_.bind(this._apiGetSubSourceHandler,this)),ThisLife.Service.api.on("error",this._apiErrorHandler,this),ThisLife.app.controller("timing").endTimer("initServices")},s.prototype._initSession=function(){return ThisLife.app.controller("auth_parent").getSession({getStartUpInfo:!0}).then(function(e){return function(t){return e.session=t,e.session.whenLoggedIn(e._handleLogin,e),e._setup(),e._initRouter(),e._initServices(),e._initViews(),window.onbeforeunload=_.bind(e.onBeforeUnload,e)}}(this))},s.prototype._startPusher=function(){return this.pusher=new ThisLife.MainPusher(null,ThisLife.Settings.pusherKey),this.pusher.init(),this.pusher.start()},s.prototype._loadPixelTracking=function(){var e;return ThisLife.isTLSignup?(e=new Image,e.src="https://adfarm.mediaplex.com/ad/bk/24970-184801-3840-0?registration_confirm=1&mpuid=;"+ThisLife.Model.User.id+";"):void 0},s.prototype._loadMtiTracking=function(){return window.MTIProjectId=ThisLife.Settings.mtiTracking.projectId,ThisLife.loadScriptAsync(ThisLife.Settings.mtiTracking.url)},s.prototype._ignoreUploads=function(){return this.forceExit=!0,window.onbeforeunload=null},s.prototype._isUploading=function(){var e;return null!=(e=ThisLife.uploader)?e.isUploading():void 0},s.prototype._isDeleting=function(){return this.controller("trash").isDeleting()},s.prototype.isMigrating=function(){var e;return null!=(e=ThisLife.migrationCtrl)?e.isMigrating:void 0},s.prototype._domReadyHandler=function(){return ThisLife.Model.User.once("reset",this._loadPixelTracking,this)},s.prototype._focusHandler=function(){var e,t;return(null!=(t=ThisLife.app.session)?t.isLoggedIn():void 0)?(e={experience:"d.web",action:"appforeground"},ThisLife.Service.api.dataWarehouseLog(e)):void 0},s.prototype._resizeHandler=function(){return ThisLife.PubSub.trigger("resize")},s.prototype._uncaughtErrorHandler=function(e){var t;return ThisLife.log.error(e),null!=(t=this._appView)?t.uncaughtError(e):void 0},s.prototype._pusherLogHandler=function(e){return ThisLife.log.debug(e)},s.prototype._apiErrorHandler=function(e){var t,i,n,o,s,r;return ThisLife.log.error("service request error: "+e.message,e.errors),e.invalidToken?(null!=(t=ThisLife.app)&&"function"==typeof t.controller&&null!=(i=t.controller("timing"))&&i.recordSessionEvents({event:"api error",err:"invalidToken",session_method:"_apiErrorHandler"}),this.invalidToken()):e.lifeNotFound?(null!=(n=ThisLife.app)&&"function"==typeof n.controller&&null!=(o=n.controller("timing"))&&o.recordSessionEvents({event:"api error",err:"lifeNotFound",session_method:"_apiErrorHandler"}),this.lifeNotFound()):e.accessDenied?(null!=(s=ThisLife.app)&&"function"==typeof s.controller&&null!=(r=s.controller("timing"))&&r.recordSessionEvents({event:"api error",err:"accessDenied",session_method:"_apiErrorHandler"}),this.router.navigateToLogout()):void 0},s.prototype._apiGetSubSourceHandler=function(){var i,n,o,s,r;return i=null!=(n=this.currentModal)?n.name:void 0,r=e[i],null==r&&(s=(null!=(o=this.currentState)?o.name:void 0)||"timeline",r=t[s],null==r&&(ThisLife.Support.GlobalErrorHandler.handleError("no API subsource mapping for current state '"+s+"' or modal '"+i+"'"),r=s)),r},s}(),ThisLife.Application}),t={timeline:"library",library:"library",stories:"stories",storiesFollowing:"stories",story:"story",storyFollowing:"story",peopleFiltered:"searchresult",tagsFiltered:"searchresult",placesFiltered:"searchresult",people:"people",tags:"tags",places:"places",home:"home",albums:"albums",migrationAlbums:"albums",gifting:"gifting",trash:"trash",fullview:"FMV"},e={fullView:"FMV",settings:"settings",peopleEdit:"editperson",peopleSuggestions:"identifyperson"}}.call(this),define("ThisLife.Helper.Features",[],function(){function e(){return _.isEmpty(a)&&(a=$.cookies.get("photos-features")||{},_.each(f,function(e,t){"undefined"==typeof a[t]&&(a[t]=e)})),a}function t(t){adobe.target.applyOffer({mbox:"target-global-mbox",offer:t}),e(),_.each(c,function(e,t){a.hasOwnProperty(t)||(a[t]=window.hasOwnProperty(e)?window[e]:!1)
}),o()}function i(){o("TEST_AND_TARGET_ERROR")}function n(){o("TIMEOUT_EXCEEDED")}function o(e){for(clearTimeout(p),h=!0;func=u.pop();)"function"==typeof func&&func()}function s(e,s){return d=!0,c=e,"object"!=typeof adobe?void o("ADOBE_NOT_LOADED"):(adobe.target.getOffer({mbox:"target-global-mbox",params:{pageName:"/photos-test-and-target",pageType:"sflyphotos",siteSection:"photosapp"},success:t,error:i,timeout:2500}),window._recipe=function(e){clearTimeout(p),e=(""+e).toLowerCase(),/^[a-z]$/.test(e)||(e="a"),window.USE_UPP="b"==e.toLowerCase()},void(s&&s>0&&(p=setTimeout(n,s))))}function r(t,i,n){"undefined"==typeof n&&(n=!1),e()[t]=i,n&&$.cookies.set("photos-features",JSON.stringify(a))}function l(t,i){var n=function(){i(e()[t]||!1)};d&&!h?u.push(n):n()}var a={},u=[],c=!1,d=!1,h=!1,p=null,f={upp:!0};return{getFeatures:e,startTestAndTarget:s,setFeature:r,whenReady:l}}),ThisLife.Helper=ThisLife.Helper||{},ThisLife.Helper.Features=require("ThisLife.Helper.Features"),function(){var e={}.hasOwnProperty;ThisLife.Helper.URL={open:function(e,t,i,n){var o,s;return null==e&&(e=null),n=n>window.screen.height?window.screen.height-100:n,s=(window.screen.width-i)/2,o=(window.screen.height-n)/2-20,window.open(t,e,"resizable=0,scrollbars=1,status=1,width="+i+",height="+n+",left="+s+",top="+o)},redirect:function(e){return window.location.href=e||this.getRedirectUrl()},getRedirectUrl:function(){var e,t;return e=Backbone.history.fragment,t="",e.match(/logout|library$|^\/$|^$/)||(t="?redirect_url="+ThisLife.Settings.app+"/"+e),ThisLife.Settings.www+"/login"+t},formatUrl:function(e,t){var i,n;return i=0===e.indexOf("/")?e.substring(1):e,n=-1!==i.indexOf("?")?"":"?",t&&_.each(t,function(e,t){return n+=t+"="+e+"&"}),i+n},getDownloadUrl:function(t,i,n){var o,s;null==n&&(n={}),s=ThisLife.Settings.downloadUrl,s+="?accessToken="+i+"&momentId="+t;for(o in n)e.call(n,o)&&(s+="&"+o+"="+n[o]);return s},downloadViaIframe:function(e){var t;return e=e.replace(/^http(s)?:/,""),t=document.getElementById("downloadIframe"),null!=t&&t.parentNode.removeChild(t),t=document.createElement("IFRAME"),t.id="downloadIframe",document.body.appendChild(t),t.style.display="none",t.setAttribute("src",e)},parseQueryString:function(e){var t,i;return i=e.replace(/^\?/,"").split("&"),t={},_.each(i,function(e){var i;return i=e.split("="),t[i[0]]=i.length>1?decodeURIComponent(i[1]):""}),t}}}.call(this),function(){define("ThisLife.Helper.Scripts",[],function(){var e;return e={loadGoogleMaps:function(e,t){var i;return i=_.bind(e,t),window.google&&window.google.maps?i():($.getScript("//maps.googleapis.com/maps/api/js?sensor=false&key="+ThisLife.Settings.googleMapsApi+"&callback=ThisLife.View.googleMapsCallback"),ThisLife.View.googleMapsCallback=function(){return delete ThisLife.View.googleMapsCallback,i()})},loadFaceBookSDK:function(){return window.fbAsyncInit=function(){return FB.init({appId:ThisLife.Settings.facebookAppId,autoLogAppEvents:!0,xfbml:!0,version:"v3.0"})},function(e,t,i){var n,o;return o=void 0,n=e.getElementsByTagName(t)[0],e.getElementById(i)?void 0:(o=e.createElement(t),o.id=i,o.src="https://connect.facebook.net/en_US/sdk.js",n.parentNode.insertBefore(o,n))}(document,"script","facebook-jssdk")},postpone:function(e,t){var i,n,o;return i=3<=arguments.length?Array.prototype.slice.call(arguments,2):null,n=new Date,o=function(){var s,r,l;return i||(i=1<=arguments.length?Array.prototype.slice.call(arguments,0):[]),l=new Date,r=l-n,t>r?(s=_.flatten([o,t-r,i],!0),_.delay.apply(null,s)):e.apply(null,i)}}}}),ThisLife.Helper.Scripts=require("ThisLife.Helper.Scripts")}.call(this),function(){ThisLife.Helper.Error={errorHelper:function(e){var t;if(503===e.status)return ThisLife.Router.api.getServerStatus(function(e){return"ok"!==e.status?window.location=ThisLife.Settings.app+"/maintenance":void 0});if(0!==e.status)return t=new ThisLife.View.ModalAlert({template:"apiErrorTemplate",item:"apiError"}),$(document.body).append(t.render().el)}},define("ThisLife.Helper.Error",[],function(){return ThisLife.Helper.Error})}.call(this),function(){ThisLife.Helper.Stories={getStoryInfoFromJSON:function(e){var t,i,n,o,s,r,l,a;return s=t="",r=e.permission||e,l=r.get("story"),s=l.name||"",n=r.get("owner_person_uid")===ThisLife.Model.User.id,o=ThisLife.Model.masterStory.isMine(r.id)||n,i=l.moment_count>0,o||(a=r.get("name"),t="by "+a),[s,t,i]},getStoryNameFromStoryUid:function(e){var t,i,n,o;return n=ThisLife.Model.masterStory.getPermissionByStoryId(e),o=this.getStoryInfoFromJSON(n),i=o[0],t=o[1],t?i+" "+t:i},getStoryCoverFromStoryUid:function(e,t){var i,n,o,s,r;return null==t&&(t="x-small"),n=ThisLife.Model.masterStory.getPermissionByStoryId(e),o=n.get("story"),r=o.cover_moment_uid,i=o.cover_owner_uid,s=o.cover_effects_modified_date,r&&i?ThisLife.Helper.Image.imgUrl(r,t,s,i):""},inviteAcceptedNotification:function(e,t){var i,n,o;return o=this.getStoryInfoFromJSON(e),n=o[0],i=o[1],n=ThisLife.Helper.String.escapeHtml(n),i&&(i=" "+i),ThisLife.notification(t+" is now following "+n+i,5e3,null,!0)},newStoryInviteNotification:function(e){var t,i,n;return n=this.getStoryInfoFromJSON(e),i=n[0],t=n[1],i=ThisLife.Helper.String.escapeHtml(i),t&&(t=" "+t),ThisLife.notification("You were invited to follow "+i+t,5e3,null,!0)},permissionsUpdatedNotification:function(e){var t,i,n,o;return n=this.getStoryInfoFromJSON(e),i=n[0],t=n[1],i=ThisLife.Helper.String.escapeHtml(i),t&&(t=" "+t),o=e.get("view_only")?"You are now a viewer on "+i+t:"You may now contribute to "+i+t,ThisLife.notification(o,5e3,null,!0)}}}.call(this),function(){var e,t,i;e=3e3,t=5e3,i=function(){function i(e,t){this.MainPusher=e,this.channelName=t,this.messageId=0,this.queueCount=0,this.queue={},this.init()}return i.prototype.init=function(){return this.MainPusher.pusher.connection.bind("state_change",this.getConnectionCallback()),this},i.prototype.getListener=function(){return _.bind(this.listener,this)},i.prototype.getConnectionCallback=function(){return _.bind(this.connectionCallback,this)},i.prototype.resetMessageId=function(){return this.messageId=0,this},i.prototype.isNextMessage=function(e){return e<=this.messageId+1},i.prototype.setMessageId=function(e){return e>this.messageId&&(this.messageId=e),this},i.prototype.processMessageData=function(e,t){var i;return this.MainPusher.processMessage(e,t),null!=(i=ThisLife.log)&&i.debug(t.message_id,e,t),this},i.prototype.processNextMessage=function(){var e;return this.queueCount&&(e=this.queue[this.messageId+1],e?(this.queueCount--,delete this.queue[this.messageId+1],this.processMessage(e.event,e.data)):this.setTimeoutIfNeeded()),this},i.prototype.addToQueue=function(e,t){return this.queueCount++,this.queue[t.message_id]={event:e,data:t},this.setTimeoutIfNeeded(),this},i.prototype.setTimeoutIfNeeded=function(){return this.timeout?void 0:this.setTimeout()},i.prototype.setTimeout=function(){return this.timeout=setTimeout(function(e){return function(){var t;return null!=(t=ThisLife.log)&&t.debug("PUSHER Replay Starting from ID: "+(e.messageId+1)),e.timeout=null,e.startReplay(e.messageId+1)}}(this),t)},i.prototype.startReplay=function(e,t){var i,n;return null==t&&(t=!1),n=function(i){return function(n){return i.resolveReplay(e,t,n)}}(this),i=function(t){return function(){return t.replayError(e)}}(this),ThisLife.Service.api.getPusherMessages(this.channelName,e,n,i),ThisLife.LogSmithManager.enqueuePusherMetrics({name:["replay","start"],value:1,timestamp:(new Date).getTime(),attributes:{person_uid:ThisLife.Model.User.id,channel:this.channelName}})},i.prototype.resolveReplay=function(e,t,i){var n,o,s,r,l,a,u,c;for("string"==typeof i&&(i=JSON.parse(i)),0===i.length&&this.replayError(),n=!1,o=0,s=i.length;s>o;o++)l=i[o],r=l.data.message_id,r===e&&(n=!0),null==this.queue[r]&&r>this.messageId&&this.addToQueue(l.event,l.data);return n?(t&&null!=(u=ThisLife.log)&&u.debug("PUSHER Replay on Reconnect Complete - found "+i.length+" missing messages"),this.processQueue(),null!=(c=ThisLife.log)&&c.debug("PUSHER Replay Complete Ended on ID: "+this.messageId),ThisLife.LogSmithManager.enqueuePusherMetrics({name:["replay","success"],value:this.messageId-e+1,timestamp:(new Date).getTime(),attributes:{person_uid:ThisLife.Model.User.id,channel:this.channelName}})):t?null!=(a=ThisLife.log)?a.debug("PUSHER Replay on Reconnect Complete - no missing messages"):void 0:this.replayError(e)},i.prototype.replayError=function(e){var t;return e>this.messageId?(null!=(t=ThisLife.log)&&t.error("PUSHER Replay Failed - missing ID: "+(this.messageId+1)),ThisLife.LogSmithManager.enqueuePusherMetrics({name:["replay","error"],value:1,timestamp:(new Date).getTime(),attributes:{person_uid:ThisLife.Model.User.id,channel:this.channelName}}),this.messageId++,this.processQueue()):void 0},i.prototype.clearTimeout=function(){return this.timeout&&(clearTimeout(this.timeout),this.timeout=null),this},i.prototype.processFirstMessage=function(t,i){if(this.firstMessageTimeout){if(!(i.message_id<this.firstMessage.data.message_id))return this.addToQueue(t,i);clearTimeout(this.firstMessageTimeout),this.addToQueue(this.firstMessage.event,this.firstMessage.data)}return this.firstMessage={event:t,data:i},this.firstMessageTimeout=setTimeout(function(e){return function(){return e.firstMessageTimeout=null,e.processMessage(e.firstMessage.event,e.firstMessage.data)}}(this),e)},i.prototype.processMessage=function(e,t){return this.clearTimeout().setMessageId(t.message_id).processMessageData(e,t).processNextMessage()},i.prototype.queueMessage=function(e,t){return this.isNextMessage(t.message_id)?this.processMessage(e,t):this.messageId?this.addToQueue(e,t):this.processFirstMessage(e,t)},i.prototype.processQueue=function(e){var t;if(null!=e)for(;this.messageId<=e;)t=this.messageId+1;for(;this.queueCount&&null!=this.queue[this.messageId+1];)this.processNextMessage();return this.queueCount>0&&this.setTimeoutIfNeeded(),this},i.prototype.disconnect=function(){return this.clearTimeout().isDisconnected=!0,ThisLife.LogSmithManager.enqueuePusherMetrics({name:["disconnect"],value:1,timestamp:(new Date).getTime(),attributes:{person_uid:ThisLife.Model.User.id,channel:this.channelName}}),this},i.prototype.reconnect=function(){return this.startReplay(this.messageId+1).isDisconnected=!1,ThisLife.LogSmithManager.enqueuePusherMetrics({name:["reconnect"],value:1,timestamp:(new Date).getTime(),attributes:{person_uid:ThisLife.Model.User.id,channel:this.channelName}}),this},i.prototype.connectionCallback=function(e){switch(e.current){case"disconnected":return this.disconnect();case"connected":if(this.isDisconnected)return this.reconnect()}},i.prototype.listener=function(e,t){return ThisLife.Settings.isProdEnv()||!window.disablePushers?t&&t.message_id?this.queueMessage(e,t):this.processMessageData(e,t):void 0},i}(),ThisLife.PusherQueue=i}.call(this),function(){var e,t,i,n,o,s;o=ThisLife.Helper.Platform.mobile(),s=window.location.port,n=void 0,e=void 0,ThisLife.MainPusher=function(){function i(e,t){this.pusher=e,this.channel=t,_.bindAll(this,"duplicateMomentDeleted","momentCreated")}return i.prototype.init=function(){return e=this,s&&o?void 0:this.pusher=new Pusher(this.channel,{encrypted:!0})},i.prototype.start=function(){return this.pusher?ThisLife.app.session.getSessionToken().then(function(e){return function(t){var i,n,o,s,r;for(s=[ThisLife.Model.User.id,t,ThisLife.lifeUid],r=[],n=0,o=s.length;o>n;n++)i=s[n],r.push(e.pusher.subscribe(i).bind_all(new ThisLife.PusherQueue(e,i).getListener()));return r}}(this)):void 0},i.prototype.getEventCallback=function(e){switch(e){case"bonus_storage_added":return this.addBonusMoments;case"story_moment_created":return this.newStoryMoment;case"story_moment_deleted":return this.storyMomentDeleted;case"story_invite_accepted":return this.storyInviteAccepted;case"story_permission_deleted":return this.storyInviteDeleted;case"story_permission_updated":return this.storyPermissionUpdated;case"story_invite":return this.storyInvite;case"story_invite_updated":return this.storyInviteUpdated;case"moment_updated":return this.momentUpdated;case"groups_processed":return this.groupsProcessed;case"moment_rotated":return this.momentEdited;case"moment_deleted":return this.momentDeleted;case"moment_created":return this.momentCreated;case"duplicate_moment_deleted":return this.duplicateMomentDeleted;case"stack_deleted":return this.stackDeleted;case"person_tag_deleted":return this.personTagDeleted;case"person_tag_updated":return this.personTagUpdated;case"suggestions_ready":return this.suggestionsReady;case"video_updated":return this.videoUpdated;case"upgrade_completed":return this.upgradeCompleted;case"billing_updated":return this.billingUpdated;case"location_tag_created":return this.locationTagCreated;case"location_tag_updated":return this.locationTagUpdated;case"location_tag_deleted":return this.locationTagDeleted;case"story_moment_created":return this.newStoryMoment;case"story_moment_deleted":return this.storyMomentDeleted;case"story_invite_accepted":return this.storyInviteAccepted;case"story_permission_created":return this.storyPermissionCreated;case"story_permission_deleted":return this.storyInviteDeleted;case"story_permission_updated":return this.storyPermissionUpdated;case"story_invite":return this.storyInvite;case"story_created":return this.storyCreated;case"story_deleted":return this.storyDeleted;case"story_read":return this.storyRead;case"album_created":return this.albumCreated;case"album_updated":return this.albumUpdated;case"album_invite_updated":return this.storyPermissionUpdated;case"moment_tag_updated":return this.momentTagUpdated;case"moment_tag_deleted":return this.momentTagDeleted;case"import_job_status":return this.importJobStatus;case"multi_download_ready":return this.multiDownloadReady;case"folder_created":return this.folderCreated;case"folder_deleted":return this.folderDeleted;case"folder_updated":return this.folderUpdated;default:return this.logData}},i.prototype.processMessage=function(e,t){var i;return i=this.getEventCallback(e),i.call(this,t),this},i.prototype.storyCreated=function(e){return ThisLife.Model.masterStory.myStories.getStory(e.story.uid)?void 0:ThisLife.Model.masterStory.myStories.createStory(e.story.name,null,{showStory:!1,createByPusher:!0,story:e.story})},i.prototype.albumCreated=function(e){return ThisLife.Model.Albums.Master.handleAlbumCreate(e.story)},i.prototype.storyUpdated=function(e){var t,i;return i=e.story.uid,t={cover_moment_uid:e.story.cover_moment_uid,cover_owner_uid:e.story.cover_owner_uid,cover_moment_aoi:e.story.cover_moment_aoi,cover_effects_modified_date:e.story.cover_effects_modified_date,name:e.story.name,start_date:e.story.start_date,end_date:e.story.end_date},i===ThisLife.storyUid&&ThisLife.currentStory.set(t),ThisLife.Model.masterStory.updateStory(i),ThisLife.PubSub.trigger("story:changed_cover",t,i),ThisLife.PubSub.trigger("story:changed_name",i,t.name)},i.prototype.albumUpdated=function(e){return ThisLife.Model.Albums.Master.handleAlbumUpdate(e.story)},i.prototype.storyRead=function(e){return ThisLife.PubSub.trigger("story:changed_last_viewed",e.story.uid,e.story.last_viewed),ThisLife.Model.Albums.Master.handleAlbumUpdate(e.story)},i.prototype.storyDeleted=function(e){var t;return t=ThisLife.Model.masterStory.myStories.getStory(e.story_uid),t&&ThisLife.Model.masterStory.myStories.remove(t),t=ThisLife.Model.masterStory.otherStories.getStory(e.story_uid),t&&ThisLife.Model.masterStory.otherStories.remove(t),t=ThisLife.Model.masterStory.autoStories.getStory(e.story_uid),t&&ThisLife.Model.masterStory.autoStories.remove(t),ThisLife.Model.Albums.Master.handleAlbumDelete(e.story_uid)},i.prototype.storyPermissionUpdated=function(e){return ThisLife.Model.Albums.Master.handleInviteUpdate(e.storyPermissionDto)},i.prototype.storyInvite=function(e){var t,i;return i=e.storyInfo,t={accepted:!1,blocked:!1,"default":!1,email_shared_with:ThisLife.Model.User.get("email"),follow:!0,ignored:!1,invited_story:!0,owner_first_name:i.owner_first_name,owner_last_name:i.owner_last_name,owner_name:i.owner_first_name,person_uid:ThisLife.Model.User.id,owner_person_uid:i.owner_person_uid,story:{cover_moment_uid:i.cover_moment_uid,cover_owner_uid:i.cover_owner_uid,cover_moment_aoi:i.cover_moment_aoi,moment_count:i.moment_count,visible_moment_count:i.visible_moment_count,updated_count:0,name:i.name,path:i.path,"public":!1,uid:i.uid,folder_uid:i.folder_uid,end_date:i.end_date,start_date:i.start_date},story_uid:i.uid,tumblr_sharing:!1,twitter_sharing:!1,view_only:i.view_only,uid:i.story_permission_uid},ThisLife.PubSub.trigger("story:newInvitation",t),ThisLife.Model.Albums.Master.handleInviteCreate(t)},i.prototype.addBonusMoments=function(e){var t;return t=e.bonus_moments,ThisLife.Model.User.trigger("add:bonus_moments",t)},i.prototype.storyPermissionCreated=function(e){return ThisLife.Model.Albums.Master.handleFollowerCreate(e.storyPermissionDto)},i.prototype.storyInviteDeleted=function(e){return ThisLife.PubSub.trigger("story:deletePermission",e.storyPermissionUid),ThisLife.Model.Albums.Master.handleInviteDelete(e.storyPermissionUid)},i.prototype.storyInviteAccepted=function(e){return ThisLife.Model.Albums.Master.handleInviteAccept(e.storyPermissionDto)},i.prototype.storyInviteUpdated=function(e){var t;return t=e.storyPermissionDto,t.story_permission_uid||(t.story_permission_uid=t.uid),ThisLife.storyUid===t.story_uid?ThisLife.currentStory.updateFollower(t):void 0},i.prototype.storyMomentDeleted=function(e){var t,i,n,o,s,r;for(o=String(e.storyUid),r=[],n=e.momentUids,t=0,i=n.length;i>t;t++)s=n[t],ThisLife.app.controller("trash").hasDeleteLock(s)||r.push(s);return ThisLife.app.album.removeMoments(o,r)},i.prototype.newStoryMoment=function(e){var i,n,o,s,r,l,a;for(a=String(e.storyUid),s=[],r=e.tableItems,i=0,o=r.length;o>i;i++)n=r[i],t(n),n.moment_added_date=(new Date).toUnix(),null!=n.original_filename&&(n.filename=n.original_filename),s.push(n);return null!=(l=ThisLife.Model.Albums.Master.getAlbumById(a))&&l.addPendingUploads(_.pluck(s,"uid")),ThisLife.app.album.addMoments(a,s)},i.prototype.locationTagCreated=function(e){var t;return t=e.locationTag,ThisLife.Service.api.getLocationTags(!0)},i.prototype.locationTagUpdated=function(e){var t,i,n,o,s;for(o=e.location_tags,s=[],t=0,i=o.length;i>t;t++)n=o[t],s.push(ThisLife.Collection.locationTags.update(n));return s},i.prototype.locationTagDeleted=function(e){var t,i,n,o,s;for(n=e.location_tag_uids,o=[],t=0,i=n.length;i>t;t++)s=n[t],o.push(ThisLife.Collection.locationTags.remove(s));return o},i.prototype.momentEdited=function(e){var t,i,n;return i=e.tableItem,n=i.uid,e.storyUid?(t=String(e.storyUid),ThisLife.app.album.momentEdited(t,n,i),ThisLife.app.controller("timeline").momentEdited(n,i)):ThisLife.app.controller("timeline").momentEdited(n,i)},i.prototype.upgradeCompleted=function(){return ThisLife.Service.api.getSubscriptionInfo()},i.prototype.billingUpdated=function(){return ThisLife.Service.api.getSubscriptionInfo()},i.prototype.videoUpdated=function(t){var i,n,o,s,r;return n=t.tableItem,i=n.height,r=n.width,s=parseInt(t.videoStatus,10),ThisLife.MediaPlayerHelper.isVideoSmall(s)&&(o=ThisLife.Collection.moments.get(n.uid),o||(o=e.momentCreated({tableItem:n},{createVideo:!0}),o.needDuration=!0)),o=ThisLife.Collection.moments.get(n.uid),o&&(ThisLife.Collection.moments.setModel(n.uid,n),o.needDuration&&n.duration)?(ThisLife.Model.User.trigger("add:video",n.duration),delete o.needDuration):void 0},i.prototype.personTagDeleted=function(e){var t,i,n,o,s,r;for(t=ThisLife.Collection.personTags,o=e.person_tag_uids,s=[],i=0,n=o.length;n>i;i++)r=o[i],s.push(t.remove(r));return s},i.prototype.stackDeleted=function(e){return ThisLife.Collection.moments.remove(e.stack_uid)},i.prototype.personTagUpdated=function(e){var t,i,n,o,s,r;for(t=ThisLife.Collection.personTags,s=e.person_tags,r=[],i=0,n=s.length;n>i;i++)o=s[i],r.push(t.updateOrAdd(o));return r},i.prototype.duplicateMomentDeleted=function(e){return this.momentDeleted(e)},i.prototype.suggestionsReady=function(e){return ThisLife.Model.suggestedGroupCount.update(e.count)},i.prototype.momentDeleted=function(e){var t,i,n;return n=e.moment_uid||e,i=null!=e?e.original_moment_id:void 0,t=ThisLife.Collection.moments.get(n),t?ThisLife.Collection.moments.deleteMoment(t):(ThisLife.Collection.moments.remove(n),ThisLife.app.album.deleteMoments([n]),ThisLife.uploader.updateSavedMomentCount(n,i))},i.prototype.logData=function(e){var t;return _.isEmpty(e)?void 0:null!=(t=ThisLife.log)?t.debug(JSON.stringify(e)):void 0},i.prototype.momentCreated=function(e,i){var n,o,s;return s=e.tableItem,n="image"===s.moment_type,t(s),_.include(s.source,"html5app")&&(s.hasOwnProperty("moment_date")&&(s.moment_date*=1e3),s.hasOwnProperty("upload_date")&&(s.upload_date*=1e3)),(n||i&&i.createVideo)&&(ThisLife.Collection.moments.get(s.uid)?ThisLife.log.debug("this moment already exists"):(o=ThisLife.Collection.moments.addMoment(s),ThisLife.Model.User.updateMomentCount(o,!0))),i&&i.createVideo&&ThisLife.uploader.updateSavedMomentCount(o),o},i.prototype.groupsProcessed=function(e){return e.num_suggested?ThisLife.Service.api.getSuggestedFaceGroups():void 0},i.prototype.momentUpdated=function(e){var i;return i=e.tableItem,t(i),ThisLife.app.controller("trash").hasDeleteLock(i.uid)&&delete i.hidden,ThisLife.app.album.momentEdited(null,i.uid,i),ThisLife.app.controller("timeline").momentEdited(i.uid,i),ThisLife.Collection.moments.setModel(i.uid,i)},i.prototype.momentTagUpdated=function(e){return ThisLife.Collection.momentTags.update(e.moment_tags)},i.prototype.momentTagDeleted=function(e){return ThisLife.Collection.momentTags.remove(e.moment_tag_uids)},i.prototype.importJobStatus=function(e){var t;return t=e.job,"shutterfly"===t.source&&ThisLife.PubSub.trigger("import_job",t.status,t),"complete"===e.job.status.toLowerCase()?ThisLife.PubSub.trigger("importComplete"):void 0},i.prototype.multiDownloadReady=function(e){var t;return t=e.job_id,ThisLife.notification('Your download is ready. <a href="'+ThisLife.Settings.www+"/moment_download/"+t+'" target="_blank">View Here</a>.',1e4)},i.prototype.folderCreated=function(e){return ThisLife.Model.Albums.Master.handleFolderCreate(e.folder)},i.prototype.folderDeleted=function(e){return ThisLife.Model.Albums.Master.handleFolderDelete(e.folder_uid)},i.prototype.folderUpdated=function(e){return ThisLife.Model.Albums.Master.handleFolderUpdate(e.folder)},i}(),i=function(e){return e.width||(e.width=640),e.height||(e.height=480)},t=function(e){var t,n;if(n=e.moment_type,t=e.moment_date,n&&t){if("video"===n&&(i(e),e.enhanced=!1),!e.height||!n)throw"Moment has no height/width or moment_type";return e.upload_date=e.created}}}.call(this),function(){define("ThisLife.Helper.Keyboard",[],function(){var e;return e={isTab:function(e){return 9===e},isEnter:function(e){return 13===e},isEscape:function(e){return 27===e},isSpace:function(e){return 32===e},isLeft:function(e){return 37===e},isRight:function(e){return 39===e},isUp:function(e){return 38===e},isDown:function(e){return 40===e},isSemicolon:function(e){return 186===e||59===e},isComma:function(e){return 188===e},keyPressIgnore:function(e){return 8===e||9===e||33===e||34===e||35===e||36===e||37===e||38===e||39===e||40===e||46===e}}}),ThisLife.Helper.Keyboard=require("ThisLife.Helper.Keyboard")}.call(this),function(){ThisLife.Helper.Mouse={getMouseScrollWheelDirection:function(e){var t;return t=ThisLife.Helper.Platform.macOSX()?ThisLife.Helper.Platform.firefox()&&e?-1:1:ThisLife.Helper.Platform.firefox()?-1:1},normalizeWheelDelta:function(e,t){return ThisLife.Helper.Platform.macOSX()||(e*=t),e}}}.call(this),function(){ThisLife.Helper.Notifications={topOverlayNotification:function(e,t,i){var n;return null==i&&(i=5e3),$(".tl_modal_notification").remove(),n=$('<div class="tl_modal_notification">\n  <img src="/assets/1px.gif" class="info_icon">'+t+'<a class="circle-x-btn"><img src="/assets/1px.gif"></a>\n</div>'),e.prepend(n),n.click(function(){return n.remove()}),i?setTimeout(function(){return n.is(":hover")?n.on("mouseleave",function(){return n.remove()}):n.remove()},i):void 0}}}.call(this),function(){ThisLife.Helper.Validate={email:function(e){return e.match(/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/)},phone:function(e){return e.match(/^[\d.\-\(\\ )]+$/)}}}.call(this),function(){ThisLife.Support.KeyInformant=function(){function e(){this._pubSub=new ThisLife.Support.PubSub,this._callbacks={},_.bindAll(this,"_keyListener"),this._bindListener()}return e.prototype.on=function(e,t,i,n){var o;return assert(t,"callback must exist"),this._exists(e,t,i)?this:((o=this._callbacks)[e]||(o[e]=[]),this._callbacks[e].push({callback:t,scope:i,maintain:n}),this)},e.prototype.off=function(e,t,i){var n,o,s,r,l,a,u,c,d;if(n=this._callbacks[e]){if(!t&&!i)return n.length=0,this;for(c=0,d=n.slice(),a=l=0,u=d.length;u>l;a=++l){if(r=d[a],o=r.callback,s=r.scope,t&&t===o&&(i&&s===i||!i)){n.splice(a,1);break}i&&i===s&&!t&&(n.splice(a-c,1),c+=1)}}return this},e.prototype.onAny=function(e,t,i){return this._pubSub.on(e,t,i),this},e.prototype.offAny=function(e,t,i){return this._pubSub.off(e,t,i),this},e.prototype.setupForCurrentView=function(){return ThisLife.Helper.Platform.ie()?window.focus():void 0},e.prototype._bindListener=function(){return window.addEventListener("keydown",this._keyListener,!1)},e.prototype._unbindListener=function(){return window.removeEventListener("keydown",this._keyListener,!1)},e.prototype._keyListener=function(e){var t,i;if((!document.activeElement||"INPUT"!==(i=document.activeElement.nodeName)&&"TEXTAREA"!==i||ThisLife.Helper.Keyboard.isEscape(e.keyCode))&&!(document.activeElement&&document.activeElement.hasAttribute("contentEditable")&&!ThisLife.Helper.Keyboard.isEscape(e.keyCode)||e.defaultPrevented||ThisLife.Helper.Platform.ie()&&e.returnValue===!1))return t=e.keyCode,ThisLife.Helper.Keyboard.isEscape(t)?(this._pubSub.trigger("cancel",e),this._trigger("cancel",e),e.preventDefault()):ThisLife.Helper.Keyboard.isLeft(t)?(this._pubSub.trigger("left",e),this._trigger("left",e)):ThisLife.Helper.Keyboard.isRight(t)?(this._pubSub.trigger("right",e),this._trigger("right",e)):ThisLife.Helper.Keyboard.isUp(t)?this._pubSub.trigger("up",e):ThisLife.Helper.Keyboard.isDown(t)?this._pubSub.trigger("down",e):ThisLife.Helper.Keyboard.isEnter(t)?this._trigger("enter",e):void 0},e.prototype._trigger=function(e,t){var i,n;return i=this._callbacks[e],i&&i.length&&(n=i[i.length-1],n.maintain||(i.length=i.length-1),n.callback.call(n.scope,t)),this},e.prototype._exists=function(e,t,i){var n,o,s,r,l,a;if(n=this._callbacks[e])for(l=0,a=n.length;a>l;l++)if(r=n[l],o=r.callback,s=r.scope,t&&t===o&&i&&s===i)return!0;return!1},e}()}.call(this),function(){ThisLife.blurEvent=function(e,t,i){var n;return null==i&&(i=!1),n=function(i){var o;return o=$(i.target),_.include(o.parents(),e[0])||_.include(e,o.get(0))||o.closest(e).length>0?void 0:($(document.body).off("click",n),t?t(e):e.remove())},_.defer(function(){return $(document.body).on("click",n),i?void 0:$(document.body).on("touchstart",n)}),n},ThisLife.removeBlurEvent=function(e,t){return null==t&&(t=!1),e&&($(document.body).off("click",e),!t)?$(document.body).off("touchstart",e):void 0},define("ThisLife.blurEvent",[],function(){return ThisLife.blurEvent}),define("ThisLife.removeBlurEvent",[],function(){return ThisLife.removeBlurEvent})}.call(this),function(){ThisLife.Helper.LocalStorage={setObject:function(e,t){return ThisLife.Support.GlobalErrorHandler.protectedInvoke(function(i){return function(){var n;try{localStorage.setItem(e,JSON.stringify(t))}catch(o){n=o,ThisLife.log.error("Local Storage is not available")}return i._cached[e]=t}}(this))},getObject:function(e){var t,i,n;if(n=this._cached[e],null!=n)return n;try{i=localStorage.getItem(e),n=i&&JSON.parse(i),this._cached[e]=n}catch(o){return t=o,ThisLife.log.error("Local Storage is not available"),null}return n},clear:function(){var e;try{return localStorage.clear()}catch(t){return e=t,ThisLife.log.error("Local Storage is not available")}}},ThisLife.Helper.LocalStorage._cached={}}.call(this),function(){ThisLife.ProductsLogic=_.extend({getCollectionForHomepage:function(e){return this.getRecentMomentsCollection(e)},getRecentMomentsCollection:function(e){return ThisLife.Service.api.getRecentMoments(25,function(t){return function(i){return ThisLife.Collection.moments.whenLoaded(function(){var n;return null!=i&&i.length>0?(n=t._createCollectionFromRecent(i),"function"==typeof e?e(n):void 0):"function"==typeof e?e(void 0):void 0})}}(this))},secondsToDays:function(e){return e/86400},createCollection:function(e){var t;return t=new Backbone.Collection,e.moments.forEach(function(){return function(e){return t.push(new ThisLife.Model.StoryMoment(e))}}(this)),t},formatCollection:function(e,t,i){var n;return null==i&&(i=!1),n=[],_.each(e.models,function(e){var o;return i&&(e=new ThisLife.Model.Moment(e)),o=e.get("story_moment_created_by")||t,n.push({id:e.id,comboId:o+":"+e.id,url:e.getImageSize("medium"),origWidth:e.get("width"),origHeight:e.get("height"),dateTaken:e.get("moment_date")})}),n},shouldRedirectToLibrary:function(){return"people"===Backbone.history.fragment?0===ThisLife.Collection.personTags.length:"albums"===Backbone.history.fragment?0===ThisLife.Model.Albums.Master.getAllAlbums().length:"add"===Backbone.history.fragment?!0:!1},getOwnerUid:function(){var e,t;return e=ThisLife.Model.User.getLifePermission(),t=e.person_uid!==e.owner_person_uid?e.owner_person_uid:e.person_uid},hashMoments:function(e){var t;return"undefined"===e||"undefined"==typeof e||null===e?this._randomString(5):(t=_.pluck(e.models,"id").sort().join(""),this._nonSecureHash(t))},_nonSecureHash:function(e){var t,i,n,o,s;if(i=0,0===e.length)return i;for(t=function(t){var n;return n=e.charCodeAt(t),i=(i<<5)-i+n,i|=0},n=o=0,s=e.length;s>=0?s>o:o>s;n=s>=0?++o:--o)t(n);return i},_randomString:function(e){var t,i,n,o,s;for(i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t=[],n=o=0,s=e;s>=0?s>o:o>s;n=s>=0?++o:--o)t.push(i.charAt(Math.floor(Math.random()*i.length)));return t.join("")},_createCollectionFromRecent:function(e){var t;return t=new Backbone.Collection,e.forEach(function(e){return t.add(new ThisLife.Model.Moment(e))}),t}})}.call(this),function(){var e,t,i,n,o,s,r,l;ThisLife.MediaPlayerHelper=_.extend({init:function(){},largestVideoSizeAvailable:function(n){return 270>=n?i:480>=n?t:e},isVideoProcessing:function(e,t){var n;return t?(n=this.largestVideoSizeAvailable(e),n===i?!((t&l)>0):!((t&o)>0)):!1},isVideoReady:function(e){return void 0===e?!0:(e&l)>0},isVideoSmall:function(e){return(e&l)>0},videoUrlDim:function(e,t,i,s,r,l,a,u){var c,d,h,p;return c=0!==u?(u&n)>0?"large":(u&o)>0?"medium":"small":270>=i?"small":480>=i?"medium":"large",a&&(c="large"===c?"medium":"small"),d=this.largestVideoSizeAvailable(s),"large"===c&&d===!1?c="medium":"medium"===c&&"small"===d&&(c="small"),h=r?"#t="+r+",":"",p="rtmp"===l?ThisLife.Settings.videoUrl+"/cfx/st/mp4:"+t+"/"+e+"_"+c+".mp4"+h:ThisLife.Settings.s3VideoUrl+"/"+t+"/"+e+"_"+c+".mp4"+h},videoSizeByQuality:function(e,n,o){var s,r;return s={width:0,height:0},r=e===i?270:e===t?480:1080,s.height=r>o?o:o>r?o:r,s.width=n*(s.height/o),s},videoUrlQuality:function(e,t,i,n,o){var s,r,l,a;return s=i,l=n?"#t="+n+",":"",r=".mp4",a="rtmp"===o?ThisLife.Settings.videoUrl+"/cfx/st/mp4:"+t+"/"+e+"_"+s+".mp4"+l:ThisLife.Settings.s3VideoUrl+"/"+t+"/"+e+"_"+s+".mp4"+l}}),r=0,l=1,o=2,n=4,s=128,i="small",t="medium",ThisLife.MediaPlayerHelper.VIDEO_LARGE=e="large"}.call(this),function(){ThisLife.Helper.Image=_.extend({imgUrl:function(e,t,i,n){var o,s;return i||(null!=(o=ThisLife.log)&&o.warn("Image request "+e+" missing effects_modified_date"),i=Date.now()),n||(null!=(s=ThisLife.log)&&s.warn("Image request "+e+" missing owner uid"),n=ThisLife.currentLifeOwner),null!=i&&(i+="/"),ThisLife.Settings.iaImageUrl+("/ng/services/mediarender/THISLIFE/"+n+"/media/"+e+"/"+t+"/"+i+"enhance")},imageSize:function(e,t){var i;return i=t/e,100>=e&&4e3>100*i||315*i>4e3?"x-small":315>=e&&4e3>315*i||720*i>4e3?"small":720>=e&&4e3>720*i||1600*i>4e3?"medium":1600>=e&&4e3>1600*i||2048*i>4e3?"large":"x-large"},imageUrlDim:function(e,t,i,n){var o,s,r,l,a;return o=t.height||t,a=t.width||o,r=Math.min(o,a),s=Math.max(o,a),l=this.imageSize(r,s),this.imgUrl(e,l,i,n)},uncroppedImageUrl:function(e){return e+"/crop=0,0,1,1"},uncroppedImageUrlDim:function(e,t,i,n){return this.uncroppedImageUrl(this.imageUrlDim(e,t,i,n))},faceUrl:function(e){return ThisLife.Settings.faceUrl+("/"+ThisLife.lifeUid+"/image/"+e+".jpg")},getOrientation:function(e,t){return e>t?"landscape":t>e?"portrait":"square"},backgrounPositionForAreaOfInterest:function(e,t,i,n,o){var s,r,l,a,u,c,d,h,p;return c=t/i,l=n/o,c>=l?(p=o/i,s=t*((e[2]+e[3])/2),a=t*p-n,d=Math.max(0,Math.min(a,s*p-n/2)),-d+"px center"):(p=n/t,r=i*((e[0]+e[1])/2),u=i*p-o,h=Math.max(0,Math.min(u,r*p-o/2)),"center "+-h+"px")
},preloadImage:function(e,t,i){var n;return n=new Image,n.onload=function(){return function(){return"function"==typeof t?t(n.width,n.height):void 0}}(this),n.onerror=function(){return function(){return"function"==typeof i?i():void 0}}(this),n.src=e}})}.call(this),function(){ThisLife.Support.SocialImportToken=function(){function e(){var e;e=document.getElementById("ThisLifeWeb"),e.setImportToken=_.bind(this._setImportToken,this),this.bindEvents()}return e.prototype.bindEvents=function(){return window.addEventListener("message",function(e){return function(t){return e.handleCompleteConnect(t)}}(this),!1),window.registerDomainForPostMessage=function(e){var t;return null!=e&&null!=(t=e.contentWindow)?t.postMessage("initialize","*"):void 0}},e.prototype.getServiceIframe=function(e){var t,i,n,o;return i=ThisLife.services[e].connect,n={connect_url:ThisLife.Settings.socialUrl+(i.extendedPermissionsUrl||i.url),popup_width:i.options.width,popup_height:i.options.height},o=ThisLife.Settings.socialUrl+"/thislife/connector?"+$.param(n),t=$('<iframe onload="registerDomainForPostMessage(this)" src='+o+'" frameborder="0" scrolling="no"></iframe>')},e.prototype.handleCompleteConnect=function(e){var t;return t=new RegExp("social."+ThisLife.Settings.apiSubDomain),t.test(e.origin)&&"newSocialToken"===e.data.type?this._setImportToken(e.data.token):void 0},e.prototype.importToken=function(e){return this._setImportToken(e)},e.prototype._setImportToken=function(e){var t,i,n,o,s,r,l;switch(r=ThisLife,t=e.split("'"),l=t[1],s=t[3],n=r.Model.User,s){case"thislife":n.set({thislife_access_token:l});break;case"flickr":n.set({flickr_access_token:l});break;case"instagram":i=l.split(".")[0],o={instagram_access_token:l,instagram_auto_import:!0,instagram_id:i},ThisLife.Service.api.updatePerson(o),n.set(o),n.trigger("change:instagram_auto_import",n,!0);break;case"picasa":n.set({picasa_access_token:l});break;case"shutterfly":n.set({shutterfly_access_token:l});break;case"smugmug":n.set({smugmug_access_token:l});break;case"facebook":this._getFacebookUserInfo(l);break;case"twitter":o={twitter_access_token:l,twitter_auto_import:!0},n.set(o),n.trigger("change:twitter_auto_import",n,!0);break;case"youtube":n.set({youtube_access_token:l});break;case"tumblr":n.set({tumblr_access_token:l})}return"facebook"!==s?r.PubSub.trigger("connectService:"+s,s,e):void 0},e.prototype._getFacebookUserInfo=function(e){var t,i;return i=ThisLife.Settings.fbUrl+("/me?access_token="+e+"&callback=?"),t=function(){return function(t){var i,n,o,s,r,l;return l=ThisLife,r=l.Model.User,i=t.id,o=t.name,n=ThisLife.Settings.fbUrl+("/"+i+"/picture"),s={facebook_access_token:e,facebook_avatar_url:n,facebook_id:i,facebook_name:o,facebook_auto_import:!0},r.get("first_name")||(s.first_name=t.first_name),r.get("last_name")||(s.last_name=t.last_name),r.set(s),r.trigger("change:facebook_auto_import",r,!0),delete l.Collection.contacts,ThisLife.Service.api.updatePerson(s),l.PubSub.trigger("connectService:facebook","facebook",t)}}(this),$.getJSON(i,t)},e}()}.call(this),function(){ThisLife.Helper.setupServices=function(e){var t,i,n,o;if(!ThisLife.services)return i=ThisLife.Model.User,i.get("life_permissions")?(n=e,t=ThisLife.lifeUid,o=i.get("uid"),ThisLife.services={thislife:{connect:{url:"/go_social/thislife",name:"thislifeConnect",options:{width:364,height:267}},importLifeUrl:function(e,i){return"/thislife/import_life?session_token="+n+"&life_uid="+t+"&old_life_session_token="+e+"&old_life_uid="+i+"&jsoncallback=?"}},facebook:{connect:{url:"/go_social/facebook?session_token="+n+"&basic_scope=true",extendedPermissionsUrl:"/go_social/facebook?session_token="+n,name:"facebookConnect",options:{width:640,height:364}},disconnect:{url:"/facebook/disconnect?session_token="+n+"&jsoncallback=?",setObject:{facebook_access_token:"",facebook_auto_import:!1,facebook_avatar_url:null,facebook_id:null,facebook_name:null},name:"Facebook"},exportFacebookFriendsWall:function(e,i,o,s,r,l){return"/facebook/export_to_friends_wall?session_token="+n+"&access_token="+e+"&life_uid="+t+"&photos[]="+i+"&friend_ids[]="+o+"&wall_message="+s+"&shared_moment_group_uid="+r+"&tl_gallery_url="+l+"&jsoncallback=?"},exportFacebookWall:function(e,i,o,s,r){return"/facebook/export_to_wall?session_token="+n+"&access_token="+e+"&life_uid="+t+"&photos[]="+i+"&wall_message="+o+"&shared_moment_group_uid="+s+"&tl_gallery_url="+r+"&jsoncallback=?"}},flickr:{connect:{url:"/go_social/flickr?session_token="+n,name:"flickrConnect",options:{width:875,height:650}},disconnect:{url:"/flickr/disconnect?session_token="+n+"&jsoncallback=?",setObject:{flickr_access_token:""},name:"Flickr"}},twitter:{connect:{url:"/go_social/twitter?session_token="+n+"&life_uid="+t,name:"twitterConnect",options:{width:700,height:650}},disconnect:{url:function(){var e;return e=i.get("life_permissions")[0].life.twitter_handle,"/twitter/disconnect?session_token="+n+"&life_uid="+t+"&twitter_handle="+e+"&jsoncallback=?"},setObject:{twitter_access_token:"",twitter_auto_import:!1},name:"Twitter"},tweet:function(e,o){var s;return s=i.get("life_permissions")[0].life.twitter_handle,"/twitter/tweet?session_toke="+n+"&life_uid="+t+"&access_token="+e+"&id="+o+"&twitter_handle="+s+"&jsoncallback=?"}},smugmug:{connect:{url:"/go_social/smugmug?session_token="+n,name:"smugmugConnect",options:{width:965,height:650}},disconnect:{url:"/smugmug/disconnect?session_token="+n+"&jsoncallback=?",setObject:{smugmug_access_token:""},name:"SmugMug"}},picasa:{connect:{url:"/go_social/google?session_token="+n,name:"picasaConnect",options:{width:868,height:490}},disconnect:{url:"/google/disconnect?session_token="+n+"&jsoncallback=?",setObject:{picasa_access_token:""},name:"Picasa"}},shutterfly:{connect:{url:"/go_social/shutterfly?session_token="+n,name:"shutterflyConnect",options:{width:1010,height:884}},disconnect:{url:"/shutterfly/disconnect?session_token="+n+"&jsoncallback=?",setObject:{shutterfly_access_token:""},name:"Shutterfly"}},instagram:{connect:{url:"/go_social/instagram?session_token="+n+"&life_uid="+t+"&person_uid="+o,name:"instagramConnect",options:{width:660,height:360}},disconnect:{url:"/instagram/disconnect?session_token="+n+"&jsoncallback=?",setObject:{instagram_access_token:"",instagram_auto_import:!1,instagram_id:""},name:"Instagram"}},tumblr:{connect:{url:"/go_social/tumblr?session_token="+n+"&life_uid="+t+"&person_uid="+o,name:"tumblrConnect",options:{width:900,height:580}},disconnect:{url:"/tumblr/disconnect?session_token="+n+"&jsoncallback=?",setObject:{tumblr_access_token:""},name:"Tumblr"},exportTumblrFeed:function(e,t,i,o,s){return"/tumblr/export_to_blog?session_token="+n+"&access_token="+e+"&photos[]="+t+"&shared_moment_group_uid="+i+"&tl_gallery_url="+o+"&caption="+s+"&jsoncallback=?"}}}):ThisLife.services}}.call(this),function(){var e;e=function(e){var t,i;for(t in e)i=e[t],this[t]=i;return this.verifyData()},e.prototype.face={},e.prototype._explicitType="PersonTagging",e.prototype.guid=function(){return $.Guid.New().toLowerCase()},e.prototype.verifyData=function(){var e;if(e=this.moment_uid&&this.person_tag_uid,this.uid||(this.uid=this.guid()),!e)throw Error("Missing PersonTagging data")},ThisLife.Helper.PersonTagging=e}.call(this),function(){var e;e=function(e){var t,i;for(t in e)i=e[t],this[t]=i;return this.verifyData()},e.prototype.face={},e.prototype._explicitType="MomentTagging",e.prototype.guid=function(){return $.Guid.New().toLowerCase()},e.prototype.verifyData=function(){var e;if(e=this.moment_uid&&this.moment_tag_uid,this.uid||(this.uid=this.guid()),!e)throw Error("Missing MomentTagging data")},ThisLife.Helper.MomentTagging=e}.call(this),function(){var e;e=function(e){var t,i;for(t in e)i=e[t],this[t]=i;return this.verifyData()},e.prototype.face={},e.prototype._explicitType="LocationTagging",e.prototype.guid=function(){return $.Guid.New().toLowerCase()},e.prototype.verifyData=function(){var e;if(e=this.moment_uid&&this.location_tag_uid,this.uid||(this.uid=this.guid()),!e)throw Error("Missing LocationTagging data")},ThisLife.Helper.LocationTagging=e}.call(this),function(){var e,t;t=480,e=350,ThisLife.FullViewHelper=_.extend({init:function(){},imageDimensions:function(i,n){var o,s,r,l,a,u,c;return o=i/n,u=document.body.clientWidth,a=document.body.clientHeight,i>u&&(i=u,n=i/o),n>a&&(n=a,i=n*o),c=Math.min(a/2-e/2,a/2-n/2),r=t>i?(t-i)/2:0,l=e>n?(e-n)/2:0,s={width:i,height:n,yOffset:c,imageX:r,imageY:l}},videoDimensions:function(i){var n,o;return o=i.width,n=i.height,o>=n?t>o&&(i=ThisLife.FullViewHelper.imageDimensions(t,n*(t/o))):e>n&&(i=ThisLife.FullViewHelper.imageDimensions(o*(e/n),e)),i},isVideoSmallerThanAnyMinimum:function(i,n){return e>n||t>i?!0:!1}})}.call(this),function(){ThisLife.Helper.BarSections=_.extend({section:function(e){var t;return t=this.getStateMapping(e),t?t.section:null},subSection:function(e){var t;return t=this.getStateMapping(e),t?t.subSection:null},leftBtns:function(e){var t;return t=this.getStateMapping(e),t?t.leftBtns:null},showFilter:function(e){var t;return t=this.getStateMapping(e),t?t.showFilter:!1},showAlbumBtns:function(e){var t;return"albums"===e.name&&"album"===(null!=(t=e.options)?t.view:void 0)},showAlbumUploadBtns:function(e){var t;return"albums"===e.name&&"upload"===(null!=(t=e.options)?t.view:void 0)},showAlbumCreateBtns:function(e){var t;return"albums"===e.name&&"album"===(null!=(t=e.options)?t.view:void 0)},showAlbumsBtns:function(e){var t,i;return"albums"===e.name&&"album"!==(null!=(t=e.options)?t.view:void 0)&&"upload"!==(null!=(i=e.options)?i.view:void 0)},showPeopleBtns:function(e){return"people"===e.name},showCreateBtns:function(e){switch(e.name){case"library":case"peopleFiltered":case"tagsFiltered":case"placesFiltered":return!0}return!1},hideSecondaryBar:function(e){var t;return t=this.getStateMapping(e),t?t.hideSecondaryBar:!1},getStateMapping:function(e){var t;return(t=this.stateMapping[e.name])?(t.sameAs&&(t=this.stateMapping[t.sameAs]),t):void 0},stateMapping:{add:{hideSecondaryBar:!1},albums:{section:"albums",subSection:"albums",leftBtns:"albums",showAlbumBtns:!0},migrationAlbums:{section:"albums",subSection:"albums",leftBtns:"albums",showAlbumBtns:!1},home:{section:"home",subSection:"home",leftBtns:"home",hideSecondaryBar:!0},library:{section:"library",subSection:"library",leftBtns:"dayLibrary",showFilter:!0},tags:{section:"tags",subSection:"tags",leftBtns:"tags"},tagsFiltered:{section:"tags",subSection:"tags",leftBtns:"results",showFilter:!0},people:{section:"people",subSection:"people",leftBtns:"people"},peopleFiltered:{section:"people",subSection:"people",leftBtns:"results",showFilter:!0},peopleSuggestions:{sameAs:"people"},places:{section:"places",subSection:"places",leftBtns:"places",hideSecondaryBar:!1},placesFiltered:{section:"places",subSection:"places",leftBtns:"results",showFilter:!0},stories:{section:"stories",subSection:"stories",leftBtns:"myStories"},storiesFollowing:{section:"stories",subSection:"otherStories",leftBtns:"otherStories"},story:{section:"stories",subSection:"stories",leftBtns:"myStory",showAlbumBtns:!0},storyFollowing:{section:"stories",subSection:"otherStories",leftBtns:"otherStory",showAlbumBtns:!0},timeline:{section:"timeline",subSection:"upload",leftBtns:"none",hideSecondaryBar:!0},gifting:{section:"gifting",subSection:"gifting",hideSecondaryBar:!0}}})}.call(this),function(){ThisLife.Helper.CSS=_.extend({init:function(){return this.is3DSupported=this.check3DSupported()},check3DSupported:function(){var e,t,i,n;e=document.createElement("p"),t=void 0,n={webkitTransform:"-webkit-transform",OTransform:"-o-transform",msTransform:"-ms-transform",MozTransform:"-moz-transform",transform:"transform"},document.body.insertBefore(e,null);for(i in n)void 0!==e.style[i]&&(e.style[i]="translate3d(1px,1px,1px)",t=window.getComputedStyle(e).getPropertyValue(n[i]));return document.body.removeChild(e),void 0!==t&&t.length>0&&"none"!==t},resolveTranslate:function(e,t,i,n){var o,s;return null==e&&(e=0),null==t&&(t=0),null==i&&(i=0),null==n&&(n=1),null==this.is3DSupported&&(this.is3DSupported=this.check3DSupported()),this.is3DSupported&&!ThisLife.Helper.Platform.ie10()?(s="3d",o=", "+i+"px"):(s="",o=""),"translate"+s+"("+e+"px, "+t+"px"+o+") scale("+n+")"},browserPrefix:function(e,t){return"-webkit-"+e+": "+t+";\n-moz-"+e+": "+t+";\n-ms-"+e+": "+t+";\n-o-"+e+": "+t+";\n"+e+": "+t+";"},browserPrefixEl:function(e,t,i){return e.style["webkit"+t]=i,e.style["moz"+t]=i,e.style["ms"+t]=i,e.style[t.toLowerCase()]=i}})}.call(this),function(){define("ThisLife.Helper.DOM",[],function(){var e,t;return t=["transitionEnd","transitionend","webkitTransitionEnd","oTransitionEnd","otransitionend","msTransitionEnd"],e=_.extend({init:function(){return this._updateCachedDimensions(),ThisLife.PubSub.on("resize",_.bind(this._updateCachedDimensions,this))},addRemoveClass:function(e,t,i){return e?t?e.classList.add(i):e.classList.remove(i):void 0},addMany:function(e,t){var i,n,o,s,r;if(e&&t){for(s=t.split(" "),r=[],n=0,o=s.length;o>n;n++)i=s[n],r.push(e.classList.add(i));return r}},isEventSupported:function(e){var t,i;return t=document.createElement("div"),e="on"+e,i=e in t,i||(t.setAttribute(e,"return;"),i="function"==typeof t[e]),t=null,i},removeDocumentSelection:function(){if(window.getSelection){if(window.getSelection().empty)return window.getSelection().empty();if(window.getSelection().removeAllRanges)return setTimeout(function(){return window.getSelection().removeAllRanges()},0)}else if(document.selection)return document.selection.empty()},addEventListener:function(e,t,i,n,o){return this._eventListener("addEventListener",e,t,i,n,o)},removeEventListener:function(e,t,i,n,o){return this._eventListener("removeEventListener",e,t,i,n,o)},scrollToBottom:function(e){return e.scrollTop=e.scrollHeight},isInput:function(e){return this._isType(e,"input")},getInputValueWidth:function(e){var t;return null==this._tempSpan&&(this._tempSpan=document.createElement("span")),this._tempSpan.style.fontSize=$(e).css("fontSize"),this._tempSpan.style.fontWeight=$(e).css("fontWeight"),document.body.appendChild(this._tempSpan),$(this._tempSpan).text(e.value),t=$(this._tempSpan).width(),document.body.removeChild(this._tempSpan),t},highlightInputValue:function(e){return e?e.select():void 0},_getBrowserEvents:function(e){switch(e){case"transitionend":return t;default:return[e]}},_eventListener:function(e,t,i,n,o,s){var r,l,a,u;if(e&&t&&i&&n){for(s&&(n=_.bind(n,s)),a=this._getBrowserEvents(i),u=[],r=0,l=a.length;l>r;r++)i=a[r],u.push(t[e](i,n,o));return u}},_isType:function(e,t){return(null!=e?e.tagName.toLowerCase():void 0)===t},_updateCachedDimensions:function(){return this.windowWidth=document.body.clientWidth,this.windowHeight=document.body.clientHeight},resetInputPosition:function(e){var t,i;return bowser.msie?(t=e.createTextRange(),t.moveStart("character",0),t.select(),i=window.document.getSelection(),i.rangeCount>0&&i.getRangeAt(0).getClientRects().length>0&&i.removeAllRanges(),document.getSelection().addRange(document.createRange())):void 0}})}),ThisLife.Helper.DOM=require("ThisLife.Helper.DOM"),ThisLife.Helper.DOM.init()}.call(this),function(){ThisLife.Helper.String={escapeHtml:function(e){return _.escape(e)},escapeRegExp:function(e){return e?e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"):e},contains:function(e,t){return e?0<=e.indexOf(t):!1},pluralize:function(e,t,i){return null==i&&(i=t+"s"),e+" "+this.pluralizeWord(e,t,i)},pluralizeWord:function(e,t,i){var n;return null==i&&(i=t+"s"),n=1===e?t:i,""+n},pluralizePhotosVideos:function(e){var t;return t=_.countBy(e,function(e){return e.moment_type||e.get("moment_type")}),t.image&&t.video?"photos and videos":t.image>1?"photos":t.video>1?"videos":1===t.image?"photo":1===t.video?"video":""},pluralizePhotosVideosSeparate:function(e){var t,i,n,o;return i=_.countBy(e,function(e){return e.moment_type||e.get("moment_type")}),t=i.image>1?i.image+" photos":1===i.image?"1 photo":"",o=i.video>1?i.video+" videos":1===i.video?"1 video":"",n=o&&t?" and ":"",""+t+n+o},formatTime:function(e){var t,i,n,o;return null==e&&(e=new Date),t=this.pad(e.getHours(),2),n=this.pad(e.getMinutes(),2),o=this.pad(e.getSeconds(),2),i=this.pad(e.getMilliseconds(),2),t+":"+n+":"+o+":"+i},pad:function(e,t,i){for(null==i&&(i="0"),e=String(e);e.length<t;)e=i+e;return e},numberWithCommas:function(e){return e?e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,","):e},beginsWith:function(e,t){return e?0===e.indexOf(t):!1},removeProtocolFromUrl:function(e){return e?(e=e.replace("http://","//"),e=e.replace("https://","//")):e},capitalizeFirstLetter:function(e){return e.charAt(0).toUpperCase()+e.slice(1)},formatCurrency:function(e){return e.toFixed(2)},formatTwoDigitNumber:function(e){return 10>e&&(e="0"+e),e},bytesToSize:function(e){var t,i;return i=["Bytes","KB","MB","GB","TB"],0===e?"n/a":(t=parseInt(Math.floor(Math.log(e)/Math.log(1024))),Math.round(e/Math.pow(1024,t),2)+i[t])},invertString:function(e){return String.fromCharCode.apply(String,_.map(e.split(""),function(e){return 65535-e.charCodeAt()}))},formatString:function(){var e,t,i;for(i=arguments[0],e=0;e<arguments.length-1;)t=new RegExp("\\{"+e+"\\}","gm"),i=i.replace(t,arguments[e+1]),e++;return i}},define("ThisLife.Helper.String",[],function(){return ThisLife.Helper.String})}.call(this),function(){ThisLife.Helper.Math={nearlyEqual:function(e,t,i){return null==i&&(i=.001),Math.abs(e-t)<i}}}.call(this),function(){var e;ThisLife.Helper.Date={getLastMomentDate:function(e){var t,i;return i=ThisLife.Collection.moments.getSort(),t="uploadDate"===i?(null!=e?e.get("upload_date"):void 0)||0:(null!=e?e.get("moment_date"):void 0)||0},areEqual:function(e,t,i){return null==i&&(i=!1),this.isDateValid(e)&&this.isDateValid(t)?i?e.toString()===t.toString():e.getYear()===t.getYear()&&e.getMonth()===t.getMonth()&&e.getDate()===t.getDate():!1},areEqualUTC:function(e,t){return this.isDateValid(e)&&this.isDateValid(t)?e.getUTCFullYear()===t.getUTCFullYear()&&e.getUTCMonth()===t.getUTCMonth()&&e.getUTCDate()===t.getUTCDate():!1},getTime:function(t){var i,n,o;return t=this.checkDateLength(t),i=e(t.getUTCHours()),n=e(t.getUTCMinutes()),o=e(t.getUTCSeconds()),i+":"+n+":"+o},offsetToUTC:function(e){var t,i,n;return t=1e3*e,i=new Date(t).getTimezoneOffset(),n=60*-i*1e3,new Date(t+n).getTime()/1e3},isLeapYear:function(e){return e%4===0&&e%100!==0||e%400===0},calculateWeekday:function(e,t,i,n){var o,s;return o=new Date(e,t-1,1),s=i-o.getDay(),0>s&&(s+=7),o.setDate(1+s+7*(n-1)),o},getNewYears:function(e){var t;return t=new Date(e,0,1),t.setHours(12),t},getMothersDay:function(e){var t;return t=this.calculateWeekday(e,5,0,2),t.setHours(12),t},getFathersDay:function(e){var t;return window.location.href.indexOf("#eventToday")>-1?(t=new Date,t.setHours(12),t):(t=this.calculateWeekday(e,6,0,3),t.setHours(12),t)},formatBirthdate:function(e,t,i){var n;return n="",null!=e&&"-"!==e&&(n+=this.getFullMonth(e),null!=t&&"-"!==t&&(n+=" "+parseInt(t))),null!=i&&"-"!==i&&(n.length>0&&(n+=", "),n+=i),n},formatDate:function(e){var t,i,n;return t=ThisLife.Helper.String.formatTwoDigitNumber(e.getDate()),i=ThisLife.Helper.String.formatTwoDigitNumber(e.getMonth()+1),n=e.getFullYear(),i+"/"+t+"/"+n},secondsToDuration:function(t){var i,n,o;return o=e(Math.floor(t)%60),n=e(Math.floor(t/60)%60),i=e(Math.floor(t/3600)),i+":"+n+":"+o},parseDate:function(e){var t,i,n,o;return this.validateDate(e)?(n=e.split("/"),o=n[2],i=n[0]-1,t=n[1],new Date(o,i,t)):null},parseISO8601DateTime:function(e){var t;return e?(t=new Date(e),this.isDateValid(t)||(t=new Date(e.replace(/\-/gi,"/"))),this.isDateValid(t)||(t=new Date(e.replace(/T/gi," "))),t):null},parseYYYYMMDD:function(e){var t,i,n;return/^(\d){8}$/.test(e)?(n=e.substr(0,4),i=Number(e.substr(4,2))-1,t=e.substr(6,2),new Date(n,i,t)):"invalid date"},validateDate:function(e,t,i){var n,o;return null==t&&(t=1900),o=e.split("/"),3===o.length&&(n=this.getDaysOfMonth(o[2],o[0]),i||(i=o[2]),o[0]>0&&o[0]<13&&o[1]>0&&o[1]<=n&&o[2]>=t&&o[2]<=i)?!0:!1},isDateValid:function(e){return"[object Date]"!==Object.prototype.toString.call(e)||isNaN(e.getTime())?!1:!0},isFutureDate:function(e){var t;return t=new Date,this.isDateValid(e)&&t<e.valueOf()?!0:!1},endOfDay:function(e){return e.setUTCHours(23),e.setUTCMinutes(59),e.setUTCSeconds(59),e},getDaysOfMonth:function(e,t){return new Date(e,t,0).getDate()},getDayOfWeek:function(e){var t;return t=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],t[e]},getMonthAndDay:function(e){var t;return e=this.checkDateLength(e),t=this.getDayOfWeek(e.getUTCDay()),t+" <div class='num'>"+e.getUTCDate()+"</div>"},summaryHeadingDate:function(e){var t,i;return e=this.checkDateLength(e),i=this.getAbrevMonth(e.getUTCMonth()+1),t=this.getDayOfWeek(e.getUTCDay()),"<span>"+t+" "+i+" "+parseFloat(e.getUTCDate())+"</span> <span class='year'>"+e.getUTCFullYear()+"</span>"},monthAndYear:function(e){var t;return e=this.checkDateLength(e),t=this.getAbrevMonth(e.getUTCMonth()+1),"<span>"+t+"</span> <span class='year'>"+e.getUTCFullYear()+"</span>"},getFullYear:function(e){return null!=e?(e=this.checkDateLength(e),"<span>"+e.getUTCFullYear()+"</span>"):void 0},getMonth:function(e){return null!=e?(e=this.checkDateLength(e),this.getAbrevMonth(e.getUTCMonth()+1)):void 0},humanDate:function(e,t){var i;return null==t&&(t=!0),e=this.checkDateLength(e),i=this.getFullMonth(e.getMonth()+1),t=t?",":"",i+" "+e.getDate()+t+" "+e.getFullYear()},humanDateUTC:function(e,t){var i;return null==t&&(t=!0),e=this.checkDateLength(e),i=this.getFullMonth(e.getUTCMonth()+1),t=t?",":"",i+" "+e.getUTCDate()+t+" "+e.getUTCFullYear()},humanTime:function(t){var i,n,o;return t=this.checkDateLength(t),i=t.getHours(),o=i>11?"pm":"am",i=i%12||12,n=e(t.getMinutes()),i+":"+n+o},humanTimeUTC:function(t){var i,n,o;return t=this.checkDateLength(t),i=t.getUTCHours(),o=i>11?"pm":"am",i=i%12||12,n=e(t.getUTCMinutes()),i+":"+n+o},abrevDate:function(e){var t;return e=this.checkDateLength(e),t=ThisLife.Helper.Date.getAbrevMonth(e.getUTCMonth()+1),t+" "+e.getUTCDate()+", "+e.getUTCFullYear()},getAbrevMonth:function(e){var t;return e=e.toString(),t=function(){switch(e){case"01":case"1":case 1:return"Jan";case"02":case"2":case 2:return"Feb";case"03":case"3":case 3:return"Mar";case"04":case"4":case 4:return"Apr";case"05":case"5":case 5:return"May";case"06":case"6":case 6:return"Jun";case"07":case"7":case 7:return"Jul";case"08":case"8":case 8:return"Aug";case"09":case"9":case 9:return"Sep";case"10":case 10:return"Oct";case"11":case 11:return"Nov";case"12":case 12:return"Dec"}}()},getFullMonth:function(e){var t;return t=function(){switch(e){case"01":case"1":case 1:return"January";case"02":case"2":case 2:return"February";case"03":case"3":case 3:return"March";case"04":case"4":case 4:return"April";case"05":case"5":case 5:return"May";case"06":case"6":case 6:return"June";case"07":case"7":case 7:return"July";case"08":case"8":case 8:return"August";case"09":case"9":case 9:return"September";case"10":case 10:return"October";case"11":case 11:return"November";case"12":case 12:return"December"}}()},cleanYear:function(e){return e.replace(new RegExp("/(\\d{2})$",""),function(e,t){return t.match(new RegExp("^[01]{1}",""))?"/20"+t:void 0})},getUTCString:function(t,i,n){var o,s,r,l,a,u,c;return null==t&&(t=new Date),null==i&&(i=!0),null==n&&(n="-"),t=this.checkDateLength(t),c=t.getUTCFullYear(),l=e(t.getUTCMonth()+1),o=e(t.getUTCDate()),u=""+c+n+l+n+o,i&&(s=e(t.getUTCHours()),r=e(t.getUTCMinutes()),a=e(t.getUTCSeconds()),u+=" "+s+":"+r+":"+a),u},getLocalString:function(t,i,n){var o,s,r,l,a,u,c;return null==t&&(t=new Date),null==i&&(i=!0),null==n&&(n="-"),t=this.checkDateLength(t),c=t.getFullYear(),l=e(t.getMonth()+1),o=e(t.getDate()),u=""+c+n+l+n+o,i&&(s=e(t.getHours()),r=e(t.getMinutes()),a=e(t.getSeconds()),u+=" "+s+":"+r+":"+a),u},prettyDate:function(e,t){var i,n,o,s,r,l,a;return r=new Date,t?(s=-r.getTimezoneOffset()/60,l=t.split(":")[0],a=60*(s-l)*60*1e3):a=0,i=e instanceof Date?e:new Date((e||"").replace(/-/g,"/").replace(/[TZ]/g," ")),o=(r.getTime()-i.getTime()-a)/1e3,r.setHours(0,0,0,0),i.setHours(0,0,0,0),n=Math.floor((r.getTime()-i.getTime()-a)/1e3/86400),isNaN(n)||0>n?ThisLife.Helper.Date.abrevDate(e):n?1===n?"Yesterday":7>n?ThisLife.Helper.String.pluralize(n,"day")+" ago":31>n?ThisLife.Helper.String.pluralize(Math.floor(n/7),"week")+" ago":365>n?ThisLife.Helper.String.pluralize(Math.floor(n/31),"month")+" ago":ThisLife.Helper.String.pluralize(Math.floor(n/365),"year")+" ago":60>o?"Just now":3600>o?ThisLife.Helper.String.pluralize(Math.floor(o/60),"minute")+" ago":86400>o?ThisLife.Helper.String.pluralize(Math.floor(o/3600),"hour")+" ago":void 0},saveDate:function(e,t){var i,n,o;return n=t.get("moment_date")%86400,i=new Date(e).toUnix()+n,t.set({moment_date:i}),null!=(o=ThisLife.Collection.moments.get(t.id))&&o.set({moment_date:i}),ThisLife.Service.api.saveMomentsProperty([t.id],"moment_date",i)},daysInMonthFromDate:function(e){var t,i;return i=this.getFullYear(e),e=this.checkDateLength(e),t=ThisLife.Helper.String.pad(e.getUTCMonth()+1,2),this.daysInMonth(t,i)},daysInMonth:function(e,t){var i;switch(t&&(i=ThisLife.Helper.Date.isLeapYear(t)),e){case"01":return 31;case"02":return i?29:28;case"03":return 31;case"04":return 30;case"05":return 31;case"06":return 30;case"07":return 31;case"08":return 31;case"09":return 30;case"10":return 31;case"11":return 30;case"12":return 31}},areSameDay:function(e,t){return ThisLife.Helper.Date.getUTCString(e,!1)===ThisLife.Helper.Date.getUTCString(t,!1)},areSameMonth:function(e,t){return this.isDateValid(e)&&this.isDateValid(t)?e.getYear()===t.getYear()&&e.getMonth()===t.getMonth():!1},areSameMonthUTC:function(e,t){return this.isDateValid(e)&&this.isDateValid(t)?e.getUTCFullYear()===t.getUTCFullYear()&&e.getUTCMonth()===t.getUTCMonth():!1},checkDateLength:function(e){var t,i;return i=1,t=e.toString(),(t.length<=10||-1!==t.indexOf("."))&&(i=1e3),e instanceof Date||(e=new Date(e*i)),e}},e=function(e){return 1===e.toString().length?"0"+e:e}}.call(this),function(){var e;ThisLife.Helper.DelayedExecution=Backbone.View.extend({id:"delayed-message-wrapper",defaultDelay:5,initialize:function(){return this.waitingTask=null,this.timerHandler=null,this.render()},events:function(){return{"click .delayed-message-undo":"undo"}},cacheDom:function(){return this.$messageHolder=$(this.$el.find(".delayed-message-text")),this.$undoButton=$(this.$el.find(".delayed-message-undo"))},addTask:function(e){var t;if(e&&null!=e.task)return t={task:e.task,cancel:e.cancelCallback,message:e.message||"",timeToWait:1e3*(e.timeToWait||this.defaultDelay),taskName:e.taskName},this._fireEvent("startDelay",t.taskName),this._execute(),this.setToNewTask(t),this._showMessage(),this.timerHandler=this.delay(t.timeToWait,this._execute.bind(this)),this},render:function(){return $("body").append(this.$el.html(e())),this.cacheDom()},updateMessage:function(e){return this.$messageHolder.html(e)},setToNewTask:function(e){return this.updateMessage(e.message),this.waitingTask=e},clean:function(){return this.waitingTask=null,clearTimeout(this.timerHandler),this._removeMessage(),this},undo:function(){var e;return this._fireEvent("cancelDelay",this.waitingTask.taskName),"function"==typeof(e=this.waitingTask).cancel&&e.cancel(),this.clean(),this._removeMessage(),this},delay:function(e,t){return setTimeout(t,e)},_execute:function(){var e;return null!=this.waitingTask&&("function"==typeof(e=this.waitingTask).task&&e.task(),this._fireEvent("executeDelay",this.waitingTask.taskName)),this.clean()},_showMessage:function(){return this.$el.fadeIn(200)},_removeMessage:function(){return this.$el.fadeOut(200)},_fireEvent:function(e,t){return ThisLife.PubSub.trigger(e,t),ThisLife.PubSub.trigger(t+":"+t)}}),e=function(){return'<div class="delayed-message">\n  <span class="delayed-message-text"></span>\n  <span class="delayed-message-undo">Undo</span>\n</div>'}}.call(this),function(){var e,t;e=360,ThisLife.Model.Moment=APIModel.extend({constructor:function(e,t){return null==t&&(t={}),this.collection=t.collection,this.cid=_.uniqueId("c"),this.id=e.uid,this.changed={},this._previousAttributes={},e.hidden=e.hidden||!1,e.rating=e.rating||0,this.attributes=e,this},enhanced:function(){return this.isVideo()?!1:this.get("enhanced")},isVideo:function(){return"video"===this.get("moment_type")},isImage:function(){return"image"===this.get("moment_type")},isSelected:function(e){return e.hasMoment(this)},isProcessing:function(){return!!this.rotateDegrees},canEdit:function(){return!0},_updateHeimdall:function(e,t){var i;return ThisLife.app.controller("timeline").updateObjects(e,t),"function"==typeof(i=ThisLife.app.album).updateObjects?i.updateObjects(e,t):void 0},rotate:function(e,i){var n,o,s,r;return o=t(),90===e||270===e?(s=this.get("height"),r=this.get("width"),this._updateHeimdall([this.id],{width:s,height:r,effects_modified_date:o}),this.set({height:r,width:s,effects_modified_date:o})):180===e?(this._updateHeimdall([this.id],{effects_modified_date:o}),this.set({effects_modified_date:t()})):i?(n=_.extend({},i),delete n.moment_date,delete n.upload_date,this._updateHeimdall([this.id],n),this.set(i)):assert(!1,"expected either rotate degrees or data")},crop:function(e){var i;return i=t(),this._updateHeimdall([this.id],{width:e.get("width"),height:e.get("height"),effects_modified_date:i}),this.set({height:e.get("height"),width:e.get("width"),effects_modified_date:i})},filter:function(){var e;return e=t(),this._updateHeimdall([this.id],{effects_modified_date:e}),this.set({effects_modified_date:e})},getImage:function(e){return null==e&&(e=this.height),ThisLife.Helper.Image.imageUrlDim(this.id,e,this.get("effects_modified_date"),ThisLife.currentLifeOwner)},getImageSize:function(e){return ThisLife.Helper.Image.imgUrl(this.id,e,this.get("effects_modified_date"),ThisLife.currentLifeOwner)},getTime:function(){return ThisLife.Helper.Date.getTime(this.get("moment_date"))},updateDate:function(e,t){var i;return i=new Date(e+" "+this.getTime()+" GMT"),this._updateHeimdall([this.id],{moment_date:1e3*i.toUnix()}),this.set({moment_date:i.toUnix()},t),i.toUnix()},quickDelete:function(){var e;return null!=(e=this.collection)?e.quickDelete(this):void 0},saveHidden:function(e){return this.saveProperty("hidden",{hidden:e},e)},saveRating:function(e){return this.set({rating:e}),this.saveProperty("rating",{rating:e},e),this._updateHeimdall([this.id],{rating:e})},saveProperty:function(e,t,i){return ThisLife.Service.api.saveMomentsProperty([this.id],e,i).then(function(e){return function(){return e.set(t),ThisLife.Collection.moments.get(e.id).set(t)}}(this))},deleteMoment:function(){var e;return ThisLife.Service.api.deleteMoments([this.id]),null!=(e=this.collection)?e.deleteMoment(this):void 0},selectMoment:function(e){var t,i;return null==e&&(e=!this.selected),this.selected!==e?(this.selected=e,this.trigger("momentSelected",this,this.selected),null!=(t=this.day)&&t.onMomentSelected(this,this.selected),null!=(i=this.month)?i.onMomentSelected(this,this.selected):void 0):void 0}}),t=function(){return Math.round(Date.now()/1e3)}}.call(this),function(){var e,t,i,n,o,s,r,l,a,u,c,d,h=[].slice;n=900,i=1e3,e=i*i,o=100*e,c=!1,u="change:first_name change:last_name",s="change:facebook_id change:email",r=u+" "+s,a=!1,l=!1,d=function(){var e;return l?(e=document.querySelector(".gray_dropdown_overlay .facebook_reconnect"),e||new ThisLife.View.FacebookReconnectPopup({model:this})):a=!0,ThisLife.PubSub.off("notification:facebookretry",d)},t=APIModel.extend({idAttribute:"uid",initialize:function(){return this.on("change",this.changes,this).on(r,this.setCustomAttributes,this).on("reset",this.start,this).on("add:bonus_moments",this.addBonusMoments,this).on("add:video",this.addVideo,this).on("facebook:fail",this.refreshFacebook,this),ThisLife.PubSub.on("notification:facebookretry",d),_.bindAll(this,"updateMomentCount")},load:function(e){return this.parseData(e),this.setShutterflyAccessToken(),this.setThisLifeMigrationAccessToken(),this.trigger("reset")},setShutterflyAccessToken:function(){return ThisLife.app.session.getSessionToken().then(function(e){return function(t){return e.set("shutterfly_access_token",t)}}(this)),this},setThisLifeMigrationAccessToken:function(){return $.cookies.get("old_life")&&this.set("thislife_access_token",$.cookies.get("old_life")),this},getCurrentSubscription:function(){var e;return e=this.get("default_life_subscription")},getLifePermission:function(){return this.get("life_permissions")[0]},getOriginalStorage:function(){return this.getCurrentSubscription().original_storage_kb},getUsedStorageText:function(){var t,o,s,r;return s=this.getOriginalStorage(),n>s?(o=s,t="KB"):n*i>s?(r=s/i,o=Math.round(r),t="MB"):(r=s/e,o=Math.round(r),t="GB"),o+" "+t},parseData:function(e){var t,i;this.loaded=!0;for(t in e)i=e[t],"person"===t?this.set(i,{silent:!0}):this.set(t,i,{silent:!0});
return this.isAlreadyOverLimit=this.isOverPlanLimit(),this.isAlreadyOverUpgradeLimit=this.isOverUpgradePlanLimit(),this},isCurrentLifeOwner:function(){var e;return(null!=(e=this.getLifePermission())?e.owner_person_uid:void 0)===this.id},start:function(){return this.ensureSubscriptions(),this.setCustomAttributes(),this.off("reset",this.start,this)},refreshFacebook:function(e){var t,i,n;return e?(n=e.status,400===n?this.refresh()?this.on("reset",this.refreshFacebook,this):(this.off("reset facebook:fail",this.refreshFacebook,this),i=ThisLife.services.facebook.disconnect,this.set(i.setObject),a?(t=document.querySelector(".gray_dropdown_overlay .facebook_reconnect"),t?!1:new ThisLife.View.FacebookReconnectPopup({model:this})):l=!0):ThisLife.notificationList("facebookFail")):void 0},addBonusMoments:function(e){var t;return e=parseInt(e),t=this.getCurrentSubscription(),t.bonus_storage+=e,t.total_storage+=e,this.trigger("change:subscriptions")},addVideo:function(e){var t,i;return t=this.getCurrentLife(),e=parseInt(e),i=this.getCurrentSubscription(),i.sec_videos+=e,t.sec_videos+=e/1e3},ensureSubscriptions:function(){var e;if(!(this.get("subscriptions")||[]).length)return e=[{total_storage:0,num_videos:0,num_photos:0,sec_videos:0,plan:{name:"Shared Account",ordinal:"sharedlife"}}],this.set({subscriptions:e},{silent:!0}),e},changes:function(){return this.setCustomAttributes()},setCustomAttributes:function(){var e;return e={},e.avatar=this.getCustomAvatar(),e.full_name=this.getFullName(),this.set(e,{silent:!0})},getFullName:function(){var e,t;return e=this.get("first_name"),t=this.get("last_name"),e+" "+t},getNumPhotos:function(){return this.getCurrentSubscription().num_photos},getNumVideos:function(){return this.getCurrentSubscription().num_videos},hasZuoraSubscription:function(){return this.getCurrentSubscription().zuoraSubscriptionId?!0:!1},isPaidAccount:function(){return this.getCurrentSubscription().plan.uid===ThisLife.Settings.starterBoxUid?!1:!0},isOverUpgradePlanLimit:function(){var e,t;return t=this.getCurrentSubscription(),t.video_storage_kb>(null!=(e=t.upgrade_plan)?e.max_storage_kb:void 0)?!0:!1},isOverPlanLimit:function(){var e;return e=this.getCurrentSubscription(),e.plan.max_storage_kb>=0&&e.video_storage_kb>e.plan.max_storage_kb?!0:!1},upgradeIsPossible:function(){var e;return e=this.getCurrentSubscription(),e.upgrade_plan?!0:!1},getCustomAvatar:function(){var e,t,i;return e=this.get("facebook_id"),i=null!=(t=this.getCurrentLife())?t.twitter_handle:void 0,e?ThisLife.Settings.fbUrl+("/"+e+"/picture"):i?"https://twitter.com/api/users/profile_image/"+i:null},getPermissionByLifeUid:function(e){return _.find(this.get("life_permissions"),function(t){return t.life_uid===e})},getLifeByUid:function(e){var t;return null!=(t=this.getPermissionByLifeUid(e))?t.life:void 0},getCurrentPermission:function(){var e;return this.getPermissionByLifeUid(null!=(e=this.getLifePermission())?e.life_uid:void 0)},getCurrentLife:function(){var e;return this.getLifeByUid(null!=(e=this.getLifePermission())?e.life_uid:void 0)},getAllowedMediaType:function(){var e;return e=ThisLife.Model.User.isPaidAccount()?3:1},getDefaultLife:function(){var e,t,i;return t=this.get("life_permissions"),i=t[0],i?(e=i.life,{uid:e.uid}):{uid:""}},updatePerson:function(e,t){return this.set(e,t),ThisLife.Service.api.updatePerson(e)},updateMomentCount:function(e,t){var i,n,o;switch(t=t?1:-1,n=this.getCurrentSubscription(),o=e.get("moment_type"),i=e.get("orig_filesize"),o){case"image":n.num_photos+=t,t&&i&&(n.original_storage_kb+=i/1e3);break;case"video":n.num_videos+=t,t&&i&&(n.original_storage_kb+=i/1e3)}if(this.isOverPlanLimit()?this.isAlreadyOverLimit||(this.trigger("overPlanLimit",!0),this.isAlreadyOverLimit=!0):this.isAlreadyOverLimit&&(this.trigger("overPlanLimit",!1),this.isAlreadyOverLimit=!1),this.isOverUpgradePlanLimit()){if(!this.isAlreadyOverUpgradeLimit)return this.isAlreadyOverUpgradeLimit=!0,ThisLife.Service.api.getSubscriptionInfo()}else if(this.isAlreadyOverUpgradeLimit)return this.isAlreadyOverUpgradeLimit=!1,ThisLife.Service.api.getSubscriptionInfo()},hasEmailAddress:function(e){var t;return t=this.get("addresses"),_.any(t,function(t){return t.email===e})},addEmailAddress:function(e){var t;return t=this.get("addresses"),this.hasEmailAddress(e)||(t.push({_explicitType:"Address",email:e,first_name:"",last_name:"",person_uid:"",uid:""}),delete ThisLife.Collection.contacts),this},whenLoaded:function(){var e,t,i,n,o;return i=arguments[0],n=arguments[1],e=3<=arguments.length?h.call(arguments,2):[],null==n&&(n=this),t=_.bind(i,n),this.loaded?t.apply(null,e):(o=function(){return t.apply(null,e),this.off("reset",o,this)},this.on("reset",o,this))}}),ThisLife.Model.User=new t}.call(this),function(){var e,t,i,n,o,s;e=APIModel.extend({initialize:function(){return this.on("change:moment_date",this.updateModelDate,this).on("change:moment_date_timestamp",this.updateTimestamp,this).on("change:enhanced",this.updateModelEnhanced,this).on("change:hidden",this.updateModelHidden,this).on("change:rating",this.updateModelRating,this)},isVideo:function(){return"video"===this.get("moment_type")},getOwner:function(){return ThisLife.Collection.moments.get(this.id)?ThisLife.currentLifeOwner:this.get("created_by_uid")},getImageSize:function(e){return ThisLife.Helper.Image.imgUrl(this.id,e,this.get("effects_modified_date"),this.getOwner())},getImage:function(e){return ThisLife.Helper.Image.imageUrlDim(this.id,e,this.get("effects_modified_date"),this.getOwner())},revertRotation:function(){return delete this.rotate},rotateMoment:function(){var e;return null!=(e=this.get("faces"))?e.reset():void 0},momentRotated:function(e){var t,i,n;return 90===e||270===e?(n=this.get("height"),i=this.get("width")):180===e&&(n=this.get("width"),i=this.get("height")),t={height:i,width:n,effects_modified_date:Math.round(Date.now()/1e3)},this.momentDimensionsChanged(t)},momentCropped:function(e){var t;return t={width:e.get("width"),height:e.get("height"),effects_modified_date:Math.round(Date.now()/1e3)},this.momentDimensionsChanged(t)},momentDimensionsChanged:function(e){return this.set({height:e.height,width:e.width,effects_modified_date:e.effects_modified_date}),this},updateTimestamp:function(e,t){var i;return i=new Date(1e3*t),this.updateDate(i)},updateModelDate:function(e,t){return this.updateModels({moment_date:t})},updateModelEnhanced:function(e,t){return this.updateModels({enhanced:t})},updateModelHidden:function(e,t){return this.updateModels({hidden:t})},updateModelRating:function(e,t){return this.updateModels({rating:t})},updateModels:function(e){return ThisLife.app.library.set(this.id,e,null)},parse:function(e){var t,n,o,s,r,l,a,u;if(a=e.result.payload,!a)throw"No Moment Found";if(o=a[0],o.moment_date=o.moment_date_timestamp,o.location_tag_uid=null!=(u=o.location_taggings[0])?u.location_tag_uid:void 0,o.moment_taggings=new i(o.moment_taggings,{parse:!0}),n=this.get("faces")){for(l=o.faces,delete o.faces,s=0,r=l.length;r>s;s++)t=l[s],n.updateOrAdd(t,{parse:!0});n.each(function(e){var i,o,s;for(i=!1,o=0,s=l.length;s>o;o++)if(t=l[o],e.id===t.uid){i=!0;break}return i?void 0:n.remove(e)})}else o.faces=new i(o.faces,{parse:!0});return o},addComment:function(e){var t,i;return t=this.get("comments"),i=parseInt(this.get("comment_count")||0,10),i++,t?(t.push(e),this.trigger("change:comments",t),this.set({comment_count:i})):this.set({comments:[e],comment_count:i})},addLocation:function(e){var t,i;return t=ThisLife.Collection.locationTags.get(e),i=t.addLocationTagging(this.id),this.set({location_taggings:i,location_tag_uid:e,lat:t.get("lat"),"long":t.get("long")}),ThisLife.Service.api.saveLocationTagWithTaggings(t,i)},removeLocation:function(){var e,t,i,n;return i=this.get("location_taggings")[0],i?(n=i.uid,t=i.location_tag_uid,null!=(e=ThisLife.Collection.locationTags.get(t))&&e.deleteMomentUid(this.id),ThisLife.Service.api.deleteLocationTagging(n),this.set({location_taggings:[],location_tag_uid:"",lat:"","long":""})):void 0},getLocationName:function(){var e,t;return(t=this.get("location_taggings")[0])?(e=t.location_tag_uid,ThisLife.Collection.locationTags.getFMVLocation(e)):void 0},updateDate:function(e){var t;return t=e.toUnix(),t!==this.get("moment_date")?this.set({moment_date:t}):void 0},changeEnhanced:function(){var e;return e=!this.get("enhanced"),this.set({enhanced:e}),this.saveMomentsProperty("enhanced",e)},changeHidden:function(e){var t;return null==e&&(e=null),t=null!==e?e:!this.get("hidden"),this.set({hidden:t}),this.saveMomentsProperty("hidden",t)},changeRating:function(e){return this.set({rating:e}),this.saveMomentsProperty("rating",e)},addHeart:function(){var e,t,i;return i=ThisLife.Model.User.toJSON(),t=this.get("hearts"),e={name:i.full_name,person_uid:i.uid,created:{date:ThisLife.Helper.Date.getUTCString()}},t.push(e),this.trigger("add:heart",e),1===t.length?this.trigger("show:social"):void 0},saveMomentsProperty:function(e,t){return ThisLife.Service.api.saveMomentsProperty([this.id],e,t),this},teardown:function(){},setShareUrl:function(e){var t;return t=ThisLife.Collection.moments.get(this.id),t?t.shareUrl=e:this.shareUrl=e},getShareUrl:function(){var e;return e=ThisLife.Collection.moments.get(this.id),e?e.shareUrl:this.shareUrl}}),ThisLife.Model.FullMoment=e,t=Backbone.Model.extend({idAttribute:"uid",remove:function(){return this.collection.remove(this)},parse:function(e){var t,i;return t=n(e._explicitType),i=o(e._explicitType),e.tag=t.get(e[i]),e}}),i=Backbone.Collection.extend({model:t,comparator:function(e){var t,i;return null!=(t=e.get("tag"))&&null!=(i=t.get("name"))?i.toLowerCase():void 0},findName:function(e){return e=(e||"").toLowerCase(),this.find(function(t){var i;return((null!=(i=t.get("tag"))?i.get("name"):void 0)||"").toLowerCase()===e})},updateOrAdd:function(e,t){var i,n;return n=this.get(e.uid),n?(i=t&&t.parse?n.parse(e):void 0,n.set({tag:null},{silent:!0}),n.set(i)):this.add(e,t)}}),s=function(){throw Error("Incorrect Tagging ExplicitType")},n=function(e){switch(e){case"Face":return ThisLife.Collection.personTags;case"MomentTagging":return ThisLife.Collection.momentTags;default:return s()}},o=function(e){switch(e){case"Face":return"person_tag_uid";case"MomentTagging":return"moment_tag_uid";default:return s()}}}.call(this),function(){var e,t;e={ORIG:"Original",BW:"BlackWhite",SEPIA:"Colortone",SATURATE:"Saturate",SOFT:"Softfocus"},t=_.invert(e),ThisLife.Model.ImageFilters=Backbone.Model.extend({idAttribute:"uid",initialize:function(e){return null==e&&(e={}),this.id=e.uid,this.model=e.model,this.set("active",null),this.set("filter",{Colortone:.5,Saturate:.6,Softfocus:.5})},fetch:function(e){return this.options=null!=e?e:{},ThisLife.Service.api.getMomentEffects(this.id,_.bind(this.fetchSuccess,this))},fetchSuccess:function(t){var i,n,o;return i=t.process,o=t.processArgument,n=e[i],"Original"===n&&(n=null),this.updateFilter(n,o),this.model.filter=n,this.model.filterValue=o,this.loaded=!0,this.trigger("sync")},save:function(){var e,i,n;return i=this.getFilter(),n=this.getFilterValue(),null==i&&(i="Original"),this.model.filter=i,this.model.filterValue=n,e=t[i],ThisLife.Service.api.setMomentEffects(this.id,e,n,_.bind(this.saveSuccess,this))},saveSuccess:function(){return this.model.trigger("filter"),this},resetFilter:function(e){var t,i;return null==e&&(e=!1),t=this.model.filter,i={Colortone:.5,Saturate:.6,Softfocus:.5},t in i&&(i[t]=this.model.filterValue),this.set("active",t),this.set("filter",i),this.trigger("change:filter")},getFilterValue:function(){var e,t;return e=this.get("active"),(null!=(t=this.get("filter"))?t[e]:void 0)||0},getFilter:function(){return this.get("active")},updateFilter:function(e,t){var i;return i=_.clone(this.get("filter")),e in i&&(i[e]=t),this.set("active",null!=e?e:e=null),this.set("filter",i),this.trigger("change:filter")}})}.call(this),function(){var e;ThisLife.Model.Story=APIModel.extend({parse:function(e){var t;return t=e.result.payload,null!=t&&(t.uid=t.uid.toString(),t.members=this.createStoryFollowersCollection(t.members)),t},initialize:function(){return this.on("reset",this.setup,this).on("toggleStatus",this.changeToggle,this).on("change:avatar_url",this.changeAvatar,this),_.bindAll(this,"mark_to_revert","revert"),this.mark_to_revert()},createStoryFollowersCollection:function(e){return"undefined"!=typeof ThisLife.Collection.StoryFollowers?new ThisLife.Collection.StoryFollowers(e):void 0},isViewOnly:function(){var e;return null!=(e=this.get("permission"))?e.get("view_only"):void 0},updateFollower:function(e){var t;return delete e.story,delete e.name,t=this.followers.get(e.uid),t?t.set(e):this.followers.add(e)},acceptFollower:function(e){var t;return this.updateFollower(e),t=e.first_name+" "+e.last_name,ThisLife.Helper.Stories.inviteAcceptedNotification(this.get("permission"),t)},changeFollowerPermission:function(e){return delete e.story,delete e.name,delete e.first_name,delete e.last_name,this.get("permission").set(e),ThisLife.Helper.Stories.permissionsUpdatedNotification(this.get("permission"))},changeAvatar:function(e,t){return this.get("permission").get("story").avatar_url=t},saveStory:function(e){var t,i;return null==e&&(e={}),this.mark_to_revert(),this.set(e),t=this.toJSON(),delete t.permission,delete t.moments,delete t.members,i=_.bind(this.saveStorySuccess,this),ThisLife.Service.api.saveStory(t,null,i)},saveStorySuccess:function(e){return e.success?void 0:(ThisLife.notification(e.errors,1e4),this.revert())},mark_to_revert:function(){return this._revertAttributes=_.clone(this.attributes)},getStoryName:function(){return this.get("name")},getCoverUrl:function(e){var t,i,n;return null==e&&(e="x-small"),n=this.get("cover_moment_uid"),t=this.get("cover_owner_uid"),i=this.get("cover_effects_modified_date"),n?ThisLife.Helper.Image.imgUrl(n,e,i,t):""},revert:function(){return this._revertAttributes&&this.set(this._revertAttributes,{silent:!0}),this.trigger("change:name",this,this.get("name"))},changeToggle:function(e,t,i){var n;return n=function(){switch(e){case"share_facebook":return"facebookShare";case"privacy":return"publicShare"}}(),n?this[n](t,i):void 0},facebookShare:function(e,t){var i,n;return n=ThisLife.Model.User,e&&!n.get("facebook_access_token")?(this.facebookPending=!0,this.popFBWindow(n)):(this.facebookPending=!1,i=e?t:{facebook_sharing:0},this.saveStory(i))},popFBWindow:function(e){var t;return e.trigger("change:facebook_access_token",e,""),t=ThisLife.services.facebook.connect,window.open(ThisLife.Settings.socialUrl+t.url,t.name,t.options)},publicShare:function(e){return this.saveStory({"public":e})},publicLinkShare:function(e){return this.saveStory({public_link:e,"public":e})},load:function(e,t,i){return ThisLife.app.session.getSessionToken().then(function(n){return function(o){var s,r,l,a,u,c;return r=ThisLife.emailToken||null,u=i?null:o,s=!1,c=function(){return s?void 0:e()},l=function(){return s?void 0:t()},a=n.fetch({method:"getStory",params:[u,n.id,r],success:function(e,t){return t.result.success?(e.loaded=!0,n.setup(c)):l()},error:l}),{abort:function(){return s=!0,a.abort()}}}}(this))},setup:function(e){return this.followers=this.get("members"),this.followers&&(this.followers.story_uid=this.id),this.parseMoments(e)},parseMoments:function(e){var t,i,n;return t=this.get("moments"),t.length?(n=function(t){return function(i){return null==i&&(i=[]),t.createCollection(i),"function"==typeof e?e():void 0}}(this),i=function(){return function(){return"function"==typeof e?e():void 0}}(this),window.momentLoaderClient.parseStoryMoments({momentsStr:t},n,i)):(this.createCollection(),"function"==typeof e&&e()),this},createCollection:function(t){var i;return null==t&&(t=[]),this.id===ThisLife.storyUid?(i=[],this.moments=_.chain(t).union(i).sortBy(e).value()):void 0},parseNotes:function(){var e,t,i,n;return n=this.get("notes"),n.length?e=function(){var e,o,s;for(s=[],e=0,o=n.length;o>e;e++)t=n[e],s.push(i={moment_date:new Date(parseInt(t.date,10)),caption_text:t.note,item_type:"moment",moment_type:"text",uid:t.uid});return s}():[]},teardown:function(){return this.changeUpdatedCount()},changeUpdatedCount:function(){var e;return null!=(e=this.get("permission"))?e.get("story").updated_count=0:void 0},updateName:function(e){var t;return e=e.trim(),e?(ThisLife.PubSub.trigger("story:changed_name",this.get("uid"),e),this.saveStory({name:e},{silent:!0}),t=this.get("permission"),t.get("story").name=e,this.trigger("change:name",this,e),t.trigger("change:story_name",t,e)):(e=this.get("name"),this.trigger("change:name",this,e))},isOwner:function(e){return this.get("permission").get("owner_person_uid")===e},isInvitee:function(){return this.get("permission").get("invited_story")},canEditCover:function(){var e;return e=this.get("permission"),!e.get("view_only")&&!e.get("invited_story")},canEditTitle:function(){return this.canEditCover()},getAcceptedInviteesCount:function(){var e,t,i,n,o;for(e=0,o=this.get("members").models,t=0,n=o.length;n>t;t++)i=o[t],e++;return e}}),e=function(e){return e.moment_date}}.call(this),function(){ThisLife.Model.StoryPermission=APIModel.extend({updateCount:function(e,t){var i,n,o,s,r;return o=this.get("story"),s=o.uid,r=o.updated_count,i=t?r:r+e,o.updated_count=i,n=o.moment_count+=e,this.trigger("change:count",n),this},updateLastViewed:function(e){var t;return t=this.get("story"),t.last_viewed!==e?(t.last_viewed=e,this.trigger("change:last_viewed",e)):void 0},updateDates:function(e,t){var i;return i=this.get("story"),i.start_date!==e||i.end_date!==t?(i.start_date=e,i.end_date=t,this.trigger("change:dates",e,t)):void 0},updateStory:function(){return this.get("story").updated=Math.round(Date.now()/1e3),this},getStoryName:function(){return ThisLife.Helper.Stories.getStoryNameFromStoryUid(this.get("story_uid"))},getImageUrl:function(e){var t,i,n,o;return null==e&&(e="x-small"),o=this.get("story"),o&&(t=o.cover_effects_modified_date,n=o.cover_moment_uid,i=o.cover_owner_uid,t&&n&&i)?ThisLife.Helper.Image.imgUrl(n,e,t,i):""},createStory:function(){return new ThisLife.Model.Story({uid:this.get("story_uid"),permission:this,life_uid:ThisLife.lifeUid,avatar_url:this.get("story").avatar_url,name:this.get("story").name,moment_count:0,updated_count:0,moments:"",members:new ThisLife.Collection.StoryFollowers,"public":!1,path:null,notes:[]})},saveStoryPermission:function(e,t){return null==e&&(e={}),null==t&&(t={}),this.set(e),ThisLife.Service.api.shareStory(this.toJSON())},setStoryPermission:function(e){return this.set(e)},deleteStoryPermission:function(){return ThisLife.Service.api.deleteStoryPermission(this.id)},deleteStory:function(){return ThisLife.Service.api.deleteStory(this.get("story_uid"))},isOwner:function(e){return this.get("owner_person_uid")===e}})}.call(this),function(){var e,t,i,n;t=5/4,e=1/t,i=["square","landscape","portrait"],ThisLife.Model.StoryMoment=Backbone.Model.extend({idAttribute:"uid",defaults:function(){return{moment_added_date:0}},getImage:function(e){return ThisLife.Helper.Image.imageUrlDim(this.id,e,this.get("effects_modified_date"),this.get("story_moment_created_by"))},getImageSize:function(e){return ThisLife.Helper.Image.imgUrl(this.id,e,this.get("effects_modified_date"),this.get("story_moment_created_by"))},isSelected:function(e){return e.hasMoment(this)},isVideo:function(){return"video"===this.get("moment_type")},saveHidden:function(e){return this.saveProperty("hidden",{hidden:e},e)},remove:function(){return this.collection.remove(this)},getAspectRatio:function(){var i,n,o;return n=this.get("height"),o=this.get("width"),i=n/o,i>t?"portrait":e>i?"landscape":"square"},isPano:function(){var e,t;return e=this.get("height"),t=this.get("width"),t>=2*e},isGoodCoverImage:function(){var e,t,i,n;return n=this.get("width"),t=this.get("height"),i=n>t,e=n>960,[i,e]},captionAuthorText:function(){var e,t,i,n;return null!=this.authorName?this.authorName:(n=this.get("story_moment_created_by"),e=n===ThisLife.Model.User.id,this.authorName=e?"":(i=ThisLife.currentStory.followers.findPerson(n),i?"by "+i.get("first_name")+" "+i.get("last_name"):(t=ThisLife.currentStory.get("permission").get("name"),"by "+t)))},selectMoment:function(e){return null==e&&(e=!this.selected),this.selected!==e?(this.selected=e,this.trigger("momentSelected",this,this.selected)):void 0},canEdit:function(){return"text"===this.get("moment_type")?!ThisLife.currentStory.isViewOnly()&&this.get("uid"):!!ThisLife.Collection.moments.get(this.id)},isImage:function(){return"image"===this.get("moment_type")},isVideo:function(){return"video"===this.get("moment_type")},rotate:function(e){var t,i;return 90===e||270===e?(t=this.get("height"),i=this.get("width"),this.set({height:i,width:t,effects_modified_date:n()})):180===e?this.set({effects_modified_date:n()}):void 0},crop:function(e){return this.set({height:e.get("height"),width:e.get("width"),effects_modified_date:n()})},filter:function(){return this.set({effects_modified_date:n()})},getTime:function(){return ThisLife.Helper.Date.getTime(this.get("moment_date"))},updateDate:function(e,t){var i;return i=new Date(e+" "+this.getTime()+" GMT"),this.set({moment_date:i.toUnix()},t),i.toUnix()},saveRating:function(e){var t;return this.set({rating:e}),this.saveProperty("rating",{rating:e},e),ThisLife.app.controller("timeline").updateObjects([this.id],{rating:e}),"function"==typeof(t=ThisLife.app.album).updateObjects?t.updateObjects([this.id],{rating:e}):void 0},saveProperty:function(e,t,i){return ThisLife.Service.api.saveMomentsProperty([this.id],e,i).then(function(e){return function(){return e.set(t),ThisLife.Collection.moments.get(e.id).set(t)}}(this))}}),n=function(){return Math.round(Date.now()/1e3)}}.call(this),function(){define("ThisLife.Model.AlbumSort",[],function(){var e;return e=function(){function e(){this.setToByMomentDate()}return e.prototype.setToByMomentDate=function(){return this.momentDirection="normal",this.momentDateAttribute="moment_date",this.momentComparator=function(e){return e.get("moment_date")},this.dateCollectionComparator=function(e){return e.unixDate}},e.prototype.setToByMomentDateReverse=function(){return this.momentDirection="reverse",this.momentDateAttribute="moment_date",this.momentComparator=function(e){return-e.get("moment_date")},this.dateCollectionComparator=function(e){return-e.unixDate}},e.prototype.isByMomentDate=function(){return"moment_date"===this.momentDateAttribute&&"normal"===this.momentDirection},e.prototype.isByMomentDateReverse=function(){return"moment_date"===this.momentDateAttribute&&"reverse"===this.momentDirection},e.prototype.setToByMomentAddedDate=function(){return this.momentDirection="normal",this.momentDateAttribute="moment_added_date",this.momentComparator=function(e){return-e.get("moment_added_date")},this.dateCollectionComparator=function(e){return-e.unixDate}},e.prototype.setToByMomentAddedDateReverse=function(){return this.momentDirection="reverse",this.momentDateAttribute="moment_added_date",this.momentComparator=function(e){return e.get("moment_added_date")},this.dateCollectionComparator=function(e){return e.unixDate}},e.prototype.isByMomentAddedDate=function(){return"moment_added_date"===this.momentDateAttribute},e.prototype.setToByFilename=function(){return this.momentDirection="normal",this.momentDateAttribute="filename",this.momentComparator=function(e){return e.get("filename")},this.dateCollectionComparator=function(e){return e.unixDate}},e.prototype.setToByFilenameReverse=function(){return this.momentDirection="reverse",this.momentDateAttribute="filename",this.momentComparator=function(e){return-e.get("filename")},this.dateCollectionComparator=function(e){return-e.unixDate}},e.prototype.setToByUploadDate=function(){return this.momentDirection="normal",this.momentDateAttribute="upload_date",this.momentComparator=function(e){return e.get("upload_date")},this.dateCollectionComparator=function(e){return e.unixDate}},e.prototype.setToByUploadDateReverse=function(){return this.momentDirection="reverse",this.momentDateAttribute="upload_date",this.momentComparator=function(e){return-e.get("upload_date")},this.dateCollectionComparator=function(e){return-e.unixDate}},e.prototype.toOptions=function(){return{momentComparator:this.momentComparator,dateCollectionComparator:this.dateCollectionComparator,momentDateAttribute:this.momentDateAttribute}},e.prototype.getMomentDate=function(e){return e.get(this.momentDateAttribute)},e}()}),ThisLife.Model.AlbumSort=require("ThisLife.Model.AlbumSort")}.call(this),function(){var e;e=Backbone.Model.extend({idAttribute:"uid",parse:function(e){var t,i,n,o,s;if(e.headers)for(o={},s=e.headers,t=0,n=s.length;n>t;t++)i=s[t],o[i.name]=i.value;else o=e,o.Make||(o.Make=o.Make),o.Model||(o.Model=o.model);return o},url:function(){return"image"===this.get("moment_type")?this.getImageUrl():this.getVideoUrl()},getImageUrl:function(){return ThisLife.Settings.imageExifUrl+"/"+this.getOwner()+"/media/exif/"+this.id+"?origin=thislife-web"},getVideoUrl:function(){return ThisLife.Settings.videoExifUrl+"/"+this.getOwner()+"/"+this.id+".json"},fetch:function(e){var t,i;return null==e&&(e={}),t=this,i=e.success,e.success=function(n,o,s){return t.loaded=!0,t.set(t.parse(n,s),e)?(i&&i(t,n),t.trigger("sync",t,n,e)):!1},e.error=function(i){return t.error=!0,t.trigger("error",t,i,e)},(this.sync||Backbone.sync).call(this,"read",this,e)},getOwner:function(){return ThisLife.Collection.moments.get(this.id)?ThisLife.currentLifeOwner:this.get("owner")}}),ThisLife.Model.ExifData=e}.call(this),function(){var e,t=[].slice;e=APIModel.extend({displayMax:100,initialize:function(){return this.on("sync",this._loadComplete,this)},parse:function(e){var t;return t=this._parseCount(e.result.payload,10),{count:t}},setCount:function(e){return e=this._parseCount(e),this.set("count",e)},hasMoreSuggestions:function(){return this.get("count")>1},hasSuggestions:function(){return this.get("count")>0},decreaseCount:function(){var e;return e=this.get("count")-1,this.set({count:e})},restart:function(){return this.unset("count"),this},getCountToDisplay:function(){var e;return e=this.get("count")||0,e<=this.displayMax?Math.max(e,0):Math.min(e,this.displayMax)+"+"},update:function(e){return this.ignoreUpdates?this.requiresUpdate=!0:this.setCount(e)},whenLoaded:function(){var e,i,n,o,s;return n=arguments[0],o=arguments[1],e=3<=arguments.length?t.call(arguments,2):[],null==o&&(o=this),i=_.bind(n,o),this.loaded?i.apply(null,e):(s=function(t){return function(){return i.apply(null,e),t.off("reset",s,t)}}(this),this.on("reset",s,this))},_parseCount:function(e){return e=parseInt(e,10),e=Math.min(e,this.displayMax)},_loadComplete:function(){return this.loaded=!0,this.trigger("reset")}}),ThisLife.Model.suggestedGroupCount=new e}.call(this),function(){ThisLife.Model.FilterMoments=APIModel.extend({hasPersonTags:function(){return this.get("personTags").length},hasLocationTags:function(){return this.get("locationTags").length},hasMomentTags:function(){return this.get("momentTags").length},getSortedPersonTags:function(){var e;return e=this.get("personTags"),_.sortBy(e,function(e){return e.name.toLowerCase()})},getSortedLocationTags:function(){var e;return e=this.get("locationTags"),_.sortBy(e,function(e){return e.name.toLowerCase()})},getSortedMomentTags:function(){var e;return e=this.get("momentTags"),_.sortBy(e,function(e){return e.name.toLowerCase()})}})}.call(this),function(){ThisLife.Model.Overlimit=function(){function e(){this.model=ThisLife.Model.User,this.model.on("overPlanLimit",this.check,this)}return e.prototype.check=function(){return this._isOverlimit()&&ThisLife.appModel.isOverlimitCheckDateExpired()?(ThisLife.appModel.updateCheckOverlimitDate(),this._setTimeout()):this._isOverlimit()?this._setTimeout():this._clearTimeout(),this},e.prototype._setTimeout=function(){var e,t,i,n;return this._timeout?this:(t=ThisLife.appModel.getOverlimitCheckDate(),t?(e=new Date(t),n=new Date,i=e-n,i=Math.max(i,0),this._timeout=setTimeout(_.bind(this._timeoutHandler,this),i)):void 0)},e.prototype._clearTimeout=function(){return this._timeout?(clearTimeout(this._timeout),delete this._timeout):void 0},e.prototype._timeoutHandler=function(){return this._clearTimeout().check(),this},e.prototype._isOverlimit=function(){return this.model.isCurrentLifeOwner()&&this.model.isOverPlanLimit()},e.prototype._goToUpgrade=function(){return this.model.upgradeIsPossible()&&ThisLife.app.router.navigateToUpgrade(),this},e}()}.call(this),function(){ThisLife.Model.Tag=APIModel.extend({initialize:function(){},parse:function(e){return e.result?e.result.payload:e},changeCount:function(e,t){return null==t&&(t={}),this.count+=e,t.silent||this.trigger("change:count",this,e,t),this},getCount:function(){return this.count||0},getName:function(){return this.get("name")},getNameEscaped:function(){return ThisLife.Helper.String.escapeHtml(this.get("name"))},getNameToLC:function(){return this.get("name").toLowerCase()}})}.call(this),function(){ThisLife.Model.PersonTag=ThisLife.Model.Tag.extend({parse:function(e){var t,i;return e.result?(t=ThisLife.Helper.Image.faceUrl(null!=(i=e.result.payload)?i.face:void 0),t&&(this.faceUrl=t),this.count=0,e.result.payload):(e.icon_url?(this.faceUrl=e.icon_url,t=this.parseFace(this.faceUrl)):e.face&&(this.faceUrl=this.setFaceUrl(e.face),t=this.getFaceUid(e.face)),this.count=e.moment_count,{email:e.email,face:t,facebook_uid:e.facebook_uid,name:e.name,uid:e.uid,is_vip:!!e.is_vip,birth_month:e.birth_month,birth_date:e.birth_date,birth_year:e.birth_year,relationship_type_uid:e.relationship_type_uid||null})},parseFace:function(e){var t;return t=e.match(/face\/\d*\/image\/((?:\w|-)*).jpg/),t?t[1]:null},defaults:function(){return{_explicitType:"PersonTag",email:null,face:null,icon_url:null,facebook_uid:null,name:"",life_uid:ThisLife.lifeUid,is_vip:!1,birth_month:null,birth_date:null,birth_year:null}},initialize:function(){return this.on("change:face",this.changeFaceUrl,this).on("change:name",this.deleteContacts,this).on("change:icon_url",this.changeIconUrl,this)},getDefaultFaceUrl:function(){return ThisLife.Helper.String.removeProtocolFromUrl(this.faceUrl||(this.faceUrl=this.setFaceUrl()))},setFaceUrl:function(e){var t,i;return null==e&&(e=this.get("face")),_.isObject(e)?this.hasCoords(e)?this.faceUrl=ThisLife.Helper.Image.faceUrl(this.getFaceUid(e)):(i=this.getFaceMomentUid(e),t=ThisLife.Collection.moments.get(i),this.faceUrl=t?t.getImageSize("x-small"):ThisLife.Helper.Image.imgUrl(i,"x-small",Date.now(),ThisLife.currentLifeOwner)):this.faceUrl=(null!=e?e.indexOf("http://"):void 0)>=0||(null!=e?e.indexOf("https://"):void 0)>=0?e:ThisLife.Helper.Image.faceUrl(e)},changeFaceUrl:function(e,t){return this.setFaceUrl(t)},changeIconUrl:function(e,t){return this.setFaceUrl(t)},hasCoords:function(e){return null!==e.center_x},getFaceMomentUid:function(e){return e.moment_uid},getFaceUid:function(e){return null==e&&(e=this.get("face")),e.uid||e},deleteContacts:function(){return delete ThisLife.Collection.contacts},getFaces:function(e){var t;return t=this.id,ThisLife.Service.api.getPersonTags(t,"faces",function(i){var n,o,s;return i.length?(o=i.first(),n=o.get("faces"),s=o.get("relationship")||{},s.is_vip=o.get("is_vip"),s.bday_month=o.get("birth_month"),s.bday_date=o.get("birth_date"),s.bday_year=o.get("birth_year")):(ThisLife.Collection.personTags.remove(t),delete ThisLife.Collection.contacts,n=[],s=null),e(n,s)})},hasRelationship:function(){return null!=this.get("relationship_type_uid")},hasFullBirthdate:function(){var e;return e=ThisLife.Helper.Date.formatBirthdate(this.get("birth_month"),this.get("birth_date"),this.get("birth_year")),null!=e&&""!==e},getRelationshipOnly:function(e){var t;return t=this.id,ThisLife.Service.api.getPersonTags(t,"",function(t){return e(t)})},getEmail:function(){return this.escape(this.get("email"))},getBirthdate:function(){var e;return e=ThisLife.Helper.Date.formatBirthdate(this.get("birth_month"),this.get("birth_date"),this.get("birth_year")),e||"Enter Birthday"},hasBirthdate:function(){var e;return e=ThisLife.Helper.Date.formatBirthdate(this.get("birth_month"),this.get("birth_date"),this.get("birth_year")),e?!0:!1},getBirthdateForSort:function(){var e;return e="",e+=null!==this.get("birth_year")?this.get("birth_year"):"0",e+=null!==this.get("birth_month")?this.get("birth_month"):"0",e+=null!==this.get("birth_date")?this.get("birth_date"):"0"},destroy:function(e){return ThisLife.Service.api.deletePersonTags(this.id,function(t){return function(i,n){return(t.collection||ThisLife.Collection.personTags).remove(t),e(i,n)}}(this))},deleteFaces:function(e){return this.collection.deleteFaces(e)},removeFaces:function(e,t){return this.updateFaces(null,null,e,t)},excludeFaces:function(e,t){return this.updateFaces(null,e,null,t)},removeNamedFace:function(e,t){return this.removeFaces([e],t)},save:function(e,t,i,n){return null==n&&(n=null),this.set(e,t,i),ThisLife.Service.api.savePersonTagBeta(this.toJSON(),null,n)
},mergeWith:function(e){return this.collection.merge(this,e),this},updateFaces:function(e,t,i,n){var o;return o=function(e){return function(t,i){return(e.collection||ThisLife.Collection.personTags).deleteFacesCallback(t,i),"function"==typeof n?n(t,i):void 0}}(this),ThisLife.Service.api.updatePersonTagFaces(this.id,e,t,i,o)},createCanvas:function(e,t,i){var n,o,s,r,l,a,u,c,d;return null==t&&(t="x-small"),null==i&&(i=74),e&&e.moment_uid?(c=e.center_x,d=e.center_y,s=e.height,u=e.width,a=e.moment_uid,n=document.createElement("canvas"),n.height=n.width=i,o=n.getContext("2d"),l=ThisLife.Collection.moments.get(a).getImageSize(t),r=new Image,r.onload=function(){var e,t,n,l;return n=r.naturalHeight,l=r.naturalWidth,e=s/100*n,t=e/2,c=c*l/100-t,d=d*n/100-t,o.drawImage(r,c,d,e,e,0,0,i,i)},r.src=l,n):void 0}})}.call(this),function(){var e,t,i,n,o;e=ThisLife.Model.PersonTag.extend({defaults:{},numSuggestions:24,parse:function(e){var o,s,r,l,a;if(l=e.result.payload){for(a=l.faces,s=0,r=a.length;r>s;s++)o=a[s],n(o);return"unnamed"===l.type?t(l):"named"===l.type&&i(l),l}},parseFromModel:function(e){var t;return t={},t.result={},t.result.payload=e,this.set(this.parse(t)),this},idAttribute:"key",isNamed:function(){return"named"===this.get("type")},getFirstFaceUid:function(e){var t;return null==e&&(e=[]),e===!0&&e.length>0?e[0]:null!=(t=this.get("faces")[0])?t.uid:void 0},getSeedFaceUrl:function(){return ThisLife.Helper.Image.faceUrl(this.getFirstFaceUid())},getPersonTagFace:function(){return this.get("person_tag").face},setPersonTagFace:function(e){return null==e&&(e=[]),this.get("person_tag").face=this.getFirstFaceUid(e)},getPersonTagName:function(){return this.get("person_tag").name||""},changeSeed:function(){var e,t,i;return this.hasMoreSuggestions()?(e=this.get("faces"),i=e.splice(0,1)[0],e.splice(24,0,i),t=e[0],this.trigger("change:seedFace",this,t,{prevSeedFace:i})):void 0},getAvailableSuggestionsLength:function(){return this.get("faces").length},hasMoreSuggestions:function(){return!!this.getAvailableSuggestionsLength()},ignoreFaces:function(e,t){return e.push(this.getFirstFaceUid()),this.updatePersonTagFaces(null,null,e,t)},updateFaces:function(e,t,i){return this.getPersonTagFace()!==this.getFirstFaceUid(e)&&this.setPersonTagFace(e),this.updatePersonTagFaces(e,t,null,i),this.updateSuggestedFaces()},updateTaggedFaces:function(e){var t,i,n,o,s,r;for(e=_.isArray(e)?e:[e],n=this.get("faces"),r=0,o=0,s=e.length;s>o;o++)i=e[o],t=_.find(n,function(e){return e.uid===i}),t.tagged||(r++,t.tagged=!0);return this.trigger("update_tagged",this,r)},updatePersonTagFaces:function(e,t,i,n){return null==e&&(e=[]),null==t&&(t=[]),null==i&&(i=[]),e.length||t.length||i.length?ThisLife.Service.api.updatePersonTagFaces(this.id,e,t,i,n):"function"==typeof n&&n(),this.updateTaggedFaces(e)},updateSuggestedFaces:function(){return this.get("faces").splice(0,this.numSuggestions)},setPersonTag:function(e){return this.set({key:e.uid,person_tag:{uid:e.uid,life_uid:e.life_uid,name:e.name,email:e.email,face:e.face,facebook_uid:e.facebook_uid,birth_month:e.birth_month,birth_date:e.birth_date,birth_year:e.birth_year}})},saveNewPersonTag:function(e,t){return this.setPersonTag(e),ThisLife.Service.api.savePersonTagBeta(e,null,function(i){return function(n){return i.updateTaggedFaces(e.face),e.id||i.updateUid(n.id),"function"==typeof t?t():void 0}}(this))},updateUid:function(e){var t;return t=this.get("person_tag"),t.uid=e,this.set({key:e,person_tag:t}),this},updateSuggestedPerson:function(e,t,i){var n,o,s;return s=null,e&&(s=e.uid),s?this.setSuggestionToExistingPersonTag(s,e,i):(n=ThisLife.Collection.personTags.findName(t))?this.setSuggestionToExistingPersonTag(n.id,e,i):(e=e||{},e.value=t,o=function(n){return function(){var o;return o=ThisLife.Collection.personTags.findName(t),o.count=e.count||0,o.trigger("count_changed"),n.trigger("rerender",n),null!=i?i.apply(null,arguments):void 0}}(this),this.setSuggestionToNewPersonTag(e,o))},setSuggestionToNewPersonTag:function(e,t){var i,n;return n="",i={uid:n,life_uid:this.get("life_uid"),name:e.value,email:e.email||"",face:(null!=e?e.faceUid:void 0)||this.getFirstFaceUid(),facebook_uid:e.facebookUid,count:(null!=e?e.count:void 0)||0,birth_month:e.birth_month,birth_date:e.birth_date,birth_year:e.birth_year},this.saveNewPersonTag(i,t)},setSuggestionToExistingPersonTag:function(e,t,i){var n,o;return n=ThisLife.Collection.personTags.get(e),o={uid:n.id,life_uid:n.get("life_uid"),name:n.get("name"),email:n.get("email"),face:(null!=t?t.faceUid:void 0)||this.getFirstFaceUid(),facebook_uid:n.get("facebook_uid"),birth_month:n.get("birth_month"),birth_date:n.get("birth_date"),birth_year:n.get("birth_year")},this.getPersonTagFace()===this.getFirstFaceUid()?(this.setPersonTag(o),"function"==typeof i?i():void 0):(this.setPersonTag(o),"function"==typeof i?i():void 0)},removeFaceFromPersonTag:function(e){var t,i;return i=ThisLife.Collection.personTags.get(this.id),t=this.getPersonTagFace(),i.excludeFaces(t,e)},saveCoverToPersonUid:function(){var e,t;return e=this.getFirstFaceUid(),t={uid:e,person_tag_uid:this.id},this.updatePersonTagFaces([e],null,null,function(t){return function(){return t.updateTaggedFaces(e),t.trigger("rerender",t)}}(this))},hasMomentUid:function(e){var t;return t=this.get("faces"),_.some(t,function(t){return t.moment_uid===e})},removeMomentUid:function(e){var t,i,n,o,s,r;if(this.hasMomentUid(e)){for(n=this.get("faces"),r={keep:[],remove:[]},o=0,s=n.length;s>o;o++)i=n[o],t=i.moment_uid===e?"remove":"keep",r[t].push(i);return this.set("faces",r.keep),r}return!1}}),ThisLife.Model.SuggestedPersonModel=e,n=function(e){return e.uid=e.id,e.moment_uid=e.imageId.toString(),e},t=function(e){var t;return t=ThisLife.Collection.personTags.get(e.key),t?o(e,t):void 0},i=function(e){var t;return t=ThisLife.Collection.personTags.get(e.key),t?void 0:(ThisLife.log.warn("Named suggestion "+e.key+" is an unknown person tag"),e.type="unnamed",e.person_tag=e.key)},o=function(e,t){return ThisLife.log.warn("Unnamed suggestion "+e.key+" is a known person tag"),e.type="named",e.person_tag={_explicitType:"PersonTag",uid:e.key,life_uid:ThisLife.lifeUid,name:t.get("name"),email:t.get("email"),face:t.getFaceUid(),facebook_uid:t.get("facebook_uid"),birth_month:t.get("birth_month"),birth_date:t.get("birth_date"),birth_year:t.get("birth_year")}}}.call(this),function(){var e=[].indexOf||function(e){for(var t=0,i=this.length;i>t;t++)if(t in this&&this[t]===e)return t;return-1};ThisLife.Model.LocationTag=ThisLife.Model.Tag.extend({defaults:{moment_uids:[],location_taggings:[],_explicitType:"LocationTag"},parse:function(e){return e.result?(this.count=0,e.result.payload):(this.count=e.moment_count,{lat:e.latitude,"long":e.longitude,name:e.name,uid:e.uid,country_code:e.country})},initialize:function(){var e;return this.updateTaggings=[],this.has("name")?void 0:(e=this.get("city")||this.get("state")||"Unknown",this.set({name:e},{silent:!0}))},updateName:function(e){var t,i;return i=this.get("long"),t=this.get("lat"),this.set("name",e),ThisLife.Service.api.saveLocationTag(e,i,t,this.id)},getStaticMap:function(e,t){return"https://maps.googleapis.com/maps/api/staticmap?center="+e+","+t+"&key="+ThisLife.Settings.googleMapsApi},createTaggings:function(e,t){var i,n,o,s,r,l;for(s=!1,i=0,n=e.length;n>i;i++)l=e[i],this.hasTagging(l)||(s=!0,o={moment_uid:l,location_tag_uid:this.id},r=new ThisLife.Helper.LocationTagging(o),this.updateTaggings.push(r),this.addTagging(r));return!t&&s&&this.saveTaggings(),s},hasTagging:function(e){var t;return t=this.getTaggings(),_.find(t,function(t){return t.moment_uid===e})},getTaggings:function(){return _.clone(this.get("location_taggings")||[])},addTagging:function(e){var t,i;return t=this.getTaggings(),i=_.pluck(t,"uid"),e&&!_.include(i,e.uid)&&t.push(e),this.set({location_taggings:t})},saveTaggings:function(){return ThisLife.Service.api.saveLocationTagWithTaggings(this,this.updateTaggings),this.updateTaggings.length=0},updateMomentUids:function(e){var t,i,n,o,s;for(e=_.isArray(e)?e:[e],i=0,n=e.length;n>i;i++)o=e[i],this.collection.clearMomentUid(o,this);return t=_.clone(this.get("moment_uids")),s=_.union(t,e),this.set({moment_uids:s})},deleteMomentUid:function(e){var t,i;return t=this.get("moment_uids"),i=_.clone(_.without(t,e)),this.set({moment_uids:i})},contains:function(e){var t;return t=this.get("moment_uids"),_.include(t,e)},addLocationTaggings:function(e){var t,i,n;return t=this.id,this.updateMomentUids(e),i=function(){var i,o,s;for(s=[],i=0,o=e.length;o>i;i++)n=e[i],s.push({moment_uid:n,location_tag_uid:t,user_approved:!0,uid:$.Guid.New().toLowerCase()});return s}()},addLocationTagging:function(e){return this.addLocationTaggings([e])},getFMVLocation:function(){return this.get("name")},verifyTaggings:function(e){var t,i,n,o;for(n=[],t=0,i=e.length;i>t;t++)o=e[t],n.push(this.addTagging(o));return n},deleteTaggingsForMomentUids:function(t){var i,n,o,s,r,l,a;for(l=this.getTaggings(),o=_.filter(l,function(i){var n;return n=i.moment_uid,e.call(t,n)>=0}),s=[],i=0,n=o.length;n>i;i++)r=o[i],a=r.uid,this.removeTagging(r),s.push(ThisLife.Service.api.deleteLocationTagging(a));return s},removeTagging:function(e){var t,i;return i=this.getTaggings(),t=_.indexOf(i,e),t>=0&&i.splice(t,1),this.set({location_taggings:i}),e}})}.call(this),function(){var e,t,i=[].indexOf||function(e){for(var t=0,i=this.length;i>t;t++)if(t in this&&this[t]===e)return t;return-1};e=ThisLife.Model.Tag.extend({parse:function(e){return e.result?(this.count=0,e.result.payload):(this.count=e.moment_count,{name:e.name,cover_moment_uid:e.cover_moment_uid,uid:e.uid,updated:e.updated})},defaults:function(){return{_explicitType:"MomentTag",life_uid:ThisLife.lifeUid,name:"",uid:$.Guid.New().toLowerCase(),moment_taggings:[],updated:t()}},initialize:function(){return this.on("change:name change:moment_taggings",this.updateTimestamp,this),this.updateTaggings=[]},updateTimestamp:function(){return this.set("updated",t())},save:function(){return this.saveTaggings()},updateName:function(e,t){var i,n;return i=this.toJSON(),i.name=e,n=function(t){return function(){return t.set("name",e)}}(this),ThisLife.Service.api.saveMomentTag(i,null,n,t)},verifyTaggings:function(e){var t,i,n,o;for(n=[],t=0,i=e.length;i>t;t++)o=e[t],n.push(this.addTagging(o));return n},createTaggings:function(e){var t,i,n,o,s;return n=!1,t=function(){var t,r,l;for(l=[],t=0,r=e.length;r>t;t++)s=e[t],this.hasTagging(s)||(n=!0,i={moment_uid:s,moment_tag_uid:this.id},o=new ThisLife.Helper.MomentTagging(i),this.updateTaggings.push(o),this.addTagging(o),l.push(o));return l}.call(this),n&&this.saveTaggings(),t},hasTagging:function(e){var t;return t=this.getTaggings(),_.find(t,function(t){return t.moment_uid===e})},addTagging:function(e){var t,i;return t=this.getTaggings(),i=_.pluck(t,"uid"),e&&!_.include(i,e.uid)&&t.push(e),this.set({moment_taggings:t})},saveTaggings:function(){return ThisLife.Service.api.saveMomentTag(this.toJSON(),this.updateTaggings),this.updateTaggings=[]},getTaggings:function(){return _.clone(this.get("moment_taggings"))||[]},removeTagging:function(e,t){var i,n;return n=this.getTaggings(),i=_.indexOf(n,e),i>=0&&n.splice(i,1),n.length>0&&this.set({moment_taggings:n}),t&&ThisLife.Service.api.deleteMomentTaggings([e.uid]),e},deleteTaggingsForMomentUids:function(e){var t,n,o,s,r;return s=this.getTaggings(),t=_.filter(s,function(t){var n;return n=t.moment_uid,i.call(e,n)>=0}),n=function(){var e,i,n;for(n=[],e=0,i=t.length;i>e;e++)o=t[e],r=o.uid,this.removeTagging(o,!1),n.push(r);return n}.call(this),ThisLife.Service.api.deleteMomentTaggings(n)},getTagging:function(e){var t,i;return i=this.getTaggings(),t=_.find(i,function(t){return t.uid===String(e)})},removeTaggingByUid:function(e){var t;return t=this.getTagging(e),t?this.removeTagging(t,!0):void 0},requestTaggings:function(e){return ThisLife.Service.api.filterMomentsResults({activityTag:[this.id]},function(t){var i;return i=t.get("moments"),e(i)})}}),ThisLife.Model.MomentTag=e,t=function(){return Math.round(Date.now()/1e3).toString()}}.call(this),function(){ThisLife.Model.MetricsLogger=APIModel.extend({idAttribute:"uid",defaults:function(){return{action:null,personUid:null,lifeUid:null,source:null}},initialize:function(e,t){return assert(void 0!==t,"metrics logger values are empty"),void 0!==t.action&&this.set("action",t.action),void 0!==t.personUid&&this.set("personUid",t.personUid),void 0!==t.lifeUid&&this.set("lifeUid",t.lifeUid),void 0!==t.source?this.set("source",t.source):void 0},setAction:function(e){return this.set("action",e)},log:function(){return ThisLife.Service.api.saveLogging(this.toJSON()),this.clean()},clean:function(){var e,t;t=[];for(e in this.attributes)t.push("personUid"!==e&&"lifeUid"!==e&&"url"!==e&&"source"!==e&&"action"!==e?this.attributes[e]=null:void 0);return t}}),ThisLife.Model.LogPeopleSuggestions=ThisLife.Model.MetricsLogger.extend({defaults:function(){return{source:"PeopleSuggestions",action:null,personUid:null,lifeUid:null,suggestionIndex:null,numOfSuggestions:null,newPerson:null,suggestionSize:null,tagCount:null,excludeCount:null,suggestionId:null,faceDetected:!0,nameCorrect:""}},setDefaultParams:function(e,t,i,n){return this.set("numOfSuggestions",e),this.set("suggestionIndex",t),this.set("suggestionSize",i),this.set("suggestionId",n)},setCounts:function(e,t){return this.set("tagCount",e),this.set("excludeCount",t),this.set("suggestionSize",e+t)},setNameWasCorrect:function(e){return this.set("nameCorrect",e)},setIsNewPerson:function(e){return this.set("newPerson",e)},setAction:function(e){return this.set("action",e),"ignore"===e||"close"===e||"skip"===e?(this.setIsNewPerson(""),this.setNameWasCorrect("")):void 0}}),ThisLife.Model.LogEditPerson=ThisLife.Model.MetricsLogger.extend({defaults:function(){return{source:"EditPerson",action:null,personUid:null,lifeUid:null,excludeCount:null}},setExcludeCount:function(e){return this.set("excludeCount",e)}}),ThisLife.Model.LogFMV=ThisLife.Model.MetricsLogger.extend({defaults:function(){return{source:"FullMomentView",action:null,personUid:null,lifeUid:null,faceDetected:null,newPerson:null,momentId:null,tagCount:null,excludeCount:null}},setMomentId:function(e){return this.set("momentId",e)},setFaceDetected:function(e){return this.set("faceDetected",e)},setNewPerson:function(e){return this.set("newPerson",e)},setTagCount:function(e){return this.set("tagCount",e)},setExcludeCount:function(e){return this.set("excludeCount",e)}})}.call(this),function(){var e,t,i;t=15,i=1,e=Backbone.Model.extend({defaults:{showHidden:!1,showRecentUploads:!1,showFavorites:!1,ratingFilterMask:t,momentTypes:"both",disabled:!1},initialize:function(){return this.showHidden=this.defaults.showHidden,this.showFavorites=this.defaults.showFavorites,this.showRecentUploads=this.defaults.showRecentUploads,this.ratingFilterMask=this.defaults.ratingFilterMask,this.momentTypes=this.defaults.momentTypes},scanUploadDates:function(e){var t;return t=[],e.each(function(e){var n,o,s;for(n=ThisLife.Helper.Date.getUTCString(e.get("upload_date"),!1),o=s=0;3>=s;o=++s){if(o>=t.length){t.push(n);break}if(n===t[o])break;if(n<t[o]){t.splice(o,0,n);break}}return t.length>i?t.shift():void 0}),ThisLife.log.debug("Recent Uploads filtered to: ",t),this.uploadDates=t}}),_.extend(e,{RATED_ZERO_BIT:1,RATED_ONE_BIT:2,RATED_TWO_BIT:4,RATED_THREE_BIT:8,RATED_ALL:t}),ThisLife.Model.Filter=e}.call(this),function(){var e,t,i,n,o,s,r,l=[].indexOf||function(e){for(var t=0,i=this.length;i>t;t++)if(t in this&&this[t]===e)return t;return-1},a={}.hasOwnProperty,u=[].slice;r=1,s=2,i=3,o=9,t=10,n=12,e=APIModel.extend({_systemFolderCollection:null,_albumsByFolderId:{},folderCollection:null,albumCollection:null,maxAlbumTitleLength:50,maxFolderTitleLength:25,initialize:function(){return this.on("reset",_.bind(this.bindCallbacks,this))},bindCallbacks:function(){return this.folderCollection.on("change:sort_option",this._updateSort,this),this._systemFolderCollection.on("change:sort_option",this._updateSort,this)},getFolderCollection:function(){return this.folderCollection},getFolderByName:function(e){var t,i;return t=this.folderCollection.filter(function(t){return t.get("name")===e}),i=this._systemFolderCollection.filter(function(t){return t.get("name")===e}),t.length>0?t[0]:i.length>0?i[0]:!1},getLifetouchFolder:function(){return this._lifetouchFolder},getDefaultFolder:function(){var e,t,i,n;for(n=this.getFolderCollection().models,t=0,i=n.length;i>t;t++)if(e=n[t],e.get("default"))return e;return null},getActiveFolderId:function(){return this._activeFolderId},setActiveFolderId:function(e){return this._activeFolderId="suggested"===e||"friends"===e||e===ThisLife.Model.Albums.Master.getLifetouchFolderId()||ThisLife.Model.Albums.Master.getFolderById(e)?e:null},_resetActiveFolderId:function(e){var t;return this._activeFolderId===e||"suggested"===this._activeFolderId&&0===this.getAutoAlbums().models.length||"friends"===this._activeFolderId&&0===this.getSharedAlbums().models.length||this._activeFolderId===(null!=(t=this._lifetouchFolder)?t.id:void 0)&&0===this.getLifetouchAlbums().models.length?this._activeFolderId=null:void 0},getAllAlbums:function(){return this.albumCollection},getSharedAlbums:function(){return this.getAlbumsByFolderId(this._sharedFolder.id)},getAutoAlbums:function(){return this.getAlbumsByFolderId(this._autoFolder.id)},getLifetouchAlbums:function(){return this._lifetouchFolder?this.getAlbumsByFolderId(this._lifetouchFolder.id):new ThisLife.Collection.AlbumsCollection},getLifetouchFolderId:function(){var e;return null!=(e=this._lifetouchFolder)?e.id:void 0},getAlbumsByFolderId:function(e){var t,i;return e+="",null==this._albumsByFolderId[e]&&(i=this.folderCollection.get(e),i||(i=this._systemFolderCollection.get(e)),t=this._albumsByFolderId[e]=new ThisLife.Collection.AlbumsCollection,t.add(this.albumCollection.filter(function(t){return t.get("folder_uid")===e})),t.setSort(i.get("sort_option"))),this._albumsByFolderId[e]},getAlbumByName:function(e){var t,i,n,o;for(o=this.albumCollection.models,i=0,n=o.length;n>i;i++)if(t=o[i],t.get("name")===e)return t;return null},getAlbumByCoverMomentId:function(e){var t;return this.albumCollection?t=_.find(this.albumCollection.models,function(t){return t.attributes.cover_moment_uid===e}):!1},getOwnerAlbums:function(){var e,t,i;return i=this._ownerFolder.id,null==this._albumsByFolderId[i]&&(t=[this._sharedFolder.id,this._autoFolder.id],e=this._albumsByFolderId[i]=new ThisLife.Collection.AlbumsCollection,e.add(this.albumCollection.filter(function(e){var i;return i=e.get("folder_uid"),l.call(t,i)<0&&null!==e.get("folder_uid")})),e.setSort(this._ownerFolder.get("sort_option"))),this._albumsByFolderId[i]},getAllSort:function(){return this._allFolder.get("sort_option")},getOwnerSort:function(){return this._ownerFolder.get("sort_option")},getSharedSort:function(){return this._sharedFolder.get("sort_option")},getAutoSort:function(){return this._autoFolder.get("sort_option")},setAllSort:function(e){return this._allFolder.setSort(e)},setOwnerSort:function(e){return this._ownerFolder.setSort(e)},setSharedSort:function(e){return this._sharedFolder.setSort(e)},setAutoSort:function(e){return this._autoFolder.setSort(e)},getFolderById:function(e){var t,i;return t=null!=(i=this.folderCollection)?i.get(e):void 0,t||(t=this.getLifetouchFolder()),t},setFolderSort:function(e){return this.folderCollection.setSort(e)},createFolder:function(e,t){var i;if(this.getFolderByName(e))throw"DUPLICATE_FOLDER_NAME";return i=function(i){return function(n){var o;return o=i.getDefaultFolderObject(),o.name=e,o.uid=n.uid,i.handleFolderCreate(o),"function"==typeof t?t(o.uid):void 0}}(this),ThisLife.Service.api.saveFolder({name:e},i),!0},saveFolder:function(e,t){var i,n;if((i=this.getFolderByName(e.name))&&i.get("uid")!==e.uid)throw"DUPLICATE_FOLDER_NAME";return n=function(i){return function(){return i.handleFolderUpdate(e),"function"==typeof t?t():void 0}}(this),ThisLife.Service.api.saveFolder(e,n),!0},deleteFolder:function(e,t){var i;if(i=this.folderCollection.get(e),!i)return"function"==typeof t&&t(),!0;if(i.get("default"))throw"CANNOT_DELETE_SYSTEM_FOLDER";return ThisLife.Service.api.deleteFolder(e,t),!0},_updateSort:function(e){return e.id===this._allFolder.id?this.albumCollection.setSort(e.get("sort_option")):null!=this._albumsByFolderId[e.id]?this._albumsByFolderId[e.id].setSort(e.get("sort_option")):void 0},getAlbumById:function(e){var t;return null!=(t=this.albumCollection)?t.get(e):void 0},getLastUsedAlbum:function(){var e,t;return e=null,t=0,this.albumCollection.each(function(i){return i.isViewOnly()?void 0:(i.get("created")>t&&(e=i,t=i.get("created")),i.get("add_remove_moment_date")>t?(e=i,t=i.get("add_remove_moment_date")):void 0)}),e},createAlbum:function(e,t,i){var n,o,s,r,l;if(null==t&&(t={}),n=this.getDefaultAlbumObject(),n.name=e,s={},null!=t.folder_uid){if(s.uid=t.folder_uid,o=this.getAlbumsByFolderId(t.folder_uid),r=o.filter(function(t){return t.get("name")===e}),r.length>0)throw"DUPLICATE_ALBUM_NAME"}else{if(!t.folder_name)throw"CREATE_ALBUM_REQUIRES_FOLDER";if(s.name=t.folder_name,this.getFolderByName(t.folder_name))throw"DUPLICATE_FOLDER_NAME"}return l=function(e){return function(o){var r;return t.folder_name&&(s=e.getDefaultFolderObject(),s.name=t.folder_name,s.uid=o.folder_uid,e.handleFolderCreate(s)),_.extend(o,n),o.sort_option="moment_date:asc",o.view_mode="grid",o.moment_count=0,o.visible_moment_count=0,r=e.handleAlbumCreate(o),"function"==typeof i?i(o.uid):void 0}}(this),ThisLife.Service.api.saveAlbum(n,s,l),!0},saveAlbum:function(e,t){var i,n;if(i=this.getAlbumsByFolderId(e.folder_uid),n=i.filter(function(t){return t.get("name")===e.name&&t.get("uid")!==e.uid&&t.isOwner(ThisLife.currentLifeOwner)}),n.length>0)throw"DUPLICATE_ALBUM_NAME";return ThisLife.Service.api.saveAlbum(e,null,function(i){return function(){return i.handleAlbumUpdate(e),"function"==typeof t?t():void 0}}(this)),!0},moveAlbum:function(e,t,i){var n;return n={uid:e,folder_uid:t},ThisLife.Service.api.moveAlbum(e,t,function(t){return function(){return t.handleAlbumUpdate(n),"function"==typeof i?i(t.albumCollection.get(e)):void 0}}(this)),!0},copyAlbum:function(e,t,i){var n,o,s;return n=this.getAlbumById(e),o=function(e){return function(o){var s,r;return r=e.getDefaultAlbumObject(),r.uid=o.uid,r.folder_uid=t,r.name=n.get("name"),r.sort_option="moment_date:asc",r.view_mode="grid",r.moment_count=0,r.recently_copied=!0,r.visible_moment_count=0,s=e.handleAlbumCreate(r),s.addPendingUploads(_.pluck(_.filter(n.moments,function(e){return!e.hidden}),"uid")),"function"==typeof i?i(s):void 0}}(this),s=function(){return function(){return ThisLife.Service.api.copyAlbum(e,t,o)}}(this),n.moments?s():n.load(s),!0},saveAlbumPermission:function(e,t){return ThisLife.Service.api.saveAlbumPermission(e,t),!0},deleteAlbum:function(e,t){var i;if(i=this.albumCollection.get(e),!i)return"function"==typeof t&&t(),!0;if(i.get("default"))throw"CANNOT_DELETE_MY_ALBUM";return i.isFriendsAlbum()?ThisLife.Service.api.deleteAlbumPermission(i.get("permission.uid"),t):ThisLife.Service.api.deleteAlbum(e,t),!0},getDefaultAlbumObject:function(){return{life_uid:ThisLife.lifeUid,facebook_sharing:0,twitter_sharing:0,tumblr_sharing:0}},getDefaultFolderObject:function(){return{"default":0,folder_type:1,hidden:!1,life_uid:ThisLife.lifeUid,sort_option:"modified_date:desc"}},handleFolderCreate:function(e){var t;if(this.loaded)return e.uid=e.uid+"",t=this.folderCollection.get(e.uid),t?this.handleFolderUpdate(e):(e.album_count=this.albumCollection.filter(function(t){return t.get("folder_uid")===e.uid}).length,t=new ThisLife.Model.Albums.Folder,t.set(e),this.folderCollection.add(t))},handleFolderDelete:function(e){var t;if(this.loaded)return t=this.folderCollection.get(e),t?(this.folderCollection.remove(t),delete this._albumsByFolderId[e],this._resetActiveFolderId(e)):void 0},handleFolderUpdate:function(e){var t;if(this.loaded)return t=this._systemFolderCollection.get(e.uid),t||(t=this.folderCollection.get(e.uid)),t?(delete e.uid,t.set(e)):this.handleFolderCreate(e)},handleAlbumCreate:function(e){var t;if(this.loaded)return t=this.albumCollection.get(e.uid),t?this.handleAlbumUpdate(e):(_.extend(e,{"permission.accepted":!0,"permission.blocked":!1,"permission.default":!1,"permission.email_shared_with":null,"permission.facebook_sharing":!1,"permission.follow":!0,"permission.ignored":!1,"permission.person_uid":ThisLife.Model.User.id,"permission.owner_person_uid":ThisLife.Model.User.id,"permission.story_uid":e.uid,"permission.tumblr_sharing":!1,"permission.twitter_sharing":!1,"permission.view_only":!1}),null==e.created&&(e.created=Math.floor((new Date).getTime()/1e3)),null==e.updated&&(e.updated=e.created),t=new ThisLife.Model.Albums.Album,t.set(e),this.albumCollection.add(t),this._albumsByFolderId.hasOwnProperty(this._ownerFolder.id)||this.getAlbumsByFolderId(this._ownerFolder.id),this._albumsByFolderId.hasOwnProperty(e.folder_uid)||this.getAlbumsByFolderId(e.folder_uid),this.handleAddAlbumToFolder(e.folder_uid,t))},handleAlbumDelete:function(e){var t;if(this.loaded)return t=this.albumCollection.get(e),t?(this.albumCollection.remove(t),this.handleRemoveAlbumFromFolder(t.get("folder_uid"),t)):void 0},handleAlbumUpdate:function(e){var t,i,n,o;if(this.loaded)return null==e.folder_uid&&delete e.folder_uid,e.uid===(null!=(o=this._myStory)?o.id:void 0)&&(delete e.uid,this._myStory.set(e),this._myStory.get("moment_count")>0&&(i=this.getFolderById(this._myStory.get("folder_uid")))&&(this.albumCollection.add(this._myStory),this.handleAddAlbumToFolder(this._myStory.get("folder_uid"),this._myStory),this._myStory=null)),t=this.albumCollection.get(e.uid),t&&(n=t.get("folder_uid"),delete e.uid,t.set(e),null!=e.folder_uid&&e.folder_uid!==n)?(this.handleRemoveAlbumFromFolder(n,t),this.handleAddAlbumToFolder(e.folder_uid,t)):void 0},handleAddAlbumToFolder:function(e,t){var i;return this._albumsByFolderId.hasOwnProperty(e)&&this._albumsByFolderId[e].add(t),i=this.getFolderById(e),null!=i&&i.set("album_count",i.get("album_count")+1),this._albumsByFolderId.hasOwnProperty(this._ownerFolder.id)&&e!==this._sharedFolder.id&&e!==this._autoFolder.id?this._albumsByFolderId[this._ownerFolder.id].add(t):void 0},handleRemoveAlbumFromFolder:function(e,t){var i,n;return this._albumsByFolderId.hasOwnProperty(e)&&this._albumsByFolderId[e].remove(t),i=this.getFolderById(e),null!=i&&i.set("album_count",i.get("album_count")-1),n=[this._sharedFolder.id,this._autoFolder.id],this._lifetouchFolder&&n.push(this._lifetouchFolder.id),this._albumsByFolderId.hasOwnProperty(this._ownerFolder.id)&&l.call(n,e)<0&&this._albumsByFolderId[this._ownerFolder.id].remove(t),l.call(n,e)>=0?this._resetActiveFolderId():void 0},handleInviteCreate:function(e){var t,i,n,o,s;if(i=ThisLife.Helper.String.escapeHtml(e.story.name),e.owner_first_name?(i+=" by "+ThisLife.Helper.String.escapeHtml(e.owner_first_name),e.owner_last_name&&(i+=" "+ThisLife.Helper.String.escapeHtml(e.owner_last_name))):e.owner_name&&(i+=" by "+ThisLife.Helper.String.escapeHtml(e.owner_name)),ThisLife.notification("You were invited to follow "+i,5e3,null,!0),this.loaded){o=e.story,o.folder_uid=this._sharedFolder.id;for(n in e)a.call(e,n)&&(s=e[n],"story"!==n&&(o["permission."+n]=s));return t=new ThisLife.Model.Albums.Album,t.set(o),this.albumCollection.add(t),this.handleAddAlbumToFolder(this._sharedFolder.id,t)}},handleFollowerCreate:function(e){var t,i;return t=this.getAlbumById(e.story_uid),null!=t&&null!=t.followers?(e.story_permission_uid=e.uid,t.followers.get(e.uid)?t.updateFollower(e):(i=new ThisLife.Model.Follower(e),t.followers.add(i))):void 0},handleInviteAccept:function(e){var t,i,n;return ThisLife.Model.User.id===e.person_uid?this.handleAlbumUpdate({uid:e.story_uid,"permission.accepted":!0}):(t=this.getAlbumById(e.story_uid))?(t.updateFollower(e),n=e.first_name+" "+e.last_name,i=ThisLife.Helper.String.escapeHtml(t.get("name")),ThisLife.notification(n+" is now following "+i,5e3,null,!0)):void 0},handleInviteDelete:function(e){var t;if(this.loaded)return t=this.albumCollection.filter(function(t){return t.get("permission.uid")===e}),t.length>0&&(this.handleAlbumDelete(t[0].get("uid")),this.handleRemoveAlbumFromFolder(this._sharedFolder.id,t[0])),this.albumCollection.each(function(t){var i,n;return i=null!=(n=t.followers)?n.get(e):void 0,i?t.followers.remove(i):void 0})},handleInviteUpdate:function(e){var t,i,n,o,s,r,l,u,c;if(this.loaded){if(e.ignored&&e.person_uid===ThisLife.Model.User.id)return void this.handleInviteDelete(e.uid);s={};for(o in e)a.call(e,o)&&(c=e[o],"story"!==o&&(s["permission."+o]=c));return t=this.albumCollection.filter(function(t){return t.get("permission.uid")===e.uid}),t.length>0&&(i=t[0],i&&(r=i.get("permission.view_only"),i.set(s),r!==i.get("permission.view_only")&&(n=ThisLife.Helper.String.escapeHtml(i.get("name")),(l=i.getOwnerFullName())&&(n+=" by "+ThisLife.Helper.String.escapeHtml(l)),u=i.get("permission.view_only")?"You are now a viewer on "+n:"You may now contribute to "+n,ThisLife.notification(u,5e3,null,!0)))),this.albumCollection.each(function(t){var i,n;return i=null!=(n=t.followers)?n.get(e.uid):void 0,i?t.updateFollower(e):void 0})}},fetchData:function(){return this.loading=!0,ThisLife.Service.api.getFolders(_.bind(this.loadFolderData,this)),ThisLife.Service.api.getAlbums(_.bind(this.loadAlbumData,this))},loadFolderData:function(e){var l,a,u,c;for(this.folderCollection=new ThisLife.Collection.FoldersCollection,this._systemFolderCollection=new ThisLife.Collection.FoldersCollection,u=0,c=e.length;c>u;u++)switch(l=e[u],l.folder_type){case r:a=this._buildFolderObject(l),this.folderCollection.add(a);break;case s:this._sharedFolder=this._buildFolderObject(l),this._systemFolderCollection.add(this._sharedFolder);break;case i:this._autoFolder=this._buildFolderObject(l),this._systemFolderCollection.add(this._autoFolder);break;case o:this._ownerFolder=this._buildFolderObject(l),this._systemFolderCollection.add(this._ownerFolder);break;case t:this._allFolder=this._buildFolderObject(l),this._systemFolderCollection.add(this._allFolder);break;case n:this._lifetouchFolder=this._buildFolderObject(l),this._systemFolderCollection.add(this._lifetouchFolder)}return this.loadedFolders=!0,this.loadData()},_buildFolderObject:function(e){var t;return e.album_count=this.loadedAlbums?this.albumCollection.filter(function(t){return t.get("folder_uid")===e.uid}).length:0,t=new ThisLife.Model.Albums.Folder,e.uid=e.uid+"",t.set(e)},loadAlbumData:function(e){var t,i,n,o,s,r,l,u,c,d,h,p;for(this.albumCollection=new ThisLife.Collection.AlbumsCollection,l=u=0,d=e.length;d>u;l=++u)for(n=e[l],c=0,h=n.length;h>c;c++)if(t=n[c],!t.ignored){s=t.story,2===l&&(s.suggested=!0);for(o in t)if(a.call(t,o))switch(p=t[o],o){case"story":break;case"first_name":s["permission.owner_first_name"]=p;break;case"last_name":s["permission.owner_last_name"]=p;break;default:s["permission."+o]=p}i=new ThisLife.Model.Albums.Album,i.set(s),i.get("permission.default")&&0===i.get("visible_moment_count")?this._myStory=i:(this.loadedFolders&&(r=this.getFolderById(i.get("folder_uid")),null!=r&&r.set("album_count",r.get("album_count")+1)),this.albumCollection.add(i))}return this.loadedAlbums=!0,this.loadData()},loadData:function(){return this.loadedFolders&&this.loadedAlbums?(this.albumCollection.setSort(this._allFolder.get("sort_option")),this.loaded=!0,this.trigger("reset")):void 0},whenLoaded:function(){var e,t,i,n,o;return i=arguments[0],n=arguments[1],e=3<=arguments.length?u.call(arguments,2):[],null==n&&(n=this),t=_.bind(i,n),this.loaded?_.defer(function(){return t.apply(null,e)}):(null==this.loading&&this.fetchData(),o=function(){return t.apply(null,e),this.off("reset",o,this)},this.on("reset",o,this))},getFirstCoverLoaded:function(){return this.firstCoverLoaded},setFirstCoverLoaded:function(e){return this.firstCoverLoaded=e}}),ThisLife.Model.Albums=ThisLife.Model.Albums||{},ThisLife.Model.Albums.Master=new e,define("ThisLife.Model.Albums.Master",[],function(){return ThisLife.Model.Albums.Master})}.call(this),function(){var e,t=[].indexOf||function(e){for(var t=0,i=this.length;i>t;t++)if(t in this&&this[t]===e)return t;return-1},i=[].slice;ThisLife.Model.Albums=ThisLife.Model.Albums||{},ThisLife.Model.Albums.Album=Backbone.Model.extend({idAttribute:"uid",moments:[],pendingUploads:[],isUnread:function(){return!this.get("last_viewed")},isFriendsAlbum:function(){return this.get("permission.owner_person_uid")!==ThisLife.currentLifeOwner},isAutoAlbum:function(){return!!this.get("suggested")},isOwner:function(e){return this.get("permission.owner_person_uid")===e},canEditCover:function(){return!this.get("permission.view_only")&&!this.get("permission.invited_story")&&!this.get("locked")},canEditTitle:function(){return this.canEditCover()},isViewOnly:function(){return!!this.get("permission.view_only")&&!!this.get("locked")
},isLocked:function(){return!!this.get("locked")},getCoverUrl:function(e){var t,i,n;return null==e&&(e="x-small"),n=this.get("cover_moment_uid"),t=this.get("cover_owner_uid"),i=this.get("cover_effects_modified_date"),n?ThisLife.Helper.Image.imgUrl(n,e,i,t):""},getOwnerFullName:function(){return this.get("permission.owner_first_name")?this.get("permission.owner_last_name")?this.get("permission.owner_first_name")+" "+this.get("permission.owner_last_name"):this.get("permission.owner_first_name"):this.get("permission.name")},isInvitee:function(){return this.isFriendsAlbum()},getAcceptedInviteesCount:function(){return this.followers.length},rename:function(e,t){var i,n;return e!==this.get("name")?(i=this._getAlbumAPIObject(),i.name=e,ThisLife.Model.Albums.Master.saveAlbum(i,t)):(n=function(e){return function(){return"function"==typeof t&&t(),e.trigger("change:name",e)}}(this),setTimeout(n,0),!0)},moveToFolder:function(e,t){var i;return e!==this.get("folder_uid")?ThisLife.Model.Albums.Master.moveAlbum(this.id,e,t):(i=function(e){return function(){return"function"==typeof t&&t(),e.trigger("change:folder_uid",e)}}(this),setTimeout(i,0),!0)},copyToFolder:function(e,t){return ThisLife.Model.Albums.Master.copyAlbum(this.id,e,t)},setSort:function(e){var t,i,n,o;return e!==this.get("sort_option")?(t=this._getAlbumAPIObject(),t.sort_option=e,ThisLife.Model.Albums.Master.saveAlbum(t),i=e.split(":")[0],n="desc"===e.split(":")[1]?!0:!1,ThisLife.app.controller("albums").updateOptions({group_by_attr:i,reverse_sort:n,sort_by_attr:i})):(o=function(e){return function(){return e.trigger("change:sort_option",e)}}(this),setTimeout(o,0),!0)},setView:function(e){var t,i;return e!==this.get("view_mode")?(t=this._getAlbumAPIObject(),t.view_mode=e,ThisLife.Model.Albums.Master.saveAlbum(t)):(i=function(e){return function(){return e.trigger("change:view_mode",e)}}(this),setTimeout(i,0),!0)},changeCover:function(e){var t;return t=this._getAlbumAPIObject(),t.cover_moment_uid=e.id,t.cover_owner_uid=e.get("story_moment_created_by"),t.cover_effects_modified_date=e.get("effects_modified_date"),ThisLife.Model.Albums.Master.saveAlbum(t),!0},updateShareLink:function(e){var t;return t=this._getAlbumAPIObject(),t["public"]=e,t.public_link=e,ThisLife.Model.Albums.Master.saveAlbum(t),!0},updateFollower:function(e){var t,i,n;return delete e.story,delete e.name,t=null!=(i=this.followers)?i.get(e.uid):void 0,t?t.set(e):null!=(n=this.followers)?n.add(e):void 0},addPendingUploads:function(e){var i,n,o,s,r;for(i=[],n=0,s=e.length;s>n;n++)o=e[n],r=ThisLife.Collection.moments.get(o),t.call(this.pendingUploads,o)<0&&(null!=r?r.canEdit():void 0)&&(null!=r?r.get("hidden"):void 0)===!1&&i.push(o);return this.pendingUploads=$.merge(this.pendingUploads,i),this.trigger("change:visible_moment_count",this)},completePendingUploads:function(e){var t,i,n,o;for(t=0,i=e.length;i>t;t++)o=e[t],n=this.pendingUploads.indexOf(o),n>=0&&this.pendingUploads.splice(n,1);return 0===this.pendingUploads.length&&this.get("recently_copied")&&this.set("recently_copied",!1),this.trigger("change:visible_moment_count",this)},load:function(e,t,i,n){return ThisLife.app.session.getSessionToken().then(function(i){return function(o){return i.loadAfterSessionToken(e,t,o,n)}}(this))["catch"](function(i){return function(){return i.loadAfterSessionToken(e,t,null,n)}}(this))},loadAfterSessionToken:function(e,t,i,n){var o,s,r,l,a;return s=ThisLife.emailToken||null,o=!1,a=function(t){return function(i){return o?void 0:t._setup(i,e,n)}}(this),r=function(){return o?void 0:"function"==typeof t?t():void 0},l=ThisLife.Service.api.getAlbum(this.get("uid"),s,i,a,r),{abort:function(){return o=!0,l.abort()}}},loadSharedAlbum:function(e,t,i,n){return this._setup(e,t,i,n)},_setup:function(e,t,i){var n,o,s,r;return this.followers=new ThisLife.Collection.StoryFollowers(e.get("members")),this.followers.story_uid=this.id,o=e.get("moments"),o.length?(r=function(e){return function(i){return null==i&&(i=[]),e._createCollection(i),"function"==typeof t?t():void 0}}(this),s=function(){return"function"==typeof t?t():void 0},window.momentLoaderClient.parseStoryMoments({momentsStr:o,filenames:e.get("filenames")},r,s)):(this._createCollection(),"function"==typeof t&&t()),i&&(n=e.attributes,delete n.members,delete n.moments,this.set(n)),this.collectionLoaded=!0,this.trigger("reset"),this},whenLoaded:function(){var e,t,n,o,s;return n=arguments[0],o=arguments[1],e=3<=arguments.length?i.call(arguments,2):[],null==o&&(o=this),t=_.bind(n,o),this.collectionLoaded?_.defer(function(){return t.apply(null,e)}):(s=function(){return t.apply(null,e),this.off("reset",s,this)},this.on("reset",s,this))},_createCollection:function(t){return null==t&&(t=[]),this.moments=_.chain(t).sortBy(e).value(),this.set("moment_count",this.moments.length),this.set("visible_moment_count",_.filter(this.moments,function(e){return!e.hidden}).length),this.completePendingUploads(_.pluck(this.moments,"uid"))},_getAlbumAPIObject:function(){return{uid:this.get("uid"),life_uid:this.get("life_uid"),folder_uid:this.get("folder_uid"),name:this.get("name"),avatar_url:this.get("avatar_url"),facebook_sharing:this.get("facebook_sharing"),twitter_sharing:this.get("twitter_sharing"),tumblr_sharing:this.get("tumblr_sharing"),sort_option:this.get("sort_option"),view_mode:this.get("view_mode")}},_getPermissionAPIObject:function(){return{uid:this.get("permission.uid"),story_uid:this.get("uid"),owner_person_uid:this.get("owner_person_uid"),email_shared_with:this.get("permission.email_shared_with"),ignored:this.get("permission.ignored"),view_only:this.get("permission.view_only"),"default":this.get("permission.default"),follow:this.get("permission.follow"),blocked:this.get("permission.blocked")}}}),e=function(e){return e.moment_date},define("ThisLife.Model.Albums.Album",[],function(){return ThisLife.Model.Albums.Album})}.call(this),function(){ThisLife.Model.Albums=ThisLife.Model.Albums||{},ThisLife.Model.Albums.Folder=Backbone.Model.extend({idAttribute:"uid",rename:function(e,t){var i;return e!==this.get("name")?ThisLife.Model.Albums.Master.saveFolder({uid:this.get("uid"),name:e}):(i=function(e){return function(){return"function"==typeof t&&t(),e.trigger("change:name",e)}}(this),setTimeout(i,0),!0)},setSort:function(e){var t;return e!==this.get("sort_option")?ThisLife.Model.Albums.Master.saveFolder({uid:this.get("uid"),name:this.get("name"),sort_option:e}):(t=function(e){return function(){return e.trigger("change:sort_option",e)}}(this),setTimeout(t,0),!0)}})}.call(this),function(){ThisLife.Collection.LazyLoad=Backbone.Collection.extend({initialize:function(e,t){return this.options=null!=t?t:{},this.requestCount=0,this.setup()},setup:function(){},fetch:function(e){var t,i,n,o;return"jsonp"!==e.dataType?(this.cancel(),this.reset()):this.requestCount++,o=e.success,t=e.error,n=this,e.success=function(e,t,s){var r;if(i===n.requestCount)return r=[],_.each(n.parse(e,s),function(e){return r.push(new n.model(e))}),n.add(r)?"function"==typeof o?o(n,r):void 0:!1},e.error=function(e,i){return"abort"!==i&&"function"==typeof t?t(n):void 0},this._fetch(e,this),i=this.requestCount},fetchLazy:function(e){return null==e&&(e={}),this.cancel(),this.reset(),this.startIndex=e.firstIndex||0,this._fetchNext(e,!0)},cancel:function(){var e;return this.loaded=!1,"jsonp"===this.options.dataType?this.requestCount=0:null!=(e=this.jqXHR)&&e.abort(),this.jqXHR=void 0},findStartIndex:function(e){var t,i,n,o;for(o=this.models,t=0,i=o.length;i>t;t++)if(n=o[t],e(n))return n.get("_startIndex");return 0},_nextUrl:function(){return ThisLife.log.error("ThisLife.Collection.LazyLoad::nextUrl must be defined")},_fetchNext:function(e,t){var i,n,o,s;return this.url=this._nextUrl(),s=e.success,i=e.error,o=this,n=_.extend({},e),e.success=function(r,l,a){var u,c;return u=[],_.each(o.parse(r,a),function(e){return e._startIndex=o.startIndex,u.push(new o.model(e))}),o.add(u)?("function"==typeof s&&s(o,u),o._moreToFetch(u,t,e.firstIndex)?(o._calculateNextStartIndex(t,e.firstIndex),c=_.extend({},n),c.success=s,c.error=i,o._fetchNext(c)):o.loaded=!0):!1},e.error=function(e,t){return"abort"!==t&&"function"==typeof i?i(o):void 0},this._fetch(e,this)},_fetch:function(e,t){return this.jqXHR=(this.sync||Backbone.sync).call(t,"read",t,e)},_calculateNextStartIndex:function(e,t){return e?0===this.startIndex||this.startIndex!==t?this.startIndex+=this.pageSize:this.startIndex=0:(this.startIndex+=this.pageSize,this.startIndex===t?this.startIndex+=this.pageSize:void 0)},_moreToFetch:function(e,t,i){return e.length===this.pageSize||t&&this.startIndex===i&&0!==this.startIndex}})}.call(this),function(){var e,t,i,n=[].slice;e=APICollection.extend({model:ThisLife.Model.Moment,sortByUpload:!1,getDate:function(e){return e.get(this.sortByUpload?"upload_date":"moment_date")},setSort:function(e){return this.sortByUpload="uploadDate"===e?!0:!1,ThisLife.app.library.showLoading(),_.defer(function(e){return function(){return e.sort(),e.rebuildCollections(),ThisLife.app.library.sortCollection(),e.syncSelectedStatus(e.models),ThisLife.app.library.hideLoading()}}(this))},getSort:function(){return this.sortByUpload?"uploadDate":"momentDate"},comparator:function(e){return this.getDate(e)},getModel:function(e){return this.get(e)},setModel:function(e,t,i){var n;return null!=(n=this.get(e))?n.set(t,i):void 0},slice:function(e,t){return null==e&&(e=0),null==t&&(t=this.length),this.models.slice(e,t)},subset:function(e){var t,i,n,o,s,r;if(!this.length)return[];for(o=this._byId,s=[],t=0,i=e.length;i>t;t++)r=e[t],n=o[r],n&&s.push(n);return s},initialize:function(e,t){return null!=t&&t.showRecentUploads&&(this.sortByUpload=!0),this.setupShownStatus(),this.bindEvents()},bindEvents:function(){return this.on("add",this.onAdd,this).on("remove",this.onRemove,this).on("reset",this.onReset,this).on("fmv:change",this.findNext,this).on("change:hidden",this.changeHidden,this),ThisLife.PubSub.on("selectmodeChange",this.onChangeSelectMode,this)},unbindEvents:function(){return ThisLife.PubSub.off(null,null,this),this.off(null,null,this)},unbindAllEvents:function(){return this.off()},addMoment:function(e,t){var i,n;return null==t&&(t={}),n=this.add(e),i=_.extend({},e),null!=e.attributes?(i.attributes.hasOwnProperty("moment_date")&&(i.attributes.moment_date*=1e3),i.attributes.hasOwnProperty("upload_date")&&(i.attributes.upload_date*=1e3),ThisLife.app.controller("timeline").addObjects([i.attributes])):(i.hasOwnProperty("moment_date")&&(i.moment_date*=1e3),i.hasOwnProperty("upload_date")&&(i.upload_date*=1e3),ThisLife.app.controller("timeline").addObjects([i])),t.silent&&this.onAdd(n,this,t),ThisLife.app.controller("uploader").forceUpdate(),n},overLimit:function(e,t){var i;if(e)return i=t.models.length,ThisLife.Collection.organize.isOverLimitWithMultiAdd(i)},getNumVisible:function(){var e;return e=_.bind(ThisLife.app.filter.includeMoment,ThisLife.app.filter),this.filter(e).length},getNumPhotos:function(){return this.filter(function(e){return e.isImage()&&e.get("hidden")===!1}).length},getNumVideos:function(){return this.getVideos().length},getVideos:function(){return this.filter(function(e){return e.isVideo()&&e.get("hidden")===!1})},areAnyVisible:function(){return this.getNumVisible()>0},getVisible:function(){var e;return e=_.bind(ThisLife.app.filter.includeMoment,ThisLife.app.filter),this.filter(e)},getHidden:function(){return this.filter(function(e){return e.get("hidden")})},getNumHidden:function(){var e,t,i,n,o;for(e=0,o=this.models,t=0,i=o.length;i>t;t++)n=o[t],n.get("hidden")&&e++;return e},areAllSelected:function(){return this.areAnyVisible()?this.all(function(e){return ThisLife.app.filter.includeMoment(e)?e.selected:!0}):!1},onChangeSelectMode:function(e,t,i){var n,o,s;if(s=null!=i?i.summaryModel:void 0,n=7===t.length?"getMonth":"getDay",o=this,!((null!=i?i.summaryHeading:void 0)&&this.overLimit(e,this[n](t)))){if(s){if(this.overLimit(e,this[n](t)))return void s.trigger("summaryElementSelected",!1);s.trigger("summaryElementSelected",!0)}return this[n](t).each(function(t){return ThisLife.app.filter.includeMoment(t)?t.selectMoment(e,!1):void 0})}},clearAlwaysShow:function(){return _.map(this.models,function(e){return delete e.alwaysShow})},onReset:function(){return this.loaded=!0},onAdd:function(e,t,i){return t===ThisLife.Collection.moments&&(ThisLife.Collection.moments.noMoments=!1),this.buildDateCollections(e,i)},onRemove:function(e,t,i){return this.removeFromDateCollection(e,i),ThisLife.app.controller("timeline").removeObjects([e.id])},changeHidden:function(e,t){return e.shown&&t?e.shown=!1:void 0},_reset:function(){return this.length=0,this.models=[],this._byId={},this._byCid={},this.dayCollection=[],this._dayByDate={},delete this._monthByDate,delete this._yearByDate},reset:function(e,t){var i,n,o,s,r;for(e||(e=[]),t||(t={}),s=this.models,i=0,n=s.length;n>i;i++)o=s[i],this._removeReference(o);return this._reset(),r=_.extend({silent:!0},t),this.add(e,r),this.buildCollections(r),t.silent||this.trigger("reset",this,t),this},initialSet:function(e){var t,i,n,o,s,r,l;for(null==e&&(e=[]),assert(!this.models.length,"initialSet can only be used with an empty collection"),this.moment_array=[],this._reset(),r={silent:!0,collection:this},l=ThisLife.performanceMonitor.start("creating "+e.length+" ThisLife.Model.Moment instances and adding to moments collection"),n=0,o=e.length;o>n;n++)s=e[n],s=new this.model(s,r),t=_.extend({},s.attributes),t.moment_date*=1e3,t.upload_date*=1e3,this.moment_array.push(t),this._byId[s.id]=s,s._events={},i=s._events.all=[],i.push({callback:this._onModelEvent,context:this,ctx:this}),this.length++,this.models.push(s);return ThisLife.performanceMonitor.end(l),l=ThisLife.performanceMonitor.start("creating date collections"),this.buildCollections(r),ThisLife.performanceMonitor.end(l),this.trigger("reset",this)},whenLoaded:function(){var e,t,i,o;return t=arguments[0],i=arguments[1],e=3<=arguments.length?n.call(arguments,2):[],this.loaded?t.apply(i,e):(o=function(){return t.apply(i,e),this.off("reset",o,this)},this.on("reset",o,this))},rebuildCollections:function(){var e;return e={silent:!0,collection:this},this.dayCollection=[],this._dayByDate={},this.monthCollection=[],this._monthByDate={},this._yearByDate={},this.buildCollections(e)},buildCollections:function(e){var t,i,n,o,s;for(o=this.models,s=[],t=0,i=o.length;i>t;t++)n=o[t],s.push(this.buildDateCollections(n,e));return s},buildDateCollections:function(e,t){return this.buildCollection(e,t,"day")},removeFromDateCollection:function(e,t){var n,o,s;return o=t.prevDate||this.getDate(e),s=ThisLife.Helper.Date.getUTCString(o).slice(0,i.day),n=this.getday(s),n&&(n.remove(e,t),n.models.length||this.destroyDateCollection(n,"day")),null},quickDelete:function(e){return this.get(e)?this.remove(e):void 0},destroyDateCollection:function(e,t){var i;return e.teardown(),delete this["_"+t+"ByDate"][e.fullDate],i=_.indexOf(this[t+"Collection"],e),this[t+"Collection"].splice(i,1)},buildCollection:function(e,t,n){var o,s;return s=ThisLife.Helper.Date.getUTCString(this.getDate(e)).slice(0,i[n]),o=this["get"+n](s)||this["create"+n+"Collection"](s),o.add(e,t)},createdayCollection:function(e){var i,n;return i=new ThisLife.Collection.DateCollection("day",e,{showRecentUploads:this.sortByUpload}),this._dayByDate[e]=i,n=_.sortedIndex(this.dayCollection,i,t),this.dayCollection.splice(n,0,i),i},getday:function(){return this.getDay.apply(this,arguments)},getmonth:function(){return this.getMonth.apply(this,arguments)},getyear:function(){return this.getYear.apply(this,arguments)},getDay:function(e){return e=e.slice(0,10),this._dayByDate[e]},getMonth:function(e){return e=e.slice(0,7),this._monthByDate&&this._monthByDate[e]},getYear:function(e){return e=e.slice(0,4),this._yearByDate&&this._yearByDate[e]},getMomentCount:function(){var e;return e=this.filter(function(e){return!e.get("hidden")}),e.length},deleteMoment:function(e,t){return null==t&&(t={}),this.get(e)?(this.remove(e,t),t.silent&&this.onRemove(e,this,t),ThisLife.Collection.locationTags.clearMomentUid(e),ThisLife.app.album.deleteMoments([e.id]),ThisLife.Model.User.updateMomentCount(e,!1),ThisLife.app.controller("uploader").forceUpdate()):void 0},findNext:function(e,t){var i,n,o,s,r;return r=t.id,(n=this.get(r))?(s="next"===e?1:-1,i=this.indexOf(n)+s,o=this.at(i),o?ThisLife.PubSub.trigger("fmv:change fmv:image",o,e):ThisLife.PubSub.off("fmv:change")):void 0},getNextMoment:function(e){var t;return t=this.indexOf(this.get(e)),this.getNextMomentByIndex(t)},getNextMomentByIndex:function(e,t){var i,n;if(null==t&&(t=1),-1===e||1===this.length)return null;for(i=null,n=e;!i;)if(t>0?e===this.length-1?e=0:e++:0===e?e=this.length-1:e--,i=this.at(e),ThisLife.app.filter.includeMoment(i)||(i=null),e===n){i=null;break}return i},getPreviousMoment:function(e){var t;return t=this.indexOf(this.get(e)),this.getNextMomentByIndex(t,-1)},setupShownStatus:function(){return this.shownMoments={},this},addToShownStatus:function(e){return this.shownMoments[e]=!0,this},removeFromShownStatus:function(e){return delete this.shownMoments[e],this},changeShownStatus:function(e,t){return t?this.addToShownStatus(e):this.removeFromShownStatus(e),this},isShownMoment:function(e){return!!this.shownMoments[e]},clearShownStatus:function(){return this.setupShownStatus(),this},topMomentForDate:function(e){var t;return t=ThisLife.Helper.Date.parseYYYYMMDD(e),_.find(this.models,function(e){return function(i){var n;return n=new Date(ThisLife.Helper.Date.humanDateUTC(e.getDate(i))),ThisLife.Helper.Date.areEqual(n,t)&&ThisLife.app.filter.includeMoment(i)}}(this))},getOrderedByDate:function(e,t){var i,n,o,s,r;for(null==t&&(t=!0),s=[],i=0,n=e.length;n>i;i++)r=e[i],o=this.get(r),!o||t&&o.get("hidden")||s.push(o);return _.sortBy(s,function(e){return e.get("moment_date")})},syncSelectedStatus:function(e){var t,n,o,s,r,l,a;for(t={},a=[],n=0,o=e.length;o>n;n++)r=e[n],s=ThisLife.Helper.Date.getUTCString(this.getDate(r)).slice(0,i[type]),t[s]?a.push(void 0):(t[s]=!0,a.push(null!=(l=this.getday(s))?l.checkIfSelected():void 0));return a}}),ThisLife.Collection.moments=new e,ThisLife.Collection.MomentsCollection=e,t=function(e){return e.date},i={day:10,month:7,year:4},define("ThisLife.Collection.MomentsCollection",[],function(){return ThisLife.Collection.MomentsCollection})}.call(this),function(){ThisLife.Collection.StoryMomentsCollection=APICollection.extend({model:ThisLife.Model.StoryMoment,initialize:function(){return this.bindEvents()},comparator:function(e){return this.getDate(e)},initialSet:function(e,t){var i,n,o,s,r,l,a;for(null==e&&(e=[]),assert(!this.models.length,"initialSet can only be used with an empty collection"),this._sortDayCollectionOptions=t,this.length=0,this.models=[],this._byId={},this._byCid={},this._dayByDate={},r={silent:!0,collection:this},a=ThisLife.performanceMonitor.start("creating "+e.length+" ThisLife.Model.StoryMoment instances and adding to story moments collection"),n=0,o=e.length;o>n;n++)s=e[n],("image"===(l=s.moment_type)||"video"===l||"text"===l)&&(s.hasOwnProperty("moment_date")&&(s.moment_date*=1e3),s.hasOwnProperty("upload_date")&&(s.upload_date*=1e3),s=new this.model(s,r),this._byId[s.id]=s,s._events={},i=s._events.all=[],i.push({callback:this._onModelEvent,context:this,ctx:this}),this.length++,this.models.push(s));return ThisLife.performanceMonitor.end(a),this.trigger("reset",this)},bindEvents:function(){return this.on("add",this.onAdd,this),this.on("remove",this.onRemove,this)},unbindEvents:function(){return this.off(null,null,this)},setModel:function(e,t,i){var n;return null!=(n=this.get(e))?n.set(t,i):void 0},addMoment:function(e,t){var i;return null==t&&(t={}),null!=e.attributes?(e.attributes.hasOwnProperty("moment_date")&&(e.attributes.moment_date*=1e3),e.attributes.hasOwnProperty("upload_date")&&(e.attributes.upload_date*=1e3)):(e.hasOwnProperty("moment_date")&&(e.moment_date*=1e3),e.hasOwnProperty("upload_date")&&(e.upload_date*=1e3)),i=this.add(e,t),t.silent&&this.onAdd(i,this,t),i},deleteMoment:function(e,t){return null==t&&(t={}),this.get(e)?(this.remove(e,t),t.silent?this.onRemove(e,this,t):void 0):void 0},getNumPhotos:function(){return this.filter(function(e){return e.isImage()&&e.get("hidden")===!1}).length},getNumVideos:function(){return this.filter(function(e){return e.isVideo()&&e.get("hidden")===!1}).length},getNumVisiblePhotosAndVideos:function(){return this.getMoments().length},getNumPhotosAndVideos:function(){return this.getPhotosAndVideos().length},getPhotosAndVideos:function(){return this.filter(function(e){return e.isImage()||e.isVideo()})},getMoments:function(){return this.filter(function(e){return!e.get("hidden")&&(e.isImage()||e.isVideo())})},areAllSelected:function(){return 0<this.getNumVisiblePhotosAndVideos()?_.all(this.getMoments(),function(e){return e.selected}):!1},getPhotosAndVideosForDateRange:function(e,t){var i;return e>t&&(i=[e,t],t=i[0],e=i[1]),this.filter(function(i){return function(n){var o;return e<=(o=i.getDate(n))&&t>=o&&(n.isImage()||n.isVideo())}}(this))},getStartDate:function(){return this.models.length?ThisLife.Helper.Date.getUTCString(this.models[0].get("moment_date"),!1):""},getEndDate:function(){return this.models.length?ThisLife.Helper.Date.getUTCString(this.models[this.models.length-1].get("moment_date"),!1):""},getFirstPhotoOrVideo:function(){var e,t,i,n;for(n=this.models,e=0,t=n.length;t>e;e++)if(i=n[e],i.isImage()||i.isVideo())return i;return null},getNextMoment:function(e){var t;return t=this.sortCollection.indexOf(this.get(e)),this.getNextMomentByIndex(t)},getNextMomentByIndex:function(e){var t,i;if(-1===e||1===this.length)return null;for(t=null,i=e;!t;)if(e===this.length-1?e=0:e++,t=this.sortCollection.at(e),(null!=t?t.get("hidden"):void 0)&&(t=null),e===i){t=null;break}return t},getPreviousMoment:function(e){var t;return t=this.sortCollection.indexOf(this.get(e)),this.getPreviousMomentByIndex(t)},getPreviousMomentByIndex:function(e){var t,i;if(-1===e||1===this.length)return null;for(t=null,i=e;!t;)if(0===e?e=this.length-1:e--,t=this.sortCollection.at(e),t.get("hidden")&&(t=null),e===i){t=null;break}return t},buildDateCollections:function(e,t){return this.buildDayDateCollection(e,t),this.buildSortCollection(e,t)},buildDayDateCollection:function(e,t){var i,n;return n=e.get(this._sortDayCollectionOptions.momentDateAttribute),i=this.getDayDateCollection(n)||this.createDayDateCollection(n),i.add(e,t)},buildSortCollection:function(e,t){return this.sortCollection||this.createSortCollection(),this.sortCollection.add(e,t)},removeFromDateCollection:function(e,t){return this.removeFromDayDateCollection(e,t),this.removeFromSortCollection(e,t)},removeFromDayDateCollection:function(e,t){var i,n;return n=t.prevDate||e.get(this._sortDayCollectionOptions.momentDateAttribute),i=this.getDayDateCollection(n),i&&(i.remove(e,t),!i.models.length)?this.destroyDayDateCollection(i):void 0},removeFromSortCollection:function(e,t){return this.sortCollection?(this.sortCollection.remove(e,t),this.sortCollection.models.length?void 0:this.destroySortCollection()):void 0},destroyDayDateCollections:function(){var e,t,i,n;if(this.dayCollection){for(n=this.dayCollection,t=0,i=n.length;i>t;t++)e=n[t],e.teardown();return this._dayByDate={},delete this.dayCollection}},destroyDayDateCollection:function(e){var t;return e.teardown(),delete this._dayByDate[e.fullDate],t=_.indexOf(this.dayCollection,e),this.dayCollection.splice(t,1)},destroySortCollection:function(){return this.sortCollection?(this.sortCollection.teardown(),delete this.sortCollection):void 0},getDate:function(e){return e.get("moment_date")},getDayDateCollection:function(e){var t;return t=ThisLife.Helper.Date.getUTCString(e,!1),this._dayByDate[t]},createDayDateCollection:function(e){var t,i,n,o;return null==this.dayCollection&&(this.dayCollection=[]),i=ThisLife.Helper.Date.getUTCString(e,!1),o={fullDate:i,unixDate:e,comparator:this._sortDayCollectionOptions.momentComparator},t=new ThisLife.Collection.StoryDateCollection(null,o),this._dayByDate[i]=t,n=_.sortedIndex(this.dayCollection,t,this._sortDayCollectionOptions.dateCollectionComparator),this.dayCollection.splice(n,0,t),t},createSortCollection:function(){return this.sortCollection=new ThisLife.Collection.StorySortCollection(null,{comparator:this._sortDayCollectionOptions.momentComparator}),this.sortCollection},resetSortCollection:function(e){var t,i,n,o;for(this._sortDayCollectionOptions=e,this.destroySortCollection(),o=this.models,t=0,i=o.length;i>t;t++)n=o[t],this.buildSortCollection(n,{silent:!0});return this.sortCollection},resetDayDateCollection:function(e){var t,i,n,o;for(this._sortDayCollectionOptions=e,this.destroyDayDateCollections(),this.dayCollection=[],o=this.models,t=0,i=o.length;i>t;t++)n=o[t],this.buildDayDateCollection(n,{silent:!0});return this.dayCollection},onAdd:function(e,t,i){return this.buildDateCollections(e,i)},onRemove:function(e,t,i){return this.removeFromDateCollection(e,i)}}),define("ThisLife.Collection.StoryMomentsCollection",[],function(){return ThisLife.Collection.StoryMomentsCollection})}.call(this),function(){window.AlbumList=ThisLife.Collection.LazyLoad.extend({setup:function(){switch(this.token=ThisLife.Model.User.get(this.options.service+"_access_token"),this.options.service){case"facebook":return this.options.dataType="jsonp","albums"===this.options.type?this.facebookAlbums():"photos_and_videos_of_me"===this.options.type||"photos_and_videos_of_me"===this.options.albumId?this.facebookPhotosAndVideosOfMe():this.facebookPhotos();case"flickr":return"albums"===this.options.type?this.flickrAlbums():this.flickrPhotos();case"smugmug":return"albums"===this.options.type?this.smugmugAlbums():this.smugmugPhotos();case"shutterfly":return"albums"===this.options.type||"folders"===this.options.type?this.shutterflyCollections():this.shutterflyPhotos()}},facebookAlbums:function(){return this.url=ThisLife.Settings.fbUrl+"/me/albums?access_token="+this.token+"&limit=200&fields=id,name,cover_photo",this.parse=function(e){return e.data}},facebookPhotosAndVideosOfMe:function(){return this.url=ThisLife.Settings.fbUrl+"/me/photos?access_token="+this.token+"&limit=1000&fields=picture",this.parse=function(e){return e.data}},facebookPhotos:function(){return this.albumId=this.options.albumId,this.url=ThisLife.Settings.fbUrl+"/"+this.albumId+"/photos?access_token="+this.token+"&limit=1000&fields=picture",this.parse=function(e){return e.data}},flickrAlbums:function(){return this.url=this.options.url,this.parse=function(e){return e.photosets.photoset}},flickrPhotos:function(){return this.albumId=this.options.albumId,this.url=this.options.url,this.parse=function(e){var t;return(null!=(t=e.photoset)?t.photo:void 0)||e.photos.photo}},smugmugAlbums:function(){return this.url=this.options.url,this.parse=function(e){return e.Albums}},smugmugPhotos:function(){return this.albumId=this.options.albumId,this.albumKey=this.options.albumKey,this.url=this.options.url,this.parse=function(e){return e.Album.Images}},shutterflyCollections:function(){return this.pageSize=10,this.parse=function(e){return e.leaves}},shutterflyPhotos:function(){return this.pageSize=100,this.parse=function(e){return e.leaves}}})}.call(this),function(){var e;ThisLife.Collection.ContactsCollection=APICollection.extend({initialize:function(){return this.on("reset",this.onReset,this)},onReset:function(){return this.addEmails()},addEmails:function(){var e,t,i,n,o,s,r;if(r=ThisLife.Model.User,t=r.get("addresses"),t.length)for(n=0,o=t.length;o>n;n++)e=t[n],i=e.email,s="undefined"!==i&&i!==r.get("email"),s&&this.add({facebook_uid:"",name:"",email:i,default_face_url:"/assets/people/defaultPerson.png",type:"email_address"});return this},addUser:function(){var e,t,i,n,o;return o=ThisLife.Model.User,n=o.get("full_name"),i=o.get("facebook_id"),e=o.get("avatar"),t=o.get("email"),this.findName(n)?this:(this.add({facebook_uid:i,name:n,default_face_url:e,_explicitType:"PersonTag",uid:"",email:t}),this)},comparator:function(t){return e(t)},findName:function(t){return t?(t=t.toLowerCase(),this.find(function(i){return e(i)===t})):void 0},setupWithCollection:function(e){var t,i,n;return e===!1&&(e=null),e&&e.models&&(n=function(){var n,o,s,r;for(s=e.models,r=[],n=0,o=s.length;o>n;n++)t=s[n],i=_.clone(t.attributes),i.default_face_url=t.getDefaultFaceUrl(),r.push(i);return r}()),this.removeDuplicates(e).add(n),this.addUser()},removeDuplicates:function(e){return this.removeDuplicateNames(e).removeDuplicateFacebookUids(e).removeDuplicateEmails(e),this},removeDuplicateNames:function(e){var t,i,n,o,s,r,l;if(t=_.compact(this.pluck("name")),e&&e.models)for(l=e.models,i=0,o=l.length;o>i;i++)s=l[i],s&&(r=s.get("name"),n=_.include(t,r),n&&this.removeName(r,s));return this},removeDuplicateEmails:function(e){var t,i,n,o,s,r,l;if(i=_.compact(null!=e?e.pluck("email"):void 0),e&&e.models)for(l=e.models,n=0,s=l.length;s>n;n++)r=l[n],r&&(t=r.get("email"),o=_.include(i,t),o&&this.removeEmail(t,r));return this},removeEmail:function(e){var t;return t=this.findEmail(e),this.remove(t)},findEmail:function(e){return e?(e=e.toLowerCase(),this.find(function(t){return(t.get("email")||"").toLowerCase()===e})):void 0},removeName:function(e,t){var i;return i=this.findName(e),i?this.setFacebookUid(t,i):void 0},setFacebookUid:function(e,t){var i;return i=t.get("facebook_uid"),e.set({facebook_uid:i})},removeDuplicateFacebookUids:function(e){var t,i,n,o;if(t=_.compact(null!=e?e.pluck("facebook_uid"):void 0),t.length)for(i=0,n=t.length;n>i;i++)o=t[i],this.remove(o);return this}}),e=function(e){return(e.get("name")||"").toLowerCase()}}.call(this),function(){var e,t,i,n,o;ThisLife.Collection.Stories=APICollection.extend({model:ThisLife.Model.StoryPermission,comparator:function(e){return[Number.MAX_SAFE_INTEGER-(e.get("story").end_date||0),ThisLife.Helper.Stories.getStoryNameFromStoryUid(e.get("story_uid")).toLowerCase()]},getStory:function(e){return this.find(function(t){return t.get("story_uid")===e})},addNewInvite:function(e){var t;return t=new this.model(e),this.add(t),t},createStory:function(t,s,r){var l,a,u,c,d,h;return r||(r={}),u=o(t),h=n(t,u),c=i(h),a=new this.model(c),l=e(a,this,r),r.createByPusher?l(r.story):(d=ThisLife.Service.api.saveStory(h,null,l),s&&d.success(s)),this},getDefaultStory:function(){return this.find(function(e){return e.get("default")})}}),e=function(e,t){return function(i){var n;if(i.payload){if(!i.success)return;i=i.payload}return n=i.uid+"",t.getStory(n)?void 0:(e.set({short_url:i.short_url,story_uid:n}),e.get("story").uid=n,t.add(e))}},n=function(e,t){return{life_uid:ThisLife.lifeUid,avatar_url:"",name:e,moment_count:0,updated_count:0,moments:"",members:[],"public":!1,path:t}},i=function(e){return{accepted:!0,blocked:!1,"default":!1,email_shared_with:null,facebook_sharing:!1,follow:!0,ignored:!1,person_uid:ThisLife.Model.User.id,owner_person_uid:ThisLife.Model.User.id,story:e,tumblr_sharing:!1,twitter_sharing:!1,view_only:!1,last_viewed:0}},o=function(e,i){var n,s;return null==i&&(i=0),s=t(e),n=i?s+=i:s,ThisLife.Model.masterStory.pathIsAvailable(n)?n:o(e,++i)},t=function(e){return e||(e=""),e.toLowerCase().replace(/[\'!#$%\^*?]+/g,"").replace(/@/g,"_at_").replace(/&/g,"_and_").replace(/[^a-z0-9]+/g,"_").replace(/_{2,}/,"_")}}.call(this),function(){ThisLife.Model.Follower=APIModel.extend({idAttribute:"story_permission_uid",getEmail:function(){return this.get("email")||this.get("owner_email")||this.get("email_shared_with")},setMessage:function(e){return this.set({message:e})},saveStoryPermission:function(e){return null==e&&(e={}),this.set(e),ThisLife.Service.api.shareStory(this.toJSON())},deleteStoryPermission:function(){return ThisLife.Service.api.deleteStoryPermission(this.id)},canContribute:function(){return!this.get("view_only")}}),ThisLife.Collection.StoryFollowers=APICollection.extend({model:ThisLife.Model.Follower,nonDuplicatedFollowers:function(){var e;return e=[],this.models.filter(function(t){var i,n;return i=!0,n=t.getEmail(),i=-1===e.indexOf(n),i&&e.push(n),i})},hasFollowers:function(){return this.find(function(e){return e.get("follow")})},getNumFollowers:function(){var e;return e=this.filter(function(e){return!e.get("ignored")}),e.length},findMemberByEmail:function(e){return this.find(function(t){return t.getEmail()===e})},hasInvitees:function(){return this.find(function(e){return e.get("follow")})},findPerson:function(e){return this.find(function(t){return t.get("person_uid")===e})},checkIfAlreadyMember:function(e){var t;return t=this.findMemberByEmail(e),t?t.toJSON():e===ThisLife.Model.User.get("email")?{isMe:!0}:!1},checkIfAlreadyAcceptedMember:function(e){var t;return t=this.findMemberByEmail(e)},checkIfPendingMember:function(e){var t;return t=this.findMemberByEmail(e),!t},checkIfIgnoredMember:function(e){var t;return t=this.findMemberByEmail(e),t&&t.get("ignored")
},canContribute:function(e){return this.get(e).canContribute()},setPermission:function(e,t){return this.get(e).saveStoryPermission({view_only:!t})},revokeInvite:function(e){var t;return(t=this.get(e))?(this.remove(t),t.deleteStoryPermission()):void 0},reInviteIgnoredUser:function(e){var t,i,n,o,s;return s=$.Guid.New().toLowerCase(),t=this.findMemberByEmail(e),i=t.toJSON(),o=_.extend({},i,{uid:s,ignored:!1,story_permission_uid:s,story_uid:this.story_uid}),n=new ThisLife.Model.Follower(o),n.saveStoryPermission(),t.set({ignored:!1})},addStoryPermission:function(e){var t,i;return i=e.uid||$.Guid.New().toLowerCase(),_.extend(e,{story_permission_uid:i,uid:i,story_uid:this.story_uid,accepted:!0,blocked:!1,follow:!0,ignored:!1}),t=new ThisLife.Model.Follower(e),this.add(t),t.saveStoryPermission()},createStoryPermission:function(e){var t;return t=e.uid||$.Guid.New().toLowerCase(),_.extend(e,{story_permission_uid:t,uid:t,story_uid:this.story_uid,accepted:!1,blocked:!1,follow:!0,ignored:!1}),new ThisLife.Model.Follower(e)}})}.call(this),function(){ThisLife.Collection.StoryGroupCollection=Backbone.Collection.extend({model:ThisLife.Model.StoryMoment,add:function(e,t){return null==t&&(t={}),e[this.type]=this,Backbone.Collection.prototype.add.call(this,e,t)},isCollectionVisible:function(){return 0<this.models.length},getMoments:function(){return _.filter(this.models,function(e){var t;return"image"===(t=e.get("moment_type"))||"video"===t})},getNotes:function(){return _.filter(this.models,function(e){return"text"===e.get("moment_type")})},getDate:function(e){return e.get("moment_date")},resetCollectionForMoments:function(){var e,t,i,n,o;for(n=this.models,o=[],e=0,t=n.length;t>e;e++)i=n[e],o.push(i[this.type]=this);return o},teardown:function(){return this.trigger("forceRemove",this),this.off()}})}.call(this),function(){ThisLife.Collection.StoryDateCollection=ThisLife.Collection.StoryGroupCollection.extend({model:ThisLife.Model.StoryMoment,type:"day",initialize:function(e,t){return this.unixDate=t.unixDate,this.fullDate=t.fullDate,this.date=this.fullDate.slice(0,10)},comparator:function(e){return e.get("moment_date")},add:function(e,t){return null==t&&(t={}),e.day=this,Backbone.Collection.prototype.add.call(this,e,t)},isCollectionVisible:function(){return 0<this.models.length},getMoments:function(){return _.filter(this.models,function(e){var t;return("image"===(t=e.get("moment_type"))||"video"===t)&&!e.get("hidden")})},getNotes:function(){return _.filter(this.models,function(e){return"text"===e.get("moment_type")})},getDate:function(e){return e.get("moment_date")},teardown:function(){return this.trigger("forceRemove",this),this.off()}})}.call(this),function(){ThisLife.Collection.StorySortCollection=ThisLife.Collection.StoryGroupCollection.extend({model:ThisLife.Model.StoryMoment,type:"sort",initialize:function(e,t){return null==t&&(t={}),this.comparator=t.comparator||function(e){return e.getDate()}},getMoments:function(){return this.filter(function(e){return!e.get("hidden")&&(e.isImage()||e.isVideo())})}})}.call(this),function(){var e,t,i,n,o;e=function(){function e(e,i,n){this.type=e,this.fullDate=i,this.options=n,this.models=[],this.date=this.fullDate.slice(0,t[this.type].dateNum),null!=this.options&&this.options.showRecentUploads&&(this.sortByUpload=!0),this.bindEvents()}return e.sortByUpload=!1,e.prototype.getDate=function(e){return e.get(this.sortByUpload?"upload_date":"moment_date")},e.prototype.comparator=function(e){return this.getDate(e)},e.prototype.on=Backbone.Events.on,e.prototype.off=Backbone.Events.off,e.prototype.trigger=Backbone.Events.trigger,e.prototype.add=function(e,t){return null==t&&(t={}),t.silent&&!t.sort?this.models.push(e):this._sortAdd(e,t),e[this.type]=this,t.silent||(this.checkIfSelected(),this.trigger("add",e,this,t)),this},e.prototype.remove=function(e,t){var i;return null==t&&(t={}),i=_.indexOf(this.models,e),this.models.splice(i,1),t.silent||(this.checkIfSelected(),this.trigger("remove",e,this,t)),this},e.prototype.getFirstVisible=function(){return 0===this.models.length?null:_.find(this.models,o)},e.prototype.getVisibleCover=function(){var e;return"day"===this.type?e=_.find(this.models,function(e){return e.get("day_cover")?o(e):!1}):"month"===this.type?e=_.find(this.models,function(e){return e.get("month_cover")?o(e):!1}):assert(!1,"no cover for date collection type '"+this.type),e||(e=_.find(this.models,function(e){return o(e)})),e},e.prototype.resetDateCollectionForMoments=function(){var e,t,i,n,o;for(n=this.models,o=[],e=0,t=n.length;t>e;e++)i=n[e],o.push(i[this.type]=this);return o},e.prototype.getNumVisible=function(){return this.getNumFiltered()},e.prototype.getNumHidden=function(){var e,t,i,n,o;for(e=0,o=this.models,t=0,i=o.length;i>t;t++)n=o[t],n.get("hidden")&&e++;return e},e.prototype.getNumFiltered=function(){return this.filter(o).length},e.prototype.getMoments=function(){return this.filter(function(e){return!e.get("hidden")})},e.prototype.isCollectionVisible=function(){return this.any(o)},e.prototype.areAllHidden=function(){return this.all(function(e){return ThisLife.app.filter.includedMomentIsHidden(e)})},e.prototype.filter=function(e){return _.filter(this.models,e)},e.prototype.each=function(e){return _.each(this.models,e)},e.prototype.all=function(e){return _.all(this.models,e)},e.prototype.any=function(e){return _.any(this.models,e)},e.prototype.bindEvents=function(){var e;return null!=(e=ThisLife.app.filter)?e.on("updated",this.checkIfSelected,this):void 0},e.prototype.unbindEvents=function(){var e;return null!=(e=ThisLife.app.filter)?e.off(null,null,this):void 0},e.prototype.checkIfSelected=function(){var e;return e=this.getSelectionState(),e!==this.selected?this.onMomentSelected({},e):void 0},e.prototype.onMomentSelected=function(e,t){var i;return i=this.getSelectionState(),t&&i||!t&&this.selected?(this.selected=t,ThisLife.PubSub.trigger("selectmode:"+this.fullDate+":view",t)):void 0},e.prototype.getSelectionState=function(){var e,t;return"timeline"===(null!=(t=ThisLife.app.controller("selection"))?t.getType():void 0)&&this.filter(i).length===this.getNumVisible()?"in_story":(e=this.getNumVisible(),e>0&&this.filter(n).length===this.getNumVisible())},e.prototype.teardown=function(){return this.trigger("forceRemove",this),this.unbindEvents(),this.off(),delete this.heading,delete this.dateSeperator},e.prototype._sortAdd=function(e){var t;return t=_.sortedIndex(this.models,e,_.bind(this.comparator,this)),this.models.splice(t,0,e)},e}(),ThisLife.Collection.DateCollection=e,define("ThisLife.Collection.DateCollection",[],function(){return ThisLife.Collection.DateCollection}),i=function(e){var t;return(null!=(t=ThisLife.app.controller("selection").getAlbumCollection())?t.get(e.id):void 0)&&o(e)},n=function(e){return e.selected},o=function(e){var t;return null!=(t=ThisLife.app.filter)?t.includeMoment(e):void 0},t={day:{dateNum:10},month:{dateNum:7},year:{dateNum:4}}}.call(this),function(){var e;e=APICollection.extend({initialize:function(){return this.on("action",this.doAction,this).on("revert",this.close,this)},close:function(){return this.model().trigger("checkrevert")},doAction:function(e,t){return this[e](t)},download:function(){return this.teardown()},teardown:function(){return this.model().trigger("close"),this.off()},model:function(){return this.first()},deleteMoments:function(){return this.model().deleteMoment(),this.trigger("close")},changeDate:function(e){return ThisLife.Helper.Date.saveDate(e,this.model()),this.trigger("close")},getMomentType:function(){return this.model().get("moment_type")},setShareUrl:function(e){return this.model().setShareUrl(e)},getShareUrl:function(){return this.model().getShareUrl()},getImages:function(){return this._filterByMediaType("image")},imageCount:function(){return this.getImages().length},getVideos:function(){return this._filterByMediaType("video")},videoCount:function(){return this.getVideos().length},getDescription:function(){var e;return e=this.getMomentType(),"image"===e?"photo":"video"},_filterByMediaType:function(e){return _.filter(this.models,function(t){return t.get("moment_type")===e})}}),ThisLife.Collection.FMVCollection=e}.call(this),function(){var e;e=Backbone.Model.extend({parse:function(e){return{date:ThisLife.Helper.Date.parseISO8601DateTime(e.created_time),name:e.from.name,avatar_url:ThisLife.Settings.fbUrl+("/"+e.from.id+"/picture"),message:e.message,attachment:e.attachment}}}),ThisLife.Collection.FacebookComments=Backbone.Collection.extend({model:e,initialize:function(e,t){return this.fbUid=t.fbUid||function(){throw Error("Missing parameter: fbUid")}(),this.token=t.token||function(){throw Error("Missing parameter: token")}(),this},url:function(){return ThisLife.Settings.fbUrl+("/"+this.fbUid+"/comments?limit=100&access_token="+this.token+"&fields=from,message,attachment,created_time&callback=?")},parse:function(e){return e.data},comparator:function(e){return e.get("date")}})}.call(this),function(){var e,t=[].slice,i=[].indexOf||function(e){for(var t=0,i=this.length;i>t;t++)if(t in this&&this[t]===e)return t;return-1};e=Backbone.Collection.extend({initialize:function(){return this.loaded=!1,this.on("reset",this._onReset,this)},getNameByUid:function(e){var t,i,n,o;for(o=this.models,t=0,n=o.length;n>t;t++)if(i=o[t],i.get("uid")===e)return i.get("name")},getGroupedCollection:function(){return this.groupedCollection},getFilteredCollection:function(e){var t,i,n,o,s,r,l,a,u;for(i=[],s=0,o=0,l=e.length;l>o;o++){for(n=e[o],t="filtered"+s,i[t]=[],r=0,a=n.length;a>r;r++)u=n[r],i[t].push({key:u,value:this.getNameByUid(u)});s++}return i},whenLoaded:function(){var e,i,n,o;return i=arguments[0],n=arguments[1],e=3<=arguments.length?t.call(arguments,2):[],this.loaded?i.apply(n,e):(o=function(t){return function(){return i.apply(n,e),t.off("reset",o,t)}}(this),this.on("reset",o,this))},_onReset:function(){return this.loaded=!0,this._buildGroupedCollection()},_buildGroupedCollection:function(){var e,t,n,o,s,r,l,a,u;for(t=[],a=this.models,n=0,r=a.length;r>n;n++)o=a[n],e=o.get("category"),i.call(t,e)<0&&(t[e]=[]);for(u=this.models,s=0,l=u.length;l>s;s++)o=u[s],t[o.get("category")].push({key:o.get("uid"),value:o.get("name")});return this.groupedCollection=t}}),ThisLife.Collection.relationships=new e}.call(this),function(){var e,t,i,n,o,s,r,l,a,u,c=[].slice;e=APICollection.extend({initialize:function(){},model:ThisLife.Model.Tag,comparator:function(e){return e.getNameToLC()},setModel:function(e,t,i){var n;return null!=(n=this.get(e))&&n.set(t,i),this},bootstrap:function(e,t){return this.loaded=!0,this.reset(e,t),this},whenLoaded:function(){var e,t,i,n;return t=arguments[0],i=arguments[1],e=3<=arguments.length?c.call(arguments,2):[],this.loaded?t.apply(i,e):(n=function(){return t.apply(i,e),this.off("reset",n,this)},this.on("reset",n,this))},findName:function(e){return e=e.toLowerCase(),this.find(function(t){return t.getNameToLC()===e})},findNameCaseSensitive:function(e){return this.find(function(t){return t.get("name")===e})},getNameFromUid:function(e){var t;return(null!=(t=this.get(e))?t.get("name"):void 0)||""},updateTags:function(){return ThisLife.app.session.getSessionToken().then(function(){return function(e){return(new APIModel).fetch({method:"searchMoments",params:r(e,ThisLife.lifeUid),success:u,error:l})}}(this))}}),s=function(e,i){return i.result.success?(ThisLife.app.controller("timing").endTimer("tagsLoad",{success:!0,firstLoggedOut:ThisLife.firstLoggedOut}),o(e,i)):t(e,i)},t=function(){return ThisLife.app.controller("timing").endTimer("tagsLoad",{success:!1,firstLoggedOut:ThisLife.firstLoggedOut}),ThisLife.log.error("bootstrap tag collections",arguments)},o=function(e){var t;return t={parse:!0},ThisLife.Collection.personTags.bootstrap(e.get("personTags"),t),ThisLife.Collection.locationTags.bootstrap(e.get("locationTags"),t),ThisLife.Collection.momentTags.bootstrap(e.get("momentTags"),t)},u=function(e,t){return t.result.success?a(e,t):l(e,t)},l=function(){return ThisLife.log.error("update tag collections",arguments)},a=function(e,t){return o(e,t)},n=function(e){return null==e&&(e=4e3),setTimeout(i,e)},i=function(){return ThisLife.holdbackLoadDelayed?(ThisLife.holdbackLoadDelayed=!1,void n(8e3)):(ThisLife.app.controller("timing").startTimer("tagsLoad"),ThisLife.app.session.getSessionToken().then(function(){return function(e){return(new APIModel).fetch({method:"searchMoments",params:r(e,ThisLife.lifeUid),success:s,error:t})}}(this)))},r=function(e,t){var i,n,o,s,r,l,a,u,c,d,h,p,f,m,g,v;return[e,t,v=!1,d=!1,u=!1,c=!1,r=!1,p=!1,a=!1,h=!1,g=!1,n=!1,m=!1,f=!1,l=!1,s=!1,o=!1,i=!0]},ThisLife.Collection.TagsCollection=e,ThisLife.Collection.TagsCollection.load=function(){return i()},define("ThisLife.Collection.TagsCollection",[],function(){return ThisLife.Collection.TagsCollection})}.call(this),function(){var e;e=ThisLife.Collection.TagsCollection.extend({model:ThisLife.Model.PersonTag,initialize:function(){return this.on("add remove",this.deleteContacts,this),this.sortType="count:desc"},comparator:function(e,t){var i,n,o,s;return n=this.sortType.split(":"),o=n[0],s=n[1],i="asc"===s?1:-1,"count"===o?(e.count>t.count?1:-1)*i:"birthday"===o?(e.getBirthdateForSort()>t.getBirthdateForSort()?1:-1)*i:(e.get(o)>t.get(o)?1:-1)*i},deleteContacts:function(){return delete ThisLife.Collection.contacts},deleteFaces:function(e){var t;return t=_.bind(this.deleteFacesCallback,this),ThisLife.Service.api.deleteFaces(e,t)},verifyTaggings:function(){},createPersonCallback:function(e){return function(t){return function(i){var n;return e.uid=i[0].person_tag_uid,n=new t.model(e,{parse:!0}),t.add(n),t.trigger("new_tag",n,t,i)}}(this)},updateTaggings:function(e,t){var i,n,o;return o=e.id||e.uid,i=this.get(o),n={name:e.value},i?(n.person_tag_uid=o,n.moment_uid=t,this.createFace(n,function(e){return function(t){return e.trigger("new_tag",i,e,t)}}(this))):(n.face={height:null,width:null,center_x:null,center_y:null,moment_uid:t},this.createPerson(n,this.createPersonCallback(n)))},deleteFacesCallback:function(e,t){var i,n,o,s,r,l,a,u,c,d;if(l=t.result.payload,i=null!=l?l.deleted_person_tags:void 0,d=null!=l?l.updated_person_tags:void 0)for(n=0,s=d.length;s>n;n++)a=d[n],this.updateOrAdd(a);if(i){for(delete ThisLife.Collection.contacts,c=[],o=0,r=i.length;r>o;o++)u=i[o],c.push(this.remove(u));return c}},createPerson:function(e,t){return e.momentId&&(this.logger=new ThisLife.Model.LogFMV(null,{action:"tagface",lifeUid:ThisLife.lifeUid}),this.logger.setMomentId(e.momentId),this.logger.setFaceDetected(e.existing),this.logger.setNewPerson(!0),this.logger.setTagCount(1),this.logger.log()),delete ThisLife.Collection.contacts,ThisLife.Service.api.savePersonTagBeta(e,null,function(){return function(e){var i,n;return i=e.get("faces"),n=i.length?i:_.isObject(e.get("face"))?[modelFace]:[{_explicitType:"Face",person_tag_uid:e.get("uid"),uid:e.get("face")}],"function"==typeof t?t(n):void 0}}(this))},createFace:function(e,t){var i;return e.momentId&&(this.logger=new ThisLife.Model.LogFMV(null,{action:"tagface",lifeUid:ThisLife.lifeUid}),this.logger.setMomentId(e.momentId),this.logger.setFaceDetected(e.existing),this.logger.setNewPerson(!1),this.logger.setTagCount(1),this.logger.log(),ThisLife.PubSub.trigger("people:requireUpdate")),i=_.isObject(e.face)?e.face:e,i.person_tag_uid?i.uid||(i.uid=i.face):(i.uid||(i.uid=i.face),i.person_tag_uid=this.findName(e.name).id),ThisLife.Service.api.saveFaces(i,function(e){var i;return i=e.first(),t(i.toJSON())})},newFace:function(e,t){var i,n;return n=e.name,i=this.findName(n),this[i?"createFace":"createPerson"](e,t)},updateOrAdd:function(e){var t,i,n;return t=this.get(e.uid),e.is_vip=!!e.is_vip,t?(e.face===(null!=(i=t.get("face"))?i.uid:void 0)&&delete e.face,t.set(e),n=t.get("is_vip")!==e.is_vip,n&&t.trigger("change:vip",t),null!=t.get("visible_moment_count")&&(t.count=t.get("visible_moment_count")),t.trigger("count_changed")):(delete ThisLife.Collection.contacts,this.add(e,{at:0})),ThisLife.PubSub.trigger("people:updateOrAdd")},updateRelationship:function(e){var t;return null!=e.person_tag_uid&&null!=e.relationship_type_uid?(t=ThisLife.Collection.personTags.get(e.person_tag_uid),t.set("relationship_type_uid",e.relationship_type_uid)):void 0},getFaces:function(e,t){return this.get(e).getFaces(t)},getMomentUidsFromFaces:function(e,t){return this.get(e).getFaces(function(e){var i;return i=_.pluck(e,"moment_uid"),t(i)})},getCollectionOfMomentsForPersonTag:function(e,t){return this.whenLoaded(this.getFaces,this,e,function(){return function(e){var i,n,o;return o=_.pluck(e,"moment_uid"),o.length&&(n=ThisLife.Collection.moments.subset(o),i=new ThisLife.Collection.MomentsCollection(n)),t(i)}}(this))},merge:function(e,t,i){return this.remove(e),ThisLife.holdbackLoadDelayed=!0,ThisLife.Service.api.mergePersonTags(e.id,t.id,i)},areAnyVips:function(){var e,t,i,n;for(n=this.models,e=0,t=n.length;t>e;e++)if(i=n[e],i.get("is_vip"))return!0;return!1},areAnyNonVips:function(){var e,t,i,n;for(n=this.models,e=0,t=n.length;t>e;e++)if(i=n[e],!i.get("is_vip"))return!0;return!1},setSort:function(e){return this.sortType=e,this.sort()}}),ThisLife.Collection.personTags=new e}.call(this),function(){var e;e=ThisLife.Collection.TagsCollection.extend({model:ThisLife.Model.LocationTag,initialize:function(){},setView:function(e){return this.view=e},update:function(e){var t;return t=this.get(e.uid),t?t.set(e):this.add(e)},getMoments:function(e){var t;return e=e.length?e:[e],t=this.subset(e),e=_.flatten(_.map(t,function(e){return e.get("moment_uids")})),ThisLife.Collection.moments.subset(e)},subset:function(e){var t,i,n,o,s,r;if(!this.length)return[];for(o=this._byId,s=[],t=0,i=e.length;i>t;t++)r=e[t],n=o[r],n&&s.push(n);return s},comparator:function(e){return(e.get("name")||"").toLowerCase()},clearMomentUid:function(e,t){var i,n,o,s,r,l;for(s=e.id||e,r=this.models,l=[],i=0,n=r.length;n>i;i++)o=r[i],l.push(o&&o!==t?o.contains(s)?o.deleteMomentUid(s):void 0:void 0);return l},getLocations:function(){return _.compact(this.pluck("name"))},findName:function(e){return e=(e||"").toLowerCase(),this.find(function(t){return(t.get("name")||"").toLowerCase()===e})},getFMVLocation:function(e){var t;return t=this.get(e),t?t.getFMVLocation():(ThisLife.log.error("FMV Location not found"),"Add a Location")},findLocationTag:function(e,t){return this.get(t)||this.findName(e)},getNameFromUid:function(e){var t;return null!=(t=this.get(e))?t.get("name"):void 0},updateTaggings:function(e,t){var i,n,o,s;return s=e.id||e.uid,(n=this.get(s))?(o=n.createTaggings(t,i),o||(n=null),this.trigger("new_tag",n,this,{})):(i=!0,this.addTag(e,t))},addLocation:function(e,t){var i;return this.view.tagList.classList.add("loading"),i=this.get(t),this.trigger("new_tag",i,this,{}),i.createTaggings(e)},addTag:function(e,t){var i,n,o,s;this.view.tagList.classList.remove("loading"),s=_.bind(this.addLocation,this,t),n=e.name||e.value,i=ThisLife.Templates.places("newPlaceTemplate"),o=new ThisLife.View.ModalNewPlace({templateID:"modal_new_place",heading:"Confirm we have the right location",body:i,closeText:"CONFIRM",callback:s,cancelText:"CANCEL",placeValue:n})},verifyTaggings:function(e){var t,i,n,o;n=[];for(t in e)o=e[t],i=this.get(t),n.push(i?i.verifyTaggings(o):void 0);return n}}),ThisLife.Collection.locationTags=new e,ThisLife.Collection.LocationTags=e}.call(this),function(){var e;e=ThisLife.Collection.TagsCollection.extend({model:ThisLife.Model.MomentTag,comparator:function(e){return(e.get("name")||"").toLowerCase()},initialize:function(){},findName:function(e){return e=(e||"").toLowerCase(),this.find(function(t){return(t.get("name")||"").toLowerCase()===e})},getNameFromUid:function(e){var t;return null!=(t=this.get(e))?t.get("name"):void 0},updateTaggings:function(e,t){var i,n,o,s;return s=e.id||e.uid,n=this.get(s),n||(i=!0,n=this.addTag(e)),o=n.createTaggings(t,i),o.length||(n=null),this.trigger("new_tag",n,this,o)},addTag:function(e){var t,i;return i=e.name||e.value,t=new this.model({name:i}),this.add(t),t},ensureTaggings:function(e){var t,i,n;return t=function(){var t,o,s;for(s=[],t=0,o=e.length;o>t;t++)i=e[t],n=this.get(i.moment_tag_uid),s.push(n?n.addTagging(i):void 0);return s}.call(this)},verifyTaggings:function(e){var t,i,n,o;n=[];for(t in e)o=e[t],i=this.get(t),n.push(i?i.verifyTaggings(o):void 0);return n},update:function(e){var t,i,n,o;for(e=_.isArray(e)?e:[e],n=[],t=0,i=e.length;i>t;t++)o=e[t],n.push(this._updateOrAdd(o));return n},_updateOrAdd:function(e){var t,i;return i=e.uid||e,t=this.get(i),t?(t.set(e),null!=e.visible_moment_count&&(t.count=e.visible_moment_count),t.trigger("count_changed")):this.add(e),this}}),ThisLife.Collection.momentTags=new e}.call(this),function(){var e;e=Number.MAX_SAFE_INTEGER||Math.pow(2,53)-1,ThisLife.Collection.AlbumsCollection=APICollection.extend({sortType:"created:desc",model:ThisLife.Model.Albums.Album,comparator:function(t){var i,n,o;switch(o=this.sortType.split(":"),i=o[0],n=o[1],i){case"name":return"desc"===n?ThisLife.Helper.String.invertString(t.get("name").toLowerCase()):t.get("name").toLowerCase();case"end_date":return"desc"===n?e-t.get("start_date"):t.get("end_date");case"updated":return"desc"===n?e-t.get("updated"):t.get("updated");default:return"desc"===n?e-t.get("created"):t.get("created")}},setSort:function(e){return this.sortType=e,this.sort()},getUnreadCount:function(){var e,t,i,n,o;for(e=0,o=this.models,t=0,i=o.length;i>t;t++)n=o[t],n.isUnread()&&n.isAutoAlbum()&&e++;return e},getUnacceptedCount:function(){var e;return e=0}})}.call(this),function(){ThisLife.Collection.FoldersCollection=APICollection.extend({sortType:"name",model:ThisLife.Model.Albums.Folder,comparator:function(e){switch(this.sortType){case"name":return e.get("name").toLowerCase();case"-name":return ThisLife.Helper.String.invertString(e.get("name").toLowerCase());default:return e.get("name")}},setSort:function(e){return this.sortType=e,this.sort()}})}.call(this),function(){var e,t;ThisLife.Templates||(ThisLife.Templates={}),ThisLife.Templates.people=function(e,i){return t[e](i)},t={editPersonDetailsTemplate:function(e){var i;return i=e.getNameEscaped(),"unnamed"===i&&(i=""),"<div class='face_identify_header'>\n  <div id='faceIdentity' class='edit_person_fields'>\n    "+t.editPersonSideBarFieldsTemplate(e)+"\n  </div>\n</div>"},editPersonSideBarFieldsTemplate:function(e){var t,i,n,o,s,r,l;return s=e.getNameEscaped(),n=e.get("email")||"","unnamed"===s&&(s=""),o=""!==n?n:"Enter email",r=e.get("uid"),i=e.getBirthdate(),t="editable",l="",e.get("is_vip")&&(l="selected"),'<div class="edit_person_row">\n  <div class="row">\n    <div class="row_item row_item_name">\n      <!-- span contenteditable=\'true\' spellcheck=\'false\' data-person-tag-uid=\''+r+"' class='person_name editable'>"+s+'</span -->\n       <label>Name</label>\n      <input class=\'person_name\' type="text" placeholder="Enter name" value="'+s+'"\u200e />\n      <div class=\'face_identify_dropdown people_box\' id=\'face_identify_dropdown-people\'>\n        <div class=\'face_identify_dropdown-scroll-area\'></div>\n      </div>\n    </div>\n\n  </div>\n  <div class="row">\n    <div class="row_item">\n      <label>Relationship</label>\n      <div class="info relationship editable">\n        <span class="text">Select Relationship</span>\n        <span class="dropdown edit-person relationship-dropdown"></span>\n      </div>\n    </div>\n  </div>\n  <div class="row">\n    <div class="row_item">\n      <label>Birthday</label>\n      <div class="info bday '+t+'">\n        <span class="text">\n          <span class="dateStr">'+i+'</span>\n          <span class="arrow"></span>\n        </span>\n        <span class="dropdown edit-person"></span>\n      </div>\n    </div>\n  </div>\n  <div class="row">\n    <div class="row_item">\n      <label>Email</label>\n      <div class="info email editable">\n        <input class="email_input" type="text" value="'+n+'" placeholder="Enter email address"/>\n        <span class="error_message">Please enter a valid email</span>\n      </div>\n    </div>\n  </div>\n</div>'},noPeopleTemplate:function(){var e,t,i;return e=ThisLife.Model.suggestedGroupCount.getCountToDisplay(),t=e>0?"":"display:none",i="<div class='text'>\n     You have not tagged any people yet. You can organize your photos by tagging people.\n     <span class='subtext'>\n       <a class=\"orange-btn identify-btn\" style='"+t+"'>Tag People</a>\n     </span>\n   </div>",0===e&&(i=" <div class='header'>\n  People\n </div>\n <div class=\"text\">\n  We automatically find similar faces and group them to help you tag all your loved ones. This allows you to easily search and find the photos of the people you love. \n  </div>\n  <div class='subtext'>\n    <div>Face identification is currently running. </div>\n    <div>Please check back later.</div>\n  </div>\n</div>"),"  <div id='no_tagged_people' class='empty-grid people'>\n    <div class='image'>\n    </div>\n   "+i+"\n</div>"},loadingPeopleTemplate:function(){return"<div class='empty_pattern' id='no_tagged_people_wrapper'>\n  <div id='no_tagged_people'>\n    <div id='no_tagged_people_center'>\n      <div class='people_empty'></div>\n      <p>Loading People&hellip;</p>\n    </div>\n  </div>\n</div>"}},e='<% var face = default_face_url || "/assets/people/defaultPerson.png" %>\n<% var email = email || null %>\n<% var uid = uid || null %>\n\n<li class="item" data-facebook-uid="<%= facebook_uid %>" data-uid ="<%= uid %>" data-email="<%= email %>">\n    <img src="<%= face %>" class="avatar">\n    <a class="name"></a>\n</li>'}.call(this),function(){var e;ThisLife.Templates.places=function(t,i){return e[t](i)},e={markerClusterMomentsTemplate:function(){return'<span class="close-btn"><img src="/assets/1px.gif"></span> <div class="popup_content scrollbar"> <h1>Loading...</h1> <ul class="clearfix"></ul> </div> <div class="popup_bottom"> <div class="shadow"><div></div></div> <a class="orange-btn">View All</a> </div> <div class="pointer"><div class="arrow"></div></div>'},newPlaceTemplate:function(){return'  <div class="place-field">\n      <input type="text" class="place-input" placeholder="Type a location..."  value="" id="js_place" />\n      <span class="find-button icon-search-lined" id="js_find_place">\n        <img src="/assets/icon-search-lined.png" srcset="/assets/icon-search-lined@2x.png 2x,/assets/icon-search-lined@3x.png 3x" class="icon-search-lined">\n      </span>\n  </div>\n\n<div id="place_map_wrap">\n  <div id="place_map"></div>\n</div>'},markerTooltipTemplate:function(){return'<span class="close-btn"><img src="/assets/1px.gif"></span>\n<div class="popup_content scrollbar">\n  <h1>Loading...</h1>\n\n  <ul class="clearfix"></ul>\n</div>\n<div class="popup_bottom">\n  <div class="shadow"><div></div></div>\n  <a class="orange-btn">DO THINGS!!!</a>\n</div>\n<div class="pointer"><div class="arrow"></div></div>'}}}.call(this),function(){var e,t,i,n,o,s,r,l,a;ThisLife.Templates||(ThisLife.Templates={}),ThisLife.Templates.settings=function(e,t){return a[e](t)},a={settingsTemplate:function(l){return"<div class='tl_settings_top'>\n  <ul class='tl_settings_nav'>\n    <li class='tl_settings_email active'>Account</li>\n    <li class='tl_settings_services'>Preferences</li>\n    <li class='tl_settings_apps'>Get Our Apps</li>\n  </ul>\n</div>\n\n<!-- BEGIN: PERSONAL INFORMATION -->\n<div class='tl_settings_content clearfix' id='tl_modal_settings_email' style='display: block'>\n  <ul class='tl_settings_submenu'>\n    <li id='tl_settings_submenu-personal' class='active'>Personal Information</li>\n    <li id='tl_settings_submenu-plan'>Usage</li>\n    <li id='tl_settings_submenu-image-prefs'>Image Preferences</li>\n    <li id='tl_settings_submenu-billing' "+(ThisLife.Model.User.isPaidAccount()&&ThisLife.Model.User.isCurrentLifeOwner()?"":'style="display: none"')+">Video Plan</li>\n </ul>\n\n  <!-- PERSONAL -->\n  "+s(l)+"\n\n  <!-- MY PLAN: USAGE -->\n  "+o(l)+"\n\n  <!-- IMAGE PREFERENCES -->\n  "+n()+"\n\n <!-- MY PLAN: BILLING -->\n  "+t(l)+"\n</div><!--//tl_settings_content-->\n<!-- END: PERSONAL INFORMATION -->\n\n\n<!-- BEGIN: PREFERENCES -->\n<div class='tl_settings_content clearfix' id='tl_modal_settings_services'>\n  <ul class='tl_settings_submenu'>\n    <!--<li class='active'><a id='tl_settings_submenu-services' title=''>Services</a></li>-->\n    <!--<li id='tl_settings_submenu-services' class='active'>Services</li>-->\n    <li id='tl_settings_submenu-email-prefs' class='active'>Email Preferences</li>\n  </ul>\n\n  <!-- SERVICES -->\n  "+r(l)+"\n\n\n  <!-- EMAIL PREFS -->\n  "+i()+"\n\n</div><!--//tl_settings_content-->\n<!-- END: PREFERENCES -->\n\n<!-- BEGIN: APPS -->\n<div class='tl_settings_content clearfix' id='tl_modal_settings_apps'>\n  "+e()+"\n</div>\n<!-- END: APPS -->\n\n<div class='tl_settings_bottom'>\n  <div class='left'>\n    <ul class='settings_links'>\n      <li><a class='feedback'>Feedback</a></li>\n      <li><a class='links-faq'>FAQ</a></li>\n      <li><a href='https://www.shutterflyinc.com/terms.html' target='_blank'>Terms of Service</a></li>\n    </ul>\n  </div>\n  <div class='right'>\n    <a class='gray-btn close_btn'>Done</a>\n  </div>\n</div>"}},l=function(e,t,i){var n;return t||(t=""),i=i||t.toLowerCase(),n=e?"on":"","<li id='tl_services_"+i+"'> <img src='/assets/1px.gif' class='icon_"+i+" service_icon' /> <span>"+t+"</span> <div class='switch "+n+"'> <div class='handle'></div> </div> </li>"},s=_.template("<div id='settings_personal' class='tl_settings_body'> <div class='scrollbar'> <ul class='settings_list'> <li> <span>First name</span> <div class='settings_detail'><%= first_name %></div> </li> <li> <span>Last name</span> <div class='settings_detail'><%= last_name %></div> </li> <li> <span>Email</span> <div class='settings_detail'><%= email %></div> </li> </ul> <div class='btn_group'> <a class='orange-btn' href='<%= ThisLife.Settings.sflyApp %>/action/address/change?wid=Self&acc=1&from=/account/acc_info.jsp' target='_blank'>Edit Info</a> <a class='orange-btn change-password'>Change Password</a> <!--<a class='delete_account_link'>Delete Account</a>--> </div> </div> </div>"),o=a.myPlan=_.template("<div id='settings_plan' class='tl_settings_body' style='display: none'></div>"),t=a.billing=_.template("<div id='settings_billing' class='tl_settings_body' style='display: none;'></div>"),n=a.imagePrefs=_.template("<div id='settings_image_prefs' class='tl_settings_body' style='display: none'></div>"),r=function(e){return"<div id='settings_services' class='tl_settings_body' style='display: none;'> <div class='scrollbar'> <ul class='settings_list'> "+l(e.facebook_access_token,"Facebook")+" "+l(e.instagram_access_token,"Instagram")+" "+l(e.twitter_access_token,"Twitter")+" "+l(e.flickr_access_token,"Flickr")+" "+l(e.picasa_access_token,"Google Photos","picasa")+" <!--"+l(e.shutterfly_access_token,"Shutterfly")+"--> <!--"+l(e.youtube_access_token,"YouTube")+"--> "+l(e.tumblr_access_token,"Tumblr")+" "+l(e.smugmug_access_token,"SmugMug")+" </ul> </div><!-//scrollbar--> </div>"},i=function(){return"<div id='settings_email_prefs' class='tl_settings_body' style='display: block;'></div>"},e=function(){return"<div id='settings_apps' class='tl_settings_body'> <div class='scrollbar'> <div class='apps_wrapper'> <div class='settings_mobile'> <div class='mobile_header'> <p class='header'>Mobile Apps.</p> <p>Access anywhere.</p> <div class='image'></div> </div> <div class='mobile_text'> <div> <p class='bold'>For iPad, iPhone, Android, and Kindle.</p> <p>Access your entire collection of photos and videos on any device, stored in the cloud. Your photos are always with you.</p> </div> <div> <p>Download our app on your phone:</p> <div id='settings_text_to_phone'></div> </div> </div> </div> </div> </div> </div>"}}.call(this),function(){var e,t;null==ThisLife.Templates&&(ThisLife.Templates={}),e=function(){return"<div class='tl_modal_bottom'> <div class='tl_modal_bottom_left'></div> <div class='tl_modal_bottom_right_close'> <a id='close_face_right' class='small-btn orange-btn'>Done</a> </div> <div class='tl_modal_bottom_right'> <a class='small-btn gray-btn ignore_possible_match'>Skip For Good</a> <a class='small-btn gray-btn skip_match'>Skip For Now</a> <a id='next_face' class='small-btn orange-btn'>Confirm &amp; Next</a> </div> </div>"},t={suggestionTemplate:function(e){var i;return i=e.btnText,"<div class='tl_modal_middle' id='tl_suggestion_middle'>\n  <div class='close-btn'><img src='/assets/1px.gif' /></div>\n  <div class='' id='suggestion_wrapper'>\n    <div class='face_identify_header'>\n      <div class='face'>\n        <div class='person_face suggested_person_face' style='background-image: url("+e.url+")'></div>\n      </div>\n      <div class='face_identify_header_right'>\n        "+t.suggestionHeaderTemplate(e)+"\n      </div>\n    </div><!--//face_identify_header-->\n    <p class='face_select_prompt'>Cross out faces that do not belong</p>\n    <ul id='main_face_grid' class='face_identify_grid scrollbar'></ul>\n  </div><!--//face_identify_wrapper-->\n  "+t.giftTooltipTemplate(e)+"\n</div>\n<div class='tl_modal_bottom_right_add'>\n  <a id='add_face_right' class='done-btn orange-btn'>"+i+"</a>\n</div>\n"
},suggestionHeaderTemplate:function(e){var i,n,o,s,r,l,a,u;return s="",a="unnamed",e.name&&(s=e.name,a="named"),u=e.uid,i=e.dateFormatted,o="none",l="none",r="none",n="none","named"===a?e.hasFullPersonData?o="block":(l="block",n="block"):(r="block",n="block"),'<div class="suggestion_row">\n  <div class="full_row_wrapper">\n    '+t.fullRowTemplate({name:s,display:o})+'\n  </div>\n  <div class="partial_row_wrapper">\n    '+t.partialRowTemplate({name:s,display:l})+'\n  </div>\n  <div class="row nameRow" style="display:'+r+";\">\n    <div class=\"header\">\n      <!-- span contenteditable='true' spellcheck='false' data-person-tag-uid='"+u+"' class='person_name editable "+a+"'>"+s+'</span -->\n      <input class=\'person_name\' type="text" placeholder="Type a name" value="'+s+'"\u200e />\n      <div class="face_identify_dropdown dropdown" id="face_identify_dropdown-people">\n        <!-- div class="face_identify_dropdown-triangle"></div-->\n        <div class="face_identify_dropdown-scroll-area"></div>\n       </div>\n      <div class="name_error_tooltip">\n        <div class="name_error_tooltip_arrow"></div>\n        <div class="name_error_tooltip_content">\n          <p>Name cannot be blank!</p>\n        </div>\n      </div>\n    </div>\n  </div>\n  <div class="row dropdownRow" style="display:'+n+';">\n    <div class="info relationship editable">\n      <span class="text">Relationship</span>\n      <span class="dropdown suggestion relationship-dropdown"></span>\n    </div>\n  </div>\n  <div class="row dropdownRow" style="display:'+n+';">\n    <div class="info bday">\n      <span class="text">\n        <span class="dateStr">'+i+'</span>\n        <span class="arrow"></span>\n      </span>\n      <span class="dropdown suggestion"></span>\n    </div>\n  </div>\n</div>'},giftTooltipTemplate:function(e){var t;return t=e.hasFullPersonData?"none":"block",'<div class="gift_tooltip_wrapper" style="display: '+t+' ;">\n  <div class="gift_info_tooltip_background"></div>\n  <div class="btn_gift_info"><img src="/assets/people/bday_modal/gift_icon_large.png" alt="birthday info" style="width: 20px;"></div>\n  <div class="gift_info_tooltip dropdown">\n    <!--div class=\'close-gift-tooltip\'><img src=\'/assets/1px.gif\' /></div-->\n    <div class="bday-title">Coming Soon... Birthday Gift Suggestions!</div>\n    <div class="bday-item short-item">\n      <img src="/assets/people/bday_modal/bday.png" alt="birthday calendar">\n      <p>Select relationship &amp; B-day.</p>\n    </div>\n    <div class="bday-item">\n      <img src="/assets/people/bday_modal/clock.png" alt="clocking ringing">\n      <p>Get a reminder before special event.</p>\n    </div>\n    <div class="bday-item long-item">\n      <img src="/assets/people/bday_modal/gifts.png" alt="gifts">\n      <p>The best photos in the best gift ready for you to buy.</p>\n    </div>\n    <div class=\'gift_info_tooltip_bottom\'>\n      <a id=\'git_into_tooltip_got_it_btn\' class=\'done-btn orange-btn\'>Got it!</a>\n    </div>\n  </div>\n</div>'},fullRowTemplate:function(e){var t,i;return i=e.name,t=e.display,'<div class="row fullRow" style="display:'+t+';">\n  <h3>'+i+'</h3>\n  <p class="suggestion-wrong">Not '+i+"?</p>\n</div>"},partialRowTemplate:function(e){var t,i,n;return n=e.name,i=n.substr(0,n.indexOf(" "))||n,t=e.display,'<div class="row partialRow" style="display:'+t+';">\n  <h4>'+n+'</h4>\n  <p class="suggestion-wrong">Not '+i+"?</p>\n</div>"},personDetailTemplate:function(e){var t,i,n,o,s,r,l,a;return a=e.url,l=e.name,s=e.hasRelationship,o=e.hasBday,n=s?"none":"inline-block",i=o?"none":"inline-block",t=e.dateFormatted,r="",s||(r+="relationship"),s||o||(r+=" & "),o||(r+="B-day"),"<div class='tl_modal_middle' id='tl_person_details_middle'>\n  <div class='close-btn'><img src='/assets/1px.gif' /></div>\n  <div class='' id='person_details_wrapper'>\n    <div class=\"header_title\">\n      <div class=\"gift_icon\"><img src=\"/assets/people/bday_modal/gift_icon_large.png\" alt=\"birthday info\"></div>\n      <h3>Coming Soon... birthday gift suggestion for "+l+"</h3>\n    </div>\n    <div class='face_identify_header'>\n      <div class='face'>\n        <div class='person_face person_details_face' style='background-image: url("+a+")'></div>\n      </div>\n      <div class='face_identify_header_right'>\n        <p class='description'>\n          Select "+r+' and get the best gift ready for you to buy!\n        </p>\n        <div class="person_details_row">\n          <div class="row dropdownRow" style="display:'+n+';">\n            <div class="info relationship editable">\n              <span class="text">Relationship</span>\n              <span class="dropdown suggestion relationship-dropdown"></span>\n            </div>\n          </div>\n          <div class="row dropdownRow" style="display:'+i+';">\n            <div class="info bday">\n              <span class="text">\n                <span class="dateStr">'+t+"</span>\n                <span class=\"arrow\"></span>\n              </span>\n              <span class=\"dropdown suggestion\"></span>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div><!--//face_identify_header-->\n  </div><!--//face_identify_wrapper-->\n</div>\n<div class='tl_modal_bottom_right_done'>\n  <a id='person_details_done' class='done-btn orange-btn'>Done</a>\n</div>\n"},keepGoing:function(e){var t;return t="<div class='face_identify_keep_going'>",e.to_tag>0&&(t+="<p class='num_to_tag_faces'>See <strong>"+e.to_tag+"</strong> more faces"+(e.name?" of "+e.name:"")+"</p> <img src='/assets/1px.gif'>"),e.tagged>0&&(t+="<p class='num_tagged_faces'>You have tagged <strong>"+e.tagged+"</strong> faces!</p>"),t+="</div>"},numTagged:function(e){var t;return t=1===e?"":"s","<div class='face_identify_count'> <img src='/assets/1px.gif' /> You have tagged <strong>"+e+"</strong> Face"+t+"! </div>"},newFace:function(e){return'<h2 class=\'face_suggestions\'>Who is this person?</h2>\n<p class=\'face_suggestions\'>Type a name and select all faces that are <strong>not</strong> this person.</p>\n<div class="face_identify_name face_suggestions">\n  <input type="text" placeholder="Type a name\u2026" data-person-tag-uid="'+e+'" tabindex=\'-1\'><a class="orange-btn">Save</a>\n  <div class="warning_icon"></div>\n</div>\n<div class="face_identify_dropdown" id="face_identify_dropdown-people">\n  <div class="face_identify_dropdown-triangle"></div>\n  <div class="face_identify_dropdown-scroll-area"></div>\n</div>'},people:function(){return"<div class='tl_modal_middle' id='tl_face_identify_middle'> <div class='close-btn'><img src='/assets/1px.gif' /></div> <div id='face_identify_wrapper' style='position: relative; overflow-x: hidden; overflow-y: hidden; '> </div> <div class='face_identify_bottom' style='display:none;'> </div><!--//face_identify_bottom--> </div> "+e()},suggestion:function(e){var t,i;return i=ThisLife.Helper.String.escapeHtml(e.name),t=e.facebook,"<h2 class='jeff_script'>"+i+"?</h2>\n<p>Confirm"+(t?" Facebook":"")+" friend and select faces that are <strong>not</strong> this person.</p>\n<a class='orange-btn small-btn'>Yes, confirm</a>\n<a class='porcelain-btn small-btn not_possible_match'>No</a>\n<a class='porcelain-btn small-btn ignore_possible_match'>Ignore this Person</a>"},known:function(e){var t,i;return i=ThisLife.Helper.String.escapeHtml(e.getPersonTagName()),t="01-01-2000","<div class='face_identify_header clearfix'> <div class='face_identify_header_right face_suggestions face_known'> <h2 class='face_suggestions'><span>"+i+"<img src='/assets/1px.gif' class='pencil_icon' /></span></h2> <p class='face_suggestions'>Cross out faces that are <strong>not</strong> "+i+".</p> <div class='disabled_tooltip_wrap'> <div class='disabled_tooltip'> <div class='tooltip_arrow'></div> Change Name </div> </div> </div> <div class='edit_person_row'> <div class='row'> <div class='label'>Relationship:</div> <div class='info relationship'> <span class='text'>Relationship</span> <span class='dropdown'></span> </div> </div> <div class='row'> <div class='label'>Birthday:</div> <div class='info bday'> <span class='text'>"+t+"</span> <span class='dropdown'></span> </div> </div> </div> </div>"},no_faces:function(){return"<div class='inner_modal' id='no_faces'> <div><h3>You have no more faces to identify right now.</h3></div> <div class='no_faces'></div> <span class='caption'>Upload photos with people in them and we'll automatically scan them for faces.<br/>This information is private.</span> </div>"},"final":function(){return"<div id='rescanning_faces'> <div> <h1>Rescanning for new Faces</h1> <p>We\u2019re rescanning your Library for new face suggestions.<br>This might take a while.</p> </div> <img src='/assets/1px.gif' class='rotating_radar'> <img src='/assets/face-empty.png' class='empty_face'> </div>"},unknown:function(e){var i;return i=e.uid,"<div class='face_identify_header clearfix'> <div class='face_identify_header_right face_suggestions'> "+t.newFace(i)+" </div> </div>"}},ThisLife.Templates.suggestedPeople=function(e,i){return t[e](i)}}.call(this),function(){ThisLife.generalBlackModal=_.template('<div class="popover one_button_modal" style="display: block" id="<%= id %>">\n  <span class="close-btn"><img src="/assets/1px.gif"></span>\n  <div class="body">\n    <h4><%= heading %></h4>\n    <div class=\'modal_information\'>\n    <%= body %>\n    </div>\n  \n\n  <div class="action_btn_wrap clearfix">\n      <a class="orange-btn small-btn"><%= closeText %></a>\n      <% if (cancelText) {%>\n        <a class="gray-btn cancel-btn  small-btn"><%= cancelText %></a>\n      <% }%>\n   </div>\n</div>\n\n</div>')}.call(this),function(){var e,t,i,n,o,s;ThisLife.Templates.actionBar=function(e,t){return o[e](t)},o={topTemplate:function(e){var t,i;return i=String(e.view),t="",e.type||"facebook"===i||(t+="popover "),t+=null!=e.additionalClass?e.additionalClass:"","<div class='"+t+"'>\n <span class='close-btn js_close_popup'><img src='/assets/1px.gif'></span>\n <div class='body'>"},oneButtonTemplate:function(e){var t,i;return i=e.id?"id="+e.id:"",t=e.className?e.className:"",'   <div class="action_btn_wrap clearfix">\n    <a '+i+' class="orange-btn done-btn '+t+'">'+e.text+"</a>\n  </div>\n\n</div>\n"},twoButtonTemplate:function(e){var t,i,n,o;return n=e.id1?"id="+e.id1:"",o=e.id2?"id="+e.id2:"",t=e.class1?e.class1:"",i=e.class2?e.class2:"",'  <div class="action_btn_wrap clearfix">\n      <a '+n+' class="gray-btn cancel_btn '+t+'">'+e.button1+"</a>\n      <a "+o+' class="orange-btn done-btn '+i+'">'+e.button2+"</a>\n  </div>\n</div>"},bottomTemplate:function(e){return e=String(e),"tags"===e?"</div>\n<div class='tl_modal_bottom'>\n  <div class='tl_modal_bottom_right'>\n    <a class='small-btn orange-btn js_done_tagging'>Done</a>\n  </div>\n</div>":"</div>\n<div class='tl_modal_bottom'>\n  <div class='tl_modal_bottom_left'>\n    <a id='prev_face' class='small-btn porcelain-btn'>Cancel</a>\n  </div>\n  <div class='tl_modal_bottom_right'>\n    <a id='next_face' class='small-btn orange-btn'>Share</a>\n  </div>\n</div><!--//tl_modal_bottom-->"},postedToService:function(e){var t;return t=e.length?e.length+" shared!":""+e.text,'<div class="inner_modal action_bar_prompt action_bar_shared">\n  <div class="tagging auto_share">\n    <div class="section"><img src="/assets/1px.gif">'+t+" </div>\n  </div>\n</div>"},count:function(e,t){var i;return null==t&&(t="Moment"),i="fullView"===ThisLife.app.currentState.name?"image"===options.collection.getMomentType()?"photo":"video":ThisLife.app.controller("selection").getCollection().getDescription(),e+" "+i+" selected"},email:function(){var e;return e="Type a name or email address here&hellip;",this.topTemplate({view:"email",additionalClass:"two_button_modal email"})+"\n       <h4>Share via Email</h4>\n       <div class='modal_information'>\n         <div class='section'>\n           <div class='label'>Send to</div>\n           <div class='recipients'>\n             <div class='recipients_input'>\n             <input type='text' placeholder='"+e+"' data-placeholder='"+e+"' id='share_recipients' />\n             <div class=\"warning_icon\"></div>\n             </div>\n           </div>\n\n           <div class=\"suggestions_wrap\"></div>\n\n           <div class='add_people' style='display: none;'>\n             <div class='label'>Send to the people that are in these photos?</div>\n             <ul id='people_in_moments'></ul>\n           </div>\n           <ul>\n             <li>\n               <div class=\"small-checkbox-wrap\">\n                 <input type='checkbox' name=\"include_self\" id=\"include_self_checkbox\" checked/> <label for=\"include_self_checkbox\"></label>\n               </div>\n               <span class=\"include_self_checkbox_label\">Send me a copy</span>\n             </li>\n           </ul>\n         </div><!--//section-->\n\n         <div class='section'>\n           <div class='label'>Message</div>\n           <textarea placeholder='Add an optional message&hellip;'></textarea>\n         </div>\n         <img src=\"/assets/loading.gif\" id=\"share_loading\" />\n       </div>\n "+this.twoButtonTemplate({button1:"Cancel",button2:"Share",id2:"next_face",id1:"prev_face"})+"\n"},download:function(e){var t,i,n,o,s,r,l,a;return l=("function"==typeof(t=e.collection).getImages?t.getImages().length:void 0)||("function"==typeof(i=e.collection).getNumPhotos?i.getNumPhotos():void 0),a=("function"==typeof(n=e.collection).getVideos?n.getVideos().length:void 0)||("function"==typeof(o=e.collection).getNumVideos?o.getNumVideos():void 0),l&&a?(s=ThisLife.Helper.String.pluralize(l,"photo"),s+=" and ",s+=ThisLife.Helper.String.pluralize(a,"video")):l?s=ThisLife.Helper.String.pluralize(l,"photo"):a&&(s=ThisLife.Helper.String.pluralize(a,"video")),r=ThisLife.Model.User.get("email"),'<div class="popover multi_download">\n  <div class="body">\n    <h3>Preparing photos</h3>\n    <p>We are preparing '+s+" for download.</p>\n    <p>Once ready, we will send you an email to<br />\n    "+r+' with a download link.</p>\n  </div>\n  <div class="tl_modal_bottom">\n    <a class="sfly-button js_close_popup">Got It</a>\n  </div>\n</div>'},link:function(){return"  "+this.topTemplate({view:"link",additionalClass:"one_button_modal link"})+'\n<h4>Copy link to share</h4>\n<div class=\'modal_information\'>\n  <input type="text" value="Loading&hellip;" readonly></input>\n</div>\n'},facebook:function(e){var i,n,o,s,r,l,a,u,c,d,h,p,f,m,g,v;if(p=ThisLife.Model.User.toJSON(),o=1===e.num?"medium":"small",l="",i="",a=0,e.shareAlbum?n="":e.facebook?(r=e.hasPermission?"":"disabled",n=this.twoButtonTemplate({id1:"prev_face",id2:"post_to_facebook",button1:"Cancel",button2:"Post to Facebook",class2:r})):n=this.twoButtonTemplate({id1:"prev_face",button1:"Cancel",button2:"",class2:"hidden"}),d=e.shareAlbum?"":this.topTemplate({view:"facebook",additionalClass:e.loading?"modal_container facebook loading":"modal_container facebook"}),e.collection){for(g=e.collection.models,u=0,c=g.length;c>u&&(h=g[u],f=h.toJSON(),s=h.isMine?null:f.story_moment_created_by||f.created_by_uid,l+="video"===f.moment_type?'<div class="photo video_moment" style="background-image: url('+ThisLife.Helper.Image.imgUrl(f.uid,o,f.effects_modified_date,s)+')">\n  <div class="play_btn"><img src="/assets/1px.gif" /></div>\n</div>':'<div class="photo" style="background-image: url('+ThisLife.Helper.Image.imgUrl(f.uid,o,f.effects_modified_date,s)+')"></div>',a++,6!==a);u++);v=e.collection.videoCount(),m=e.collection.imageCount(),e.hasPermission&&(i+='<div class="fb_preview_album_select">\n  <div class="default">\n    <p>\n      '+(v>0?"Videos will be added to <strong>Videos</strong> album.<br />":"")+"\n      "+(m>0?'Photos will be added to <strong>Shutterfly Photos</strong> album. <a class="edit_fb_album">Edit</a>':"")+'\n    </p>\n  </div>\n  <div class="select_album">\n    <input type="text" name="new_album" placeholder="Enter new" class="new_album" />\n  </div>\n</div>')}else l+='<div class=\'content\'>\n  <div class="photo" style="background-image: url('+e.coverUrl+")\"></div>\n  <div class='description' id='facebook_message'>\n    <div class='story_name' >"+e.storyName+"</div>\n    <div class='story_body'>"+e.description+"</div>\n    <div class='story_footer' >SHUTTERFLY.COM </div>\n  </div>\n</div>";return 4===a&&(l="<div class='grid_4'>\n  "+l+"\n</div>"),d+=e.loading?'<h4>Share via Facebook</h4>\n<div class="connect_overlay">\n</div>\n<div class=\'modal_information\'>\n  <div class="fb_preview">\n    '+t(e,p)+'\n    <div class="facebook_preview_grid count_'+a+" "+(e.coverUrl||e.collection?"":"no_image")+'">\n      '+l+"\n    </div>\n  </div>\n</div>":e.hasPermission?"<h4>Share via Facebook</h4>\n<div class='modal_information'>\n  <div class=\"fb_preview\">\n    "+t(e,p)+'\n    <div class="facebook_preview_grid count_'+a+" "+(e.coverUrl||e.collection?"":"no_image")+'">\n      <textarea id="facebook_caption" placeholder="Type message here..."></textarea>\n      '+l+"\n    </div>\n  </div>\n  "+i+"\n</div>":e.facebook?'<h4>Share via Facebook</h4>\n<div class="connect_overlay">\n  <a id="connect_to_facebook">Allow Post to Facebook</a>\n</div>\n<div class=\'modal_information\'>\n  <div class="fb_preview">\n    '+t(e,p)+'\n    <div class="facebook_preview_grid count_'+a+" "+(e.coverUrl||e.collection?"":"no_image")+'">\n      '+l+"\n    </div>\n  </div>\n</div>":'<h4>Share via Facebook</h4>\n<div class="connect_overlay">\n  <a id="connect_to_facebook">Connect to Facebook</a>\n</div>\n<div class=\'modal_information\'>\n  <div class="fb_preview">\n    '+t(e,p)+'\n    <div class="facebook_preview_grid count_'+a+" "+(e.coverUrl?"":"no_image")+'">\n      '+l+"\n    </div>\n  </div>\n</div>",d+=n},twitter:function(e){var t,i,n,o,s,r,l,a,u,c;return l=ThisLife.Model.User.toJSON(),r=e.collection.first(),a=r.toJSON(),n=r.isMine?null:a.story_moment_created_by||a.created_by_uid,s=ThisLife.Helper.Image.imgUrl(a.uid,"x-small",a.effects_modified_date,n),t=a.width/a.height,1>t?(u=30,o=u/t,c=0):(o=30,u=o*t,c=(u-30)/2),i=this.twoButtonTemplate(e.twitter?{id1:"prev_face",id2:"post_to_twitter",button1:"Cancel",button2:"Post to Twitter"}:{id1:"prev_face",button1:"Cancel",button2:"",class2:"hidden"}),this.topTemplate({view:"twitter",additionalClass:"two_button_modal twitter"})+"\n  "+(e.twitter?"":'<div class="connect_overlay"><a id="connect_to_twitter">Connect to Twitter</a></div>')+'\n  <h3>Share via Twitter</h3>\n  <div class="twitter_preview_wrap">\n    <div class="twitter_preview">\n      <div class="twitter_avatar">\n        <img src="'+(l.avatar||"/assets/people/defaultPerson.png")+'" width="48" height="48" />\n      </div>\n      <div class="twitter_name">\n        <strong>'+l.full_name+'</strong>\n      </div>\n      <div class="twitter_input">\n        <div class="twitter_thumbs">\n          <div class="preview_thumb '+(e.num>2?"three":e.num>1?"two":"one")+'">\n            <div class="crop_img">\n              <img src="'+s+'" width="'+u+'" height="'+o+'" style="margin-left: -'+c+'px;" />\n            </div>\n          </div>\n        </div>\n        <textarea id="twitter_caption" maxlength="120" placeholder="'+l.first_name+" just shared "+e.num+" "+ThisLife.Helper.String.pluralizePhotosVideos(e.collection.models)+' on #Shutterfly"></textarea>\n        <span id="twitter_count">120</span> \n      </div>\n    </div>\n  </div>\n  '+i},tumblr:function(e){var t,i,n,o;return n=e.collection.first(),o=n.toJSON(),i=n.isMine?null:o.story_moment_created_by||o.created_by_uid,t=this.twoButtonTemplate(e.tumblr?{id1:"prev_face",id2:"post_to_tumblr",button1:"Cancel",button2:"Post to Tumblr"}:{id1:"prev_face",button1:"Cancel",button2:"",class2:"hidden"}),this.topTemplate({view:"tumblr",additionalClass:"two_button_modal tumblr"})+"\n  "+(e.tumblr?"":'<div class="connect_overlay"><a id="connect_to_tumblr">Connect to Tumblr</a></div>')+'\n  <h3>Share via Tumblr</h3>\n  <div class="tumblr_preview_wrap">\n    <div class="tumblr_preview">\n      <div class=\'preview_frame '+(e.num>2?"three":e.num>1?"two":"one")+'\'>\n       <div class="crop_img" style="background-image: url('+ThisLife.Helper.Image.imgUrl(o.uid,"small",o.effects_modified_date,i)+')">\n              '+("video"===o.moment_type?'<div class="play_btn"><img src="/assets/1px.gif" /></div>':"")+'\n      </div>\n      </div>\n      <div class="tumblr_preview_caption">\n        <span>'+e.num+" "+ThisLife.Helper.String.pluralizePhotosVideos(e.collection.models)+' on #Shutterfly</span>\n        <textarea id="tumblr_caption" placeholder="Type a caption here&hellip;"></textarea>\n      </div>\n    </div>\n  </div>\n  '+t},date:function(t){var n;return n=ThisLife.app.isMobile?'<input type="date" name="newDate" id="mobileDate" class="newDate"><label for="mobileDate" id="mobileDateLabel"></lable>':'<div class="select_wrap month">\n  <select>\n    '+i()+'\n  </select>\n</div>\n\n<div class="select_wrap day">\n  <select>\n    '+e(t.days)+'\n  </select>\n</div>\n\n<div class="select_wrap year">\n  <select>\n    '+s()+"\n  </select>\n</div>",this.topTemplate({view:"date",additionalClass:"one_button_modal date"})+"\n  <h4>Edit the date</h4>\n  <div class='modal_information'>\n  \n  "+n+"\n</div>\n"+this.oneButtonTemplate({text:"Set the date"})},timeline_add_empty:function(){var e;return e="albums"===ThisLife.app.currentState.name?"Copy to...":"Add to Album...",'<div class="popover_wrap spinner_modal">\n  <div class="popover">\n    <div class="circular_spinner orange_xlarge"></div>\n    <p>'+e+"</p>\n  </div>\n</div>"},timeline_add:function(){var e;return e="albums"===ThisLife.app.currentState.name?"Copy to...":"Add to Album...",'<div class="popover add_to_story_popover">\n  <span class="close-btn js_close_popup">\n    <img src="/assets/1px.gif">\n  </span>\n  <div class="body">\n    <h3>'+e+'</h3>\n    <div class="albums_list"></div>\n  </div>\n  <div class="footer">\n    <div class="create_story_btn">\n      <span class="icon"></span>\n      <span class="label">Create New Album</span>\n  </div>\n</div>'},moment_move_empty:function(){var e;return e="Move to...",'<div class="popover loading">\n  <span class="close-btn js_close_popup"><img src="/assets/1px.gif"></span>\n <h4>'+e+'</h4>\n  <div class="body">\n  </div>\n</div>'},moment_move:function(){var e;return e="Move to...",'<div class="popover add_to_story_popover">\n  <span class="close-btn js_close_popup">\n    <img src="/assets/1px.gif">\n  </span>\n  <div class="body">\n    <h3>'+e+'</h3>\n    <div class="albums_list"></div>\n  </div>\n  <div class="footer">\n    <div class="create_story_btn">\n      <span class="icon"></span>\n      <span class="label">Create New Album</span>\n  </div>\n</div>'},sharedByEmail:function(e){return"<div class='popover'> <div> <div class='tagging auto_share'> <div class='section'><img src='/assets/1px.gif'>Your "+ThisLife.Helper.String.pluralizePhotosVideos(e)+" "+ThisLife.Helper.String.pluralizeWord(e.length,"is","are")+" shared!</div> </div> </div> </div>"},emailLimitReached:function(){return'<div class=\'popover\'>\n  <div>\n    <div class="share_limit_reached">\n      <div class="section">You\u2019ve reached the limit for email share. Please try again later.</div>\n    </div>\n   </div>\n</div>'}},t=function(e,t){var i;return i="",e.collection?i+=e.num+" "+ThisLife.Helper.String.pluralizePhotosVideos(e.collection.models):i="an album",'<div class="fb_preview_top">\n  <img src="'+(t.avatar||"/assets/people/defaultPerson.png")+'" width="32" height="32" />\n  <strong>\n    '+(t.facebook_name||t.full_name)+" shared "+i+"\n  </strong><br />\n  Just now via Shutterfly\n</div>"},n=function(e){var t,i,n,o,s,r,l,a;return n=e.get("view_only")?"view_only":"",r=ThisLife.Helper.Stories.getStoryNameFromStoryUid(e.get("story_uid")),r=ThisLife.Helper.String.escapeHtml(r),o=e.get("story"),i=o.cover_moment_uid,t=o.cover_owner_uid,l=o.cover_effects_modified_date,s=i?"style='background-image: url("+ThisLife.Helper.Image.imageUrlDim(i,1,l,t)+")'":"style=''",a=o.uid,e.get("view_only")?"":'<li class="'+n+' timeline_add" data-uid="'+a+'"><div class="avatar '+(i?"":"no_avatar")+'" '+s+"></div><span>"+r+"</span></li>"},s=function(){var e,t,i,n,o;for(n="<option value='default' disabled='true'>Year</option>",o=(new Date).getUTCFullYear(),e=t=i=o;1900>=i?1900>=t:t>=1900;e=1900>=i?++t:--t)n+="<option value='"+e+"'>"+e+"</option>";return n},e=function(e){var t,i,n,o;for(e||(e=31),o="<option value='default' disabled='true'>Day</option>",t=i=1,n=e;n>=1?n>=i:i>=n;t=n>=1?++i:--i)o+="<option value='"+t+"'>"+t+"</option>";return o},i=function(){return'<option value="default" disabled="true">Month</option><option value="1">Jan</option><option value="2">Feb</option><option value="3">Mar</option><option value="4">Apr</option><option value="5">May</option><option value="6">Jun</option><option value="7">Jul</option><option value="8">Aug</option><option value="9">Sep</option><option value="10">Oct</option><option value="11">Nov</option><option value="12">Dec</option>'}}.call(this),function(){var e,t,i,n,o,s,r,l,a,u,c,d,h,p,f=[].slice;ThisLife.Templates.secondaryBarLeftBtns=function(){var e,t;return t=arguments[0],e=2<=arguments.length?f.call(arguments,1):[],"function"==typeof h[t]?h[t].apply(h,e):void 0},h={albums:function(e){var t;return t=e?"disabled hidden":"",i(t)+"\n"+a(t)},dayLibrary:function(t){return e(!1)+"\n"+n(t)},monthLibrary:function(e){return this.dayLibrary(e)},yearLibrary:function(e){return this.dayLibrary(e)},people:function(){return""+e("upload")},otherStories:function(){return""+d()},otherStory:function(e,n){var o,s;return o=e?"disabled hidden":"",s=o+" friends",(n?"":t())+"\n"+c(s)+"\n"+i(o)},myAlbums:function(e,t,i){var n,o;return o=e?"":"disabled hidden",n=i?"":"disabled hidden",""+l(n)},album:function(e,t,i,n,o,s){var r,c,d,h,f;return ThisLife.Settings.disableAlbumUpload&&(t=!1),c=e?"":"disabled hidden",f=t?"":"disabled hidden",r=i?"":"disabled hidden",h=o?"":"disabled hidden",d=t||i||o?!1:!0,p(f)+"\n"+l(h)+"\n"+(n?u(r):a(r+" "+s))},myStories:function(){return'<div class="primary_btn new_story">\n  <div class="btn_text">\n    <span>New Story</span>\n  </div>\n  <div class="disabled_tooltip_wrap">\n    <div class="disabled_tooltip">\n      <div class="tooltip_arrow border"></div>\n      <div class="tooltip_arrow"></div>\n      Create a new story\n    </div>\n  </div>\n</div>\n'+d()},myStory:function(e){var n;return n=e?"disabled hidden":"",t()+"\n"+r(n)+"\n"+c(n)+"\n"+i(n)}},n=function(e,t){var i,n;return i=e?"disabled hidden":"",n=t?"left":"",o(i,n)+"\n"+a(i)},e=function(e,t){return null==t&&(t=""),t+=e?"disabled hidden":"",'<div class="primary_btn add '+t+'" data-href="add">\n  <div class="btn_text">\n    <span>Upload</span>\n  </div>\n  <div class="disabled_tooltip_wrap add">\n    <div class="disabled_tooltip">\n      <div class="tooltip_arrow border"></div>\n      <div class="tooltip_arrow"></div>\n      Add more from your desktop<br> or external sources\n    </div>\n  </div>\n</div>'},o=function(e,t){return null==e&&(e=""),null==t&&(t=""),'<div class="primary_btn edit '+e+'" data-href="edit">\n  <div class="btn_text">\n    <span>Organize</span>\n  </div>\n  <div class="disabled_tooltip_wrap '+t+'">\n    <div class="disabled_tooltip">\n      <div class="tooltip_arrow border"></div>\n      <div class="tooltip_arrow"></div>\n      Select to tag, add to album, <br /> rate and more\n    </div>\n  </div>\n</div>'},u=function(e){return null==e&&(e=""),'<div class="top_bar_dropdown section_dropdown action_dropdown share_dropdown '+e+'">\n<div class="label action_dropdown_share">\n  SHARE\n</div>\n<div class="dropdown share_dropdown_box">\n    <ul>\n      <li class="share border" >\n          Share Album\n        </li>\n      <li class="share friends" >\n          Select Photos\n        </li>\n      </ul>\n  </div>\n  </div>'},l=function(e){return null==e&&(e=""),'<div class="primary_btn organize '+e+'" data-href="organize">\n  <div class="btn_text">\n    <span>Organize</span>\n  </div>\n  <div class="disabled_tooltip_wrap">\n    <div class="disabled_tooltip">\n      <div class="tooltip_arrow border"></div>\n      <div class="tooltip_arrow"></div>\n      Organize your albums\n    </div>\n  </div>\n</div>'},p=function(e){return null==e&&(e=""),'<div class="primary_btn upload '+e+'" data-href="upload">\n  <div class="btn_text">\n    <span>Add</span>\n  </div>\n  <div class="disabled_tooltip_wrap">\n    <div class="disabled_tooltip">\n      <div class="tooltip_arrow border"></div>\n      <div class="tooltip_arrow"></div>\n      Upload\n    </div>\n  </div>\n</div>'},a=function(e){return null==e&&(e=""),'<div class="primary_btn share '+e+'" data-href="share">\n  <div class="btn_text">\n    <span>Share</span>\n  </div>\n  <div class="disabled_tooltip_wrap share">\n    <div class="disabled_tooltip">\n      <div class="tooltip_arrow border"></div>\n      <div class="tooltip_arrow"></div>\n      Select to share via email,<br /> Facebook, and more\n    </div>\n  </div>\n</div>'},s=function(e){return null==e&&(e=""),'<div class="primary_btn edit_profile '+e+'" data-href="edit_profile">\n  <div class="btn_text">\n    <span>Edit Profile</span>\n  </div>\n  <div class="disabled_tooltip_wrap share">\n    <div class="disabled_tooltip">\n      <div class="tooltip_arrow border"></div>\n      <div class="tooltip_arrow"></div>\n      Edit this persons profile\n    </div>\n  </div>\n</div>'},t=function(){var e;return e=ThisLife.Model.User.isPaidAccount()?"photos and videos":"photos",'<div class="primary_btn add_to_story">\n  <div class="btn_text">\n    <span>Add</span>\n  </div>\n  <div class="disabled_tooltip_wrap">\n    <div class="disabled_tooltip">\n      <div class="tooltip_arrow border"></div>\n      <div class="tooltip_arrow"></div>\n      Add '+e+"<br />from all photos to this album\n    </div>\n  </div>\n</div>"},r=function(e){return null==e&&(e=""),'<div class="primary_btn edit '+e+'" data-href="edit">\n  <div class="btn_text">\n    <span>Organize</span>\n  </div>\n  <div class="disabled_tooltip_wrap">\n    <div class="disabled_tooltip">\n      <div class="tooltip_arrow border"></div>\n      <div class="tooltip_arrow"></div>\n      Select to remove from album,<br />tag, and add to another album\n    </div>\n  </div>\n</div>'},c=function(e){return null==e&&(e=""),'<div class="primary_btn share_story '+e+'" data-href="share_story">\n  <div class="btn_text">\n    <span>Share</span>\n  </div>\n  <div class="disabled_tooltip_wrap">\n    <div class="disabled_tooltip">\n      <div class="tooltip_arrow border"></div>\n      <div class="tooltip_arrow"></div>\n      Share this Album by email,<br /> Facebook or with a link\n    </div>\n  </div>\n</div>'},i=function(e){return null==e&&(e=""),'<div class="primary_btn create_story '+e+'" data-href="create">\n  <div class="btn_text">\n    <span>Create</span>\n  </div>\n  <div class="disabled_tooltip_wrap">\n    <div class="disabled_tooltip">\n      <div class="tooltip_arrow border"></div>\n      <div class="tooltip_arrow"></div>\n      Select to create Shutterfly<br /> photo books, cards, gifts and more\n      <div class="img"></div>\n    </div>\n  </div>\n</div>'},d=function(){return'<div class="primary_orange_btn invitations '+(ThisLife.Model.masterStory.invitedStories.length>0?"":"hide")+'">\n  <div class="orange-btn">\n    Invitations\n    <div class="notify" data-count="'+ThisLife.Model.masterStory.invitedStories.length+'"></div>\n  </div>\n</div>'}}.call(this),function(){var e,t,i;ThisLife.Service.TmsTracking={trackUploadMoments:function(){return i("https://adfarm.mediaplex.com/ad/bk/24970-184801-3840-0?thislife_upload=1&amp;mpuid=")},trackShareAction:function(){return i("https://adfarm.mediaplex.com/ad/bk/24970-184801-3840-0?thislife_share=1&amp;mpuid=")},trackCreatePhotobooks:function(){return i("https://adfarm.mediaplex.com/ad/bk/24970-184801-3840-0?thislife_create_pb=1&amp;mpuid=")},trackCreateCalendars:function(){return i("https://adfarm.mediaplex.com/ad/bk/24970-184801-3840-0?thislife_create_calendar=1&amp;mpuid=")},trackCreateCards:function(){return i("https://adfarm.mediaplex.com/ad/bk/24970-184801-3840-0?thislife_create_cards=1&amp;mpuid=")},trackCreateGifts:function(){return i("https://adfarm.mediaplex.com/ad/bk/24970-184801-3840-0?thislife_create_gifts=1&amp;mpuid=")},trackCreateHomedecor:function(){return i("https://adfarm.mediaplex.com/ad/bk/24970-184801-3840-0?thislife_create_homedecor=1&amp;mpuid=")}},i=function(i){var n;return n=t(i),e(n)},e=function(e){return document.body.insertAdjacentHTML("beforeend",e)},t=function(e){return'<img src="'+e+'" height="1" width="1" alt="Mediaplex_tag" style="display: none;" />'}}.call(this),function(){var e;e=200,ThisLife.View.CustomSelect=Backbone.View.extend({className:"custom_select",events:{"click .default_label":"clickOpen","click .options_wrap li.clickable":"clickItem"},_isOpen:!1,enableDefaultItem:!1,initialize:function(e){return this.options=null!=e?e:{},this.specialType=this.options.specialType,this.source=this.options.source,this.defaultText=this.options.defaultText,this.enableDefaultItem=this.options.enableDefaultItem,this.useTouch=this.options.useTouch||!1,this.render(),this.cacheElements(),this.bindEvents()
},render:function(){var e;return e=this.getContainerTemplate(this.getTemplate(),this.defaultText),this.el.insertAdjacentHTML("beforeend",e),this},cacheElements:function(){return this.optionsWrapEl=this.el.querySelector(".options_wrap"),this.listEl=this.el.querySelector(".options_wrap ul"),this.defaultLabelEl=this.el.querySelector(".default_label"),this.defaultLabelTextEl=this.el.querySelector(".default_label .text")},bindEvents:function(){},unbindEvents:function(){return this.blurDropdown?ThisLife.removeBlurEvent(this.blurDropdown):void 0},clickOpen:function(e){return e.preventDefault(),e.stopPropagation(),this.open()},open:function(){return this.trigger("opened"),this._isOpen=!0,this.el.classList.add("open"),$(this.optionsWrapEl).slideDown(e),this.blurDropdown=ThisLife.blurEvent(this.el.querySelector(".component_wrap"),_.bind(this.close,this),this.useTouch),ThisLife.Support.keyInformant.on("cancel",this.close,this)},close:function(t){return null==t&&(t=!0),this._isOpen=!1,t?$(this.optionsWrapEl).slideUp(e,function(e){return function(){return e.el.classList.remove("open")}}(this)):this.el.classList.remove("open"),this.blurDropdown&&ThisLife.removeBlurEvent(this.blurDropdown,this.useTouch),ThisLife.Support.keyInformant.off("cancel",this.close,this)},isOpen:function(){return this._isOpen},selectItem:function(e){var t,i;return null!=(i=this.listEl.querySelector("li.selected"))&&i.classList.remove("selected"),t=this.listEl.querySelector("li[data-value='"+e+"']"),t&&""!==t.textContent?(t.classList.add("selected"),this.defaultLabelTextEl.textContent=t.textContent):void 0},clickItem:function(e){var t,i,n;return e.stopPropagation(),e.preventDefault(),t=e.currentTarget,n=t.dataset.value,null!=(i=this.listEl.querySelector("li.selected"))&&i.classList.remove("selected"),"-"===n?this.defaultLabelTextEl.textContent=this.defaultText:(this.defaultLabelTextEl.textContent=t.textContent,t.classList.add("selected")),this.close(),this.trigger("selected",n)},getSelectionValue:function(){var e;return null!=(e=this.listEl.querySelector("li.selected"))?e.dataset.value:void 0},getSelectionLabel:function(){var e;return null!=(e=this.listEl.querySelector("li.selected"))?e.textContent:void 0},resetSelection:function(){var e;return null!=(e=this.listEl.querySelector("li.selected"))&&e.classList.remove("selected"),this.defaultLabelTextEl.textContent=this.defaultText},teardown:function(){return this.trigger("closed"),this.unbindEvents(),this.remove()},getTemplate:function(){return this.getGroupedTemplate()},getGroupedTemplate:function(){var e,t,i,n,o,s,r,l,a,u,c,d,h,p;h=this.source,n=this.options.id,u=null!=this.options.selected?this.options.selected:"00",e=null!=this.options.dontShowTitles?this.options.dontShowTitles:!1,l=null!=this.options.longText?"long_text":"",p=null!=this.options.useGroupDivider?this.options.useGroupDivider:!1,p&&(d=!0),r="",this.enableDefaultItem&&(r+="<li class='clickable "+l+"' data-value='-'>-</li>");for(i in h)for(t=h[i],e||(r+="<li class='group_title'>"+i+"</li>"),p&&(d?d=!1:r+="<li class='group_divider'></li>"),o=0,s=t.length;s>o;o++)a=t[o],c=a.key===u?"selected":"",r+="<li class='clickable "+l+" "+c+"' data-value='"+a.key+"'>"+a.value+"</li>";return r},getContainerTemplate:function(e,t){return null==e&&(e=""),null==t&&(t=""),'<div class="component_wrap">\n  <div class="default_label">\n    <span class="text">'+t+'</span>\n    <span class="arrow"></span>\n  </div>\n  <div class="options_wrap">\n    <div class="scroll_area">\n      <ul>\n        '+e+"\n      </ul>\n    </div>\n  </div>\n</div>"}}),ThisLife.View.NumericCustomSelect=ThisLife.View.CustomSelect.extend({initialize:function(e){return this.options=null!=e?e:{},this.defaultText=this.options.defaultText,this.rangeStart=this.options.rangeStart,this.rangeEnd=this.options.rangeEnd,this.rangeMinStringLength=this.options.rangeMinStringLength,this.selectedItem=this.options.selected,this.enableDefaultItem=this.options.enableDefaultItem,this.render(),this.cacheElements(),this.bindEvents()},getTemplate:function(){var e,t,i,n,o,s,r,l;for(i="",r=ThisLife.Helper.String.pad(this.selectedItem,this.rangeMinStringLength),this.enableDefaultItem&&(i+="<li class='clickable' data-value='-'>-</li>"),e=t=n=this.rangeStart,o=this.rangeEnd;o>=n?o>=t:t>=o;e=o>=n?++t:--t)l=ThisLife.Helper.String.pad(e,this.rangeMinStringLength),s=r===l?"selected":"",i+="<li class='clickable "+s+"' data-value='"+l+"'>"+e+"</li>";return i},updateRange:function(e,t){var i;return this.rangeStart=e,this.rangeEnd=this.options.rangeEnd=t,i=this.getSelectionValue(),this.listEl.innerHTML="",this.listEl.insertAdjacentHTML("beforeend",this.getTemplate()),e>i||i>t?this.resetSelection():void 0}}),ThisLife.View.MonthCustomSelect=ThisLife.View.CustomSelect.extend({initialize:function(e){return this.options=null!=e?e:{},this.defaultText=this.options.defaultText,this.selectedItem=this.options.selected,this.enableDefaultItem=this.options.enableDefaultItem,this.render(),this.cacheElements(),this.bindEvents()},getTemplate:function(){var e,t,i,n,o;for(i="",e=1,this.enableDefaultItem&&(i+="<li class='clickable' data-value='-'>-</li>");12>=e;)o=ThisLife.Helper.String.pad(e,2),t=ThisLife.Helper.Date.getAbrevMonth(o),n=this.selectedItem===o?"selected":"",i+="<li class='clickable "+n+"' data-value='"+o+"'>"+t+"</li>",e++;return i}})}.call(this),function(){var e,t,i,n,o,s,r,l;ThisLife.View.NoMomentsView=e=Backbone.View.extend({className:"empty_box",events:{"click .box a":"import","click .ownerBox a":"goToLibrary","click .back_to_following_stories":"backToFollowingStories","click .new-btn":"goToLibrary","click .upload-btn:not(.disabled)":"import","click div.footer a:not(.disabled)":"import"},initialize:function(e){return this.options=null!=e?e:{},this.album=this.options.album},getTemplate:function(){switch(this.options.id){case"life-empty":return ThisLife.app.isMobile?i:t;case"timeline-empty":return l(this.album);case"album-empty-viewer":return r;case"album-empty-contributor":return s(this.album);case"people-empty":return o}},render:function(){var e,t,i;return i=this.getTemplate(),this.$el.css({direction:"ltr"}).html(i),this.uploadView=null!=(e=ThisLife.Uploader)?new e.View.Uploader:void 0,null!=(t=this.el.querySelector(".dz_upload_clickable_placeholder"))&&t.appendChild(this.uploadView.el),("undefined"!=typeof Dropzone&&null!==Dropzone?Dropzone.dragAndDropSupport:void 0)||$(this.el.querySelector(".header-text")).text(""),this._cacheElements(),this},_cacheElements:function(){return this._uploadButtonEl=this.el.querySelector("div.footer a")},hide:function(){return this.el.style.display="none"},show:function(){return this.el.style.display="block"},"import":function(){return ThisLife.app.router.navigateToAdd()},goToLibrary:function(){return this.album?ThisLife.app.controller("selection").start({storyUid:this.album.id,collection:null,models:null,replaceUrl:!0}):void 0},backToFollowingStories:function(){return ThisLife.app.router.navigateToStoriesFollowing()}}),t=function(){var e,t;return e=ThisLife.Model.User.isPaidAccount()?"photos and videos":"photos",t=ThisLife.Model.User.isPaidAccount()?"photos or videos":"photos","<div class='empty-grid album timeline'>\n  <div class='image'></div>\n  <div class='text'>\n    You have not uploaded any "+t+" yet\n    <span class='subtext'>\n      <a class=\"orange-btn upload-btn\">START UPLOADING</a>\n      <div class='tip'>\n        If you've started an import, it may take several minutes for your "+e+" to start appearing\n      </div>\n    </span>\n  </div>\n</div>"},i=function(){var e,t;return e=ThisLife.Model.User.isPaidAccount()?"photos and videos":"photos",t=ThisLife.Model.User.isPaidAccount()?"photos or videos":"photos","<div class='empty-grid timeline'>\n  <div class='image'></div>\n    <div class='subtext'>\n      You do not have any photos in your timeline. <br> <br>\n      Upload your photos from a desktop computer or the Shutterfly App.\n  </div>\n</div>"},l=function(){var e,t,i,n;return e=(null!=(n=ThisLife.Mode)?n.PublicStory:void 0)?"display: none;":"",t=ThisLife.Model.User.isPaidAccount()?"photos and videos":"photos",i=ThisLife.Model.User.isPaidAccount()?"photos or videos":"photos",ThisLife.Settings.disableAlbumUpload?"  <div class='empty-grid album'>\n    <div class='image'>\n    </div>\n    <div class='text'>\n      You currently do not have "+i+" in this album.\n      <span class='subtext'>\n        <div class='"+e+"'>\n          Select "+t+' from the timeline\n          <a class="orange-btn new-btn">Add from Timeline</a>\n        </div>\n       \n        </span>\n    </div>\n</div>':ThisLife.app.library.noMoments()||ThisLife.app.library.areAllFiltered()?"<div class='empty-grid album'>\n  <div class='image'>\n  </div>\n  <div class='text'>\n    You currently do not have "+i+" in this album.\n    <span class='subtext'>\n      <div class='"+e+"'>\n        <!--Start uploading "+t+' now!-->\n        <div class="header-text"> Drag '+t+' to upload </div>\n        <div class="dz_upload_clickable_placeholder upload-btn"></div>\n      </div>\n     \n      </span>\n  </div>\n</div>':"<div class='empty-grid album'>\n    <div class='image'>\n    </div>\n    <div class='text'>\n      You currently do not have "+i+" in this album.\n      <span class='subtext'>\n        <div class='columns "+e+"'>\n          <div class='column'>\n            <!--Start uploading "+t+' now!-->\n            <div class="header-text"> Drag '+t+" to upload </div>\n            <div class=\"dz_upload_clickable_placeholder upload-btn\"></div>\n          </div>\n          <div class='column middle-column'> OR </div>\n          <div class='column'>\n            Select "+t+' from the timeline\n            <a class="orange-btn new-btn">Add from Timeline</a>\n          </div>\n        </div>\n       \n        </span>\n    </div>\n</div>'},r=function(){var e,t;return e=!(null!=(t=ThisLife.Mode)?t.PublicStory:void 0)&&ThisLife.Model.User.isPaidAccount()?"photos or videos":"photos","<div class='empty-grid album viewer'>\n    <div class='image'>\n    </div>\n    <div class='text'>\n      There are no "+e+" in this album.\n    </div>\n</div>"},s=function(){var e;return e=ThisLife.Model.User.isPaidAccount()?"photos and videos":"photos",ThisLife.Settings.disableAlbumUpload?"<div class='empty-grid album'>\n    <div class='image'>\n    </div>\n    <div class='text'>\n      You have been invited to contribute to this album.\n      <span class='subtext'>\n            Select "+e+' from the timeline\n            <a class="orange-btn new-btn">Add from Timeline</a>           \n        </span>\n    </div>\n</div>':ThisLife.app.library.noMoments()||ThisLife.app.library.areAllFiltered()?"  <div class='empty-grid album'>\n    <div class='image'>\n    </div>\n    <div class='text'>\n      You have been invited to contribute to this album.\n      <span class='subtext'>\n            <!--Start uploading "+e+' now!-->\n            <div class="header-text"> Drag '+e+' to upload </div>\n            <div class="dz_upload_clickable_placeholder upload-btn"></div>\n        </span>\n    </div>\n</div>':"<div class='empty-grid album'>\n    <div class='image'>\n    </div>\n    <div class='text'>\n      You have been invited to contribute to this album.\n      <span class='subtext'>\n        <div class='columns'>\n          <div class='column'>\n            <!--Start uploading "+e+' now!-->\n            <div class="header-text"> Drag '+e+" to upload </div>\n            <div class=\"dz_upload_clickable_placeholder upload-btn\"></div>\n          </div>\n          <div class='column middle-column'> OR </div>\n          <div class='column'>\n            Select "+e+' from the timeline\n            <a class="orange-btn new-btn">Add from Timeline</a>\n          </div>\n        </div>\n       \n        </span>\n    </div>\n</div>'},n=function(){return'<div class="hidden_empty">\n  <div class="all_hidden_message">There are no results for this filter.</div>\n</div>'},o=function(){return" <div class='empty-grid album timeline'>\n    <div class='image'>\n    </div>\n    <div class='text'>\n      Scanning for new faces\n      <span class='subtext'>\n        <div class='tip'>\n          We're scanning your library for new face suggestions.\n          <br/>\n          Please check back later.\n        </div>\n      </span>\n    </div>\n</div>"},_.extend(ThisLife.View.NoMomentsView,{showLibraryEmpty:function(t){var i,n;return n=new e({id:"life-empty"}),i=n.render().el,t.prependChild(i),$(document.getElementsByClassName("date_btns")).addClass("hide"),n},showAlbumEmpty:function(t,i){var n,o,s;return n=t.isFriendsAlbum()?t.isViewOnly()?"album-empty-viewer":"album-empty-contributor":(null!=(o=ThisLife.Mode)?o.PublicStory:void 0)?"album-empty-viewer":"timeline-empty",s=new e({id:n,album:t}),i.appendChild(s.render().el),s},showPeopleEmpty:function(t){var i;return i=new e({id:"people-empty"}),t.prependChild(i.render().el),i}}),define("ThisLife.View.NoMomentsView",[],function(){return ThisLife.View.NoMomentsView})}.call(this),function(){ThisLife.View.DarkModal=Backbone.View.extend({className:"popover_wrap new_popover_wrap sub_popover",initialize:function(e){return this.options=null!=e?e:{},this.setupOptions(),this.render()},setupOptions:function(){return _.bindAll(this,"modalKeys"),this.templateID=this.options.templateID||"",this.heading=this.options.heading||"",this.body=this.options.template||this.options.body||"",this.closeText=this.options.closeText||"",this.cancelText=this.options.cancelText||""},events:{"click .close-btn":"remove","click .cancel-btn":"remove","click .tl_modal_bottom_right > .small-btn":"remove",click:function(e){return e.target.classList.contains("popover_wrap")?this.remove():void 0}},modalKeys:function(e){var t;return 27===e.keyCode&&this.remove(),t=[27,37],this.options.fmv&&-1!==t.indexOf(e.keyCode)&&!$("input, textarea").is(":focus")?this.remove():void 0},render:function(){return document.body.addEventListener("keydown",this.modalKeys,!1),$(this.el).append(ThisLife.generalBlackModal({id:this.templateID,heading:this.heading,body:this.body,closeText:this.closeText,cancelText:this.cancelText})).appendTo(document.body),$(this.el).show().addClass("visible"),this},centerModal:function(){return $.each($("div.modal"),function(){var e,t,i;return i=document.body.clientHeight,e=$(this).height()+20,t=(i-e)/2,$(this).css(e>=i?{top:0}:{top:t})})},remove:function(){return document.body.removeEventListener("keydown",this.modalKeys,!1),$(this.el).remove()}})}.call(this),function(){define("ThisLife.People.Views.Merge",[],function(){var e;return e=Backbone.View.extend({className:"merge-people",initialize:function(e){return this.options=null!=e?e:{},this.render()},render:function(){return this.el.insertAdjacentHTML("beforeend",this.template())},teardown:function(){return this.remove()},template:function(){var e,t,i,n;return i=this.options.source,e=this.options.dest,n="unnamed"===i.get("name")?"":ThisLife.Helper.String.escapeHtml(i.get("name")),t=ThisLife.Helper.String.escapeHtml(e.get("name")),"<div class='first'>\n  <img src=\""+i.getDefaultFaceUrl()+'" />\n  <span class="text">'+n+'</span>\n</div>\n<div>\n  <img src="'+e.getDefaultFaceUrl()+'" />\n  <span class="text" >'+t+"</span>\n</div>\n           \n"}})})}.call(this),function(){define("ThisLife.People.Views.PersonModalSidebar",["ThisLife.People.Views.EditPersonDetails","ThisLife.People.Views.ChangePersonCover"],function(){var e;return e=Backbone.View.extend({className:"person-modal-sidebar",events:{"click .button_wrap a":"changeChildView"},initialize:function(e){return this.options=null!=e?e:{},this.render(),this.setSvgIcons(),this.model.on("count_changed",this.updatePersonCount,this)},render:function(){return this.el.insertAdjacentHTML("beforeend",this.template())},teardown:function(){return this.remove()},setSvgIcons:function(){var e,t,i,n,o,s;return i='<svg viewBox="0 0 18 22" xmlns="http://www.w3.org/2000/svg"><title>icons/account/people</title><defs><path d="M3 22h-.006A1 1 0 0 1 2 20.994c.008-1.296.145-2.948 1.133-4.243.662-.866 1.502-1.421 2.313-1.958.916-.606 1.708-1.13 2.11-2.006.22-.48.035-1.108-.212-1.536l-.17-.295a20.774 20.774 0 0 1-.9-1.662c-1.24-2.648-.916-5.758.807-7.736C7.931.582 9.396 0 11.001 0s3.07.582 3.919 1.558c1.722 1.978 2.046 5.088.808 7.737a21.302 21.302 0 0 1-.905 1.67l-.166.286c-.248.428-.433 1.055-.212 1.536.402.876 1.193 1.4 2.11 2.006.81.537 1.65 1.092 2.312 1.958.99 1.298 1.126 2.949 1.133 4.243A1 1 0 0 1 19.006 22H19a1 1 0 0 1-1-.994c-.006-.983-.093-2.216-.723-3.04-.457-.599-1.122-1.039-1.826-1.505-1.024-.677-2.185-1.445-2.824-2.841-.458-.997-.347-2.257.299-3.37l.168-.29c.299-.515.582-1 .822-1.514.895-1.912.687-4.206-.505-5.576C12.95 2.342 12.005 2 11 2c-1.005 0-1.95.342-2.412.87-1.192 1.37-1.399 3.663-.503 5.577.237.51.518.992.815 1.503l.175.301c.643 1.112.754 2.372.298 3.369-.64 1.397-1.8 2.164-2.824 2.841-.705.466-1.37.906-1.827 1.505-.629.822-.717 2.056-.723 3.04A1 1 0 0 1 3 22" id="icons/account/people-path-1-83413"/></defs><g id="icons/account/people-icon-library-83413" fill="none" fill-rule="evenodd"><g id="icons/account/people-account-83413" transform="translate(-24 -20)"><g id="icons/account/people-icons/account/people-83413" transform="translate(22 20)"><mask id="icons/account/people-mask-2-83413" fill="#fff"><use href="#icons/account/people-path-1-83413"/></mask><g id="icons/account/people-color-/-18.-black_000000-83413" mask="url(#icons/account/people-mask-2-83413)" fill="#58595B"><path id="icons/account/people-black_000000-83413" d="M0 0h22v22H0z"/></g></g></g></g></svg>',t='<svg viewBox="0 0 18 22" xmlns="http://www.w3.org/2000/svg"><title>icons/account/people_selected</title><defs><path d="M20 20.99c0 .27-.1.53-.29.72-.189.18-.439.29-.71.29H3c-.27 0-.52-.11-.71-.29-.189-.19-.29-.45-.29-.72.01-1.29.141-2.94 1.13-4.24.67-.87 1.5-1.42 2.32-1.96.91-.6 1.7-1.13 2.111-2 .219-.48.029-1.11-.221-1.54l-.16-.29c-.31-.52-.63-1.07-.909-1.66-1.241-2.65-.911-5.76.809-7.74C7.93.58 9.4 0 11 0c1.601 0 3.07.58 3.92 1.56 1.721 1.98 2.05 5.09.81 7.73-.28.6-.6 1.15-.91 1.67l-.16.29c-.25.43-.44 1.06-.22 1.54.411.87 1.201 1.4 2.11 2 .82.54 1.65 1.09 2.32 1.96.99 1.3 1.12 2.95 1.13 4.24" id="icons/account/people_selected-path-1-16533"/></defs><g id="icons/account/people_selected-icon-library-16533" fill="none" fill-rule="evenodd"><g id="icons/account/people_selected-account-16533" transform="translate(-109 -20)"><g id="icons/account/people_selected-icons/account/people_selected-16533" transform="translate(107 20)"><mask id="icons/account/people_selected-mask-2-16533" fill="#fff"><use href="#icons/account/people_selected-path-1-16533"/></mask><g id="icons/account/people_selected-color-/-18.-black_000000-16533" mask="url(#icons/account/people_selected-mask-2-16533)" fill="#F05323"><path id="icons/account/people_selected-black_000000-16533" d="M0 0h22v22H0z"/></g></g></g></g></svg>',s='<svg viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg"><title>icons/edit/edit</title><defs><path d="M19 5.59L16.41 3l.98-.97c.61.07 1.49.27 1.9.68.4.4.61 1.26.68 1.91l-.97.97zM5.51 19.08l-3.24.65.65-3.23L15 4.42 17.59 7v.01L5.51 19.08zM20.71 1.3C21.93 2.52 22 4.74 22 4.99c0 .27-.101.53-.29.72l-15 15c-.14.14-.32.24-.51.27l-5 1c-.07.02-.13.02-.2.02-.26 0-.52-.1-.71-.29a.998.998 0 0 1-.27-.9l1-5c.04-.2.13-.37.27-.51l15-15a.95.95 0 0 1 .72-.3c.25.01 2.47.07 3.7 1.3z" id="icons/edit/edit-path-1-13116"/></defs><g id="icons/edit/edit-icon-library-13116" fill="none" fill-rule="evenodd"><g id="icons/edit/edit-edit-13116" transform="translate(-26 -23)"><g id="icons/edit/edit-icons/edit/edit-13116" transform="translate(26 23)"><mask id="icons/edit/edit-mask-2-13116" fill="#fff"><use href="#icons/edit/edit-path-1-13116"/></mask><g id="icons/edit/edit-color-/-18.-black_000000-13116" mask="url(#icons/edit/edit-mask-2-13116)" fill="#58595B"><path id="icons/edit/edit-black_000000-13116" d="M0 0h22v22H0z"/></g></g></g></g></svg>',o='<svg viewBox="0 0 22 22" xmlns="http://www.w3.org/2000/svg"><title>icons/edit/edit_selected</title><defs><path d="M19 5.59L16.41 3l.98-.97c.61.07 1.49.27 1.9.68.4.4.61 1.26.68 1.91l-.97.97zm1.71-4.29C19.48.07 17.26.01 17.01 0a.95.95 0 0 0-.72.3l-14.999 15a.968.968 0 0 0-.27.51l-1 5c-.07.33.04.66.27.9.19.19.45.29.71.29.07 0 .13 0 .2-.02l4.999-1c.19-.03.37-.13.51-.27l15-15c.189-.19.29-.45.29-.72 0-.25-.07-2.47-1.29-3.69z" id="icons/edit/edit_selected-path-1-11191"/></defs><g id="icons/edit/edit_selected-icon-library-11191" fill="none" fill-rule="evenodd"><g id="icons/edit/edit_selected-edit-11191" transform="translate(-110 -23)"><g id="icons/edit/edit_selected-icons/edit/edit_selected-11191" transform="translate(110 23)"><mask id="icons/edit/edit_selected-mask-2-11191" fill="#fff"><use href="#icons/edit/edit_selected-path-1-11191"/></mask><g id="icons/edit/edit_selected-color-/-18.-black_000000-11191" mask="url(#icons/edit/edit_selected-mask-2-11191)" fill="#F05323"><path id="icons/edit/edit_selected-black_000000-11191" d="M0 0h22v22H0z"/></g></g></g></g></svg>',n=this.el.querySelector("#edit-person-details-icon"),n.innerHTML="edit-person-details"===this.options.currentChildView?o:s,e=this.el.querySelector("#change-person-cover-icon"),e.innerHTML="change-person-cover"===this.options.currentChildView?t:i},setActiveView:function(e){switch($(".button_wrap").removeClass("active"),e){case"edit-person-details":$("#edit-person-details-wrapper").addClass("active");break;case"change-person-cover":$("#change-person-cover-wrapper").addClass("active")}return this.setSvgIcons()},changeChildView:function(e){var t;return t=e.currentTarget,$(t).parent().hasClass("active")||($(".button_wrap").removeClass("active"),$(t).parent().addClass("active"),null==this.options.switchChildCallback)?void 0:(this.options.switchChildCallback(t.id),this.setSvgIcons())},updatePersonCover:function(e){var t;return t=this.el.querySelector("#person_cover_face_img"),t.style.backgroundImage="url("+e+")"},updatePersonCount:function(){var e,t;return e=this.model.count,t=this.el.querySelector(".moment-count"),t.innerHTML=e},template:function(){var e,t,i,n;return t=this.options.model,n=t.getDefaultFaceUrl(),e=t.count,i=t.get("uid"),'<div class="face_preview_wrap">\n  <div class="image_wrap">\n    <div id="person_cover_face_img" class="image" style="background-image: url('+n+')"></div>\n    <br/>\n  </div>\n  <div class="moment-count" id="count_'+i+'">'+e+'</div>\n</div>\n<div class="button_section">\n  <div id="edit-person-details-wrapper" class="button_wrap active">\n    <div id="edit-person-details-icon" class="button-icon"></div>\n    <a id="edit-person-details" class="edit_person_details">Edit Information</a>\n    <div class="left_triangle"></div>\n  </div>\n  <div id="change-person-cover-wrapper" class="button_wrap">\n    <div id="change-person-cover-icon" class="button-icon"></div>\n    <a id="change-person-cover" class="change_person_cover">Change Cover</a>\n    <div class="left_triangle"></div>\n  </div>\n</div>\n'}})})}.call(this),function(){define("ThisLife.People.Views.EditPersonDetails",[],function(){var e,t;return e=Backbone.View.extend({className:"person-modal-child-view",id:"edit-person-details-view",events:{"click .face_identify_name .orange-btn:not(.disabled)":"editPersonName","click .face_identify_grid:not(.select_front_image) li":"crossOut","click .person_name":"editName","keypress .person_name":"keypressName","click .info.email input":"editEmail","click .info.relationship .text":"editRelationship","click .info.editable :not(.text):not(.default_label)":"preventDefault","click .info.email .email_input":"stopPropagation"},initialize:function(e){return this.options=null!=e?e:{},this.model=this.options.model,this.crossed=0,_.bindAll(this,"saveName","remove"),this.chosenRelUid=null,this.personPubSub=_.extend({},Backbone.Events),this.bindEvents(),this.selectedFaces=[],this.mode="normal",this.chosenMonth=this.model.get("birth_month"),this.chosenDate=this.model.get("birth_date"),this.chosenYear=this.model.get("birth_year"),this.lastTagName=this.model.get("name"),this.logger=new ThisLife.Model.LogEditPerson(null,{action:"untagface",lifeUid:ThisLife.lifeUid,personUid:this.model.get("uid")}),this.relationshipUid=this.model.get("relationship_type_uid"),this.faceGrid=this.el.querySelector("#main_face_grid"),ThisLife.Collection.relationships.loaded?this.render():ThisLife.Collection.relationships.on("reset",this.render,this)},render:function(){return this.$el.html(ThisLife.Templates.people("editPersonDetailsTemplate",this.model)),this.cacheElements(),this.initializeDropdowns(),this.options.hidden?this.el.classList.add("app_model_view_hidden"):void 0},saveName:function(e){var t;return t=_.unescape(e.trim()),t&&""!==t&&t!==this.lastTagName?(this.model.save("name",t),this.nameEl.value=t):this.cancelEditName(),ThisLife.Support.keyInformant.off("cancel",this.cancelEditName,this),this},mergeToPerson:function(e){var t,i;return i=this.model.get("uid"),e!==i?(t=function(e){return function(){return ThisLife.PubSub.trigger("edit_people:filterView",{model:e.model})}}(this),ThisLife.PubSub.trigger("edit_people:merge",{source:this.model,dist:ThisLife.Collection.personTags.get(e),cancelCallback:t})):void 0},cancelEditName:function(){return this.nameEl.value=this.lastTagName,this.nameEl.blur()},clearName:function(){return this.nameEl.value="",this.nameEl.focus()},cacheElements:function(){return this.nameWrapEl=this.el.querySelector("#faceIdentity"),this.nameEl=this.nameWrapEl.querySelector(".person_name"),this.nameFaceSelectEl=this.el.querySelector(".face_select_prompt .name"),this.personFaceEl=this.el.querySelector(".person_face"),this.faceIdentifyGridEl=this.el.querySelector(".face_identify_grid"),this.relationshipWrapEl=this.el.querySelector(".edit_person_row .info.relationship"),this.birthdayWrapEl=this.el.querySelector(".edit_person_row .info.bday"),this.emailWrapEl=this.el.querySelector(".edit_person_row .info.email")},teardown:function(){return this.remove()},hide:function(){return this.el.classList.add(this.options.hideViewClass),this.options.hidden=!0},show:function(){return this.el.classList.remove(this.options.hideViewClass),this.options.hidden=!1},bindEvents:function(){return!0},initializeDropdowns:function(){var e,t,i,n,o,s;return e=this.chosenMonth,e&&"-"!==e||(e=ThisLife.Helper.String.pad((new Date).getMonth(),2)),s=this.chosenYear,s&&"-"!==s||(s=(new Date).getYear()),null!=(t=this.relationshipDD)&&t.teardown(),this.relationshipDD=new ThisLife.View.CustomSelect({id:"relationship_dropdown",defaultText:"Select Relationship",source:ThisLife.Collection.relationships.getGroupedCollection(),selected:this.relationshipUid,longText:!0}),this.relationshipWrapEl.querySelector(".dropdown").appendChild(this.relationshipDD.el),this.relationshipDD.selectItem(this.model.get("relationship_type_uid")),this.relationshipDD.on("selected",this.onRelationshipSelect,this),this.relationshipDD.on("opened",this.closeEditBirthdate.bind(this,!1),this),null!=(i=this.monthDD)&&i.teardown(),this.monthDD=new ThisLife.View.MonthCustomSelect({id:"month_dropdown",defaultText:"Month",selected:this.chosenMonth,enableDefaultItem:!0}),this.birthdayWrapEl.querySelector(".dropdown").appendChild(this.monthDD.el),this.monthDD.selectItem(this.chosenMonth),this.monthDD.on("selected",this.onMonthSelect,this).on("opened",this.onMonthOpened,this),null!=(n=this.dayDD)&&n.teardown(),this.dayDD=new ThisLife.View.NumericCustomSelect({id:"day_dropdown",defaultText:"Day",rangeStart:1,rangeEnd:ThisLife.Helper.Date.daysInMonth(e,s),rangeMinStringLength:2,selected:this.chosenDate,enableDefaultItem:!0}),this.birthdayWrapEl.querySelector(".dropdown").appendChild(this.dayDD.el),this.dayDD.selectItem(this.chosenDate),this.dayDD.on("selected",this.onDateSelect,this).on("opened",this.onDayOpened,this),null!=(o=this.yearDD)&&o.teardown(),this.yearDD=new ThisLife.View.NumericCustomSelect({id:"year_dropdown",defaultText:"Year",rangeStart:(new Date).getFullYear(),rangeEnd:1900,selected:this.chosenYear,enableDefaultItem:!0}),this.birthdayWrapEl.querySelector(".dropdown").appendChild(this.yearDD.el),this.yearDD.selectItem(this.chosenYear),this.yearDD.on("selected",this.onYearSelect,this).on("opened",this.onYearOpened,this)},editRelationship:function(){return this.closeAllRowEdits(),this.blurRelationship=ThisLife.blurEvent(this.relationshipWrapEl,_.bind(this.closeEditRelationship,this))},editBirthdate:function(){return this.closeAllRowEdits(),this.birthdayWrapEl.classList.add("editable"),this.blurBirthdate=ThisLife.blurEvent(this.birthdayWrapEl,_.bind(this.closeEditBirthdate,this))},editEmail:function(){var e;return this.closeAllRowEdits(),e=this.emailWrapEl.querySelector(".email_input"),this.blurEmail=ThisLife.blurEvent(e,_.bind(this.blurEmailInput,this)),ThisLife.Support.keyInformant.on("cancel",this.blurEmailInput,this),e.focus()},closeAllRowEdits:function(){return this.closeEditRelationship(!1),this.closeEditBirthdate(!1),this.closeEditEmail(!1)},closeEditRelationship:function(e){return null==e&&(e=!0),this.relationshipDD.isOpen()&&this.relationshipDD.close(e),this.blurRelationship?ThisLife.removeBlurEvent(this.blurRelationship):void 0},closeEditBirthdate:function(e){return null==e&&(e=!0),(this.dayDD.isOpen()||this.monthDD.isOpen()||this.yearDD.isOpen())&&(this.dayDD.close(e),this.monthDD.close(e),this.yearDD.close(e)),this.blurBirthdate?ThisLife.removeBlurEvent(this.blurBirthdate):void 0},closeEditEmail:function(e){return null==e&&(e=!1),ThisLife.Helper.DOM.addRemoveClass(this.emailWrapEl,e,"invalid"),e?!1:void 0},getRelationshipName:function(e){return ThisLife.Collection.relationships.getNameByUid(e)||"Relationship"},onRelationshipSelect:function(e){return e?(this.relationship={person_tag_uid:this.model.get("uid"),relationship_type_uid:e},ThisLife.appModel.addUsedRelationship(e),_.delay(function(t){return function(){return t.relationshipWrapEl.querySelector(".text").textContent=t.getRelationshipName(e)}}(this),200),this):void 0},saveRelationship:function(){return ThisLife.Service.api.saveRelationship(this.relationship),this},onMonthSelect:function(e){var t,i,n;return this.chosenMonth=e,"-"===e&&(e=ThisLife.Helper.String.pad((new Date).getMonth(),2)),n=this.chosenYear||(new Date).getYear(),n&&"-"!==n||(n=(new Date).getYear()),t=ThisLife.Helper.Date.daysInMonth(e,n),parseInt(t)!==parseInt(this.dayDD.options.rangeEnd)?(i=this.dayDD.getSelectionValue(),this.dayDD.updateRange(1,parseInt(t)),this.dayDD.selectItem(parseInt(i)>parseInt(t)?ThisLife.Helper.String.pad(t,2):ThisLife.Helper.String.pad(i,2))):void 0},onDateSelect:function(e){return this.chosenDate=e},onYearSelect:function(e){var t,i,n;return i=this.chosenMonth,i&&"-"!==i||(i=ThisLife.Helper.String.pad((new Date).getMonth(),2)),this.chosenYear=e,"-"===e&&(e=(new Date).getYear()),t=ThisLife.Helper.Date.daysInMonth(i,e),parseInt(t)!==parseInt(this.dayDD.options.rangeEnd)?(n=this.dayDD.getSelectionValue(),this.dayDD.updateRange(1,parseInt(t)),this.dayDD.selectItem(parseInt(n)>parseInt(t)?ThisLife.Helper.String.pad(t,2):ThisLife.Helper.String.pad(n,2))):void 0},onMonthOpened:function(){return this.dayDD.close(),this.yearDD.close()},onDayOpened:function(){return this.monthDD.close(),this.yearDD.close()},onYearOpened:function(){return this.monthDD.close(),this.dayDD.close()},savePersonDate:function(){var e,t;return t=!1,e={uid:this.model.get("uid")},null!==this.chosenYear&&this.chosenYear!==this.model.get("birth_year")&&(e.birth_year="-"===this.chosenYear?null:this.chosenYear,t=!0),null!==this.chosenDate&&this.chosenDate!==this.model.get("birth_date")&&(e.birth_date="-"===this.chosenDate?null:this.chosenDate,t=!0),null!==this.chosenMonth&&this.chosenMonth!==this.model.get("birth_month")&&(e.birth_month="-"===this.chosenMonth?null:this.chosenMonth,t=!0),t&&ThisLife.Service.api.savePersonTagBeta(e),t},blurEmailInput:function(){return ThisLife.Support.keyInformant.off("cancel",this.blurEmailInput,this)},savePersonEmail:function(){var e,t;return e=this.emailWrapEl.querySelector(".email_input").value.trim(),ThisLife.removeBlurEvent(this.blurEmail),e===this.model.get("email")?(this.closeEditEmail(),!0):""===e||ThisLife.Helper.Validate.email(e)?(this.model.set("email",e),t={uid:this.model.get("uid"),email:e||null},ThisLife.Service.api.savePersonTagBeta(t),this.closeEditEmail(),!0):(this.closeEditEmail(!0),!1)},savePerson:function(){var e,t,i;return t=this.nameEl.value,this.selectedItem&&this.selectedItem.name!==t?this.mergeToPerson(this.selectedItem.uid):(e=ThisLife.Collection.personTags.findName(t),e&&e.id!==this.model.get("uid")?this.mergeToPerson(e.id):(i=this.savePersonEmail())?(this.saveName(this.nameEl.value),this.savePersonDate(),this.relationship&&this.saveRelationship(),!0):(this.unbindEvents(),!1))},unbindEvents:function(){return this.model.off(null,null,this)},remove:function(){return $(".people_dropdown").remove(),this.unbindEvents(),this.$el.remove()
},editName:function(){return this.editPersonName(this.nameEl),this.nameWrapEl.classList.add("editable"),ThisLife.Support.keyInformant.on("cancel",this.cancelEditName,this)},keypressName:function(e){return this.selectedItem=null,ThisLife.Helper.Keyboard.isEnter(e.keyCode)?(e.preventDefault(),this.nameEl.blur()):void 0},printName:function(e){this.selectedItem=e.data("item"),this.selectedItem},shorthand:function(e){var i,n,o;return o=this,n=_.bind(this.printName,this),i={source:ThisLife.Service.api.combineContacts().toJSON(),value:"name",parent:$(e.parent().find(".face_identify_dropdown-scroll-area")),num:-1,show:function(){return o.$("#face_identify_dropdown-people").show(),$.fn.shorthand.Constructor.prototype.show.call(this)},blur:function(e){return ThisLife.Helper.Keyboard.isEscape(e.keyCode)?this.hide():void 0},sorted:!1,hide:function(){return o.$("#face_identify_dropdown-people").hide(),$.fn.shorthand.Constructor.prototype.hide.call(this)},template:t,menu:'<ul class="people_dropdown suggestions"></ul>',selectCallback:n,caseSensitive:!1},e.shorthand(i)},setupAutoComplete:function(e){return e.shorthand||this.shorthand($(e)),e},editPersonName:function(e){return e=this.setupAutoComplete(e),e.shorthand.select()}}),t='<% var face = default_face_url || "/assets/people/defaultPerson.png" %>\n<% var email = email || null %>\n<% var uid = uid || null %>\n\n<li class="item" data-facebook-uid="<%= facebook_uid %>" data-uid ="<%= uid %>" data-email="<%= email %>">\n    <img src="<%= face %>" class="avatar">\n    <a class="name"></a>\n</li>',e})}.call(this),function(){define("ThisLife.People.Views.ChangePersonCover",["PMCHeimdall","ThisLife.People.Views.FaceThumbnailOverlay"],function(e,t){var i;return i=Backbone.View.extend({className:"person-modal-child-view",id:"change-person-cover-view",initialize:function(e){return this.options=null!=e?e:{},this.personPubSub=_.extend({},Backbone.Events),this.model=this.options.model,this.tempModel=this.model.clone(),this.render()},render:function(){return this.el.insertAdjacentHTML("beforeend",this.template()),this.options.hidden&&this.el.classList.add("app_model_view_hidden"),this.faceGrid=this.el.querySelector("#grid-faces-heimdall")},getFaces:function(){return this.heimdall?!1:(this.addLoader(),this.model.getFaces(_.bind(this.renderFaces,this)))},addLoader:function(){return this.el.classList.add("loading")},removeLoader:function(){return this.el.classList.remove("loading")},renderFaces:function(e){var t,i;return this.faces=e,i=this.model.get("face"),t=e.find(function(e){return e.uid===i}),this.originalFaceId=null!=t?t.uid:void 0,e=_.filter(e,function(){return function(e){var t;return(null!=(t=ThisLife.Collection.moments.get(e.moment_uid))?t.get("hidden"):void 0)===!1}}(this)),this.removeLoader(),this.heimdall?void 0:this.loadHeimdall(e,t)},loadHeimdall:function(i,n){var o,s;return s={actionbar_options:{sections:{left:[{view:"date-summary",options:{hide_checkmark:!0}}],center:[],right:[]}},container:this.faceGrid,environment:ThisLife.Settings.sflyEnv,life_uid:ThisLife.currentLifeOwner,layout:"VerticalCondensed",layout_options:{date_summary:{hide_checkmark:!0},default_size:"small",group_objects:!1,object_sizes:{small:{min_height:102,max_height:102}},offsets:{top:82,left:0,right:0,object:5},overlay:t,view_type:"square",sort_by_attr:"upload_date"},scrubber:"Basic",scrubber_options:{show_markers:!1,show_needle:!1,show_tooltip:!1,vertical:!0},clickCallback:_.bind(this.clickHandler,this)},o=[],_.each(i,function(e){return function(t){var i,s;return s=ThisLife.Collection.moments.get(t.moment_uid),s.get("hidden")===!1?(i=_.extend({},s.attributes),i.moment_date*=1e3,i.upload_date*=1e3,i.uid===(null!=n?n.moment_uid:void 0)&&(i.selected=!0),i.src=e._getImageUrl(t),o.push(i)):void 0}}(this)),this.heimdall=new e(o,s)},clickHandler:function(e,t){var i,n;switch(n=this.faces.find(function(t){return t.moment_uid===e[0]}),this.selectedMomentUid=e[0],t){case"untag":return i=[n.uid],this.model.updateFaces(null,i,null,function(e){return function(){return e.heimdall.removeObjects(e.selectedMomentUid),e.model.count=e.heimdall.getObjectCount(),e.model.trigger("count_changed")}}(this));case"click":return this.selectedFaceUid=n.uid,this.selectFrontImage(n)}},selectFrontImage:function(e){var t;return this.selectedFaceUid&&this.tempModel.set("face",this.selectedFaceUid),t=this._getImageUrl(e),null!=this.options.updatePersonCoverCallback&&this.options.updatePersonCoverCallback(t),$(this.faceGrid).find('.moment.pmc-square[data-uid="'+this.selectedMomentUid+'"]').addClass("selected").siblings().removeClass("selected"),this.personPubSub.trigger("face:showSelected",this.selectedFaceUid)},teardown:function(){return this.remove()},hide:function(){return this.el.classList.add(this.options.hideViewClass),this.options.hidden=!0},show:function(){return this.el.classList.remove(this.options.hideViewClass),this.options.hidden=!1,this.getFaces()},saveCoverImage:function(){return null!=this.selectedFaceUid&&this.selectedFaceUid!==this.originalFaceId?this.model.save("face",this.selectedFaceUid):void 0},_getImageUrl:function(e){var t,i;return null!=e.center_x||null!=e.x?ThisLife.Helper.Image.faceUrl(e.uid):(i=e.moment_uid,t=null,t||(t=ThisLife.Collection.moments.get(i)),t?t.getImageSize("x-small"):ThisLife.Helper.Image.faceUrl(e.uid))},template:function(){return"<div class='top_headline'>Change cover photo.</div>\n<div id=\"grid-faces-heimdall\"></div>"}})})}.call(this),function(){define("ThisLife.People.Views.FaceThumbnailOverlay",[],function(){var e;return e=Backbone.View.extend({className:"facethumbnail-overlay",render:function(){return this.$el.html(this.template()),this},template:function(){return'<div action="untag" class="hover-layer-btn">Untag</div>'}})})}.call(this),function(){ThisLife.View.ModalList=Backbone.View.extend({tagName:"li",className:"face",initialize:function(e){return this.options=null!=e?e:{},_.bindAll(this,"render","hmm")},render:function(){return $(this.el).html(this.options.template(this.model.toJSON())),this}})}.call(this),function(){ThisLife.View.ModalNewPlace=ThisLife.View.DarkModal.extend({events:{click:function(e){return e.target.classList.contains("popover_wrap")?this.remove():void 0},"click .close-btn":"remove","keypress #js_place":function(e){return 13===e.keyCode?this.findPlace():void 0},"keypress #js_place_label":function(e){return 13===e.keyCode?this.savePlace():void 0},"click #js_find_place":"findPlace","click .orange-btn":"savePlace","click .cancel-btn":"remove"},initialize:function(e){return this.options=null!=e?e:{},this.setupOptions(),this.render(),this.$("#js_place_label").val(this.options.placeValue),this.$("#js_place").val(this.options.placeValue),this.setupGoogleMaps(),$("#js_place_label").focus()},setupGoogleMaps:function(){return ThisLife.Helper.Scripts.loadGoogleMaps(this.findPlace,this),this.setPlaceMapImage("https://maps.google.com/maps/api/staticmap?size=400x183&sensor=false")},findPlace:function(){var e;return e=this.$("#js_place").val().trim(),e?this.mapInit(e):void 0},mapInit:function(e){var t,i,n;return n=this,i=new google.maps.Geocoder,t=e,i.geocode({address:t},function(t){return function(i,n){var o;return n===google.maps.GeocoderStatus.OK?(t.createLocationTag(i[0]),o="https://maps.google.com/maps/api/staticmap?zoom=6&size=400x183&markers=color:orange%7C"+t.locationTag.lat+"%2C"+t.locationTag["long"]+"&sensor=false",t.setPlaceMapImage(o),t.options.placeValue=i[0].formatted_address,$("#js_place").val(t.options.placeValue)):(e=ThisLife.Helper.String.escapeHtml(e),$("#place_map").html('<p class="place_error">We couldn\'t find<b class="location_tag_name">'+e+"</b>on the map. Please try a different search term.</p>")),$("#js_place").focus()}}(this))},resultInfo:function(e){return function(t){var i;return null!=(i=_.find(e.address_components,function(e){return _.include(e.types,t)}))?i.short_name:void 0}},createLocationTag:function(e){var t,i,n,o;return t=this.resultInfo(e),o=t("street_number"),n=t("route"),i=o?o+" "+n:n,this.locationTag={address:i,city:""+(t("locality")||""),county:""+(t("administrative_area_level_2")||""),lat:e.geometry.location.lat(),"long":e.geometry.location.lng(),state:""+(t("administrative_area_level_1")||""),zip:""+(t("postal_code")||""),uid:$.Guid.New().toLowerCase()}},savePlace:function(){var e;if(e=this.locationTag)return e.name=this.options.placeValue,ThisLife.Collection.locationTags.add(e),this.options.callback&&this.options.callback(e.uid),this.remove()},setPlaceMapImage:function(){return function(e){return ThisLife.Service.api.getSignedUrl(e,function(e){return $("#place_map").html('<img src="'+e+'"/>')})}}(this)})}.call(this),function(){var e,t,i,n,o,s,r,l,a;ThisLife.View.ModalAlert=Backbone.View.extend({className:"popover_wrap new_popover_wrap",initialize:function(e){return this.options=null!=e?e:{},_.bindAll(this,"keypress")},events:{"click .orange-btn":"confirm","click .gray-btn":"teardown","click .close-btn, .porcelain-btn, .gray-btn":"teardown",click:"clickOutside","click .story_input_field":"removeErrorMessage"},render:function(){var e;return e=l[this.options.template](this.options.item),$(this.el).html(e).show(),this.el.classList.add("visible"),this.setup(),this},clickOutside:function(e){return!this.spinnerActive&&e.target.classList.contains("popover_wrap")?this.teardown(e):void 0},removeErrorMessage:function(){return document.querySelector(".disabled_tooltip_wrap").classList.remove("show")},renderLoadingTemplate:function(){var e;return this.$el.find(".form").hide(),this.spinnerActive=!0,e=l.processingTemplate,this.$el.append(e),this.el.classList.add("visible"),this},removeLoadingTemplate:function(){return this.$el.find(".form").show(),this.spinnerActive=!1,this.$el.find("#processingSpinner").remove(),this.el.classList.remove("visible"),this},setup:function(){return $(document).bind("keydown",this.keypress),ThisLife.Support.keyInformant.on("cancel",this.teardownOnCancel,this)},keypress:function(e){switch(e.keyCode){case 13:return this.confirm(),!1}},teardownOnCancel:function(e){return e.preventDefault(),this.teardown(e)},teardown:function(e){var t;return"object"==typeof e&&null!=this.options.disableCancelKeypressCallback&&"function"==typeof(t=this.options).cancelCallback&&t.cancelCallback(),$(document).unbind("keydown",this.keypress),ThisLife.Support.keyInformant.off("cancel",this.teardownOnCancel,this),this.remove()},changeInnerHTML:function(e,t){return this.$el.html(l[e](t)),this},confirm:function(){var e,t,i,n,o,s,r,l,a,u;switch(this.options.item){case"deleteTimeline":case"deleteFMV":this.model.collection.deleteMoment(this.model);break;case"delete":ThisLife.View.bulkEditBar["delete"]();break;case"logout":t=!0,null!=(i=ThisLife.app)&&"function"==typeof i.controller&&null!=(n=i.controller("timing"))&&n.recordSessionEvents({event:"bulk edit",err:"logout",session_method:"confirm"}),ThisLife.app.logout(t);break;case"invalidToken":null!=(o=ThisLife.app)&&"function"==typeof o.controller&&null!=(s=o.controller("timing"))&&s.recordSessionEvents({event:"bulk edit",err:"invalidToken",session_method:"confirm"}),ThisLife.app.immediateLogout();break;case"apiError":null!=(r=ThisLife.app)&&"function"==typeof r.controller&&null!=(l=r.controller("timing"))&&l.recordSessionEvents({event:"bulk edit",err:"apiError",session_method:"confirm"}),window.location.reload();break;case"createStory":return this.options.callback(this);case"online":null!=(a=ThisLife.app)&&"function"==typeof a.controller&&null!=(u=a.controller("timing"))&&u.recordSessionEvents({event:"bulk edit",err:"online",session_method:"confirm"}),window.location.reload();break;default:"function"==typeof(e=this.options).callback&&e.callback()}return this.teardown()},show:function(){return document.body.appendChild(this.render().el)}}),l={announce:function(e){var t;return t="<p>"+e+"</p>"+i,a(t)},warningTemplate:function(e){var t;return t=null!=e.modalClass?e.modalClass:"",e.oneButton?'<div class="popover one_button_modal warning '+t+'" >\n  <span class="close-btn"><img src="/assets/1px.gif"></span>\n  <h4>'+e.header+"</h4>\n  <div class='modal_information'>\n      "+e.subtext+'\n  </div>\n  <div class="action_btn_wrap clearfix">\n    <a class="orange-btn done-btn">'+e.button1+"</a>\n  </div>\n</div>":'<div class="popover two_button_modal warning '+t+'">\n  <div class="body">\n   <h4>'+e.header+"</h4>\n   <div class='modal_information'>\n      "+e.subtext+'\n    </div>\n   </div>\n\n   <div class="action_btn_wrap clearfix">\n    <a class="gray-btn cancel_btn">'+e.button1+'</a>\n    <a class="orange-btn done-btn">'+e.button2+"</a>\n  </div>\n</div>"},privateAccount:function(){return this.warningTemplate({header:"Private Account",subtext:"We're sorry; it looks like these photos belong to someone else's account. Please contact the person who sent you the message and request that they share these photos with you from ThisLife.<br /><br />Or, try a different account.",button1:"Ok",button2:"Switch Accounts",oneButton:!1})},removeFromStory:function(e){var t,i,n,o,s,r,l,a,u,c,d;return o=[],o.push(null!=(s=ThisLife.app.currentModal)&&null!=(r=s.options)?r.moment:void 0),t=e?"1 photo":0===ThisLife.app.controller("selection").getCollection().models.length?"1 photo":ThisLife.app.controller("selection").getCollection().models.length+" "+ThisLife.Helper.String.pluralizePhotosVideos(null!=(l=ThisLife.app.controller("selection").getCollection())?l.models:void 0),u=e?ThisLife.Helper.String.pluralizePhotosVideos(o):0===ThisLife.app.controller("selection").getCollection().models.length?"photo":ThisLife.Helper.String.pluralizePhotosVideos(null!=(a=ThisLife.app.controller("selection").getCollection())?a.models:void 0),d=e?"This":1===ThisLife.app.controller("selection").getCollection().models.length||0===ThisLife.app.controller("selection").getCollection().models.length?"This":"These",i="Remove "+t+"?",c="This will remove the "+u+" you added to the album. "+d+" "+u+" will remain in your Shutterfly account.",n=e?"":"removefromalbum",this.warningTemplate({header:""+i,subtext:c,button1:"CANCEL",button2:"REMOVE",oneButton:!1,modalClass:n})},emptyTrashCan:function(){var e;return e="Are you sure you want to permanently delete all photos in your trash from Shutterfly?",this.warningTemplate({header:"Empty Trash?",subtext:e,button1:"Cancel",button2:"Yes",oneButton:!1})},deleteMomentView:function(e){var t,i;return t=ThisLife.app.controller("selection").getCount(),i=e?"":"<h5 class='count'>"+t+" items selected</h5>",this.warningTemplate({header:"Delete from All Photos?",subtext:i+" <div>"+(t>1?"They":"It")+" will be deleted from all photos.</div>",button1:"Cancel",button2:"Delete",oneButton:!1})},confirmLogoutView:function(){return this.warningTemplate({header:"Sign Out?",subtext:"You have uploads in progress. If you close Shutterfly Photos, your current uploads will stop. Are you sure?",button1:"Yes, sign out",oneButton:!0})},confirmRefreshView:function(){return this.warningTemplate({header:"Refresh?",subtext:"You have uploads in progress. If you close Shutterfly Photos, your current uploads will stop. Are you sure?",button1:"Yes, refresh",oneButton:!0})},skipForGood:function(){return this.warningTemplate({header:"Are you sure you wish to skip these faces for good?",subtext:"These face will not appear again for you to tag.",button1:"Cancel",button2:"Yes, skip for good",oneButton:!1})},removeVip:function(){return this.warningTemplate({header:"Are you sure you wish to remove this person from My VIP list?",subtext:"You\u2019ll be able to re-add this person as a VIP at any time.",button1:"Cancel",button2:"Yes, remove as VIP",oneButton:!1})},remindBirthday:function(){var e;return e='<div class="bday-item">\n  <img src="/assets/people/bday_modal/bday.png" alt="birthday calendar">\n  <p>Select relationship & B-day.</p>\n</div>\n<div class="bday-item">\n  <img src="/assets/people/bday_modal/clock.png" alt="clocking ringing">\n  <p>Get a reminder before special event.</p>\n</div>\n<div class="bday-item long-item">\n  <img src="/assets/people/bday_modal/gifts.png" alt="gifts">\n  <p>The best photos in the best gift ready for you to buy.</p>\n</div>',this.warningTemplate({header:"New, Birthday Gift Suggestions!",subtext:e,button1:"No thanks",button2:"Select relationship & B-day",oneButton:!1,modalClass:"bday-modal",disableCancelKeypressCallback:!0})},retrySocialService:function(e){var t;return t="<p>Reconnect to "+e.capitalize()+"</p>"+i,a(t)},expiredSocialService:function(e){var t;return t="<p>Your "+e.capitalize()+" account is expired.</p>"+i,a(t)},deletePersonView:function(){var e;return e="<p class='header'>Remove this Person</p><p class='text'>Remove this person from People view? No photos will be deleted.</p>"+n,a(e)},deleteFaceView:function(){var e;return e="<p>Delete this Face?</p>"+t,a(e)},deleteAlbumTemplate:function(){var e;return e="<p>Delete this Album?</p>"+t,a(e)},unfollowStoryTemplate:function(){var e;return e="<p>Remove this Story?</p>"+n,a(e)},deleteLocationTemplate:function(){var e;return e="<p>Permanently delete location?</p>"+t,a(e)},deleteMomentTagTemplate:function(e){var t,i,n;return i=ThisLife.Helper.String.escapeHtml(e.tagName),t=e.count,n=t>1?"s":"",this.warningTemplate({header:"Permanently delete tag?",subtext:i+" ("+t+" item"+n+")",button1:"Cancel",button2:"Delete",oneButton:!1})},changeStoryNameErrorTemplate:function(e){return this.warningTemplate({header:e.heading,subtext:e.message,button1:"Okay",oneButton:!0})},lifeNotFoundAlertTemplate:function(){var e;return e="<p style='padding-top: 21px'>You do not have access<br /> to this life.</p>"+i,a(e)},logOutAlertTemplate:function(){var e;return e="<p>Your Session Has Expired</p>"+i,a(e)},actionPermissionError:function(){var e;return e=ThisLife.Model.User.isPaidAccount()?"Photos and Videos":"Photos",this.warningTemplate({header:"Edit "+e,subtext:"You can only edit "+e.toLowerCase()+" that you contributed. Please change your selection.",button1:"Ok",oneButton:!0})},actionPermissionWarning:function(){var e;return e=ThisLife.Model.User.isPaidAccount()?"Photos and Videos":"Photos",this.warningTemplate({header:"Some edits could not be applied.",subtext:"You can only edit "+e.toLowerCase()+" that you contributed.",button1:"Ok",oneButton:!0})},apiErrorTemplate:function(){var e;return e="<p>We encountered an error.<br/>Please refresh.</p>"+i,a(e)},apiSoftErrorTemplate:function(){var e;return e="<p>We encountered an error.</p>"+i,a(e)},shareSiteErrorTemplate:function(e){return'<div class="popover one_button_modal share_site warning" >\n  <span class="close-btn"><img src="/assets/1px.gif"></span>\n  <div class="body">\n    <div class=\'modal_information\'>\n      '+e+"\n    </div>\n  </div>\n</div>"},videoProcessingTemplate:function(){var e;return e="<p>Whoa cowboy! Your video is still processing...</p>"+i,a(e)},hdProcessingTemplate:function(){var e;return e="<p>HD video is currently processing...</p>"+i,a(e)},vidProcessingTemplate:function(){var e;return e='<img src="/assets/1px.gif" />\n<h2 class="jeff_script">Your video is processing</h2>\n<p>Check back later and you\'ll be able to watch it in its fullscreen glory. Trust us, it\'ll be worth it.</p>\n'+i,a(e,"tl_video_processing")},multiSelectTemplate:function(e){var t;return t="<p>Select photos to "+e+"</p>"+i,a(t)},overLimitEditTemplate:function(e){var t,i,n;return n="Maximum selection for edit",i=ThisLife.Model.User.isPaidAccount()?"photos and videos":"photos",t="You can only select up to "+e+" "+i+" to edit at a given time.",this.overLimitTemplate(n,t)},overLimitDownloadTemplate:function(e){var t,i;return i="Maximum select for download",t="You can select up to "+e+" photos to download at a given time.",this.overLimitTemplate(i,t)},overLimitTemplate:function(e,t){return this.warningTemplate({header:e,subtext:t,button1:"Okay",oneButton:!0})},overLimitShareTemplate:function(e){var t;return t=ThisLife.Model.User.isPaidAccount()?"photos and videos":"photos",this.warningTemplate({header:"Maximum selection for edit",subtext:"You can only select up to "+e+" "+t+" to share at a given time.",button1:"Okay",oneButton:!0})},getChangesSinceFail:function(){var e;return e="<p>Please reload this page to see your updated library.</p>",a(e)},tagAlreadyExistsTemplate:function(){var e;return e="<p>This tag already exists</p>"+i,a(e)},createAlbumTemplate:function(){var e;return e=ThisLife.Model.Albums.Master.maxAlbumTitleLength,'<div class="popover one_button_modal" >\n  <span class="close-btn"><img src="/assets/1px.gif"></span>\n  <h4>Create a new Album</h4>\n  <div class=\'modal_information\'>\n      <form>\n        <label>Album name</label>\n        <input type="text" placeholder="Name for your Album&hellip;" maxlength="'+e+'" />\n          <span class="error-text-icon"><img src="/assets/1px.gif">\n            <div class="disabled_tooltip_wrap">\n              <div class="disabled_tooltip_arrow"></div>\n              <div class="disabled_tooltip">\n                <div class="input_error">Error</div>\n              </div>\n            </div>\n          </span>\n        </form>\n    </div>\n     <div class="action_btn_wrap clearfix">\n      <a class="orange-btn done-btn">Create Album</a>\n    </div>\n  </div>\n</div>'},processingTemplate:function(){return'<div id="processingSpinner" class="confirmation popover">\n  <div class="circular_spinner orange_xlarge "></div>\n  <p>Processing ...</p>\n</div>'},saveStoryMoments:function(t){var i,n,o,s,l;return o=r(t),i=o[0],n=o[1],s=o[2],l="We have added "+i+" "+n+" to<br/><span class='breakable'>"+s+"</span>",e(l)},copySharedMoments:function(t){var i,n,o,s,l;return t.data.shift(),o=r(t),i=o[0],n=o[1],s=o[2],l="We have added "+i+" "+n+" to<br/><span class='breakable'>"+s+"</span>",e(l)},invalidStoryMomentsToAddToAlbum:function(){var t,i;return t=ThisLife.Model.User.isPaidAccount()?"photos or videos":"photos",i="Sorry, no valid new "+t+" found to add to album",e(i)},moveAlbumMoments:function(e){var t,i,n,o,s;return n=r(e),t=n[0],i=n[1],o=n[2],s=t+" "+i.toUpperCase()+" MOVED",ThisLife.app.controller("toast")["new"]({title:s,style:"light",position:"bottom-left"})},deleteStoryMoments:function(e){var t,i,n,o,s;return n=r(e),t=n[0],i=n[1],o=n[2],s=t+" "+i.toUpperCase()+" REMOVED",ThisLife.app.controller("toast")["new"]({title:s,style:"light",position:"bottom-left"})},hideMoment:function(t){var i,n;return n=t.data[0],i="Your <span class='breakable'>"+n+"</span> has been deleted",e(i)},rotateMoments:function(t){var i,n,o;return i=t.length,n=s(i),o=i+" "+n+" been rotated",e(o)},deleteMoments:function(t){var i,n,o;return i=t.length,n=s(i),o=i+" "+n+" been deleted",e(o)},deletePerson:function(t){var i;return i=ThisLife.Helper.String.escapeHtml(t.get("name")),e(i+" has been deleted")},removeFaces:function(t){var i,n;return n=s(t),i=ThisLife.Helper.String.pluralizeWord(t,"face","faces"),e(t+" "+i+n+" been removed")},mergePeople:function(t){var i,n;return i=ThisLife.Helper.String.escapeHtml(t.dest.get("name")),n=ThisLife.Helper.String.escapeHtml(t.src.get("name")),e(n+" has been merged to "+i)},tagRelationship:function(t){var i,n;return n=ThisLife.Helper.String.escapeHtml(t.dest.get("name")).toLowerCase(),i=ThisLife.Helper.String.escapeHtml(t.src.get("name")),e("me"===n?"Thanks, you have tagged yourself":"Thanks, "+i+" is now your "+n)},momentUpdates:function(t){var i,n,o;return i=t.length,n=s(i),o=i+" "+n+" been updated",e(o)},momentHiddenUpdates:function(t){var i,n,o,r;return n=t.length,o=s(n),i=t.data.hidden?"hidden":"unhidden",r=n+" "+o+" been "+i,e(r)}},ThisLife.View.ModalAlert.CONFIRMATION_DELAY=1100,i="<div class='buttons' style='text-align: center;'>\n  <a class='orange-btn small-btn' style='float: none;display: inline-block;'>OK</a>\n</div>",t='<div class="buttons">\n  <a class="porcelain-btn small-btn">Cancel</a>\n  <a class="orange-btn small-btn">Yes, delete</a>\n</div>',n='<div class="buttons">\n  <a class="porcelain-btn small-btn">Cancel</a>\n  <a class="orange-btn small-btn">Remove</a>\n</div>',a=function(e,t,i){return null==t&&(t=""),null==i&&(i=""),'<div class="tl_timeline_tooltip '+t+'" id="'+i+'">'+e+"</div>"},e=function(e,t){return null==t&&(t=""),'<div class="confirmation popover warning '+t+'">\n  <div class="modal_information">\n    '+e+"\n  </div>\n</div>"},r=function(e){var t,i,n,o,s,r,l,a,u;for(u=e.data[0],s=e.data[1],r=s.length,o=[],t=0,n=s.length;n>t;t++)i=s[t],ThisLife.Collection.moments.get(i)&&o.push(ThisLife.Collection.moments.get(i));return o.length!==s.length&&(o=ThisLife.uploader.getRecentUploads()),l=ThisLife.Helper.String.pluralizePhotosVideos(o),a=ThisLife.Model.Albums.Master.getAlbumById(u).get("name"),a=ThisLife.Helper.String.escapeHtml(a),[r,l,a]},s=function(e){return 1===e?" has":" have"},o=function(e){var t,i;return t="<img class='rating_heart_active' border='0' src='/assets/1px.gif' />",i="",e>0&&(i+=t),e>1&&(i+=t),e>2&&(i+=t),i},define("ThisLife.View.ModalAlert",[],function(){return ThisLife.View.ModalAlert})}.call(this),function(){ThisLife.View.SpinnerModal=Backbone.View.extend({className:"popover_wrap spinner_modal",initialize:function(e){var t;return this.options=null!=e?e:{},t=ThisLife.app.isMobile,this.options.hasOwnProperty("color")||(this.options.color="orange"),this.htmlProgress=this.options.progressText?"<p>"+this.options.progressText+"</p>":"",this.options.size=t?"medium":"xlarge",this.render(),this},render:function(){return this.el.insertAdjacentHTML("beforeend",this._getTemplate())},teardown:function(){return this.remove()},_getTemplate:function(){var e;return e="",this.options.color&&(e=" "+this.options.color+"_"+this.options.size),'<div class="popover">\n  <div class="circular_spinner'+e+'"></div>\n  '+this.htmlProgress+"\n</div>"}}),define("ThisLife.View.SpinnerModal",[],function(){return ThisLife.View.SpinnerModal})}.call(this),function(){var e,t,i,n,o,s;ThisLife.View.Import={},e=Backbone.View.extend({el:"#tl_import_modal_wrap",events:{"click .tl_modal_top li a":"switchTab","click .tl_modal_close, span.close-btn":"teardown","click .tl_modal_notification a.circle-x-btn":function(e){var t;return null!=(t=e.currentTarget.parentNode)?t.removeChild(e.currentTarget):void 0}},initialize:function(e){return this.options=null!=e?e:{},this.model=ThisLife.Model.User,this.initializeTabViews(),this.render(),this.cacheElements(),this.lifeUid=ThisLife.lifeUid,ThisLife.app.session.getSessionToken().then(function(e){return function(t){return e.sessionToken=t,e.show()}}(this))},initializeTabViews:function(){return this.importsCount=0,this.facebookView=new ThisLife.View.Import.Facebook({parent:this}),this.instagramView=new ThisLife.View.Import.Instagram({parent:this}),this.flickrView=new ThisLife.View.Import.Flickr({parent:this}),this.smugmugView=new ThisLife.View.Import.Smugmug({parent:this}),this.picasaView=new ThisLife.View.Import.Picasa({parent:this}),this.subViews=[this.facebookView,this.instagramView,this.flickrView,this.smugmugView,this.picasaView]},bindEvents:function(){return ThisLife.Support.keyInformant.on("cancel",this.modalKeysOnCancel,this),ThisLife.PubSub.on("modal:close:social_import_widget",this.teardown,this)},modalKeysOnCancel:function(e){return e.preventDefault(),this.teardown()},show:function(){return this.open=!0,this.bindEvents(),this.showDefaultTab(),_.defer(function(e){return function(){return e.el.classList.add("tl_modal_wrap_visible"),document.getElementById("tl_modal_container").classList.add("visible")}}(this))},render:function(){var e,n,s,r;for(this.el.insertAdjacentHTML("afterbegin",o()),this.renderTabs(),this.el.insertAdjacentHTML("beforeend",i()),this.tabEl=this.el.querySelector(".tl_modal_middle"),s=this.subViews,e=0,n=s.length;n>e;e++)r=s[e],this.tabEl.appendChild(r.render().el);return this.el.insertAdjacentHTML("beforeend",t()),this},renderTabs:function(){var e,t,i,o,s,r;for(this.topBarEl=this.el.querySelector(".add_nav"),o=this.subViews,s=[],e=0,i=o.length;i>e;e++)r=o[e],t=r.label||ThisLife.Helper.String.capitalizeFirstLetter(r.serviceName),s.push(this.topBarEl.insertAdjacentHTML("beforeend",n(r.serviceName,t)));return s},cacheElements:function(){return this.closeBtnEl=this.el.querySelector(".tl_modal_close")},switchTab:function(e){var t;return this.closeBtnEl.classList.add("active"),t=e.currentTarget.id,this.showServiceView(t),this.el.style.zoom=1},showServiceView:function(e){var t,i,n,o,s;for(this.updateTabs(e),o=this.getSubView(e),n=this.subViews,t=0,i=n.length;i>t;t++)s=n[t],s.hide();return o.show()},updateTabs:function(e){var t,i;return i=this.el.querySelector("#tl_import_top_"+e),i.classList.contains("active")?void 0:(null!=(t=this.el.querySelector(".add_nav li.active"))&&t.classList.remove("active"),i.classList.add("active"))},teardown:function(){return this.open=!1,ThisLife.Support.keyInformant.off("cancel",this.modalKeysOnCancel,this),_.defer(function(e){return function(){return e.el.classList.remove("tl_modal_wrap_visible"),document.getElementById("tl_modal_container").classList.remove("visible")}}(this))},showDefaultTab:function(){return this.showServiceView(this.options.tab)},getSubView:function(e){return _.find(this.subViews,function(t){return t.serviceName===e})}}),o=function(){return'<span class="close-btn"><img src="/assets/1px.gif"></span>\n<div class="tl_modal_top">\n  <ul class="add_nav"></ul>\n</div>'},n=function(e,t){return'<li id="tl_import_top_'+e+'"><a id="'+e+'"><span class="icon_'+e+'"></span> '+t+"</a></li>"},i=function(){return'<div class="tl_modal_middle"></div>'},t=function(){return'<div class="tl_modal_bottom">\n  <div class="tl_modal_bottom_right">\n    <a class="tl_modal_close gray-btn">Done</a>\n  </div>\n</div>'},s=null,ThisLife.PubSub.on("modal:show:social_import_widget",function(t){return s?(s.options=t.options,s.show()):s=new e(t.options)})}.call(this),function(){var e,t;ThisLife.View.Import.Social=Backbone.View.extend({className:"tl_modal_middle_tab",events:function(){return _.extend({},this.baseEvents,this.additionalEvents)},baseEvents:{"click .select_photos_albums":"select","click .import_everything":"importAll","click .toggle":"toggleAutoImport"},additionalEvents:{},initialize:function(e){return this.options=null!=e?e:{},this.model=ThisLife.Model.User,this.active=!1,this.importing=!1,this.parent=this.options.parent,this.setup()},setup:function(){},render:function(){return this.el.insertAdjacentHTML("beforeend",this.template(this.model.toJSON())),this.cacheElements(),this.bindEvents(),this},cacheElements:function(){return this.importAllEl=this.el.querySelector(".import_everything"),this.importingEl=this.el.querySelector(".tl_modal_importing"),this.connectEl=this.el.querySelector(".tl_modal_import_connect"),this.connectedEl=this.el.querySelector(".tl_modal_import_connected"),this.connectedRightEl=this.connectedEl.querySelector(".right_col")},bindEvents:function(){return ThisLife.PubSub.on("import_job",this.onImportJob,this),ThisLife.PubSub.on("importComplete",this.onImportComplete,this),ThisLife.PubSub.on(this.serviceName+"_service_required",this.serviceRequired,this),window.addEventListener("message",function(e){return function(t){return e.handleCompleteConnect(t)}}(this),!1),this.bindAdditionalEvents()},bindAdditionalEvents:function(){},show:function(){return this.active=!0,this.el.classList.add("active"),this.showStep()},hide:function(){return this.active=!1,this.el.classList.remove("active")},showStep:function(){return document.body.classList.remove("uploader"),this.showConnectedState()},showConnect:function(){var e,t;return this.resetSteps(),t=ThisLife.services[""+this.serviceName].connect,e=ThisLife.app.socialToken.getServiceIframe(this.serviceName),e.on("load",function(t){return function(){return e[0].contentWindow.postMessage("initialize","*"),t.connectEl.classList.add("active")}}(this)),e.appendTo(this.connectEl.querySelector(".chewing-gum-btn"))},showConnected:function(){return this.resetSteps(),this.connectedEl.classList.add("active")},showImporting:function(){var e;return this.resetSteps(),null!=(e=this.importingEl)&&e.classList.add("active"),this._showProgress()},_showProgress:function(){var e,t;return t=this.model.get(this.serviceName+"_access_token"),t?(e=ThisLife.Helper.String.capitalizeFirstLetter(this.label||this.serviceName),this.parent.importProgress?this.parent.importProgress.view?this.parent.importProgress.addServiceText(e):this.parent.importProgress.getView({service:e}):(this.parent.importProgress=ThisLife.app.controller("importProgress"),this.parent.importProgress.getView({service:e})),this.parent.importsCount++):void 0},resetSteps:function(){var e,t,i,n,o;for(o=this.el.querySelectorAll(".tl_modal_import_step"),i=[],e=0,t=o.length;t>e;e++)n=o[e],i.push(n.classList.remove("active"));return i},onImportComplete:function(){var e,t,i;return this.importing&&this.showConnected(),this.importing=!1,i=ThisLife.Helper.String.capitalizeFirstLetter(this.label||this.serviceName),this.parent.importsCount>1?null!=(e=this.parent.importProgress)&&e.removeServiceText(i):null!=(t=this.parent.importProgress)&&t.removeView(),this.parent.importsCount>0?this.parent.importsCount--:void 0
},getCollectionView:function(){},select:function(){return this.selectView=this.getCollectionView(),this.el.appendChild(this.selectView.render().el),this.selectView.on("remove",this.removeSelect,this),this.resetSteps(),this.selectView.show()},removeSelect:function(e){return null==e&&(e=!1),this.importing=e,this.resetSteps(),e?this.showImporting():this.showConnected(),this.selectView.off("remove",this.removeSelect,this),this.selectView=null},handleCompleteConnect:function(e){var t;return t=new RegExp("social."+ThisLife.Settings.apiSubDomain),t.test(e.origin)&&"newSocialToken"===e.data.type?ThisLife.app.socialToken.importToken(e.data.token):void 0},removeExistingAlbums:function(){return ThisLife.Service["import"][this.serviceName+"Albums"]?ThisLife.Service["import"][this.serviceName+"Albums"]=null:void 0},showConnectedState:function(){var e;return e=this.model.get(this.serviceName+"_access_token"),e?this.showConnected():this.showConnect()},changeAccessToken:function(){return this.removeExistingAlbums(),this.showConnectedState(),this.model.get(this.serviceName+"_auto_import")&&"facebook"!==this.serviceName?this._showProgress():void 0},toggleAutoImport:function(){var e,t;return this.model.get(this.serviceName+"_auto_import")||this._showProgress(),this.toggleDisabled?void 0:(this.toggleDisabled=!0,e=!this.model.get(this.serviceName+"_auto_import"),ThisLife.Service["import"].autoImport(this.serviceName,e),t=this,_.delay(function(){return t.toggleDisabled=!1},2e3))},importAll:function(){var e,t;if(!this.importing)return t=function(e){return function(){return e.onImportAllSuccess()}}(this),e=function(e){return function(t){return e.onImportAllError(t)}}(this),this.importAllEl.textContent="Importing...",this.importing=!0,ThisLife.Service["import"].importAll(this.serviceName,t,e)},onImportAllSuccess:function(){return clearTimeout(this.onImportAllTimer),this.showImporting(),this.importAllEl.textContent="Import Everything",this.importAllEl.classList.add("importing"),this.importingMsgEl||this.importErrorEl||this.importAllEl.insertAdjacentHTML("afterend",t(this.serviceName)),this.importAllTimer=setTimeout(function(e){return function(){var t;return e.importing=!1,e.importAllEl.classList.remove("importing"),e.importingMsgEl=e.el.querySelector(".importing_message"),null!=(t=e.importingMsgEl)&&t.parentNode.removeChild(e.importingMsgEl),e.importingMsgEl=null}}(this),6e4)},onImportAllError:function(t){return clearTimeout(this.importAllTimer),this.importAllEl.textContent="Import Everything",this.importAllEl.classList.add("importing"),this.importingMsgEl||this.importErrorEl||this.importAllEl.insertAdjacentHTML("afterend",e(t)),this.importAllTimer=setTimeout(function(e){return function(){var t;return e.importing=!1,e.importAllEl.classList.remove("importing"),e.importErrorEl=e.el.querySelector(".import_error"),null!=(t=e.importErrorEl)&&t.parentNode.removeChild(e.importErrorEl),e.importErrorEl=null}}(this),1500)},onImportJob:function(e,t){return"COMPLETE"===e&&t.source===this.serviceName?this.showStep():void 0},serviceRequired:function(e){var t;return this.showConnect(),t=new ThisLife.View.ModalAlert({template:"retrySocialService",item:this.serviceName,callback:e}),document.body.appendChild(t.render().el)},template:function(){},importingTemplate:function(e){var t,i;return e?(i="Importing your photos&hellip;",t="Photos will continue to import"):(i="Importing your photos and videos&hellip;",t="Photos and videos will continue to import"),"<div class='tl_modal_import_step tl_modal_importing'>\n  <p class='tl_import_instruction'>"+i+"</p>\n  <div class='import_bar_wrap'>\n    <div class='import_bar'></div>\n  </div>\n  <p class='jeff_script close_prompt'>"+t+"<img src='/assets/1px.gif' /></p>\n</div>"}}),t=function(e){return"<p class='importing_message' style='font: 600 14px/17px;'>You <span id='"+e+"_import_first_started'>just </span>started an import<span id='"+e+"_import_started'></span>.<br/> Your import will continue in the background<br/>and appear in your account.</p>"},e=function(e){return"<p class='import_error' style='margin-top: 15px'>"+e+"</p>"}}.call(this),function(){ThisLife.View.Import.Facebook=ThisLife.View.Import.Social.extend({id:"tl_modal_import_facebook",setup:function(){return this.serviceName="facebook"},bindAdditionalEvents:function(){return this.model.on("change:facebook_access_token",this.changeAccessToken,this)},getCollectionView:function(){return new ThisLife.View.Import.SelectFacebook({service:this.serviceName})},template:function(e){var t;return t=ThisLife.Model.User.isPaidAccount()?"photos and videos":"photos",'<!-- CONNECT -->\n<div class="tl_modal_import_step tl_modal_import_connect'+(e.facebook_access_token?"":" active")+'"  id="tl_modal_facebook_connect">\n  <p class="tl_import_instruction">Select and import '+t+'<br />from your Facebook account</p>\n  <a class="chewing-gum-btn gray-btn " id="connecting_to_facebook"><img src="/assets/1px.gif" class="icon_facebook" />Connect to Facebook</a>\n</div>\n\n<!-- CONNECTED -->\n<div class="tl_modal_import_step tl_modal_import_connected'+(e.facebook_access_token?" active":"")+'" id="tl_modal_facebook_connected">\n  <div class="left_col">\n    <p class="tl_import_instruction">Select photos or albums<br />from your Facebook account</p>\n    <img src="/assets/1px.gif" />\n    <a class="chewing-gum-btn gray-btn  select_photos_albums">Select Photos or Albums</a>\n  </div>\n  <div class="right_col">\n    <p class="tl_import_instruction">Import all '+t+'<br />from your Facebook account</p>\n    <img src="/assets/1px.gif" />\n    <a class="chewing-gum-btn gray-btn import_everything">Import Everything</a>\n  </div>\n</div>\n\n<!-- IMPORTING -->\n'+this.importingTemplate()}})}.call(this),function(){ThisLife.View.Import.Instagram=ThisLife.View.Import.Social.extend({id:"tl_modal_import_instagram",setup:function(){return this.serviceName="instagram"},bindAdditionalEvents:function(){return this.model.on("change:instagram_auto_import",this.toggle,this),this.model.on("change:instagram_access_token",this.changeAccessToken,this)},show:function(){return this.el.classList.add("active"),this.showStep(),this.toggle()},toggle:function(){var e;return e=this.model.get(this.serviceName+"_auto_import"),e?this.connectedEl.classList.add("auto_import_on"):this.connectedEl.classList.remove("auto_import_on")},template:function(e){var t;return t=e[this.serviceName+"_auto_import"]?" auto_import_on":"",'<!-- CONNECTED -->\n<div class="tl_modal_import_step tl_modal_import_connected'+t+'" id="tl_modal_instagram_connected">\n  <img src="/assets/1px.gif"  />\n  <p class="tl_import_instruction">Instagram Auto-Import is now <span class="toggle_on_text">turned on</span><span class="toggle_off_text">turned off</span>.</p>\n  <p id="tl_modal_instagram_detail_instruction_on" class="tl_modal_instagram_detail_instruction">Instagram photos will automatically be added to your Shutterfly Library.</p>\n  <p id="tl_modal_instagram_detail_instruction_off" class="tl_modal_instagram_detail_instruction">Click on the switch below to allow Instagram photos to be automatically added to your Shutterfly library.</p>\n  <!-- Import Toggle -->\n  <div class="auto_import_toggle">\n    Auto-Import\n    <div class="toggle_wrap">\n      <div class="toggle">\n        <span class="toggle_on">On</span>\n        <span class="toggle_off">Off</span>\n        <div class="toggle_handle"></div>\n      </div>\n    </div>\n  </div>\n\n</div>\n\n<!-- CONNECT -->\n<div class="tl_modal_import_step tl_modal_import_connect">\n  <p class="tl_import_instruction">Auto-import photos from<br />your Instagram account</p>\n  <a class="chewing-gum-btn gray-btn " id="connect_to_instagram"><img src="/assets/1px.gif" class="icon_instagram" />Connect to Instagram</a>\n</div>'}})}.call(this),function(){ThisLife.View.Import.Smugmug=ThisLife.View.Import.Social.extend({id:"tl_modal_import_smugmug",setup:function(){return this.serviceName="smugmug",this.label="SmugMug"},bindAdditionalEvents:function(){return this.model.on("change:smugmug_access_token",this.changeAccessToken,this)},template:function(){var e;return e=ThisLife.Model.User.isPaidAccount()?"photos and videos":"photos",'<!-- CONNECTED -->\n<div class="tl_modal_import_step tl_modal_import_connected single" id="tl_modal_smugmug_connected">\n\n  <div class="right_col">\n    <p class="tl_import_instruction">Import all '+e+'<br />from your SmugMug account</p>\n    <img src="/assets/1px.gif" />\n    <a class="chewing-gum-btn gray-btn import_everything">Import Everything</a>\n  </div>\n</div>\n\n<!-- CONNECT -->\n<div class="tl_modal_import_step tl_modal_import_connect" id="tl_modal_smugmug_connect">\n  <p class="tl_import_instruction">Select and import '+e+'<br />from your SmugMug account</p>\n  <a class="chewing-gum-btn gray-btn" id="connect_to_smugmug"><img src="/assets/1px.gif" class="icon_smugmug" />Connect to SmugMug</a>\n</div>\n\n<!-- IMPORTING -->\n'+this.importingTemplate()}})}.call(this),function(){ThisLife.View.Import.Picasa=ThisLife.View.Import.Social.extend({id:"tl_modal_import_picasa",setup:function(){return this.serviceName="picasa",this.label="Google Photos"},bindAdditionalEvents:function(){return this.model.on("change:picasa_access_token",this.changeAccessToken,this)},template:function(){var e;return e=ThisLife.Model.User.isPaidAccount()?"photos and videos":"photos",'<!-- CONNECT -->\n<div class="tl_modal_import_step tl_modal_import_connect"  id="tl_modal_picasa_connect">\n  <p class="tl_import_instruction">Select and import '+e+'<br />from your Google Photos account</p>\n  <a class="chewing-gum-btn gray-btn" id="connect_to_picasa"><img src="/assets/1px.gif" class="icon_picasa" />Connect to Google Photos</a>\n</div>\n\n<!-- CONNECTED -->\n<div class="tl_modal_import_step tl_modal_import_connected single" id="tl_modal_picasa_connected">\n\n  <div class="left_col">\n    <!--<p class="jeff_script">Select photos or albums from<br />your Google Photos account</p>\n    <img src="/assets/1px.gif" />\n    <a class="chewing-gum-btn gray-btn select_photos_albums">Select Photos or Albums</a>-->\n  </div>\n\n  <div class="right_col">\n    <p class="tl_import_instruction">Import all photos from<br />your Google Photos account</p>\n    <img src="/assets/1px.gif" />\n    <a class="chewing-gum-btn gray-btn import_everything" id="import_all_picasa">Import Everything</a>\n  </div>\n</div>\n\n<!-- IMPORTING -->\n'+this.importingTemplate()}})}.call(this),function(){ThisLife.View.Import.Flickr=ThisLife.View.Import.Social.extend({id:"tl_modal_import_flickr",setup:function(){return this.serviceName="flickr"},bindAdditionalEvents:function(){return this.model.on("change:flickr_access_token",this.changeAccessToken,this)},getCollectionView:function(){return new ThisLife.View.Import.SelectFlickr({service:this.serviceName})},template:function(){var e;return e=ThisLife.Model.User.isPaidAccount()?"photos and videos":"photos",'<!-- CONNECT -->\n<div class="tl_modal_import_step tl_modal_import_connect"  id="tl_modal_flickr_connect">\n  <p class="tl_import_instruction">Select and import '+e+'<br />from your Flickr account</p>\n  <a class="chewing-gum-btn gray-btn" id="connect_to_flickr"><img src="/assets/1px.gif" class="icon_flickr" />Connect to Flickr</a>\n</div>\n\n<!-- CONNECTED -->\n<div class="tl_modal_import_step tl_modal_import_connected" id="tl_modal_flickr_connected">\n\n  <div class="left_col">\n    <p class="tl_import_instruction">Select photos or albums from<br />your Flickr account</p>\n    <img src="/assets/1px.gif" />\n    <a class="chewing-gum-btn gray-btn  select_photos_albums">Select Photos or Albums</a>\n  </div>\n\n  <div class="right_col">\n    <p class="tl_import_instruction">Import all '+e+'<br />from your Flickr account</p>\n    <img src="/assets/1px.gif" />\n    <a class="chewing-gum-btn gray-btn import_everything">Import Everything</a>\n  </div>\n\n</div>\n\n<!-- IMPORTING -->\n'+this.importingTemplate()}})}.call(this),function(){ThisLife.View.Import.Select=Backbone.View.extend({className:"tl_modal_import_step tl_import_browser",initialize:function(e){return null==e&&(e={}),this.serviceName=e.service},render:function(){return this.renderTopLevel(),this},renderTopLevel:function(){return this.renderAlbums()},show:function(){return this.el.classList.add("active")},reset:function(){var e,t;return null!=(e=this.albumsView)&&e.hide(),null!=(t=this.photosView)?t.hide():void 0},getAlbumsView:function(){},renderAlbums:function(e){var t;return e&&(t=this.getCollectionId(e)),this.albumsView=this.getAlbumsView(t),this.el.appendChild(this.albumsView.render().el),this.bindAlbumsEvents(),this.reset(),this.albumsView.show(),this.albumsView},bindAlbumsEvents:function(){return this.albumsView.on("back",this.backFromAlbums,this),this.albumsView.on("open",this.renderPhotos,this),this.albumsView.on("remove",this.importAlbums,this)},unbindAlbumsEvents:function(){var e,t,i;return null!=(e=this.albumsView)&&e.off("back",this.backFromAlbums,this),null!=(t=this.albumsView)&&t.off("open",this.renderPhotos,this),null!=(i=this.albumsView)?i.off("remove",this.importAlbums,this):void 0},importAlbums:function(){return this.teardown(!0)},backFromAlbums:function(){return this.teardown()},teardownAlbums:function(){var e;return this.unbindAlbumsEvents(),null!=(e=this.albumsView)&&e.teardown(),this.albumsView=null},getPhotosView:function(){},renderPhotos:function(e){return this.photosView=this.getPhotosView(e),this.el.appendChild(this.photosView.render().el),this.bindPhotosEvents(),this.reset(),this.photosView.show(),this.photosView},bindPhotosEvents:function(){return this.photosView.on("back",this.backFromPhotos,this),this.photosView.on("remove",this.importPhotos,this)},unbindPhotosEvents:function(){var e,t;return null!=(e=this.photosView)&&e.off("back",this.backFromPhotos,this),null!=(t=this.photosView)?t.off("remove",this.importPhotos,this):void 0},importPhotos:function(){return this.teardown(!0)},backFromPhotos:function(){return this.teardownPhotos(),this.reset(),this.albumsView.show()},teardownPhotos:function(){var e;return this.unbindPhotosEvents(),null!=(e=this.photosView)&&e.teardown(),this.photosView=null},teardownViews:function(){return this.teardownPhotos(),this.teardownAlbums()},teardown:function(e){return null==e&&(e=!1),this.trigger("remove",e),this.teardownViews(),this.remove()},getCollectionId:function(e){return e.id||("function"==typeof e.get?e.get("collectionId"):void 0)},getCollectionTitle:function(){}}),ThisLife.View.Import.SelectFacebook=ThisLife.View.Import.Select.extend({getCollectionTitle:function(e){return e.title||("function"==typeof e.get?e.get("name"):void 0)},getAlbumsView:function(){return new ThisLife.View.Import.SelectFacebookAlbums({service:this.serviceName})},getPhotosView:function(e){var t,i;return i=this.getCollectionTitle(e),t=this.getCollectionId(e),new ThisLife.View.Import.SelectFacebookPhotos({collectionId:t,title:i,service:this.serviceName})}}),ThisLife.View.Import.SelectFlickr=ThisLife.View.Import.Select.extend({getCollectionTitle:function(e){return e.title||("function"==typeof e.get?e.get("title")._content:void 0)},getAlbumsView:function(){return new ThisLife.View.Import.SelectFlickrAlbums({service:this.serviceName})},getPhotosView:function(e){var t,i;return i=this.getCollectionTitle(e),t=this.getCollectionId(e),new ThisLife.View.Import.SelectFlickrPhotos({collectionId:t,title:i,service:this.serviceName})}})}.call(this),function(){var e=[].slice;ThisLife.View.Import.SelectCollections=Backbone.View.extend({events:function(){return _.extend({},this.baseEvents,this.additionalEvents)},baseEvents:{"click .tl_back":"back","click .refresh a":"refresh"},additionalEvents:{},initialize:function(e){return this.options=null!=e?e:{},_.bindAll(this,"onGetCollectionsSuccess"),this.collectionId||(this.collectionId=this.options.collectionId),this.service=this.options.service,this.listViews=[]},render:function(){return this.el.insertAdjacentHTML("beforeend",this.template(this.getTemplateSettings())),this.cacheElements(),this.loadCollections(),this},cacheElements:function(){return this.browserEl=this.el.querySelector(".tl_import_browser_middle"),this.listEl=this.el.querySelector(".tl_collection_list"),this.step1El=this.el.querySelector(".step_1"),this.step2El=this.el.querySelector(".step_2")},prepareToLoad:function(){return this.browserEl.classList.remove("empty"),this.browserEl.classList.add("loading"),this.emptyList()},loadCollections:function(e){return this.selected=null,this.prepareToLoad(),this.getCollections(e)},refresh:function(){return this.el.classList.remove("selected"),this.loadCollections(!0)},getCollections:function(){},getCollectionsSuccess:function(){},onGetCollectionsSuccess:function(){var t;return t=1<=arguments.length?e.call(arguments,0):[],this.getCollectionsSuccess.apply(this,t)},select:function(e){var t,i;return this.selected=e,i=this.selected.id||("function"==typeof(t=this.selected).get?t.get("collectionId"):void 0),this.resetList(i,this.selected.get("selected")),e.get("selected")?this.el.classList.add("selected"):this.el.classList.remove("selected")},selectNotInSet:function(e){var t;return null==e&&(e={}),this.selected=e,t=this.selected.isSelected?this.selected.id:this.selected.active,this.resetList(t,this.selected.isSelected),t?this.el.classList.add("selected"):this.el.classList.remove("selected")},back:function(){return this.cancelRequest(),this.trigger("back"),this.hide()},cancelRequest:function(){},importAll:function(){},open:function(){return this.trigger("open",this.selected)},hide:function(){return this.el.classList.remove("active")},show:function(){return this.el.classList.add("active")},resetList:function(e,t){var i,n,o,s,r,l,a;for(o=this.listViews,l=[],i=0,n=o.length;n>i;i++)a=o[i],a.collectionId!==e?(a.toggleActive(!1),l.push(null!=(s=a.model)?s.set("selected",!1):void 0)):l.push(null!=(r=a.model)?r.set("selected",t):void 0);return l},emptyList:function(){var e;for(e=[];this.listEl.firstChild;)e.push(this.listEl.removeChild(this.listEl.firstChild));return e},teardown:function(){return this.cancelRequest(),this.remove()},getTemplateSettings:function(){},template:function(e){var t,i;return null==e&&(e={}),i=e.title,t=e.notAvailable,"<div class='left_col'>\n  <div class='tl_import_browser_top'>\n    <h3>"+i+"</h3>\n    <div class='tl_back'>\n      Back\n    </div>\n    <div class='refresh'>\n      <a class='porcelain-btn'>Refresh</a>\n    </div>\n  </div>\n  <div class='tl_import_browser_middle scrollbar'>\n    <ul class='tl_collection_list'></ul>\n    <div class='spinner' id='import_spinner'></div>\n    <div class='no_results tl_import_instruction'>"+t+"</div>\n  </div>\n</div>\n\n<div class='right_col'>\n  <div class='step_1'>\n    "+this.step1Template()+"\n  </div>\n\n  <div class='step_2'>\n    "+this.step2Template()+"\n  </div>\n</div>"},step1Template:function(){return""},step2Template:function(){return""}})}.call(this),function(){ThisLife.View.Import.SelectAlbums=ThisLife.View.Import.SelectCollections.extend({className:"tl_modal_select_step tl_modal_select_album",additionalEvents:{"click .import":"importAll","click .select_open":"open"},cancelRequest:function(){return ThisLife.Service["import"].cancel(this.service,"Albums")},getTemplateSettings:function(){return{title:"Albums",notAvailable:"No Albums Available"}},step1Template:function(){return"<p class='choose_album_prompt jeff_script'>\n  <img src='/assets/1px.gif' />Choose an album\n</p>"},step2Template:function(){return"<a class='orange-btn select_open'>Select Photos Inside Album</a>\n<p class='jeff_script'>or</p>\n<a class='orange-btn import'>Import Whole Album</a>"}}),ThisLife.View.Import.SelectFacebookAlbums=ThisLife.View.Import.SelectAlbums.extend({getCollections:function(e){return ThisLife.Service["import"].getFacebookAlbums(this.onGetCollectionsSuccess,e)},getCollectionsSuccess:function(e){var t,i;return i=ThisLife.Model.User.isPaidAccount()?"Photos and Videos":"Photos",e.length?(this.browserEl.classList.remove("loading"),t=new ThisLife.View.Import.SelectFacebookAlbumNotInSet({collectionId:"photos_and_videos_of_me",title:i+" of me"}),this.listEl.appendChild(t.el),t.on("selected",this.selectNotInSet,this),this.listViews.push(t),e.each(function(t){return function(i){var n;return n=new ThisLife.View.Import.SelectFacebookAlbum({collectionId:i.id,token:e.token,model:i}),t.listEl.appendChild(n.el),n.on("selected",t.select,t),t.listViews.push(n)}}(this))):void this.browserEl.classList.add("empty")},importAll:function(){return this.trigger("remove"),"photos_and_videos_of_me"===this.selected.id?ThisLife.Service["import"].importPhotosAndVideosOfMe():ThisLife.Service["import"].importAlbum(this.service,this.selected.id)}}),ThisLife.View.Import.SelectFlickrAlbums=ThisLife.View.Import.SelectAlbums.extend({getCollections:function(e){return ThisLife.Service["import"].getFlickrAlbums(this.onGetCollectionsSuccess,e)},getCollectionsSuccess:function(e){var t;return e.length?(this.browserEl.classList.remove("loading"),t=new ThisLife.View.Import.SelectFlickrAlbumNotInSet({collectionId:"getPhotostreamThislife",title:"Photos not in Albums"}),this.listEl.appendChild(t.el),t.on("selected",this.selectNotInSet,this),this.listViews.push(t),e.each(function(e){return function(t){var i;if(!(t.get("videos")>0&&0===t.get("photos"))||ThisLife.Model.User.isPaidAccount())return i=new ThisLife.View.Import.SelectFlickrAlbum({collectionId:t.id,model:t}),e.listEl.appendChild(i.el),i.on("selected",e.select,e),e.listViews.push(i)}}(this))):void this.browserEl.classList.add("empty")},importAll:function(){return this.trigger("remove"),ThisLife.Service["import"].importAlbum(this.service,this.selected.id)}})}.call(this),function(){var e;e=["Backyard fun.jpg","Lake tahoe.jpg","Eiffel Tower.jpg","Rufus.jpg","Nathalie and Brooks wedding.jpg","Snorkeling in Hawaii.jpg","San Francisco bay.jpg","spring flowers.jpg","Soccer practice.jpg","Summer family reunion.jpg","Susan and grandma.jpg","the Caribbean.jpg","Valentines crafts.jpg","Yosemite.jpg","Backyard-fun.jpg","Lake-tahoe.jpg","Angela-sleeping.jpg","Eiffel-Tower.jpg","Rufus.jpg","Nathalie-and-Brooks-wedding.jpg","Snorkeling-in-Hawaii.jpg","San-Francisco-bay.jpg","spring-flowers.jpg","Soccer-practice.jpg","Summer-family-reunion.jpg","Susan-and-grandma.jpg","the-Caribbean.jpg","Valentines-crafts.jpg","Yosemite.jpg","stockings1.jpg","P1010047.jpg","P1010035.jpg","ornaments1.jpg","Whitened Tree.jpg","icicles1.jpg","snowy cabin1.jpg","P1010043.jpg","P1010047.jpg","redberries1.jpg","P1010043.jpg","Flag1.jpg"],ThisLife.View.Import.SelectPhotos=ThisLife.View.Import.SelectCollections.extend({className:"tl_modal_select_step tl_modal_select_photos",additionalEvents:{"click .import_photos":"importAll"},cancelRequest:function(){return ThisLife.Service["import"].cancel(this.service,"Photos",this.collectionId)},getTemplateSettings:function(){return{title:this.options.title,notAvailable:"No Photos Available"}},select:function(e){var t,i;return this.selected||(this.selected=[]),i=e.id||e.get("mediaId"),t=_.find(this.selected,function(e){return e===i}),t?this.selected=_.without(this.selected,i):this.selected.push(i),this.selected.length?this.el.classList.add("selected"):this.el.classList.remove("selected")},step1Template:function(){return"<p class='choose_album_prompt jeff_script'>\n  <img src='/assets/1px.gif' />\n  Select Moments\n</p>"},step2Template:function(){return"<a class='orange-btn import_photos'>Import selected items</a>"}}),ThisLife.View.Import.SelectFacebookPhotos=ThisLife.View.Import.SelectPhotos.extend({getCollections:function(e){return ThisLife.Service["import"].getFacebookPhotos(this.collectionId,this.onGetCollectionsSuccess,e)},getCollectionsSuccess:function(e){return this.browserEl.classList.remove("loading"),e.length?e.each(function(e){return function(t){var i;return i=new ThisLife.View.Import.SelectFacebookPhoto({itemId:t.id,model:t}),e.listEl.appendChild(i.el),i.on("selected",e.select,e),e.listViews.push(i)}}(this)):void this.browserEl.classList.add("empty")},importAll:function(){return this.trigger("remove"),ThisLife.Service["import"].importSocialServicePhotos(this.service,this.selected)}}),ThisLife.View.Import.SelectFlickrPhotos=ThisLife.View.Import.SelectPhotos.extend({getCollections:function(e){return ThisLife.Service["import"].getFlickrPhotos(this.collectionId,this.onGetCollectionsSuccess,e)},getCollectionsSuccess:function(e){return this.browserEl.classList.remove("loading"),e.length?e.each(function(e){return function(t){var i;if("video"!==t.get("media")||ThisLife.Model.User.isPaidAccount())return i=new ThisLife.View.Import.SelectFlickrPhoto({itemId:t.id,model:t}),e.listEl.appendChild(i.el),i.on("selected",e.select,e),e.listViews.push(i)}}(this)):void this.browserEl.classList.add("empty")},importAll:function(){return this.trigger("remove"),ThisLife.Service["import"].importSocialServicePhotos(this.service,this.selected)}})}.call(this),function(){ThisLife.View.Import.SelectItem=Backbone.View.extend({tagName:"li",className:"tl_album_list_item",events:function(){return{click:"selected"}},initialize:function(e){return this.options=null!=e?e:{},this.setup(),this.render()},setup:function(){return this.collectionId=this.options.collectionId,this.model=this.options.model,this.model.set("selected",!1)},render:function(){return this.el.insertAdjacentHTML("beforeend",this.template(this.getTemplateSettings())),this.setCover(),this},getTemplateSettings:function(){var e;return null!=(e=this.model)?e.toJSON():void 0},selected:function(){var e;return e=this.model.get("selected"),this.model.set("selected",!e),this.trigger("selected",this.model),this.toggleActive(!e)},toggleActive:function(e){return e?this.el.classList.add("active"):this.el.classList.remove("active")},setCover:function(){var e,t;return this.coverEl=this.el.querySelector("img"),t=ThisLife.Helper.String.removeProtocolFromUrl(this.getCoverUrl()),e=new Image,e.src=t,e.onload=function(i){return function(){var n,o;return i.hasCover()?(n=e.height/e.width,o=n>1?"portrait":"landscape",i.coverEl.src=t,i.coverEl.classList.add(o)):(i.coverEl.src=t,i.coverEl.classList.add("not_in_set"))}}(this)},hasCover:function(){var e;return null!=(e=this.model)?e.get("cover_photo"):void 0},getCoverUrl:function(){return"/assets/1px.gif"},teardown:function(){return this.remove()},template:function(){}}),ThisLife.View.Import.SelectPhoto=ThisLife.View.Import.SelectItem.extend({className:"tl_photo_list_item",setup:function(){return this.itemId=this.options.itemId,this.model=this.options.model,this.model.set("selected",!1)}}),ThisLife.View.Import.SelectItemNotInSet=ThisLife.View.Import.SelectItem.extend({setup:function(){return this.collectionId=this.options.collectionId,this.title=this.options.title},selected:function(){var e;return e=this.el.classList.contains("active"),this.trigger("selected",{id:this.collectionId,title:this.title,isSelected:!e}),this.toggleActive(!e)}}),ThisLife.View.Import.SelectFacebookPhoto=ThisLife.View.Import.SelectPhoto.extend({hasCover:function(){return this.model.get("picture")},getCoverUrl:function(){return this.model.get("picture")||"/assets/1px.gif"},getTemplateSettings:function(){var e;return e=this.model.get("height")/this.model.get("width"),{orientation:e>1?"portrait":"landscape"}},template:function(){return"<a><img src='/assets/1px.gif' /></a>"}}),ThisLife.View.Import.SelectFacebookAlbum=ThisLife.View.Import.SelectItem.extend({setup:function(){return this.collectionId=this.options.collectionId,this.model=this.options.model,this.token=this.options.token,this.model.set("selected",!1)},getCoverUrl:function(){return this.hasCover()?ThisLife.Settings.fbUrl+"/"+this.model.get("cover_photo").id+"/picture?type=thumbnail&access_token="+this.token:"/assets/1px.gif"},template:function(e){return'<a>\n  <span><img src="/assets/1px.gif" /></span>\n  <strong>'+e.name+'<img src="/assets/1px.gif" /></strong>\n</a>'}}),ThisLife.View.Import.SelectFacebookAlbumNotInSet=ThisLife.View.Import.SelectItemNotInSet.extend({template:function(){var e;return e=ThisLife.Model.User.isPaidAccount()?"Photos and Videos":"Photos",'<a data-title="'+e+' of me" id="photos_and_videos_of_me">\n  <span><img src="/assets/1px.gif" class="not_in_set" width="50" /></span>\n  <strong>'+this.title+'<img src="/assets/1px.gif" /></strong>\n</a>'}}),ThisLife.View.Import.SelectFolderItem=ThisLife.View.Import.SelectItem.extend({className:"tl_folder_list_item",template:function(e){return'<a>\n    <span><img src="/assets/1px.gif" class="not_in_set"/></span>\n    <strong>'+e.title+'<img src="/assets/1px.gif" /></strong>\n  </a>'}}),ThisLife.View.Import.SelectFlickrAlbum=ThisLife.View.Import.SelectItem.extend({hasCover:function(){return this.model.get("farm")&&this.model.get("server")&&this.model.get("primary")&&this.model.get("secret")},getCoverUrl:function(){return this.hasCover()?"//farm"+this.model.get("farm")+".static.flickr.com/"+this.model.get("server")+"/"+this.model.get("primary")+"_"+this.model.get("secret")+"_s.jpg":"/assets/1px.gif"},template:function(e){return"<a>\n  <span>\n    <img src='' width='44' height='44' /></span>\n<strong>"+e.title._content+"<img src='/assets/1px.gif' /></strong>\n</a>"}}),ThisLife.View.Import.SelectFlickrPhoto=ThisLife.View.Import.SelectPhoto.extend({hasCover:function(){return this.model.get("farm")&&this.model.get("server")&&this.model.get("secret")},getCoverUrl:function(){return this.hasCover()?"//farm"+this.model.get("farm")+".static.flickr.com/"+this.model.get("server")+"/"+this.model.get("id")+"_"+this.model.get("secret")+"_s.jpg":"/assets/1px.gif"},template:function(){return"<a><img src='' width='66' height='66' /></a>"}}),ThisLife.View.Import.SelectFlickrAlbumNotInSet=ThisLife.View.Import.SelectItemNotInSet.extend({template:function(){return"<a>\n  <span><img class='not_in_set' src='/assets/1px.gif' width='44' height='44' /></span>\n  <strong>"+this.title+'<img src="/assets/1px.gif" /></strong>\n</a>'}})}.call(this),function(){var e;ThisLife.View.ImportGetMobileApp=Backbone.View.extend({id:"popover_wrap",className:"popover_wrap popover_view_get_mobile_app tl_modal_wrap_visible",events:{"click .js_close_popup":"teardown"},initialize:function(){return this.render(),document.body.appendChild(this.el),this.bindEvents(),this},render:function(){return this.el.insertAdjacentHTML("beforeend",e()),this.textToPhoneView=new ThisLife.View.ImportTextToPhone,this.el.querySelector(".body").appendChild(this.textToPhoneView.el)},bindEvents:function(){return ThisLife.Support.keyInformant.on("cancel",this.modalKeysOnCancel,this),this.textToPhoneView.on("remove",this.teardown,this)},unbindEvents:function(){return ThisLife.Support.keyInformant.off("cancel",this.modalKeysOnCancel,this),this.textToPhoneView.off("remove",this.teardown,this)},modalKeysOnCancel:function(e){return e.preventDefault(),this.teardown()},teardown:function(){return this.unbindEvents(),this.remove()}},e=function(){return'<div class="popover get_mobile_app">\n  <span class="close-btn js_close_popup"><img src="/assets/1px.gif"></span>\n  <div class="body">\n  </div>\n  <div class="pointer"></div>\n</div>'})}.call(this),function(){var e,t;ThisLife.View.TextToPhone=Backbone.View.extend({id:"text_to_phone",events:{"click .send_btn":"send","click .warning_icon":"resetInput","keypress .phone_input":"enterOnSend"},initialize:function(e){return this.options=null!=e?e:{},this.render()},render:function(){return this.el.insertAdjacentHTML("beforeend",this.template()),this.cacheElements(),this},cacheElements:function(){return this.input=this.el.querySelector(".phone_input"),this.formContainer=this.el.querySelector(".share_app_link_wrap"),this.tooltip=this.el.querySelector(".tooltip")},send:function(){var e;if(this.input)return this.phoneNumber=this.input.value,this.input.setAttribute("disabled","disabled"),ThisLife.Helper.Validate.phone(this.phoneNumber)?("function"==typeof(e=this.options).onSend&&e.onSend(),ThisLife.Service.api.sendText(this.phoneNumber,_.bind(this.onSuccess,this),_.bind(this.onError,this))):void this.onError()},enterOnSend:function(e){return 13===e.keyCode?this.send():void 0},resetInput:function(){return this.clearInvalid(),this.input.focus()},clearInvalid:function(){var e;return this.input.value="",null!=(e=this.formContainer)?e.classList.remove("invalid"):void 0},onSuccess:function(){},onError:function(){var e;return null!=(e=this.formContainer)&&e.classList.add("invalid"),this.el.classList.remove("sent"),this.tooltip.innerHTML=t({state:"failed",message:"Invalid number, try again"}),this.input.removeAttribute("disabled")},template:function(){}}),ThisLife.View.SettingsTextToPhone=ThisLife.View.TextToPhone.extend({className:"settings_text_to_phone",onSuccess:function(){return this.$(".share_app_link_wrap").hide(),this.el.insertAdjacentHTML("beforeend",e({mobile_number:this.phoneNumber}))
},teardown:function(){return this.remove(),this.trigger("remove")},template:function(){return'<div class="share_app_link_wrap">\n  <input type="text" class="phone_input" placeholder="Phone Number" />\n  <span class="send_btn orange-btn">Get Link</span>\n  <div class="warning_icon"></div>\n  <div class="tooltip"></div>\n</div>'}}),ThisLife.View.ImportTextToPhone=ThisLife.View.TextToPhone.extend({className:"import_text_to_phone",onSuccess:function(){return this.el.insertAdjacentHTML("beforeend",e({mobile_number:this.input.value})),this.el.classList.add("sent"),this.teardownTimer=setTimeout(function(e){return function(){return e.teardown()}}(this),2e3)},teardown:function(){return clearTimeout(this.teardownTimer),this.remove(),this.trigger("remove")},template:function(){return'<div class="share_app_link_wrap">\n  <div class="input_label">Text the download link to your phone</div>\n  <div class="sms_form">\n    <input type="text" class="phone_input" placeholder="Mobile Number with area code" />\n    <span class="send_btn gray-btn">Send</span>\n    <div class="warning_icon"></div>\n    <div class="tooltip"></div>\n  </div>\n</div>'}}),ThisLife.View.GettingStartedTextToPhone=ThisLife.View.TextToPhone.extend({className:"gettingstarted_text_to_phone",onSuccess:function(){var i;return this.el.classList.add("sent"),this.tooltip.innerHTML=t({state:"success",message:""}),null!=(i=this.tooltip.querySelector(".message"))&&i.insertAdjacentHTML("beforeend",e({mobile_number:this.input.value})),this.input.removeAttribute("disabled"),this.clearInvalid(),this.teardownTimer=setTimeout(function(e){return function(){return e.el.classList.remove("sent")}}(this),2e3)},clear:function(){var e;return clearTimeout(this.teardownTimer),this.clearInvalid(),this.el.classList.remove("sent"),null!=(e=this.tooltip)?e.classList.remove("success"):void 0},teardown:function(){return clearTimeout(this.teardownTimer),this.remove()},template:function(){return'<div class="share_app_link_wrap">\n  <span class="input_label">Text download link to your phone</span>\n  <input type="text" class="phone_input" placeholder="Mobile number with area code" />\n  <div class="warning_icon"></div>\n  <div class="tooltip"></div>\n  <div class="send_btn orange-btn">Send</div>\n</div>'}}),t=function(e){var t;return t=e.state?" "+e.state:"",'<div class="disabled_tooltip_wrap'+t+'">\n  <div class="disabled_tooltip_arrow"></div>\n  <div class="disabled_tooltip">\n    <div class="message">'+e.message+"</div>\n  </div>\n</div>"},e=function(e){return'<div class="sent_successful">\n  <span class="check_icon"></span>\n  Link sent to: <span class="mobile_number">'+e.mobile_number+"</span>\n</div>"}}.call(this),function(){var e;e=0,ThisLife.View.MagicShopView=Backbone.View.extend({widgetView:"fullview",widgetLabel:"",sourceView:"",collection:null,manualSelection:!1,callback:function(){},collectionReady:!1,widgetReady:!1,MAX_PHOTOS_MANUAL:2e3,MAX_PHOTOS_AUTO_PRODUCTS:100,MAX_PHOTOS_AUTO_BOOK:500,initialize:function(e){return null==e.fullView||e.fullView||(this.widgetView="listview"),null!=e.callback&&(this.callback=e.callback),null!=e.view&&(this.sourceView=e.view),null!=e.collection&&null!=e.manualSelection&&(this.manualSelection=!0),null!=e.chosenTab&&(this.chosenTab=e.chosenTab),null!=e.prodType&&(this.prodType=e.prodType),this.isGifting=e.gifting||!1,null!=e.clickthroughNoModal&&(this.clickthroughNoModal=e.clickthroughNoModal),this.productType=e.prodType||"homepage",ThisLife.Model.User.whenLoaded(function(e){return function(){return ThisLife.Helper.Features.whenReady("magicshop",function(t){return e.magicshop=t,e.magicshop?void 0:e.loadSDKAsync(function(t){return e.loadWidget(ThisLife.Model.User.getLifePermission(),t)})})}}(this)),this.render(e)},render:function(e){return null!=e.label&&(this.widgetLabel=e.label),this.manualSelection=null!=e.collection&&null!=e.manualSelection,null!=e.chosenTab&&(this.chosenTab=e.chosenTab),null!=e.collection?(this.collection=e.collection,this.collectionLoaded()):this.fetchCollection()},fetchCollection:function(e){return null==e&&(e=!0),ThisLife.ProductsLogic.getCollectionForHomepage(function(t){return function(i){return t.collection=i,t.collectionLoaded(e)}}(this))},collectionLoaded:function(e){return null==e&&(e=!0),this.collectionReady=!0,this.widgetReady&&e?this.renderWidget():void 0},loadWidget:function(e,t){return ThisLife.app.session.getSessionToken().then(function(i){return function(n){var o;return o={containerElement:i.$el,env:ThisLife.Settings.sflyEnv,operationMode:i.widgetView,displayMode:"embedded",partnerId:"thislife",partnerUserId:e.person_uid,isUserMigrated:!0,token:n,callback:i.callback,interceptSource:i.getInterceptSource(),gifting:i.isGifting,prodtype:i.productType},null!=i.prodType&&(o.prodtype=i.prodType),i.lifeOwnerUid=e.person_uid!==e.owner_person_uid?o.partnerOwnerId=e.owner_person_uid:e.person_uid,i.widget=new t(o),i.widgetLoaded()}}(this))},getInterceptSource:function(e){var t;return null==e&&(e=""),t=""!==e?"sflyphotos/"+this.sourceView+"/"+e:"sflyphotos/"+this.sourceView+(this.manualSelection?"/manualselect":"/autoselect"),ThisLife.log.debug("MagicShop - InterceptSource: "+t),t},widgetLoaded:function(){return this.widgetReady=!0,this.collectionReady?this.renderWidget():void 0},setOpenInNewTab:function(e){var t;return null!=(t=this.widget)?t.setOpenInNewTab(e):void 0},trackHover:function(e){var t,i;return t={mode:"instance",prod_type:e},null!=(i=this.widget)?i.track("tl","hover-category",t):void 0},trackClick:function(e){var t,i;return t={mode:"instance",click_target:e},null!=(i=this.widget)?i.track("tl","click-on",t):void 0},applyModalMenuSelection:function(e,t){return this.widget||this.loadSDKAsync(function(e){return function(t){return e.loadWidget(ThisLife.Model.User.getLifePermission(),t)}}(this)),_.defer(function(i){return function(){return i.widget.applyModalMenuSelection(e,t)}}(this))},createPhotosArrayFromMomentsCollection:function(e){var t,i;return t=this.lifeOwnerUid,i=[],this.collection.each(function(e){return function(n){var o,s;return s=n.get("story_moment_created_by")||t,o=e.getMomentUrl(n),i.push({id:n.id,comboId:s+":"+n.id,url:o,origWidth:n.get("width"),origHeight:n.get("height"),dateTaken:n.get("moment_date"),shouldCopyToNxgen:null!=n.get("story_moment_created_by")&&n.get("story_moment_created_by")!==t})}}(this)),i=this.sortAndFilterCollection(i,e,this.productType)},renderWidget:function(){var e,t,i;return t=this.lifeOwnerUid,e="gifting"===this.sourceView?!0:(null!=(i=this.collection)?i.length:void 0)>0,!ThisLife.Helper.Platform.ie10()&&e?this.createMomentsMap(function(e){return function(){var t;return t=e.createPhotosArrayFromMomentsCollection(e.manualSelection),e.widget.render({photos:t,title:e.widgetLabel,isManualSelect:e.manualSelection,interceptSource:e.getInterceptSource(),chosenTab:e.chosenTab,openInNewTab:ThisLife.app._isUploading(),clickthroughNoModal:e.clickthroughNoModal||!1})}}(this)):this.showStatic(),_.defer(function(e){return function(){return e.trigger("rendered")}}(this))},getMomentUrl:function(e){return this.momentsMap&&this.momentsMap[e.id]?this.momentsMap[e.id]:e.getImageSize("small")},createMomentsMap:function(e){return this.momentsMap={},ThisLife.app.whenReady(function(t){return function(){var i,n;return ThisLife.app.currentState.library||ThisLife.app.currentState.filtered?i=ThisLife.Collection.moments.models:ThisLife.app.currentState.albums&&"album"===ThisLife.app.currentState.options.view?(null!=(n=ThisLife.app.album._layout)?n.strategy.collection:void 0)&&(i=ThisLife.app.album._layout.strategy.collection[0].models):i=t.collection.models,_.each(i,function(e){return t.momentsMap.hasOwnProperty(e.id)?void 0:t.momentsMap[e.id]=e.getImage({height:e.height,width:e.width})}),"function"==typeof e?e():void 0}}(this))},sortAndFilterCollection:function(e,t,i){return e=e.sort(function(e,t){return t.dateTaken-e.dateTaken}),t?e.slice(0,this.MAX_PHOTOS_MANUAL):e.slice(0,"photobook"===i?this.MAX_PHOTOS_AUTO_BOOK:this.MAX_PHOTOS_AUTO_PRODUCTS)},showStatic:function(){return this.$el.addClass("create-small").find(".create_floating").html(this.tmplImage(this.productType)),this.$el.children(".create_floating_catcher").addClass("small-version")},tmplImage:function(e){var t,i;return i=this.getProductRedirectUrl(e),t=this.getProductTitle(e),'<a href="'+i+'" class="create-redirect-link"><img src="/assets/create/'+e+'.jpg" alt="shop for '+e+'" /></a>\n<div class="create-redirect-link-bottom"><a href="'+i+'" class="orange-btn">'+t+"</a></div>"},getProductRedirectUrl:function(e){switch(e){case"photobook":return"https://www.shutterfly.com/photo-books";case"calendar":return"https://www.shutterfly.com/calendars";case"cns":return"https://www.shutterfly.com/cards-stationery";case"homedecor":return"https://www.shutterfly.com/home-decor";case"kids":return"https://www.shutterfly.com/kids";case"photogifts":return"https://www.shutterfly.com/photo-gifts";case"prints":return"https://www.shutterfly.com/prints"}},getProductTitle:function(e){var t;switch(t="Shop ",e){case"photobook":return t+="photo books";case"calendar":return t+="calendars";case"cns":return t+="cards";case"homedecor":return t+="home decor";case"kids":return t+="kids";case"photogifts":return t+="photo gifts";case"prints":return t+="prints"}},loadSDKAsync:function(e){var t,i,n;if(i=ThisLife.Helper.URL.parseQueryString(window.location.search.substring(1)),"1"===(null!=i?i.magic:void 0))return!1;try{n=require("ProductSDK")}catch(o){return void console.log("No productSDK, returning")}try{return e(n)}catch(o){return t=o,console.log("[Product Widget] Retrying to load... (",t,")"),setTimeout(this.loadSDKAsync.bind(this,e),500)}}}),ThisLife.View.MagicShopFloatingView=ThisLife.View.MagicShopView.extend({className:"create_floating_wrapper",initialize:function(e){return this.options=null!=e?e:{},this.mouseleaveCallback=this.options.mouseleaveCallback||null,this.mouseenterCallback=this.options.mouseenterCallback||null,this.actionCallback=this.options.callback||null,this.catcherCustom=this.options.catcher||null,this.menuElement=this.options.menuElement||null,this.modalContainer=this.options.modalContainer||null,this.$buttons=null,this.$buttonsNewIA=null,this.loadedProducts=[],this.outOfCatcher=!0,this.outOfInner=!0,null!=this.options.view&&(this.sourceView=this.options.view),null!=this.options.clickthroughNoModal&&(this.clickthroughNoModal=this.options.clickthroughNoModal),null!=this.options.isSelectionMode&&this.el.classList.add("in_center"),this},bindEvents:function(){return this},unbindEvents:function(){return $(this.el).off()},bindMouseMovement:function(){var e,t,i;return this.catcher?(t=function(e){return function(t){var i,n,o,s,r;return $(e.catcher).hasClass("dropdown")&&!e.catcher.canClose?void(e.catcher.canClose=!0):(n=e.catcher.offset(),o=e.catcher.width(),i=e.catcher.height(),s=t.pageX,r=t.pageY,(s<n.left||s>n.left+o||r<n.top-50||r>n.top+i)&&"function"==typeof e.mouseleaveCallback?e.mouseleaveCallback():void 0)}}(this),e=function(e){return function(){return $(e.catcher).hasClass("dropdown")?$("body").on("click.mg",t.bind(e)):$("body").on("mousemove.mg",_.throttle(t.bind(e),200))}}(this),i=function(e){return function(){return e.catcher.canClose=!1,$("body").off("click.mg"),$("body").off("mousemove.mg")}}(this),i(),e()):this.on("render:finished",function(e){return function(){return e.off("render:finished"),e.bindMouseMovement()}}(this))},render:function(e){var t,i;return this.productType=e.productType||"photobook",this.manualSelection=null!=e.collection&&null!=e.manualSelection,this.inContainer=e.insideContainer,ThisLife.Helper.Platform.ie10()?(this.$el.html(this.tmplContainer(this.productType)),null!=e.container&&(this.hide(),e.container.append(this.$el)),this.inContainer?this.$el.addClass("in-container"):this.$el.removeClass("in-container"),this.$buttonsNewIA=null,this.renderWidget()):(null!=e.collection?(t=this._removeVideos(e.collection),0===t.length?this.fetchCollection():(null==this.originalCollection&&(this.originalCollection=this.collection),this.collection=t,this.collectionReady=!0)):null!=this.originalCollection?this.collection=this.originalCollection:this.collectionReady||this.fetchCollection(),this.$el.html(this.tmplContainer(this.productType)),null!=e.container&&(this.hide(),e.container.append(this.$el)),this.inContainer?this.$el.addClass("in-container"):this.$el.removeClass("in-container"),this.$buttonsNewIA=null,this.bindEvents(),ThisLife.Helper.Features.whenReady("magicshop",function(t){return function(i){return t.magicshop=i,!t.magicshop||e.force?t.loadSDKAsync(function(e){return t.loadWidget(ThisLife.Model.User.getLifePermission(),e)}):void 0}}(this))),null!==this.catcherCustom?window.newMgSdkVersion?(this.catcher=this.$el.parents(".dropdown"),this.$el.parents(".create-products-wrapper").addClass("new_mg_small")):this.catcher=this.catcherCustom:(this.catcher=this.$el.children(".create_floating_catcher").first(),window.newMgSdkVersion&&(i=$(window).width()<992,this.catcher.addClass("new_mg_catcher"),"calendar"!==this.productType&&"photobook"!==this.productType||i?(this.$el.find(".create_floating_loading").removeClass("sml_loading"),this.catcher.removeClass("sml_catcher")):(this.$el.find(".create_floating_loading").addClass("sml_loading"),this.catcher.addClass("sml_catcher")))),this},updatePhotos:function(e){var t;return t=this._removeVideos(e.collection),this.collection=t,e.photos=this.createPhotosArrayFromMomentsCollection(!0),this.widget.render(e),this},positionArrow:function(e,t,i){var n,o,s;return t?this.positionArrowNewIA(e):(null==this.$buttons&&(this.buttons=i.el.querySelector("ul.widget-list")),o=this.productTypeToCreateClass(e),n=$(this.buttons).find(".primary_btn."+o).first(),s=n.offset().left+n.width()/2+10,this.$el.find(".arrow").css("left",s+"px"),this)},positionArrowNewIA:function(e){var t,i,n;return null==this.$buttonsNewIA&&(this.$buttonsNewIA=$("#tl_selection_bar ul.create > ul.primary_options")),i=this.productTypeToCreateClass(e),t=this.$buttonsNewIA.find(".create."+i).first(),n=t.offset().left+t.width()/2+10,this.$el.find(".arrow").css("left",n+"px").addClass("small-arrow"),this},callback:function(e){return"function"==typeof this.actionCallback?this.actionCallback(e):void 0},loadWidget:function(e,t){return ThisLife.app.session.getSessionToken().then(function(i){return function(n){var o,s;return s=i.productType,o={containerElement:i.$el.children(".create_floating"),env:ThisLife.Settings.sflyEnv,operationMode:"listview",displayMode:"embedded",partnerId:"thislife",partnerUserId:e.person_uid,token:n,callback:i.callback.bind(i),interceptSource:i.getInterceptSource(),isUserMigrated:!0,prodtype:s,modalContainer:i.modalContainer},i.lifeOwnerUid=e.person_uid!==e.owner_person_uid?o.partnerOwnerId=e.owner_person_uid:e.person_uid,window.newMgSdkVersion&&$(o.containerElement).addClass("new_mg"),i.widget=new t(o),i.widgetLoaded()}}(this))},hide:function(){var e;return this.$el.css("visibility","hidden"),this.$el.css("opacity","0"),null!=(e=this.menuElement)&&e.removeClass("mg_selected"),this.$el.removeClass("showing"),this},loadMagicShop:function(e){return-1===this.loadedProducts.indexOf(e)?(0===this.loadedProducts.length&&this.callback({action:"load_categories",force:!0,productType:e}),this.loadedProducts.push(e),this.productType=e,this.loadSDKAsync(function(e){return function(t){return e.loadWidget(ThisLife.Model.User.getLifePermission(),t)}}(this))):void 0},show:function(e,t,i){var n;return null==i&&(i=!1),this.magicshop&&this.loadMagicShop(t),this.positionArrow(t,i,e),this.$el.css("visibility","visible"),this.$el.css("opacity","1"),this.$el.addClass("showing"),null!=(n=this.menuElement)&&n.addClass("mg_selected"),this.bindMouseMovement(),"function"==typeof this.mouseenterCallback&&this.mouseenterCallback(),this.trackHover(t),this},remove:function(){return this.unbindEvents(),this.$el.remove(),this},productTypeToCreateClass:function(e){switch(e){case"photobook":return"books";case"photogifts":return"gifts";case"prints":return"prints";case"homedecor":return"decor";case"kids":return"kids";case"calendar":return"calendars";case"cns":return"cards";default:return"books"}},_removeVideos:function(e){return new Backbone.Collection(_.filter(e.models,function(e){return"image"===e.get("moment_type")}))},tmplContainer:function(e){var t;return t=e,'<div class="create_floating_catcher"></div>\n<div class=\'create_floating '+t+"'><div class=\"create_floating_loading\">Loading products, please wait...</div></div>\n<div class='arrow'></div>"}}),ThisLife.View.MagicShopTimeline=ThisLife.View.MagicShopView.extend({initialize:function(e){var t;return this.options=null!=e?e:{},t=this.options,this.widgetView="listview",this.sourceView="timeline",this.productType="timeline",this.manualSelection=!1,this.isTimeline=t.timeline||!1,this.collection=t.collection,this.collectionReady=!0,this.containerEl=t.containerEl,this.productClass=t.containerClass,null!=t.callback&&(this.callback=t.callback),ThisLife.Model.User.whenLoaded(function(e){return function(){return ThisLife.Helper.Features.whenReady("magicshop",function(t){return e.magicshop=t,e.magicshop?void 0:e.loadSDKAsync(function(t){return e.loadWidget(ThisLife.Model.User.getLifePermission(),t)})})}}(this))},loadWidget:function(e,t){return ThisLife.app.session.getSessionToken().then(function(i){return function(n){var o,s;return s=i.productType,o={containerElement:i.containerEl,productClass:i.productClass,env:ThisLife.Settings.sflyEnv,operationMode:"listview",displayMode:"embedded",partnerId:"thislife",partnerUserId:e.person_uid,token:n,callback:i.callback.bind(i),interceptSource:i.getInterceptSource(),isUserMigrated:!0,prodtype:s,timeline:i.isTimeline},i.lifeOwnerUid=e.person_uid!==e.owner_person_uid?o.partnerOwnerId=e.owner_person_uid:e.person_uid,i.widget=new t(o),i.widgetLoaded()}}(this))}}),ThisLife.View.MagicShopGifting=ThisLife.View.MagicShopView.extend({className:"create_gifting",initialize:function(e){var t,i;return this.options=null!=e?e:{},t=this.options,null==t.fullView||t.fullView||(this.widgetView="listview"),null!=t.callback&&(this.callback=t.callback),this.sourceView="gifting",null!=t.collection&&null!=t.manualSelection&&(this.manualSelection=!0),null!=t.chosenTab&&(this.chosenTab=t.chosenTab),null!=t.prodType&&(this.prodType=t.prodType),this.isGifting=t.gifting||!1,i=this,ThisLife.Model.User.whenLoaded(function(){return i.loadSDKAsync(function(){return function(e){return i.loadWidget(ThisLife.Model.User.getLifePermission(),e)}}(this))})},loadWidget:function(){return ThisLife.View.MagicShopGifting.__super__.loadWidget.apply(this,arguments),this.setRecipe?this.widget.changeRecipe(this.setRecipe):void 0},renderWithMoments:function(e){return this.options.collection=e,this.render(this.options)},changeRecipe:function(e){return this.widgetReady?this.widget.changeRecipe(e):this.setRecipe=e}}),ThisLife.View.MagicShopModalContainer=Backbone.View.extend({className:"magicshop_modal_wrapper",events:{"click .magicshop_modal_overlay":"hide","click .magicshop_modal_close":"hide","mouseenter .modal_category_btn":"hover","mouseleave .modal_category_btn":"hoverOut"},initialize:function(e){var t;return this.options=null!=e?e:{},t=this.options,this.resetSelection(t.defaultCategory),this.widgets=null,this.render(this.selectedCategory),this.cancelCallback=this.options.cancelCallback,this.mgShopping=!1,ThisLife.PubSub.on("selection:closed",this.resetSelection.bind(this)),this.hoverTimer=[],this.timerInterval=300,this.selectedTimer=null,this},render:function(e){return this.$el.html(this.getCategoryTemplate()),_.defer(function(t){return function(){return t.$el.find(".modal_category_btn."+e).addClass("selected-category")}}(this))},setSelection:function(e,t){return this.selectedCategory=e,this.selectedProduct=t},resetSelection:function(e){return this.selectedCategory=e||"prints",this.selectedProduct=null},setWidgets:function(e){return this.widgets=e},doneShopping:function(){return this.mgShopping=!1},startShopping:function(){return this.mgShopping=!0},applyMenuSelection:function(){var e;return null!=(e=this.widgets[this.selectedCategory])?e.widget.applyModalMenuSelection(this.selectedCategory,this.selectedProduct):void 0},setInterceptSource:function(e){var t,i,n,o,s,r;o=this.widgets,s=[];for(t in o)r=o[t],i=r.widget,n=i.getInterceptSource(e),i.widget.model.set("interceptSource",n),s.push(ThisLife.log.debug(">>> intercept source for modal",t,"is",n));return s},show:function(e){return null==e&&(e=""),this.setInterceptSource(e),this.$el.addClass("visible"),this.mgShopping?this.applyMenuSelection():void 0},hide:function(){return this.$el.removeClass("visible"),"function"==typeof this.cancelCallback?this.cancelCallback():void 0},addHoverClass:function(e){return this.$el.find(".modal_category_btn").removeClass("hover-active"),e.addClass("hover-active")},removeHoverClass:function(e){return e.hasClass("hover-active")?e.removeClass("hover-active"):void 0},hover:function(e){var t,i,n,o;return i=$(e.currentTarget),n=i.attr("data-cat"),this.selectedTimer&&clearTimeout(this.selectedTimer),o=_.bind(this.hideSelectedCategory,this),this.selectedTimer=setTimeout(o,this.timerInterval),this.hoverTimer.hasOwnProperty(n)&&clearTimeout(this.hoverTimer[n]),t=_.bind(this.addHoverClass,this,i),this.hoverTimer[n]=setTimeout(t,this.timerInterval)},hoverOut:function(e){var t,i,n,o;return t=$(e.currentTarget),i=t.attr("data-cat"),this.selectedTimer&&clearTimeout(this.selectedTimer),o=_.bind(this.showSelectedCategory,this),this.selectedTimer=setTimeout(o,this.timerInterval),this.hoverTimer.hasOwnProperty(i)&&clearTimeout(this.hoverTimer[i]),n=_.bind(this.removeHoverClass,this,t),this.hoverTimer[i]=setTimeout(n,this.timerInterval+500)},showSelectedCategory:function(){return this.$el.find(".modal_category_btn").removeClass("hover-active"),this.$el.find("ul.modal_category_list").removeClass("hide-selected")},hideSelectedCategory:function(){return this.$el.find("ul.modal_category_list").addClass("hide-selected")},getCategoryTemplate:function(){return'<div class="magicshop_modal_overlay"></div>\n<div class="magicshop_modal_container">\n  <div class="magicshop_modal_close">\n    <span class="magicshop_modal_x_icon">&nbsp;</span>\n  </div>\n  <div class="magicshop_modal_menu_wrapper">\n    <ul class="modal_category_list">\n      <li class="modal_category_btn prints" data-cat="prints">\n        <div class="modal_category_btn_sub_menu"></div>\n        <div class="btn_text">\n          <span class="mg_icon"></span>\n          <span class="mg_label">Prints</span>\n        </div>\n      </li>\n      <li class="modal_category_btn photobook" data-cat="photobook">\n        <div class="btn_text">\n          <span class="mg_icon"></span>\n          <span class="mg_label">Books</span>\n        </div>\n        <div class="modal_category_btn_sub_menu"></div>\n      </li>\n      <li class="modal_category_btn cns" data-cat="cns">\n        <div class="btn_text">\n          <span class="mg_icon"></span>\n          <span class="mg_label">Cards</span>\n        </div>\n        <div class="modal_category_btn_sub_menu"></div>\n      </li>\n      <li class="modal_category_btn calendar" data-cat="calendar">\n        <div class="btn_text">\n          <span class="mg_icon"></span>\n          <span class="mg_label">Calendars</span>\n        </div>\n        <div class="modal_category_btn_sub_menu"></div>\n      </li>\n      <li class="modal_category_btn photogifts" data-cat="photogifts">\n        <div class="btn_text">\n          <span class="mg_icon"></span>\n          <span class="mg_label">Gifts</span>\n        </div>\n        <div class="modal_category_btn_sub_menu"></div>\n      </li>\n      <li class="modal_category_btn homedecor" data-cat="homedecor">\n        <div class="btn_text">\n          <span class="mg_icon"></span>\n          <span class="mg_label">Decor</span>\n        </div>\n        <div class="modal_category_btn_sub_menu">DECOR SUB</div>\n      </li>\n      <li class="modal_category_btn kids" data-cat="kids">\n        <div class="btn_text">\n          <span class="mg_icon"></span>\n          <span class="mg_label">Kids</span>\n        </div>\n        <div class="modal_category_btn_sub_menu"></div>\n      </li>\n    </ul>\n  </div>\n  <div class="magicshop_modal_right_section">\n    <div class="magicshop_modal_promo_bar">\n      <div class="sfly_wgt_listview_embedded_title">\n        <div class="sfly_wgt_special_offers"></div>\n      </div>\n    </div>\n    <div class="magicshop_modal_content_wrapper"></div>\n  </div>\n</div>\n'}})}.call(this),function(){var e,t,i,n,o,s;o=0,n=ThisLife.Helper.Notifications.topOverlayNotification,e=Backbone.View.extend({el:"#tl_settings_modal_wrap",events:{"click .close-btn, .close_btn":"close","click .tl_modal_close":"close","click .links-faq":"openFaqs","click .feedback":"openFeedback","click .links-refresh":"refresh","click .tl_settings_email":"emailPreferences","click .orange-btn.change-password":"changePassword","click .tl_settings_plan":"myPlan","click .tl_settings_services":"services","click .tl_settings_apps":"settingsApps","click .tl_settings_submenu li":"submenu","click #settings_services .switch.on":"toggle"},initialize:function(){return _.bindAll(this,"deleteAccountCallback"),this.model.on("change:default_life_subscription",this.subscriptionChanged,this),this.model.id?this.init():this.model.bind("change",this.startSettings,this)},startSettings:function(){return this.init(),this.model.unbind("change",this.startSettings)},init:function(){return ThisLife.app.session.getSessionToken().then(function(e){return function(t){return ThisLife.Helper.setupServices(t),e.tl_modal(),e.bindEvents(),e.showEl()}}(this))},showEl:function(){var e,t,i,n,o,s;return s=new ThisLife.View.SettingsUsage,o=document.getElementById("settings_plan"),$(o).html(s.render().el),i=new ThisLife.View.SettingsTextToPhone,n=document.getElementById("settings_text_to_phone"),$(n).html(i.el),e=new ThisLife.View.ImagePrefsView,t=document.getElementById("settings_image_prefs"),$(t).html(e.el),new ThisLife.View.EmailPrefsView,_.defer(function(e){return function(){return e.el.classList.add("tl_modal_wrap_visible")}}(this))},bindEvents:function(){return ThisLife.Support.keyInformant.on("cancel",this.close,this),ThisLife.PubSub.on("modal:close:settings",this.teardown,this),this.model.on("change:facebook_access_token",function(){return this.changeAccessToken("facebook")},this).on("change:flickr_access_token",function(){return this.changeAccessToken("flickr")},this).on("change:picasa_access_token",function(){return this.changeAccessToken("picasa")},this).on("change:shutterfly_access_token",function(){return this.changeAccessToken("shutterfly")},this).on("change:tumblr_access_token",function(){return this.changeAccessToken("tumblr")},this).on("change:instagram_access_token",function(){return this.changeAccessToken("instagram")},this).on("change:twitter_access_token",function(){return this.changeAccessToken("twitter")},this).on("change:smugmug_access_token",function(){return this.changeAccessToken("smugmug")},this)},unbindEvents:function(){return ThisLife.PubSub.off("modal:close:settings",this.teardown,this),ThisLife.Support.keyInformant.off("cancel",this.close,this)},changeViewLoaded:function(e){return this.model.whenLoaded(this.changeView,this,e)},changeView:function(e){switch(e){case"email_preferences":return $("#tl_settings_submenu-email-prefs").trigger("click");case"email":return $(".tl_settings_services").trigger("click"),$("#tl_settings_submenu-email-prefs").trigger("click")}},changeAccessToken:function(e){var t;return t=this.model.get(e+"_access_token"),t?(this.$("#tl_services_"+e+" div.switch").addClass("on"),this.$("#tl_services_"+e+" div.switch iframe").remove()):(this.$("#tl_services_"+e+" div.switch").removeClass("on"),this.$("#tl_services_"+e+" div.switch").append(ThisLife.app.socialToken.getServiceIframe(e)))},show:function(){return this.bindEvents(),this.showEl()},deleteAccount:function(){var e;return e=new ThisLife.View.DeleteAccountModal({callback:this.deleteAccountCallback}),document.body.appendChild(e.render().el)},deleteAccountCallback:function(){},tl_modal:function(){return this.$el.html(ThisLife.Templates.settings("settingsTemplate",this.model.toJSON())),this._injectSocialIframe(),this.tl_center_modal(),"undefined"!=typeof Placeholders&&null!==Placeholders?Placeholders.init():void 0},_injectSocialIframe:function(){var e;return e=["shutterfly","instagram","flickr","picasa","smugmug","facebook","twitter","tumblr"],_.each(e,function(e){return function(t){return e.$("#tl_services_"+t+" div.switch").hasClass("on")?void 0:e.$("#tl_services_"+t+" div.switch").append(ThisLife.app.socialToken.getServiceIframe(t))}}(this))},subscriptionChanged:function(){return ThisLife.Model.User.hasZuoraSubscription()&&ThisLife.Model.User.isCurrentLifeOwner()?$("#tl_settings_submenu-billing").show():void 0},resetMyPlan:function(){var e;return e=ThisLife.Templates.settings("myPlan",this.model.toJSON()),this.$("#settings_my_plan").replaceWith(e),this.setMyPlan(),this.myPlan()},tl_center_modal:function(){return this.$el.resize(function(){var e,t,i;return i=document.body.clientHeight,e=$(this).height()+20,t=(i-e)/2,$(this).css(e>=i?{top:0}:{top:t})})},close:function(){return this.teardown(),ThisLife.app.router.back()},openFaqs:function(){return this.close(),_.defer(function(){return window.open(ThisLife.Settings.faqUrl,"_blank")})},openFeedback:function(){return ThisLife.app.loadMaritzCXSurvey()},refresh:function(){return this.teardown(),ThisLife.app.router.navigate("refresh")},teardown:function(){return this.unbindEvents(),this.el.classList.remove("tl_modal_wrap_visible")},showTab:function(e,t){return this.lastViewedTab=t,this.setActiveTab(e),$(t).show().siblings("div.tl_settings_content").hide()},emailPreferences:function(e){return this.showTab($(e.currentTarget),"#tl_modal_settings_email")},changePassword:function(){return ThisLife.app.session.gotoChangePassword()},myPlan:function(e){return this.showTab($(e.currentTarget),"#tl_modal_settings_plan")},services:function(e){return this.showTab($(e.currentTarget),"#tl_modal_settings_services")},settingsApps:function(e){return this.showTab($(e.currentTarget),"#tl_modal_settings_apps")},setActiveTab:function(e){return e.addClass("active").siblings("li").removeClass("active")},submenu:function(e){var t,i,n;return t=e.currentTarget,n=t.id.slice(20),this.setActiveTab($(t)),i=function(){switch(n){case"personal":return"settings_personal";case"plan":return"settings_plan";case"email-prefs":return"settings_email_prefs";case"billing":return"settings_billing";case"services":return"settings_services";case"image-prefs":return"settings_image_prefs"}}(),$("#"+i).show().siblings("div.tl_settings_body").hide(),"billing"===n?this.billingTab():void 0},billingTab:function(){var e;return this.billingInfoView?void 0:($("#settings_billing").addClass("loading"),this.billingInfoView=new ThisLife.View.SettingsBillingInfo,e=document.getElementById("settings_billing"),e.appendChild(this.billingInfoView.render().el))},toggle:function(e){var t,n,o,s,r,l;return n=e.currentTarget,n.classList.contains("disabled")?void 0:(o=n.parentElement,t=o.id.split("_")[2],r=n.classList.contains("on"),r?(s=i(ThisLife.services[""+t],"disconnect"),l=i(s,"url"),this.model.set(s.setObject),$.getJSON(ThisLife.Settings.socialUrl+l)):(this.disableToggle(n),ThisLife.Service["import"].connect(t),ThisLife.PubSub.on("connectService:"+t,this.cancelSocialConnect(t),this)))},closeNotification:function(e){return $(e.currentTarget).parent().remove()},cancelSocialConnect:function(e){return function(t){return function(){var i;return i=t.model.get(e+"_access_token"),t.model.trigger("change:"+e+"_access_token",t.model,i),ThisLife.PubSub.off("connectService:"+e,null,t),$("#tl_services_"+e+" div.switch").removeClass("disabled")}}(this)},disableToggle:function(e){return e.classList.add("disabled")}}),i=function(e,t){return e&&e[t]?_.isFunction(e[t])?e[t]():e[t]:null},t=function(){return clearTimeout(o)},s=null,ThisLife.PubSub.on("modal:show:settings",function(t){var i;return s?s.show():s=new e({model:ThisLife.Model.User}),(null!=(i=t.options)?i.view:void 0)?s.changeViewLoaded(t.options.view):void 0})}.call(this),function(){var e;ThisLife.View.SettingsBillingInfo=Backbone.View.extend({className:"scrollbar",events:{"click .switch":"toggleAutoRenew","click .switch_billing_cycle":"switchBillingCycle","click .update_billing":"updateBillingInfo"},initialize:function(){return _.bindAll(this,"disableAutoRenewCallback","switchBillingCycleCallback","updatedBillingInfo","updateAutoRenew"),ThisLife.Service.api.getSubscriptionInfo(),ThisLife.Model.User.on("change:default_life_subscription",this.updatedBillingInfo).on("change:default_life_subscription:autoRenew",this.updateAutoRenew)
},updatedBillingInfo:function(){return this.subscription=ThisLife.Model.User.get("default_life_subscription"),this.reRender()},reRender:function(){var t;return this.nextInvoiceDate=ThisLife.Helper.Date.humanDateUTC(this.subscription.nextInvoiceDate),this.el.parentElement.classList.remove("loading"),t=e(this.subscription,{nextInvoiceDate:this.nextInvoiceDate}),this.$el.html(t),this},toggleAutoRenew:function(e){var t,i;return t=e.currentTarget,i=t.classList.contains("on"),i?this.disableAutoRenew():this.enableAutoRenew()},updateAutoRenew:function(){var e;return e=ThisLife.Model.User.get("default_life_subscription:autoRenew"),e?this.$(".switch").addClass("on"):this.$(".switch").removeClass("on")},enableAutoRenew:function(){return ThisLife.Service.api.setSubscriptionAutoRenew(!0,function(){return function(){return ThisLife.Model.User.set("default_life_subscription:autoRenew",!0)}}(this)),this.el.parentElement.classList.add("loading")},disableAutoRenew:function(){var e;return e=new ThisLife.View.AutoRenewalModal({template:"autoRenewModal",callback:this.disableAutoRenewCallback,nextInvoiceDate:this.nextInvoiceDate}),document.body.appendChild(e.render().el)},disableAutoRenewCallback:function(){return ThisLife.Service.api.setSubscriptionAutoRenew(!1,function(){return function(){return ThisLife.Model.User.set("default_life_subscription:autoRenew",!1)}}(this)),this.el.parentElement.classList.add("loading")},switchBillingCycle:function(){var e,t;return t=this.subscription.plan.zuora_product_sku,e=ThisLife.Settings.www+"/upgrade?billing_period=annual&plan="+t,ThisLife.Helper.URL.open("upgade",e,860,790)},switchBillingCycleCallback:function(){var e;return e=this.subscription.annualRatePlanId,ThisLife.Service.api.updateSubscription(e),this.el.parentElement.classList.add("loading")},updateBillingInfo:function(){var e;return e=ThisLife.Settings.www+"/billing-info",ThisLife.Helper.URL.open("checkout",e,860,790)},render:function(){return this},setup:function(){}}),e=function(e,t){var i,n,o,s,r,l,a,u,c;return c=e.plan.name.replace(/\w\S*/g,function(e){return e.charAt(0).toUpperCase()+e.substr(1)}),l=e.creditCardMaskNumber.substr(e.creditCardMaskNumber.length-4),s=e.creditCardExpirationMonth,r=e.creditCardExpirationYear,a=t.nextInvoiceDate,u=new Date,u.getMonth()>s&&u.getFullYear()>r&&(o="<div class='plan_over'>Your Credit Card has expired!</div>"),i=e.autoRenew?" on":"",n="<p><strong>You will be billed on "+a+" for $"+e.invoiceAmount.toFixed(2)+"</strong></p>",(o?o:"")+"\n"+(i?n:"")+"\n<ul class='settings_list'>\n  <li>\n    <span>Plan</span>\n    <div class='settings_detail'>"+c+"</div>\n  </li>\n  <li>\n    <span>Plan End Date</span>\n    <div class='settings_detail'>"+a+"</div>\n  </li>\n  <li>\n    <span>Auto-Renewal</span>\n    <div class='switch"+i+"'><div class='handle'></div></div>\n  </li>\n  <li class='update_billing'>\n    <span>Update Billing Information</span>\n    <div class='payment_info'>Payment via credit card ending in "+l+'</div>\n  </li>\n</ul>\n<div class="settings_video_text">\n  To cancel plan or for more information, visit the \n  <a href="https://support.shutterfly.com/s/article/Shutterfly-Photos--Video-Plans-1" target="_new">FAQ page</a>.\n</div>'}}.call(this),function(){var e;ThisLife.View.SettingsUsage=Backbone.View.extend({className:"scrollbar",events:{"click .upgrade_btn":function(){return ThisLife.app.router.navigateToUpgrade()}},initialize:function(){return _.bindAll(this,"reRender"),this.model=ThisLife.Model.User,this.setVars(),ThisLife.PubSub.on("api:subscriptionUpdated",this.reRender,this),ThisLife.PubSub.on("modal:close:settings",this.teardown,this),this.model.on("change:default_life_subscription",this.reRender).on("overPlanLimit",this.reRender),ThisLife.Service.api.getSubscriptionInfo()},teardown:function(){return ThisLife.PubSub.off("api:subscriptionUpdated",this.reRender,this),ThisLife.PubSub.off("modal:close:settings",this.teardown,this)},setVars:function(){return this.subscription=this.model.get("default_life_subscription"),this.plan=this.subscription.plan,this.totalStorageKb=this.plan.max_storage_kb,this.photoStorageKb=this.subscription.image_storage_kb,this.videoStorageKb=this.subscription.video_storage_kb,this.numPhotos=this.model.getNumPhotos(),this.numVideos=this.model.getNumVideos()},reRender:function(){var e;return null!=(e=this.el.parentElement)&&e.classList.remove("loading"),this.setVars(),this.render(),this},templateOptions:function(){var e;return e={product_sku:this.plan.zuora_product_sku,num_photos:this.numPhotos,num_videos:this.numVideos,photo_storage_kb:this.photoStorageKb,video_storage_kb:this.videoStorageKb,total_storage:this.totalStorage,overlimit:this.model.isOverPlanLimit(),upgradePossible:this.subscription.upgrade_plan&&ThisLife.Model.User.isCurrentLifeOwner()?!0:!1,total_storage_kb:this.totalStorageKb}},render:function(){var t;return t=this.templateOptions(),this.$el.html(e(this.model,t)),this},setup:function(){}}),e=function(e,t){var i,n,o,s,r,l,a,u,c,d,h;return r=e.get("default_life_subscription"),s=r.plan,a=r.upgrade_plan||(r.upgrade_plan=null),i=r.lastActiveSubscription||(r.lastActiveSubscription=null),l=t.upgradePossible?"<a class='orange-btn upgrade_btn'><img src='/assets/1px.gif' />Upgrade</a>":"",c="tllarge"===t.product_sku?"unlimited":0===t.total_storage_kb?"0GB":ThisLife.Helper.String.bytesToSize(1024*t.total_storage_kb),d=0===t.video_storage_kb?"0GB":ThisLife.Helper.String.bytesToSize(1024*t.video_storage_kb),o=0===t.photo_storage_kb?"0GB":ThisLife.Helper.String.bytesToSize(1024*t.photo_storage_kb),n=null!=i&&new Date(i.termEndDate.replace(/\-/gi,"/"))<new Date?'<div class="plan_over">Your Plan has expired!</div>':'<div class="plan_over">Out of Video Storage</div>',ThisLife.Model.User.isPaidAccount()||t.video_storage_kb>0?(h=d+" out of "+c,u=""):(h="Upgrade Now to backup your videos!",u="orange"),(t.overlimit?n:"")+'\n<ul class="settings_list">\n  <li>\n    <span>Photos</span>\n    <div class="settings_detail">\n      '+ThisLife.Helper.String.numberWithCommas(t.num_photos)+' out of Unlimited\n    </div>\n  </li>\n  <li>\n    <span>Videos</span>\n    <div class="settings_detail '+u+'">\n      '+h+"\n    </div>\n  </li>\n</ul>\n\n"+l}}.call(this),function(){var e,t;ThisLife.View.EmailPrefsView=Backbone.View.extend({initialize:function(){return this.addListeners(),ThisLife.Service.api.getSubscriptions()},render:function(){return ThisLife.Model.User.get("email_prefs")?(ThisLife.Model.User.off("change",this.render),this.el.insertAdjacentHTML("afterbegin",t),this.emailPrefsWrap=document.getElementById("settings_email_prefs"),this.addPrefs(),$(this.emailPrefsWrap).html(this.el),this.cacheElements(),this):void 0},addPrefs:function(){var e,t,i,n,o,s;for(o=this.el.querySelector("ul.settings_list"),n=ThisLife.Model.User.get("email_prefs").models,e=0,t=n.length;t>e;e++)i=n[e],s=new ThisLife.View.EmailPrefView({model:i,parentView:this.emailPrefsWrap,collection:ThisLife.Model.User.get("email_prefs")}),o.appendChild(s.el);return this},cacheElements:function(){return this},addListeners:function(){return ThisLife.Model.User.on("change",this.render,this)},teardown:function(){return this.trigger("teardown"),this.remove()}}),t="<div class='scrollbar'>\n  <ul class='settings_list'>\n  </ul>\n</div><!-//scrollbar-->",e=function(e){var t,i,n;return t=e.get("key").toLowerCase(),n=function(){switch(t){case"welcome":return"Welcome Email";case"inviteToLife":return"Life Invitation"}}(),i="1"===e.get("value")?"on":"off","<li id='tl_subscriptions_"+t+"' data-uid='"+e.get("uid")+"'> <img src='/assets/1px.gif' class='icon_"+t+" service_icon' /> <span>"+n+"</span> <div class='toggle_wrap'> <div class='toggle toggle_state_"+i+"'> <span class='toggle_on'>On</span> <span class='toggle_off'>Off</span> <div class='toggle_handle'></div> </div> </div> </li>"}}.call(this),function(){var e;ThisLife.View.EmailPrefView=Backbone.View.extend({tagName:"li",events:{"click .switch":"toggle"},initialize:function(e){return this.parentView=e.parentView,this.render(),this.addListeners()},render:function(){return this.el.insertAdjacentHTML("afterbegin",e(this.model)),this},cacheElements:function(){return this},addListeners:function(){},teardown:function(){return this.trigger("teardown"),this.remove()},toggle:function(e){var t;return t=_.bind(this.toggleCallback,this),e.currentTarget.classList.contains("on")?ThisLife.Service.api.optOut(this.model.get("uid"),t):ThisLife.Service.api.optIn(this.model.get("uid"),t),e.currentTarget.classList.toggle("on")},toggleCallback:function(e){return e.result.success?void 0:this.$(".switch").toggleClass("on")}}),e=function(e){var t,i,n;return t=e.get("key").toLowerCase(),n=function(){switch(t){case"welcome":return"Welcome to ThisLife";case"invitetolife":return"Invite to Life";case"rediscovery":return"Rediscover";case"sharemoments":return"Share Moments";case"sharestory":return"Share Album";case"storynotification":return"Album Notification";default:return"Email"}}(),i="1"===e.get("value")?"on":"","<span>"+n+"</span> <div class='switch "+i+"'> <div class='handle'></div> </div>"}}.call(this),function(){var e;ThisLife.View.ImagePrefsView=Backbone.View.extend({className:"image_prefs",events:{"click .switch":"_clickToggle"},initialize:function(){return this._isVividPixEnabled=!1,this.render(),this._cacheElements(),this._getVividPix()},render:function(){return this.el.insertAdjacentHTML("afterbegin",e(this.model)),this},teardown:function(){return this.trigger("teardown"),this.remove()},_cacheElements:function(){return this._toggleEl=this.el.querySelector(".switch"),this},_getVividPix:function(){var e;return this.el.classList.add("loading"),e=function(e){return function(t){return e._isVividPixEnabled=t.result.payload,e._updateToggle(),e.el.classList.remove("loading")}}(this),ThisLife.Service.api.getVividPix(e,ThisLife.Service.api.error)},_setVividPix:function(e){return ThisLife.Service.api.setVividPix(e,null,ThisLife.Service.api.error)},_updateToggle:function(){return this._isVividPixEnabled?this._toggleEl.classList.add("on"):this._toggleEl.classList.remove("on")},_clickToggle:function(){return this._isVividPixEnabled?(this._isVividPixEnabled=!1,this._setVividPix(this._isVividPixEnabled)):(this._isVividPixEnabled=!0,this._setVividPix(this._isVividPixEnabled)),this._updateToggle()}}),e=function(){return"<div class='scrollbar'>\n  <ul class='settings_list'>\n    <li>\n      <span>\n        <a href=\"https://support.shutterfly.com/app/answers/detail/a_id/533\" target=\"_blank\">\n          <strong>VividPics</strong>\n        </a> - Image enhancer during printing\n      </span>\n      <div class='switch'>\n        <div class='handle'></div>\n      </div>\n    </li>\n  </ul>\n  <div class=\"tab-spinner\"></div>\n</div>"}}.call(this),function(){var e,t,i,n;t=n=void 0,i={click:function(e){return e.target.classList.contains("popover_wrap")?this.remove():void 0},"click .close-btn, .cancel":"remove","click .confirm":"confirm"},e=Backbone.View.extend({className:"popover_wrap visible",events:i,initialize:function(e){this.options=null!=e?e:{}},render:function(){var e;return _.bindAll(this,"keyListener"),e=this.template(this.options),this.$el.html('<div class="popover">'+e+"</div>"),this.setup(),this},confirm:function(){return this.options.callback(),this.remove()},setup:function(){return document.body.addEventListener("keydown",this.keyListener,!1)},keyListener:function(e){return 27===e.keyCode?this.remove():void 0},remove:function(){return this.$el.remove(),document.body.removeEventListener("keydown",this.keyListener,!1)}}),ThisLife.View.AutoRenewalModal=e.extend({template:function(e){return t(e)},className:"popover_wrap visible billing_info_modal"}),ThisLife.View.DeleteAccountModal=e.extend({template:function(e){return n(e)},className:"popover_wrap visible delete_account_modal",events:_.extend({"keyup input":"inputKeyup"},i),setup:function(){return document.body.addEventListener("keydown",this.keyListener,!1),this.cacheEls()},cacheEls:function(){return this.deleteInput=this.el.querySelector(".delete_account_phrase"),this.passwordInput=this.el.querySelector(".delete_account_password"),this.confirmBtn=this.el.querySelector(".gray-btn.confirm"),this.popover=this.el.querySelector(".popover"),this.errorMessage=this.el.querySelector(".error_message")},inputKeyup:function(e){return 13===e.keyCode?this.confirm():this.deleteAccountInputsValid()?this.confirmBtn.classList.remove("disabled"):this.confirmBtn.classList.add("disabled")},deleteAccountInputsValid:function(){return this.validConfirmationPhrase()&&this.passwordInput.value.length>=4?!0:!1},validConfirmationPhrase:function(){return"delete"===this.deleteInput.value.toLowerCase()?!0:!1},confirm:function(e){var t;return(null!=e?e.currentTarget.classList.contains("disabled"):void 0)?!1:this.deleteAccountInputsValid()?($(this.errorMessage).hide(),this.popover.classList.add("loading"),t=function(e){return function(t){return e.popover.classList.remove("loading"),e.passwordInput.value="",$(e.errorMessage).html(t).show()}}(this),ThisLife.app.deleteAccount(this.passwordInput.value,t)):$(this.errorMessage).html("Please fill out the required fields.").show()}}),t=function(e){return'<span class="close-btn"><img alt="1px" src="/assets/1px.gif"></span>\n<div class="body">\n  <h3 class="heading">Turn Off Auto-Renewal?</h3>\n  <p>Turning off auto-renewal will cancel your plan at the end of your current subscription period. Your subscription period ends on <strong>'+e.nextInvoiceDate+'</strong>.</p>\n</div>\n<div class="tl_modal_bottom">\n  <div class="tl_modal_bottom_left">\n    <a class="cancel gray-btn">Cancel</a>\n  </div>\n\n  <div class="tl_modal_bottom_right">\n    <a class="gray-btn confirm">Turn Off Auto-Renewal</a>\n  </div>\n</div>'},n=function(){return ThisLife.Model.User.isPaidAccount()?'<span class="close-btn"><img alt="1px" src="/assets/1px.gif"></span>\n<div class="body">\n  <h3 class="heading">Delete Account</h3>\n  <p>Please email us at <a href="mailto:help@cs.thislife.com">help@cs.thislife.com</a><br />if you\u2019d like us to permanently delete your account.</p>\n</div>\n<div class="tl_modal_bottom">\n  <div class="tl_modal_bottom_right">\n    <a class="gray-btn cancel">Close</a>\n  </div>\n</div>':'<span class="close-btn"><img alt="1px" src="/assets/1px.gif"></span>\n<div class="body">\n  <h3 class="heading">Delete Account</h3>\n  <p>You are about to permanently delete your ThisLife account<br /> and all its contents. This action is irreversible.</p>\n  <div class="error_message"></div>\n  <div class="float_left left">\n    <label>Type "delete" to confirm</label><br />\n    <input type="text" autofocus="autofocus" autocomplete="off" class="delete_account_phrase" />\n  </div>\n  <div class="float_left">\n    <label>Enter password</label><br />\n    <input type="password" class="delete_account_password" maxlength="10" />\n  </div>\n</div>\n<div class="tl_modal_bottom">\n  <div class="tl_modal_bottom_left">\n    <a class="cancel gray-btn">Don\'t Delete</a>\n  </div>\n  <div class="tl_modal_bottom_right">\n    <a class="gray-btn confirm disabled">Delete Account</a>\n  </div>\n</div>'}}.call(this),function(){var e,t;e=Backbone.View.extend({className:"popover_wrap sub_popover",events:{"click a":"confirmType","click .close-btn":"remove"},initialize:function(e){return this.options=null!=e?e:{},this.callback=this.options.callback||function(){}},render:function(){return this.name=this.options.data.value.trim(),this.el.insertAdjacentHTML("beforeend",t(this.name)),this},confirmType:function(e){var t,i,n;return t=e.currentTarget.className,n=t.split("gray-btn ")[1],"tag"===n&&this.name.length>255?(i=new ThisLife.View.Error({message:"Tag name is too long. Please make tags 255 characters or less."}),i.show()):this.callback(n),this.remove()},remove:function(){return document.getElementById("tag_input").removeAttribute("disabled"),this.$el.remove(),this}}),t=function(e){return e=ThisLife.Helper.String.escapeHtml(e),'<div class=\'popover tag_popup new\'>\n<span class="close-btn"><img src="/assets/1px.gif"></span>\n<div class="body">\n  <p class="subtitle">What type of tag is <br/> "'+e+'"?</p>\n  <div class="tag_type">\n    <a class="gray-btn person"><span></span>Person</a>\n    <a class="gray-btn place"><span></span>Place</a>\n    <a class="gray-btn tag"><span></span>Tag</a>\n  </div>\n</div>\n</div>'},ThisLife.View.NewTagPopup=e}.call(this),function(){var e,t,i,n,o,s;e=Backbone.View.extend({id:"tl_invites_popover",className:"tl_modal_wrap popover tl_modal_wrap_visible",events:{"click .close-btn":"close","click .footer .gray-btn":"close","click #js_my_invitations_list_popup .dismiss":"ignoreInvite","click #js_my_invitations_list_popup .orange-btn":"acceptInvite"},initialize:function(){return this.model=ThisLife.Model.masterStory,this.bindCallbacks()},render:function(){return this.el.innerHTML=s,this},bindCallbacks:function(){return this.model.invitedStories.on("add",this.addInvitationStory,this).on("remove",this.removeInvitedStory,this).on("add remove reset",this.updateInvitationCount,this),ThisLife.PubSub.on("modal:close",this.teardown,this),ThisLife.Support.keyInformant.on("cancel",this.close,this)},unbindCallbacks:function(){return this.model.invitedStories.off(null,null,this),ThisLife.Support.keyInformant.off("cancel",this.close,this),ThisLife.PubSub.off(null,null,this)},getInvitedStories:function(){return this.model.whenLoaded(this.renderInvitedStories,this)},acceptInvite:function(e){var t,i,n;return i=e.currentTarget,t=i.parentNode.parentNode,n=t.dataset.uid,i.parentNode.innerHTML='<div class="joined"><span></span>Joined</div>',_.delay(function(e){return function(){return e.model.joinInvitedStory(n)}}(this),500)},ignoreInvite:function(e){var t,i,n;return i=e.currentTarget,t=i.parentNode.parentNode,n=t.dataset.uid,this.model.ignoreStory(n)},removeInvitedStory:function(e,t){return this.ignoreStory(e.get("story_uid"),t.length)},ignoreStory:function(e,t){var i,n;return n=this,i=this.el.querySelector("li[data-uid='"+e+"']"),$(i).animate({left:-516,opacity:0},function(){return $(this).animate({paddingTop:0,paddingBottom:0,minHeight:0,height:0},function(){return $(this).remove(),t?void 0:n.addNoInvitedStoriesTemplate()})})},renderInvitedStories:function(){var e,t,i,n,o,s;if(e=this.model.invitedStories,e.length){for(o=e.models,s=[],t=0,i=o.length;i>t;t++)n=o[t],s.push(this.addInvitationStory(n,e));return s}return this.addNoInvitedStoriesTemplate()},addInvitationStory:function(e,t){var i;return 1===t.length&&this.removeNoInvitedStoriesTemplate(),i=n(e),this.invitationsEl=document.getElementById("js_my_invitations_list_popup"),this.invitationsEl.insertAdjacentHTML("beforeend",i)},addNoInvitedStoriesTemplate:function(){var e;return this.invitationsEl=document.getElementById("js_my_invitations_list_popup"),null!=(e=this.invitationsEl)?e.insertAdjacentHTML("afterbegin",o):void 0},removeNoInvitedStoriesTemplate:function(){return $(this.el.querySelector("li.empty")).remove()},close:function(){return this.teardown(),ThisLife.app.router.back()},teardown:function(){return this.unbindCallbacks(),this.remove()}}),n=function(e){var n,o,s,r,l,a;return r=e.get("story"),a=r.uid,o=r.cover_moment_uid,n=r.cover_owner_uid,s=t(o,n),l=i(e),"<li data-uid='"+a+"' data-type='invite'>\n  <div class=\"avatar\" style=\"background-image: url("+s+')"></div>\n  '+l+'\n  <div class="btns">\n    <a class="gray-btn dismiss"></a>\n    <a class="orange-btn">Accept</a>\n  </div>\n</li>'},i=function(e){var t,i,n;return i=e.get("story"),t=ThisLife.Helper.String.escapeHtml(i.name),e.owner_person_uid===ThisLife.Model.User.id?"<strong>"+t+"</strong>":(n=e.get("name"),"<strong>"+t+" </strong><span class='author'>by "+n+"</span>")},t=function(e,t){return e?ThisLife.Helper.Image.imageUrlDim(e,32,null,t):""},s='<span class="close-btn"><img src="/assets/1px.gif"></span>\n<div class="body">\n  <h3>Invites to join a Story</h3>\n  <h5>Accept or decline your invites to Stories from friends.</h5>\n  <div class="invites_list">\n    <div class="list_gradient_heading">Invitations</div>\n    <ul id="js_my_invitations_list_popup">\n    </ul>\n  </div>\n</div>\n<div class="footer">\n  <a class="gray-btn right">Done</a>\n</div>\n</div>',o='<li class="empty">\n  <img src="/assets/1px.gif">\n  <p>You have no new invitations</p>\n</li>',ThisLife.PubSub.on("modal:show:storyInvites",function(){var t,i;return i=new e,t=document.getElementById("tl_modal_container"),$(i.render().el).appendTo(t),i.getInvitedStories()})}.call(this),function(){var e,t;e=function(e){return this.options=null!=e?e:{},this.init(),this},e.prototype.init=function(){var e,t,i;return e=_.bind(this.createNewStorySubmit,this),i=new ThisLife.View.ModalAlert({template:"createAlbumTemplate",item:"createStory",callback:e}),t=function(){return i.teardown(),ThisLife.PubSub.off("state:change",t,this),ThisLife.PubSub.off("modal:show",t,this)},ThisLife.PubSub.on("state:change",t,this),ThisLife.PubSub.on("modal:show",t,this),document.body.appendChild(i.render().el),i.el.getElementsByTagName("input")[0].focus(),"undefined"!=typeof Placeholders&&null!==Placeholders?Placeholders.init():void 0},e.prototype.createNewStorySubmit=function(e){var t,i,n,o;return n=e.el.getElementsByTagName("input")[0].value.trim(),n.toLowerCase()!==$(e.el.getElementsByTagName("input")[0]).attr("placeholder").toLowerCase()?(o=this.validateForm(n),o?this.showError(e,o):(i=this.createNewStoryCallback(e),t=_.bind(i,this),ThisLife.Model.masterStory.myStories.createStory(n,t,this.options))):void 0},e.prototype.validateForm=function(e){var t;return t=ThisLife.Model.masterStory.nameExists(e),e?t?"Story name already exists!":e.length>ThisLife.Model.Albums.Master.maxAlbumTitleLength?"Story name is too long.":null:"Story name cannot be blank!"},e.prototype.showError=function(e,t){var i;return e.el.getElementsByClassName("clearfix")[0].classList.add("error"),e.el.getElementsByClassName("disabled_tooltip_wrap")[0].classList.add("show"),i=e.el.getElementsByClassName("input_error")[0],i.innerHTML=t,i.style.display="block",!1},e.prototype.createNewStoryCallback=function(e){return e.renderLoadingTemplate(),function(t){var i,n,o,s,r;return t.result.success?(r=t.result.payload.uid,this.options.navigate?(e.teardown(),ThisLife.app.controller("selection").start({storyUid:r})):this.options.autoAdd?(n=this.options.autoAdd,i=this.options.fmv,n=_.isArray(n)?n:[n],o=_.pluck(n,"id"),s=this.options,ThisLife.Model.masterStory.updateStory(r),ThisLife.Service.api.saveStoryMoments(r,o,function(){return e.changeInnerHTML.call(e,"saveStoryMoments",{data:[r,o],length:o.length}),_.delay(function(){return function(){return e.teardown(),ThisLife.app.controller("selection").done(),s.showStory?ThisLife.app.router.navigateToStory(r,{replace:!0,trigger:!0}):void 0}}(this),ThisLife.View.ModalAlert.CONFIRMATION_DELAY)})):void 0):(e.removeLoadingTemplate(),this.showError(e,t.result.errors))}},ThisLife.View.CreateNewStory=e,t=function(e){return ThisLife.Model.masterStory.myStories.find(function(t){return t.get("story").name===e})}}.call(this),function(){var e;e=Backbone.View.extend({id:"save_email_address",className:"gray_popup",events:{"keypress input":"inputKeypress","click a":"action","click span":"remove","click .warning_icon":"removeNotify"},initialize:function(e){var t;return this.options=null!=e?e:{},this.offset=this.options.offset,this.tagUid=this.options.tagUid||"",this.view=this.options.view,this.item=this.options.item,this["class"]=this.options["class"]||"",document.body.appendChild(this.render().el),t=_.debounce(_.bind(this.adjustSizePosition,this),100),ThisLife.PubSub.on("resize",t,this),this.adjustPosition(),_.defer(function(e){return function(){return e.$("input").focus()}}(this))},render:function(){return this.$el.html(this.template()),this.$el.addClass(this["class"]),this},adjustSizePosition:function(){return this.offset=this.view.getPopupOffset($(this.item)[0]),this.adjustPosition()},adjustPosition:function(){var e,t,i,n,o;return n="50%",$(window).width()<480?(this.$el.css("margin-left","0px"),$(window).width()>356?(t=($(window).width()-356)/2,e=this.offset.left-$(window).width()/2,this.$el.css({top:this.offset.top-138.5+72,left:t,zIndex:999})):(o=$(window).width()-32,t=o/2,e=this.offset.left-t-20,this.$el.css({width:o+"px",top:this.offset.top-138.5+72,left:0,zIndex:999}),this.$el.find(".gray_popup_input").css({width:o-115+"px"}))):(i=this.offset.left-140,e=-9,ThisLife.app.isMobile&&this.offset.left+178>$(window).width()&&(i=$(window).width()-311,e=this.offset.left-i+45,n=0),20>i&&(e=i-54,i=48),this.$el.css({top:this.offset.top-138.5+72,left:i,marginLeft:-45,zIndex:999})),e?this.$el.find(".pointer").css({marginLeft:e,left:n}):void 0},inputKeypress:function(e){return ThisLife.Helper.Keyboard.isEnter(e.keyCode)?this.action():void 0},action:function(){var e,t,i,n;return e=this.$el.find("input"),i=e.data("tag"),t=e.val().trim(),ThisLife.Helper.Validate.email(t)?(this.options.view.trigger("action:email",{uid:i,email:t}),this.remove()):(n="Invalid email address",this.notify(n))},notify:function(e){var t;return this.removeNotify(),$(this.el).addClass("invalid"),null!=(t=this.errorTooltip)&&t.teardown(),this.errorTooltip=new ThisLife.View.Album.SharePopupTooltip({message:e}),$(this.el).append(this.errorTooltip.el),this.updateWarningPosition()},removeNotify:function(){var e;return $(this.el).removeClass("invalid"),null!=(e=this.errorTooltip)&&e.teardown(),this.errorTooltip=null},updateWarningPosition:function(){var e,t,i,n,o;return this.errorTooltip?(o=this.el.querySelector(".warning_icon"),n=this.el.querySelector(".validation_tooltip"),t=$(o).offset(),e=t.left-($(n).width()/2-$(o).width()/2),i=t.top-($(n).height()+10),$(".validation_tooltip").offset({top:i,left:e})):void 0},remove:function(){return this.view.$el.trigger("click"),this.$el.remove()},template:function(){return'<input class="gray_popup_input" placeholder="Provide an email address" data-tag="'+this.tagUid+'" type="text" value="" />\n<a href="javascript:;" class="gray_popup_save" >Save</a>\n<div class="pointer"><span></span></div>\n<div class=\'warning_icon\'></div>'}}),ThisLife.View.SmallGrayPopup=e}.call(this),function(){var e,t,i,n,o,s;e=Backbone.View.extend({className:"popover_wrap visible share_sites new_popover_wrap",events:{click:"clickOutsideModal","click .close-btn":"teardown","change .share_sites":"changeSite","click .submit_share_site:not(.disabled)":"submit","submit .share_sites_wrap":"submit","click .create_share_site":"createShareSite","click .radio_wrap":"radioSelect"},initialize:function(e){return this.options=null!=e?e:{},this.selectedPhotos=this.collection.getImages(),this.selectedVideos=this.collection.getVideos()},render:function(){return this.el.insertAdjacentHTML("beforeend",s()),this.setup(),this.setupShareSitesList(),ThisLife.Support.keyInformant.on("cancel",this.teardown,this),this},setup:function(){return ThisLife.PubSub.on("state:change",this.teardown,this),ThisLife.PubSub.on("modal:show",this.teardown,this),this.popoverEl=this.el.querySelector(".popover")},cacheDomElements:function(){return this.shareSitesEl=this.el.querySelector(".share_sites"),this.shareSitesWrapEl=this.el.querySelector(".share_sites_wrap"),this.submitBtnEl=this.el.querySelector(".orange-btn.done-btn")},setupShareSitesList:function(){return ThisLife.app.session.getSessionToken().then(function(e){return function(t){var i,n;return n=new ThisLife.Collection.ShareSitesGetUserSites,i=_.bind(e.getSitesCallback,e),n.getSites(t,i)}}(this))},getSitesCallback:function(e,t,o){var s,r,l,a,u,c,d;if(this.popoverEl.classList.remove("loading"),t.error)return this.errorModal(t.error.message),this.remove();if(this.shareSites=_.sortBy(t.result.sites,function(e){return(e.title||"").toLowerCase()}),this.popoverEl.innerHTML=n(this.collection,this.shareSites.length),this.shareSites.length){u=_.sortBy(_.groupBy(this.shareSites,"role"),function(e){return e}),this.cacheDomElements();for(r in u)c=u[r],"-4"===u[r][0].role?(l="My sites",a=i(l,c)):(l="Sites I belong to",d=i(l,c));return a&&this.shareSitesEl.insertAdjacentHTML("beforeend",a),d&&this.shareSitesEl.insertAdjacentHTML("beforeend",d),this.selectedSite=u[0][0],this.getSections(o),$(this.shareSitesEl).customSelect(),s=this.shareSitesEl.options[0].value,$(this.shareSitesEl).val(s).change()}return this.popoverEl.className="popover  one_button_modal new_share_site"},changeSite:function(e){var t;return t=e.currentTarget.value,this.selectedSite=_.find(this.shareSites,function(){return function(e){return e.id===t}}(this)),ThisLife.app.session.getSessionToken().then(function(e){return function(t){return e.getSections(t),e.toggleSelectDisabled(!0),e.toggleBtnDisabled(!0)}}(this))},radioSelect:function(e){return this.$el.find(".radio_input.selected").removeClass("selected"),$(e.currentTarget).find(".radio_input").addClass("selected"),this.popoverEl.className="popover one_button_modal "+e.currentTarget.dataset.value},toggleSelectDisabled:function(e){return this.shareSitesEl.disabled=e},toggleBtnDisabled:function(e){return ThisLife.Helper.DOM.addRemoveClass(this.submitBtnEl,e,"disabled")},getSections:function(e){var t,i;return i=new ThisLife.Collection.ShareSitesGetSectionList,t=_.bind(this.getSectionsCallback,this),i.getSections({site:this.selectedSite.id,token:e},t)},getSectionsCallback:function(e,t){var i,n,o,s;return t.error?(this.errorModal(t.error.message),this.remove()):(o=this.rejectSectionsWithoutPermission(t.result.items),i=_.groupBy(o,"moduleId"),this.selectedPhotos.length>0&&(n=_.groupBy(i.Pictures,"pageName"),this.renderPicturesLocation(n)),this.selectedVideos.length>0&&(s=_.groupBy(i.Videos,"pageName"),this.renderVideoLocation(s)),this.toggleSelectDisabled(!1),o.length>0?this.toggleBtnDisabled(!1):void 0)},renderVideoLocation:function(e){var t;return null!=(t=this.videoLocationView)&&t.remove(),this.videoLocationView=new ThisLife.View.SelectShareSiteLocation({className:"videos_location share_site_location",collection:e,mediaType:"Videos",selectedSite:this.selectedSite}),this.shareSitesWrapEl.appendChild(this.videoLocationView.render().el)},renderPicturesLocation:function(e){var t;return null!=(t=this.picturesLocationView)&&t.remove(),this.picturesLocationView=new ThisLife.View.SelectShareSiteLocation({className:"pictures_location share_site_location",collection:e,mediaType:"Pictures",selectedSite:this.selectedSite}),this.shareSitesWrapEl.appendChild(this.picturesLocationView.render().el)},rejectSectionsWithoutPermission:function(e){return _.reject(e,function(e){return!e.permissions.canContribute})},clickOutsideModal:function(e){return e.target.classList.contains("popover_wrap")?this.teardown():void 0},teardown:function(){return ThisLife.Support.keyInformant.off("cancel",this.teardown,this),ThisLife.PubSub.off("state:change",this.teardown,this),ThisLife.PubSub.off("modal:show",this.teardown,this),this.options.fmv&&this.collection.trigger("fmv:closeShare"),this.remove()},remove:function(){return this.$el.remove(),this},submit:function(){return this.validateForm()&&ThisLife.app.session.getSessionToken().then(function(e){return function(t){var i,n,o,s;return o=e.shareSitesEl.value,s=ThisLife.Settings.sflyCmd+"/commands/ofly/site/contents/add?site="+o+"&access_token="+t+"&contentSource=ThisLife",n=new ThisLife.Model.ShareSitesAdd({},{url:s}),i=_.bind(e.submitCallback,e),n.addToShareSite(e.getSubmitParams(),i),e.popoverEl.classList.add("loading")}}(this)),!1},createShareSite:function(){var e,t,i;return i=this.getNewSiteParams(),e=this.el.querySelector("#new_share_site_form"),t=this.el.querySelector("#new_share_site_form input"),t.value=JSON.stringify(i),e.submit(),this.remove()},validateForm:function(){return this.picturesLocationView&&!this.picturesLocationView.validate()||this.videoLocationView&&!this.videoLocationView.validate()?!1:!0},getNewSiteParams:function(){var e;return e={contentSource:"thislife",shareType:"thisLife",shareDestination:"Share_Sites",newSite:!0,coverURL:this.getCoverUrl()},this.momentItemList().length&&(e.shareIds=this.momentItemList()),this.videoItemList().length&&(e.videoJson={items:this.videoItemList(),rtmpBaseUrl:ThisLife.Settings.videoUrl+"/cfx/st",httpBaseUrl:this.gethttpBaseUrl()}),e},getCoverUrl:function(){var e,t;return e=_.first(this.selectedPhotos)||_.first(this.selectedVideos),t=this.getMomentOwner(e),ThisLife.Helper.Image.imageUrlDim(e.id,{width:e.get("width"),height:e.get("width")},e.get("effects_modified_date"),t)},getSubmitParams:function(){var e;return e={contentSource:"thislife",shareType:"thisLife",shareDestination:"Share_Sites"},this.picturesLocationView&&this.picturesLocationView.userCanPostMedia()&&(e.pictures={pictureIds:this.momentItemList()},e.pictures=_.extend(e.pictures,this.picturesLocationView.getParams())),this.videoLocationView&&this.videoLocationView.userCanPostMedia()&&(e.videos={rtmpBaseUrl:ThisLife.Settings.videoUrl+"/cfx/st",httpBaseUrl:this.gethttpBaseUrl(),items:this.videoItemList()},e.videos=_.extend(e.videos,this.videoLocationView.getParams())),e
},momentItemList:function(){var e;return e=[],_.each(this.selectedPhotos,function(t){return function(i){var n;return n=t.getMomentOwner(i),e.push(n+":"+i.id)}}(this)),e.join()},videoItemList:function(){var e;return e=[],_.each(this.selectedVideos,function(t){return function(i){var n,o;return n=t.getMomentOwner(i),o={sourceId:i.id,sourceToken:t.getVideoSizes(i),title:ThisLife.Helper.Date.getUTCString(i.get("moment_date"),!1),description:i.get("caption_text"),thumbnail:ThisLife.Helper.Image.imageUrlDim(i.id,{width:i.get("width"),height:i.get("width")},i.get("effects_modified_date"),n),lifeUid:ThisLife.lifeUid,ownerId:n},e.push(o)}}(this)),e},getVideoSizes:function(e){var t,i;return t=["_small","_medium","_large"],i="_"+ThisLife.MediaPlayerHelper.largestVideoSizeAvailable(e.get("height")),t.slice(0,t.indexOf(i)+1).join()},getMomentOwner:function(e){return e.get("story_moment_created_by")||e.get("created_by_uid")||ThisLife.currentLifeOwner},submitCallback:function(e,t){var i,n,s,r,l,a,u,c,d,h,p;return this.popoverEl.classList.remove("loading"),this.blurInput(),t.error||(null!=(r=t.result.pictureResponse)?r.error:void 0)||(null!=(l=t.result.videoResponse)?l.error:void 0)?(t.error?s=t.error.clientMessage:((null!=(a=t.result.pictureResponse)?a.error:void 0)||(null!=(u=t.result.videoResponse)?u.error:void 0))&&(i=(null!=(c=t.result.pictureResponse)?c.error:void 0)||(null!=(d=t.result.videoResponse)?d.error:void 0),ThisLife.Helper.String.contains(i.clientMessage,"You do not have permission to add content this section")&&(s="You do not have permission to add content to this section.")),s||(s="Error posting to Share Site."),this.errorModal(s)):(n=(null!=(h=t.result.pictureResponse)?h.path:void 0)||(null!=(p=t.result.videoResponse)?p.path:void 0),this.popoverEl.innerHTML=o(this.postedMedia(),this.postBreadcrumb(),n),this.popoverEl.classList.add("success"),this.logToDataWareHouse(),this.trackShareLinkClick())},errorModal:function(e){var t;return t=new ThisLife.View.ModalAlert({template:"shareSiteErrorTemplate",callback:null,item:e}),$(document.body).append(t.render().el),!1},blurInput:function(){var e;return e=this.el.querySelector(".new_section"),null!=e?e.blur():void 0},logToDataWareHouse:function(){var e;return e={module:"share",action:"share",numOfPictures:this.selectedPhotos.length,numOfVideos:this.selectedVideos.length},ThisLife.Service.api.dataWarehouseLog(e)},trackShareLinkClick:function(){return ThisLife.app.controller("tracking").logSharePost("site")},postedMedia:function(){return this.postedMedia=this.collection.models,this.picturesLocationView&&!this.picturesLocationView.userCanPostMedia()&&(this.postedMedia=_.reject(this.postedMedia,function(e){return"image"===e.get("moment_type")})),this.videoLocationView&&!this.videoLocationView.userCanPostMedia()&&(this.postedMedia=_.reject(this.postedMedia,function(e){return"video"===e.get("moment_type")})),this.postedMedia},postBreadcrumb:function(){return this.picturesLocationView&&this.picturesLocationView.userCanPostMedia()?this.picturesLocationView.getBreadcrumb():this.videoLocationView.getBreadcrumb()},gethttpBaseUrl:function(){var e;return e=""+ThisLife.Settings.scheme+ThisLife.Settings.shareStatic+" <"+ThisLife.Settings.scheme+ThisLife.Settings.shareStatic+"/>"}}),s=function(){return'<div class="popover one_button_modal existing_share_site loading">\n</div>'},n=function(e,i){return"<span class='close-btn js_close_popup'><img src='/assets/1px.gif'></span>\n<div class='body'>\n<h4>Share on Share Sites</h4>\n  <div class='modal_information'>\n  <form class=\"share_sites_wrap\"> \n    <div class='header'>Post "+e.models.length+" "+e.getDescription()+' to&hellip;</div>\n    <div class="select_site_wrap clearfix">\n      <p>Select a Share Site:</p>\n\n      '+(i>0?t():"")+'\n\n      <div class="radio_wrap" data-value="new_share_site">\n        <div class="radio_input '+(0===i?"selected":"")+'"></div>\n        New Share Site\n      </div>\n\n    </div>\n  </form>\n\n  <form action="'+ThisLife.Settings.app+'/create_new_share_site" method="post" target="_blank" id="new_share_site_form">\n    <input type="hidden" name="data" />\n  </form>\n\n</div>\n\n<div class="action_btn_wrap clearfix existing_footer">\n  <a class="orange-btn done-btn submit_share_site disabled">Post to Site</a>\n</div>\n<div class="action_btn_wrap clearfix create_footer">\n  <a class="orange-btn done-btn create_share_site">Create</a>\n</div>\n\n</div>'},t=function(){return'<div class="radio_wrap" data-value="existing_share_site">\n  <div class="radio_input selected"></div>\n  <div class="share_sites_select_wrap">\n    <select class="share_sites custom_select">\n    </select>\n  </div>\n</div>'},o=function(e,t,i){return'<span class="close-btn"><img src="/assets/1px.gif"></span>\n<div class="body">\n  <h3>'+e.length+" "+ThisLife.Helper.String.pluralizePhotosVideos(e)+' posted to&hellip;</h3>\n  <a class="btn standard" href="'+i+'" target="_blank">'+t+"</a>\n</div>"},i=function(e,t){var i,n,o,s;for(s="",i=0,n=t.length;n>i;i++)o=t[i],s+="<option value='"+o.id+"'>"+o.title+"</option>";return"<optgroup label='"+e+"'>"+s+"</optgroup>"},ThisLife.View.PostToShareSites=e,define("ThisLife.View.PostToShareSites",[],function(){return e})}.call(this),function(){var e,t,i,n,o;t="New Section name cannot be blank!",e=Backbone.View.extend({events:{"click .change_location":"renderDropdowns","change .pages":"changePage","change .sections":"changeSection","keyup input":"inputChange","click .warning_icon":"clearWarning","click .new_section":"clearWarning"},initialize:function(e){var t,i,n,o;return this.options=null!=e?e:{},this.collection=function(){var e,i;e=this.collection,i=[];for(t in e)o=e[t],i.push({name:t,data:o});return i}.call(this),this.selectedSection=null!=(i=this.collection[0])?i.data[0]:void 0,this.selectedSectionPath=null!=(n=this.selectedSection)?n.path:void 0},render:function(){return this.el.insertAdjacentHTML("beforeend",this.getBottomTemplate()),this.locationWrapEl=this.el.querySelector(".location_wrap"),this},cacheDomElements:function(){return this.pagesEl=this.el.querySelector(".pages"),this.sectionsEl=this.el.querySelector(".sections"),this.newSectionEl=this.el.querySelector(".new_section"),this.inputEl=this.el.querySelector("input"),this.inputWrapEl=this.el.querySelector(".input_wrap")},userCanPostMedia:function(){return this.collection.length>0},changePage:function(e){var t;return t=e.currentTarget.value,this.selectPage(t)},selectPage:function(e){var t,i,n,o,s;for(null==e&&(e=0),this.sections=this.collection[e].data,this.sectionsEl.innerHTML="",t="",o=this.sections,e=i=0,n=o.length;n>i;e=++i)s=o[e],t+="<option value='"+e+"'>"+s.title+"</option>";return t+=this.newSectionOption(),this.sectionsEl.insertAdjacentHTML("beforeend",t),this.selectedSectionPath=this.sections[0].path,this.selectedSection=this.sections[0],this.newSectionEl.style.display="",this.sectionsCustomSelect?$(this.sectionsEl).trigger("update"):this.sectionsCustomSelect=$(this.sectionsEl).customSelect({truncate:18})},getParams:function(){var e;return this.selectedSectionPath?(e={section:this.selectedSectionPath},this.newSectionTitle=null):(e={page:this.selectedSection.page,sectionTitle:this.newSectionEl.value.trim()},this.newSectionTitle=this.newSectionEl.value.trim()),e},validate:function(){var e;return this.selectedSectionPath||!this.userCanPostMedia()?!0:this.newSectionEl.value.trim()?!0:(null!=(e=this.errorTooltip)&&e.teardown(),this.errorTooltip=null,this.inputError=!0,this.inputEl.parentNode.classList.add("error"),this.errorTooltip=new ThisLife.View.Album.SharePopupTooltip({message:t}),this.inputWrapEl.appendChild(this.errorTooltip.el),!1)},inputChange:function(){var e;return null!=(e=this.errorTooltip)&&e.teardown(),this.errorTooltip=null,this.inputError?this.newSectionEl.value.trim()||""===this.newSectionEl.value?this.inputEl.parentNode.classList.remove("error"):this.inputEl.parentNode.classList.add("error"):void 0},newSectionOption:function(){return"<option value='new_section'>New Section</option>"},getBreadcrumb:function(){return this.options.selectedSite.title+" &gt; "+this.selectedSection.pageName+" &gt; "+(this.newSectionTitle||this.selectedSection.title)},changeSection:function(e){var t;return t=e.currentTarget.value,"new_section"===t?(this.selectedSectionPath=null,this.newSectionEl.parentNode.style.display="block",this.newSectionEl.focus()):(this.selectedSectionPath=this.sections[t].path,this.selectedSection=this.sections[t],this.newSectionEl.parentNode.style.display="")},getBottomTemplate:function(){return this.collection.length?o(this.options.mediaType,this.selectedSection):n(this.options.mediaType)},clearWarning:function(){var e;return null!=(e=this.errorTooltip)&&e.teardown(),this.errorTooltip=null,this.inputEl.parentNode.classList.remove("error")},renderDropdowns:function(){var e,t,n,o,s,r;for($(this.locationWrapEl).empty(),this.locationWrapEl.insertAdjacentHTML("beforeend",i()),this.cacheDomElements(),e="",r=this.collection,n=t=0,o=r.length;o>t;n=++t)s=r[n],e+="<option value='"+n+"'>"+s.name+"</option>";return this.pagesEl.insertAdjacentHTML("beforeend",e),$(this.pagesEl).customSelect({truncate:18}),this.selectPage()}}),n=function(e){return"<p>Your "+e+' will be added to:</p>\n<div class="location_wrap clearfix">You don\'t have permission to post to any '+e+" section in this Share Site.</div>"},o=function(e,t){return"<p>Your "+e+' will be added to:</p>\n<div class="location_wrap clearfix">The <strong>'+t.title+"</strong> section on the <strong>"+t.pageName+'</strong> page. <a class="change_location">Change Location</a></div>'},i=function(){return'<div class="select_location page">\n  <label for="pages_location">Page:</label>\n  <div class="select_wrap">\n    <select id="pages_location" class="pages custom_select" data-width="168"></select>\n  </div>\n</div>\n<div class="select_location section">\n  <label for="sections_location">Section:</label>\n  <div class="select_wrap">\n    <select id="sections_location" class="sections custom_select" data-width="168"></select>\n</div>\n<div class="input_wrap">\n    <input type="text" placeholder="new section" class="new_section" />\n    <div class="warning_icon"></div>\n</div>\n</div>'},ThisLife.View.SelectShareSiteLocation=e}.call(this),function(){ThisLife.View.ShareModal=Backbone.View.extend({className:"popover_wrap new_popover_wrap tl_modal_wrap_visible",events:{"click .close-btn":"teardown"},initialize:function(e){return null==e&&(e={}),this.options=e,this.render()},render:function(){return this.$el.html(this.template()),document.body.appendChild(this.el)},teardown:function(){return this.remove()},template:function(){var e;return e=this.options.backButton?'<a class="back_button">'+this.options.backButton+"</a>":"",'<div class="share_modal_wrap">\n  <div class="share_modal">\n    <span class="close-btn"></span>\n    <div class="top_section">\n      <div class="title">'+this.options.title+'</div>\n    </div>\n    <div class="middle_section"/>\n    <div class="bottom_section">\n      <a class="disabled orange-button">'+this.options.orangeButton+'\n         <span class="count">0</span>\n      </a>\n      '+e+"\n    </div>\n  </div>\n</div>"}})}.call(this),function(){var e,t,i,n,o;ThisLife.View.Upgrade={},e=Backbone.View.extend({id:"upgrade_popup",className:"popover_wrap",events:{click:function(e){return e.target.classList.contains("popover_wrap")?this.remove():void 0},"click .close-btn":"remove"},initialize:function(){return _.bindAll(this,"modalKeys","reRender","render","remove","overPlanLimit","overUpgradePlanLimit","getUpgradeRatePlansCallback"),this.bindModel(),this.setVars(),this.setup(),this},bindModel:function(){return this.model.on("change:default_life_subscription",this.remove).on("overPlanLimit",this.overPlanLimit).on("overUpgradePlanLimit",this.overUpgradePlanLimit)},unbindModel:function(){return this.model.off("change:default_life_subscription",this.remove).off("overPlanLimit",this.overPlanLimit).off("overUpgradePlanLimit",this.overUpgradePlanLimit)},setVars:function(){return this.subscription=this.model.get("default_life_subscription"),this.totalStorageKb=this.subscription.plan.max_storage_kb,this.numPhotos=this.model.getNumPhotos(),this.numVideos=this.model.getNumVideos()},setup:function(){return document.body.addEventListener("keydown",this.modalKeys,!1),ThisLife.PubSub.on("modal:close:upgrade",this.teardown,this)},teardown:function(){return ThisLife.PubSub.off("modal:close:upgrade",this.teardown,this),document.body.removeEventListener("keydown",this.modalKeys,!1),this.$el.remove(),this},overUpgradePlanLimit:function(){},overPlanLimit:function(){return this.reRender()},modalKeys:function(e){return 27===e.keyCode?this.remove():void 0},render:function(){var e,i;return i=t(),e=this.subscription.plan.zuora_product_sku,ThisLife.Service.api.getAllZuoraRatePlans(this.getUpgradeRatePlansCallback),this.$el.html(i),this.el.style.display="block",this},callOMTR:function(e){var t;if(e)return t=[],_.each(e,function(e){return t.push({name:""+e.plan.zuora_product_sku+e.charges[0].billingPeriod})}),ThisLife.app.controller("tracking").logUpgradeModal(t)},getUpgradeRatePlansCallback:function(e){var t;return e.result.success?(this.ratePlans=e.result.payload.plans,this.reRender(),this.callOMTR(this.ratePlans)):(t=i(),this.$el.html(t))},reRender:function(){var e,t,i,o,s,r,l,a,u;if(this.setVars(),i={num_photos:this.numPhotos,num_videos:this.numVideos,total_storage_kb:this.totalStorageKb,overlimit:this.model.isOverPlanLimit(),plan_name:this.subscription.plan.name,upgrade_possible:this.subscription.upgrade_plan?!0:!1,rate_plans:this.ratePlans,upgrade_plan:this.subscription.upgrade_plan,is_paid_plan:this.model.isPaidAccount()},u=n(i),this.$el.html(u),this.planColumns=[],i.rate_plans){for(r=i.rate_plans,a=[],e=0,t=r.length;t>e;e++)o=r[e],s=new ThisLife.View.Upgrade.Plan({parentView:this,model:o}),this.planColumns.push(s),a.push(null!=(l=this.el.querySelector(".plans_wrap"))?l.appendChild(s.el):void 0);return a}},remove:function(){var e,t,i,n;if(this.unbindModel(),this.teardown(),this.planColumns)for(n=this.planColumns,e=0,t=n.length;t>e;e++)i=n[e],null!=i&&i.remove();return ThisLife.app.router.back(),this}}),n=function(e){var t;return e.rate_plans?(t=e.rate_plans.length>2?"max_plans":"",'<div class="popover '+t+'">\n  <span class="close-btn js_close_popup"><img src="/assets/1px.gif"></span>\n  <div class="body clearfix">\n\n    <h3>Want to add video?</h3>\n    <h4>Each video plan also comes with unlimited photo storage and organization.</h4>\n    <div class="plan_table_container">\n      <div class="plan_table">\n        <div class="plan_table_group">\n          <div class="plans_wrap">\n          </div>\n        </div>\n      </div>\n    </div>\n\n    '+o(e)+"\n  </div>\n</div>"):"<div class='premium_message'>You currently have our largest subscription plan, the Premium Plan. You do not need to upgrade to another plan at this time.</div>"},o=function(e){return e.rate_plans?'<div class="upgrade_footer">\n  <div>Each uploaded video may not exceed 2GB.</div>\n</div>':""},t=function(){return'<div class="loading popover">\n  <span class="close-btn js_close_popup"><img src="/assets/1px.gif"></span>\n  <div class="body clearfix">\n  </div>\n</div>'},i=function(){return'<div class="popover" style="margin-top: -255px; width: 700px; height: 510px; margin-left: -350px;">\n  <span class="close-btn js_close_popup"><img src="/assets/1px.gif"></span>\n  <div class="body clearfix">\n    <h3>No upgrade plan available...</h3>\n  </div>\n</div>'},ThisLife.PubSub.on("modal:show:upgrade",function(){var t;return t=new e({model:ThisLife.Model.User}),document.body.appendChild(t.render().el)})}.call(this),function(){var e;ThisLife.View.Upgrade.Plan=Backbone.View.extend({className:"plan_col",events:{"click .orange-btn":"upgradePopup"},initialize:function(e){return this.parentView=e.parentView,this.model=e.model,this.render()},upgradePopup:function(){var e,t,i,n,o;return e=this.model.charges[0].billingPeriod,i=this.model.name,n=this.model.plan.zuora_product_sku,o=n?"plan="+n:"",t=e?"?billing_period="+e:"",ThisLife.Helper.URL.open("checkout",ThisLife.Settings.www+"/checkout"+t+"&"+o,860,1100),ThisLife.app.controller("tracking").logClickUpgradePlan(i)},render:function(){switch(this.$el.html(e(this.model)),this.model.status){case"current":this.$el.addClass("current");break;case null:this.$el.addClass("disable")}return this.el}},e=function(e){var t,i,n,o;if(e){switch(i="Annual"===e.charges[0].billingPeriod?"year":"",t=e.charges[0].chargeAmount,e.plan.zuora_product_sku){case"tlsmall":o="60 GB",n="~1,000 videos";break;case"tlmedium":o="300 GB",n="~5,000 videos";break;default:o="UNLIMITED",n="videos"}return'<div>\n  <div class="plan_name">'+o+'</div>\n  <div class="plan_videos">'+n+'</div>\n  <div class="price">\n    <div class="currency">$</div>\n    <div class="amount">'+t+'</div>\n    <div class="billing_period">/ '+i+'</div>\n  </div>\n  <div class="plan_btn">\n    <button class="orange-btn">Upgrade</button>\n  </div>\n  <div class="your_plan_btn">Your Plan</div>\n</div>'}})}.call(this),function(){ThisLife.View.ActionBarModal=Backbone.View.extend({id:"popover_wrap",className:"popover_wrap new_popover_wrap tl_modal_wrap_visible",events:{"click #modal_cancel":function(){return this.triggerCollection("teardown")},"click .create_story_btn":"createNewStory",click:function(e){return"popover_wrap"===e.target.id?this.back():void 0},"click #prev_face, .js_close_popup":"back","click .js_done_tagging":"doneTagging","click #next_face":"save"},triggerCollection:function(e,t){return this.collection.trigger("action",e,t)},exitFmv:function(){return this.collection.trigger("fmv:exit",this.collection),this.back()},saveDate:function(e){var t,i;return i=e.month+"/"+e.day+"/"+e.year,"function"==typeof(t=this.options).callback&&t.callback(i),this.back()},momentMove:function(e){var t,i,n,o;return n=e.get("uid"),o=_.pluck(this.myCollection,"id"),e.addPendingUploads(o),i=this.getCurrentStoryUid(),t=this._showSpinner(n,o,i,!0),ThisLife.Service.api.moveAlbumMoments(i,n,o,t)},timelineAdd:function(e){var t,i,n,o;return t=e.get("uid"),this.options.fmv?(n=this.moments.models[0].id,i=this._showSpinner(t,n,null,!1),ThisLife.Service.api.saveStoryMoments(t,[n],i)):this.options.recentUploads?ThisLife.app.controller("selection").getActions()._addDirectToAlbum({storyUid:t,collection:this.collection,navigateToAlbum:!0}):(ThisLife.app.controller("selection").getActions()._addDirectToAlbum({storyUid:t,collection:this.collection}),ThisLife.Model.Albums.Master.loaded&&(o=_.pluck(this.myCollection,"id"),ThisLife.Model.Albums.Master.getAlbumById(t).addPendingUploads(o))),this.back()},_showSpinner:function(e,t,i,n){var o;return o=new ThisLife.View.ModalAlert,document.body.appendChild(o.renderLoadingTemplate().el),ThisLife.Helper.Scripts.postpone(function(s){return function(){return o.spinnerActive=!1,n?(o.changeInnerHTML.call(o,"moveAlbumMoments",{data:[e,t],length:t.length}),ThisLife.app.controller("albums").removeMoments(i,t),s.back(),ThisLife.app.controller("selection").done(),_.delay(function(){return o.teardown(),s.collection.containsOthersMoments()?(o=new ThisLife.View.ModalAlert({template:"actionPermissionWarning"}),$(document.body).append(o.render().el)):void 0},ThisLife.View.ModalAlert.CONFIRMATION_DELAY,500)):(t=[t],o.changeInnerHTML.call(o,"saveStoryMoments",{data:[e,t],length:1}),_.delay(function(){return o.teardown()},ThisLife.View.ModalAlert.CONFIRMATION_DELAY,500))}}(this))},initialize:function(e){var t,i;return this.options=null!=e?e:{},this.moments=this.collection.moments||this.collection,(this.options.fmv||this.options.recentUploads)&&(ThisLife.PubSub.on("state:change",this.teardown,this),ThisLife.PubSub.on("modal:show",this.teardown,this),this.myCollection=this.moments.models),this.contacts=ThisLife.Service.api.combineContacts(),this.type=this.options.type,this.share=this.options.share,this.options.fmv||this.options.recentUploads?void 0:(this.myCollection="function"==typeof(t=this.collection).getOnlyMyMoments?t.getOnlyMyMoments():void 0,this.partialEdit=("function"==typeof(i=this.collection).containsOthersMoments?i.containsOthersMoments():void 0)?!0:!1)},render:function(){return ThisLife.app.controller("timeline").disableScroll(),this.renderView(),this.bindEvents(),this},bindEvents:function(){return ThisLife.Support.keyInformant.on("cancel",this.keyPressCancel,this,!0)},unbindEvents:function(){return ThisLife.PubSub.off(null,null,this),ThisLife.Support.keyInformant.off("cancel",this.keyPressCancel,this)},keyPressCancel:function(e){return e.preventDefault(),this.back()},save:function(){return ThisLife.PubSub.trigger("actionBar:share")},deleteMoments:function(){var e;return e=new ThisLife.View.ModalAlert({template:"deleteMomentView",callback:this.collection.deleteMoments}),$(document.body).append(e.render().el)},renderView:function(){var e,t,i,n,o;switch(this.$el.addClass("popover_view_"+this.type),this.$el.show(),this.type){case"tags":return this.options.fmv?(this.view=new ThisLife.View.actionBar[this.type]({collection:this.collection,fmv:this.options.fmv,storyUid:this.getCurrentStoryUid()}),$(this.el).html(this.view.render().el)):ThisLife.Service.api.getMomentSet(_.pluck(this.myCollection,"id")).then(function(e){return function(t){return e.view=new ThisLife.View.actionBar[e.type]({collection:t,fmv:e.options.fmv,storyUid:e.getCurrentStoryUid()}),$(e.el).html(e.view.render().el)}}(this));case"link":return this.view=new ThisLife.View.actionBar.link({collection:this.collection,storyUid:this.getCurrentStoryUid()}),$(this.el).html(this.view.render().el);case"download":return $(this.el).html(ThisLife.Templates.actionBar(this.type,{collection:this.collection}));case"moment_move":return n=this.getInfo(this.type),$(this.el).html(ThisLife.Templates.actionBar("moment_move_empty",n)),ThisLife.Model.Albums.Master.whenLoaded(function(e){return function(){return ThisLife.Model.Albums.Master.getAllAlbums().models.length<=0?void e.createNewStory():($(e.el).html(ThisLife.Templates.actionBar(e.type,n)),null!=e._albumListView&&(e._albumListView.off("itemSelected",e.momentMove),e._albumListView.teardown()),e._albumListView=new ThisLife.Albums.View.BasicList({renderViewOnlyAlbums:!1,currentAlbum:e.getCurrentStoryUid()}),e._albumListView.on("itemSelected",e.momentMove,e),e.el.querySelector(".albums_list").appendChild(e._albumListView.el))}}(this));case"timeline_add":return n=this.getInfo(this.type),$(this.el).html(ThisLife.Templates.actionBar("timeline_add_empty",n)),ThisLife.Model.Albums.Master.whenLoaded(function(e){return function(){return ThisLife.Model.Albums.Master.getAutoAlbums().models.length+ThisLife.Model.Albums.Master.getOwnerAlbums().models.length<=0?void e.createNewStory():($(e.el).html(ThisLife.Templates.actionBar(e.type,n)),null!=e._albumListView&&(e._albumListView.off("itemSelected",e.timelineAdd),e._albumListView.teardown()),e._albumListView=new ThisLife.Albums.View.BasicList({renderViewOnlyAlbums:!1,currentAlbum:e.getCurrentStoryUid()}),e._albumListView.on("itemSelected",e.timelineAdd,e),e.el.querySelector(".albums_list").appendChild(e._albumListView.el))}}(this));case"date":return n=this.getInfo(this.type),t=n.collection.last().get("moment_date"),i=new Date(t),n.days=new Date(i.getFullYear(),i.getMonth()+1,0).getDate(),e=_.bind(this.saveDate,this),o=this.myCollection[0].id,this.view=new ThisLife.View.ActionBarDate({date:t,uid:o,callback:e}),$(this.el).html(this.view.render().$el);case"facebook":return n=this.getInfo(this.type),n.parent=this,n.facebook?(n.loading=!0,this.view=new ThisLife.View.ActionBarShareService(n),$(this.el).html(this.view.render().el),ThisLife.Service.api.getFacebookPermissions(function(e){return function(t){return n.loading=!1,n.hasPermission=t.hasPermission("publish_actions"),e.view.updateOptions(n),$(e.el).html(e.view.render().el),e.view.updateDisplay(),ThisLife.app.isMobile?void 0:e.modalFocus()}}(this))):(this.view=new ThisLife.View.ActionBarShareService(n),$(this.el).html(this.view.render().el));default:return n=this.getInfo(this.type),n.parent=this,this.share?(this.view=new ThisLife.View.ActionBarShareService(n),$(this.el).html(this.view.render().$el)):$(this.el).html(ThisLife.Templates.actionBar(this.type,n))}},modalFocus:function(){var e;return null!=(null!=(e=this.view)?e.focus:void 0)?this.view.focus():void 0},createNewStory:function(){return this.back(),new ThisLife.Albums.View.AddAlbumPopover({autoAdd:this.options.recentUploads||"timeline_add"===this.options.type?this.collection:this.myCollection,recentUploads:this.options.recentUploads,navigateToAlbum:!this.options.fmv&&"timeline_add"!==this.type&&"moment_move"!==this.type,moveMoment:"moment_move"===this.type,copyMoment:this.options.copyMoment,partialEdit:this.partialEdit})},getInfo:function(e){var t,i,n,o,s,r,l;return e=String(e),l=ThisLife.Model.User,i="facebook"===e&&l.get("facebook_access_token"),r="twitter"===e&&l.get("twitter_access_token"),s="tumblr"===e&&l.get("tumblr_access_token"),n=this.collection.length,t=this.collection,o={facebook:i,twitter:r,tumblr:s,num:n,collection:t,type:e,album_uid:this.options.album_uid}},doneTagging:function(){var e,t,i;return this.back(),t=_.pluck(this.myCollection,"id").length>1?" PHOTOS":" PHOTO",ThisLife.app.controller("toast")["new"]({title:_.pluck(this.myCollection,"id").length+t+" TAGGED",style:"light",position:"bottom-left"}),ThisLife.app.controller("selection").done(),e=this.myCollection.length,this.partialEdit?(i=new ThisLife.View.ModalAlert({template:"actionPermissionWarning"}),$(document.body).append(i.render().el)):void 0},back:function(){var e;return this.options.fmv&&this.collection.trigger("fmv:closeShare",this.collection),this.view&&"function"==typeof(e=this.view).teardown&&e.teardown(),this.teardown()},teardown:function(){return ThisLife.app.controller("timeline").enableScroll(),this.unbindEvents(),this.remove()},getCurrentStoryUid:function(){var e,t;return e="albums"===(null!=(t=ThisLife.app.currentState)?t.name:void 0)?ThisLife.app.album.getCurrentAlbum():null,null!=e?e.get("uid"):void 0}}),define("ThisLife.View.ActionBarModal",[],function(){return ThisLife.View.ActionBarModal})}.call(this),function(){var e,t,i,n,o,s,r,l,a,u;(t=ThisLife.View).actionBar||(t.actionBar={}),i=[{collection:"locationTags",attr:"location_taggings",type:"place"},{collection:"personTags",attr:"faces",type:"person"},{collection:"momentTags",attr:"moment_taggings",type:"tag"}],ThisLife.View.actionBar.tags=Backbone.View.extend({events:{"focus input":"shorthand","click .tag_input_wrap .orange-btn":"clickAddTag"},initialize:function(){return this.locationTags=ThisLife.Collection.locationTags,this.locationTags.setView(this),this.momentTags=ThisLife.Collection.momentTags,this.personTags=ThisLife.Collection.personTags,this.pubSub=new ThisLife.Support.PubSub},teardown:function(){return this.remove()},checkCollectionLength:function(){return this.collection.length?this.startRender(this.collection):(this.tagList.classList.add("loading"),this.collection.on("reset",this.updateView,this))},updateView:function(e){var t,n,o;for(t=0,n=i.length;n>t;t++)o=i[t],e[o.type]=[];return this.startRender(e),this.tagList.classList.remove("loading"),this.collection.off("reset",this.updateView,this),this.el.querySelector("#tag_input").focus()},startRender:function(e){var t,n,o;for(t=0,n=i.length;n>t;t++)o=i[t],this.renderTags(e,o.collection,o.attr,o.type);return this.el.querySelector("#tag_input").focus()},renderTags:function(t,i,n,o){var s,r,l,a,u,c,d,h,p;if(l=ThisLife.Collection[i],p=_.flatten(t.pluck(n)),p.length||this.collection[o].length){for(this.collection[o].length||(this.collection[o]=this.getSharedResults(p,l)),u=this.collection[o],c=[],s=0,r=u.length;r>s;s++)d=u[s],h=l.get(d),h?(a={model:h,type:o,collection:this.collection,pubSub:this.pubSub},"person"===o&&(a.removeTagging=_.bind(this.removeTagging(p),this)),c.push(this.tagList.appendChild(new e(a).el))):c.push(void 0);return c}},removeTagging:function(e){return _.isArray(e)?e=e:_.isObject(e)&&(e=[e]),function(t){var i,n,o;return o=t.id,n=_.filter(e,function(e){return e.person_tag_uid===o}),i=_.pluck(n,"uid"),t.removeFaces(i)}},getSharedResults:function(e,t){var i,o,r,l,a,u,c;return i=n(e[0]),a=this.collection.length,o=s(i),r=_.groupBy(e,o),t.verifyTaggings(r),u=function(){var e;e=[];for(l in r)c=r[l],c.length>=a&&e.push(c[0][i]);return e}(),_.compact(u)},render:function(){return this.el.insertAdjacentHTML("beforeend",u(this.collection.toJSON())),this.tagList=this.el.querySelector(".list_container"),this.el.querySelector("#tag_input").focus(),"undefined"!=typeof Placeholders&&null!==Placeholders&&Placeholders.init(),this.checkCollectionLength(),this},remove:function(){return this.$el.remove(),this},shorthand:function(){var e,t,i,n,o,s,r;return t=this.el.getElementsByTagName("input")[0],o=ThisLife.Service.api.combineContacts().toJSON(),s=this.locationTags.toJSON(),i=this.momentTags.toJSON(),r=_.union(o,s,i),e=_.bind(this.shorthandCallback,this),n={source:r,value:"name",parent:$(t).parent(),num:-1,sorted:!1,template:l,menu:'<ul class="tl_autocomplete"></ul>',selectCallback:e},$(t).shorthand(n)},shorthandCallback:function(e,t){var i,n,o,s;return null==t&&(t=!1),i=_.extend({},e.data()),t&&(i.value=e.val()),e.blur(),n=i.type,s=i.value.trim(),s&&s.toLowerCase()!==e.attr("placeholder").toLowerCase()?(n||"#"!==s.charAt(0)||(n="tag",i.value=s.slice(1)),o=this.collection.pluck("uid"),this.updateMethodByType(i,o,n),_.defer(function(){return e.val(""),document.getElementById("tag_input").focus()})):void 0},clickAddTag:function(){var e;return e=this.el.querySelector("#tag_input"),this.shorthandCallback($(e),!0)},updateMethodByType:function(e,t,i){var n;return i?(n=e.id||e.uid,i=r(i),"place"===i&&0!==this.collection.place.length&&this.collection.place[0]!==n&&this.pubSub.trigger("remove",this.collection.place[0]),"person"===i&&ThisLife.PubSub.trigger("people:requireUpdate"),_.include(this.collection[i],n)?this.showAlert():this[o(i)](e,t)):this.isInCollection(e,t)},updatePeople:function(e,t){return t=this.trimPeopleUids(e,t),t.length?this.updateCollection(this.personTags,e,t):ThisLife.log.error("update people, no moment uids")},trimPeopleUids:function(e,t){var i,n,o,s;return s=e.uid||e.id,n=_.flatten(this.collection.pluck("faces")),o=_.filter(n,function(e){return e.person_tag_uid===s}),i=_.pluck(o,"moment_uid"),i.unshift(t),_.without.apply(null,i)},updateTags:function(e,t){return this.updateCollection(this.momentTags,e,t)},updatePlaces:function(e,t){return this.updateCollection(this.locationTags,e,t)},updateCollection:function(e,t,i){return this.tagList.classList.add("loading"),e.off("new_tag",this.addNewTag,this),e.on("new_tag",this.addNewTag,this).updateTaggings(t,i)},getCollectionFromType:function(e){return"person"===e.type?ThisLife.Service.api.combineContacts():ThisLife.Collection[e.collection]},isInCollection:function(e,t){var n,o,s,r,l,a,u,c;for(s=0,l=i.length;l>s;s++)if(r=i[s],o=this.getCollectionFromType(r),a=o.findName(e.value)){u=r.type;break}return a?(e.uid=a.id,this.updateMethodByType(e,t,u)):(n=_.bind(this.updateMethodByType,this,e,t),c=new ThisLife.View.NewTagPopup({data:e,callback:n}),document.getElementById("tag_input").disabled=!0,document.getElementById("popover_wrap").appendChild(c.render().el))},addNewTag:function(t,i,n){var o,s,r;return this.tagList.classList.remove("loading"),i.off("new_tag",this.addNewTag,this),t?(r=this.getType(i),this.collection[r].unshift(t.id),o={model:t,type:r,collection:this.collection,pubSub:this.pubSub},"PersonTag"===t.get("_explicitType")&&(o.removeTagging=_.bind(this.removeTagging(n),this)),this.tagList.prependChild(new e(o).el),null!=(s=document.getElementById("tag_input"))?s.focus():void 0):this.showAlert()},showAlert:function(){var e;return e=new ThisLife.View.ModalAlert({template:"tagAlreadyExistsTemplate"}),_.defer(function(){return document.body.appendChild(e.render().el)})},getType:function(e){switch(e){case this.personTags:return"person";case this.momentTags:return"tag";case this.locationTags:return"place"}},teardown:function(){return this.off(),this.trigger("teardown"),this.remove()}}),o=function(e){var t;return t=function(){switch(e){case"person":return"updatePeople";case"tag":return"updateTags";case"place":return"updatePlaces"}}()},l='<% var className, facebookUid; facebookUid = typeof facebook_uid == "string" ? facebook_uid : ""; className = _explicitType === "LocationTag" ? "places" : _explicitType === "PersonTag" ? "people" : "tags"; %><li class=\'<%= className %>\' data-uid=\'<%= uid %>\' data-facebook-uid="<%= facebookUid %>" data-type=\'<%= className %>\'><a class=\'name\'></a></li>',u=function(){var e,t,i;return t=ThisLife.Model.User.isPaidAccount()?"photos and videos":"photos",i=ThisLife.Templates.actionBar("topTemplate",{view:"tags",additionalClass:"one_button_modal"}),e=ThisLife.Templates.actionBar("oneButtonTemplate",{text:"Done",className:"js_done_tagging"}),i+"\n<h4>Tags</h4>\n<div class='modal_information'>\nAdd tags to organize your "+t+'\n\n  <div class="tag_input_wrap">\n    <input type="text" placeholder="Person, Place or Tag" id="tag_input" maxlength="255">\n    <a class="orange-btn">Add</a>\n  </div>\n\n  <div class="popover_list_wrap tags">\n      <div class=\'list_header\'>Current Tags</div>\n      <div class=\'list_container\'></div>       \n  </div>\n\n</div>\n'+e
},e=Backbone.View.extend({tagName:"div",className:"list_item",events:{"click .remove":"removeTagging"},initialize:function(e){return this.options=null!=e?e:{},this.el.classList.add(this.options.type),this.render(),this.bindEvents()},bindEvents:function(){return this.options.pubSub.on("remove",this.removeHandler,this)},unbindEvents:function(){return this.options.pubSub.off(null,null,this)},render:function(){var e;return e=this.model.get("name"),this.el.insertAdjacentHTML("beforeend",a(e,this.options.taggings)),this},removeTagging:function(){var e;return this.options.removeTagging?this.options.removeTagging(this.model):(e=this.collection.pluck("uid"),this.collection[this.options.type]=_.without(this.collection[this.options.type],this.model.id),this.model.deleteTaggingsForMomentUids(e)),this.teardown()},removeHandler:function(e){return this.options.model.id===e?this.removeTagging():void 0},teardown:function(){return this.unbindEvents(),this.remove()}}),n=function(e){switch(e._explicitType){case"LocationTagging":return"location_tag_uid";case"Face":return"person_tag_uid";case"MomentTagging":return"moment_tag_uid"}},s=function(e){return function(t){return t[e]}},a=function(e){return e=ThisLife.Helper.String.escapeHtml(e),"<span>"+e+'</span>\n<div class="remove" data-tagging-uids=""><div></div></div>'},r=function(e){switch(e){case"person":case"people":return"person";case"tag":case"tags":return"tag";case"place":case"places":return"place"}}}.call(this),function(){var e,t,i,n,o;ThisLife.View.actionBar.email=Backbone.View.extend({className:"email_modal",events:{"keypress #share_recipients":"makeLikeChosen","keydown #share_recipients":"makeLikeChosen","input #share_recipients":"makeLikeChosenAndroid","click .added_item .remove":"removeRecipient","click .remove_invalid":"removeInvalidInput","click .added_item.invalid":"editRecipient","mouseover .added_item:not(.invalid)":"showEmail","mouseout .added_item:not(.invalid)":"hideEmail","click .recipients":"onRecipientsClick","keydown textarea":"textareaKeydown","focus textarea":"hideBottom","blur textarea":"blurInputField","focus #share_recipients":"hideBottom","blur #share_recipients":"blurInputField","click .warning_icon":"clearNotify","click .address-book":"openAddressBook"},initialize:function(e){return this.options=null!=e?e:{},this.model=ThisLife.Model.User,this.collection||(this.collection=new APICollection(this.options.model)),this.personTags=ThisLife.Collection.personTags,this.render(),this.bindEvents()},render:function(){var e;return ThisLife.Helper.Platform.mobile()||this.el.classList.add("not_touch"),this.options.fmv?this.$el.html(this.template()):(e=this.collection.length,e||this.collection.on("reset",this.renderLength,this),this.el.classList.add("loading"),this.$el.html(this.template())),this.personTags.whenLoaded(this.buildContacts,this),this.cacheElements(),this.winHeightDevice=window.innerHeight,this},teardown:function(){return this.remove()},cacheElements:function(){return this.recipientsEl=this.el.querySelector(".recipients")},bindEvents:function(){return ThisLife.PubSub.on("state:change",this.remove,this).on("modal:show",this.remove,this).on("actionBar:share",this.save,this),this.options.fmv?ThisLife.PubSub.on("fmv:close",this.remove,this):void 0},unbindEvents:function(){return this.options.fmv&&ThisLife.PubSub.off("fmv:close"),ThisLife.PubSub.off("state:change",this.remove).off("modal:show",this.remove).off("actionBar:share")},newGrayPopup:function(e){var t,i;return this.removeNotify(),this.removeGrayPopup(),i=e.uid,t=e.element,this.smallGrayView=new ThisLife.View.SmallGrayPopup(e),this.on("action:email",function(e){var n,o,s;return n=e.email.trim(),o=this.el.querySelector(".added_item[data-uid='"+i+"']"),delete ThisLife.Collection.contacts,$(o).attr("data-email",n),s=this.personTags.get(i),s.set("email",n),s.save(),o.classList.remove("invalid"),$(t).val(""),this.refreshShorthandContacts(),this.updateAppModal()}),this.grayPopupBlurEvent=ThisLife.blurEvent(this.smallGrayView.$el,_.bind(this.removeGrayPopup,this)),ThisLife.Support.keyInformant.on("cancel",_.bind(this.removeGrayPopup,this),this)},notify:function(e,t,i){var n,o;return null==i&&(i={}),this.removeNotify(),this.invalidItem=t,n=$(t).parent(),$(t).hasClass("invalid")||i.valid||$(n).addClass("invalid"),i.valid||$(n).addClass("no_scroll"),null!=(o=this.errorTooltip)&&o.teardown(),this.errorTooltip=new ThisLife.View.Album.SharePopupTooltip({message:e,contentClass:i.contentClass}),$(n).append(this.errorTooltip.el),this.debounceResize=_.debounce(_.bind(this.adjustTooltipPosition,this),100),ThisLife.PubSub.on("resize",this.debounceResize,this),this.adjustTooltipPosition(i)},adjustTooltipPosition:function(e){var t,i,n,o,s,r,l,a,u,c,d;return null==e&&(e={}),s=$(".recipients"),e.noScroll||s.scrollTop(0),u=$(this.invalidItem).offset().top-s.offset().top-4,e.noScroll||s.scrollTop(u),d=$(".validation_tooltip").width(),c=$(".validation_tooltip").height(),o=$(this.invalidItem).position(),l=e.offsetTop?o.top-c-6:o.top-c,n=$(this.invalidItem).outerWidth(),r=o.left-d/2+n/2,t="50%",$(window).width()<=480&&$(window).width()<d&&(r=0,$(".validation_tooltip").css("min-width",$(window).width()+"px")),this.$el.find(".arrow").css({left:t}),this.$el.find(".arrow .border").css({left:t}),$(".validation_tooltip").css({top:l+"px",left:r+"px"}),$(window).width()<=768&&(i=this.el.querySelector(".validation_tooltip").getBoundingClientRect(),i.left<0?(r=0,t=o.left+n/2,a=!0,$(".validation_tooltip").css({top:l+"px",left:r+"px"})):i.right>$(window).width()&&(a=!0,r=$(window).width()-d,t=o.left-r+n/2),a)?($(".validation_tooltip").css({top:l+"px",left:r+"px"}),this.$el.find(".arrow").css({left:t}),this.$el.find(".arrow .border").css({left:t})):void 0},removeNotify:function(){var e,t;return null==this.invalidItem||$(this.invalidItem).hasClass("invalid")||$(this.invalidItem).parent().removeClass("invalid"),null==this.invalidItem||this.invalidItem.classList.contains("no_scroll")||null!=(e=this.invalidItem.parentNode)&&e.classList.remove("no_scroll"),this.invalidItem=null,null!=(t=this.errorTooltip)&&t.teardown(),this.errorTooltip=null,ThisLife.PubSub.off("resize",this.debounceResize,this)},removeGrayPopup:function(){var e;return null!=(e=this.smallGrayView)&&e.remove(),this.smallGrayView=null,this.off("action:email"),this.removeGrayPopup&&ThisLife.Support.keyInformant.off("cancel",this.removeGrayPopup,this),this.grayPopupBlurEvent?ThisLife.removeBlurEvent(this.grayPopupBlurEvent):void 0},clearNotify:function(){var e;return null!=(e=this.invalidItem)&&(e.value=""),this.removeNotify()},isVideo:function(e){return e.isVideo()},renderLength:function(){return this.$("h5.count").text(ThisLife.Templates.actionBar("count",this.collection.length)),this.$("textarea").val(this.getCaption()),this.collection.off("reset",this.renderLength,this)},getCaption:function(){return 1===this.collection.length?this.collection.first().get("caption_text")||"":""},getSubject:function(){var e,t;return e=this.collection.length,this.options.fmv||(t=this.getCaption()),t||(t=i(e))},buildContacts:function(){return _.defer(function(e){return function(){var t;return $("#share_loading").remove(),e.el.classList.remove("loading"),t=$(document.getElementById("share_recipients")),e.shorthand(t)}}(this))},refreshShorthandContacts:function(){var e;return e=this.$el.find("#share_recipients"),e.get(0).shorthand.destroy(),this.shorthand(e)},makeLikeChosen:function(e){var t,i;if(!ThisLife.Helper.Platform.android())if(t=e.currentTarget,i=t.value,ThisLife.Helper.Keyboard.isSpace(e.keyCode)){if(ThisLife.Helper.Validate.email(i))return t.shorthand.select(),t.value="",!1}else if(ThisLife.Helper.Keyboard.isComma(e.keyCode)||ThisLife.Helper.Keyboard.isSemicolon(e.keyCode))return t.shorthand.select(),t.value="",!1},makeLikeChosenAndroid:function(e){var t,i,n;if(ThisLife.Helper.Platform.android())return t=e.currentTarget,n=t.value,i=n[n.length-1],","===i||";"===i||" "===i?(t.value=n.slice(0,-1),t.shorthand.select(),t.value="",!1):void 0},onRecipientsClick:function(e){return this.clearNotify(),$(e.currentTarget).find("input").focus()},scrollToBottom:function(){return ThisLife.Helper.DOM.scrollToBottom(this.recipientsEl)},textareaKeydown:function(e){return e.metaKey&&ThisLife.Helper.Keyboard.isEnter(e.keyCode)?this.save():void 0},hideBottom:function(){return ThisLife.Helper.Platform.android()?($(".bottom_section").hide(),this.resizeCallback=_.debounce(_.bind(this.showBottom,this),100),ThisLife.PubSub.on("resize",this.resizeCallback,this)):void 0},blurInputField:function(){var e;return ThisLife.Helper.Platform.android()&&(e=window.innerHeight,e===this.winHeightDevice)?($(".bottom_section").show(),ThisLife.PubSub.off("resize",this.resizeCallback,this)):void 0},showBottom:function(){var e;return ThisLife.Helper.Platform.android()?(e=window.innerHeight,e===this.winHeightDevice?$(".bottom_section").show():$(".bottom_section").hide()):void 0},shorthand:function(e){var t,i;return i=ThisLife.Service.api.getContactsWithoutFacebook().toJSON(),t={source:i,value:"name",parent:$(this.el).find(".suggestions_wrap"),"class":"sharing suggestions",sorted:!1,num:-1,highlighter:function(e){return ThisLife.Helper.String.escapeHtml(e)},matcher:function(e){var t;return t=e[this.value]+(e.email||""),t?~t.toLowerCase().indexOf(this.query.toLowerCase()):void 0},select:function(){var e,t;return e=this.$menu.find("."+this.activeClass),t=e.data("value")||e.data("email"),this.shown&&t&&this.$el.val(t.trim()),t&&t.toLowerCase()===this.$el.val().toLowerCase()&&this.$el.data(e.data()),this.selectCallback&&this.selectCallback(this.$el),this.hide()},blur:function(e){return ThisLife.Helper.Keyboard.isEscape(e.keyCode)&&this.hide(),this.selectCallback&&!this.shown?this.selectCallback(this.$el):void 0},template:o,selectCallback:_.bind(this.onEnter,this)},$(e).shorthand(t)},onEnter:function(i){var n,o,s,r,l,a,u,c;if(c=i.val().trim()){if(n=i.data(),u=n.uid,o=null!=(a=n.email)?a.trim():void 0,s=this.el.querySelector(".recipients_input"),u)if(o){if(!this.validateRecipient(null,o,s))return;this.addRecipient(e(o,c),i),this.updateAppModal()}else{if(!this.validateRecipient(u,c,s))return;this.addRecipient(t(u,c),i),r=this.el.querySelector(".added_item[data-uid='"+u+"']"),l=this.getPopupOffset(r),this.newGrayPopup({offset:l,uid:u,"class":"email_share_modal",view:this,element:i,item:r})}else if(o&&ThisLife.Helper.Validate.email(o)){if(!this.validateRecipient(null,o,s))return;this.addRecipient(e(o,c),i),ThisLife.Model.User.addEmailAddress(o),i.get(0).shorthand.updateSource(ThisLife.Service.api.getContactsWithoutFacebook().toJSON()),this.updateAppModal()}else{if(!ThisLife.Helper.Validate.email(c))return this.notify("Invalid email address",s);if(!this.validateRecipient(null,c,s))return;this.addRecipient(e(c,c),i),ThisLife.Model.User.addEmailAddress(c),i.get(0).shorthand.updateSource(ThisLife.Service.api.getContactsWithoutFacebook().toJSON()),this.updateAppModal()}return i.attr("placeholder",""),u&&o&&i.val(""),i.removeData()}},validateRecipient:function(e,t,i){var n;return this.recipientExists(e,t)?(this.notify("This contact has already been added",i),n=$(document.getElementById("share_recipients")),$(n).removeData(),!1):!0},updateAppModal:function(){var e;return e=this.getRecipientCount(),this.parentController.updateButtonSubText("orange_button",e+""),e>0?this.parentController.enableButton("orange_button"):this.parentController.disableButton("orange_button")},getRecipientCount:function(){return this.recipientsEl.querySelectorAll(".added_item:not(.invalid)").length},openAddressBook:function(){var e,t;return e=this.el.querySelector("#share_recipients"),null!=(t=$(e).get(0).shorthand)&&t.hide(),ThisLife.app.controller("addressbook").show({sendToList:this.emailList(),cb:_.bind(this.onCloseAddressBook,this)}),ThisLife.app.controller("tracking").logClickShareAddressBook()},onCloseAddressBook:function(e){var t;return t=this.el.querySelector("#share_recipients"),_.each(e,function(e){return function(i){var n;return e.recipientExists(null,i.email)?void 0:(n="",i.fName&&(n=i.fName),i.lName&&(n+=" "+i.lName),n||(n=i.email),$(t).data(i),$(t).val(n).blur())}}(this))},recipientExists:function(e,t){var i,n,o,s;for(o=this.recipientsEl.querySelectorAll(".added_item"),n=0,s=o.length;s>n;n++){if(i=o[n],e&&$(i).attr("data-uid")===e)return!0;if(t&&$(i).attr("data-email")===t)return!0}return!1},findRecipient:function(e){var t,i,n,o;for(n=this.recipientsEl.querySelectorAll(".added_item"),i=0,o=n.length;o>i;i++)if(t=n[i],e&&$(t).attr("data-email")===e)return t;return!1},addRecipient:function(e,t){return this.removeNotify(),t.val(""),$(this.recipientsEl.querySelector(".recipients_input")).before(e),this.scrollToBottom()},removeRecipient:function(e,t){var i,n;return i=e?e.currentTarget.parentNode:t,i.parentNode.removeChild(i),this.removeNotify(),this.removeGrayPopup(),0===this.emailList().length&&(n=document.getElementById("share_recipients"),$(n).attr("placeholder",$(n).attr("data-placeholder"))),this.updateAppModal()},removeInvalidInput:function(){var e;return this.removeNotify(),e=document.getElementById("share_recipients"),$(e).attr("placeholder",$(e).attr("data-placeholder")).val(""),this.updateAppModal()},showEmail:function(e){var t,i;return this.smallGrayView||this.errorTooltip||ThisLife.app.isMobile||(i=e.currentTarget,t=$(i).data(),t.email.trim().toLowerCase()===$(i).text().trim().toLowerCase())?void 0:(this.showingEmail=!0,this.notify(t.email,i,{offsetTop:!0,contentClass:"narrow",noScroll:!0,narrow:!0,valid:!0}))},hideEmail:function(){return this.showingEmail&&!ThisLife.app.isMobile?(this.removeNotify(),this.showingEmail=!1):void 0},editRecipient:function(e){var t,i,n,o,s;return e.stopPropagation(),i=e.currentTarget,n=e.target,o=n.parentNode,t=$(i).data(),s=t.uid,n.classList.contains("remove")||o.classList.contains("remove")?void 0:this.newGrayPopup({offset:this.getPopupOffset(i),"class":"email_share_modal",view:this,element:i,item:i,uid:s})},getPopupOffset:function(e){var t,i,n,o,s;return i=e.getBoundingClientRect(),s=$(e).outerWidth(),o=i.top,n=i.left+s/2,t={top:o,left:n}},getCurrentStoryUid:function(){var e,t;return e="albums"===(null!=(t=ThisLife.app.currentState)?t.name:void 0)?ThisLife.app.album.getCurrentAlbum():null,null!=e?e.get("uid"):void 0},save:function(){var e,t,i,n,o,s,r,l,a,u,c;if(t=this.el,e=this.collection,o=document.getElementById("share_recipients"),s=this.el.querySelector(".recipients_input"),$(o).val().toLowerCase()!==$(o).attr("data-placeholder").toLowerCase()){if(o.shorthand.select(),a={},a.twitter=a.facebook=a.tumblr=a.youtube=!1,a.emails=_.compact(this.emailList()),a.storyUid=this.getCurrentStoryUid(),i=this.el.querySelector("#include_self_checkbox").checked,a.cc=i,(null!=(r=this.el.querySelectorAll(".recipients>.email.invalid"))?r.length:void 0)>0)return ThisLife.PubSub.off("actionBar:shareResponse"),c="Provide an email address",n=this.el.querySelectorAll(".recipients>.email.invalid")[0],void this.notify(c,n,{offsetTop:!0});if(!((null!=(l=this.el.querySelectorAll(".invalid"))?l.length:void 0)>0))return a.emails.length?(a.momentUids=this.collection.pluck("uid"),u=a.subject=this.getSubject(),a.message=this.$("textarea").val(),ThisLife.Service.api.shareMoments(a,_.bind(function(e){this.shared(e)},this)),void 0):(ThisLife.PubSub.off("actionBar:shareResponse"),c="Please enter addresses or select people to share with",this.notify(c,this.el.querySelector("#share_recipients")))}},emailList:function(){var e;return _.uniq(function(){var t,i,n,o;for(n=this.$(".recipients>.email"),o=[],t=0,i=n.length;i>t;t++)e=n[t],o.push($(e).attr("data-email"));return o}.call(this))},shared:function(e){var t,i,o,s,r;return $(".action_bar_modal .tl_modal_bottom_left").empty(),$(".action_bar_modal .tl_modal_bottom_right").html('<a id="modal_cancel" class="small-btn porcelain-btn">Done</a>'),e.result.success?(ThisLife.Helper.Platform.ie()&&ThisLife.Helper.Platform.majorVersion()<11?this.$el.html(ThisLife.Templates.actionBar("sharedByEmail",this.collection.models)):ThisLife.app.isMobile?(this.parentController.removeView(),this.options.fmv||ThisLife.app.controller("selection").done()):(t=this.collection.length>20,this.$el.html(n(this.collection.models)),i=$(".photobook_intercept .primary "),s=$(".photobook_intercept .secondary "),t&&(o=new ThisLife.View.MagicShopView({el:i,fullView:!1,view:"share",prodType:"photobook_share",collection:this.collection,clickthroughNoModal:!0}),r=new ThisLife.View.MagicShopView({el:s,fullView:!1,view:"share",prodType:"photogifts_share",collection:this.collection,clickthroughNoModal:!0})),t||(o=new ThisLife.View.MagicShopView({el:i,fullView:!1,view:"share",prodType:"prints_share",collection:this.collection,clickthroughNoModal:!0}),r=new ThisLife.View.MagicShopView({el:s,fullView:!1,view:"share",prodType:"photogifts_share",collection:this.collection,clickthroughNoModal:!0})),$(".photobook_intercept .close-btn").off().on("click",function(e){return function(){var t;return e.parentController.removeView(),"function"==typeof(t=e.parentController.options).onRemove&&t.onRemove(),e.options.fmv?void 0:ThisLife.app.controller("selection").done()}}(this))),this.trackShareLinkClick()):(this.$el.html(ThisLife.Templates.actionBar("emailLimitReached")),_.delay(function(e){return function(){var t;return e.parentController.removeView(),"function"==typeof(t=e.parentController.options).onRemove&&t.onRemove(),e.options.fmv?void 0:ThisLife.app.controller("selection").done()}}(this),1200)),$("#tl_action_bar_share").removeClass("tl_modal_middle_share"),ThisLife.PubSub.trigger("actionBar:shareResponse"),$("#popover_wrap").addClass("popover_view_shared")},remove:function(){return this.removeNotify(),this.unbindEvents(),this.$el.remove(),$("#save_email_address").remove()},selectedCount:function(){var e,t,i,n;return n=ThisLife.app.controller("selection"),e=n.getCollection(),t=(null!=(i=this.options)?i.fmv:void 0)&&0===n.getCount()?this.isVideo(this.options.fmvModel)?"1 video is selected":"1 photo is selected":this.updateLabel(ThisLife.app.isMobile?this.collection.models:e.models)},updateLabel:function(e){var t;return t=ThisLife.Helper.String.pluralizePhotosVideosSeparate(e),t+=e.length>1?" are":" is",t+=" selected"},trackShareLinkClick:function(){return ThisLife.app.controller("tracking").logSharePost("email")},template:function(){return'<p class="selected_count">'+this.selectedCount()+'</p>\n<div class="modal_information">\n   <div class="section">\n     <div class="label">Send to</div>\n     <div class="recipients">\n       <div class="recipients_input">\n       <input type="text" placeholder="Enter name or email" data-placeholder="Enter email or name" id="share_recipients">\n       <a class="remove_invalid" href="javascript:;"></a>\n       </div>\n     </div>\n\n     <div class="suggestions_wrap"></div>\n  \n     <ul class="secondary-options">\n       <li class="send-me-copy">\n         <div class="small-checkbox-wrap">\n           <input type="checkbox" name="include_self" id="include_self_checkbox" checked=""> <label for="include_self_checkbox"><span class=\'check-box\'><span></span></span>Send me a copy</label>\n         </div>\n       </li>\n       <li class="address-book-link">\n          <a class="address-book tertiary_link" href="javascript:;">Address book</a>\n       </li>\n     </ul>\n     <div class="clear"></div>\n   </div><!--//section-->\n   <div class="section message_section">\n     <div class="label">Message</div>\n     <textarea placeholder="Add an optional message"></textarea>\n   </div>\n  </div>\n\n    '}}),i=function(e){var t;return t=1===e?" a":"","I just shared "+t+" "+ThisLife.Helper.String.pluralizeWord(e,"moment")+" from ThisLife"},e=function(e,t){return t=ThisLife.Helper.String.escapeHtml(t),"<div data-email='"+e+"' class='added_item email'>\n  "+t+"\n  <div class='remove'>\n    <div class='icon'></div>\n  </div>\n </div>"},t=function(e,t){return"<div data-uid='"+e+"' class='added_item email invalid'>\n  "+t+"\n  <div class='remove'>\n    <div class='icon'></div>\n  </div>\n  <div class=\"warning_icon\"></div>\n</div>"},n=function(e){return"<div class='photobook_intercept'>\n  <div class='close-btn'></div>\n  <div class='header'>\n    <div class='title'>\n      <div class='section'><img src='/assets/1px.gif'><span class=\"text\">Your "+ThisLife.Helper.String.pluralizePhotosVideos(e)+" "+ThisLife.Helper.String.pluralizeWord(e.length,"is","are")+" shared!</span></div>\n    </div>\n  </div>\n  <div class='primary'>\n  </div>\n  <div class='secondary'>\n  </div>\n</div>"},o="<% var uid = uid || \"\"; var email = email || \"\"; var facebookUid = facebook_uid || \"\"; var default_face_url = default_face_url || \"/assets/people/defaultPerson.png\" %>\n<% if (email) { %>\n  <li data-email='<%= email %>' data-uid='<%= uid %>' class='item'>\n    <img src=\"<%= default_face_url %>\" class=\"avatar row_avatar\" />\n    <a class=\"name\"></a>\n    <span class=\"email\">\n      <%= email %>\n    </span>\n  </li>\n<% } else if (facebookUid) { %>\n  <li data-facebook-uid='<%= facebookUid %>' data-uid='<%= uid %>' class='item'><img src='<%= default_face_url %>' class='avatar row_avatar' /><a class='name'></a></li>\n<% } else { %>\n  <li data-uid='<%= uid %>' class='item'><img src='<%= default_face_url %>' class='avatar row_avatar' /><a class='name'></a></li>\n<% } %>",define("ThisLife.View.actionBar.email",[],function(){return ThisLife.View.actionBar.email})}.call(this),function(){ThisLife.View.actionBar.link=Backbone.View.extend({initialize:function(e){return null==e&&(e={}),this.storyUid=e.storyUid,this.collection=e.collection},render:function(){return this.el.innerHTML=ThisLife.Templates.actionBar("link"),this.cacheElements(),this.getUrl(),this},teardown:function(){return this.remove()},cacheElements:function(){return this.inputEl=this.el.querySelector("input")},getUrl:function(){var e;return this.collection.getShareUrl()?void this.setUrl():(e=function(e){return this.collection.setShareUrl(_.values(e.result.payload)[0]),this.setUrl()},ThisLife.Service.api.shareMoments({momentUids:this.collection.pluck("uid"),storyUid:this.storyUid,urlOnly:!0},_.bind(e,this)))},setUrl:function(){return this.inputEl.value=this.collection.getShareUrl(),this.inputEl.focus(),_.defer(function(e){return function(){return e.inputEl.select()}}(this))}})}.call(this),function(){var e;ThisLife.View.ActionBarDate=Backbone.View.extend({initialize:function(e){return this.options=null!=e?e:{},this.callback=this.options.callback,this.uid=this.options.uid,assert(this.uid,"edit date moment uid must exist")},events:function(){return{"click .orange-btn":"saveDate","change .month select":"onMonthYearSelected","change .year select":"onMonthYearSelected"}},render:function(){return this.options.days||this.options.date&&(this.options.days=ThisLife.Helper.Date.daysInMonthFromDate(this.options.date)),$(this.el).html(ThisLife.Templates.actionBar("date",this.options)),this.options.date&&this.setDate(),this},teardown:function(){return this.remove()},onMonthYearSelected:function(){var e;return e=new Date(this.$(".year option:selected").val(),this.$(".month option:selected").val(),0).getDate(),this.updateDaysList(e)},updateDaysList:function(e){var t,i;for(i=this.$(".day option:selected").val(),this.$(".day option").remove(),this.$(".day select").append("<option value='default' disabled='true'>Day</option>"),t=1;e>=t;)this.$(".day select").append($("<option></option>").attr("value",t).text(t)),t++;return this.$(".day select").val(i)},setDate:function(){var e;return e=new Date(1e3*this.options.date),this.$(".month option[value='"+(e.getUTCMonth()+1)+"'], .year option[value='"+e.getUTCFullYear()+"'], .day option[value='"+e.getUTCDate()+"']").attr("selected","selected"),this.$(".newDate").val(e.dateFormat("Y-m-d"))},saveDate:function(){var e,t,i;return i=["year","month","day"],e=function(){var e,n,o;for(o=[],e=0,n=i.length;n>e;e++)t=i[e],o.push(this.$("."+t+" option:selected").val());return o}.call(this),ThisLife.app.isMobile&&(e=this.$(".newDate").val().split("-")),this.callback&&this.callback({year:e[0],month:e[1],day:e[2]}),this.remove()}}),e=function(e,t){var i;return _.all(function(){var n,o;for(o=[],i=n=2;n>=0;i=--n)o.push(e[i]===t[i]);return o}(),_.identity)}}.call(this),function(){ThisLife.View.ActionBarShareService=Backbone.View.extend({className:"modal_wrap",events:{"click #post_to_facebook:not(.disabled)":"postToFacebook","click .edit_fb_album":"editFacebookAlbum","change .custom_select":"facebookAlbumChange","keyup #twitter_caption":"updateCount","click #post_to_tumblr, #post_to_twitter":"postToService","keypress input.new_album":function(e){return 13===e.keyCode?this.postToFacebook():void 0}},initialize:function(e){return this.options=null!=e?e:{},this.type=this.options.type,this.parent=this.options.parent,ThisLife.PubSub.on("connectService:"+this.type,this.connectedToService,this)},render:function(){var e;return $(this.el).html(ThisLife.Templates.actionBar(this.type,this.options)),e=this.$el.find("#connect_to_"+this.type),e.length>0&&e.append(ThisLife.app.socialToken.getServiceIframe(this.type)),this},focus:function(){return $("textarea").focus()},teardown:function(){return ThisLife.PubSub.off("connectService:"+this.type,this.connectedToService,this),this.remove()},updateCount:function(){var e,t;return e=this.$("#twitter_caption"),t=document.getElementById("twitter_count"),t.textContent=120-e.val().length},updateDisplay:function(){return this.facebookAlbumList(),this.delegateEvents()},updateOptions:function(e){return this.options=e,{clearNotify:function(){return this.removeNotify()}}},removeNotify:function(){var e;return null!=this.invalidItem&&$(this.invalidItem).hasClass("invalid")&&($(this.invalidItem).removeClass("invalid"),this.invalidItem=null),null!=(e=this.errorTooltip)&&e.teardown(),this.errorTooltip=null},notify:function(e,t,i){var n,o;return null==i&&(i=!1),this.removeNotify(),this.invalidItem=t,n=$(t).parent(),$(t).hasClass("invalid")||$(t).addClass("invalid"),null!=(o=this.errorTooltip)&&o.teardown(),this.errorTooltip=new ThisLife.View.Album.SharePopupTooltip({message:e}),$(n).append(this.errorTooltip.el),this.blurEventCallback=ThisLife.blurEvent($(".validation_tooltip"),function(e){return function(){return e.removeNotify()}}(this))},postToFacebook:function(){var e,t,i,n,o,s,r,l,a;if(s=$("#"+this.type+"_caption").val(),l={momentUids:this.collection.pluck("uid"),publish_photos:!0,message:s,subject:s,storyUid:this.options.album_uid||this.getCurrentStoryUid()},this.el.querySelector(".fb_preview_album_select").classList.contains("select_album"))t=this.el.querySelector("select").value,i=this.el.querySelector(".new_album").value;else{for(r=this.facebookAlbums,n=0,o=r.length;o>n;n++)e=r[n],"Shutterfly Photos"===e.get("name")&&(t=e.id);t||(i="Shutterfly Photos")}if(t)l.facebook_album_id=t;else{if(!i)return a="Please enter a name for the new album",void this.notify(a,this.el.querySelector(".new_album"));l.facebook_new_album_name=i}return l[this.view]=!0,ThisLife.Service.api.shareMoments(l),this.showShared()},postToService:function(e){var t,i;if(!e.currentTarget.classList.contains("disabled"))return t=$("#"+this.type+"_caption").val(),i={momentUids:this.collection.pluck("uid"),publish_photos:!0,message:t,subject:t,storyUid:this.getCurrentStoryUid()},i[this.type]=!0,ThisLife.Service.api.shareMoments(i),this.showShared()},showShared:function(){return this.$("div.body").html(ThisLife.Templates.actionBar("postedToService",{length:this.collection.length})),$("#popover_wrap").addClass("popover_view_shared"),_.delay(function(){return function(){return $("#popover_wrap .close-btn").trigger("click")}}(this),1200),this.showDoneButton(),this.trackShareLinkClick()},showDoneButton:function(){return this.$(".tl_modal_bottom_left").empty(),this.$(".tl_modal_bottom_right").html('<a id="modal_cancel" class="small-btn porcelain-btn">Done</a>')},connectedToService:function(e){return this.view=!1,this.parent.renderView(),ThisLife.PubSub.off("connectService:"+e,this.connectedToService)},facebookAlbumChange:function(e){var t,i;return i=e.currentTarget.value,t=this.el.querySelector(".new_album"),i?t.style.display="none":(t.style.display="block",t.focus())},editFacebookAlbum:function(){return this.el.querySelector(".fb_preview_album_select").classList.add("select_album"),$(".custom_select",this.$el).customSelect({width:283})},facebookAlbumList:function(){var e;return this.options.facebook?(e=new AlbumList(null,{service:"facebook",type:"albums"}),e.fetch({dataType:"jsonp",success:function(e){return function(t){var i,n,o,s,r,l;if(e.options.albumCollection=t,e.options.albumCollection){for(e.facebookAlbums=e.options.albumCollection.models,l='<span class="label">Your Facebook Albums:</span><select class="custom_select" data-width="261">',s=e.facebookAlbums,n=0,o=s.length;o>n;n++)i=s[n],l+="<option value='"+i.id+"''>"+i.get("name")+"</option>";return l+='<option value="">New Album</option>',l+="</select>",e.selectWrap=e.el.querySelector(".select_album"),e.selectWrap&&e.selectWrap.insertAdjacentHTML("afterbegin",l),null!=(r=e.el.querySelector(".fb_preview_album_select"))?r.classList.add("loaded"):void 0}}}(this),error:function(e){return function(){return e.socialServiceRequired(service)}}(this)})):void 0},getCurrentStoryUid:function(){var e;return e="albums"===ThisLife.app.currentState.name?ThisLife.app.album.getCurrentAlbum():null,null!=e?e.get("uid"):void 0},trackShareLinkClick:function(){return ThisLife.app.controller("tracking").logSharePost(this.type)}}),define("ThisLife.View.ActionBarShareService",[],function(){return ThisLife.View.ActionBarShareService})}.call(this),function(){define("ThisLife.People.Controllers.Merge",["ThisLife.People.Views.Merge","ThisLife.View.ModalAlert"],function(e,t){var i;return i=function(){function i(){}return _.extend(i.prototype,Backbone.Events),i.prototype.renderView=function(t){var i;return this.options=null!=t?t:{},i={width:"480",fullPagePoint:"smallScreen",title:"Would you like to merge these faces?",childView:new e(this.options),disableClose:!0,buttons:[{type:"orange_button",onclick:_.bind(this._doMerge,this),text:"MERGE",noSubtext:!0},{type:"back_button",onclick:_.bind(this._cancel,this),text:"CANCEL"}]},this.mergeView=ThisLife.app.controller("appmodal").get("mergePeople").renderView(i),this},i.prototype._doMerge=function(){var e,i,n,o;return this.mergeView.removeView(),o=new t,document.body.appendChild(o.renderLoadingTemplate().el),n=this.options.source,i=this.options.dest,e=ThisLife.Helper.Scripts.postpone(function(e){return function(){var s,r;return r={src:n,dest:i},o.changeInnerHTML.call(o,"mergePeople",r),_.delay(function(){return o.teardown()},t.CONFIRMATION_DELAY||0),i.count+=n.count,i.trigger("count_changed"),delete ThisLife.Collection.contacts,"function"==typeof(s=e.options).successCallback?s.successCallback(n.id,i.get("name")):void 0}}(this),1e3),ThisLife.Collection.personTags.merge(n,i,e)},i.prototype._cancel=function(){var e;return this.mergeView.removeView(),"function"==typeof(e=this.options).cancelCallback?e.cancelCallback():void 0},i}()})}.call(this),function(){define("ThisLife.People.Controllers.EditPersonModal",["ThisLife.People.Views.PersonModalSidebar","ThisLife.People.Views.EditPersonDetails","ThisLife.People.Views.ChangePersonCover"],function(e,t,i){var n;return n=function(){function n(){}return _.extend(n.prototype,Backbone.Events),n.prototype.renderView=function(n){var o;return this.options=null!=n?n:{},this.options.hideViewClass="app_model_view_hidden",this.options.currentChildView="edit-person-details",this.editPersonDetailsView=new t(_.extend(this.options,{hidden:!1})),this.changePersonCoverView=new i(_.extend(this.options,{hidden:!0,updatePersonCoverCallback:_.bind(this._updatePersonCover,this)})),this.personModalSidebarView=new e(_.extend(this.options,{switchChildCallback:_.bind(this._switchChildView,this)})),o={width:"672",title:" ",fullPagePoint:"smallScreen",modalClass:"edit-person-modal",sidebarView:this.personModalSidebarView,childView:[this.editPersonDetailsView,this.changePersonCoverView],disableClose:!0,buttons:[{type:"orange_button",onclick:_.bind(this._saveState,this),text:"DONE",noSubtext:!0},{type:"back_button",onclick:_.bind(this._cancel,this),text:"CANCEL"}]},this.personModalView=ThisLife.app.controller("appmodal").get("person_modal").renderView(o),this},n.prototype._switchChildView=function(e){switch(this.options.currentChildView=e,e){case"edit-person-details":this.changePersonCoverView.hide(),this.editPersonDetailsView.show();break;case"change-person-cover":this.changePersonCoverView.show(),this.editPersonDetailsView.hide()}return this.personModalSidebarView.setActiveView(e)},n.prototype._updatePersonCover=function(e){var t;return"function"==typeof(t=this.personModalSidebarView).updatePersonCover?t.updatePersonCover(e):void 0
},n.prototype._saveState=function(){var e;return e=!1,this.changePersonCoverView.saveCoverImage(),e=this.editPersonDetailsView.savePerson(),e?setTimeout(function(e){return function(){return e.personModalView.removeView()}}(this),750):"edit-person-details"!==this.options.currentChildView?this._switchChildView("edit-person-details"):void 0},n.prototype._cancel=function(){var e;return this.personModalView.removeView(),"function"==typeof(e=this.options).cancelCallback?e.cancelCallback():void 0},n}()})}.call(this),function(){define("ThisLife.FullView.Controllers.FullView",[],function(){var e;return e=function(){function e(){}return _.extend(e.prototype,Backbone.Events),e.prototype.setup=function(){return ThisLife.PubSub.on("modal:show:fullView",function(e){return function(t){return ThisLife.app.isMobile?ThisLife.app.controller("moment").show("mobile",t.options):(e._currentFullView=new ThisLife.View.FullView(t.options),document.body.appendChild(e._currentFullView.render().el),t.options.moment.isVideo()&&document.querySelector(".full_view_btn.slideshow").classList.add("hidden")),_.defer(function(){return document.body.classList.add("fmv")}),ThisLife.app.controller("tracking").logPageEvent("appfull")}}(this))},e.prototype.startSlideshow=function(){var e;return null!=(e=this._currentFullView)?e.startSlideshow():void 0},e}()})}.call(this),function(){var e;e=Backbone.View.extend({events:{"mouseup .full_view_stage":function(e){return"IMG"===e.target.nodeName&&this.notResizing?this.mouseUpStage(e):void 0},"mousedown .handle":"isResizing","mousedown .new_face_tag":function(e){return e.target.classList.contains("outline")&&this.notResizing?this.isMoving(e):void 0},"focus .new_face_tag input.shorthand_input":"setData"},initialize:function(e){var t;return this.options=null!=e?e:{},this.parentPubSub=this.options.parentPubSub,ThisLife.Support.keyInformant.on("cancel",this.removeOnCancel,this),this.cacheDOMElements().setupVariables().render(),_.bindAll(this,"startTagAnimation","startResizeAnimation","resizeTag","mouseUp","moveTag","mouseUpResize"),t=_.debounce(_.bind(this.onWindowResize,this),100),ThisLife.PubSub.on("resize",t,this),this.parentPubSub.on("faceTags:deleteNew",this.deleteNewFaceTagView,this),ThisLife.Helper.Platform.ie()?void 0:$(document).on("selectstart",!1)},removeOnCancel:function(){return this.parentPubSub.trigger("tagPeople",!1)},onWindowResize:function(){return this.deleteNewFaceTagView()},cacheDOMElements:function(){return this.fmvStage=this.el.getElementsByClassName("full_view_stage")[0],this},setupVariables:function(){return this.canvasImg=this.ctx=this.naturalHeight=this.mainHeight=void 0,this.multiplier=1,this.tag_dimension=this.tag_x=this.tag_y=void 0,this.notResizing=!0,this.stage_w=1e3,this.stage_h=667,this.posX=this.posY=this.newFaceTag=this.currentX=this.currentY=this.newFaceTagHandle=this.newFaceTooltip=0,this},render:function(){return this.el.classList.add("tag_mode"),this.changeStageClasses(!0)},changeStageClasses:function(e){var t,i;return e?(t="add",i="remove"):(t="remove",i="add"),this.fmvStage.classList[t]("tag"),this.fmvStage.classList[i]("zoom")},teardown:function(){var e;return ThisLife.Helper.Platform.ie()||$(document).off("selectstart",!1),this.el.classList.remove("tag_mode"),this.changeStageClasses(!1),this.undelegateEvents(),ThisLife.Support.keyInformant.off("cancel",this.removeOnCancel,this),null!=(e=this.newFaceTagView)?e.removeIfIsNew():void 0},mouseUpStage:function(e){var t;return this.tag_dimension=100,this.stage_w=this.fmvStage.clientWidth,this.stage_h=this.fmvStage.clientHeight,t=this.fmvStage.getBoundingClientRect(),this.tag_x=e.clientX-t.left-this.tag_dimension/2,this.tag_y=e.clientY-t.top-this.tag_dimension/2,this.setTagXAndTagY(),this.deleteNewFaceTagView()?void 0:(this.newFaceTagView=new ThisLife.View.NewFaceTag({positionY:this.position_y,positionX:this.position_x,tagX:this.tag_x,tagY:this.tag_y,dimension:this.tag_dimension,moment:this.model,parentPubSub:this.parentPubSub}),this.fmvStage.appendChild(this.newFaceTagView.render().el),this.newFaceTags=document.getElementsByClassName("new_face_tag"),this.newFaceTag=this.newFaceTags[this.newFaceTags.length-1],this.newFaceTagHandle=this.newFaceTag.querySelector(".handle"),this.newFaceTooltip=this.newFaceTag.querySelector(".full_view_face_tooltip"),this.newFaceTagHandle.style.cssText="left: "+this.tag_dimension+"px; top: "+this.tag_dimension+"px",this.newFaceTooltip.style.left=this.position_x+"px",this.createCanvasFacePlaceholder(this.tag_x,this.tag_y,this.newFaceTagView.$el))},deleteNewFaceTagView:function(){return this.newFaceTagView&&this.newFaceTagView.isNew?(this.newFaceTagView.remove(),delete this.newFaceTagView,!0):!1},setTagXAndTagY:function(){return this.tag_x=Math.max(this.tag_x,0),this.tag_y=Math.max(this.tag_y,0),this.tag_x+this.tag_dimension>this.stage_w&&(this.tag_x=this.stage_w-this.tag_dimension),this.tag_y+this.tag_dimension>this.stage_h&&(this.tag_y=this.stage_h-this.tag_dimension),this.setTooltipPosition()},setTooltipPosition:function(){var e;return this.position_y=(this.tag_y+this.tag_dimension/2)/this.stage_h*100>50?"top":"bottom",e=10,this.position_x=this.tag_x+this.tag_dimension/2-139<e?Math.abs(this.tag_x+this.tag_dimension/2-139-e):this.tag_x+this.tag_dimension/2+139>this.stage_w-e?-1*(this.tag_x+this.tag_dimension/2+139-(this.stage_w-e)):0},isMoving:function(e){var t;return t=e.target.parentNode,this.posX=e.clientX,this.posY=e.clientY,this.currentX=t.offsetLeft,this.currentY=t.offsetTop,$(window).on("mousemove",this.moveTag).on("mouseup",this.mouseUp),this.moveTag(e),this.startTagAnimation(e)},moveTag:function(e){var t,i;return t=this.posX-e.clientX,i=this.posY-e.clientY,this.tag_x=this.currentX-t,this.tag_y=this.currentY-i,this.setTagXAndTagY()},mouseUp:function(){return cancelAnimationFrame(this.moveTagFrame),$(window).off("mousemove").off("mouseup",this.mouseUp),this.newFaceTagView.focusInput()},drawCanvasImage:function(){var e,t,i;return t=this.tag_x*this.multiplier,i=this.tag_y*this.multiplier,e=this.tag_dimension*this.multiplier,this.ctx.drawImage(this.canvasImg,t,i,e,e,0,0,27,27)},startTagAnimation:function(){return this.moveTagFrame=requestAnimationFrame(this.startTagAnimation),this.newFaceTag.style.left=this.tag_x+"px",this.newFaceTag.style.top=this.tag_y+"px",this.newFaceTag.classList.remove("tag_position_bottom","tag_position_top"),this.newFaceTag.classList.add("tag_position_"+this.position_y),this.newFaceTooltip.style.left=this.position_x+"px",this.drawCanvasImage()},createCanvasFacePlaceholder:function(e,t,i){var n,o,s,r;return o=i[0].getElementsByTagName("canvas")[0],"undefined"!=typeof G_vmlCanvasManager&&null!==G_vmlCanvasManager&&G_vmlCanvasManager.initElement(o),this.ctx=o.getContext("2d"),n=$(".full_view_media>img"),r=n.attr("src"),this.canvasImg=s=new Image,s.onload=function(e){return function(){var t,i;return i=s.naturalHeight,t=n.height(),e.multiplier=i/t,e.drawCanvasImage()}}(this),s.src=r},setData:function(e){var t,i,n,o,s,r,l,a;return o=e.currentTarget,t=$(o),a=this.fmvStage.clientWidth,s=this.fmvStage.clientHeight,i=(this.tag_x+.5*this.tag_dimension)/a*100,n=(this.tag_y+.5*this.tag_dimension)/s*100,l=this.tag_dimension/a*100,r=this.tag_dimension/s*100,t.data({center_x:i,center_y:n,height:r,width:l,momentUid:this.model.id})},isResizing:function(e){return this.notResizing=!1,this.startX=e.clientX,this.startY=e.clientY,$(window).on("mousemove",this.resizeTag).on("mouseup",this.mouseUpResize),this.resizeTag(e),this.startResizeAnimation()},resizeTag:function(e){var t,i,n;return this.currentX=e.clientX,this.currentY=e.clientY,i=this.currentX-this.startX,n=this.currentY-this.startY,t=Math.max(i,n),this.newDim=Math.max(this.tag_dimension+2*t,50),this.newDim=Math.min(this.newDim,this.stage_h-30,this.stage_w-30),this.l=this.tag_x-(this.newDim-this.tag_dimension)/2,this.t=this.tag_y-(this.newDim-this.tag_dimension)/2,this.l=Math.max(this.l,0),this.t=Math.max(this.t,0),this.l+this.newDim>this.stage_w&&(this.l=this.stage_w-this.newDim),this.t+this.newDim>this.stage_h?this.t=this.stage_h-this.newDim:void 0},startResizeAnimation:function(){var e,t,i;return this.resizeTagFrame=requestAnimationFrame(this.startResizeAnimation),this.newFaceTagHandle.style.top=this.newDim+"px",this.newFaceTagHandle.style.left=this.newDim+"px",this.newFaceTag.style.width=this.newDim+"px",this.newFaceTag.style.height=this.newDim+"px",this.newFaceTag.style.left=this.l+"px",this.newFaceTag.style.top=this.t+"px",t=this.l*this.multiplier,i=this.t*this.multiplier,e=this.newDim*this.multiplier,this.ctx.drawImage(this.canvasImg,t,i,e,e,0,0,27,27)},mouseUpResize:function(){var e,t;return cancelAnimationFrame(this.resizeTagFrame),$(window).off("mousemove",this.resizeTag).off("mouseup",this.mouseUpResize),this.newFaceTagView.focusInput(),e=$(this.newFaceTag),this.tag_dimension=this.newDim,t=e.position(),this.tag_x=t.left,this.tag_y=t.top,this.setTooltipPosition(),this.newFaceTooltip.style.left=this.position_x+"px",_.defer(function(e){return function(){return e.notResizing=!0}}(this)),!1}}),ThisLife.View.FMVTagFacesView=e}.call(this),function(){var e;e=0,define("ThisLife.View.FaceTag",["ThisLife.People.Controllers.Merge"],function(e){var t,i;return t=Backbone.View.extend({initialize:function(e){return this.options=null!=e?e:{},this.setVariables(this.options).setCoords(this.options).bindFaceEvents()},events:{"focus input":"shorthand","click .face_tag_submit":"submit"},setVariables:function(e){return this.face=e.face,this.moment=e.moment,this.parentPubSub=e.parentPubSub,this.faces=this.moment.get("faces"),this},bindFaceEvents:function(){return this.face?(this.face.on("showCoords",this.showCoords,this).on("change:tag",this.onChangeTag,this),this):this},onChangeTag:function(){return this.el.className=this.className,this.rerender()},showCoords:function(e){var t;return t=e?"add":"remove",this.el.classList[t]("show"),this},removeIfIsNew:function(){return this.isNew?this.remove():void 0},blurInput:function(){return this.blurEvent=!1},removeShorthand:function(){var e,t;return e=this.el.querySelector("input"),e&&null!=(t=e.shorthand)?t.hide():void 0},addBlurEvent:function(){return this.blurEvent||ThisLife.blurEvent(this.$el,_.bind(this.blurInput,this)),this.blurEvent=!0},shorthand:function(e){var t,n,o;return this.addBlurEvent(),o=_.bind(this.remove,this),t=e.currentTarget,t.shorthand?void 0:(n={source:ThisLife.Service.api.combineContacts().toJSON(),value:"name",parent:this.$(".full_view_face_tooltip"),num:-1,"class":"dark_suggestions",removeOnBlur:!this.existing,sorted:!1,template:i,blur:function(e){return 27===e.keyCode?this.removeOnBlur&&!this.shown?o():this.hide():void 0},selectCallback:_.bind(this.onEnter,this)},$(t).shorthand(n))},showSaving:function(){var e;return null!=(e=this.el.querySelector(".face_tag_submit"))&&(e.innerHTML='<em class="saving"></em>'),this.saving=!0},removeSaving:function(){var e;return null!=(e=this.el.querySelector(".face_tag_submit"))&&(e.innerHTML="Save"),this.saving=!1},submit:function(){var e;return e=$(this.el.querySelector("input")),this.onEnter(e)},onEnter:function(e){var t,i,n,o,s,r,l,a,u,c,d;return d=e.val().trim(),!this.saving&&d?(n=e.data(),a={name:d},n.uid&&(a.person_tag_uid=n.uid),a.face=(null!=(u=this.face)?u.id:void 0)||{_explicitType:"Face",moment_uid:n.momentUid,center_x:n.center_x,center_y:n.center_y,height:n.height,width:n.width},a.momentId=this.moment.id,a.existing=this.existing?!0:!1,c=this.face?this.face.get("unnamedTag"):null,null!=c?(a.uid=null==a.person_tag_uid?c.id:void 0,o=c.id):o=a.person_tag_uid,l=a.name,r=ThisLife.Collection.personTags.get(o),t=ThisLife.Collection.personTags.findName(l),s=l&&""!==l&&!t,s?(ThisLife.app.controller("tracking").logSearchPeopleTagSaved(),this.idExistsInFilters(o)&&(ThisLife.app.controller("visual_search").updateSelectedFilter(o,{title:l}),this.removeBanner(o)),i=_.bind(this.savePersonCallback,this),ThisLife.Collection.personTags.newFace(a,i)):(t&&r.id!==t.id&&"unnamed"===r.get("name")&&(ThisLife.app.controller("tracking").logSearchPeopleTagSaved(),this.mergeTags(r,ThisLife.Collection.personTags.get(t.id),a)),t&&r.id===t.id&&(i=_.bind(this.savePersonCallback,this),ThisLife.Collection.personTags.newFace(a,i))),this.showSaving(),this.isNew=!1):void 0},mergeTags:function(t,i,n){var o,s,r;return o=function(e){return function(){return e.removeSaving()}}(this),r=function(e){return function(){var o;return e.idExistsInFilters(t.id)&&(ThisLife.app.controller("visual_search").mergeFilters(t,i),e.removeBanner(t.id)),o=_.bind(e.savePersonCallback,e),ThisLife.Collection.personTags.newFace(n,o)}}(this),s=new e,s.renderView({source:t,dest:i,cancelCallback:o,successCallback:r})},savePersonCallback:function(e){var t;return this.saving=!1,t=_.isArray(e)?e[0]:e,this.faces.updateOrAdd(t,{parse:!0}),this.parentPubSub.trigger("tagPeopleCreated"),this.face||this.remove(),this},remove:function(){var e;return null!=(e=this.face)&&e.off(null,null,this),this.$el.remove(),this},idExistsInFilters:function(e){var t,i;return i=function(){var e,i,n,o;for(n=ThisLife.app.controller("visual_search").search.getSelectedFilters(),o=[],e=0,i=n.length;i>e;e++)t=n[e],o.push(t.id);return o}(),i.includes(e)},removeBanner:function(e){return ThisLife.PubSub.trigger("banner:remove",e)}}),i='<% var uid = uid || ""; var default_face_url = default_face_url || "/assets/people/defaultPerson.png" %>\n  <li data-facebook-uid="<%= facebook_uid %>" data-uid="<%= uid %>" class="item">\n  <img src="<%= default_face_url %>" class="avatar" />\n  <a class="name"></a>\n</li>',t}),ThisLife.View.FaceTag=require("ThisLife.View.FaceTag")}.call(this),function(){var e;ThisLife.View.NewFaceTag=ThisLife.View.FaceTag.extend({className:"full_view_face_tag shorthand new_face_tag show tagging",isNew:!0,setCoords:function(e){return this.el.classList.add("tag_position_"+e.positionY),this.el.style.cssText="left: "+e.tagX+"px;top: "+e.tagY+"px;height: "+e.dimension+"px;width: "+e.dimension+"px;opacity: 1;",this},render:function(){return this.el.insertAdjacentHTML("afterbegin",e),this.focusInput(),this},focusInput:function(){return _.delay(function(e){return function(){var t;return e.$el.click(),t=e.el.querySelector("input"),null!=t?t.focus():void 0}}(this),100),this}}),e='<div class="outline"></div>\n<div class="full_view_face_tooltip_wrap">\n  <div class="full_view_face_tooltip_center">\n    <div class="full_view_face_tooltip">\n      <div class="full_view_item">\n        <div class=\'face_avatar\'>\n          <canvas width="26" height="26"></canvas>\n        </div>\n        <input type=\'text\' class=\'shorthand_input\' placeholder=\'Who is this?\' />\n        <a class=\'full_view_btn face_tag_submit\'>Save</a>\n      </div>\n    </div>\n  </div>\n</div>\n<div class="handle"></div>'}.call(this),function(){var e,t,i,n,o,s,r,l;t=0,o=20,i=480,n=100,e=1.1,ThisLife.View.ExistingFaceTag=ThisLife.View.FaceTag.extend({className:"full_view_face_tag",existing:!0,isNew:!1,events:_.extend({click:"identifyFace","click .remove":"removeFaceTag",mouseleave:"onMouseLeave",mouseenter:"onMouseEnter"},ThisLife.View.FaceTag.prototype.events),onMouseLeave:function(){return this.tagging?void 0:this.faceTagTimeout=setTimeout(function(e){return function(){return e.faceTagTimeout=null,e.el.classList.remove("show"),e.removeShorthand()}}(this),t)},onMouseEnter:function(){return this.tagging||this.removeShorthand(),this.el.classList.add("show"),clearTimeout(this.faceTagTimeout)},removeFaceTag:function(e){var t;return e.stopPropagation(),t=this.face.get("tag"),t?(t.removeNamedFace(this.face.id),this.face.set({person_tag_uid:null,tag:null})):(ThisLife.Collection.personTags.deleteFaces(this.face.id),this.face.collection.remove(this.face)),this.logger=new ThisLife.Model.LogFMV(null,{action:"untagface",lifeUid:ThisLife.lifeUid}),this.logger.setMomentId(this.moment.id),this.logger.setFaceDetected(!0),this.logger.setExcludeCount(1),this.logger.log(),ThisLife.PubSub.trigger("people:requireUpdate")},identifyFace:function(){return this.face.get("tag")?void 0:(this.parentPubSub.trigger("faceTags:deleteNew"),this.tagging=!0,this.el.classList.add("tagging","show"),this.focusInput())},blurInput:function(){return this.blurEvent=!1,this.tagging?(this.tagging=!1,this.el.classList.remove("tagging","show")):void 0},setCoords:function(){var t,i,o,s,r,l,a,u,c;return c=this.face.get("width")*e,i=this.face.get("height")*e,s=null!=(l=this.options.dimensions)?l.width:void 0,o=null!=(a=this.options.dimensions)?a.height:void 0,t=s/100*c,n>t&&(t=n,c=n/s*100,i=n/o*100),r=this.face.get("center_x")-c/2,u=this.face.get("center_y")-i/2,this.el.style.cssText="left: "+r+"%;top: "+u+"%;height: "+t+"px;width: "+t+"px;",this.el.classList.add(this.face.get("center_y")<50?"tag_position_bottom":"tag_position_top"),this},resize:function(e){return this.options.dimensions=e,this.rerender()},rerender:function(){return this.$el.empty(),this.setCoords().render(),this},render:function(){return this.tagging=!1,this.face.get("tag")?this.renderExistingTag():this.renderMissingTag(),this.loadImage(),this},renderExistingTag:function(){var e,t;return this.$el.addClass("identified"),e=this.face.get("tag").get("name"),t=s(e),this.el.insertAdjacentHTML("afterbegin",t),this.el.insertAdjacentHTML("afterbegin",'<div class="outline"></div>')},renderMissingTag:function(){var e;return this.$el.addClass("unidentified shorthand"),e=r(),this.el.insertAdjacentHTML("afterbegin",e),this.el.insertAdjacentHTML("afterbegin",'<div class="outline"></div>')},getFaceUrl:function(){var e;return(null!=(e=this.face.get("tag"))?e.getDefaultFaceUrl():void 0)||ThisLife.Helper.Image.faceUrl(this.face.id)},loadImage:function(){var e;return e=new Image,e.onload=_.bind(this.imageLoadCallback,this),e.onerror=_.bind(this.imageErrorCallback,this),e.src=this.getFaceUrl()},imageLoadCallback:function(){var e;return e=this.el.querySelector(".face_avatar"),e.style.backgroundImage="url("+this.getFaceUrl()+")"},imageErrorCallback:function(){return ThisLife.log.warn("Face thumbnail did not load",this.face.id)},focusInput:function(){return _.delay(function(e){return function(){var t;return t=e.el.querySelector("input"),null!=t?t.focus():void 0}}(this),100),this}}),l=function(e){return"<div class='full_view_face_tooltip_wrap'> <div class='full_view_face_tooltip_center'> <div class='full_view_face_tooltip'> <div class='full_view_item'> "+e+" </div> </div> </div> </div>"},s=function(e){return e=ThisLife.Helper.String.escapeHtml(e),l("unnamed"!==e?"<div class='face_avatar'></div> <span class='name'>"+e+"</span> <div class='remove'> <div></div> </div>":"<div class='identify_face_input'> <div class='face_avatar'></div> <input type='text' class='shorthand_input' placeholder='Who is this?' /> <a class='full_view_btn face_tag_submit'>Save</a> </div>")},r=function(){return l("<div class='identify_face_prompt'> <span class='name'>Click to tag person</span> <div class='remove'> <div></div> </div> </div> <div class='identify_face_input'> <div class='face_avatar'></div> <input type='text' class='shorthand_input' placeholder='Who is this?' /> <a class='full_view_btn face_tag_submit'>Save</a> </div>")}}.call(this),function(){ThisLife.View.BaseView=Backbone.View.extend({className:"full_view",events:function(){return _.extend({},this.baseEvents,this.additionalEvents)},baseEvents:{"click .full_view_btn.next":"goToNextMoment","click .full_view_btn.prev":"goToPreviousMoment"},additionalEvents:{},initialize:function(e){return this.options=null!=e?e:{},_.bindAll(this,"modalKeys"),this.preloaded={},this.setup(this.options).addBindings(),this},bindKeyEvents:function(){return window.addEventListener("keydown",this.modalKeys,!1),this},unbindKeyEvents:function(){return window.removeEventListener("keydown",this.modalKeys,!1),this},modalKeys:function(e){var t;if("INPUT"!==(t=e.target.tagName)&&"TEXTAREA"!==t){switch(e.keyCode){case 37:this.goToPreviousMoment();break;case 39:this.goToNextMoment()}return this.additionalModalKeys(e)}},additionalModalKeys:function(){},focusOnMoment:function(e){return"peopleFiltered"!==ThisLife.app.currentState.name?ThisLife.app.currentState.library||ThisLife.app.currentState.filtered?ThisLife.app.library.centerOnMoment(this.model.id,e):"albums"===ThisLife.app.currentState.name&&null!=ThisLife.app.album.getCurrentAlbum()?ThisLife.app.album.centerOnMoment(this.model.id,e):void 0:void 0},goToNextMoment:function(e){var t;return t=this.getNextMoment(),this.redirectToMoment(t,e)},goToPreviousMoment:function(e){var t;return t=this.getPreviousMoment(),this.redirectToMoment(t,e)},redirectToMoment:function(e,t){return e?(this.redirectToMomentRoute(e,t),!0):!1},getRedirectOptions:function(e,t){return null==t&&(t={}),t},redirectToMomentRoute:function(e,t){return this.redirectToNewView(e,this.getRedirectOptions(e,t))},getNextMoment:function(){return this.getMoment("Next")},getPreviousMoment:function(){return this.getMoment("Previous")},getMoment:function(e){var t,i;return i="get"+e+"Moment",t=this.options.inStory?ThisLife.app.album.getCollection():this.collection,t[i](this.model.id)},renderImage:function(e,t,i){var n;return null==i&&(i=!1),i||this.getLowResImage(t),n=function(){return"function"==typeof e?e():void 0},this.getHighResImage(null,n)},getImageSource:function(e,t,i,n){return ThisLife.Helper.Image.imageUrlDim(e,t,i,n)},getLowResImage:function(){var e;return e=this.getLowResImageSource(),this.setImageSource(e),this},getLowResImageSource:function(){return this.moment.getImageSize("small")},getHighResImage:function(e,t){var i,n,o,s,r,l;return e||(o=!0,e=this.moment),l=e.id,i=this.getImageDimensions(e),n=e.get("story_moment_created_by")||ThisLife.currentLifeOwner,r=e.get("effects_modified_date"),s=this.getImageSource(l,i,r,n),s===this.currentSrc?null!=t&&t():this.preloadImage(s,{setImageSource:o,uid:l,onLoadComplete:t}),this},setPreloadedSource:function(e,t){return this.preloaded[t]=e},preloadImage:function(e,t){var i,n;return n=function(i){return function(n){return t.setImageSource?i.setImageSource(e):i.setPreloadedSource(e,t.uid),null!=t.onLoadComplete?t.onLoadComplete(n):void 0}}(this),i=new Image,i.onload=n,i.src=e},prefetchImages:function(){return this.getHighResImage(this.getNextMoment()),this.getHighResImage(this.getNextMoment())},removeBindings:function(){},remove:function(){return this.removeBindings(),this.unbindKeyEvents(),this.$el.remove()}})}.call(this),function(){var e,t,i,n,o,s,r,l,a,u;i=285,t=60,e=62,r="transitionend webkitTransitionEnd oTransitionEnd otransitionend MSTransitionEnd",o=!0,s=10,n=200,ThisLife.View.FullView=ThisLife.View.BaseView.extend({additionalEvents:{"click .btns.top_right":"close","click .full_view_btn.slideshow":"startSlideshow",mousemove:"onMousemove","click .check-wrap":"selectMoment"},setup:function(e){var t,i,n,o;return this.moment=this.options.moment,this.selection=this.options.selection||ThisLife.app.controller("selection"),this.selectionCollection=null!=(t=this.selection)?t.getCollection():void 0,this.selectionBin=this.options.selectionBin,this.tagPeopleEnabled=this.options.tagPeopleEnabled,this.slideshowActive=e.slideshowActive,this.controlsHidden=e.controlsHidden?e.controlsHidden:!1,this.lastMouse=e.lastMouse?e.lastMouse:[0,0],this.taggedPeople=0,this.collection||(this.collection=null!=(i=ThisLife.app.library)?i.getCollection():void 0),this.slideshowFade(e.fade),this.fullViewPubSub=_.extend({},Backbone.Events),this.sidebarVisible=null!=e.sidebarVisible?e.sidebarVisible:!ThisLife.appModel.getFullViewSidebarHidden(),this.sidebarEditVisible=!!e.sidebarEditVisible,this.sidebarDefaultVisible=!!e.sidebarDefaultVisible||this.sidebarVisible,(this.sidebarDefaultVisible||this.sidebarEditVisible)&&(this.sidebarVisible=!0),((null!=(n=ThisLife.Mode)?n.PublicStory:void 0)||ThisLife.app.isMobile)&&(this.sidebarVisible=this.sidebarDefaultVisible=this.sidebarEditVisible=!1),this.sidebarEditVisible&&(this.editing=!0),_.bindAll(this,"resize","stageTransitionCallback"),this.resizeFullView=_.debounce(this.resize,200),$(window).on("resize",this.resizeFullView),o=this.moment?this.moment.id:e.uid,this.model=new ThisLife.Model.FullMoment({uid:o,hidden:this.moment.get("hidden"),rating:this.moment.get("rating"),story_moment_created_by:this.moment.get("story_moment_created_by"),upload_date:this.moment.get("upload_date")}),this.model.isMine=!!ThisLife.Collection.moments.get(o),window.model=this.model,this.controlsHidden?this.hideControls():"click"!==(null!=e?e.type:void 0)&&this.mouseMoveTimer(),this.model.isMine||this.el.classList.add("read_only"),this.logger=new ThisLife.Model.LogFMV(null,{action:"tagface",lifeUid:ThisLife.lifeUid}),this.logger.setMomentId(o),this.addMobileUpdates(),this},slideshowFade:function(e){return e?(this.el.classList.add("fade_out"),_.delay(function(e){return function(){return e.el.classList.remove("fade_out")}}(this),0)):void 0},addBindings:function(){return this.fullViewPubSub.on("tagPeople",this.tagPeopleListener,this).on("slideshow:stop",this.stopSlideshow,this).on("slideshow:prev",this.goToPreviousMoment,this).on("slideshow:next",this.goToNextMoment,this).on("toggleSidebar",this.toggleSidebar,this).on("toggleEditPanel",this.toggleEditPanel,this).on("download",this.downloadMoment,this).on("addToAlbum",this.addToAlbum,this).on("removeFromStory",this.removeFromStory,this).on("delete",this.changeHidden,this).on("rotate",this.rotate,this).on("share",this.share,this).on("changeRating",this.changeRating,this).on("controls:show",this.showControls,this).on("controls:hide",this.hideControls,this).on("crop",this.cropMoment,this).on("tagPeopleCreated",this.tagCreated,this),ThisLife.PubSub.once("modal:close:fullView",this.remove,this),this.bindModelEvents(),this.bindKeyEvents(),this.bindSelection(),ThisLife.Support.keyInformant.on("cancel",this.removeOnCancel,this)},removeBindings:function(){var e;return this.fullViewPubSub.off(null,null,this),(null!=(e=ThisLife.Mode)?e.PublicStory:void 0)||this.selectionCollection.off(null,null,this),ThisLife.PubSub.off(null,null,this),$(window).off("resize",this.resizeFullView),this.unbindModelEvents(),ThisLife.Support.keyInformant.off("cancel",this.removeOnCancel,this)},bindModelEvents:function(){return this.model.on("remove",this.onRemove,this),this.moment.on("change:hidden",this.onRemove,this),this.moment.on("change:rating",this.onChangeRating,this),this},bindSelection:function(){var e;return(null!=(e=ThisLife.Mode)?e.PublicStory:void 0)||this.selectionCollection.on("add",this.select,this).on("remove",this.unselect,this),this},unbindModelEvents:function(){return this.model.off(null,null,this),this.moment.off(null,null,this)},onRemove:function(){return this.goToNextMoment()?void 0:ThisLife.app.router.back()},redirectToMoment:function(e,t){return e?(e.isVideo()&&this.sidebarEditVisible&&this.removeEditSidebar(),(null!=t?t.fade:void 0)?(this.el.classList.add("fade_out"),this.fadeTimer=setTimeout(function(i){return function(){return i.redirectToMomentRoute(e,t)}}(this),n),!0):(this.redirectToMomentRoute(e,t),!0)):!1},getRedirectOptions:function(e,t){return null==t&&(t={}),_.extend(t,{moment:e,sidebarVisible:this.sidebarVisible,sidebarEditVisible:this.sidebarEditVisible,tagPeopleEnabled:"video"===e.get("moment_type")?!1:this.tagPeopleEnabled,inStory:this.options.inStory,slideshowActive:this.slideshowActive,collection:this.collection,src:this.preloaded[e.id],controlsHidden:this.controlsHidden,lastMouse:this.lastMouse,selectionBin:this.selectionBin,selection:this.selection})},getNextMoment:function(){var e,t;return e=this.model.id,ThisLife.app.currentState.library?(t={},ThisLife.app.controller("selection").isActive()&&this.selectionBin&&(t.selected=!0),this.collection.getModel(ThisLife.app.controller("visual_search").searchResultsHidden()?ThisLife.app.controller("timeline").getNextObject(e,t):ThisLife.app.controller("visual_search").getNextObject(e,t))):this._getNextMoment(e)},_getNextMoment:function(e){var t;return t=this.options.inStory&&!this.selectionBin?ThisLife.app.album.getCollection().get(ThisLife.app.album.getNextMoment(e)):this.collection.getNextMoment(e),"video"===(null!=t?t.get("moment_type"):void 0)&&this.slideshowActive&&(t=this._getNextMoment(t.id)),t},getPreviousMoment:function(){var e,t;return e=this.model.id,ThisLife.app.currentState.library?(t={},ThisLife.app.controller("selection").isActive()&&this.selectionBin&&(t.selected=!0),this.collection.getModel(ThisLife.app.controller("visual_search").searchResultsHidden()?ThisLife.app.controller("timeline").getPreviousObject(e,t):ThisLife.app.controller("visual_search").getPreviousObject(e,t))):this._getPreviousMoment(e)},_getPreviousMoment:function(e){var t;return t=this.options.inStory&&!this.selectionBin?ThisLife.app.album.getCollection().get(ThisLife.app.album.getPreviousMoment(e)):this.collection.getPreviousMoment(e),"video"===(null!=t?t.get("moment_type"):void 0)&&this.slideshowActive&&(t=this._getPreviousMoment(t.id)),t},navigate:function(e,t){return this.options.inStory?ThisLife.app.router.navigateToStoryFullView(ThisLife.storyUid,e.id,t):ThisLife.app.router.navigateToFullView(e.id,t)},redirectToNewView:function(e,t){return this.removing=!0,this.navigate(e,{replace:!0}),ThisLife.app.showModal("fullView",t,!0)},selectMoment:function(){var e,t;return this.checkbox.classList.toggle("selected"),this.options.inStory?null!=(e=this.selection)?e.toggleModels(this.moment,{storyUid:ThisLife.storyUid}):void 0:null!=(t=this.selection)?t.toggleModels(this.moment):void 0},onMousemove:function(e){return this.didMouseMove(e)?((e.target.classList.contains("full_view")||$(e.target).closest(this.fullViewStage).length>0)&&this.showControls(),clearTimeout(this.timer),!this.tagPeopleView&&e.target.classList.contains("full_view")||!this.tagPeopleView&&$(e.target).closest(this.fullViewStage).length>0?this.mouseMoveTimer():void 0):void 0},didMouseMove:function(e){var t;return t=e.clientX!==this.lastMouse[0]||e.clientY!==this.lastMouse[1]?!0:!1,this.lastMouse=[e.clientX,e.clientY],t},mouseMoveTimer:function(){return this.timer=setTimeout(function(e){return function(){return e.fullViewPubSub.trigger("controls:hide")}}(this),2e3)},showControls:function(){return this.controlsHidden?(this.controlsHidden=!1,this.el.classList.remove("hide_controls")):void 0},hideControls:function(){return this.sidebarVisible?void 0:(this.controlsHidden=!0,this.el.classList.add("hide_controls"))},_addFetchingState:function(){return this.el.classList.add("fetching")},_removeFetchingState:function(){return this.el.classList.remove("fetching")},resize:function(e){return this.dimensions=this.getImageDimensions(this.moment),this.setStageStyles(),this.sidebarVisible&&$(this.fullViewSidebarScroll).perfectScrollbar("update"),e?this.renderImage():this.getHighResImage(),this.videoView?this.videoView.resize(this.dimensions):void 0},additionalModalKeys:function(e){switch(e.keyCode){case 32:if("video"!==this.moment.get("moment_type"))return this.startSlideshow();break;case 73:if(!e.metaKey&&!e.shiftKey)return this.toggleSidebar();break;case 69:if(!e.metaKey&&!e.shiftKey)return this.toggleEditPanel()}},removeOnCancel:function(){return this.slideshowActive?ThisLife.Support.keyInformant.on("cancel",this.removeOnCancel,this):this.close()},prepareStageTransition:function(){var t,n,o,s,r;return this.dimensions=this.getImageDimensions(this.moment,!1,!1),this.editing?(o=this.dimensions.sidebarScaleEdit,t=0):(o=this.dimensions.sidebarScale,t=e),n=this.dimensions.left-i/2,s=this.dimensions.top-t/2,r=ThisLife.Helper.CSS.browserPrefix("transform",ThisLife.Helper.CSS.resolveTranslate(n,s,0,o)),this.fullViewStage.style.cssText="width: "+this.dimensions.width+"px; height: "+this.dimensions.height+"px; "+r},stageTransitionCallback:function(){var e,t,i;if(this.fullViewStage.classList.remove("transition"),this.sidebarVisible){if("video"===this.moment.get("moment_type"))return;this.dimensions=this.getImageDimensions(this.moment,!0),i=ThisLife.Helper.CSS.browserPrefix("transform",ThisLife.Helper.CSS.resolveTranslate(this.dimensions.left,this.dimensions.top,0,1)),this.fullViewStage.style.cssText="width: "+this.dimensions.width+"px; height: "+this.dimensions.height+"px; "+i}else this.el.classList.remove("edit"),null!=(e=this.fullViewSidebarView)&&e.teardown(),this.fullViewSidebarView=null,null!=(t=this.fullViewSidebarEditView)&&t.teardown(),this.fullViewSidebarEditView=null;return this.renderImage(null,null,!0)},toggleSidebar:function(){return this.sidebarVisible?this.removeSidebar():this.showSidebar(),this.transitionSidebar()},toggleEditPanel:function(){return this.sidebarEditVisible?this.sidebarDefaultVisible?this.removeEditSidebar():(this.removeSidebar(),this.transitionSidebar()):(this.showEditSidebar(),this.transitionSidebar())},transitionSidebar:function(e){return null==e&&(e=this.sidebarVisible),_.delay(function(t){return function(){return t.fullViewStage.classList.add("transition"),t.setStageStyles(e)
}}(this),0)},removeSidebar:function(){var e;return this.prepareStageTransition(),this.editing=!1,this.el.classList.remove("sidebar_visible"),null!=(e=this.el.querySelector(".full_view_btn.info"))&&e.classList.remove("orange"),this.sidebarVisible=this.sidebarEditVisible=this.sidebarDefaultVisible=!1,ThisLife.appModel.setFullViewSidebarHidden(!0)},removeEditSidebar:function(){return this.el.classList.remove("edit"),this.editing=this.sidebarEditVisible=!1,this.prepareStageTransition()},applyFilter:function(){var e,t,i;return this.removePeopleView(),e=function(t){return function(){return t.showEditError(e)}}(this),i=function(e){return function(i){return e.editingImage(!1),e.addPeopleView(),e.model.momentCropped(i),e.fullViewMediaImg.src="/assets/1px.gif",ThisLife.app.library.filterMoment(e.model.get("uid"),i),ThisLife.app.album.filterMoment(t,e.model.get("uid"),i),e.resize(!0)}}(this),t=this.options.inStory?ThisLife.storyUid:null,ThisLife.Service.api.getFullMomentSet(this.model,t,i,e)},showEditSidebar:function(){return this.dimensions=this.getImageDimensions(this.moment,!1,!0),this.fullViewSidebarEditView||(this.fullViewSidebarEditView=new ThisLife.View.FullViewEditPanel({model:this.model,parentPubSub:this.fullViewPubSub,parentView:this}),this.fullViewSidebar.appendChild(this.fullViewSidebarEditView.el)),this.model.on("filter",this.applyFilter,this),this.el.classList.add("sidebar_visible"),this.el.classList.add("edit"),this.showControls(),this.sidebarVisible=!0,this.sidebarEditVisible=!0,ThisLife.appModel.setFullViewSidebarHidden(!1),this.editing=!0,ThisLife.app.controller("tracking").logClickFMVEdit()},showSidebar:function(){var e;return this.fullViewSidebarView||(this.fullViewSidebarView=new ThisLife.View.FullViewSidebar({model:this.model,tagPeopleEnabled:this.tagPeopleEnabled,parentPubSub:this.fullViewPubSub}),this.fullViewSidebar.appendChild(this.fullViewSidebarView.el)),this.el.classList.add("sidebar_visible"),this.showControls(),null!=(e=this.el.querySelector(".full_view_btn.info"))&&e.classList.add("orange"),this.sidebarVisible=!0,this.sidebarDefaultVisible=!0,ThisLife.appModel.setFullViewSidebarHidden(!1)},setStageStyles:function(t){var n,o,s,r,l;return!t&&this.editing?(s=1,o=this.dimensions.left,r=(ThisLife.Helper.DOM.windowHeight-this.dimensions.height)/2):t?(this.editing?(s=this.dimensions.sidebarScaleEdit,n=0):(s=this.dimensions.sidebarScale,n=e),o=this.dimensions.left-i/2,r=(ThisLife.Helper.DOM.windowHeight-this.dimensions.height-n)/2):(s=1,o=this.dimensions.left,r=this.dimensions.top),l=u({left:o,top:r,width:this.dimensions.width,height:this.dimensions.height},this.model.isVideo(),s),this.fullViewStage.style.cssText="width: "+this.dimensions.width+"px; height: "+this.dimensions.height+"px; "+l},cacheElements:function(){return this.fullViewMedia=this.el.querySelector(".full_view_media"),this.fullViewMediaImg=this.el.querySelector(".full_view_media img"),this.fullViewStage=this.el.querySelector(".full_view_stage"),this.fullViewSidebar=this.el.querySelector(".full_view_sidebar"),this.fullViewSidebarScroll=this.el.querySelector(".full_view_sidebar_scroll"),this.fullViewBottomBar=this.el.querySelector(".full_view_bottom_bar"),this.faceTagger=this.el.querySelector(".face_tagger"),this.checkbox=this.el.querySelector(".check-wrap")},prefetchImages:function(){return this.getHighResImage(this.getNextMoment()),this.slideshowActive?void 0:this.getHighResImage(this.getPreviousMoment())},addMobileUpdates:function(){return ThisLife.Helper.Platform.mobile()?$(this.checkbox).addClass("mobile"):void 0},setImageSource:function(e){var t;return t=function(e){return function(){return e._removeFetchingState()}}(this),_.delay(function(e){return function(){return e._addFetchingState()}}(this),0),$(this.fullViewMediaImg).on("load",t),this.currentSrc=e,this.fullViewMediaImg.src=e},getImageDimensions:function(e,t,i){return null==t&&(t=this.sidebarVisible),null==i&&(i=this.editing),a({width:e.get("width"),height:e.get("height"),isVideo:e.isVideo(),sidebarVisible:t,editing:i})},render:function(){var e,t,i;return this.dimensions=this.getImageDimensions(this.moment,this.sidebarVisible),i=l(this.dimensions,this.moment.isVideo()),this.$el.html(i),this.slideshowActive?this.startSlideshow():this.delegateEvents(),this.cacheElements(),(null!=(e=this.selection)?e.isMomentSelected(this.moment):void 0)&&this.select(),this.renderImage(),this.prefetchImages(),this.addBottomBarView(),ThisLife.Helper.DOM.addEventListener(this.fullViewStage,"transitionend",this.stageTransitionCallback),(null!=(t=ThisLife.Mode)?t.PublicStory:void 0)?this.getMomentSetCallback(this.moment):this.getFullMomentSet(),this.sidebarDefaultVisible&&this.showSidebar(),this.sidebarEditVisible&&this.showEditSidebar(),(this.sidebarEditVisible||this.sidebarDefaultVisible)&&this.setStageStyles(!1),this.tagPeopleEnabled&&this.addTagPeopleView(this.tagPeopleEnabled),this.addHoverTooltips(),this.fullViewPubSub.trigger("slideshow:momentChanged",this.moment.get("moment_type")),ThisLife.Support.keyInformant.setupForCurrentView(),this},select:function(){return this.checkbox.classList.add("selected")},unselect:function(e){var t;return t=_.find(e,function(e){return function(t){return t.id===e.model.id}}(this)),t?this.checkbox.classList.remove("selected"):void 0},addHoverTooltips:function(){return this.slideshowHoverTooltip=new ThisLife.View.HoverTooltip({el:this.el.querySelector(".slideshow"),wrapSelector:".full_view_hover_tooltip_wrap",onCanShow:_.bind(this.canShowHoverTooltip,this),showClassName:"visible"})},canShowHoverTooltip:function(){return this.slideshowActive?!1:null!=this.bottomBarView?!this.bottomBarView.isTooltipActive():!0},removeHoverTooltips:function(){var e;return null!=(e=this.slideshowHoverTooltip)&&e.teardown(),this.slideshowHoverTooltip=null},addVideoView:function(e){var t;return t=this.moment.get("story_moment_created_by")||ThisLife.currentLifeOwner,this.videoView=new ThisLife.View.FullView.Video({el:this.fullViewMedia,model:e,dimensions:this.dimensions,ownerUid:t,parentPubSub:this.fullViewPubSub,autoplay:this.slideshowActive}),_.defer(function(){return afterglow.initVideoElements()}),this},addBottomBarView:function(){return this.bottomBarView=new ThisLife.View.FullView.BottomBar({el:this.fullViewBottomBar,parentView:this,model:this.model,moment:this.moment,parentPubSub:this.fullViewPubSub,tagPeopleEnabled:this.tagPeopleEnabled,sidebarVisible:this.sidebarVisible,inStory:this.options.inStory,tooltipActive:this.tooltipActive})},editingImage:function(e){var t,i,n;return null==e&&(e=!0),ThisLife.Helper.DOM.addRemoveClass(this.el,e,"loading"),null!=(t=this.bottomBarView)&&t.editingImage(e),null!=(i=this.fullViewSidebarView)&&i.editingImage(e),null!=(n=this.fullViewSidebarEditView)?n.editingImage(e):void 0},downloadMoment:function(){var e,t;if(ThisLife.Helper.Platform.mobile()&&"video"===this.moment.get("moment_type"))return alert("Please download from desktop browser");t=this.options.inStory?ThisLife.storyUid:null;try{return ThisLife.app.session.getSessionToken().then(function(e){return function(i){return window.location=ThisLife.Service.api.downloadMomentUrl(e.model.id,t,i)}}(this))}catch(i){if(e=i,"Unspecified error."!==e.message)throw e}},cropMoment:function(){var e,t,i,n,o;return this.unbindKeyEvents(),o=function(e){return function(){return e.removeFaceViews(),e.removePeopleView(),e.editingImage()}}(this),n=function(e){return function(){return e.editingImage(!1)}}(this),e=function(e){return function(){return t.off(null,null,e),e.fullViewPubSub.trigger("doneLoading"),e.bindKeyEvents()}}(this),i=function(e){return function(){var t,i,o;return t=function(){return e.showEditError(n)},o=function(t){return e.editingImage(!1),e.addPeopleView(),e.model.momentCropped(t),e.fullViewMediaImg.src="/assets/1px.gif",ThisLife.app.library.cropMoment(e.model.get("uid"),t),ThisLife.app.album.cropMoment(i,e.model.get("uid"),t),e.resize(!0)},i=e.options.inStory?ThisLife.storyUid:null,ThisLife.Service.api.getFullMomentSet(e.model,i,o,t)}}(this),t=new ThisLife.View.FullView.Crop({moment:this.moment}),t.once("start",o,this),t.once("error",n,this),t.once("close",e,this),t.once("cropped",i,this),this.fullViewPubSub.trigger("loading"),document.body.appendChild(t.el)},showEditError:function(e){var t;return t=new ThisLife.View.Error({onClose:e}),t.show()},deleteMoment:function(){var e;return e=new ThisLife.View.ModalAlert({template:"deleteMomentView",item:!0,callback:function(e){return function(){var t,i;return e.model.trigger("remove",e.model),t=ThisLife.Collection.moments.get(e.model.id),e.selection.removeModels([t]),ThisLife.Service.api.deleteMoments([e.model.id]),ThisLife.Collection.moments.deleteMoment(t),ThisLife.app.library.getCollection().remove(e.model.id),null!=(i=ThisLife.app.album.getCollection())&&i.remove(e.model.id),ThisLife.PubSub.trigger("people:requireUpdate"),ThisLife.PubSub.trigger("explore:setRefreshHome")}}(this)}),document.body.appendChild(e.render().el)},addToAlbum:function(){var e,t;return e=new ThisLife.Collection.FMVCollection(this.model),t=new ThisLife.View.ActionBarModal({collection:e,fmv:!0,type:"timeline_add",share:!0}),document.body.appendChild(t.render().el),t.modalFocus()},removeFromStory:function(){var e;return e=new ThisLife.View.ModalAlert({template:"removeFromStory",item:!0,callback:function(e){return function(){var t;return e.model.trigger("remove",e.model),ThisLife.Service.api.deleteStoryMoments(ThisLife.storyUid,[e.model.id]),ThisLife.app.album.removeMoments(ThisLife.storyUid,[e.model.id]),t=e.selectionCollection.hasMoment(e.model),t?e.selection.removeModels([t]):void 0}}(this)}),document.body.appendChild(e.render().el)},tagPeopleListener:function(e){return e?this.addTagPeopleView():this.removeTagPeopleView()},addTagPeopleView:function(){return this.tagPeopleView||(this.tagPeopleEnabled=!0,this.tagPeopleView=new ThisLife.View.FMVTagFacesView({el:this.el,model:this.model,parentPubSub:this.fullViewPubSub})),this},removeTagPeopleView:function(){var e;return this.tagPeopleView?(this.tagPeopleEnabled=!1,null!=(e=this.tagPeopleView)&&e.teardown(),this.tagPeopleView=null):void 0},tagCreated:function(){return this.taggedPeople+=1},rotate:function(e){var t,i;return i=function(t){return function(){var i,n;return t.editingImage(!1),null!=(n=t.model.get("faces"))&&n.reset(),t.model.momentRotated(e),t.fullViewMediaImg.src="/assets/1px.gif",i=t.model.get("uid"),ThisLife.app.library.rotateMoments([i],e),ThisLife.app.album.rotateMoments([i],e),t.resize(!0)}}(this),t=function(e){return function(){return e.showEditError(function(){return e.editingImage(!1)})}}(this),this.editingImage(),this.removeFaceViews(),ThisLife.Service.api.rotateMoment(this.model.id,e).then(i,t)},share:function(e){var t,i,n,o,s;return this.unbindKeyEvents(),i=new ThisLife.Collection.FMVCollection(this.model),i.once("fmv:closeShare",this.bindKeyEvents,this),o=function(){return function(){return i.trigger("fmv:closeShare",i)}}(this),"share_sites"===e?(n=new ThisLife.View.PostToShareSites({collection:i,fmv:!0}),document.body.appendChild(n.render().el)):"email"===e?(t={fmv:!0,fmvModel:this.model,collection:i},s={width:"450",fullPagePoint:"smallScreen",title:"Share via email",childView:new ThisLife.View.actionBar.email(t),onRemove:o,buttons:[{type:"orange_button",onclick:this.shareMail,text:"SHARE WITH",subtext:0}]},ThisLife.app.controller("appmodal").get("emailShare").renderView(s).disableButton("orange_button")):"facebook"===e?FB.ui({method:"share",href:this.moment.getImage("large")}):(n=new ThisLife.View.ActionBarModal({collection:i,fmv:!0,type:e,share:!0}),document.body.appendChild(n.render().el),n.modalFocus())},shareMail:function(){return ThisLife.PubSub.trigger("actionBar:share")},changeHidden:function(){var e,t;return e=this.selectionCollection.hasMoment(this.model),e&&this.selection.removeModels([e]),ThisLife.app.controller("trash")["delete"]([this.moment.get("uid")],!0),t=new ThisLife.View.ModalAlert,document.body.appendChild(t.renderLoadingTemplate().el),t.spinnerActive=!1,t.changeInnerHTML.call(t,"hideMoment",{data:[this.moment.get("moment_type")]}),_.delay(function(){return t.teardown()},ThisLife.View.ModalAlert.CONFIRMATION_DELAY),ThisLife.app.controller("tracking").logClickFMVDelete()},changeRating:function(e){return this.moment.set("rating",e),this.model.changeRating(e)},onChangeRating:function(){},getFullMomentSet:function(){var e;return e=this.options.inStory?ThisLife.storyUid:null,ThisLife.Service.api.getFullMomentSet(this.model,e,_.bind(this.getMomentSetCallback,this),function(e){return function(){return _.bind(e.getMomentSetErrorCallback,e)}}(this))},getMomentSetCallback:function(e){return e.loaded=!0,this.fullViewPubSub.trigger("model:updated"),e.isMine&&(this.removePeopleView(),ThisLife.Collection.personTags.whenLoaded(this.addPeopleView,this)),"video"===e.get("moment_type")?this.addVideoView(e):void 0},getMomentSetErrorCallback:function(){return this.slideshowActive?this.fullViewPubSub.trigger("slideshow:stop"):void 0},addPeopleView:function(){return this.peopleView=new ThisLife.View.FullView.PeopleView({model:this.model,el:this.fullViewStage,dimensions:this.dimensions,parentPubSub:this.fullViewPubSub}),this},removePeopleView:function(){var e;return null!=(e=this.peopleView)&&e.remove(),this},removeFaceViews:function(){var e;return null!=(e=this.peopleView)&&e.removeFaceViews(),this},close:function(){var e,t;if(!this._fullScreenVideoPlaying())return e=ThisLife.app.currentState,e.albums&&"albums"===e.name&&!e.previous?(t="appalbum",ThisLife.app.controller("tracking").logPageEvent(t,null,e),ThisLife.app.router.navigateToAlbums(),!0):e.library&&"library"===e.name?(t="applibrary",ThisLife.app.controller("tracking").logPageEvent(t,null,e),ThisLife.app.router.navigateToLibrary(),!0):"fullview"===e.name?(t="appstory",ThisLife.app.controller("tracking").logPageEvent(t,null,e),ThisLife.app.router.navigateToStory(),!0):(ThisLife.app.router.back(),setTimeout(function(){return ThisLife.PubSub.trigger("explore:refreshHome")},100))},startSlideshow:function(){return this.tagPeopleView?void 0:(this.fullViewPubSub.trigger("slideshow:started"),this.unbindKeyEvents(),this.undelegateEvents(),this.slideshowActive=!0,this.sidebarVisible&&(this.removeSidebar(),this.transitionSidebar()),this.slideshowView?this.slideshowView.start(this.moment.get("moment_type")):this.slideshowView=new ThisLife.View.FullView.Slideshow({el:this.el,parentPubSub:this.fullViewPubSub,type:this.moment.get("moment_type")}),this)},stopSlideshow:function(e){return e||(this.delegateEvents(),this.bindKeyEvents()),this.slideshowActive?(clearTimeout(this.fadeTimer),this.el.classList.remove("fade_out"),this.slideshowView.teardown(),this.slideshowActive=!1,this.showControls()):void 0},removeVideoView:function(){var e;return this.videoView?(null!=(e=this.videoView)&&e.remove(),this.videoView=null):void 0},remove:function(){var e,t,i,n,o;if("video"===model.get("moment_type")){if(o=afterglow.getPlayer("video-"+model.id),null!=o?o.isFullscreen():void 0)return void o.exitFullscreen();this.removeVideoView()}return this.stopSlideshow(!0),this.removeTagPeopleView(),this.removePeopleView(),this.removeHoverTooltips(),null!=(e=this.fullViewSidebarView)&&e.teardown(),null!=(t=this.fullViewSidebarEditView)&&t.teardown(),null!=(i=this.bottomBarView)&&i.teardown(),"fullView"!==(null!=(n=ThisLife.app.currentModal)?n.name:void 0)&&this.focusOnMoment(!0),ThisLife.View.BaseView.prototype.remove.call(this),document.body.classList.remove("fmv"),$("body>.black_tooltip").remove(),this.taggedPeople>0&&ThisLife.PubSub.trigger("updatePeopleCounts"),this.$el.remove(),this},_fullScreenVideoPlaying:function(){var e;return"video"===this.model.get("moment_type")&&(e=afterglow.getPlayer("video-"+this.model.id),null!=e?e.isFullscreen():void 0)?!0:!1}}),u=function(e,t,i){return null==i&&(i=1),t&&ThisLife.Helper.Platform.safari()&&ThisLife.FullViewHelper.isVideoSmallerThanAnyMinimum(e.width,e.height)?"left:"+e.left+"px;top:"+e.top+"px;":ThisLife.Helper.CSS.browserPrefix("transform",ThisLife.Helper.CSS.resolveTranslate(e.left,e.top,0,i))},a=function(n){var r,l,a,u,c,d,h,p,f,m,g,v,_,b,w,y;return null==n&&(n={}),d=n.sidebarVisible?ThisLife.Helper.DOM.windowWidth-i:ThisLife.Helper.DOM.windowWidth,a=n.editing?0:e,c=n.sidebarVisible?ThisLife.Helper.DOM.windowHeight-a:ThisLife.Helper.DOM.windowHeight,d=d,c=c,n.isVideo&&(d-=2*t,c=ThisLife.Helper.DOM.windowHeight-a),u=d/c,v=n.width/n.height,n.editing&&(n.width>720||n.height>720)?v>1?(p=720,f=p*v):(f=720,p=f/v):(f=n.width,p=n.height),w=o&&!n.sidebarVisible&&Math.abs(v-u)<s/100?!0:!1,!w&&u>v||w&&v>u?(p=Math.min(p,c),f=p*v):(f=Math.min(f,d),p=f/v),n.isVideo&&(y=ThisLife.FullViewHelper.videoDimensions({width:f,height:p}),p=y.height,f=y.width),r=(ThisLife.Helper.DOM.windowWidth-i)/(ThisLife.Helper.DOM.windowHeight-a),l=(ThisLife.Helper.DOM.windowWidth-i)/ThisLife.Helper.DOM.windowHeight,r>v?p+a>c&&(_=(c-a)/p):f+i>d&&(_=(d-i)/f),b=l>v?c/p:(d-i)/f,v>1?(m=720,g=m*v):(g=720,m=g/v),(f*b>g||p*b>m)&&(b=l>v?m/p:g/f,b=Math.min(1,b)),h={width:f,height:p,left:Math.round((d-f)/2),top:Math.round((c-p)/2),sidebarScale:_||1,sidebarScaleEdit:b||1},n.isVideo&&(h.left+=t),h},l=function(e,t){var i,n,o,s,r;return i=(null!=(o=ThisLife.Mode)?o.PublicStory:void 0)?"display: none;":"",n=(null!=(s=ThisLife.Mode)?s.PublicStory:void 0)?"public_story":"",r=u(e,t),'<div class="full_view_stage" style="width: '+e.width+"px; height: "+e.height+"px; "+r+'">\n  <div class="full_view_media">\n    <img draggable="false" />\n    <!-- or video player goes here -->\n    <div class="fullview-spinner"></div>\n  </div>\n  <!-- face stuff -->\n</div>\n<div class="action_btns">\n  <div class="check-wrap large" style="'+i+'">\n    <div class="checkmark">\n    </div>\n  </div>\n</div>\n<div class=\'full_view_sidebar\'>\n</div>\n<div class="full_view_bottom_bar '+n+'"></div>\n<div class="btns bottom_center">\n  <div class="full_view_btn slideshow">\n    <div class="full_view_hover_tooltip_wrap">\n      <div class="full_view_tooltip">\n      Play slideshow\n      </div>\n    </div>\n    <div class="icon"></div>\n      <span>Slideshow</span>\n  </div>\n  <canvas width="44" height="44" id="slideshow_progress"></canvas>\n</div>\n\n<div class="btns top_right">\n  <div class="full_view_btn_extend">\n    <div class="full_view_btn close">\n      <div class="icon"></div>\n    </div>\n  </div>\n</div>\n<div class="full_view_btn prev">\n  <div></div>\n</div>\n<div class="full_view_btn next">\n  <div></div>\n</div>\n\n<!--<div class="face_tagger">\n</div>-->\n\n<!-- sidebar stuff -->'},define("ThisLife.View.FullView",[],function(){return ThisLife.View.FullView})}.call(this),function(){var e,t,i,n,o,s;t=285,e=62,o="transitionend webkitTransitionEnd oTransitionEnd otransitionend MSTransitionEnd",i=!0,n=10,ThisLife.View.FullView.Video=Backbone.View.extend({className:"full_view_video",initialize:function(e){return this.dimensions=e.dimensions,this.ownerUid=e.ownerUid,this.parentPubSub=e.parentPubSub,this.autoplay=e.autoplay,this.render(),this.bindEvents(),this},bindEvents:function(){return this.parentPubSub&&this.parentPubSub.on("slideshow:start",this.videoPlay,this).on("slideshow:stop",this.videoPause,this),this},unbindEvents:function(){return this.parentPubSub?this.parentPubSub.off(null,null,this):void 0},resize:function(e){return this.videoElm&&e?this.videoElm.attr({height:e.height,width:e.width}):void 0},render:function(){return this.$el.html(s(this.model,this.ownerUid,this.dimensions)),afterglow.initVideoElements(),this.videoElm=this.$el.find("video"),this.videoPlayer=afterglow.getPlayer("video-"+this.model.id),this},remove:function(){return this.unbindEvents(),this.videoPause(),afterglow.destroyPlayer("video-"+this.model.id),Backbone.View.prototype.remove.apply(this),this},videoPlay:function(){var e;return null!=(e=this.videoPlayer)?e.play():void 0},videoPause:function(){var e;return null!=(e=this.videoPlayer)?e.pause():void 0}}),s=function(e,t,i){var n,o,s,r,l;return s=e.get("video_status")||0,o=ThisLife.Helper.Image.imageUrlDim(e.id,i,e.get("effects_modified_date"),t),l=ThisLife.Settings.s3VideoUrl+"/"+t+"/"+this.model.id+"_small.mp4",n=ThisLife.MediaPlayerHelper.videoUrlDim(this.model.id,t,i.height,e.get("height"),null,null,!1,s),(null!=(r=ThisLife.Mode)?r.PublicStory:void 0)?'<video class="afterglow" id="video-'+e.id+'" height="'+i.height+'" width="'+i.width+'" data-skin="dark" poster="'+o+'" data-autoresize="fit">\n  <source type="video/mp4" src="'+n+'" />\n</video>':'<video class="afterglow" id="video-'+e.id+'" height="'+i.height+'" width="'+i.width+'" data-skin="dark" poster="'+o+'" data-autoresize="fit">\n  <source type="video/mp4" src="'+n+'" data-quality="hd" />\n  <source type="video/mp4" src="'+l+'" />\n</video>'}}.call(this),function(){ThisLife.View.FullView.PeopleView=Backbone.View.extend({initialize:function(e){return this.options=null!=e?e:{},this.setup().bindEvents().render(),this},setup:function(){return this.faceViews=[],this.faces=this.model.get("faces"),this},bindEvents:function(){return this.parentPubSub=this.options.parentPubSub,this.faces.on("remove",this.removeFaceTagView,this).on("reset",this.removeFaceViews,this).on("add",this.addFaceTagView,this),this},render:function(){var e,t,i,n;for(n=this.faces.models,t=0,i=n.length;i>t;t++)e=n[t],this.addFaceTagView(e);return this},addFaceTagView:function(e){var t,i;if(null!=e.get("height"))return t=e.get("tag"),null!=t&&"unnamed"===t.get("name")&&e.set("unnamedTag",t),i=new ThisLife.View.ExistingFaceTag({face:e,faces:e.collection,moment:this.model,dimensions:this.options.dimensions,parentPubSub:this.parentPubSub}),this.el.appendChild(i.render().el),this.faceViews.push(i)},removeFaceViews:function(){var e,t,i,n;if(this.faceViews.length){for(n=this.faceViews,t=0,i=n.length;i>t;t++)e=n[t],e.remove();this.faceViews.length=0}return this},removeFaceTagView:function(e){var t;return t=_.find(this.faceViews,function(t){return t.face===e}),null!=t?t.remove():void 0},resize:function(e){var t,i,n,o,s;for(n=this.faceViews,o=[],t=0,i=n.length;i>t;t++)s=n[t],o.push(s.resize(e));return o},remove:function(){return this.faces.off(null,null,this),this.removeFaceViews(),this}})}.call(this),function(){var e,t,i,n,o,s,r,l;ThisLife.View.FullView.BottomBar=Backbone.View.extend({events:{"click .full_view_btn.add_to_story":"addToStory","click .full_view_btn.remove_from_story":"removeFromStory","click .full_view_btn.share":"share","click .full_view_btn.save":"saveMoment","click .full_view_btn.edit":"toggleEditPanel","click .tag_people":"tagPeople","click .info":"toggleSidebar","click .full_view_btn.crop":"crop","click .download":"download","click .delete":"delete","click .rotate_ccw":"rotateCCW","click .rotate_cw":"rotateCW","click .full_view_btn.rate_moment":"ratingSelected","mouseleave .rating_option":"removeForcedEmptyHearts"},initialize:function(e){var t;return this.options=null!=e?e:{},this.moment=this.options.moment,this.parentPubSub=this.options.parentPubSub,this.parentView=this.options.parentView,this.tagPeopleEnabled=this.options.tagPeopleEnabled,this.parentPubSub.on("tagPeople",this.tagPeopleListener,this).on("controls:hide",this.hideTooltips,this).on("slideshow:started",this.hideTooltips,this),this.moment.on("change:rating",this.ratingUpdated,this),t=_.debounce(_.bind(this.onWindowResize,this),100),ThisLife.PubSub.on("resize",t,this),this.render()},onWindowResize:function(){return this.hideTooltips()},render:function(){var i;return this.sidebarVisible=this.parentView.sidebarVisible,i=this.tagPeopleEnabled?t:e(this),this.el.insertAdjacentHTML("afterbegin",i),this.cacheElements(),this.moment.isVideo()&&this.setupVideo(),this.addHoverTooltips(),this},addHoverTooltips:function(){var e,t;return t=this.el.querySelectorAll(".full_view_btn"),this.hoverTooltips=function(){var i,n,o;for(o=[],i=0,n=t.length;n>i;i++)e=t[i],o.push(new ThisLife.View.HoverTooltip({el:e,wrapSelector:".full_view_hover_tooltip_wrap",onCanShow:_.bind(this.canShowHoverTooltip,this),showClassName:"visible"}));return o}.call(this)},canShowHoverTooltip:function(){return!this.isTooltipActive()},teardownHoverTooltips:function(){var e,t,i,n;if(this.hoverTooltips){for(n=this.hoverTooltips,t=0,i=n.length;i>t;t++)e=n[t],e.teardown();return this.hoverTooltips=null}},isTooltipActive:function(){return this.addToStoryTooltip||this.shareTooltip?!0:void 0},setupVideo:function(){return this.hideRotate(),this.reloadImageEditingButtons(),$(this.faceTaggingEl).hide()},cacheElements:function(){return this.rotateGroupEl||(this.rotateGroupEl=this.el.querySelector(".rotate")),this.cropButtonEl||(this.cropButtonEl=this.el.querySelector(".crop")),this.imageEditingGroupEl||(this.imageEditingGroupEl=this.el.querySelector(".image_editing")),this.faceTaggingEl||(this.faceTaggingEl=this.el.querySelector(".tag_people")),this.full_view_btn_groupsEl||(this.full_view_btn_groupsEl=this.el.querySelectorAll(".full_view_btn_group"))},toggleClass:function(e,t){return e?e.classList.toggle(t):void 0},toggleActiveClass:function(e){return this.toggleClass(e,"active")},toggleVisibleClass:function(e){return this.toggleClass(e,"visible")},shareFromService:function(e){return this.parentPubSub.trigger("share",e)},hideTooltips:function(){return this.teardownShareTooltip(),this.teardownStoryTooltip()},addStoryTooltip:function(){return this.addToStoryTooltip=new ThisLife.View.FullView.AddToStoryTooltip({model:this.model}),this.addToStoryTooltip.on("teardown",this.teardownStoryTooltip,this),this.storyEl.parentNode.appendChild(this.addToStoryTooltip.el),ThisLife.blurEvent(this.addToStoryTooltip.$el,_.bind(this.teardownStoryTooltip,this)),this},addDownloadTooltip:function(){return this.downloadTooltip=new ThisLife.View.FullView.DownloadTooltip({model:this.model}),this.downloadTooltip.on("teardown",this.teardownDownloadTooltip,this),this.downloadEl.parentNode.appendChild(this.downloadTooltip.el),ThisLife.blurEvent(this.downloadTooltip.$el,_.bind(this.teardownDownloadTooltip,this)),this},addShareTooltip:function(){return this.shareTooltip=new ThisLife.View.FullView.ShareTooltip({model:this.model}),this.shareTooltip.on("teardown",this.teardownShareTooltip,this).on("share",this.shareFromService,this),this.shareEl.parentNode.appendChild(this.shareTooltip.el),ThisLife.blurEvent(this.shareTooltip.$el,_.bind(this.teardownShareTooltip,this)),this},teardownShareTooltip:function(){return this.shareTooltip&&(this.shareTooltip.off(),this.shareTooltip.teardown(),this.shareTooltip=null,this.shareEl.classList.remove("active"),this.$el.trigger("click")),this},teardownDownloadTooltip:function(){return this.downloadTooltip&&(this.downloadTooltip.off(),this.downloadTooltip.teardown(),this.downloadTooltip=null,this.downloadEl.classList.remove("active"),this.$el.trigger("click")),this},teardownStoryTooltip:function(){return this.addToStoryTooltip&&(this.addToStoryTooltip.off(),this.addToStoryTooltip.teardown(),this.addToStoryTooltip=null,this.storyEl.classList.remove("active"),this.$el.trigger("click")),this},addToStory:function(){return this.parentPubSub.trigger("addToAlbum")},removeFromStory:function(){return this.parentPubSub.trigger("removeFromStory")},share:function(){var e;return this.shareEl=this.el.querySelector(".full_view_btn.share"),e=this.toggleActiveClass(this.shareEl),e?this.teardownStoryTooltip().addShareTooltip():this.teardownShareTooltip()},saveMoment:function(){var e,t;if(!this._saving)return t=function(e){return function(){var t;return t={close:!0,position:"bottom-left",style:"light",title:"PHOTO SAVED",text:"1 photo has been saved"},e._saving=!1,ThisLife.app.controller("toast")["new"](t)}}(this),e=function(e){return function(){return e._saving=!1}}(this),this._saving=!0,ThisLife.app.controller("tracking").logFMVSave(),ThisLife.Service.api.copySharedMoments(ThisLife.storyUid,null,[this.moment.get("uid")],t,e)},tagPeople:function(){var e;return e=!this.tagPeopleEnabled,this.parentPubSub.trigger("tagPeople",e)},tagPeopleListener:function(e){return this.tagPeopleEnabled=e,this.$el.empty(),this.render()},toggleSidebar:function(e){return this.parentPubSub.trigger("toggleSidebar",e)},toggleEditPanel:function(e){return this.parentPubSub.trigger("toggleEditPanel",e)},"delete":function(){return this.parentPubSub.trigger("delete")},download:function(e){var t;return e.stopPropagation(),ThisLife.app.controller("tracking").logFMVDownloadClicked(),this.parentPubSub.trigger("download"),this.moment.isVideo()&&this.model.isMine?(this.downloadEl=this.el.querySelector(".full_view_btn.download"),t=this.toggleActiveClass(this.downloadEl),t?this.addDownloadTooltip():this.teardownDownloadTooltip()):void 0},crop:function(){return this.editingImageDisabled?void 0:(this.parentPubSub.trigger("crop"),this.cropButtonEl||(this.cropButtonEl=this.el.querySelector(".crop")))},ratingSelected:function(e){var t,i;return t=e.target,i=0,(t.classList.contains("rating_3")||$(t).find(".rating_3").length>0)&&(i=3),this.moment.get("rating")>=1&&(i=0),this.updateRating(i),ThisLife.Helper.DOM.addRemoveClass(this.el.querySelector(".rating_options_wrap"),0===i,"force_empty_hearts")},updateRating:function(e){return ThisLife.app.controller("timeline").updateObjects([this.moment.id],{rating:e}),this.parentPubSub.trigger("changeRating",e)},ratingUpdated:function(e,t){var i;return i=this.el.querySelector(".rate_moment"),ThisLife.Helper.DOM.addRemoveClass(i.querySelector(".rate_moment"),t>0,"has_rating"),ThisLife.Helper.DOM.addRemoveClass(i.querySelector(".rating_3"),t>=1,"rated")},removeForcedEmptyHearts:function(){return this.el.querySelector(".rating_options_wrap").classList.remove("force_empty_hearts")},rotateCCW:function(){return this.rotate(270)},rotateCW:function(){return this.rotate(90)},rotate:function(e){return this.editingImageDisabled?void 0:(this.parentPubSub.trigger("rotate",e),this.rotateGroupEl||(this.rotateGroupEl=this.el.querySelector(".rotate")))},hideRotate:function(){return $(this.rotateGroupEl).hide()},showRotate:function(){return $(this.rotateGroupEl).show()},reloadImageEditingButtons:function(){var e;return this.imageEditingGroupEl?(e=this.model.isMine?s(!1,!0):"",this.imageEditingGroupEl.insertAdjacentHTML("afterend",e),$(this.imageEditingGroupEl).remove(),this.imageEditingGroupEl=this.el.querySelector(".image_editing")):void 0},editingImage:function(e){return null==e&&(e=!0),this.editingImageDisabled=e,this.editingImageDisabled?(this.rotateGroupEl.classList.add("disabled"),this.cropButtonEl.classList.add("disabled")):(this.rotateGroupEl.classList.remove("disabled"),this.cropButtonEl.classList.remove("disabled"))},teardownButtonGroup:function(){var e,t,i,n,o;if(this.full_view_btn_groupsEl){for(n=this.full_view_btn_groupsEl,o=[],t=0,i=n.length;i>t;t++)e=n[t],o.push($(e).remove());return o}},teardown:function(){return this.off(),this.moment.off(null,null,this),this.parentPubSub.off(null,null,this),this.teardownStoryTooltip(),this.teardownHoverTooltips(),this.teardownButtonGroup(),ThisLife.PubSub.off(null,null,this),this.remove(),this}}),n=function(e,t,n){return'<div class="full_view_btn_wrap '+e+'">\n  '+i(e,t,n)+"\n</div>"},i=function(e,t,i){var n;return n="Hide from timeline"===i?"Unhide from timeline":"Hide from timeline",'<div class="full_view_btn '+e+'">\n  <div class="full_view_hover_tooltip_wrap">\n    <div class="full_view_tooltip primary_text">\n    '+i+'\n    </div>\n    <div class="full_view_tooltip alt_text">\n    '+i+'\n    </div>\n  </div>\n  <div class="icon"></div>\n  '+(t?"<span>"+t+"</span>":"")+"\n</div>"},o=function(e,t){var o,s,r,l,a,u,c,d,h,p;for(null==e&&(e=[]),null==t&&(t=""),c=a=e.length-1;a>=0;c=a+=-1)o=e[c],p=o.visible===!1?!1:!0,p===!1&&e.splice(c,1);if(!e.length)return"";if(1===e.length)r=e[0].className||"",s=e[0].buttonText||"",h=e[0].tooltipText||"",l=n(r,s,h);else{for(l="<div class='full_view_btn_group "+t+"'>",u=0,d=e.length;d>u;u++)o=e[u],r=o.className||"",s=o.buttonText||"",h=o.tooltipText||"",l+=i(r,s,h);l+="</div>"}return l},r=function(e){return'<div class="full_view_btn_wrap rate_moment">\n  <div class="full_view_btn rate_moment '+(e>0?"has_rating":"")+'">\n  <div class="full_view_hover_tooltip_wrap">\n    <div class="full_view_tooltip">\n    Mark your favorite\n    </div>\n  </div>\n    <div class="rating_options_wrap">\n      <div class="rating_option rating_3 '+(e>=1?"rated":"")+'"></div>\n    </div>\n  </div>\n</div>'},t='<div class="done_tagging">\n  <p>Click on a face to tag it.</p>\n  '+i("tag_people","Done Tagging")+"\n</div>",s=function(e,t){var i;return i=[{className:"crop",tooltipText:"Crop Image",visible:e},{className:"download",tooltipText:"Download to desktop"},{className:"delete",tooltipText:"Add To Trash ",visible:t}],o(i,"image_editing")},l=function(){var e;return e=[{className:"rotate_ccw",tooltipText:"Rotate by 90 degrees left"},{className:"rotate_cw",tooltipText:"Rotate by 90 degrees right"}],o(e,"rotate")
},e=function(e){var t,a,u,c,d,h,p,f,m,g,v,_,b,w;return(null!=(m=ThisLife.Mode)?m.PublicStory:void 0)?(a=[{className:"download",tooltipText:"Download to desktop"}],c=o(a,"image_editing"),'<div class="btns bottom_right">\n'+c+"\n</div>"):(p=e.model,h=e.sidebarVisible?"info orange":"info",ThisLife.app.isMigrating()?(g="",t=""):(g=(p.isMine||ThisLife.currentStory.isOwner(ThisLife.currentLifeOwner))&&e.options.inStory?n("remove_from_story","Remove from Album","Remove from this Abum"):"",t=p.isMine?n("add_to_story","Add to Album","Add to an Album"):"",p.isMine&&"albums"===ThisLife.app.currentState.name&&(t=p.isMine?n("add_to_story copy_to_story","Copy to...","Copy to an Album"):void 0)),w=p.isMine?i("tag_people","Tag People","Add or remove people tags"):"",v=p.isMine?l():"",u=s(p.isMine,p.isMine),f=e.options.inStory&&!p.isMine?"":r(p.get("rating")),_=e.options.inStory&&!p.isMine?n("save","Save Photo","Save photo to your Shutterfly account"):"",b=p.isMine?n("share","Share","Share via email, Facebook, and more"):n("share read_only","Share","Share via email, Facebook, and more"),d=p.isMine&&!e.moment.isVideo()?n("edit","Edit","Edit this photo"):"",'<div class="btns bottom_left">\n  '+f+"\n  "+t+"\n  "+g+"\n  "+b+"\n  "+_+"\n  "+d+'\n</div>\n<div class="btns bottom_right">\n  '+w+"\n  "+v+"\n  "+u+"\n  "+i(h,"","See tags, caption, and more")+"\n</div>")}}.call(this),function(){var e,t,i,n;ThisLife.View.FullView.BottomBarTooltip=Backbone.View.extend({className:"full_view_tooltip_wrap visible",teardown:function(){return this.remove(),this}}),ThisLife.View.FullView.ShareTooltip=ThisLife.View.FullView.BottomBarTooltip.extend({events:{"click .js_share li":"shareFromService"},initialize:function(){return this.render()},render:function(){return this.el.insertAdjacentHTML("afterbegin",n),this},shareFromService:function(e){var t,i;return t=e.currentTarget.className,i=t,ThisLife.app.controller("tracking").logFMVShare(i),this.trigger("share",i),this.trigger("teardown")}}),ThisLife.View.FullView.DownloadTooltip=ThisLife.View.FullView.BottomBarTooltip.extend({className:"full_view_tooltip_wrap visible request_original",events:{"click .full_view_btn":"requestVideoOriginal","click .close-btn":"close"},initialize:function(){var e;return(null!=(e=ThisLife.app.currentState)?e.fragment.indexOf("album"):void 0)>-1&&this.el.classList.add("album"),this.render()},render:function(){return this.el.insertAdjacentHTML("afterbegin",t),this},close:function(){return this.trigger("teardown")},teardown:function(){return this.remove()},requestVideoOriginal:function(e){return e.stopPropagation(),ThisLife.Service.api.unfreezeMoments(this.model.id),$(this.el.querySelector(".heading")).text("Your video is on its way."),$(this.el.querySelector(".description")).text("We'll send you an email when your original video will be ready to be downloaded"),$(this.el.querySelector(".full_view_btn")).text("Original Requested!"),$(this.el.querySelector(".full_view_btn")).addClass("requested"),$(this.el.querySelector(".full_view_btn")).removeClass("full_view_btn")}}),ThisLife.View.FullView.AddToStoryTooltip=ThisLife.View.FullView.BottomBarTooltip.extend({events:{"click .full_view_btn":"createStory"},initialize:function(){var e;return e=ThisLife.Model.masterStory,this.render(),e.whenLoaded(function(t){return function(){return t.myStories=e.myStories,t.autoStories=e.autoStories,t.friendsStories=e.otherStories,t.lastUsedStoryModel=e.getLastUsed(),$(".js_my_stories").html(" "),t.cacheElements().bindEvents().renderMyStories().renderAutoStories().renderFriendsStories().renderLastUsedStory()}}(this))},cacheElements:function(){return this.myStoriesEl=this.el.querySelector(".js_my_stories"),this.autoStoriesEl=this.el.querySelector(".js_auto_stories"),this.friendsStoriesEl=this.el.querySelector(".js_friends_stories"),this.lastUsedEl=this.el.querySelector(".js_last_used"),this},bindEvents:function(){return this.myStories.on("add",this.addMyStory,this),this},getMaxTooltipHeight:function(){return ThisLife.Helper.DOM.windowHeight-120-50},render:function(){return this.el.insertAdjacentHTML("afterbegin",e(this.getMaxTooltipHeight())),this},renderMyStories:function(){var e,t,i,n;for(i=this.myStories.models,e=0,t=i.length;t>e;e++)n=i[e],this.addMyStory(n);return this},renderAutoStories:function(){var e,t,i,n;if(this.autoStories.models.length)for(this.addAutoStoriesHeading(),i=this.autoStories.models,e=0,t=i.length;t>e;e++)n=i[e],this.addAutoStory(n);return this},renderFriendsStories:function(){var e,t,i,n;if(e=_.reject(this.friendsStories.models,function(e){return e.get("view_only")}),e.length)for(this.addFriendsStoryHeading(),t=0,i=e.length;i>t;t++)n=e[t],this.addFriendsStory(n);return this},renderLastUsedStory:function(){return this.lastUsedStoryModel&&(this.addLastUsedHeading(),this.addLastUsedStory(this.lastUsedStoryModel)),this},addLastUsedHeading:function(){var e;return e='<div class="story_heading">Last Used</div>',this.lastUsedEl.insertAdjacentHTML("beforebegin",e)},addStory:function(e,t,i){var n,o,s,r;return s=i?this.model.getImageSize("x-small"):"",r=new ThisLife.View.FullView.BottomBarTooltipStory({model:this.model,story:t,imageUrl:s,parentView:this}),i?(o=e.children,n=o[i.index],n?e.insertBefore(r.el,n):e.appendChild(r.el)):e.appendChild(r.el)},addMyStory:function(e,t,i){return this.addStory(this.myStoriesEl,e,i)},addAutoStory:function(e,t,i){return this.addStory(this.autoStoriesEl,e,i)},addFriendsStory:function(e){return this.addStory(this.friendsStoriesEl,e)},addLastUsedStory:function(e){return this.addStory(this.lastUsedEl,e)},addAutoStoriesHeading:function(){return this.addHeading(this.autoStoriesEl,"Auto Stories")},addFriendsStoryHeading:function(){return this.addHeading(this.friendsStoriesEl,"Friends' Stories")},addHeading:function(e,t){return t='<div class="story_heading">'+t+"</div>",e.insertAdjacentHTML("beforebegin",t)},createStory:function(){return this.teardown(),new ThisLife.View.CreateNewStory({autoAdd:this.model,fmv:!0,showStory:!1})},teardown:function(){return this.myStories.off(null,null,this),this.trigger("teardown"),this.remove()}}),i=function(e){return'<div class="heading">'+e+"</div>"},n='<div class="full_view_tooltip">\n  <div class="heading">Share</div>\n  <ul class=\'js_share\'>\n    <li class=\'email\'><div class="icon"></div>Email</li>\n    <li class=\'link\'><div class="icon"></div>Link</li>\n    <li class=\'share_sites\'><div class="icon"></div>Share Sites</li>\n    <li class=\'facebook\'><div class="icon"></div>Facebook</li>\n  </ul>\n</div>',t='<div class="full_view_tooltip">\n  <div class="heading">Your video is downloading in <br>high quality.</div>\n  <div class="description">If you want the original file, <br>click below, we will send you <br>an email when it is ready.</div>\n  <div class="full_view_btn">Request Original</div>\n  <span class="close-btn"><img src="/assets/1px.gif"></span>\n</div>',e=function(e){var t,n;return n=ThisLife.Model.masterStory.loaded?"":"<span class='loading'>Loading...<span>",t="albums"===ThisLife.app.currentState.name?"Copy to...":"Add to Album","<div class='full_view_tooltip visible'>\n  "+i(t)+'\n  <div class="scroll_wrap" style="max-height: '+e+"px\">\n    <ul class='js_last_used'></ul>\n    <div class=\"story_heading my_stories\">My Albums</div>\n    <ul class='js_my_stories'> "+n+" </ul>\n    <ul class='js_auto_stories'></ul>\n    <ul class='js_friends_stories'></ul>\n  </div>\n  <div class=\"bottom\">\n    <div class=\"full_view_btn\">New Album</div>\n  </div>\n</div>"},define("ThisLife.View.FullView.ShareTooltip",[],function(){return ThisLife.View.FullView.ShareTooltip})}.call(this),function(){var e;ThisLife.View.FullView.BottomBarTooltipStory=Backbone.View.extend({tagName:"li",initialize:function(e){return this.story=e.story,this.imageUrl=e.imageUrl,this.parentView=e.parentView,this.render()},events:{click:"addMomentToStory"},render:function(){return this.el.insertAdjacentHTML("afterbegin",e(this.story,this.imageUrl))},addMomentToStory:function(){var e,t,i;return i=this.story.get("story_uid"),t=this.model.id,e=this.showSpinner(i,t),ThisLife.Model.masterStory.updateStory(i),ThisLife.Service.api.saveStoryMoments(i,[t],e),this.parentView.trigger("teardown")},showSpinner:function(e,t){var i;return i=new ThisLife.View.ModalAlert,document.body.appendChild(i.renderLoadingTemplate().el),ThisLife.Helper.Scripts.postpone(function(){return function(){return i.spinnerActive=!1,i.changeInnerHTML.call(i,"saveStoryMoments",{data:[e,[t]],length:1}),_.delay(function(){return i.teardown()},ThisLife.View.ModalAlert.CONFIRMATION_DELAY)}}(this),500)}}),e=function(e,t){var i,n,o;return o=ThisLife.Helper.String.escapeHtml(e.getStoryName()),t||(t=e.getImageUrl()),n=t?"":"no_avatar",i=t?"style='background-image: url("+t+")'":"",'<div class="img '+n+'" '+i+"></div>"+o}}.call(this),function(){var e,t;ThisLife.View.FullViewSidebar=Backbone.View.extend({className:"full_view_sidebar_info_panel",initialize:function(e){return this.options=null!=e?e:{},this.sidebarLoading(),this.subViews=[],this.parentPubSub=this.options.parentPubSub,this.model.loaded?this.render():this.model.on("sync",this.renderOnLoad,this)},renderOnLoad:function(){return this.model.off("sync",this.renderOnLoad,this),this.render()},sidebarLoading:function(){return this.sidebarLoadingTimer=setTimeout(function(e){return function(){return e.el.classList.add("loading")}}(this),400)},render:function(){return clearTimeout(this.sidebarLoadingTimer),this.el.classList.remove("loading"),this.el.insertAdjacentHTML("afterbegin",t(this.model)),this.cacheElements().showScrollbar().showDate().showSubViews(),"video"===this.model.get("moment_type")&&this.setupVideo(),this},setupVideo:function(){return this.$el.find(".people").hide()},cacheElements:function(){return this.fullViewSidebarScroll=this.el.querySelector(".full_view_sidebar_scroll"),this.sidebarBlocks=this.el.querySelector(".sidebar_blocks"),this},showScrollbar:function(){return this.$(this.fullViewSidebarScroll).perfectScrollbar({useKeyboard:!1}),this},showDate:function(){var e;return e=new ThisLife.View.FullView.SidebarDateView({model:this.model}),this.subViews.push(e),this.fullViewSidebarScroll.prependChild(e.el),this},showSubViews:function(){var t,i,n,o,s;for(n=_.clone(this.options),n.parent=this,t=0,i=e.length;i>t;t++)o=e[t],"SidebarCropView"===o&&this.model.isVideo()||(s=new ThisLife.View.FullView[o]({model:this.model},n),this.subViews.push(s),this.sidebarBlocks.appendChild(s.el),this[o+"Setup"](s));return this},SidebarLocationViewSetup:function(){},SidebarTagViewSetup:function(){},SidebarPeopleViewSetup:function(e){return this.parentPubSub.on("tagPeople",this.tagPeople,this),e.on("tagPeople",this.tagPeople,this)},SidebarCaptionViewSetup:function(){},SidebarCommentsViewSetup:function(){},SidebarCropViewSetup:function(){},SidebarExifViewSetup:function(){},tagPeople:function(e){return this.tagPeopleEnabled!==e?(this.tagPeopleEnabled=e,this.parentPubSub.trigger("tagPeople",e)):void 0},editingImage:function(e){var t,i,n,o,s;for(n=this.subViews,o=[],t=0,i=n.length;i>t;t++)s=n[t],o.push("function"==typeof s.editingImage?s.editingImage(e):void 0);return o},teardownscrollBar:function(){return this.$el.find(".full_view_sidebar_scroll").remove()},teardown:function(){var e,t,i,n;for(this.parentPubSub.off(null,null,this),this.model.off(null,null,this),i=this.subViews,e=0,t=i.length;t>e;e++)n=i[e],n.remove();return this.teardownscrollBar(),this.fullViewSidebarScroll=null,this.$el.remove(),this}}),t=function(){return'<div class="full_view_sidebar_scroll">\n  <div class="sidebar_blocks">\n  </div>\n</div>\n<div class="full_view_sidebar_shadow bottom"></div>'},e=["SidebarLocationView","SidebarTagView","SidebarPeopleView","SidebarCaptionView","SidebarCommentsView","SidebarCropView","SidebarExifView"]}.call(this),function(){var e;e=Backbone.View.extend({initialize:function(){return this.bindEvents().render(),this},bindEvents:function(){return this.model.on("remove",this.remove,this),this},render:function(){var e,t;return t=this.model.get("tag"),assert(t,"no tag for moment tagging:",this.model.get("moment_tagging_uid")),e=t.get("name")||"",null==e&&ThisLife.log.error("No tag name"),this.el.insertAdjacentHTML("afterbegin",this.template(t)),this},remove:function(){var e;return this.$el.remove(),this.model.off(null,null,this),null!=(e=this.model.collection)&&e.off(null,null,this),this}}),ThisLife.View.FullView.SidebarPersonTagView=e.extend({className:"full_view_tag person",template:function(e){var t,i;return i=e.getDefaultFaceUrl(),t=ThisLife.Helper.String.escapeHtml(e.get("name")),"<div class='face' style='background-image: url("+i+")'></div>"+t+"<div class='remove'><span></span></div>"},events:{mouseenter:"showCoords",mouseleave:"hideCoords","click .remove":"removeName"},bindEvents:function(){return this.model.on("remove",this.remove,this).on("change:tag",this.onChangeTag,this),this.model.collection.on("reset",this.remove,this),this},showCoords:function(){return this.model.trigger("showCoords",!0)},hideCoords:function(){return this.model.trigger("showCoords",!1)},onChangeTag:function(e,t){return t?void 0:this.remove()},removeName:function(e){return this.logger=new ThisLife.Model.LogFMV(null,{action:"untagface",lifeUid:ThisLife.lifeUid}),this.logger.setMomentId(this.model.get("moment_uid")),this.logger.setFaceDetected(!0),this.logger.setExcludeCount(1),this.logger.log(),ThisLife.PubSub.trigger("people:requireUpdate"),e.metaKey?this.deleteFace():this.removeFace()},deleteFace:function(){var e;return e=new ThisLife.View.ModalAlert({template:"deleteFaceView",callback:_.bind(this.deleteFaceCallback,this)}),document.body.appendChild(e.render().el)},deleteFaceCallback:function(){return ThisLife.Collection.personTags.deleteFaces(this.model.id),this.model.collection.remove(this.model)},removeFace:function(){return this.model.get("tag").removeNamedFace(this.model.id),this.model.set({person_tag_uid:null,tag:null})}}),ThisLife.View.FullView.SidebarMomentTagView=e.extend({className:"full_view_tag",template:function(e){var t;return t=ThisLife.Helper.String.escapeHtml(e.get("name")),t+"<div class='remove'><span></span></div>"},events:{"click .remove":"removeModel"},removeModel:function(){return ThisLife.Service.api.deleteMomentTaggings([this.model.id]),this.model.remove(),this}})}.call(this),function(){var e,t,i;ThisLife.View.FullView.SidebarTagView=Backbone.View.extend({tagName:"section",className:"sidebar_block tags",subView:ThisLife.View.FullView.SidebarMomentTagView,initialize:function(){return this.subViews=[],this.momentTags=ThisLife.Collection.momentTags,this.taggings=this.model.get("moment_taggings"),this.taggings.on("add",this.addSingleTag,this),this.render(),this},events:{"click .tag_cloud .add_tag_btn":"addTagTemplate","click .add_tag .add_tag_btn":"submitTag"},cacheElements:function(){return this.tagWrapEl=this.el.querySelector(".tag_wrap"),this.addTagEl=this.el.querySelector(".add_tag_btn"),this},hide:function(){return this.el.style.display="none",this},render:function(){return this.model.isMine?(this.el.insertAdjacentHTML("afterbegin",i),this.cacheElements().renderTags(),this):this.hide()},renderTags:function(){var e,t,i,n;for(i=this.taggings.models,e=0,t=i.length;t>e;e++)n=i[e],this.addSingleTag(n);return this},addSingleTag:function(e){var t;return e.get("tag")?(t=new this.subView({model:e}),this.subViews.push(t),this.tagWrapEl.appendChild(t.el),this):void ThisLife.log.error("no tag for moment tagging:",e.get("moment_tag_uid"))},addBlurEvent:function(){return this.blurEvent?void 0:(ThisLife.blurEvent(this.$el,_.bind(this.blurInput,this)),this.blurEvent=!0)},addTagTemplate:function(){var i,n;if(!this.addingTag)return this.addBlurEvent(),this.addingTag=!0,this.$(".add_tag_btn").hide(),this.el.insertAdjacentHTML("beforeend",e),i=$(this.el.querySelector(".dark_suggestions")),n={source:this.momentTags.toJSON(),value:"name",parent:i,num:-1,sorted:!1,template:t,"class":"sidebar_shorthand",menu:"<ul></ul>",selectCallback:_.bind(this.onEnter,this),hide:function(){return i.hide(),$.fn.shorthand.Constructor.prototype.hide.call(this)},show:function(){return i.show(),$.fn.shorthand.Constructor.prototype.show.call(this)}},this.$("input").shorthand(n),this.$("input").focus()},removeTagTemplate:function(){return this.addingTag?(this.addingTag=!1,this.$(".add_tag").remove(),this.$(".add_tag_btn").show()):void 0},submitTag:function(){return this.onEnter()},onEnter:function(e){var t,i,n,o,s;return e||(e=$(this.el.querySelector("input"))),(s=e.val().trim())?(t=this.taggings.findName(s),t||(i=this.momentTags.findName(s),i||(i=new this.momentTags.model({name:s}),this.momentTags.add(i)),n={moment_uid:this.model.id,moment_tag_uid:i.id},o=new ThisLife.Helper.MomentTagging(n),this.taggings.add(o,{parse:!0}),ThisLife.Service.api.saveMomentTag(i.toJSON(),[o])),this.removeTagTemplate()):void 0},blurInput:function(){return this.blurEvent=!1,setTimeout(function(e){return function(){return e.removeTagTemplate()}}(this),100),this}}),i='<h4><div class="icon"></div>Tags</h4>\n<div class="tag_cloud clearfix">\n  <div class="tag_wrap"></div>\n  <div class=\'full_view_btn add_tag_btn\'>Add</div>\n</div>',e='<div class="add_tag">\n  <input type="text" placeholder="Type your tag&hellip;" maxlength="255" />\n  <div class=\'full_view_btn add_tag_btn\'>Add</div>\n  <div class="dark_suggestions" style=\'display:none\'></div>\n</div>',t="<li><a></a></li>"}.call(this),function(){var e,t,i,n;ThisLife.View.FullView.SidebarCaptionView=Backbone.View.extend({tagName:"section",className:"sidebar_block caption clearfix",initialize:function(){return this.render(),this},events:{"click .add_tag_btn, div.text":"addCaption","click .save_caption":"updateCaption","click .cancel":"rerender","keydown textarea":"keyListener","keyup textarea":"autoGrow"},autoGrow:function(){return this.textarea.style.height=this.textarea.scrollHeight-6+"px"},addCaption:function(){var e;return this.model.isMine?(this.$el.empty(),e=t(),this.el.insertAdjacentHTML("afterbegin",e),this.textarea=this.el.querySelector("textarea"),this.textarea.textContent=this.model.get("note")||"",this.autoGrow(),this.$(this.textarea).focus(),this):!1},keyListener:function(e){if(this.autoGrow(),ThisLife.Helper.Keyboard.isEnter(e.keyCode)){if(!e.shiftKey)return this.updateCaption()}else if(ThisLife.Helper.Keyboard.isEscape(e.keyCode))return this.rerender()},updateCaption:function(e){var t;return e=this.textarea.value.trim(),t=this.model.get("note"),this.model.set("note",e),e!==t&&ThisLife.Service.api.saveMomentsProperty([this.model.id],"note",e),this.rerender()},rerender:function(){return this.$el.empty(),this.render(),this},render:function(){var t,n;if(t=this.model.get("note"))n=i(t);else{if(!this.model.isMine)return this.el.style.display="none";n=e}return this.el.insertAdjacentHTML("afterbegin",n),t&&(this.el.querySelector(".text").textContent=t),this},remove:function(){return this.$el.remove(),this}}),n="<h4><div class='icon'></div>Caption</h4>",i=function(){return n+"\n<div class='text'></div>"},e=n+"\n<div class='full_view_btn add_tag_btn'>Add</div>",t=function(){return n+'\n<textarea class="text" maxlength="1000"></textarea>\n<div class="clearfix cancel_save_wrap">\n  <div class="full_view_btn save_caption">\n    Save\n  </div>\n  <div class="cancel">\n    Cancel\n  </div>\n</div>'}}.call(this),function(){var e,t,i,n,o,s,r;ThisLife.View.FullView.SidebarCommentsView=Backbone.View.extend({tagName:"section",className:"sidebar_block comments",events:{"click .view_all_comments":"viewAllComments"},initialize:function(){return this.fbUid=this.model.get("facebook_uid"),this.fbUid&&this.model.isMine?(this.currentUser=ThisLife.Model.User,this.currentUser.on("change:facebook_access_token",this.fbConnectChange,this),this.render()):this.el.style.display="none",this},fbConnectChange:function(){return this.unbindConnectFB(),this.$el.empty(),this.render(),this},render:function(){var e;return e=this.currentUser.get("facebook_access_token"),this.el.insertAdjacentHTML("afterbegin",i),e?this.getComments():this.showConnectTemplate(),this},getComments:function(){return this.el.insertAdjacentHTML("beforeend",n),this.comments=new ThisLife.Collection.FacebookComments(null,{fbUid:this.fbUid,token:this.currentUser.get("facebook_access_token")}),this.comments.fetch({success:function(e){return function(){return e.showComments.apply(e,arguments)}}(this),error:function(e){return function(){return e.showCommentsError.apply(e,arguments)}}(this)})},removeLoadingEl:function(){var e;return e=this.el.querySelector(".js_loading"),null!=e?e.parentNode.removeChild(e):void 0},showComments:function(){var t;return this.removeLoadingEl(),t=this.comments.length?e(this.comments,!0):o,this.el.insertAdjacentHTML("beforeend",t),this},viewAllComments:function(){var t;return this.$(".facebook_comments").remove(),t=e(this.comments,!1),this.el.insertAdjacentHTML("beforeend",t),this},showCommentsError:function(){return ThisLife.log.error("showCommentsError",arguments)},showConnectTemplate:function(){var e;return this.el.insertAdjacentHTML("beforeend",t),e=this.$el.find(".full_view_tag.add_tag_btn"),e.append(ThisLife.app.socialToken.getServiceIframe("facebook")),this},cancelSocialConnect:function(){return this.unbindConnectFB(),this.currentUser.trigger("change:facebook_access_token",this.currentUser,this.currentUser.get("facebook_access_token"),{}),this},unbindConnectFB:function(){return ThisLife.PubSub.off("connectService:facebook",this.cancelSocialConnect,this),this},remove:function(){var e;return this.$el.remove(),null!=(e=this.currentUser)&&e.off(null,null,this),this}}),i="<h4><div class='icon'></div>Facebook Comments</h4>",n="<p class='js_loading'>Loading...</p>",t="<div class='full_view_tag add_tag_btn'>Connect to Facebook</div>",o="<p class='no_comments'>No comments</p>",s=function(e){var t,i,n,o,s,r;return s=ThisLife.Helper.String.escapeHtml(e.get("name")),i=e.get("date"),r=e.get("avatar_url"),o=ThisLife.Helper.String.escapeHtml(e.get("message")),t=e.get("attachment"),n=ThisLife.Helper.Date.humanDate(i)+" at "+ThisLife.Helper.Date.humanTime(i),"photo"===(null!=t?t.type:void 0)&&t.media.image&&(o+="<img class='attachment' src='"+t.media.image.src+"' />"),'<li>\n  <div class="avatar" style="background-image: url('+r+')"></div>\n  <strong>'+s+"</strong><br />\n  "+o+'\n  <div class="date">'+n+"</div>\n</li>"},r=function(e){var t,i;return e.length>2?(t=e.length-2,i=1===t?"":"s",'<div class="view_all_comments">\n  <a>View '+t+" more comment"+i+"&hellip;</a>\n</div>"):""},e=function(e,t){var i,n,o,l,a;for(n='<div class="facebook_comments">',t&&(n+=r(e)),n+="<ul>",a=t?-2:0,e=e.models.slice(a),o=0,l=e.length;l>o;o++)i=e[o],n+=s(i);return n+="</ul></div>"}}.call(this),function(){var e,t,i,n,o;ThisLife.View.FullView.SidebarLocationView=Backbone.View.extend({tagName:"section",className:"sidebar_block location",events:{"click .js_add_loation":"addLocation","click .location_block .remove":"removeLocation"},initialize:function(){return this.locationTags=ThisLife.Collection.locationTags,this.setLocation().bindEvents().render(),this},hide:function(){return this.el.style.display="none",this},setLocation:function(){return this.locationUid=this.model.get("location_tag_uid"),this.location=this.locationTags.get(this.locationUid),this.location_taggings=this.model.get("location_taggings"),this.lat=this.model.get("lat")||"",this["long"]=this.model.get("long")||"",this},bindEvents:function(){return this.model.on("change:location_tag_uid",this.rerender,this),this},cacheElements:function(){return this.locationBlockEl=this.el.querySelector(".location_block"),this},getImageUrl:function(){return window.devicePixelRatio>=2?this.location.getStaticMap(this.lat,this["long"])+"&zoom="+this.getZoom()+"&size=205x88&scale=2&maptype=roadmap&sensor=false&markers=scale:2|icon:https://photos.shutterfly.com/assets/full_view/marker@2x.png|"+this.lat+","+this["long"]:this.location.getStaticMap(this.lat,this["long"])+"&zoom="+this.getZoom()+"&size=205x88&maptype=roadmap&sensor=false&markers=icon:https://photos.shutterfly.com/assets/full_view/marker.png|"+this.lat+","+this["long"]},getZoom:function(){return"13"},rerender:function(){return this.changingLocation=!1,this.$el.empty(),this.setLocation().render(),this},render:function(){var t,o,s;return this.el.insertAdjacentHTML("afterbegin",i),this.cacheElements(),this.model.isMine?(this.location?(s=null!=this.lat&&null!=this["long"]?this.getImageUrl():"",t=this.location_taggings.length>1?this.getFullNameLocation():this.location.get("name"),this.getSignedUrl(s,function(e){return function(i){var o;return o=n(i,t),e.locationBlockEl.insertAdjacentHTML("afterbegin",o)}}(this))):(o=e,this.locationBlockEl.insertAdjacentHTML("afterbegin",o)),this):this.hide()},getFullNameLocation:function(){var e,t,i,n,o,s;return i={},o={city:_.findWhere(this.location_taggings,{admin_level:8}),state:_.findWhere(this.location_taggings,{admin_level:4}),country:_.findWhere(this.location_taggings,{admin_level:2})},o.city&&(e=this.locationTags.get(o.city.location_tag_uid),i.city=e.get("name")),o.state&&(s=this.locationTags.get(o.state.location_tag_uid),i.state=s.get("name")),o.country&&(t=this.locationTags.get(o.country.location_tag_uid),i.country=t.get("name"),i.country_code=t.get("country_code")),n="",i.city&&(n=i.city),n+=["US","CA"].indexOf(i.country_code)>=0?""===n?i.state:", "+i.state:""===n?i.country:", "+i.country},addLocation:function(){return this.popNewLocationModal("")},addBlurEvent:function(){return this.blurEvent?void 0:(ThisLife.blurEvent(this.$el,_.bind(this.blurInput,this)),this.blurEvent=!0)},changeLocation:function(){var e,t,i,n;if(!this.changingLocation)return this.addBlurEvent(),this.changingLocation=!0,i=this.location?this.location.get("name"):void 0,e=$(this.el.querySelector(".dark_suggestions")),e=$(this.el.querySelector(".dark_suggestions")),n={source:this.locationTags.toJSON(),value:"name",parent:e,num:-1,sorted:!1,"class":"sidebar_shorthand",template:o,menu:"<ul></ul>",selectCallback:_.bind(this.onEnter,this),hide:function(){return e.hide(),$.fn.shorthand.Constructor.prototype.hide.call(this)},show:function(){return e.show(),$.fn.shorthand.Constructor.prototype.show.call(this)}},t=this.el.querySelector("input"),this.$(t).shorthand(n),t.select()},removeLocation:function(e){return e.stopPropagation(),this.model.removeLocation()},onEnter:function(e){var t,i,n;return e||(e=$(this.el.querySelector("input"))),(n=e.val().trim())?(i=this.locationTags.findName(n),t=this.locationUid&&(null!=i?i.id:void 0)===this.locationUid,t?this.rerender():i?this.model.addLocation(i.id):this.popNewLocationModal(n)):void 0},popNewLocationModal:function(e){var t,i,n;return n=_.bind(this.model.addLocation,this.model),t=ThisLife.Templates.places("newPlaceTemplate"),i=new ThisLife.View.ModalNewPlace({templateID:"modal_new_place",heading:"Add new location",body:t,closeText:"SAVE",callback:n,cancelText:"CANCEL",fmv:!0,placeValue:e})},blurInput:function(){return this.blurEvent=!1,setTimeout(function(e){return function(){return e.rerender()}}(this),100),this},remove:function(){return this.$el.remove(),this.model.off(null,null,this),this},getSignedUrl:function(e,t){return ThisLife.Service.api.getSignedUrl(e,function(){return function(e){return"function"==typeof t?t(e):void 0}}(this))}}),n=function(e,t){var i;return t=ThisLife.Helper.String.escapeHtml(t),i=null!=e?"":" display: none;","<div class='tag_wrap'>\n<div class='full_view_tag'>"+t+'<div class=\'remove\'><span></span></div></div></div>\n<div class="map" style="background-image: url('+e+");"+i+'"></div>'},e="<div class='full_view_btn add_tag_btn js_add_loation'>Add</div>",i="<h4><div class=\"icon\"></div>Location</h4>\n<div class='location_block'></div>",t=function(e){return null==e&&(e=""),'<div class="add_tag">\n  <input type="text" placeholder="Type a location&hellip;" value=\''+e+"' />\n  <div class='full_view_btn add_tag_btn'>Save</div>\n  <div class=\"dark_suggestions\" style='display:none'></div>\n</div>"},o="<li><a></a></li>"}.call(this),function(){var e,t;ThisLife.View.FullView.SidebarPeopleView=Backbone.View.extend({tagName:"section",className:"sidebar_block people",subView:ThisLife.View.FullView.SidebarPersonTagView,events:{"click .add_tag_btn":"triggerTagPeople"},initialize:function(e,t){return this.subViews=[],this.tagPeopleEnabled=t.tagPeopleEnabled,this.faces=this.model.get("faces"),this.faces.on("add",this.showAndAddFace,this).on("change:tag",this.onChangeTag,this),this.parentPubSub=t.parentPubSub,this.parentPubSub.on("tagPeople",this.tagPeople,this),this.render(),this},cacheElements:function(){return this.personTagWrapEl=this.el.querySelector(".tag_wrap"),this.tagPeopleEl=this.el.querySelector(".add_tag_btn"),this},render:function(){return this.el.insertAdjacentHTML("afterbegin",t),this.cacheElements(),this.model.isMine?this.showFaces().renderFaces():this.hideFaces(),this.renderTagPeopleText(this.tagPeopleEnabled),this},showFaces:function(){return this.el.style.display="",this.shown=!0,this},hideFaces:function(){return this.el.style.display="none",this.shown=!1,this},renderFaces:function(){var e,t,i,n;for(n=this.faces.models,t=0,i=n.length;i>t;t++)e=n[t],this.addSingleFace(e);return this},isKnownFace:function(e){return e.get("person_tag_uid")},hasCoords:function(e){return null!=e.get("height")},addSingleFace:function(e){var t,i;return t=this.isKnownFace(e),t&&e.get("tag")?(i=new this.subView({model:e}),this.subViews.push(i),e.get("unnamedTag")&&"unnamed"===e.get("tag").get("name")&&i.el.replaceChild(document.createTextNode(""),i.el.childNodes[1]),this.personTagWrapEl.appendChild(i.el),this.personTagWrapEl.classList.add("flex-column")):t&&ThisLife.log.error("No tag found for known person tag"),this},showAndAddFace:function(e){if(this.shown||this.showFaces(),e.get("tag").get("name")&&e.get("unnamedTag")){for(;this.personTagWrapEl.firstChild;)this.personTagWrapEl.removeChild(this.personTagWrapEl.firstChild);return this.renderFaces()}return this.addSingleFace(e)},onChangeTag:function(e,t){return t?this.showAndAddFace(e):void 0},renderTagPeopleText:function(){var e;return e=this.tagPeopleEnabled?"Done Tagging":"Add",this.tagPeopleEl.textContent=e},triggerTagPeople:function(){var e;return e=!this.tagPeopleEnabled,this.trigger("tagPeople",e)},tagPeople:function(e){return this.tagPeopleEnabled=e,this.renderTagPeopleText()},remove:function(){var e,t,i,n;for(i=this.subViews,e=0,t=i.length;t>e;e++)n=i[e],n.remove();return this.faces.off(null,null,this),this.parentPubSub.off(null,null,this),this.off(),this.$el.remove(),this}}),t='<h4><div class="icon"></div>People</h4>\n<div class="tag_cloud clearfix">\n  <div class="tag_wrap"></div>\n  <div class="full_view_btn add_tag_btn"></div>\n</div>',e=function(e){return null!==e.get("person_tag_uid")}}.call(this),function(){var e,t,i,n,o,s,r,l,a,u,c;e=["January","February","March","April","May","June","July","August","September","October","November","December"],t=' selected="selected"',ThisLife.View.FullView.SidebarDateView=Backbone.View.extend({tagName:"section",className:"sidebar_block date",events:function(){return this.model.isMine?{"click .date_wrap":"editDate","click .full_view_btn":"saveDate","click .cancel":"rerender","change select.month":"updateDays","change select.year":"updateDays"}:{}},initialize:function(){return this.render(),this},render:function(){return this.el.insertAdjacentHTML("afterbegin",n(this.model)),this},rerender:function(){return this.$el.empty(),this.render(),this},remove:function(){return this.$el.remove(),this},editDate:function(){return this.$(".date_wrap").remove(),this.el.insertAdjacentHTML("afterbegin",i(this.model.get("moment_date"))),this.$(".date_edit select").customSelect({height:30})},saveDate:function(){return this.$(".error").removeClass("error"),this.modifyDate()&&(this.$(".date_edit").remove(),this.render()),this},updateDays:function(){var e,t,i,n,o;for(e=document.querySelector("select.day"),t=ThisLife.Helper.Date.getDaysOfMonth(this.$("select.year option:selected").val(),parseInt(this.$("select.month option:selected").val(),10)+1),o=this.$("select.day option:selected").val(),e.innerHTML=null,n="",i=1;t>=i;)n+="<option value='"+i+"'>"+i+"</option>",i++;return e.insertAdjacentHTML("beforeend",n),e.value=o,i<=parseInt(o)?(e.value=i-1,this.$('select.day option[value="'+(i-1)+'"]').attr("selected",!0),this.$(".date_edit span.day span").text(i-1)):void 0},validateTime:function(e){var t,i,n,o;return t=e[0],n=e[1],i=u(t),o=c(n),i||this.showTimeError("hours"),o||this.showTimeError("minutes"),i&&o},showTimeError:function(e){var t;return t=this.el.querySelector(".js_"+e),t.classList.add("error")},modifyDate:function(){var e,t,i,n,o,s,r,l,a,u,c,d,h,p,f,m,g,v,_;return h=new Date(1e3*this.model.get("moment_date")),e=this.$(".date_edit"),t=e.find("option").filter(":selected"),i=e.find("input"),o=function(){var e,i,n;
for(n=[],e=0,i=t.length;i>e;e++)r=t[e],n.push(r.value);return n}(),m=function(){var e,t,n;for(n=[],e=0,t=i.length;t>e;e++)r=i[e],g=r.value||"0",1===g.length&&(g="0"+g),n.push(g);return n}(),(v=this.validateTime(m))?(_=o[2],c=o[0],s=o[1],n=o[3],l=parseInt(m[0],10),l="PM"===n?12>l?l+12:l:12===l?0:l,u=m[1],p=h.getUTCSeconds(),a=h.getUTCMilliseconds(),d=Date.UTC(_,c,s,l,u,p,a),h.getTime()!==d&&(f=d/1e3,this.model.set("moment_date_timestamp",f),ThisLife.app.controller("timeline").updateObjects([this.model.id],{moment_date:d}),ThisLife.Service.api.saveMomentsProperty([this.model.id],"moment_date",f)),!0):!1}}),n=function(e){return'<div class="date_wrap">\n  '+o(e.get("moment_date"))+"<span><img src='/assets/1px.gif' class='pencil_icon' /></span>\n</div>"},o=function(e){var t,i;return t=ThisLife.Helper.Date.humanDateUTC(e),i=ThisLife.Helper.Date.humanTimeUTC(e),t+"<span class='at'>at</span>"+i},i=function(e){var t,i,n;return t=new Date(1e3*e),i=new Date(t.getFullYear(),t.getMonth()+1,0).getDate(),n=t.getUTCMinutes(),n=10>n?"0"+n:n,'<div class="date_edit">\n\n  <div class="float_right">\n\n    <div class="date_select_wrap">\n      <select class="month" data-width="90">\n        '+l(t.getUTCMonth())+'\n      </select>\n    </div>\n    <div class="date_select_wrap">\n      <select class="day" data-width="30">\n        '+r(t.getUTCDate(),i)+'\n      </select>\n    </div>\n\n    <div class="date_select_wrap">\n      <select class="year" data-width="45">\n        '+a(t.getUTCFullYear())+'\n      </select>\n    </div>\n  </div>\n\n  <div class="float_right">\n    <div class="date_select_wrap time">\n      <input class=\'js_hours\' type="text" value="'+(t.getUTCHours()%12||12)+'" maxlength="2" />\n      :\n      <input class=\'js_minutes\' type="text" value="'+n+'" maxlength="2" />\n    </div>\n    <div class="date_select_wrap">\n      <select data-width="30">\n      '+s(t.getUTCHours())+'\n      </select>\n    </div>\n  </div>\n\n  <div class="clearfix cancel_save_wrap">\n    <div class="full_view_btn">\n      Save\n    </div>\n    <div class="cancel">\n      Cancel\n    </div>\n  </div>\n</div>'},u=function(e){var t;return e.match(/\d{2}/)&&0<(t=parseInt(e,10))&&12>=t},c=function(e){var t;return e.match(/\d{2}/)&&0<=(t=parseInt(e,10))&&60>t},l=function(i){var n,o,s,r,l,a;for(l="",n=0,o=0,s=e.length;s>o;o++)r=e[o],a=n===i?t:"",l+="<option"+a+" value='"+n+"''>"+r+"</option>",n++;return l},r=function(e,i){var n,o,s,r,l;for(o="",i||(i=31),n=s=1,r=i;r>=1?r>=s:s>=r;n=r>=1?++s:--s)l=n===e?t:"",o+="<option"+l+" value='"+n+"'>"+n+"</option>";return o},a=function(e){var i,n,o,s,r;for(r="",s=i=n=(new Date).getFullYear();1900>=n?1900>=i:i>=1900;s=1900>=n?++i:--i)o=s===e?t:"",r+="<option"+o+" value='"+s+"'>"+s+"</option>";return r},s=function(e){var i,n,o,s,r,l,a;for(i="",l=e>11?"PM":"AM",s=["AM","PM"],n=0,o=s.length;o>n;n++)a=s[n],r=l===a?t:"",i+="<option"+r+" value='"+a+"'>"+a+"</option>";return i}}.call(this),function(){var e,t,i,n,o,s,r,l,a;ThisLife.View.FullView.SidebarExifView=Backbone.View.extend({tagName:"section",className:"sidebar_block exif",initialize:function(){var e;return this.render(),this.cacheElements(),this.addSourcesView(),this.model.exif&&this.model.exif.loaded?this.renderExif():this.model.exif&&this.model.exif.error?this.renderExif():((e=this.model).exif||(e.exif=this.newExifModel()),this.model.exif.on("sync",this.renderExif,this).on("error",this.renderExif,this)),this},cacheElements:function(){return this.table=this.el.querySelector("table")},addSourcesView:function(){var e;return e=new ThisLife.View.FullView.SidebarSourceView({model:this.model}),this.table.appendChild(e.el)},newExifModel:function(){var e,t,i;return i=this.model.get("created_by_uid")||this.model.get("story_moment_created_by"),t=this.model.get("moment_type"),e=new ThisLife.Model.ExifData({uid:this.model.id,owner:i,moment_type:t}),e.fetch(),e},render:function(){return this.el.insertAdjacentHTML("afterbegin",r(this.model)),this},renderExif:function(){return this.table.insertAdjacentHTML("beforeend",n(this.model)),this.renderDateTaken(),this},renderDateTaken:function(){var e,t,i;return this.model.isVideo()?(t=$.trim(this.model.exif.get("create_date"))||$.trim(this.model.exif.get("creation_date"))||"0000:00:00 00:00:00","false"===t&&(t="0000:00:00 00:00:00"),e=new Date(t),t&&isNaN(e.getTime())&&(e=new Date(t.split(" ")[0].replace(/:/g,"/"))),i="0000:00:00 00:00:00"===t?"N/A":ThisLife.Helper.Date.humanDate(e)):(t=$.trim(this.model.exif.get("Date/Time Original")))?(e=new Date(t),isNaN(e.getTime())&&(e=new Date(t.split(" ")[0].replace(/:/g,"/"))),i="0000:00:00 00:00:00"===t?"N/A":ThisLife.Helper.Date.humanDate(e)):i="N/A",$(l(i)).insertAfter(this.$el.find(".exif_filename"))},remove:function(){return this.$el.remove(),this.model.exif.off(null,null,this),this}}),r=function(e){var t,i,n;return t=e.get("original_filename"),n=e.get("upload_date")?ThisLife.Helper.Date.humanDateUTC(e.get("upload_date")):void 0,i=ThisLife.Helper.String.bytesToSize(e.get("orig_filesize")),'<h4><div class="icon"></div>File Data</h4>\n<table cellpadding="0" cellspacing="0">\n  '+o(t)+"\n  "+a(n)+"\n  "+s(i)+"\n</table>"},o=function(e){return e?'<tr class="exif_filename">\n  <td colspan="2">\n    <strong>Name</strong><br />\n    <span class="filename">'+e+"</span>\n  </td>\n</tr>":""},l=function(e){return e?'<tr>\n  <td colspan="2">\n    <strong>Date Taken</strong><br />\n    '+e+"\n  </td>\n</tr>":""},a=function(e){return e?'<tr>\n  <td colspan="2">\n    <strong>Upload Date</strong><br />\n    '+e+"\n  </td>\n</tr>":""},s=function(e){return e?'<tr>\n  <td colspan="2">\n    <strong>Filesize</strong><br />\n    '+e+"\n  </td>\n</tr>":""},e=function(e){return e?'<tr>\n  <td colspan="2">\n    <strong>Camera</strong><br />\n    '+e+"\n  </td>\n</tr>":""},t=function(e,t){return'<td width="94"><strong>'+e+"</strong><br />"+(t||"Unknown")+"</td>"},i=function(e){var i,n,o,s,r;for(r=1,n="",o=0,s=e.length;s>o;o++)i=e[o],i.value&&(1===r&&(n+="<tr>"),n+=t(i.label,i.value),2===r&&(n+="</tr>"),r=1===r?2:1);return 2===r&&(n+="</tr>"),n},n=function(t){var n,o,s,r,l,a,u,c,d,h,p,f,m,g,v;return r=t.exif,o=r.get("Make"),s=r.get("Model"),g=t.get("orig_duration")&&ThisLife.Helper.Date.secondsToDuration(Number(t.get("orig_duration"))/1e3),d=null!=(p=r.get("Image Height"))?p.replace(/\D/g,""):void 0,v=null!=(f=r.get("Image Width"))?f.replace(/\D/g,""):void 0,m=d&&v?v+"x"+d:t.get("width")+"x"+t.get("height"),a=r.get("Exposure Time")||r.get("Shutter Speed Value"),n=r.get("Aperture Value")||r.get("F-Number"),n=null!=n?n.replace("F","f/"):void 0,c=r.get("Focal Length"),h=r.get("ISO Speed Ratings"),u=r.get("Flash"),o||s||m||a||n||c||h||u||g?(l=[{label:"Video Duration",value:g},{label:"Resolution",value:m},{label:"Focal Length",value:c},{label:"Exposure",value:a},{label:"ISO Speed",value:h},{label:"Aperture",value:n},{label:"Flash",value:u}],e(s)+"\n"+i(l)):""}}.call(this),function(){var e,t,i;ThisLife.View.FullView.SidebarSourceView=Backbone.View.extend({tagName:"tr",initialize:function(){return this.render(),this},render:function(){var e;return e=this.model.get("source"),e?this.el.insertAdjacentHTML("afterbegin",i(e)):this.el.style.display="none",this}}),e=function(e){var i,n,o;return null==e&&(e=""),i=e.split(","),o=function(){var e,o,s;for(s=[],e=0,o=i.length;o>e;e++)n=i[e],s.push(t(n));return s}(),o.join(", ")},t=function(e){switch(e){case"facebook":return"Facebook";case"thislife":return"ThisLife";case"shutterfly":case"sfly":return"Shutterfly";case"share_status":case"shared_import":return"Shared Gallery";case"android_tablet":return"Android Tablet";case"macuploader_device":case"macuploader_filesystem":case"macuploader_iphoto":case"macuploader_photos":case"winuploader":return"Desktop Uploader";case"android_phone":return"Android Phone";case"ipad":return"iPad";case"smugmug":return"SmugMug";case"instagram":return"Instagram";case"iPhone":case"ios_background_upload":return"iPhone";case"flickr":return"Flickr";case"html5app":return"My Computer";case"picasa":return"Google Photos";default:return e?e:"Unknown"}},i=function(t){var i;return i=e(t),'<td colspan="2">\n  <strong>Sources</strong><br />\n  '+i+"\n</td>"}}.call(this),function(){var e,t;ThisLife.View.FullView.SidebarCropView=Backbone.View.extend({tagName:"section",className:"sidebar_block crop clearfix hidden",events:{"click .edit_crop_btn":"edit"},initialize:function(e,t){return this.fullViewPubSub=t.parentPubSub,this.model=t.model,this.editingDisabled=t.editingImage,this.render(),this},render:function(){var e,i;return e=function(e){return function(){return e.el.classList.add("hidden"),e.model.on("change:effects_modified_date",e.updateCrop,e)}}(this),i=function(i){return function(n){var o;return n.crop?(o=i.getLabel(n),i.el.insertAdjacentHTML("afterbegin",t(i.model.isMine,i.editingDisabled,o)),i.editButton=i.el.querySelector(".edit_crop_btn"),i.el.classList.remove("hidden"),i.model.on("change:effects_modified_date",i.updateCrop,i)):e()}}(this),ThisLife.Service.api.getCropping(this.model.id,i,e),this},edit:function(){return this.editingDisabled?void 0:this.fullViewPubSub.trigger("crop")},editingImage:function(e){return this.editingDisabled=e,ThisLife.Helper.DOM.addRemoveClass(this.editButton,this.editingDisabled,"disabled")},getLabel:function(e){var t,i,n,o,s,r,l,a,u,c,d,h,p,f;for(a=e.full_width,l=e.full_height,r=e.crop.urx-e.crop.llx,o=e.crop.ury-e.crop.lly,s=a*r,n=l*o,i=s/n,f=1/i,p=ThisLife.View.FullView.Crop.ASPECT_RATIOS,u=0,d=p.length;d>u;u++){if(t=p[u],t.areEqualWithinTolerance(i,a,l)){h=t.label;break}if(t.areEqualWithinTolerance(f,a,l)){h=t.rotatedLabel;break}}return s=Math.round(s),n=Math.round(n),c=s+"x"+n,h&&(c+=" ("+h+")"),c},updateCrop:function(){var e;return e=function(e){return function(i){var n;return i.crop?((n=null!=e.el.querySelector(".aspectInfo"))?n.innerHTML=e.getLabel(i):e.el.insertAdjacentHTML("afterbegin",t(e.model.isMine,e.editingDisabled,e.getLabel(i))),e.el.classList.remove("hidden")):e.el.classList.add("hidden")}}(this),ThisLife.Service.api.getCropping(this.model.id,e)},remove:function(){return this.$el.remove(),this.model.off(null,null,this),this}}),t=function(t,i,n){return"<h4><div class='icon'></div>Crop</h4>\n<p class='aspectInfo'>"+n+"</p>\n"+(t?e(i):"")},e=function(e){var t;return t="full_view_btn edit_crop_btn",e&&(t+=" disabled"),"<div class='"+t+"'>Edit</div>"}}.call(this),function(){var e;ThisLife.View.FullViewAFS=Backbone.View.extend({initialize:function(e){return this.options=null!=e?e:{},this.filterModel=this.options.filterModel,this.parentView=this.options.parentView,this.afsPubSub=this.options.afsPubSub,this.loadScripts()},loadScripts:function(){return("undefined"!=typeof shutterfly&&null!==shutterfly?shutterfly.AFS:void 0)?void 0:$.getScript(ThisLife.manifest.afs)},filterImage:function(t){var i,n,o,s,r,l;return null==t&&(t=this.model),this.afsPubSub.trigger("loading"),o=!1,this.el.classList.add("disabled"),l=(new Date).getTime(),i=this.filterModel.getFilter(),n=void 0,"Original"===i?n=void 0:"Softfocus"===i?n=new shutterfly.AFS.filters[i]({strength:this.filterModel.getFilterValue()}):"Saturate"===i?n=new shutterfly.AFS.filters.LegacySaturate({saturate:this.filterModel.getFilterValue()}):"Colortone"===i?n=new shutterfly.AFS.filters.Duotone({hue:this.filterModel.getFilterValue()}):i&&(n=new shutterfly.AFS.filters[i]),s=this.parentView.getUneditedSrc(),ThisLife.Helper.Platform.ie10()?void this.afsPubSub.trigger("doneLoading"):(r=new shutterfly.AFS.FilteredImage({imageUrl:s,filters:null,rotation:e(),resample:[this.parentView.parentView.dimensions.width,this.parentView.parentView.dimensions.height]}),n&&r.addFilter(n),r.getFilterSet()[0]||i||0!==e()?r.applyFilters(function(e){return function(t,n){var s,r;t?console.log("filterImage: ERROR applying filters: ",t):!o&&shutterfly.AFS.Utils.browserSupportsClientFilters()?(e.el.classList.remove("disabled"),$(".full_view_media img").attr("src",n),"prod"!==(s=ThisLife.Settings.sflyEnv)&&"stage"!==s&&(r=(new Date).getTime()-l,$("#messageList").append('<li val="'+r+'">'+i+' on client took: <span class="time">'+r+'ms</span> <span class="imgdesc">()</span></li>'))):($("#filteredImageContainer")[0].onload=function(){var e;"prod"!==(e=ThisLife.Settings.sflyEnv)&&"stage"!==e&&(r=(new Date).getTime()-l,$("#messageList").append('<li val="'+r+'">'+i+' on server took: <span class="time">'+r+'ms</span> <span class="imgdesc">()</span></li>')),$(this)[0].onload=null,updateAverage()},$("#filteredImageContainer").attr("src",n)),e.afsPubSub.trigger("doneLoading")}}(this),o):alert("Unsupported Filter!"))}}),e=function(){var e;return e=$("input[name=rotation]").val(),e=""!==e?parseInt(e,10):null}}.call(this),function(){var e;ThisLife.View.FullViewEditPanel=Backbone.View.extend({className:"full_view_sidebar_edit_panel",events:{"click .initial_panel .crop":"crop","click .initial_panel .rotate_icon.left":"rotateCW","click .initial_panel .rotate_icon.right":"rotateCCW","click .initial_panel .filters":"filters","click .initial_panel .red_eye":"redeye","click .initial_panel footer .apply":"toggleSidebar"},initialize:function(e){return this.options=null!=e?e:{},this.sidebarLoading(),this.newImageFilterModel(),this.parentPubSub=this.options.parentPubSub,this.parentView=this.options.parentView,this.afsPubSub=_.extend({},Backbone.Events),this.afs=new ThisLife.View.FullViewAFS({model:this.model,filterModel:this.filterModel,parentView:this,afsPubSub:this.afsPubSub}),this.afsPubSub.on("doneLoading",function(e){return function(){return e.el.classList.remove("disabled")}}(this)),this.afsPubSub.on("loading",function(e){return function(){return e.el.classList.add("disabled")}}(this)),this.parentPubSub.on("doneLoading",function(e){return function(){return e.el.classList.remove("disabled")}}(this)),this.parentPubSub.on("loading",function(e){return function(){return e.el.classList.add("disabled")}}(this)),this.model.loaded&&this.filterModel.loaded?this.render():(this.filterModel.on("sync",this.renderOnLoad,this),this.model.on("sync",this.renderOnLoad,this))},getUneditedSrc:function(){return this.model.getImageSize("medium")+"?suppressEffects=true"},renderOnLoad:function(){return this.model.loaded&&this.filterModel.loaded?(this.model.off("sync",this.renderOnLoad,this),this.filterModel.off("sync",this.renderOnLoad,this),this.render()):void 0},sidebarLoading:function(){return this.sidebarLoadingTimer=setTimeout(function(e){return function(){return e.el.classList.add("loading")}}(this),400)},render:function(){return clearTimeout(this.sidebarLoadingTimer),this.el.classList.remove("loading"),this.el.insertAdjacentHTML("afterbegin",e(this.model)),this.cacheElements(),this},newImageFilterModel:function(){return this.filterModel=new ThisLife.Model.ImageFilters({uid:this.model.id,model:this.model}),this.filterModel.fetch({silent:!0}),this.filterModel.on("change",this.filterImage,this),this.filterModel},filterImage:function(){return this.afs.filterImage()},toggleSidebar:function(e){return this.parentPubSub.trigger("toggleEditPanel",e)},crop:function(){return this.el.classList.add("disabled"),this.parentPubSub.trigger("crop")},filters:function(){var e;return e=new ThisLife.View.FullView.Filters({model:this.model,filterModel:this.filterModel,parentView:this}),this.el.appendChild(e.el)},redeye:function(){var e;return e=new ThisLife.View.FullView.Redeye({model:this.model,parentView:this}),this.el.appendChild(e.el)},rotateCCW:function(){return this.rotate(270)},rotateCW:function(){return this.rotate(90)},rotate:function(e){return this.editingImageDisabled?void 0:this.parentPubSub.trigger("rotate",e)},editingImage:function(e){return null==e&&(e=!0),this.editingImageDisabled=e,this.editingImageDisabled?this.el.classList.add("disabled"):this.el.classList.remove("disabled")},cacheElements:function(){return this.fullViewSidebarScroll=this.el.querySelector(".full_view_sidebar_scroll"),this.sidebarBlocks=this.el.querySelector(".sidebar_blocks"),this},teardown:function(){return this.remove(),this.parentPubSub.off(null,null,this),this.model.off(null,null,this),this}}),e=function(){return'<div class="full_view_editing_panel initial_panel">\n  <h2>Edit your photo</h2>\n  <ul class="edit_options">\n    <li class="rotate">\n      <span>Rotate</span>\n      <div class="rotate_icon left"></div>\n      <div class="rotate_icon right"></div>\n    </li>\n    <li class="crop arrow">\n      <span>Crop</span>\n    </li>\n    <li class="filters arrow">\n      <span>Filters</span>\n    </li>\n    <li class="red_eye arrow">\n      <span>Red Eye</span>\n    </li>\n  </ul>\n\n  <footer>\n    <div class="apply orange-btn">Done</div>\n  </footer>\n</div>'}}.call(this),function(){var e;ThisLife.View.FullView.Filters=Backbone.View.extend({className:"full_view_sidebar full_view_editing_panel edit_slideout filters",events:{"click .cancel":"cancel","click .apply":"saveFilter","click .filters_list li:not(.active)":"applyFilter"},initialize:function(e){return this.options=null!=e?e:{},this.model=this.options.model,this.parentView=this.options.parentView,this.render(),_.delay(function(e){return function(){return e.el.classList.add("show")}}(this))},render:function(){return this.el.insertAdjacentHTML("afterbegin",e(this.model)),this.disableNavigation(),this.setFilterState(),this.onModelChange(),this.renderSlider(),this},disableNavigation:function(){return this.parentView.parentView.unbindKeyEvents(),this.parentView.parentView.$el.find(".full_view_btn.prev, .full_view_btn.next").addClass("disabled").hide()},enableNavigation:function(){return this.parentView.parentView.bindKeyEvents(),this.parentView.parentView.$el.find(".full_view_btn.prev, .full_view_btn.next").removeClass("disabled").show()},setFilterState:function(){var e,t,i;return null!=(t=this.el.querySelector("li.active"))&&t.classList.remove("active"),e=this.options.filterModel.getFilter(),e?null!=(i=this.el.querySelector("li[data-filter="+e+"]"))?i.classList.add("active"):void 0:this.el.querySelector("li.original").classList.add("active")},applyFilter:function(e){var t,i;return t=$(e.currentTarget).data("filter"),this.removeFilterParams(),"Colortone"===t||"Saturate"===t||"Softfocus"===t?(this.renderSlider(t),i=this.getRangeOptions(t).tuneValue/100,this.options.filterModel.updateFilter(t,i)):this.options.filterModel.updateFilter(t),this.toggleSaveFilter(t,i)},renderSlider:function(e){var t;return t=null!=e?e:e=this.options.filterModel.getFilter(),"Colortone"===t||"Saturate"===t||"Softfocus"===t?(this.slider=new ThisLife.View.FullView.RangeSlider({className:t,parentView:this,rangeOptions:this.getRangeOptions(t)}),this.el.querySelector(".edit_options").appendChild(this.slider.el)):void 0},removeFilterParams:function(){var e;return null!=(e=this.slider)&&e.remove(),this.slider=null},getRangeOptions:function(e){var t,i;return i={min:0,max:100,"default":0},i.tuneValue=100*(null!=(t=this.options.filterModel)?t.get("filter")[e]:void 0)||i["default"],i},updateModel:function(e,t){return this.options.filterModel.updateFilter(e,t?t/100:void 0),this.toggleSaveFilter(e,t)},onModelChange:function(){return this.options.filterModel.on("change:filter",this.updateFilterSelection,this)},updateFilterSelection:function(){return this.setFilterState()},reset:function(){return this.removeFilterParams(),this.options.filterModel.resetFilter()},cancel:function(){return this.options.filterModel.resetFilter(),this.parentView.uneditedSrc=null,this.enableNavigation(),this.el.classList.remove("show")},toggleSaveFilter:function(e,t){return e===this.model.filter&&t===this.model.filterValue?this.el.querySelector("footer .apply").classList.add("disabled"):this.el.querySelector("footer .apply").classList.remove("disabled")},saveFilter:function(e){return e.target.classList.contains("disabled")?void 0:(this.options.filterModel.save(),this.enableNavigation(),this.el.classList.remove("show"))},transitionCallback:function(){return this.remove()}}),e=function(){var e;return e="",ThisLife.Helper.Platform.ie10()&&(e="<div class='no-preview'>We've detected that you\u2019re running IE10. You will not be able to preview your filters in this mode, but any filter you apply will save. Please upgrade or use a supported browser to preview filters.</div>"),'<h2><div class="icon"></div>Filters</h2>\n<ul class="filters_list clearfix">\n  <li class="original">\n    <div class="img original"></div>\n    <span>Original</span>\n  </li>\n  <li data-filter="BlackWhite">\n    <div class="img bw"></div>\n    <span>B&amp;W</span>\n  </li>\n  <li data-filter="Colortone">\n    <div class="img colortone"></div>\n    <span>Color Tone</span>\n  </li>\n  <li data-filter="Saturate">\n    <div class="img saturate"></div>\n    <span>Saturate</span>\n  </li>\n  <li data-filter="Softfocus">\n    <div class="img softfocus"></div>\n    <span>Soft Focus</span>\n  </li>\n</ul>\n<ul class="edit_options sliders">\n</ul>\n<div id="messageList">'+e+'</div>\n<footer>\n  <div class="cancel">\n    <span>Cancel</span>\n  </div>\n  <div class="apply orange-btn disabled">Apply</div>\n</footer>\n<div class="disabled_block"></div>'}}.call(this),function(){var e,t,i;ThisLife.View.FullView.Redeye=Backbone.View.extend({className:"full_view_sidebar full_view_editing_panel edit_slideout red_eye",events:{"click .cancel":"cancel","click .apply":"applyChanges","click .re_auto .switch":"toggleAuto","click .show_re":"","click .hide_re":""},initialize:function(e){return this.options=null!=e?e:{},this.model=this.options.model,this.parentView=this.options.parentView,this.setupVars().bindEvents().render(),this.findRedEyes(),this.hideFaceTags(),_.bindAll(this,"startRedeyeAnimation","mouseUp","moveRedeye","createRedeye","mouseUpCreate","startCreateAnimation"),ThisLife.Helper.Platform.ie()||$(document).on("selectstart",!1),_.delay(function(e){return function(){return e.el.classList.add("show")}}(this))},bindEvents:function(){return $(".full_view_stage").on("mousedown.redeye",function(e){return function(t){return"IMG"===t.target.nodeName&&e.notDrawing&&e.isCreating(t),"outline"===t.target.className&&e.notDrawing?e.isMoving(t):void 0}}(this)).on("click.re_close",function(e){return function(t){return"re_close"===t.target.className?e.deleteNewRedeyeView(t):void 0}}(this)),this.parentView.parentView.unbindKeyEvents(),this.parentView.parentView.$el.find(".full_view_btn.prev, .full_view_btn.next").addClass("disabled").hide(),this},unbindEvents:function(){return $(".full_view_stage").off("mousedown.redeye").off("click.re_close"),this.parentView.parentView.bindKeyEvents(),this.parentView.parentView.$el.find(".full_view_btn.prev, .full_view_btn.next").removeClass("disabled").show(),this},setupVars:function(){return this.fmvStage=$(".full_view_stage")[0],this.multiplier=1,this.box_dimension=this.box_x=this.box_y=void 0,this.notDrawing=!0,this.stage_w=this.fmvStage.clientWidth,this.stage_h=this.fmvStage.clientHeight,this.posX=this.posY=this.newRedeye=this.currentX=this.currentY=this.boxid=0,this.redeyeBoxes=[],this.defaultBoxes=[],this},render:function(){return this.el.insertAdjacentHTML("afterbegin",i(this.model)),this.changeStageClasses(!0),this.applyBtn=this.el.querySelector(".apply"),this},teardown:function(){return ThisLife.Helper.Platform.ie()||$(document).on("selectstart",!0),this.changeStageClasses(!1),this.clearBoxes(),this.unhideFaceTags()},findRedEyes:function(){return ThisLife.Service.api.getMomentRedEyeEffects(this.model.id,_.bind(this.findSuccess,this),_.bind(this.findError,this))},findSuccess:function(e){var t,i,n,o,s,r,l,a,u;for(i=e.regions,o=0,r=i.length;r>o;o++)t=i[o],u=t.urx*this.stage_w-t.llx*this.stage_w,n=t.ury*this.stage_h-t.lly*this.stage_h,s=t.llx*this.stage_w,a=this.stage_h-t.lly*this.stage_h-n,l=new ThisLife.View.FullView.RedeyeBox({boxX:s,boxY:a,width:u,height:n,moment:this.model}),this.fmvStage.appendChild(l.render().el),l.el.setAttribute("boxid",++this.boxid),this.redeyeBoxes.push(l);return this.defaultBoxes=_.extend([],this.redeyeBoxes)},findError:function(e){var t;return null!=(t=this.errorView)&&t.teardown(),this.errorView=new ThisLife.View.Error({message:e.payload.message}),this.errorView.show()},hideFaceTags:function(){return _.each(this.fmvStage.querySelectorAll(".full_view_face_tag"),function(e){return $(e).hide()})},unhideFaceTags:function(){return _.each(this.fmvStage.querySelectorAll(".full_view_face_tag"),function(e){return $(e).show()})},changeStageClasses:function(e){var t,i;return e?(t="add",i="remove"):(t="remove",i="add"),this.fmvStage.classList[t]("redeye"),this.fmvStage.classList[i]("zoom")},cancel:function(){return this.unbindEvents().teardown(),ThisLife.Helper.DOM.addEventListener(this.el,"transitionend",this.transitionCallback),this.el.classList.remove("show")},applyChanges:function(e){var t,i,n,o,s,r,l;if(!$(e.currentTarget).hasClass("disabled")){for(o=[],l=this.redeyeBoxes,s=0,r=l.length;r>s;s++)t=l[s],i=t.getCoords(),n={llx:i.llx/this.stage_w,lly:1-i.lly/this.stage_h,urx:i.urx/this.stage_w,ury:1-i.ury/this.stage_h},o.push(n);return this.loadingView=new ThisLife.View.SpinnerModal({size:"small"}),document.body.appendChild(this.loadingView.el),ThisLife.Service.api.setMomentRedEyeEffects(this.model.id,o,_.bind(this.saveSuccess,this),_.bind(this.saveError,this))}},saveSuccess:function(){var e;return null!=(e=this.loadingView)&&e.teardown(),this.model.trigger("filter"),this.el.classList.remove("show"),this.unbindEvents().teardown(),this},saveError:function(){var e,t;return null!=(e=this.loadingView)&&e.teardown(),null!=(t=this.errorView)&&t.teardown(),this.errorView=new ThisLife.View.Error({message:"Unable to apply Red Eye removal effects at this time."}),this.errorView.show(),this},transitionCallback:function(){return this.remove()},toggleAuto:function(e){return e.currentTarget.classList.toggle("on")},mouseUp:function(){return cancelAnimationFrame(this.boxMoveFrame),$(window).off("mousemove").off("mouseup",this.mouseUp)},mouseUpCreate:function(){return cancelAnimationFrame(this.boxCreateFrame),$(window).off("mousemove",this.createRedeye).off("mouseup",this.mouseUpCreate),this.applyBtn.classList.remove("disabled"),_.defer(function(e){return function(){return e.notDrawing=!0}}(this)),!1},clearBoxes:function(){var e,t,i,n;if(this.redeyeBoxes){for(i=this.redeyeBoxes,n=[],t=i.length-1;t>=0;t+=-1)e=i[t],n.push(e.remove());return n}},deleteNewRedeyeView:function(e){var t,i,n,o,s;for(i=e.target.parentNode.parentNode,n=i.getAttribute("boxid"),s=this.redeyeBoxes,o=s.length-1;o>=0;o+=-1)t=s[o],t.el.getAttribute("boxid")===n&&(t.remove(),this.redeyeBoxes.splice(this.redeyeBoxes.indexOf(t)));return this.isModified()?this.applyBtn.classList.remove("disabled"):this.applyBtn.classList.add("disabled")},isCreating:function(e){var t,i;return this.notDrawing=!1,this.box_dimension=25,this.stage_w=this.fmvStage.clientWidth,this.stage_h=this.fmvStage.clientHeight,t=this.fmvStage.getBoundingClientRect(),this.offsetTop=t.top,this.offsetLeft=t.left,this.startX=e.clientX,this.startY=e.clientY,this.box_x=e.clientX-t.left,this.box_y=e.clientY-t.top,i=new ThisLife.View.FullView.RedeyeBox({positionX:this.position_x,positionY:this.position_y,boxX:this.box_x,boxY:this.box_y,width:this.box_dimension,height:this.box_dimension,moment:this.model}),this.fmvStage.appendChild(i.render().el),i.el.setAttribute("boxid",++this.boxid),this.redeyeBoxes.push(i),this.newRedeyeBox=this.redeyeBoxes[this.redeyeBoxes.length-1],$(window).on("mousemove",this.createRedeye).on("mouseup",this.mouseUpCreate),this.createRedeye(e),this.startCreateAnimation()},createRedeye:function(e){var t,i,n,o;return t=e.clientX,i=e.clientY,n=t-this.startX,o=i-this.startY,this.newX=Math.max(n,25),this.newX=Math.min(this.newX,this.stage_w),this.newY=Math.max(o,25),this.newY=Math.min(this.newY,this.stage_h-30),t>this.stage_w+this.offsetLeft&&(this.newX=this.stage_w+this.offsetLeft-this.startX),i>this.stage_h+this.offsetTop?this.newY=this.stage_h+this.offsetTop-this.startY:void 0},startCreateAnimation:function(){return this.boxCreateFrame=requestAnimationFrame(this.startCreateAnimation),this.newRedeyeBox.el.style.width=this.newX+"px",this.newRedeyeBox.el.style.height=this.newY+"px"},isMoving:function(e){var t;return t=e.target.parentNode,this.movingElem=t,this.posX=e.clientX,this.posY=e.clientY,this.currentX=t.offsetLeft,this.currentY=t.offsetTop,$(window).on("mousemove",this.moveRedeye).on("mouseup",this.mouseUp),this.moveRedeye(e),this.startRedeyeAnimation(e)},moveRedeye:function(e){var t,i;return t=this.posX-e.clientX,i=this.posY-e.clientY,this.box_x=this.currentX-t,this.box_y=this.currentY-i,this.setXAndY()},setXAndY:function(){return this.box_x=Math.max(this.box_x,0),this.box_y=Math.max(this.box_y,0),this.box_x+this.movingElem.offsetWidth>this.stage_w&&(this.box_x=this.stage_w-this.movingElem.offsetWidth),this.box_y+this.movingElem.offsetHeight>this.stage_h?this.box_y=this.stage_y-this.movingElem.offsetHeight:void 0},startRedeyeAnimation:function(){return this.boxMoveFrame=requestAnimationFrame(this.startRedeyeAnimation),this.movingElem.style.left=this.box_x+"px",this.movingElem.style.top=this.box_y+"px"},isModified:function(){return!(JSON.stringify(this.defaultBoxes)===JSON.stringify(this.redeyeBoxes))}}),t=function(t,i){return'<div class="full_view_btn_wrap '+t+'">\n  '+e(t,i)+"\n</div>"},e=function(e,t){return'<div class="full_view_btn '+e+'">\n  <span>'+t+"</span>\n</div>"},i=function(){var e,i;return e=!0,i=e?'<span class="zero_re">No Red Eye detected</span>':t("show_re","Show Boxes"),'<h2><div class="icon"></div>Red Eye</h2>\n<div class="re_auto">\n  <span>Red Eye Detection</span>\n  <div class="switch on">\n    <div class="handle"></div>\n  </div>\n</div>\n<div class="re_interaction">'+i+'</div>\n<div class="re_manual">\n  <div class="re_title">Manual Detection:</div>\n  <div>Select areas to treat by drawing a box around the eyes. Drag and drop the box if misplaced. Click on the box to delete it.</div>\n</div>\n<footer>\n  <div class="cancel">\n    <span>Cancel</span>\n  </div>\n  <div class="apply orange-btn disabled">Apply</div>\n</footer>\n<div class="disabled_block"></div>'}}.call(this),function(){var e;ThisLife.View.FullView.RedeyeBox=Backbone.View.extend({className:"full_view_redeye_box shorthand redeye_box show",initialize:function(e){return this.options=null!=e?e:{},this.setCoords(this.options)},render:function(){return this.el.insertAdjacentHTML("afterbegin",e),this},setCoords:function(e){return this.el.style.cssText="left: "+e.boxX+"px; top: "+e.boxY+"px; height: "+e.height+"px; width: "+e.width+"px; opacity: 1;",this},getCoords:function(){var e,t;return t=this.$el.position(),e={llx:t.left,lly:t.top+parseInt(this.$el.height()),urx:t.left+parseInt(this.$el.width()),ury:t.top}}}),e='<div class="outline"><div class="re_close"></div></div>'}.call(this),function(){var e;ThisLife.View.FullView.RangeSlider=Backbone.View.extend({tagName:"li",events:{"mousedown .handle":"onMouseDown","mousedown .range_input":"onMouseDownRangeInput"},initialize:function(e){return this.options=null!=e?e:{},this.sliderWidth=224,this.handleWidth=14,this.render(),this.cacheElements(),this.options.rangeOptions.min<0?this.el.querySelector(".range_input").classList.add("negative"):void 0},updateSlider:function(e){var t;return t=this.getSliderPosition(e),this.renderSliderOffset(t)},onMouseDownRangeInput:function(e){var t,i,n;return e.preventDefault(),t=this.rangeInputEl.getBoundingClientRect(),i=(e.pageX-t.left-this.handleWidth/2)/(this.sliderWidth-this.handleWidth),n=this.getSliderPosition(this.getSliderValueFromPercent(i)),this.renderSliderOffset(n),this.onMouseDown(e)},getSliderValueFromPercent:function(e){return this.getSliderRange()*e-(this.getSliderRange()-this.options.rangeOptions.max)},getSliderRange:function(){return this.options.rangeOptions.max-this.options.rangeOptions.min},onMouseDown:function(e){return e.preventDefault(),e.stopPropagation(),this.dragging=!0,this.mouseDownX=e.pageX,this.mouseMoveCallback=_.bind(this.onMouseMove,this),this.mouseUpCallback=_.bind(this.onMouseUp,this),this.startingLeft=this.left,$(window).on("mousemove",this.mouseMoveCallback).on("mouseup",this.mouseUpCallback)},onMouseMove:function(e){var t,i,n,o;return o=e.pageX-this.mouseDownX,i=100/(this.sliderWidth-this.handleWidth)*o,t=(this.startingLeft+i)/100,n=this.getSliderPosition(this.getSliderValueFromPercent(t)),this.renderSliderOffset(n)},onMouseUp:function(){return this.dragging=!1,this.options.parentView.updateModel(this.options.className,this.options.rangeOptions.tuneValue),$(window).off("mousemove",this.mouseMoveCallback).off("mouseup",this.mouseUpCallback)},cacheElements:function(){return this.fillEl=this.el.querySelector(".fill"),this.handleEl=this.el.querySelector(".handle"),this.rangeValueEl=this.el.querySelector(".range_value"),this.rangeInputEl=this.el.querySelector(".range_input")},renderSliderOffset:function(e){return this.fillEl.style.cssText="width: "+e.trackWidth+"%; left: "+e.trackLeft+"%",this.handleEl.style.left=e.left+"px",this.rangeValueEl.innerHTML=e.tuneValue
},getSliderPosition:function(e){var t,i,n,o,s;return null==e&&(e=this.options.rangeOptions.tuneValue),e=parseInt(e),e=Math.max(this.options.rangeOptions.min,e),e=Math.min(this.options.rangeOptions.max,e),this.left=(e-this.options.rangeOptions.min)/this.getSliderRange()*100,o=this.options.rangeOptions.min<0?Math.abs(this.options.rangeOptions.min/this.getSliderRange()*100):0,0>e?(n=this.left,s=o-n):(n=o,s=this.left-o),i=this.sliderWidth*this.left/100,t=Math.abs((this.left-50)/50),this.left<50?i+=this.handleWidth/2*t:i-=this.handleWidth/2*t,this.options.rangeOptions.tuneValue=e,{midPoint:o,trackLeft:n,trackWidth:s,left:i,tuneValue:e}},render:function(){var t;return t=this.getSliderPosition(),this.el.insertAdjacentHTML("afterbegin",e(this.options,t)),this}}),e=function(e,t){return"<span>"+e.className+'</span>\n<div class="range_value">'+t.tuneValue+'</div>\n<div class="range_input">\n  <div class="track">\n    <div class="fill" style="width: '+t.trackWidth+"%; left: "+t.trackLeft+'%"></div>\n    <div class="notch" style="left: '+t.midPoint+'%"></div>\n  </div>\n  <div class="handle" style="left: '+t.left+'px"></div>\n</div>'}}.call(this),function(){var e,t;e=4e3,ThisLife.View.FullView.Slideshow=Backbone.View.extend({bindEvents:{"click .full_view_btn.slideshow":"stopSlideshow","click .full_view_btn.next":"goToNextMoment","click .full_view_btn.prev":"goToPreviousMoment",mousemove:"onMousemove"},initialize:function(e){return _.bindAll(this,"slideshowKeys"),this.parentPubSub=e.parentPubSub,this.addListeners(),this.start(e.type),this.el.classList.add("slideshow_enabled")},start:function(e){return this.el.classList.add("slideshow_active"),this.slideshowButton||(this.slideshowButton=this.el.querySelector(".full_view_btn.slideshow")),this.slideshowButton.classList.add("playing"),this.delegateEvents(this.bindEvents),this.bindKeyEvents(),("video"!==e||"video"===e&&ThisLife.Helper.Platform.mobile())&&this.startTimer(),this.mouseMoveTimer(),this.onMomentChanged(e),this.parentPubSub.trigger("slideshow:start"),this},onMousemove:function(e){return this.mouseTimer&&clearInterval(this.mouseTimer),this.parentPubSub.trigger("controls:show"),e.target.classList.contains("full_view")||$(e.target).closest(this.fullViewStage).length>0?this.mouseMoveTimer():void 0},mouseMoveTimer:function(){return this.mouseTimer=setTimeout(function(e){return function(){return e.parentPubSub.trigger("controls:hide")}}(this),2e3)},startTimer:function(){var t;return t=null!=this.remainingTime?this.remainingTime:e,this.timerStartTime=Date.now(),this.timer=setTimeout(_.bind(this.goToNextMoment,this,!0),t),this.startProgressIndicator(t),this},setupProgressIndicator:function(){return this.slideshowProgressEl||(this.slideshowProgressEl=document.getElementById("slideshow_progress")),this.progressIndicatorDegrees||(this.progressIndicatorDegrees=0)},drawProgressIndicator:function(){var e,i,n;return e=36,i=4,n=e+2*i,this.setupProgressIndicator(),this.slideshowProgressCtx=this.slideshowProgressEl.getContext("2d"),this.slideshowProgressCtx.beginPath(),this.slideshowProgressCtx.clearRect(0,0,n,n),this.slideshowProgressCtx.closePath(),this.slideshowProgressCtx.lineWidth=i,this.slideshowProgressCtx.strokeStyle="#fff",this.slideshowProgressCtx.arc(n/2,n/2,(n-i)/2,t(0),t(this.progressIndicatorDegrees),!1),this.slideshowProgressCtx.stroke()},startProgressIndicator:function(){var t,i,n,o,s;return i=e/360,t=this.progressIndicatorDegrees||0,n=o=null,s=function(e){return function(r){var l;return null==o&&(o=r),n=r,e.timer?(l=(n-o)/i,e.progressIndicatorDegrees=t+l,e.drawProgressIndicator(),requestAnimationFrame(s)):void 0}}(this),requestAnimationFrame(s)},stopTimer:function(){var t;return this.timer&&(t=Date.now()-this.timerStartTime,this.remainingTime=this.remainingTime?this.remainingTime-t:e-t,clearTimeout(this.timer),this.timer=null),this},restart:function(){return this.stopTimer(),this.remainingTime=null,this.progressIndicatorDegrees=null,this.startTimer()},bindKeyEvents:function(){return window.addEventListener("keydown",this.slideshowKeys,!1),this},unbindKeyEvents:function(){return window.removeEventListener("keydown",this.slideshowKeys,!1),this},addListeners:function(){return this.parentPubSub.on("slideshow:momentChanged",this.onMomentChanged,this),this.parentPubSub.on("videoEnded",this.onVideoEnded,this),this},goToPreviousMoment:function(e){return null==e&&(e=!1),this.parentPubSub.trigger("slideshow:prev",{fade:e})},goToNextMoment:function(e){return null==e&&(e=!1),this.parentPubSub.trigger("slideshow:next",{fade:e})},stopSlideshow:function(){return this.parentPubSub.trigger("slideshow:stop")},slideshowKeys:function(e){switch(e.keyCode){case 27:case 32:return this.stopSlideshow();case 37:return this.goToPreviousMoment(!1);case 39:return this.goToNextMoment(!1)}},onMomentChanged:function(e){return"video"!==e||ThisLife.Helper.Platform.mobile()?void 0:this.stopTimer()},onVideoEnded:function(){return this.goToNextMoment()},teardown:function(){return this.stopTimer(),this.slideshowButton.classList.remove("playing"),this.unbindKeyEvents(),this.undelegateEvents(),this.remove()},remove:function(){return this.el.classList.remove("slideshow_active"),this}}),t=function(e){return e-=90,e*(Math.PI/180)}}.call(this),function(){var e,t,i,n,o;i=62,o=285,n={llx:0,lly:0,urx:1,ury:1},ThisLife.View.FullView.Crop=ThisLife.View.BaseView.extend({className:"full_view sidebar_visible crop_view",once:Backbone.Events.once,setup:function(e){return this.options=e||{},this.moment=this.options.moment,this.render(),this.resizeCrop=_.debounce(_.bind(this.resize,this),250),$(window).on("resize",this.resizeCrop),this},render:function(){return this.el.classList.add("crop_loading"),this.loadScripts()},resize:function(){var e,t;if(this.editView)return t=this.croppingResponse?this.croppingResponse.full_width:this.moment.get("width"),e=this.croppingResponse?this.croppingResponse.full_height:this.moment.get("height"),this.calculateFullImageDimensions(t,e),this.getHighResImage(),this.editView.resize(this.fullImageDimensions,this.croppingResponse)},loadScripts:function(){return $.Jcrop?this.getCropping():$.getScript(ThisLife.manifest.jCrop,function(e){return function(){return e.getCropping()}}(this))},getCropping:function(){var e,t;return t=function(e){return function(t){var i,n,o;return e.croppingResponse=t,n=t?t.full_width:e.moment.get("width"),i=t?t.full_height:e.moment.get("height"),e.calculateFullImageDimensions(n,i),e.createInitialCoordinates(),e.createModel(n,i),e.renderEditor(),e.renderSidebar({originalRatio:n/i}),e.renderImage(function(){return e.editView.showCropTools(t.crop)}),o=null!=t.crop?!1:!0,e.sidebarView.coordinatesUpdated(o),e.el.classList.remove("crop_loading")}}(this),e=function(e){return function(){return e.el.classList.remove("crop_loading"),e.error()}}(this),ThisLife.Service.api.getCropping(this.moment.id,t,e)},createInitialCoordinates:function(){var e;return e=this.croppingResponse.crop,this.initialCoordinates=e?{llx:parseFloat(e.llx.toFixed(20).slice(0,-14)),lly:parseFloat(e.lly.toFixed(20).slice(0,-14)),urx:parseFloat(e.urx.toFixed(20).slice(0,-14)),ury:parseFloat(e.ury.toFixed(20).slice(0,-14))}:n},createModel:function(t,i){var n,o,s,r,l,a,u,c,d,h;if(!this.croppingResponse||!this.croppingResponse.crop)return void(this.model=new Backbone.Model({aspectRatio:0,original:!1,free:!0,rotated:!1}));for(s=this.croppingResponse.crop,h=(s.urx-s.llx)*t,r=(s.ury-s.lly)*i,o=h/r,d=r/h,l=0,a=e.length;a>l;l++)n=e[l],n.areEqualWithinTolerance(o,t,i)?u=n.ratio:n.areEqualWithinTolerance(d,t,i)&&(u=1/n.ratio,c=!0);return this.model=new Backbone.Model(u?{aspectRatio:u,original:!1,free:!1,rotated:c}:{aspectRatio:0,original:!1,free:!0,rotated:c})},renderEditor:function(){return this.editView=new ThisLife.View.FullView.Crop.Editor({moment:this.moment,model:this.model,dimensions:this.fullImageDimensions}),this.el.appendChild(this.editView.el),this.addEditorBindings()},renderSidebar:function(t){return null==t&&(t={}),this.sidebarView=new ThisLife.View.FullView.Crop.Sidebar({model:this.model,originalRatio:t.originalRatio,disabled:!0,aspectRatios:e}),this.el.appendChild(this.sidebarView.el),this.addSidebarBindings()},addBindings:function(){return ThisLife.Support.keyInformant.on("cancel",this.cancel,this)},addEditorBindings:function(){return this.editView.on("coordinatesUpdated",this.coordinatesUpdated,this),this.editView.on("disabled",this.editorDisabled,this)},addSidebarBindings:function(){return this.sidebarView.on("cancel",this.cancel,this),this.sidebarView.on("apply",this.apply,this)},removeBindings:function(){return this.removeEditorBindings(),this.removeSidebarBindings(),$(window).off("resize",this.resizeCrop),ThisLife.Support.keyInformant.off("cancel",this.cancel,this)},removeEditorBindings:function(){var e;return null!=(e=this.editView)?e.off(null,null,this):void 0},removeSidebarBindings:function(){var e;return null!=(e=this.sidebarView)?e.off(null,null,this):void 0},setImageSource:function(e){return this.currentSrc=e,this.editView.imgEl.src=e},getImageDimensions:function(){return this.fullImageDimensions},getLowResImageSource:function(){return ThisLife.Helper.Image.uncroppedImageUrl(this.moment.getImageSize("x-small"))},getImageSource:function(e,t,i,n){return ThisLife.Helper.Image.uncroppedImageUrlDim(e,t,i,n)},coordinatesUpdated:function(e){var t,i,n;for(i in e)n=e[i],e[i]=parseFloat(n.toFixed(20).slice(0,-14));return t=_.isEqual(this.initialCoordinates,e),this.sidebarView.coordinatesUpdated(t)},editorDisabled:function(e){return this.sidebarView.disable(e)},apply:function(){var e,t;return t=function(e){return function(){return e.el.classList.remove("disabled"),e.trigger("cropped"),e.teardown()}}(this),e=function(e){return function(){return e.el.classList.remove("disabled"),e.error()}}(this),this.areSameCoordinates()?this.backToFullView():(this.el.classList.add("disabled"),this.trigger("start"),ThisLife.Service.api.setCropping(this.moment.id,this.getCoordinates(),t,e))},cancel:function(){return this.backToFullView()},error:function(){var e,t;return t=function(e){return function(){return e.trigger("error"),e.backToFullView()}}(this),e=new ThisLife.View.Error({onClose:t}),e.show()},teardown:function(){var e,t;return this.trigger("close"),null!=(e=this.editView)&&e.teardown(),null!=(t=this.sidebarView)&&t.teardown(),this.removeBindings(),this.remove({skipRedirect:!0})},backToFullView:function(){return this.editView?_.defer(function(e){return function(){var t,i,n,o,s;return e.el.className="full_view zoom_transition",n=ThisLife.View.FullView.prototype.getImageDimensions.call(e,e.moment,!0,!0),o=n.width/e.fullImageDimensions.width,s=e.fullImageDimensions.top,t=e.fullImageDimensions.left,i=function(){return e.teardown()},e.editView.transitionBack(s,t,o,i)}}(this)):this.teardown()},calculateFullImageDimensions:function(e,t){var n,s,r,l,a,u,c,d;return s=Math.max(ThisLife.Helper.DOM.windowHeight-2*i,200),r=Math.max(ThisLife.Helper.DOM.windowWidth-o-2*i,200),n=r/s,u=e,a=t,l=u/a,(u>720||a>720)&&(l>1?(a=720,u=a*l):(u=720,a=u/l)),n>l?(a=Math.min(a,s),u=a*l):(u=Math.min(u,r),a=u/l),c=Math.round((r-u+2*i)/2),d=Math.round((s-a+2*i)/2),this.fullImageDimensions={width:u,height:a,left:c,top:d}},getCoordinates:function(){var e;return this.editView.coordinatesExist()?(e=this.editView.getCoordinates(),this.areOriginalCoordinates(e)?n:e):this.initialCoordinates},areSameCoordinates:function(){var e;return e=this.getCoordinates(),this.areEqualCoordinatesWithinTolerance(e,this.initialCoordinates)},areOriginalCoordinates:function(e){return this.areEqualCoordinatesWithinTolerance(e,n)},areEqualCoordinatesWithinTolerance:function(e,t){var i,n;return i=.004,n=.004,ThisLife.Helper.Math.nearlyEqual(e.llx,t.llx,i)&&ThisLife.Helper.Math.nearlyEqual(e.lly,t.lly,n)&&ThisLife.Helper.Math.nearlyEqual(e.urx,t.urx,i)&&ThisLife.Helper.Math.nearlyEqual(e.ury,t.ury,n)}}),t=function(){function e(e,t){this.label=t,this.rotatedLabel=t.split(":").reverse().join(":"),this.ratio=e}return e.prototype.areEqualWithinTolerance=function(e,t,i){var n,o,s;return s=t/200*.001,o=i/200*.001,n=(s+o)/2,ThisLife.Helper.Math.nearlyEqual(this.ratio,e,n)},e}(),e=[new t(16/9,"16:9"),new t(5/4,"5:4"),new t(1.5,"3:2"),new t(1,"1:1"),new t(4/3,"4:3")],ThisLife.View.FullView.Crop.ASPECT_RATIOS=e}.call(this),function(){var e,t;e=300,ThisLife.View.FullView.Crop.Editor=Backbone.View.extend({className:"crop_view_editor",initialize:function(e){return null==e&&(e={}),this.fullImageDimensions=e.dimensions,this.moment=e.moment,this.model=e.model,this.render(),this.bindEvents()},render:function(){return this.el.insertAdjacentHTML("beforeend",t(this.fullImageDimensions)),this.cacheElements()},cacheElements:function(){return this.cropViewStage=this.el.querySelector(".full_view_stage"),this.imgEl=this.el.querySelector(".full_view_stage img")},bindEvents:function(){return this.model.on("change",this.updateJCrop,this)},unbindEvents:function(){return this.model.off(null,null,this)},resize:function(e){var t,i;return this.fullImageDimensions=e,i=ThisLife.Helper.CSS.browserPrefix("transform",ThisLife.Helper.CSS.resolveTranslate(this.fullImageDimensions.left,this.fullImageDimensions.top,0)),this.cropViewStage.style.cssText="width: "+this.fullImageDimensions.width+"px; height: "+this.fullImageDimensions.height+"px; "+i,null!=(t=this.jCrop)?t.resizeImage(this.fullImageDimensions.width,this.fullImageDimensions.height):void 0},showCropTools:function(e,t){var i,n,o,s,r,l;return o=e?e.llx*this.fullImageDimensions.width:0,r=e?(1-e.ury)*this.fullImageDimensions.height:0,s=e?e.urx*this.fullImageDimensions.width:this.fullImageDimensions.width,l=e?(1-e.lly)*this.fullImageDimensions.height:this.fullImageDimensions.height,i=40,n=this,$(this.imgEl).Jcrop({setSelect:[o,r,s,l],boxWidth:Math.floor(this.fullImageDimensions.width),aspectRatio:this.model.get("aspectRatio"),boxHeight:Math.floor(this.fullImageDimensions.height),boundary:0,allowSelect:!1,bgColor:"black",keySupport:!1,bgOpacity:.4,bgFade:!0,handleOpacity:1,borderOpacity:1,minSize:[50,50],createHGuides:[1/3,2/3],createVGuides:[1/3,2/3],resizeCentered:!0,onChange:function(e){return function(t){return e.jCropCoordinates=t,e.trigger("coordinatesUpdated",e.getCoordinates())}}(this)},function(){return n.jCrop=this,n.animateTo([o,r,s,l],function(){return"function"==typeof t?t():void 0})})},removeCropTools:function(){var e;return null!=(e=this.jCrop)?e.destroy():void 0},coordinatesExist:function(){return null!=this.jCropCoordinates},getCoordinates:function(){var e,t;return t=this.model.get("free")||this.model.get("original")?this.jCropCoordinates:{x:this.jCropCoordinates.x,y:this.jCropCoordinates.y,h:this.jCropCoordinates.h,w:this.model.get("aspectRatio")*this.jCropCoordinates.h},e={llx:t.x/this.fullImageDimensions.width,lly:(this.fullImageDimensions.height-t.y-t.h)/this.fullImageDimensions.height,urx:(t.x+t.w)/this.fullImageDimensions.width,ury:(this.fullImageDimensions.height-t.y)/this.fullImageDimensions.height}},transitionBack:function(t,i,n,o){return this.removeCropTools(),_.defer(function(s){return function(){var r;return r=ThisLife.Helper.CSS.browserPrefix("transform",ThisLife.Helper.CSS.resolveTranslate(i,t,0,n)),s.cropViewStage.style.cssText="width: "+s.fullImageDimensions.width+"px; height: "+s.fullImageDimensions.height+"px; "+r,_.delay(function(){return o()},e)}}(this))},updateJCrop:function(e){var t,i,n,o,s;if(this.jCrop&&(this.jCrop.setOptions({aspectRatio:0}),!e.get("free")))return t=e.get("aspectRatio"),t>this.fullImageDimensions.width/this.fullImageDimensions.height?(n=this.fullImageDimensions.width,i=n/t):(i=this.fullImageDimensions.height,n=i*t),o=(this.fullImageDimensions.width-n)/2,s=(this.fullImageDimensions.height-i)/2,Math.round(n)!==this.jCropCoordinates.w||Math.round(i)!==this.jCropCoordinates.h?this.animateTo([o,s,n+o,i+s],function(e){return function(){return e.jCrop.setOptions({aspectRatio:t})}}(this)):this.jCrop.setOptions({aspectRatio:t})},animateTo:function(e,t){return this.jCrop?(this.trigger("disabled",!0),this.jCrop.animateTo(e,function(e){return function(){return e.trigger("disabled",!1),"function"==typeof t?t():void 0}}(this))):void 0},teardown:function(){return this.removeCropTools(),this.unbindEvents(),this.remove()}}),t=function(e){var t;return t=ThisLife.Helper.CSS.browserPrefix("transform",ThisLife.Helper.CSS.resolveTranslate(e.left,e.top,0)),'<div class="full_view_stage" style="width: '+e.width+"px; height: "+e.height+"px; "+t+'">\n  <div class="full_view_media">\n    <img draggable="false" src="">\n  </div>\n</div>'}}.call(this),function(){var e;ThisLife.View.FullView.Crop.Sidebar=Backbone.View.extend({className:"full_view_sidebar full_view_editing_panel edit_slideout crop",events:{"click .apply":"apply","click .cancel":"cancel"},initialize:function(e){return null==e&&(e={}),this.model=e.model,this.render(e),_.delay(function(e){return function(){return e.el.classList.add("show")}}(this)),this.disable(e.disabled)},render:function(t){return this.el.insertAdjacentHTML("beforeend",e()),this.aspectsView=new ThisLife.View.FullView.Crop.Aspects(t),this.el.querySelector(".aspects").appendChild(this.aspectsView.el),this.applyBtn=this.el.querySelector(".apply")},apply:function(e){return e.target.classList.contains("disabled")?void 0:this.trigger("apply")},coordinatesUpdated:function(e){return this.applyDisabled=e,ThisLife.Helper.DOM.addRemoveClass(this.applyBtn,this.applyDisabled,"disabled")},disable:function(e){return this.aspectsView.disable(e)},cancel:function(){return this.trigger("cancel"),this.teardown()},teardown:function(){return this.aspectsView.teardown(),this.remove()}}),e=function(){return'<h2><div class="icon"></div>Crop</h2>\n<div class="sidebar_blocks">\n  <section class="sidebar_block crop clearfix">\n    <h4><div class="icon"></div>Crop</h4>\n    <p class="aspect_title">Aspect Ratio</p>\n    <ul class="aspects">\n    </ul>\n  </section>\n</div>\n\n<footer>\n  <div class="cancel">\n    <span>Cancel</span>\n  </div>\n  <div class="apply orange-btn disabled">Apply</div>\n</footer>\n<div class="disabled_block"></div>\n'}}.call(this),function(){var e;ThisLife.View.FullView.Crop.Aspects=Backbone.View.extend({tagName:"ul",className:"aspects",events:{"click .rotate_control":"rotate"},initialize:function(e){return null==e&&(e={}),this.model=e.model,this.originalRatio=e.originalRatio,this.createAspectRatioItems(e.aspectRatios),this.render()},render:function(){var t,i,n,o,s,r,l,a;for(this.aspectViews=[],l=this.aspectRatioItems,n=0,s=l.length;s>n;n++)t=l[n],this.aspectViews.push(new e({aspect:t,rotated:this.model.get("rotated")}));for(this.updateActiveForCurrentRatio(),a=this.aspectViews,o=0,r=a.length;r>o;o++)i=a[o],this.el.appendChild(i.el);return this.el.insertAdjacentHTML("beforeend",this.rotateControlTemplate()),this.cacheElements(),this.bindEvents(),this},reRender:function(){for(this.unbindEvents();this.el.firstChild;)this.el.removeChild(this.el.firstChild);return this.render()},cacheElements:function(){return this.rotateControlEl=this.el.querySelector(".rotate_control")},bindEvents:function(){var e,t,i,n,o;for(n=this.aspectViews,o=[],t=0,i=n.length;i>t;t++)e=n[t],o.push(e.on("click",this.setActive,this));return o},unbindEvents:function(){var e,t,i,n,o;for(n=this.aspectViews,o=[],t=0,i=n.length;i>t;t++)e=n[t],o.push(e.off(null,null,this));return o},resetToOriginal:function(){return this.disabled?void 0:(this.model.set({aspectRatio:this.originalRatio,original:!0,free:!1},{silent:!0}),this.updateActiveForCurrentRatio(),this.model.trigger("change",this.model))},createAspectRatioItems:function(e){var t,i,n,o;for(this.aspectRatioItems=[],this.aspectRatioItems.push({label:"Original",original:!0}),this.aspectRatioItems.push({label:"FREE",free:!0}),o=[],i=0,n=e.length;n>i;i++)t=e[i],o.push(this.aspectRatioItems.push(t));return o},updateActiveForCurrentRatio:function(){return this.setActive(this.getActiveViewForCurrentRatio(),!0)},getActiveViewForCurrentRatio:function(){var e,t,i,n,o,s,r;for(r=this.aspectViews,o=0,s=r.length;s>o;o++){if(n=r[o],t=n.aspect,this.model.get("original")&&t.original){e=n;break}if(this.model.get("free")&&t.free){e=n;break}if(i=this.model.get("rotated")?1/t.ratio:t.ratio,ThisLife.Helper.Math.nearlyEqual(i,this.model.get("aspectRatio"))){e=n;break}}return e},rotate:function(){return this.rotateTimeout?void 0:(this.el.className="aspects transition",this.model.get("rotated")?(this.el.classList.add("rotate_ccw"),this.rotateControlEl.classList.add("portrait")):(this.el.classList.add("rotate_cw"),this.rotateControlEl.classList.add("portrait")),this.rotateTimeout=setTimeout(function(e){return function(){return e.model.set(e.model.get("free")||e.model.get("original")||1===e.model.get("aspectRatio")?{rotated:!e.model.get("rotated")}:{aspectRatio:1/e.model.get("aspectRatio"),rotated:!e.model.get("rotated")}),e.reRender(),e.el.className="aspects",clearTimeout(e.rotateTimeout),e.rotateTimeout=null}}(this),250))},setActive:function(e,t){var i,n,o,s;if(!this.disabled||t){for(this.currentAspect=e.aspect,s=this.aspectViews,n=0,o=s.length;o>n;n++)i=s[n],i.setActive(!1);return e.setActive(!0),this.activeChanged()}},disable:function(e){return this.disabled=e},activeChanged:function(){var e,t,i,n,o,s,r;for(r=this.aspectViews,o=0,s=r.length;s>o;o++)if(n=r[o],n.active){e=n;break}return t=e.aspect,t.original?this.model.set({aspectRatio:this.originalRatio,original:!0,free:!1}):t.free?this.model.set({aspectRatio:0,free:!0,original:!1}):(i=this.model.get("rotated")?1/t.ratio:t.ratio,this.model.set({aspectRatio:i,original:!1,free:!1}))},teardown:function(){var e,t,i,n;for(this.unbindEvents(),n=this.aspectViews,t=0,i=n.length;i>t;t++)e=n[t],e.teardown();return this.aspects=void 0,this.remove()},rotateControlTemplate:function(){return'<li class="rotate_control'+(this.model.get("rotated")?" portrait":"")+'">\n  <div class="portrait_frame frame"></div>\n  <div class="landscape_frame frame"></div>\n  <div class="arrow"></div>\n</li>'}}),e=Backbone.View.extend({tagName:"li",events:{click:"click"},initialize:function(e){return null==e&&(e={}),this.aspect=e.aspect,this.rotated=e.rotated,this.render()},render:function(){return this.el.insertAdjacentHTML("beforeend",this.template()),this.setActive(),this.setType()},click:function(){return this.trigger("click",this)},setType:function(){var e;return e="",this.aspect.free&&(e="free"),this.aspect.original&&(e="original"),e?this.el.classList.add(e):void 0},setActive:function(e){return this.active=e,this.active?this.el.classList.add("active"):this.el.classList.remove("active")},teardown:function(){return this.remove()},template:function(){var e,t,i,n;return t=this.aspect.label,i=54,this.aspect.original||this.aspect.free?(e=i,n=i):this.rotated?(e=i,n=Math.floor(i/this.aspect.ratio),t=this.aspect.rotatedLabel):(e=Math.floor(i/this.aspect.ratio),n=i),"<div style='width: "+n+"px; height: "+e+"px' class='crop_frame'><span>"+t+"</span></div>"}})}.call(this),function(){var e,t,i,n,o;e=2e3,ThisLife.View.App=Backbone.View.extend({el:"body",events:{"click #tl_modal_container":"removeSlideDowns"},initialize:function(){return new ThisLife.View.LoaderView,new ThisLife.View.PrimaryBar,new ThisLife.View.SecondaryBar,ThisLife.View.bottomBar=new ThisLife.View.BottomBar,this.startTime=(new Date).getTime(),$(window).blur(function(){var e,t,i,n,o;for(o=document.getElementsByTagName("video"),n=[],t=0,i=o.length;i>t;t++)e=o[t],n.push(e.pause());return n}),this.bindEvents()},bindEvents:function(){return ThisLife.PubSub.on("state:change",this.stateChanged,this),ThisLife.PubSub.on("modal:show",this.modalChanged,this),ThisLife.PubSub.on("modal:close",this.modalChanged,this)},stateChanged:function(e){var t;return(t=i(e))?(document.body.className=t.css,ThisLife.app.controller("selection").isActive()?document.body.classList.add("select_mode"):void 0):void 0},modalChanged:function(e){var i;return this.stateChanged(ThisLife.app.currentState),i=t(e),i?document.body.classList.add(i.css):void 0},removeSlideDowns:function(e){var t;switch(null!=(t=e.target)?t.id:void 0){case"js_download_apps":return!0;case"tl_modal_container":return $(".tl_modal_wrap_visible .close-btn").trigger("click")}},momentSyncError:function(){var e;return e=new ThisLife.View.ModalAlert({template:"getChangesSinceFail"}),document.body.appendChild(e.render().el)},confirmRefresh:function(e,t){var i;return i=new ThisLife.View.ModalAlert({template:"confirmRefreshView",callback:e,cancelCallback:t}),document.body.appendChild(i.render().el)},confirmLogout:function(e,t){var i;return i=new ThisLife.View.ModalAlert({template:"confirmLogoutView",callback:e,cancelCallback:t}),document.body.appendChild(i.render().el)},lifeNotFound:function(){var e;return e=new ThisLife.View.ModalAlert({template:"lifeNotFoundAlertTemplate",item:"logout"}),$(document.body).append(e.render().el)},invalidToken:function(){return ThisLife.app.session.expiredSession()},uncaughtError:function(e){var t;return null!=(t=this.errorView)&&t.teardown(),this.errorView=new ThisLife.View.Error({message:e}),this.errorView.show()}}),i=function(e){var t;return t=o[e.name],t&&t.sameAs&&(t=o[t.sameAs]),t},t=function(e){var t;return t=n[null!=e?e.name:void 0],t&&t.sameAs&&(t=n[t.sameAs]),t},o={library:{css:"library dayLibrary"},home:{css:"home"},people:{css:"people"},peopleFiltered:{css:"library dayLibrary filtered"},places:{css:"places"},placesFiltered:{sameAs:"peopleFiltered"},tags:{css:"tags"},tagsFiltered:{sameAs:"peopleFiltered"},storyFollowing:{sameAs:"story"},stories:{css:"stories"},storiesFollowing:{css:"stories following"},albums:{css:"albums"},timeline:{css:"timeline"},gifting:{css:"gifting"},migrationAlbums:{css:"migration_albums"}},n={settings:{css:"settings"},share:{css:"share"},storyInvites:{css:"share"},peopleEdit:{css:"people_edit"},peopleSuggestions:{css:"people_suggestions"},peopleChangeCover:{sameAs:"peopleEdit"},gifting:{css:"gifting"},personDetailRequest:{sameAs:"peopleSuggestions"}}}.call(this),function(){var e;ThisLife.View.PeopleView=Backbone.View.extend({el:".face_grid_center",initialize:function(){return _.bindAll(this,"render","addListItems"),this.groupCount=ThisLife.Model.suggestedGroupCount,this.facegridSize=0,this.peopleSectionSize=0,this.scrollTimer=null,this.permitScroll=!1,this.blockScroll=!1,this.usedRelationships=ThisLife.appModel.getUsedRelationships()||[],this.suggestionsState=1,this.showingPeopleScreen=!1,this.suggestions=[],this.hiddenSuggestions=[],this.howManyRelationshipsToShow=7,this.minSuggestionSize=10,this.userOpenedSuggestionArea=!1,this.showingGuide=!1,this.inDrag=!1,this.bindEvents(),ThisLife.Helper.Features.whenReady("upp",function(e){return function(t){return e.useUPP=t,e.initRelationships(function(){return e.render()})}}(this)),ThisLife.PubSub.trigger("peopleViewInitialized"),ThisLife.PubSub.on("edit_people:merge",this.doMerge,this)},events:{"click .people_suggestions_look_for_more":"showSmallSuggestions"},bindEvents:function(){var e;return e=_.debounce(_.bind(this.resize,this),50),ThisLife.PubSub.on("resize",e,this),ThisLife.PubSub.on("suggestion:drag",this.scrollOnDrag,this),ThisLife.PubSub.on("suggestion:stopdrag",this.stopScroll,this),ThisLife.PubSub.on("suggestion:reverting",this.blockScroll,this),ThisLife.PubSub.on("suggestion:removed",this.removeSuggestion,this),ThisLife.PubSub.on("relationships:changed",this.reRenderRelationships,this),ThisLife.PubSub.on("startDelay",this.onDelayStart,this),ThisLife.PubSub.on("cancelDelay",this.onDelayCancel,this),this.collection.on("reset",this.reRender,this).on("add",this.newListItem,this).on("remove",this.checkCollectionEmpty,this).on("change:is_vip",this.changedVip,this).on("sort",this.reRender,this),this.groupCount.on("change:count",this.onChangeGroupCount,this),ThisLife.Collection.moments.on("add",this.timelineChanged,this),ThisLife.Collection.moments.on("remove",this.timelineChanged,this)},initRelationships:function(e){var t;return t=ThisLife.Collection.personTags.pluck("relationship_type_uid"),_.each(t,function(){return function(e){return e?ThisLife.appModel.addUsedRelationship(e):void 0}}(this)),"function"==typeof e?e():void 0},initContainers:function(){return this.nonvip_section=this.el.querySelector(".non_vip_section"),this.suggestions_view=this.el.querySelector("#people_suggestions_container"),this.suggestions_wrapper=this.el.querySelector(".people_suggestions_wrapper"),this.suggestions_section=this.el.querySelector(".people_suggestions_section"),this.relationship_section=this.el.querySelector(".relationship_section"),this.relationship_section_regular=this.relationship_section.querySelector(".relationship_section_regular"),this.relationship_section_special=this.relationship_section.querySelector(".relationship_section_special"),this.people_sections=this.el.querySelector(".people_sections"),this.people_section_wrapper=this.el.querySelector(".people_sections_wrapper")},setSuggestionsSize:function(){var e;return 0===this.suggestions.length?(e=$("#tl_bottom_bar").height()+$("#tl_primary_bar").height()+1,void $(this.suggestions_section).hide()):($(this.suggestions_section).show(),e=$("#tl_bottom_bar").height()+$("#tl_primary_bar").height()+$("#tl_secondary_bar").height()+$(".secondary_bar_bg").height()+3,$(".people_suggestions_section").css("height",$(window).height()-e+"px"))},render:function(){return ThisLife.Collection.moments.whenLoaded(function(t){return function(){return t.face_grid=$("#face_grid"),t.secondary_bar=$(".secondary_bar"),t.people_section=$("#people_section"),0!==ThisLife.Collection.moments.getMomentCount()||t.useUPP?t.showingPeopleScreen?(t.timelineEmpty=!1,t.removeEmptyClasses(),t.reRender()):(t.timelineEmpty=!1,t.removeEmptyClasses(),t.showingPeopleScreen=!0,$(t.el).empty(),t.$el.append(e),t.initContainers(),t.renderCollection(),t.resizePeopleArea(),t.resizeFaceGrid(),ThisLife.appModel.getFirstTimePeopleGuide()&&0===t.collection.length&&"people"===ThisLife.app.currentState.name&&"add"!==ThisLife.app.currentState.fragment&&t.renderPeopleGuide(),t.makePeopleSectionDroppable()):(t.timelineEmpty=!0,t.showEmptyView())}}(this)),this.setSuggestionsSize()},addEmptyClasses:function(){var e;return $(this.people_section).addClass("no-faces"),null!=(e=document.querySelector(".search_people_input"))?e.disabled=!0:void 0},removeEmptyClasses:function(){var e;return $(this.people_section).removeClass("no-faces"),null!=(e=document.querySelector(".search_people_input"))?e.disabled=!1:void 0},showEmptyView:function(){return this.showingPeopleScreen=!1,$(this.el).empty(),this.addEmptyClasses(),this._uploadView=ThisLife.app.controller("timeline").upload({widgets:["EmptyPeople"]}),this.el.appendChild(this._uploadView.el)},renderCollection:function(){return ThisLife.Collection.relationships.whenLoaded(this.reRenderRelationships,this),this.collection.length?(this.hideSuggestionsHeader(),this.collection.each(this.addListItems)):void 0},reRender:function(){return 0!==ThisLife.Collection.moments.getMomentCount()||this.useUPP?($(this.nonvip_section).empty(),this.emptyRelationships(),this.renderCollection()):(this.timelineEmpty=!0,this.showEmptyView()),this},setPageScrollAreas:function(){return this.topScrollLine=this.face_grid.offset().top+10,this.bottomScrollLine=this.topScrollLine+this.face_grid.height()-15-120},canScroll:function(){return this.permitScroll&&!this.blockScroll},stopScroll:function(){return this.permitScroll=!1,clearTimeout(this.scrollTimer)},blockScroll:function(){return this.blockScroll=!0,this.stopScroll(),this.delay(200,function(e){return function(){return e.blockScroll=!1}}(this))},scrollWindow:function(e,t){var i,n;return null==t&&(t=!1),i=t?30:10,this.canScroll(e)&&(n=this.face_grid.scrollTop(),n+="up"===e?-1*i:i,this.face_grid.scrollTop(n)),clearTimeout(this.scrollTimer),this.scrollTimer=this.delay(100,function(t){return function(){return t.scrollWindow(e,!0)}}(this))},scrollOnDrag:function(e){return e.top<=1.05*this.topScrollLine?(this.permitScroll=!0,clearTimeout(this.scrollTimer),this.scrollTimer=this.delay(200,function(e){return function(){return e.scrollWindow("up")}}(this))):e.top>=.9*this.bottomScrollLine&&e.top<=1.1*this.bottomScrollLine?(this.permitScroll=!0,clearTimeout(this.scrollTimer),this.scrollTimer=this.delay(200,function(e){return function(){return e.scrollWindow("down")}}(this))):(this.permitScroll=!1,clearTimeout(this.scrollTimer)),this},renderPeopleGuide:function(){return this.suggestedGuideView?void 0:(this.showingGuide=!0,this.suggestedGuideView=new ThisLife.View.PeopleGuide,$("body").append(this.suggestedGuideView.render().el))},makePeopleSectionDroppable:function(){return $(".people_sections").droppable({tolerance:"intersect",greedy:!0,activeClass:"droppable",drop:function(e,t){return $(t.helper).remove()}})},changedVip:function(e){var t;return t=this.collection.where({is_vip:e.get("is_vip")}).indexOf(e),this.newListItem(e,this.collection,{index:t}),this
},resize:function(){return this.resizeSuggestionsArea(!0),this.resizePeopleArea(),this.resizeFaceGrid()},addListItems:function(e){var t;return t=new ThisLife.View.PeopleListView({model:e}),$(this.nonvip_section).append(t.render().el),this.bindPersonListDragEvents(t)},bindPersonListDragEvents:function(e){return e.on("start:drag",function(e){return function(){return e.inDrag=!0}}(this)),e.on("stop:drag",function(e){return function(){return e.inDrag=!1}}(this))},timelineChanged:function(){return 0!==ThisLife.Collection.moments.getMomentCount()||this.timelineEmpty?ThisLife.Collection.moments.getMomentCount()>=1&&this.timelineEmpty?(this.timelineEmpty=!1,this.render()):void 0:(this.timelineEmpty=!0,this.render())},newListItem:function(e,t,i){var n,o,s,r,l;return this.collection.length&&this.hideSuggestionsHeader(),l=new ThisLife.View.PeopleListView({model:e}),s=(null!=i.index||0)-1,n=this.nonvip_section,-1===s?(r=$(n).find("div.relationship_card"),r.length>0?$(r).after(l.render().el):$(n).prepend(l.render().el)):(o=$(n).find("div.person_card").get(s),o?$(o).after(l.render().el):this.reRender())},onChangeGroupCount:function(e){return this.showingPeopleScreen?e.hasSuggestions()?this.showSuggestionsArea():(this.hideSuggestionsArea(),this.hideLoadingTitle()):this.render()},onDelayStart:function(){return 1===this.suggestions.length&&(this.hideSuggestionsArea(),this.hideLoadingTitle(),this.showNoSuggestionsTitle()),this.resizeSuggestionsArea(!0)},onDelayCancel:function(){return 1===this.suggestions.length&&(this.showSuggestionsArea(),this.hideNoSuggestionsTitle()),this.resizeSuggestionsArea(!0)},getFacegroup:function(e){return function(t,i,n){return ThisLife.Service.api.getSuggestedFaceGroup(t,function(e){return"function"==typeof n&&n(e),i.resolve()}),e}}(this),getFacesBatch:function(e,t,i){return ThisLife.Service.api.getSuggestedFaceGroupChunk(e,t,function(){return function(e){return"function"==typeof i?i(e):void 0}}(this)),this},doMerge:function(e){var t,i,n;return t=require("ThisLife.People.Controllers.Merge"),e.source!==e.dist?(i=new t,n={source:e.source,dest:e.dist},null!=e.cancelCallback&&(n.cancelCallback=e.cancelCallback),i.renderView(n)):void 0},delay:function(e,t){return setTimeout(t,e)},hideLoadingTitle:function(){return $(".people_suggestions_section .people_suggestions_loading_suggestions").hide(),0===this.suggestions.length?($(this.suggestions_section).hide(),$(".people_suggestions_section .people_suggestions_look_for_more_wrapper").show(),$(".people_suggestions_section .suggestions-title").hide(),$(this.suggestions_wrapper).hide()):$(this.suggestions_section).show()},showNoSuggestionsTitle:function(){return $(".people_suggestions_section .suggestions-title").hide(),$(".people_suggestions_section .people_suggestions_look_for_more_wrapper").show()},hideNoSuggestionsTitle:function(){return $(".people_suggestions_section .people_suggestions_loading_suggestions").hide(),$(".people_suggestions_section .people_suggestions_look_for_more_wrapper").hide(),$(".people_suggestions_section .suggestions-title").show(),$(this.suggestions_wrapper).show()},hideSuggestionArrows:function(){return $(".people_suggestions_arrow_left").hide(),$(".people_suggestions_arrow_right").hide()},showSuggestionArrows:function(){return $(".people_suggestions_arrow_left").show(),$(".people_suggestions_arrow_right").show()},hideSuggestionsArea:function(){return this},showSuggestionsArea:function(e){return null==e&&(e=!1),e&&($(this.people_section_wrapper).removeClass("move-down"),this.showingGuide=!1),this.showingGuide||(this.suggestionsState=1,this.toggleSuggestionsVisibility(!1,!0)),this},resizeSuggestionsArea:function(e){var t,i;return 0===this.suggestions.length&&0===this.hiddenSuggestions.length?void $(this.suggestions_section).hide():($(this.suggestions_section).show(),this.showSuggestionsArea(),t=124*this.suggestions.length+30,$(this.suggestions_view).css({height:t+"px"}),t>$(".people_suggestions_section").height()?($(this.suggestions_view).css({"margin-left":"","margin-right":"","float":"left"}),i={wheelSpeed:1,suppressScrollX:!0,maxScrollbarLength:200,minScrollbarLength:50,useKeyboard:!1},this.showSuggestionArrows(),$(this.suggestions_wrapper).hasClass("ps-container")||(e=!1),$(this.suggestions_wrapper).perfectScrollbar(e?"update":i),this.suggestionsScroller=$(this.suggestions_wrapper).children(".ps-scrollbar-x-rail"),this.bindArrowsForSuggestionsScroll()):(this.hideSuggestionArrows(),$(this.suggestions_view).css({"margin-left":"auto","margin-right":"auto","float":"none"})),this.setSuggestionsSize(),this)},resizePeopleArea:function(){var e,t;return t=.95*$(this.people_section_wrapper).width(),e=($(this.people_section_wrapper).width()-t)/2,$(this.people_sections).css({width:t+"px","margin-left":e+"px"}),this.resizeRelationshipSection(this.howManyRelationshipsToShow,t),this},resizeFaceGrid:function(){var e;return e=$(window).width(),$(this.suggestions_section).is(":visible")&&(e-=$(this.suggestions_section).width()),this.peopleSectionSize!==e&&($(this.people_section_wrapper).css({width:e+"px"}),this.peopleSectionSize=e),this.face_grid&&this.setPageScrollAreas(),this.resizePeopleArea()},animateSuggestionsScroll:function(e){return $(this.suggestionsScroller).hide(),$(this.suggestions_wrapper).animate({scrollTop:e},200,"linear",function(e){return function(){return $(e.suggestions_wrapper).perfectScrollbar("update"),$(e.suggestionsScroller).fadeIn(100)}}(this)),this.currentScrollPosition=e},bindArrowsForSuggestionsScroll:function(){return this.currentScrollPosition=0,this.maxScroll=$(this.suggestions_view).height()-$(window).height(),$(".people_suggestions_arrow_left").off().on("click",function(e){return function(){var t;return e.currentScrollPosition=e.suggestions_wrapper.scrollTop,t=e.currentScrollPosition-200<0?0:e.currentScrollPosition-200,e.animateSuggestionsScroll(t)}}(this)),$(".people_suggestions_arrow_right").off().on("click",function(e){return function(){var t;return e.currentScrollPosition=e.suggestions_wrapper.scrollTop,t=e.currentScrollPosition+200>e.maxScroll?e.maxScroll:e.currentScrollPosition+200,e.animateSuggestionsScroll(t)}}(this))},clearSuggestionsArea:function(){return $(this.suggestions_view).empty()},removeSuggestion:function(e){var t;return t=function(t){return t.id===e.id},this.suggestions=_.reject(this.suggestions,t),this.resizeSuggestionsArea(!0),ThisLife.Model.suggestedGroupCount.decreaseCount(),0===this.suggestions.length&&(this.hideSuggestionsArea(),this.hideLoadingTitle(),this.showNoSuggestionsTitle()),this},hideSuggestionsHeader:function(){return this.removeEmptyClasses(),this.setSuggestionsSize()},showSuggestionsHeader:function(){return this.addEmptyClasses(),this.setSuggestionsSize()},checkCollectionEmpty:function(){return this.collection.length?void 0:this.showSuggestionsHeader()},toggleSuggestionsVisibilityWrapper:function(){return $(this.suggestions_section).hasClass("partial-hide")&&(this.userOpenedSuggestionArea=!0),this.toggleSuggestionsVisibility(!1,!1)},toggleSuggestionsVisibility:function(e,t){return null==e&&(e=!1),null==t&&(t=!1),!$(this.suggestions_section).hasClass("partial-hide")&&!t||e?(this.suggestionsState=0,$(this.suggestions_section).addClass("partial-hide"),this.delay(200,function(e){return function(){return e.resizeFaceGrid()}}(this))):($(this.suggestions_section).removeClass("partial-hide"),ThisLife.Model.suggestedGroupCount.hasSuggestions()||this.showNoSuggestionsTitle(),this.delay(200,function(e){return function(){return e.resizeFaceGrid()}}(this)))},filterHiddenFaces:function(e){var t;return t=_.filter(e.get("faces"),function(){return function(e){var t;return(null!=(t=ThisLife.Collection.moments.get(e.moment_uid))?t.get("hidden"):void 0)===!1}}(this)),e.set("faces",t)},showSmallSuggestions:function(){return this.suggestions=this.hiddenSuggestions,this.resizeSuggestionsArea(!1),this.hideNoSuggestionsTitle(),this.suggestions.forEach(function(e){return function(t){var i;return i=new ThisLife.View.PeopleSuggestedListView({model:t,removeCallback:_.bind(e.removeSuggestion,e),parentView:e}),$(e.suggestions_view).append(i.render().el)}}(this))},getRelationById:function(e){var t;return t=null,ThisLife.Collection.relationships.each(function(){return function(i){return i.get("uid")===e?t=i:void 0}}(this)),t},addRelationshipItems:function(){var e;return e=function(){var e,t,i;return i=["01","05","04","07","06","02","03","09","08","19","20"],e=0,t=new ThisLife.View.RelationshipListView({model:new Backbone.Model({name:"New Person",uid:null})}),$(this.relationship_section_regular).append(t.render().el),i.forEach(function(t){return function(i){var n,o;return e<t.howManyRelationshipsToShow&&!_.contains(t.usedRelationships,i)&&(n=t.getRelationById(i),null!=n)?(o=new ThisLife.View.RelationshipListView({model:n}),$(t.relationship_section_regular).append(o.render().el),e++):void 0}}(this)),this.howManyRelationshipsToShow=e,this.resizePeopleArea()},ThisLife.Collection.relationships.whenLoaded(e,this)},resizeRelationshipSection:function(e,t){var i;return this.relationship_section_regular?(t=Math.ceil(t),i=Math.max(144*Math.min(Math.floor(t/144),e+1)-144,144),$(this.relationship_section_regular).css("width",i),$(this.relationship_section).css("width",Math.ceil($(this.relationship_section_regular).width()+0))):void 0},reRenderRelationships:function(){return this.usedRelationships=ThisLife.appModel.getUsedRelationships()||[],this.emptyRelationships(),this.addRelationshipItems()},emptyRelationships:function(){return $(this.relationship_section_regular).empty(),$(this.relationship_section_special).empty()}}),e=function(){return"<div class='people_suggestions_section '>\n  <h6 class=\"suggestions-title\">New Suggestions\n    <hr></hr>\n  </h6>\n  <div class='people_suggestions_loading_suggestions'>\n    Loading suggestions...\n  </div>\n  <div class='people_suggestions_look_for_more_wrapper'>\n    <div class=\"people_suggestions_look_for_more_title\">No more suggestions</div>\n    <!-- div class=\"people_suggestions_look_for_more\">Look for more</div-->\n  </div>\n  <div class='people_suggestions_wrapper'>\n    <div class='people_suggestions' id='people_suggestions_container'></div>\n  </div>\n</div>\n<div class='people_sections_wrapper'>\n  <div class='people_sections'>\n      <h3>To start just drag & drop faces</h3>\n      <br style=\"clear:both;\"/>\n      <div class='relationship_section'>\n        <div class='relationship_section_special'></div>\n        <div class='relationship_section_regular'></div>\n      </div>\n      <br style=\"clear:both;\"/>\n      <div class='non_vip_section'></div>\n  </div>\n</div>"}}.call(this),function(){var e,t;e=Backbone.View.extend({className:"tl_modal_wrap tl_modal_wrap_visible",id:"tl_suggestion",events:{"click .close-btn":"teardown","click .modal_close":"tl_close_modal","click .close-btn":"closeModal","click .tl_modal_bottom_right a.porcelain-btn":"uncrossAll","click .face_identify_grid:not(.select_front_image) li":"crossOut","click .person_name":"editName","blur  .person_name":"blurName","keypress .person_name":"keypressName","click  .close_icon":"clearName","click .info.relationship .text":"editRelationship","click .info.bday .text":"editBirthdate","click .info.editable :not(.text):not(.default_label)":"preventDefault","click .btn_gift_info":"toggleGiftTooltip","click #git_into_tooltip_got_it_btn":"giftTooltipGotIt","click .btn_show_gift_info":"showGiftModal","click #add_face_right":"addSuggestionFaces","click p.suggestion-wrong":"showEmptyForm","focus input.person_name":"setupAutocomplete"},initialize:function(e){return this.options=null!=e?e:{},this.model=this.options.model,this.relationshipId=null,this.personTagId=null,this.dropType="normal",this.suggestionType="named",this.name=null,this.uid=null,this.chosenRelationship=null,this.chosenMonth=null,this.chosenDate=null,this.chosenYear=null,this.chosenEmail=null,this.defaultPlaceHolder="Type a name",this.defaultBirthdayText="Select birthday",this.parseInput(),this.crossed=0,_.bindAll(this,"saveName","remove"),this.personPubSub=_.extend({},Backbone.Events),this.bindEvents(),this.selectedFaces=[],this.mode="normal",this.logger=new ThisLife.Model.LogPeopleSuggestions(null,{action:"tagface",lifeUid:ThisLife.lifeUid,personUid:this.model.get("uid")}),this.giftTooltipShown=!1,this.giftTooltipWatchedOnce=!1,this.nameErrorTooltipShown=!1,this.avatarFromExistingPerson=!1,"onRelationship"!==this.dropType&&"named"===this.suggestionType||"onPersonTag"===this.dropType?this.getRelationshipForPerson(this.uid,function(e){return function(){return e.renderAfterRelationshipsLoaded()}}(this)):this.renderAfterRelationshipsLoaded(),this.initLogger()},initLogger:function(){var e,t;return t=(null!=(e=this.model.get("parentView"))?e.suggestions.length:void 0)||0,this.logger.setDefaultParams(t,0,this.model.get("faces").length,this.model.id),this.logger.setNameWasCorrect("named"===this.suggestionType),this.logger.setIsNewPerson("named"!==this.suggestionType),this},renderAfterRelationshipsLoaded:function(){return ThisLife.Collection.relationships.loaded?this.render():ThisLife.Collection.relationships.on("reset",this.render,this)},parseInput:function(){var e,t;return null!=this.options.relationshipId&&(this.relationshipId=this.options.relationshipId,this.dropType="onRelationship",this.chosenRelationship=this.relationshipId),null!=this.options.personTagId&&(this.personTagId=this.options.personTagId,this.dropType="onPersonTag"),this.suggestionType=("function"==typeof(e=this.model).isNamed?e.isNamed():void 0)||"onPersonTag"===this.dropType?"named":"unnamed","onPersonTag"===this.dropType?(t=ThisLife.Collection.personTags.get(this.personTagId),this.initializeFromPersonTag(t)):this.initializeFromModel(this.model)},initializeFromModel:function(e){var t;return e.isNamed()?(t=e.get("person_tag"),this.name=t.name,this.chosenDate=t.birth_date,this.chosenMonth=t.birth_month,this.chosenYear=t.birth_year,this.uid=t.uid):this.uid=e.id},initializeFromPersonTag:function(e){return this.name=e.get("name"),this.chosenDate=e.get("birth_date"),this.chosenMonth=e.get("birth_month"),this.chosenYear=e.get("birth_year"),this.uid=e.get("uid")},initializeDropdowns:function(){var e,t,i,n,o;return e=this.chosenMonth||ThisLife.Helper.String.pad((new Date).getMonth(),2),null!=(t=this.relationshipDD)&&t.teardown(),this.relationshipDD=new ThisLife.View.CustomSelect({id:"relationship_dropdown",defaultText:"Select relationship",source:ThisLife.Collection.relationships.getGroupedCollection(),selected:this.chosenRelationship,longText:!0}),this.relationshipWrapEl.querySelector(".dropdown").appendChild(this.relationshipDD.el),this.relationshipDD.selectItem(this.chosenRelationship),this.relationshipDD.on("selected",this.onRelationshipSelect,this),this.relationshipDD.on("opened",this.closeEditBirthdate.bind(this,!1),this),null!=(i=this.monthDD)&&i.teardown(),this.monthDD=new ThisLife.View.MonthCustomSelect({id:"month_dropdown",defaultText:"Month",selected:this.chosenMonth}),this.birthdayWrapEl.querySelector(".dropdown").appendChild(this.monthDD.el),this.monthDD.selectItem(this.chosenMonth),this.monthDD.on("selected",this.onMonthSelect,this).on("opened",this.onMonthOpened,this),null!=(n=this.dayDD)&&n.teardown(),this.dayDD=new ThisLife.View.NumericCustomSelect({id:"day_dropdown",defaultText:"Day",rangeStart:1,rangeEnd:ThisLife.Helper.Date.daysInMonth(e),rangeMinStringLength:2,selected:this.chosenDate,enableDefaultItem:!0}),this.birthdayWrapEl.querySelector(".dropdown").appendChild(this.dayDD.el),this.dayDD.selectItem(this.chosenDate),this.dayDD.on("selected",this.onDateSelect,this).on("opened",this.onDayOpened,this),null!=(o=this.yearDD)&&o.teardown(),this.yearDD=new ThisLife.View.NumericCustomSelect({id:"year_dropdown",defaultText:"Year",rangeStart:(new Date).getFullYear(),rangeEnd:1900,selected:this.chosenYear,enableDefaultItem:!0}),this.birthdayWrapEl.querySelector(".dropdown").appendChild(this.yearDD.el),this.yearDD.selectItem(this.chosenYear),this.yearDD.on("selected",this.onYearSelect,this).on("opened",this.onYearOpened,this)},bindEvents:function(){return ThisLife.PubSub.on("modal:close",this.remove,this),this.model.on("change:name change:email",this.renderName,this).on("change:face change:icon_url",this.changeFaceUrl,this).on("remove",this.teardown,this),this.personPubSub.on("face:selected",this.onFaceSelected,this),ThisLife.Support.keyInformant.on("cancel",this.teardown,this)},getBirthdate:function(){var e;return e=ThisLife.Helper.Date.formatBirthdate(this.chosenMonth,this.chosenDate,this.chosenYear),e||this.defaultBirthdayText},hasBirthdate:function(){var e;return e=ThisLife.Helper.Date.formatBirthdate(this.chosenMonth,this.chosenDate,this.chosenYear),e?!0:!1},hasRelationship:function(){return null!==this.chosenRelationship?!0:!1},getImageUrl:function(e){var t;return null!=e.center_x||null!=e.x?ThisLife.Helper.Image.faceUrl(e.uid):(t=e.moment_uid,this.moment||(this.moment=ThisLife.Collection.moments.get(t)),this.moment?this.moment.getImageSize("x-small"):ThisLife.Helper.Image.faceUrl(e.uid))},getModelFace:function(){var e,t;return t=this.model.get("faces"),e=0,$.each(t,function(t){return function(i,n){return _.indexOf(t.selectedFaces,n.uid)>-1?!0:(e=i,!1)}}(this)),t[e]},updateSuggestionAvatar:function(e){var t;return null==e&&(e=null),"named"===this.suggestionType?(t=this.model.get("person_tag").icon_url,$(".person_face.suggested_person_face").css("background-image","url("+t+")")):this.avatarFromExistingPerson||(t=e||this.getImageUrl(this.getModelFace()),$(".person_face.suggested_person_face").css("background-image","url("+t+")")),t},render:function(){var e;return e={uid:this.uid,name:ThisLife.Helper.String.escapeHtml(this.name),btnText:this.getAddBtnText(),dateFormatted:this.getBirthdate(),hasFullPersonData:!1,suggestionType:this.suggestionType,url:this.updateSuggestionAvatar()||this.getImageUrl(this.getModelFace())},this.$el.html(ThisLife.Templates.suggestedPeople("suggestionTemplate",e)),this.cacheElements(),this.initializeDropdowns(),this.getFaces(),ThisLife.Collection.relationships.off("reset",this.render,this),_.defer(function(e){return function(){return"unnamed"===e.suggestionType?e.nameEl.focus():void 0}}(this))},getAddBtnText:function(){var e,t;return e=this.model.get("faces").length-this.crossed,t=1===e?"":"s","Add "+e+" Face"+t},updateAddBtnText:function(){return this.model.get("faces").length-this.crossed>0?(this.addFacesBtn.innerHTML=this.getAddBtnText(),$(this.addFacesBtn).hasClass("disabled")?ThisLife.Helper.DOM.addRemoveClass(this.addFacesBtn,!1,"disabled"):void 0):(this.addFacesBtn.innerHTML=this.getAddBtnText(),ThisLife.Helper.DOM.addRemoveClass(this.addFacesBtn,!0,"disabled"))},cacheElements:function(){return this.suggestionHeaderEl=this.el.querySelector(".suggestion_row"),this.nameWrapEl=this.el.querySelector(".suggestion_row .header"),this.nameEl=this.nameWrapEl.querySelector(".person_name"),this.personFaceEl=this.el.querySelector(".person_face"),this.faceIdentifyGridEl=this.el.querySelector(".face_identify_grid"),this.relationshipWrapEl=this.el.querySelector(".suggestion_row .info.relationship"),this.birthdayWrapEl=this.el.querySelector(".suggestion_row .info.bday"),this.giftTooltipEl=this.el.querySelector(".gift_info_tooltip"),this.addFacesBtn=this.el.querySelector("#add_face_right")},shorthand:function(e){var i,n,o;return o=this,n=_.bind(this.processAutocomplete,this),i={source:ThisLife.Service.api.combineContacts().toJSON(),value:"name",parent:this.$(".face_identify_dropdown-scroll-area"),num:4,show:function(){return o.$("#face_identify_dropdown-people").show(),$.fn.shorthand.Constructor.prototype.show.call(this)},sorted:!1,hide:function(){return o.$("#face_identify_dropdown-people").hide(),$.fn.shorthand.Constructor.prototype.hide.call(this)},template:t,menu:'<ul class="people_dropdown suggestions"></ul>',selectCallback:n,caseSensitive:!1,blurTimeout:300},e.shorthand(i)},setupAutocomplete:function(){var e;return e=this.el.querySelector("input.person_name"),e.shorthand||this.shorthand($(e)),e},blurAutocomplete:function(){return setTimeout(function(){return this.$("#face_identify_dropdown-people").hide()},1e3)},processAutocomplete:function(e){var t;return ThisLife.log.debug(">> element",e.data().item),(t=e.data().item)?(this.chosenEmail=null,t.hasOwnProperty("uid")?null===t.uid?(ThisLife.log.debug(" >> uid == null, selected login user",t),this.chosenEmail=t.email,this.chosenRelationship="01",this.relationshipDD.selectItem(this.chosenRelationship),this.nameEl.blur(),void(this.name=t.name)):(this.relationshipDD.resetSelection(),this.getRelationshipForPerson(t.uid,function(e){return function(){var i;return e.chosenRelationship&&e.relationshipDD.selectItem(e.chosenRelationship),e.chosenMonth=t.birth_month,e.chosenDate=t.birth_date,e.chosenYear=t.birth_year,null!=e.chosenMonth?e.monthDD.selectItem(e.chosenMonth):e.monthDD.resetSelection(),null!=e.chosenDate?e.dayDD.selectItem(e.chosenDate):e.dayDD.resetSelection(),null!=e.chosenYear?e.yearDD.selectItem(e.chosenYear):e.yearDD.resetSelection(),i=ThisLife.Helper.Date.formatBirthdate(e.chosenMonth,e.chosenDate,e.chosenYear).trim(),e.birthdayWrapEl.querySelector(".text .dateStr").textContent=i||e.defaultBirthdayText,$(e.suggestionHeaderEl).find(".nameRow").hide(),e.name=t.name,e.$(".partial_row_wrapper").html(ThisLife.Templates.suggestedPeople("partialRowTemplate",{name:t.name,display:"block"})),(null!=t?t.face:void 0)?(e.updateSuggestionAvatar(t.face),e.avatarFromExistingPerson=!0):void 0}}(this))):(ThisLife.log.debug(" >> Problem with processAutocomplete() [has no uid]",t),void this.nameEl.blur())):void this.nameEl.blur()},getRelationshipForPerson:function(e,t){return ThisLife.Service.api.getPersonTags(e,"",function(e){return function(i){var n,o;return n=i.first(),null!=n&&(e.chosenRelationship=(null!=(o=n.get("relationship"))?o.relationship_type_uid:void 0)||null),"function"==typeof t?t():void 0}}(this))},getFaces:function(){return this.addLoader(),this.renderFaces()},showEmptyForm:function(){return this.resetSuggestionInput(),$(this.suggestionHeaderEl).find(".fullRow").hide(),$(this.suggestionHeaderEl).find(".partialRow").hide(),$(this.suggestionHeaderEl).find(".nameRow").show(),$(this.suggestionHeaderEl).find(".dropdownRow").show(),$(this.el).find(".gift_tooltip_wrapper").show(),_.defer(function(e){return function(){return e.nameEl.focus()}}(this)),this},resetSuggestionInput:function(){return this.nameEl.value="",this.name=null,this.resetRelationshipDropdown(),this.resetBirthdayDropdown(),this.avatarFromExistingPerson=!1,this.suggestionType="unnamed",this.updateSuggestionAvatar()},resetBirthdayDropdown:function(){return this.monthDD.resetSelection(),this.dayDD.resetSelection(),this.yearDD.resetSelection(),this.chosenMonth=null,this.chosenDate=null,this.chosenYear=null,this.birthdayWrapEl.querySelector(".text .dateStr").textContent=this.defaultBirthdayText},resetRelationshipDropdown:function(){return this.relationshipDD.resetSelection()},addLoader:function(){return this.el.classList.add("loading")},removeLoader:function(){return this.el.classList.remove("loading")},setMode:function(e){return"frontimage"===e?(this.selectedFaces=[],this.mode="frontimage"):this.mode="normal"},editName:function(){return this.nameErrorTooltipShown&&this.hideNameErrorTooltip(),ThisLife.Support.keyInformant.on("cancel",this.cancelEditName,this)},blurName:function(){return this.nameEl.value,""===this.nameEl.value&&(this.nameEl.placeholder=this.defaultPlaceHolder,this.name=null),this.saveName(this.nameEl.value)},keypressName:function(e){return ThisLife.Helper.Keyboard.isEnter(e.keyCode)?(e.preventDefault(),this.nameEl.blur()):void 0},resizeNameEl:function(){var e,t;return e=this.nameEl.value.length,t=this.nameEl.clientWidth,0===e?(this.nameEl.size=11,this.nameEl.style.textAlign="left"):(this.nameEl.size=24,this.nameEl.style.textAlign="center")},saveName:function(e){var t;return t=_.unescape(e.trim()),this.name=t,this.nameEl.textContent=t,this.nameWrapEl.classList.remove("editable"),ThisLife.Support.keyInformant.off("cancel",this.cancelEditName,this)},cancelEditName:function(){return this.nameEl.textContent=this.lastTagName,this.nameEl.placeholder=this.defaultPlaceHolder,this.nameWrapEl.classList.remove("editable"),this.nameEl.blur()},clearName:function(){return this.nameEl.textContent="",this.nameEl.focus()},preventDefault:function(e){return e.preventDefault()},stopPropagation:function(e){return e.stopPropagation()},editRelationship:function(){return this.closeAllRowEdits(),this.blurRelationship=ThisLife.blurEvent(this.relationshipWrapEl,_.bind(this.closeEditRelationship,this))},editBirthdate:function(){return this.closeAllRowEdits(),this.birthdayWrapEl.classList.add("editable")},closeAllRowEdits:function(){return this.closeEditRelationship(!1),this.closeEditBirthdate(!1),this.hideGiftTooltip()},closeEditRelationship:function(e){return null==e&&(e=!0),this.relationshipDD.isOpen()&&this.relationshipDD.close(e),this.blurRelationship?ThisLife.removeBlurEvent(this.blurRelationship):void 0},closeEditBirthdate:function(e){var t;return null==e&&(e=!0),this.dayDD.isOpen()||this.monthDD.isOpen()||this.yearDD.isOpen()?(this.dayDD.close(e),this.monthDD.close(e),this.yearDD.close(e),e?_.delay(function(e){return function(){return e.birthdayWrapEl.classList.remove("editable")}}(this),200):this.birthdayWrapEl.classList.remove("editable")):this.birthdayWrapEl.classList.remove("editable"),t=ThisLife.Helper.Date.formatBirthdate(this.chosenMonth,this.chosenDate,this.chosenYear).trim(),this.birthdayWrapEl.querySelector(".text .dateStr").textContent=t||this.defaultBirthdayText,this.blurBirthdate?ThisLife.removeBlurEvent(this.blurBirthdate):void 0},getRelationshipName:function(e){return ThisLife.Collection.relationships.getNameByUid(e)||"Relationship"},onRelationshipSelect:function(e){return e?(this.chosenRelationship=e,_.delay(function(t){return function(){return t.relationshipWrapEl.querySelector(".text").textContent=t.getRelationshipName(e)}}(this),200),this):void 0},onMonthSelect:function(e){var t,i,n;return this.chosenMonth=e,"-"===e&&(e=ThisLife.Helper.String.pad((new Date).getMonth(),2)),n=this.chosenYear||(new Date).getYear(),n&&"-"!==n||(n=(new Date).getYear()),t=ThisLife.Helper.Date.daysInMonth(e,n),parseInt(t)!==parseInt(this.dayDD.options.rangeEnd)?(i=this.dayDD.getSelectionValue(),this.dayDD.updateRange(1,parseInt(t)),this.dayDD.selectItem(parseInt(i)>parseInt(t)?ThisLife.Helper.String.pad(t,2):ThisLife.Helper.String.pad(i,2))):void 0},onDateSelect:function(e){return this.chosenDate=e},onYearSelect:function(e){var t,i,n;return i=this.chosenMonth,i&&"-"!==i||(i=ThisLife.Helper.String.pad((new Date).getMonth(),2)),this.chosenYear=e,"-"===e&&(e=(new Date).getYear()),t=ThisLife.Helper.Date.daysInMonth(i,e),parseInt(t)!==parseInt(this.dayDD.options.rangeEnd)?(n=this.dayDD.getSelectionValue(),this.dayDD.updateRange(1,parseInt(t)),this.dayDD.selectItem(parseInt(n)>parseInt(t)?ThisLife.Helper.String.pad(t,2):ThisLife.Helper.String.pad(n,2))):void 0},onMonthOpened:function(){return this.dayDD.close(),this.yearDD.close()},onDayOpened:function(){return this.monthDD.close(),this.yearDD.close()},onYearOpened:function(){return this.monthDD.close(),this.dayDD.close()},savePersonDate:function(){var e,t;return t=!1,e={uid:this.model.get("key")},null!==this.chosenYear&&this.chosenYear!==this.model.get("birth_year")&&(e.birth_year="-"===this.chosenYear?null:this.chosenYear,t=!0),null!==this.chosenDate&&this.chosenDate!==this.model.get("birth_date")&&(e.birth_date="-"===this.chosenDate?null:this.chosenDate,t=!0),null!==this.chosenMonth&&this.chosenMonth!==this.model.get("birth_month")&&(e.birth_month="-"===this.chosenMonth?null:this.chosenMonth,t=!0),t&&ThisLife.Service.api.savePersonTagBeta(e),t},savePersonRelationship:function(){var e;if(this.chosenRelationship)return e={person_tag_uid:this.model.get("key"),relationship_type_uid:this.chosenRelationship},ThisLife.Service.api.saveRelationship(e),ThisLife.appModel.addUsedRelationship(this.chosenRelationship)},renderFaces:function(){var e,t,i,n,o,s,r,l;if(t=this.model.get("faces"),this.removeLoader(),t.length){for(i=this.el.querySelector("#main_face_grid"),l=[],s=[],n=0,o=t.length;o>n;n++)e=t[n],r=new ThisLife.View.PersonThumbnail({face:e,autoLoadImage:!1,parentPubSub:this.personPubSub}),l.push(r),i.appendChild(r.render().el),s.push(setTimeout(function(){return this.lazyImageLoader=new ThisLife.Support.LazyImageLoader(i,l),this.lazyImageLoader.setup()},0));return s}},delay:function(e,t){return setTimeout(t,e)},onFaceSelected:function(e){return this.selectedFaceUid=e,"normal"===this.mode?_.indexOf(this.selectedFaces,e)>-1?this.selectedFaces=_.without(this.selectedFaces,e):this.selectedFaces.push(e):void 0},crossOut:function(e){var t;return t=e.currentTarget.classList.toggle("crossed"),t?this.crossed++:this.crossed--,this.checkCrossed(),this.updateAddBtnText(),this.updateSuggestionAvatar()},checkCrossed:function(){return this},tl_close_modal:function(){return this.crossed?this.tl_remove_faces():this.closeModal(!1)},uncrossAll:function(){var e,t,i,n;if(this.crossed=0,n=this.el.querySelectorAll("ul#main_face_grid li"),n.length)for(e=0,t=n.length;t>e;e++)i=n[e],i.classList.remove("crossed");return this.checkCrossed(),this},addSuggestionFaces:function(){var e,t,i,n,o,s,r,l;if(!$(this.addFacesBtn).hasClass("disabled"))return(r=this.name)?this.chosenRelationship&&this.hasBirthdate()||this.giftTooltipShown||ThisLife.appModel.getHideBirthdayTooltip()?(ThisLife.Helper.DOM.addRemoveClass(this.addFacesBtn,!0,"disabled"),t=_.pluck(this.model.get("faces"),"id"),o=this.selectedFaces,s=_.difference(t,o),this.logger.setAction("tagface"),this.logger.setCounts(s.length,o.length),this.logger.log(),null!=this.personTagId&&this.model.setSuggestionToExistingPersonTag(this.personTagId),this.chosenRelationship&&ThisLife.appModel.addUsedRelationship(this.chosenRelationship),l=ThisLife.Collection.personTags.findName(r),null!=l&&(e=this.model.get("faces").length-this.crossed,l.count+=e),n={count:s.length,birth_month:this.chosenMonth,birth_date:this.chosenDate,birth_year:this.chosenYear,email:this.chosenEmail},i=function(e){return function(){return e.closeModal(),e.model.updateFaces(s,o),e.savePersonDate(),e.savePersonRelationship(),ThisLife.PubSub.trigger("suggestion:removed",e.model)}}(this),this.model.updateSuggestedPerson(n,r,i),ThisLife.PubSub.trigger("updatePeopleCounts",this.model.get("key")),ThisLife.holdbackLoadDelayed=!1):(this.showGiftTooltip(),ThisLife.appModel.setHideBirthdayTooltip(),this.chosenRelationship||(this.relationshipBorder=this.relationshipWrapEl.querySelector(".component_wrap .default_label"),ThisLife.Helper.DOM.addRemoveClass(this.relationshipBorder,!0,"error-msg")),void(this.hasBirthdate()||(this.birthdayBorder=this.birthdayWrapEl.querySelector(".text"),ThisLife.Helper.DOM.addRemoveClass(this.birthdayBorder,!0,"error-msg")))):void(this.nameErrorTooltipShown||this.showNameErrorTooltip())},tl_delete_person:function(){var e,t;return e=function(t){return function(){var i;return i=new ThisLife.View.ModalAlert,document.body.appendChild(i.renderLoadingTemplate().el),e=ThisLife.Helper.Scripts.postpone(function(){return i.changeInnerHTML.call(i,"deletePerson",t.model),_.delay(function(){return i.teardown()},ThisLife.View.ModalAlert.CONFIRMATION_DELAY)},1e3),t.model.destroy(e)}}(this),t=new ThisLife.View.ModalAlert({template:"deletePersonView",callback:e}),document.body.appendChild(t.render().el)},tl_remove_faces:function(){var e,t,i,n;return e=this.$(".face_identify_grid li.crossed"),e.length?(i=this.selectedFaces,n=new ThisLife.View.ModalAlert,document.body.appendChild(n.renderLoadingTemplate().el),t=ThisLife.Helper.Scripts.postpone(function(t){return function(){return n.changeInnerHTML.call(n,"removeFaces",i.length),e.remove(),t.crossed=0,t.checkCrossed(),_.delay(function(){return n.teardown(),t.model.count-=i.length,t.model.trigger("count_changed")},ThisLife.View.ModalAlert.CONFIRMATION_DELAY)}}(this),1e3),this.model.updateFaces(null,i,null,t),this.selectedFaces=[],this.logger.setAction("untagface"),this.logger.setExcludeCount(i.length),this.logger.log()):void 0},toggleGiftTooltip:function(){return this.giftTooltipShown?this.hideGiftTooltip():this.showGiftTooltip()},showGiftTooltip:function(){return this.giftTooltipWatchedOnce=!0,this.el.querySelector(".gift_info_tooltip_background").style.display="block",this.el.querySelector(".gift_info_tooltip").style.display="block",this.giftTooltipShown=!0,this.blurGiftTooltip=ThisLife.blurEvent(this.giftTooltipEl,_.bind(this.hideGiftTooltip,this,!1))},hideGiftTooltip:function(e){return null==e&&(e=!1),this.el.querySelector(".gift_info_tooltip_background").style.display="",this.el.querySelector(".gift_info_tooltip").style.display="",this.giftTooltipShown=!1,this.blurGiftTooltip&&ThisLife.removeBlurEvent(this.blurGiftTooltip),null!=this.birthdayBorder&&$(this.birthdayBorder).hasClass("error-msg")&&ThisLife.Helper.DOM.addRemoveClass(this.birthdayBorder,!1,"error-msg"),null!=this.relationshipBorder&&$(this.relationshipBorder).hasClass("error-msg")&&ThisLife.Helper.DOM.addRemoveClass(this.relationshipBorder,!1,"error-msg"),e?this.editBirthdate():void 0
},giftTooltipGotIt:function(e){return e.stopPropagation(),this.hideGiftTooltip(!0)},showNameErrorTooltip:function(){return this.el.querySelector(".name_error_tooltip").style.display="block",ThisLife.Helper.DOM.addRemoveClass(this.nameEl,!0,"name-error"),this.nameErrorTooltipShown=!0},hideNameErrorTooltip:function(){return this.el.querySelector(".name_error_tooltip").style.display="",ThisLife.Helper.DOM.addRemoveClass(this.nameEl,!1,"name-error"),this.nameErrorTooltipShown=!1},showGiftModal:function(){var e;return this.hideGiftTooltip(),e=new ThisLife.View.ModalAlert({template:"remindBirthday",callback:null,cancelCallback:this.addSuggestionFaces.bind(this)}),document.body.appendChild(e.render().el)},changeFaceUrl:function(){var e;return e=this.model.getDefaultFaceUrl(),this.personFaceEl.style.backgroundImage="url("+e+")"},closeModal:function(e){return null==e&&(e=!0),e?this.teardown():void 0},teardown:function(){return this.el.classList.remove("tl_modal_wrap_visible"),document.getElementById("tl_modal_container").style.display="",this.remove(),ThisLife.app.router.navigateToPeople(),this.logger.setAction("close"),this.logger.log()},unbindEvents:function(){return ThisLife.Support.keyInformant.off("cancel",this.teardown,this),ThisLife.PubSub.off("modal:close",this.remove),this.model.off(null,null,this)},remove:function(){var e;return null!=(e=this.lazyImageLoader)&&e.destroy(),$(".people_dropdown").remove(),this.unbindEvents(),this.$el.remove()}}),t='<% var face = default_face_url || "/assets/people/defaultPerson.png" %>\n<% var email = email || null %>\n<% var uid = uid || null %>\n\n<li class="item" data-facebook-uid="<%= facebook_uid %>" data-uid ="<%= uid %>" data-email="<%= email %>">\n    <img src="<%= face %>" class="avatar">\n    <a class="name"></a>\n</li>',ThisLife.PubSub.on("modal:show:peopleSuggestions",function(t){var i,n;return i={},i.model=t.options.suggestion,null!=t.options.personTagId&&(i.personTagId=t.options.personTagId),null!=t.options.relationshipId&&(i.relationshipId=t.options.relationshipId),n=new e(i),document.getElementById("tl_modal_container").appendChild(n.el)}),ThisLife.PubSub.on("modal:close:peopleSuggestions",function(){return ThisLife.Model.suggestedGroupCount.ignoreUpdates=!1,ThisLife.Model.suggestedGroupCount.requiresUpdate?(ThisLife.Model.suggestedGroupCount.requiresUpdate=!1,ThisLife.Service.api.getSuggestedFaceGroupCount()):void 0})}.call(this),function(){var e,t,i;t=void 0,ThisLife.View.PeopleListView=Backbone.View.extend({className:"person_card",events:{drag:"drag",drop:"drop","click .image_wrap, .count":"filteredView","click .triangle-actions":"deletePerson",mouseleave:"onMouseout","blur input.name":"onBlurName","focus input.name":"onFocusName","keypress input.name":"onKeypressName","click .error-text-icon":"cancelNameChange"},initialize:function(){return _.bindAll(this,"render"),this.model.on("change:name change:face change:icon_url",this.render,this).on("remove",this.remove,this).on("filter",this.showhide,this).on("count_changed",this.render,this),ThisLife.PubSub.on("updatePeopleCounts",this.updateCount,this),ThisLife.PubSub.on("edit_people:filterView",this.filteredView,this),this.draggable(),this.droppable()},cacheElements:function(){return this.personCard=this.$el,this.containerPersonTiles=$(".non_vip_section").addClass("hoverableitems"),this.personInputName=this.personCard.find("input.name"),this.personDropdown=this.personCard.find(".face_identify_dropdown"),this.personInputName=this.personInputName,this.nameError=this.personCard.find(".error-text-icon")},focusTile:function(e){return e.addClass("selected").siblings(".person_card").removeClass("selected"),this.containerPersonTiles.removeClass("hoverableitems")},unfocusTile:function(e){return e.removeClass("selected"),this.containerPersonTiles.addClass("hoverableitems")},onFocusName:function(){var e,t;return this.focusTile(this.personCard),this.originalName=this.model.getName(),e=this.setupAutoComplete(this.personInputName),t=_.unescape(this.personInputName.val().trim()),t&&this.personDropdown.show(),e.shorthand.select?e.shorthand.select():void 0},onBlurName:function(){var e;return this.unfocusTile(this.personCard),this.personInputName.hasClass("nosave")?(this.personInputName.val(this.originalName).removeClass("nosave"),void this.hideNameError()):(e=this.personInputName.val(),"unnamed"===e&&this.personInputName.val(""),"unnamed"===this.originalName&&""===e||this.originalName===e?void 0:(""===e?(this.showNameError(),this.personInputName.focus()):this.savePersonName(),this))},onMouseout:function(){return this.folderDropdown.isShown&&this.folderDropdown.hideAllActions(!0),this.personDropdown.hide()},onKeypressName:function(e){return ThisLife.Helper.Keyboard.isEnter(e.keyCode)?(this.savePersonName(),!1):ThisLife.Helper.Keyboard.isEscape(e.keyCode)?(this.personInputName.val(this.originalName),this.hideNameError(),!1):void 0},savePersonName:function(){var e,t,i,n;return n=_.unescape(this.personInputName.val().trim()),e=ThisLife.Collection.personTags.findName(n),t=n&&""!==n&&n!==this.originalName&&!e,i=n&&""!==n&&n.toLocaleLowerCase()===this.originalName.toLowerCase(),t||i?(this.model.save("name",n),this.originalName=n,void this.hideNameError()):""===n?void this.showNameError():n!==this.originalName&&e&&this.model.id!==e.id?(this.personInputName.val(this.originalName),ThisLife.PubSub.trigger("edit_people:merge",{source:this.model,dist:ThisLife.Collection.personTags.get(e.id)})):void 0},cancelNameChange:function(){return this.personInputName.val(this.originalName),this.hideNameError()},setupAutoComplete:function(e){return e.shorthandF||this.shorthandF(e),e},shorthandF:function(e){var t,n,o;return o=this,n=_.bind(this.savePersonName,this),t={source:ThisLife.Service.api.combineContacts().toJSON(),value:"name",parent:o.personDropdown.find(".face_identify_dropdown-scroll-area"),num:-1,sorted:!1,template:i,menu:'<ul class="people_dropdown suggestions"></ul>',selectCallback:n,caseSensitive:!1,show:function(){return o.personDropdown.show(),$.fn.shorthand.Constructor.prototype.show.call(this)},blur:function(t){return ThisLife.Helper.Keyboard.isEscape(t.keyCode)?(o.personInputName.val(o.originalName),e.blur(),this.hide()):void 0},hide:function(){return o.personDropdown.hide(),$.fn.shorthand.Constructor.prototype.hide.call(this)},save:function(){return o.savePersonName()}},e.shorthand(t)},render:function(){var t,i,n,o,s;return i=this.model.getDefaultFaceUrl(),n=this.model.getNameEscaped(),s=this.model.get("uid"),t=this.model.count?this.model.count:0,this.$el.html(e(n,i,s,t)),this.cacheElements(),o={caller:this,model:this.model,container:this.el,editCallback:this.editPerson,deleteCallback:this.deletePerson,changeCoverCallback:this.changeCover},this.folderDropdown=new ThisLife.View.PeopleDropdown(o),$(this.el).append(this.folderDropdown.render().el),this},updateCount:function(e){var t,i;return e===this.model.get("uid")?(t=this.model.count?this.model.count:0,i=$(this.$el.find(".count")[0]),i.html(t),i.addClass("grow"),setTimeout(function(){return i.removeClass("grow")},200)):void 0},drag:function(){return ThisLife.View.peopleSection.drag(this.model)},drop:function(e,t){var i;return e.stopPropagation(),i=$("#face_grid"),t.offset.top>i.offset().top&&t.offset.top<i.offset().top+i.height()?ThisLife.View.peopleSection.drop(this.model):void 0},showTooltip:function(e){var t;return t=e.currentTarget.querySelector(".disabled_tooltip_wrap"),t.classList.add("show")},hideTooltip:function(e){return e.currentTarget.querySelector(".disabled_tooltip_wrap").classList.remove("show")},showhide:function(e){return this.el.style.display=e?"inline-block":"none"},showNameError:function(e){return null==e&&(e="Person can't be blank"),this.nameError.find(".input_error").text(e),this.nameError.show(),this.personInputName.addClass("focus"),this.$el.addClass("focus")},hideNameError:function(){return this.nameError.hide(),this.personInputName.removeClass("focus"),this.$el.removeClass("focus")},changeCover:function(){return ThisLife.app.router.navigateToPeopleChangeCover(this.model.id)},deletePerson:function(){var e,t,i;return t=function(e){return function(){var i;return i=new ThisLife.View.ModalAlert,document.body.appendChild(i.renderLoadingTemplate().el),t=ThisLife.Helper.Scripts.postpone(function(){return i.changeInnerHTML.call(i,"deletePerson",e.model),_.delay(function(){return i.teardown()},ThisLife.View.ModalAlert.CONFIRMATION_DELAY)},1e3),e.model.destroy(t)}}(this),i=new ThisLife.View.ModalAlert({template:"deletePersonView",callback:t}),e=i.render().el,$(e).find(".tl_timeline_tooltip").addClass("delete_person"),document.body.appendChild(e)},filteredView:function(e){var t,i,n,o;return n=this.containerPersonTiles.find(".person_card.selected"),this.unfocusTile(n),n.find("input.name").addClass("nosave").blur(),o={model:this.model},null!=e.model&&(o={model:e.model}),t=require("ThisLife.People.Controllers.EditPersonModal"),i=new t,i.renderView(o)},showActions:function(e){return this.folderDropdown.isShown?this.folderDropdown.hideActions(e):this.folderDropdown.showSectionActions(e)},draggable:function(){var e;return e=this,this.$el.draggable({revert:"invalid",helper:"clone",opacity:.8,zIndex:2700,containment:".people_sections",revertDuration:200,start:function(){return this.style.opacity=.2,this.classList.add("pending_merge"),e.trigger("start:drag")},stop:function(){return this.style.opacity=1,this.classList.remove("pending_merge"),e.trigger("stop:drag")}})},droppable:function(){return this.$el.droppable({tolerance:"intersect",greedy:!0,drop:function(e,t){return $(t.helper).offset().top<$("#face_grid").height()+53&&$(this).hasClass("ui-draggable")?($(t.helper).remove(),$(this).removeClass("drophover")):void 0},activeClass:"droppable",over:function(e,t){return $(t.helper).offset().top<$("#face_grid").height()+53&&$(this).hasClass("ui-draggable")?$(this).addClass("drophover"):void 0},out:function(){return $(this).removeClass("drophover")}})},remove:function(){return this.$el.remove(),this}}),e=function(e,t,i,n){var o;return o=n>0?"":"invisible",e="unnamed"===e?"":e,'<div class="image_wrap">\n  <div class="image" style="background-image: url('+t+')"></div>\n</div>\n<br/>\n<div class="count '+o+'" id="count_'+i+'">\n  '+n+'\n</div>\n\n<br/>\n<input type="text" class="name editable shorthand_input" spellcheck=\'false\' title="'+e+'" value="'+e+'" placeholder="Who\'s this?">\n<div class="error-text-icon"><img src="/assets/1px.gif">\n  <div class="disabled_tooltip_wrap">\n    <div class="disabled_tooltip_arrow"></div>\n    <div class="disabled_tooltip">\n      <div class="input_error">Person can\'t be blank</div>\n    </div>\n  </div>\n</div>\n<div class="triangle-actions">\n  <div class="background"></div>\n</div>\n<!-- autofill -->\n<div class=\'face_identify_dropdown\' id=\'face_identify_dropdown-people\'>\n  <div class=\'face_identify_dropdown-scroll-area\'></div>\n</div>'},i='<% var uid = uid || ""; var default_face_url = default_face_url || "/assets/people/defaultPerson.png" %>\n<li data-facebook-uid="<%= facebook_uid %>" data-uid="<%= uid %>" class="suggestion-item">\n    <img src="<%= default_face_url %>" class="avatar avatar-circle" />\n    <a class="person-name"></a>\n</li>'}.call(this),function(){define("ThisLife.View.PeopleSection",[],function(){var e;return e=Backbone.View.extend({id:"people_section",events:function(){return{"click .secondary_bar a.orange-btn":"goToSuggestedPeople","keyup .search_input_wrap input":"keyupListener","click .search_input_wrap .icon_delete":"clearSearch","mouseenter .secondary_bar .orange-btn":"showTooltip","mouseleave .secondary_bar .orange-btn":"hideTooltip","drop .people_sections":"dropInPeopleSection","click .breadcrumb_bar .bc_back_wrapper":"clickedBack"}},showTooltip:function(e){var t,i;return i=e.currentTarget.querySelector(".disabled_tooltip_wrap"),i.classList.remove("show"),t=function(){return i.classList.add("show")},this.tooltipTimerId=setTimeout(t,1e3)},hideTooltip:function(e){return clearTimeout(this.tooltipTimerId),e.currentTarget.querySelector(".disabled_tooltip_wrap").classList.remove("show")},initialize:function(e){return this.options=null!=e?e:{},this.start(),this.toClearSearch=!0,this.needPeopleUpdate=!1,ThisLife.PubSub.on("state:changeTo:people",function(e){return function(){return e.toClearSearch&&e.clearSearch(),e.needPeopleUpdate&&ThisLife.PubSub.trigger("updatePeopleCounts"),e.toClearSearch=!0,e.needPeopleUpdate=!1}}(this)),ThisLife.PubSub.on("people:dontClearSearch",function(e){return function(){return e.toClearSearch=!1}}(this)),ThisLife.PubSub.on("people:requireUpdate",function(e){return function(){return e.needPeopleUpdate=!0}}(this)),this.bindings()},keyupListener:function(){return this.lookup(),this.updateInputIcon()},clearSearch:function(){return this.searchInput.value="",this.lookup(),this.updateInputIcon()},lookup:function(){var e,t,i;return this.query=null!=(t=this.searchInput)&&null!=(i=t.value)?i.trim().toLowerCase():void 0,e=_.bind(this.matchesQuery,this),this.collection.each(e)},matchesQuery:function(e){var t;return t=this.matcher(e)?!0:!1,e.trigger("filter",t)},updateInputIcon:function(){var e,t,i;return this.query&&this.query.length&&!this.showDeleteIcon?(null!=(e=this.searchWrap)&&e.classList.add("delete"),this.showDeleteIcon=!0):this.query&&0===this.query.length&&this.showDeleteIcon?(null!=(t=this.searchWrap)&&null!=(i=t.classList)&&i.remove("delete"),this.showDeleteIcon=!1):void 0},matcher:function(e){var t,i,n,o,s;if(!this.query)return!0;if(e=e.get("name").toLowerCase(),n=!1,e){for(e=e.replace(new RegExp(String.fromCharCode(160),"gi")," "),s=e.split(" "),t=0,i=s.length;i>t&&(o=s[t],!(n=-1===~o.indexOf(this.query)));t++);n||(n=-1===~e.indexOf(this.query))}return n},addHoverTooltips:function(){return!1},checkEmptyCollection:function(e,t){return t.length?void 0:this.addNoPeopleTemplate()},addNoPeopleTemplate:function(){var e;return this.$el.append(ThisLife.Templates.people("noPeopleTemplate")),this.el.classList.add("empty"),null!=(e=this.el.querySelectorAll(".secondary_bar").classList)&&e.add("hidden"),$(".identify-btn").on("click",this.goToSuggestedPeople),this.collection.on("add",this.resetCollection,this)},removeNoPeopleTemplate:function(){var e,t,i;return $(document.getElementById("no_tagged_people_wrapper")).remove(),null!=(e=this.el)&&null!=(t=e.querySelectorAll(".secondary_bar").classList)&&t.remove("hidden"),null!=(i=this.el)&&i.classList.remove("empty"),this},start:function(){var e;return this.collection.length||this.collection.loaded?(this.render(),this.el.innerHTML=this.template(),document.body.appendChild(this.el),e=this.options.header,this.el.querySelector(".header_wrapper").appendChild(e.render().el),this.searchWrap=document.querySelector(".search_input_wrap"),this.searchInput=this.searchWrap.querySelector("input"),this.peopleView||(this.peopleView=new ThisLife.View.PeopleView({collection:this.collection}))):(this.$el.append(ThisLife.Templates.people("loadingPeopleTemplate")),this.collection.on("reset",this.resetCollection,this))},resetCollection:function(){return this.collection.loaded=!0,this.collection.off("add reset",this.resetCollection),this.removeNoPeopleTemplate().start()},showPeopleView:function(){return this.peopleView||(this.peopleView=new ThisLife.View.PeopleView({collection:this.collection})),this.removeNoPeopleTemplate()},changeGroupCount:function(e,t){var i,n,o,s;return t>0&&null==this.peopleView&&this.showPeopleView(),i=e.getCountToDisplay(),o=document.querySelector(".primary_btn.identify .notify"),o&&(o.dataset.count=i,o.setAttribute("data-count",i),n=i>0?"remove":"add",null!=(s=document.querySelector(".primary_btn.identify"))&&s.classList[n]("disabled")),e.get("count")>0?this.$("#no_tagged_people .jeff_script").show():void 0},goToSuggestedPeople:function(){return ThisLife.app.router.navigateToPeopleSuggestions()},drag:function(e){return this.dragModel=e},drop:function(e){return this.dropModel=e,this.changeDrop()},dropInPeopleSection:function(){return this.drop(null)},showModal:function(e){return null==e&&(e={}),ThisLife.app.whenReady(function(t){return function(){return t.goToSuggestedPeople(),ThisLife.app.showModal("peopleSuggestions",e)}}(this))},mergePersonTags:function(){var e,t,i,n;return e=require("ThisLife.People.Controllers.Merge"),this.dragModel===this.dropModel||this.dropped?void 0:(t=function(e){return function(){return e.dropped=!1}}(this),n=function(e){return function(){return e.dropped=!1}}(this),i=new e,i.renderView({source:this.dragModel,dest:this.dropModel,cancelCallback:t,successCallback:n}))},changeRelationship:function(){var e,t,i;return t={person_tag_uid:this.dragModel.get("uid"),relationship_type_uid:this.dropModel.get("uid")},ThisLife.Service.api.saveRelationship(t),ThisLife.appModel.addUsedRelationship(this.dropModel.get("uid")),i=new ThisLife.View.ModalAlert,document.body.appendChild(i.renderLoadingTemplate().el),e={src:this.dragModel,dest:this.dropModel},i.changeInnerHTML.call(i,"tagRelationship",e),_.delay(function(){return function(){return i.teardown()}}(this),ThisLife.View.ModalAlert.CONFIRMATION_DELAY+1e3)},confirmSuggestion:function(e,t){var i,n,o,s;return n=_.pluck(t.get("faces"),"id"),s=function(){return function(t){return e.count+=t,ThisLife.PubSub.trigger("updatePeopleCounts",e.get("uid"))}}(this),o=function(){return function(){var i;return i=function(){return t.updateFaces(n,[]),ThisLife.PubSub.trigger("suggestion:removed",t)},t.updateSuggestedPerson(void 0,e.get("name"),i),ThisLife.holdbackLoadDelayed=!0}}(this),i=function(){return function(){return t.trigger("show"),s(-1*n.length)}}(this),t.trigger("hide"),s(n.length),ThisLife.DelayedExecution.addTask({task:o.bind(this),message:"You have added "+t.get("faces").length+" faces to "+e.get("name"),timeToWait:5,cancelCallback:i.bind(this),taskName:"removeSuggestion"}),this},changeDrop:function(){var e,t,i,n,o,s,r,l;return"PersonTag"!==(null!=(e=this.dragModel)?e.get("_explicitType"):void 0)||null!==this.dropModel?"PersonTag"!==(null!=(t=this.dragModel)?t.get("_explicitType"):void 0)&&null===this.dropModel?this.showModal({suggestion:this.dragModel}):"PersonTag"===(null!=(i=this.dragModel)?i.get("_explicitType"):void 0)&&"PersonTag"===(null!=(n=this.dropModel)?n.get("_explicitType"):void 0)?this.mergePersonTags():"PersonTag"===(null!=(o=this.dragModel)?o.get("_explicitType"):void 0)&&"PersonTag"!==(null!=(s=this.dropModel)?s.get("_explicitType"):void 0)?this.changeRelationship():"PersonTag"===(null!=(r=this.dropModel)?r.get("_explicitType"):void 0)?this.confirmSuggestion(this.dropModel,this.dragModel):this.showModal(null===(null!=(l=this.dropModel)?l.get("uid"):void 0)?{suggestion:this.dragModel}:{suggestion:this.dragModel,relationshipId:this.dropModel.get("uid")}):void 0},clickedBack:function(){return ThisLife.app.router.navigateToLibrary()},template:function(){return"<div class='header_wrapper'></div>\n<div id='face_grid' class='face_list scrollbar'>\n  <div class='face_grid_center'></div>\n</div>"},bindings:function(){return ThisLife.PubSub.on("state:changeFrom:people",this.remove,this)},remove:function(){var e,t;return ThisLife.PubSub.off("state:changeFrom:people",this.remove,this),null!=(e=this.peopleView)&&e.remove(),null!=(t=this.header)&&t.remove(),this.$el.remove(),this}})}),ThisLife.View.PeopleSection=require("ThisLife.View.PeopleSection")}.call(this),function(){var e;ThisLife.View.PersonThumbnail=Backbone.View.extend({tagName:"li",events:{click:"onClick",mouseenter:"onMouseEnter",mouseleave:"onMouseLeave"},initialize:function(e){return null==e&&(e={}),this.face=e.face,this.parentPubSub=e.parentPubSub,this.autoLoadImage=null!=e.autoLoadImage?e.autoLoadImage:!0,this.addBindings()},addBindings:function(){var e;return null!=(e=this.parentPubSub)?e.on("face:showSelected",this.onShowSelected,this):void 0},render:function(){return this.$el.html(e(this.face)),this.cacheDomElements(),this.requestImage(),this.setupTooltip(),this},cacheDomElements:function(){return this.imageEl=this.el.querySelector(".img")},setupTooltip:function(){var e;return e=this,this.$el.tooltip({track:!0,delay:500,allowWindowOverflow:!1,bodyHandler:function(){var t;return t=e.getTooltipImageUrl(),"<img class='person_tooltip' src='"+t+"'/>"}})},requestImage:function(){return this.autoLoadImage?this.loadImage(this.getImageUrl()):void 0},getTooltipImageUrl:function(){var e;return e=this.face.moment_uid,this.moment||(this.moment=ThisLife.Collection.moments.get(e)),this.moment?this.moment.getImageSize("small"):ThisLife.Helper.Image.imgUrl(e,"small",Date.now(),ThisLife.currentLifeOwner)},getImageUrl:function(){var e;return null!=this.face.center_x||null!=this.face.x?ThisLife.Helper.Image.faceUrl(this.face.uid):(e=this.face.moment_uid,this.moment||(this.moment=ThisLife.Collection.moments.get(e)),this.moment?this.moment.getImageSize("x-small"):ThisLife.Helper.Image.faceUrl(this.face.uid))},loadImage:function(e){return this.imageEl||this.render().el,this.imageEl.style.backgroundImage="url("+e+")"},onClick:function(e){var t;return null!=(t=this.parentPubSub)?t.trigger("face:selected",this.face.uid,e.currentTarget):void 0},onMouseEnter:function(){return this.$el.addClass("crossed_hover")},onMouseLeave:function(){return this.$el.removeClass("crossed_hover")},onShowSelected:function(e){return e===this.face.uid?this.$el.addClass("selected"):void 0}}),e=function(e){var t;return t=null!=e.center_x?"":"moment",'<div class="img '+t+'"></div>\n<div class="cross"></div>'}}.call(this),function(){var e,t;ThisLife.View.PeopleSuggestedListView=Backbone.View.extend({className:"suggested_card",events:{"click .skip-suggestion":"skip",click:"openSuggestion",drag:"drag",mouseenter:"showTooltip",mouseleave:"removeTooltip"},initialize:function(e){return null==e&&(e={}),this.removeCallback=e.removeCallback,this.tooltipAdded=!1,this.tooltipOver=!1,this.model.on("change",this.modelChanged,this),this.model.on("hide",this.hideElement,this),this.model.on("show",this.showElement,this),this.model.set("parentView",e.parentView||null)},render:function(){return this.$el.html(t(this.model)),this.cacheDomElements(),this.requestImage(this.getModelFace()),this.setCount(),this.draggable(),this},modelChanged:function(){return null!=this.model.get("person_tag")&&this.remove(),this},cacheDomElements:function(){return this.imageEl=this.el.querySelector(".img"),this.countEl=this.el.querySelector(".count"),this.skipSuggestion=this.el.querySelector(".skip-suggestion"),this.suggestionName=this.el.querySelector(".suggestion_name"),this.tooltip=$(e(this.model))},loadImage:function(e){return this.imageEl.style.backgroundImage="url("+e+")"},getImageUrl:function(e){var t;return null!=e.center_x||null!=e.x?ThisLife.Helper.Image.faceUrl(e.uid):(t=e.moment_uid,this.moment||(this.moment=ThisLife.Collection.moments.get(t)),this.moment?this.moment.getImageSize("x-small"):ThisLife.Helper.Image.faceUrl(e.uid))},getModelFace:function(){return this.model.get("faces")[0]},getFaceCount:function(){return this.model.get("faces").length},requestImage:function(e){return this.loadImage(this.getImageUrl(e))},setCount:function(){return this.countEl.innerHTML=this.getFaceCount()},bindTooltipEvents:function(){return this.tooltip.on("mouseenter",function(e){return function(){return e.tooltipOver=!0}}(this)),this.tooltip.on("mouseleave",function(e){return function(){return e.tooltipOver=!1,e.removeTooltip()}}(this)),this.tooltip.children(".name_suggestion_btn_no").on("click",function(e){return function(){return e.openSuggestionWithoutName()}}(this)),this.tooltip.children(".name_suggestion_btn_yes").on("click",function(e){return function(){return e.openSuggestion()}}(this))},positionTooltip:function(){var e,t;return t=this.$el.offset(),e=(this.tooltip.width()-this.$el.width())/2,$(this.tooltip).css({top:t.top+120+"px",left:t.left-e+"px"})},showTooltip:function(){},removeTooltip:function(){return this.tooltipAdded&&this.delay(50,function(e){return function(){return e.tooltipOver?void 0:(e.tooltip.hide(),$(e.suggestionName).show())}}(this)),this},deletePersonAndFaces:function(){var e;return e=_.map(this.model.get("faces"),function(){return function(e){return e.uid}}(this)),this.model.ignoreFaces(e),this.$el.addClass("fade"),setTimeout(function(e){return function(){return e.$el.remove(),"function"==typeof e.removeCallback?e.removeCallback(e.model):void 0}}(this),200)},hideElement:function(){return this.$el.addClass("fade"),setTimeout(function(e){return function(){return e.$el.hide()}}(this),200),this},showElement:function(){return this.$el.removeClass("fade").show()},skip:function(e){var t,i;return e.stopPropagation(),i=this.model.isNamed()?this.model.getNameEscaped():"a person",this.$el.addClass("fade"),setTimeout(function(e){return function(){return e.$el.hide()}}(this),200),t=function(e){return function(){return e.$el.removeClass("fade").show()}}(this),ThisLife.DelayedExecution.addTask({task:this.deletePersonAndFaces.bind(this),message:"You have skipped "+i+" suggestion",timeToWait:5,cancelCallback:t.bind(this),taskName:"skipSuggestion"}),this},openSuggestion:function(){return ThisLife.View.peopleSection.showModal({suggestion:this.model})},openSuggestionWithoutName:function(){return ThisLife.View.peopleSection.showModal({suggestion:this.model,personTagId:null})},draggable:function(){var e;return e=this,this.$el.draggable({helper:"clone",opacity:.8,zIndex:2700,containment:"#people_section",appendTo:"body",revertDuration:200,revert:function(){return ThisLife.PubSub.trigger("suggestion:reverting"),!0},start:function(t,i){return this.style.opacity=.1,this.classList.add("pending_merge"),$(i.helper).addClass("ui-draggable-helper"),e.trigger("start:drag")},stop:function(){return ThisLife.View.peopleSection.dropped||(this.style.opacity=1,this.classList.remove("pending_merge")),ThisLife.PubSub.trigger("suggestion:stopdrag"),e.trigger("stop:drag")},drag:function(e,t){return ThisLife.PubSub.trigger("suggestion:drag",t.offset)}})},drag:function(){return ThisLife.View.peopleSection.drag(this.model)},delay:function(e,t){return setTimeout(t,e)}}),t=function(e){var t,i;return i=e.isNamed()?"known":"unknown",t=e.isNamed()?e.getPersonTagName().split(" ")[0]:"","<div class='suggestion_thumb "+i+"'>\n  <div class='img'></div>\n  <div class='count'>0</div>\n  <div class='skip-suggestion'><div></div></div>\n</div>\n<div class=\"suggestion_name\">"+t+"</div>"},e=function(e){var t,i;return i=e.getPersonTagName(),t=e.id,"<div class='name_suggestion_tooltip'>\n  <span class='name_suggestion_tooltip_name'>"+i+"?</span>\n  <br/>\n  <a class=\"name_suggestion_tooltip_btn name_suggestion_btn_no gray-btn\" href='javascript:void(0);' data-suggid='"+t+"'>No</a>\n  <a class=\"name_suggestion_tooltip_btn name_suggestion_btn_yes orange-btn\" href='javascript:void(0);' data-suggid='"+t+"'>Yes</a>\n</div>"}}.call(this),function(){var e,t;t=void 0,ThisLife.View.RelationshipListView=Backbone.View.extend({className:"relationship_card",events:{drop:"drop","click .remove":"remove"},showTooltip:function(e){var t;return t=e.currentTarget.querySelector(".disabled_tooltip_wrap"),t.classList.add("show")},hideTooltip:function(e){return e.currentTarget.querySelector(".disabled_tooltip_wrap").classList.remove("show")},initialize:function(){return _.bindAll(this,"render"),this.model.on("change:name change:face change:icon_url",this.render,this).on("remove",this.remove,this).on("filter",this.showhide,this).on("count_changed",this.render,this),this.droppable()},render:function(){var t,i,n;return t="Me"!==this.model.get("name")&&"Other"!==this.model.get("name")&&"New Person"!==this.model.get("name")&&"Drag a new person here"!==this.model.get("name")?"My "+this.model.get("name"):this.model.get("name"),n=this.model.get("uid"),i="",this.$el.html(e(t,n,i)),this},drop:function(e){return e.stopPropagation(),ThisLife.View.peopleSection.drop(this.model)},showhide:function(e){return this.el.style.display=e?"block":"none"},filteredView:function(){return ThisLife.PubSub.trigger("addFilter"),ThisLife.app.router.navigateToPeopleFiltered(this.model.id)},droppable:function(){var e;return e=this,this.$el.droppable({tolerance:"pointer",greedy:!0,drop:function(e,t){return $(t.helper).remove(),$(this).removeClass("drophover")},activeClass:"droppable",over:function(e,t){return"New Person"===$.trim($(this)[0].innerText)&&t.draggable[0].className.split(" ").indexOf("person_card")>-1?void 0:$(this).hasClass("ui-droppable")?$(this).addClass("drophover"):void 0},out:function(){return $(this).removeClass("drophover")}})},remove:function(){return this.$el.animate({opacity:0},100,function(){return $(this).remove()}),this}}),e=function(e,t,i){return null==i&&(i=""),'<div class="relationship_wrap '+i+'">\n  <div class="name" title="'+e+'">\n    '+e+'\n  </div>\n  <!--<div class="remove" id="remove_'+t+'">\n    <div></div>\n  </div>-->\n</div>'}}.call(this),function(){var e;ThisLife.View.PeopleGuide=Backbone.View.extend({className:"suggested_guide people_guide",events:{"click .close":"hide","click .close-btn":"hide"},initialize:function(e){return this.options=null!=e?e:{},this},remove:function(){return this.$el.remove(),this},render:function(){return this.el.insertAdjacentHTML("beforeend",e),this},hide:function(){var e;return ThisLife.appModel.setFirstTimePeopleGuide(),this.remove(),"function"==typeof(e=this.options).callback?e.callback():void 0}}),e='<div class="guide-wrapper">\n  <div class="guide-content">\n    <div class=\'close-btn\'><img src=\'/assets/1px.gif\' /></div>\n    <h1>Find the photos you need!</h1>\n    <div class="guide-item">\n      <img src="/assets/people/guide/people.png" />\n      <p>Tag your loved ones.</p>\n    </div>\n    <div class="guide-item">\n      <img src="/assets/people/guide/search.png" />\n      <p>Search for multiple people.</p>\n    </div>\n    <div class="guide-item">\n      <img src="/assets/people/guide/cards.png" />\n      <p>Find the perfect group shot.</p>\n    </div>\n    <div class="close done-btn orange-btn">Got it!</div>\n  </div>\n</div>'}.call(this),function(){ThisLife.View.PeopleDropdown=Backbone.View.extend({className:"actions-container",initialize:function(e){return this.options=null!=e?e:{},this.closeCallback=this.options.closeCallback,this.model=this.options.model,this.container=this.options.container,this.caller=this.options.caller,this.editCallback=this.options.editCallback,this.changeCoverCallback=this.options.changeCoverCallback,this.deleteCallback=this.options.deleteCallback,this.isShown=!1},render:function(){return this.el.insertAdjacentHTML("beforeend",this.template()),this},events:function(){return{"click .edit-profile-action":"editProfile","click .change-cover-action":"changeCover","click .delete-action":"deletePerson",mouseout:"hideActions",mouseover:"mouseOver"}},editProfile:function(){return this.hideAllActions(!0),"function"==typeof this.editCallback?this.editCallback():void 0},changeCover:function(){return this.hideAllActions(!0),"function"==typeof this.changeCoverCallback?this.changeCoverCallback():void 0},deletePerson:function(){return this.hideAllActions(!0),"function"==typeof this.deleteCallback?this.deleteCallback():void 0},showSectionActions:function(){var e,t,i,n;return e=$(this.container).offset().top,t=$(this.el).height(),i=$("#tl_bottom_bar").height()+5,n="0px",$(this.el).css({top:n,display:"block"}),this.isShown=!0},mouseOver:function(){return $(this.el).addClass("hover")},hideAllActions:function(e){return $(this.el).css("display","none"),this.el.classList.remove("inverted"),this.caller.closeCallback&&e&&this.caller.closeCallback(),this.isShown=!1},hideActions:function(e){var t;return t=e.relatedTarget?e.relatedTarget:e.toElement,0===$(t).parents(".actions-container").length?($(this.el).removeClass("hover"),this.hideAllActions(!0)):void 0},template:function(){return"<div class='action-menu dropdown' >\n   <ul>\n     <li class='edit-profile-action bottom-border'>Edit profile</li>\n     <li class='change-cover-action bottom-border'>Change cover</li>\n    <li class='delete-action'>Delete</li>\n   </ul>\n </div>\n    "}})}.call(this),function(){var e,t,i,n,o,s,r,l,a;t=l=r=s=o=void 0,n=[],e=Backbone.View.extend({el:"#places-map",markers:[],initialize:function(){return this.collection=ThisLife.Collection.locationTags,_.bindAll(this,"render","addMarkers"),ThisLife.Helper.Scripts.loadGoogleMaps(this.initializeMap,this)},resize:function(){return google.maps.event.trigger(this.map,"resize")},initializeMap:function(){var e;return e=new google.maps.StyledMapType(l,{name:"Simplified"}),this.map=new google.maps.Map(this.el,o()),this.map.mapTypes.set("tl_simplified",e),this.map.setMapTypeId("tl_simplified"),this.collection.length&&this.render(),google.maps.event.addListener(this.map,"zoom_changed",s),this.collection.on("reset add remove",this.render,this)
},render:function(){return this.addMarkers(),this.attachMarkers(),this},addMarkers:function(){var e;return e=this,this.markers=[],this.collection.each(function(t){var i,o,s,r,l,a;return o=t.get("lat"),r=t.get("long"),s=new google.maps.LatLng(o,r),a={position:s,icon:{url:"/assets/places/marker-1.png",size:{width:40,height:40},scaledSize:{width:40,height:40}}},l=new google.maps.Marker(a),l.data={location_tag_uid:t.get("uid"),location_tag_name:t.get("name")},i=new google.maps.InfoWindow({maxWidth:400}),n.push(i),google.maps.event.addListener(l,"click",function(){return e.viewPlaces(this.data)}),google.maps.event.addListener(l,"mouseover",function(){var t;return t=e.getName(l.data),i.setContent("<h4>"+t+"</h4>"),i.open(this.map,this)}),google.maps.event.addListener(l,"mouseout",function(){return i.close()}),e.markers.push(l)})},attachMarkers:function(){var e,i,o;return o=this,null!=(i=this.markerClusterer)&&i.clearMarkers(),this.markerClusterer=new MarkerClusterer(this.map,this.markers,t),e=new google.maps.InfoWindow({maxWidth:400,pixelOffset:new google.maps.Size(0,-40)}),n.push(e),google.maps.event.addListener(this.markerClusterer,"click",function(e){var t,i,n,s;return n=new google.maps.Marker({position:e.center_}),i=[],t=[],s=e.getMarkers(),_.each(s,function(e){var n;return n=e.data,i.push(n.location_tag_uid),t.push(n.location_tag_name)}),o.viewPlaces({location_tag_uids:i,location_tag_names:t})}),google.maps.event.addListener(this.markerClusterer,"mouseover",function(t){var i,n,s,r,l,a;return r=new google.maps.Marker({position:t.center_}),s=[],n=[],l=t.getMarkers(),_.each(l,function(e){var t;return t=e.data,s.push(t.location_tag_uid),n.push(t.location_tag_name)}),a=o.getName({location_tag_uids:s,location_tag_names:n}),i=new google.maps.MVCObject,i.set("position",t.center_),e.setContent("<h4>"+a+"</h4>"),e.open(this.map,i)}),google.maps.event.addListener(this.markerClusterer,"mouseout",function(){return e.close()})},viewPlaces:function(e){var t;if(this.collection.length)return ThisLife.PubSub.trigger("addFilter"),t=this.getLocationTagUids(e),ThisLife.app.router.navigateToPlacesFiltered(t)},getLocationTagUids:function(e){return e.location_tag_uids||[e.location_tag_uid]},getName:function(e){var t,i,n;return n=e.location_tag_names||[e.location_tag_name],t=n.length,i=t>2?""+_.first(n)+" and "+(t-1)+" others":2===t?n[0]+" and "+n[1]:""+n[0],ThisLife.Helper.String.escapeHtml(i)}}),t={enableRetinaIcons:!0,styles:[{textColor:"white",height:40,width:40,url:"/assets/places/marker-2.png",anchorIcon:[30,15]},{textColor:"white",height:40,width:40,url:"/assets/places/marker-3.png",anchorIcon:[30,15]}],calculator:function(e){return{text:"",index:2===e.length?1:2}},gridSize:40,averageCenter:!0,zoomOnClick:!1},l=[{featureType:"landscape.natural",stylers:[{color:"#dbe6da"}]},{featureType:"landscape.man_made",stylers:[{visibility:"off"}]},{featureType:"administrative",stylers:[{visibility:"off"}]},{featureType:"water",stylers:[{color:"#f9f9fa"}]},{featureType:"poi",stylers:[{color:"#d1dfd0"}]},{featureType:"administrative.country",stylers:[{visibility:"on"}]},{featureType:"administrative.locality",stylers:[{visibility:"on"}]},{featureType:"administrative.neighborhood",stylers:[{visibility:"off"}]},{featureType:"administrative.land_parcel",stylers:[{visibility:"off"}]},{featureType:"road",stylers:[{visibility:"off"}]},{}],s=function(){var e,t,i,o;for(o=[],e=0,i=n.length;i>e;e++)t=n[e],o.push(t.close());return o},o=function(){return{zoom:3,minZoom:3,streetViewControl:!1,panControl:!1,center:new google.maps.LatLng(19.973348786110638,-36.5625),mapTypeControlOptions:{mapTypeIds:["tl_simplified",google.maps.MapTypeId.SATELLITE,google.maps.MapTypeId.HYBRID,google.maps.MapTypeId.ROADMAP]}}},i=function(){return-(document.body.clientHeight-42-43)/4},a=null,ThisLife.PubSub.on("state:changeTo:places",function(){return a?a.resize():a=new e})}.call(this),function(){define("ThisLife.View.PrimaryBar",["ThisLife.Helper.Features"],function(){var e;return e=Backbone.View.extend({el:"#tl_primary_bar",events:{"click #tl_settings_rating_visibility a":"updateRatingVisibility","click .dropdown_wrap":function(e){return e.stopPropagation()},"click .account_dropdown":"toggleAccountDropdown","click .settings":"openSettings","click .signout":"logout","click #tl_logo":"navigateHome","click .menu_item.photos":"navigateTimeline","click .people":"navigatePeople","click .tags":"navigateTags","touchstart .menu_dropdown li":function(e){return e.stopPropagation()}},initialize:function(){return this.bindEvents(),this.cacheDOMElements(),this.createBtns=null},bindEvents:function(){var e;return ThisLife.PubSub.on("state:change",this.stateChange,this),ThisLife.Model.User.on("change:default_life_subscription",this.subscriptionChanged,this),ThisLife.Model.User.on("reset",this.initUserInfo,this),ThisLife.PubSub.on("albums:unread",this.updateNewAlbumsCount,this),null!=(e=ThisLife.app.controller("selection"))&&e.on("start",this.selectionStart,this),$(document.body).on("click touchstart",this.hideAccountDropdown)},unbindEvents:function(){return $(document.body).off("click touchstart",this.hideAccountDropdown)},subscriptionChanged:function(){var e,t;return e=ThisLife.Model.User.upgradeIsPossible(),e?void 0:null!=(t=$("#tl_settings_upgrade"))?t.remove():void 0},cacheDOMElements:function(){return this.storyInvitationsNotifyEl=this.el.querySelector(".stories .notify"),this.albumsInvitationNotifyEl=this.el.querySelector(".albums .notify"),this.peopleNotifyEl=this.el.querySelector(".people .notify"),this.cartEl=this.el.querySelector(".cart"),this.cartCountEl=this.el.querySelector(".cart .notify"),this.primaryBtnsRightEl=this.el.querySelector(".primary_btns_right"),this.accountDropdown=this.el.querySelector(".account_dropdown"),this.createBtnsContainer=this.el.querySelector(".create_btns_container"),this.primaryBarEl=document.querySelector(".tl_primary_bar"),this},toggleAccountDropdown:function(e){return e.stopPropagation(),$(this.accountDropdown).toggleClass("visible"),ThisLife.PubSub.trigger("accountmenu:open")},hideAccountDropdown:function(e){var t,i;return null==e&&(e=window.event),e&&(i=$(e.target),t=i.parent(),i.hasClass("account_dropdown")||t.hasClass("account_dropdown"))?void 0:$(".account_dropdown").removeClass("visible")},initUserInfo:function(){var e;return null!=(e=this.albumsInvitationNotifyEl)&&e.classList.add("show"),$(this.primaryBtnsRightEl).find(".dropdown_arrow").html("Hi, "+ThisLife.Model.User.get("first_name")),$(this.primaryBtnsRightEl).find(".myshutterfly").attr("href",ThisLife.Settings.sflyApp+"/nav/mysfly.sfly"),$(this.primaryBtnsRightEl).find(".cart").attr("href",ThisLife.Settings.sflyApp+"/checkout/start.sfly"),$(this.primaryBtnsRightEl).find(".history a").attr("href",ThisLife.Settings.sflyApp+"/account/orderhistory.jsp"),$(this.primaryBtnsRightEl).find(".projects a").attr("href",ThisLife.Settings.sflyApp+"/myProjects/default.sfly"),$(this.primaryBtnsRightEl).find(".account a").attr("href",ThisLife.Settings.sflyApp+"/account/start.sfly"),$(this.primaryBtnsRightEl).find(".addresses a").attr("href",ThisLife.Settings.sflyApp+"/addressbook/management.sfly"),$(this.primaryBtnsRightEl).find(".share").attr("href",ThisLife.Settings.sflyApp+"/nav/share.sfly"),$(this.primaryBtnsRightEl).find(".favorites a").attr("href",ThisLife.Settings.sflyApp+"/favoritesList/view.sfly"),$(this.primaryBtnsRightEl).find(".lifetouch a").attr("href",ThisLife.Settings.sflyApp+"/lifetouch-pictures/#/personalize"),$(this.primaryBtnsRightEl).find(".shutterflylabs a").attr("href",ThisLife.Settings.sflyApp+"/labs"),this.setCartCount()},setCartCount:function(){return $.ajax({type:"GET",url:ThisLife.Settings.sflyApp+"/rest/ecom/showicweb",data:null,dataType:"text",success:function(e){return function(t){var i;return i=JSON.parse(t),(null!=i?i.showIcWeb:void 0)?e._updateCartCountFromWOL():e._updateCartCount()}}(this),xhrFields:{withCredentials:!0},error:function(e){return function(){return e._updateCartCount()}}(this)})},_updateCartCount:function(){return $.ajax({type:"GET",url:ThisLife.Settings.sflyApp+"/rest/ecom/carts",data:null,dataType:"text",success:function(e){return function(t){var i,n;return n=JSON.parse(t),i=null!=n?n[0].itemsInCart:void 0,e._setCartCountInfo(i)}}(this),xhrFields:{withCredentials:!0},error:function(){return function(e){return console.log("ERROR:",e)}}(this)})},_updateCartCountFromWOL:function(){return ThisLife.app.session.getSessionToken().then(function(e){return function(t){return $.ajax({url:"https://"+ThisLife.Settings.api2Domain+"/v1/web-cart-orch/cart/v1/carts/default/projects/ids",type:"GET",beforeSend:function(e){e.setRequestHeader("SFLY-Apikey",ThisLife.Settings.apigeeApiKey),e.setRequestHeader("Authorization","Bearer "+t)},success:function(t){return e._setCartCountInfo(null!=t?t.itemsInCart:void 0),$(e.primaryBtnsRightEl).find(".cart").attr("href",ThisLife.Settings.sflyApp+"/cart")}})}}(this))},_setCartCountInfo:function(e){return e>9&&(e="9+"),null!=e?($(this.cartCountEl).attr("data-count",e),e>0?this.cartEl.classList.remove("inactive"):this.cartEl.classList.add("inactive")):this.cartEl.classList.add("inactive")},addCreateButtons:function(){return ThisLife.app.whenReady(function(e){return function(){return e.addMobileUpdate(),ThisLife.Collection.moments.whenLoaded(function(){return e.addCreateButtonsView(),ThisLife.Collection.moments.getNumVisible()<1?ThisLife.View.magicShop.hide():void 0})}}(this))},addCreateButtonsView:function(){var e,t,i;if("gifting"!==(null!=(e=ThisLife.app.currentState)?e.name:void 0))return this.createBtns=new ThisLife.View.SecondaryBar.CreateBtns({selection:ThisLife.app.controller("selection"),library:ThisLife.app.library}),i=this.createBtns.render().el,ThisLife.View.magicShop=this.createBtns,(t=function(e){return function(){return ThisLife.app.isMobile?void 0:$(e.createBtnsContainer).show().html(i)}}(this))()},addMobileUpdate:function(){return ThisLife.app.isMobile?$(this.primaryBarEl).addClass("mobile"):void 0},hidePopovers:function(){var e;return null!=(e=this.storyBtns)?e.hidePopovers():void 0},updateRatingVisibility:function(){var e;return e=this.settingsDropdownEl.querySelector("#tl_settings_rating_visibility a"),ThisLife.appModel.toggleShowRatings(),e.innerHTML=ThisLife.appModel.getShowRatings()?"Hide Ratings":"Show Ratings"},toggleMagicShop:function(e){return"gifting"===(null!=e?e.name:void 0)?ThisLife.View.magicShop.hide():ThisLife.View.magicShop.show()},stateChange:function(e){var t,i,n,o;return this.createBtns?this.toggleMagicShop(e):this.addCreateButtons(),(i=ThisLife.Helper.BarSections.section(e))?(this.removeActiveBtnStates(),this.hidePopovers(),n=this.el.querySelector("."+i+".primary_btn"),null!=n&&n.classList.add("active"),n?(t=n.querySelector(".btn_text"),o=$(".btn_text .icon").outerWidth(!0)+$(".btn_text .label").outerWidth(!0),null!=t?t.style.width=o+"px":void 0):void 0):void 0},selectionStart:function(){return this.hidePopovers(),this.hideAccountDropdown()},teardown:function(){return this.removeActiveBtnStates(),this.unbindEvents()},removeActiveBtnStates:function(){var e,t,i,n;for(e=this.el.getElementsByClassName("active"),n=[];e[0];)t=e[0],t.classList.remove("active"),n.push(null!=(i=t.querySelector(".btn_text"))?i.style.width="":void 0);return n},openSettings:function(){return ThisLife.app.router.navigate("settings")},logout:function(){var e,t;return null!=(e=ThisLife.app)&&"function"==typeof e.controller&&null!=(t=e.controller("timing"))&&t.recordSessionEvents({event:"user logout",session_method:"primary bar logout"}),ThisLife.app.logout()},navigateTimeline:function(){return ThisLife.app.router.navigate("library")},navigateHome:function(){return window.location=""+ThisLife.Settings.sflyApp},navigatePeople:function(){return ThisLife.app.router.navigate("people")},navigateTags:function(){return ThisLife.app.router.navigate("tags")}})}),ThisLife.View.PrimaryBar=require("ThisLife.View.PrimaryBar")}.call(this),function(){ThisLife.View.SecondaryBar=Backbone.View.extend({el:"#tl_secondary_bar",events:{"click .primary_btns_left .primary_btn":"navigate","click .section_dropdown li":"navigate","click .section_dropdown .label":"_onClickCurrentDropdownSection"},initialize:function(){return this.bindEvents(),this.cacheDOMElements(),this.setStyle(),this.render()},bindEvents:function(){return ThisLife.PubSub.on("state:change",this.stateChange,this)},cacheDOMElements:function(){return this.subSectionDropdownEl=this.el.querySelector(".sub_section_dropdown"),this.mainSectionDropdownEl=this.el.querySelector(".main_section_dropdown"),this.primaryBtnsLeftEl=this.el.querySelector(".primary_btns_left"),this.secondaryBarEl=document.querySelector(".tl_secondary_bar"),this},render:function(){return this.updateSectionDropdown({name:ThisLife.app.defaultStateName()})},stateChange:function(e){var t,i;return(t=ThisLife.Helper.BarSections.section(e))?(this.removeActiveBtnStates(),this.updateFilter(e),i=this.el.querySelector("."+t+".primary_btn"),null!=i&&i.classList.add("active"),this.updateSectionDropdown(e)):void 0},updateFilter:function(e){var t,i;return null!=(t=this.filter)&&t.teardown(),null!=(i=this.upload)&&i.remove(),this.upload=new ThisLife.View.SecondaryBar.Upload({state:e}),$(this.subSectionDropdownEl).append(this.upload.render().el)},navigate:function(e){var t;return t=e.currentTarget.dataset.href,t?("albums"!==t||ThisLife.Model.Albums.Master.getFirstCoverLoaded()||ThisLife.app.controller("timing").recordEvent("navigateAlbums"),ThisLife.app.router.navigate(t)):void 0},_onClickCurrentDropdownSection:function(e){return this.navigate(e)},removeActiveBtnStates:function(){var e,t,i;for(e=this.el.getElementsByClassName("active"),i=[];e[0];)t=e[0],i.push(t.classList.remove("active"));return i},updateSectionDropdown:function(e){var t;return t={section:ThisLife.Helper.BarSections.section(e),subSection:ThisLife.Helper.BarSections.subSection(e)},this.mainSectionDropdown?void this.mainSectionDropdown.changeState(t):(this.mainSectionDropdown=new ThisLife.View.PrimaryBar.SectionDropdown(t),this.mainSectionDropdownEl.appendChild(this.mainSectionDropdown.el))},setStyle:function(){return this.addMobileUpdate()},addMobileUpdate:function(){return ThisLife.app.isMobile?$(this.secondaryBarEl).addClass("mobile"):void 0}})}.call(this),function(){var e;ThisLife.View.SecondaryBar.CreateBtns=Backbone.View.extend({id:"",className:"",FAST_TIMER:200,SLOW_TIMER:500,events:{"click .books:not(.disabled)":"books","click .gifts:not(.disabled)":"gifts","click .prints:not(.disabled)":"prints","click .decor:not(.disabled)":"decor","click .kids:not(.disabled)":"kids","click .calendars:not(.disabled)":"calendars","click .cards:not(.disabled)":"cards","click .create:not(.disabled)":"create","click .dropdown .close-btn":"onMouseleaveMG","mouseenter ul:not(.new_mg_menu) .books:not(.disabled) .btn_text > span":"startHoverBooks","mouseenter ul:not(.new_mg_menu) .gifts:not(.disabled) .btn_text > span":"startHoverGifts","mouseenter ul:not(.new_mg_menu) .prints:not(.disabled) .btn_text > span":"startHoverPrints","mouseenter ul:not(.new_mg_menu) .decor:not(.disabled) .btn_text > span":"startHoverDecor","mouseenter ul:not(.new_mg_menu) .kids:not(.disabled) .btn_text > span":"startHoverKids","mouseenter ul:not(.new_mg_menu) .calendars:not(.disabled) .btn_text > span":"startHoverCalendars","mouseenter ul:not(.new_mg_menu) .cards:not(.disabled) .btn_text > span":"startHoverCards","mouseenter ul.new_mg_menu .books:not(.disabled)":"startHoverBooks","mouseenter ul.new_mg_menu .gifts:not(.disabled)":"startHoverGifts","mouseenter ul.new_mg_menu .prints:not(.disabled)":"startHoverPrints","mouseenter ul.new_mg_menu .decor:not(.disabled)":"startHoverDecor","mouseenter ul.new_mg_menu .kids:not(.disabled)":"startHoverKids","mouseenter ul.new_mg_menu .calendars:not(.disabled)":"startHoverCalendars","mouseenter ul.new_mg_menu .cards:not(.disabled)":"startHoverCards","mouseleave .primary_btn:not(.disabled) .btn_text > span":"endHover"},initialize:function(e){return this.responsiveBP=e.responsiveBP||991,this.storyModel=ThisLife.Model.masterStory,this.selection=e.selection,this.library=e.library,this.album=e.album,this.currentHover=null,this.hoverTimer=null,this.timerInterval=this.FAST_TIMER,this.insideTooltip=!1,this.usingDropdownMenu=!1,this.productCategories=["photobook","photogifts","prints","homedecor","calendar","cns","kids"],this.productsPreloaded={},this.showingMG=!1,this.usingSmall=$(window).width()<=this.responsiveBP,this.loadingCollection=!1,this.collectionType="",this.didScroll=!1,this.homepageCollection=null,this.currentMomentsHash="",this.preloadTimer=null,this.getCurrentCollection()},bindEvents:function(){var e,t;return null!=(e=this.library)&&e.on("change:visibleMoments",this.visibleMomentsChange,this),null!=(t=this.album)&&t.on("change:visibleMoments",this.visibleMomentsChange,this),ThisLife.app.filter.on("change:filter",this.filterMoments,this),this.createButtons.on("mouseleave",this.onMouseleaveButtonsArea.bind(this)),$(window).on("resize.mg",_.debounce(this.onResize.bind(this),200)),this.collection&&(this.listenTo(this.collection,"remove",this.removedAlbum),this.listenTo(this.collection,"add",this.addedAlbum)),ThisLife.PubSub.on("upload:start",this.setOpenInNewTab.bind(this,!0),this).on("upload:complete",this.setOpenInNewTab.bind(this,!1),this),ThisLife.PubSub.on("change:libraryPosition",_.once(this.onScroll.bind(this))),ThisLife.PubSub.on("startDelay",this.showingDelayedExec.bind(this)),ThisLife.PubSub.on("cancelDelay, executeDelay",this.canceledDelayedExec.bind(this))},unbindEvents:function(){var e,t;return null!=(e=this.library)&&e.off(null,null,this),null!=(t=this.album)&&t.off(null,null,this),ThisLife.removeBlurEvent(this.blurEventCallback),ThisLife.app.filter.off(null,null,this),this.createButtons.off("mouseleave"),$(window).off("resize.mg"),ThisLife.PubSub.off("change:libraryPosition"),ThisLife.PubSub.off("startDelay"),ThisLife.PubSub.off("cancelDelay"),ThisLife.PubSub.off("executeDelay")},_keyCancel:function(){return this.doneShopping()},showingDelayedExec:function(){return this.timerInterval=this.SLOW_TIMER,this},canceledDelayedExec:function(){return this.timerInterval=this.FAST_TIMER,this},getCurrentCollection:function(){var e,t,i,n;return t=$.Deferred(),ThisLife.app.hasOwnProperty("currentState")&&"library"!==ThisLife.app.currentState.fragment?"albums/mine"===ThisLife.app.currentState.fragment?(this.collection=ThisLife.Model.Albums.Master.getOwnerAlbums(),this.collectionType="albums",t.resolve()):"albums/suggested"===ThisLife.app.currentState.fragment?(this.collection=ThisLife.Model.Albums.Master.getAutoAlbums(),this.collectionType="albums",t.resolve()):"albums/friends"===ThisLife.app.currentState.fragment?(this.collection=ThisLife.Model.Albums.Master.getSharedAlbums(),this.collectionType="albums",t.resolve()):"albums"===ThisLife.app.currentState.fragment?(this.collection=ThisLife.Model.Albums.Master.getAllAlbums(),this.collectionType="albums",t.resolve()):ThisLife.app.currentState.albums&&"folder"===(null!=(i=ThisLife.app.currentState.options)?i.view:void 0)?(this.collection=ThisLife.Model.Albums.Master.getAlbumsByFolderId(ThisLife.app.currentState.options.folder_uid),this.collectionType="albums",t.resolve()):ThisLife.app.currentState.albums&&"album"===(null!=(n=ThisLife.app.currentState.options)?n.view:void 0)?(this.collection=ThisLife.Model.Albums.Master.getAlbumById(ThisLife.app.currentState.options.album_uid),this.collectionType="singleAlbum",null!=this.collection.moments?t.resolve():this.collection.whenLoaded(function(){return function(){return t.resolve()}}(this))):"people"===ThisLife.app.currentState.fragment?ThisLife.Collection.personTags.whenLoaded(function(e){return function(){var i,n,o;return ThisLife.Collection.personTags.length>0?(e.loadingPersonCollection=!0,i=ThisLife.Collection.personTags.length>3?3:ThisLife.Collection.personTags.length,o=Math.floor(Math.random()*i),n=ThisLife.Collection.personTags.models[o],ThisLife.Collection.personTags.getCollectionOfMomentsForPersonTag(n.get("uid"),function(i){return e.collection=i,e.collectionType="people",t.resolve(),e.loadingPersonCollection=!1,e.trigger("persontagcollection:loaded")})):void 0}}(this)):null!=ThisLife.app.currentState.name&&"peopleFiltered"===ThisLife.app.currentState.name?(e=ThisLife.app.currentState.options.data.personTagUids[0],this.loadingPersonCollection=!0,ThisLife.Collection.personTags.getCollectionOfMomentsForPersonTag(e,function(e){return function(i){return e.collection=i,e.collectionType="people",t.resolve(),e.loadingPersonCollection=!1,e.trigger("persontagcollection:loaded")}}(this))):t.reject():(this.collectionType="library",this.loadingHomepageCollection=!0,ThisLife.ProductsLogic.getCollectionForHomepage(function(e){return function(t){return e.homepageCollection=t||new Backbone.Collection,e.loadingHomepageCollection=!1,e.trigger("hpcollection:loaded")}}(this)),t.resolve()),t.then(function(e){return function(){var t,i;return e.loadingCollection=!0,null!=e.collection&&((null!=(t=e.collection.models)?t.length:void 0)>0||(null!=(i=e.collection.moments)?i.length:void 0)>0)?e.getPhotosFromCollection(e.collection,e.collectionType,function(t){return e.collection=t,e.loadingCollection=!1,e.trigger("collection:loaded")}):(e.collectionType="library",ThisLife.ProductsLogic.getCollectionForHomepage(function(t){return e.homepageCollection=t||new Backbone.Collection,e.getPhotosFromCollection(e.homepageCollection,e.collectionType,function(t){return e.collection=t,e.loadingCollection=!1,e.trigger("collection:loaded")})}))}}(this))},onScroll:function(){return this.didScroll=!0},onResize:function(e,t,i){var n,o;return null==t&&(t=!1),null==i&&(i=!1),this.mgShopping?void 0:(t&&(this.mgShopping=!0),o=!1,n=!1,i&&(o=!(n=this.usingSmall)),this.usingSmall&&$(window).width()>this.responsiveBP||o?(this.usingSmall=!1,this.createDropdownVisible&&(this.usingDropdownMenu=!1,this.hideDropdown(),this.onMouseleaveMG()),this.reRender()):(!this.usingSmall&&$(window).width()<=this.responsiveBP||t||n)&&(this.usingSmall=!0,t||this.onMouseleaveMG(),this.reRender()),this)},setOpenInNewTab:function(e){return Object.keys(this.productsPreloaded).forEach(function(t){return function(i){var n;return null!=(n=t.productsPreloaded[i])?n.widget.setOpenInNewTab(e):void 0}}(this))},hideFloatingWindows:function(){return Object.keys(this.productsPreloaded).forEach(function(e){return function(t){return e.productsPreloaded[t].widget.hide(e.showingMG)}}(this))},removeAllMagicshops:function(){return Object.keys(this.productsPreloaded).forEach(function(e){return function(t){return e.productsPreloaded[t].widget.remove()}}(this))},render:function(){return this.$el.html(e()),this.cacheElements(),this.bindEvents(),this.preloadMagicshop(),$(this.magicShopOverlay).hide(),this.usingSmall?($(this.dropdown).css("visibility","hidden").css("display","block"),$(this.dropdownClose).show(),this.dropdown.classList.add("selection")):($(this.dropdown).css("visibility","visible"),$(this.dropdownClose).hide(),this.dropdown.classList.remove("selection")),window.newMgSdkVersion?this.usingSmall?$(this.menuElement).addClass("new_mg_menu"):$(this.menuElement).removeClass("new_mg_menu"):this.menuElement=null,this},reRender:function(){return this.unbindEvents(),this.removeAllMagicshops(),this.render()},cacheElements:function(){return this.dropdown=this.el.querySelector(".dropdown"),this.dropdownClose=this.dropdown.querySelector(".close-btn"),this.magicShopOverlay=this.el.querySelector(".magicshop-overlay"),this.menuElement=$(this.dropdown).children("ul:first"),this.createButtons=$(".secondary_btns_create"),this.productWrapper=$(this.dropdown).children(".create-products-wrapper"),this.create_btn=this.el.querySelector(".primary_btn.create"),this.small_catcher=this.el.querySelector(".create-products-small-catcher"),this.container=$(this.usingSmall?this.productWrapper:"body")},filterMoments:function(e){var t;return t=$(".primary_btn.create, .secondary_btns_create .dropdown "),"video"===e?t.addClass("hidden"):t.removeClass("hidden")},removedAlbum:function(e,t){var i;return i=$(".primary_btn.create, .secondary_btns_create .dropdown "),t.length?void 0:i.addClass("hidden")},addedAlbum:function(e,t){var i;return i=$(".primary_btn.create, .secondary_btns_create .dropdown "),1===t.length?i.removeClass("hidden"):void 0},visibleMomentsChange:function(e,t){var i;return i=$(".primary_btn.create, .secondary_btns_create .dropdown "),e||t?i.addClass("hidden"):i.removeClass("hidden")},remove:function(){return this.unbindEvents(),this.$el.remove(),this},startShopping:function(e,t,i,n){return null==n&&(n=""),e&&(this.mgSelectedMoments=e,this.updateWidgetsWithPhotos()),t&&ThisLife.mgModalContainer.setSelection(t,i),this.mgShopping=!0,ThisLife.mgModalContainer.startShopping(),ThisLife.Support.keyInformant.on("cancel",this._keyCancel,this),ThisLife.mgModalContainer.show(n)},doneShopping:function(){return this.mgShopping=!1,ThisLife.mgModalContainer.doneShopping(),this.mgSelectedMoments=null,this.usingSmall=$(window).width()<=this.responsiveBP,ThisLife.app.controller("selection").doneShopping(),ThisLife.Support.keyInformant.off("cancel",this._keyCancel,this)},create:function(){return this.startShopping(null)},toggleDropdown:function(){return this.createDropdownVisible?(this.usingDropdownMenu=!1,this.hideDropdown()):(this.usingDropdownMenu=!0,this.showDropdown())},show:function(){return this.el.style.display="block"},hide:function(){return this.el.style.display="none"},showDropdown:function(){return this.createDropdownVisible=!0,this.dropdown.style.visibility="visible",$(this.productWrapper).css("visibility","visible").css("display","block"),$(this.create_btn).addClass("open"),this.prints()},hideDropdown:function(){var e;return this.createDropdownVisible=!1,null!=(e=this.dropdown)&&(e.style.visibility="hidden"),$(this.productWrapper).css("visibility","hidden").css("display","none"),$(this.create_btn).removeClass("open")},getPhotosFromCollection:function(e,t,i){var n,o,s;return o=function(){return function(e){var n;return n=new Backbone.Collection,e.moments.forEach(function(e){return n.push("people"===t||"library"===t?e:new ThisLife.Model.Moment(e))}),"function"==typeof i?i(n):void 0}}(this),"library"===t||"people"===t?(e.moments=e.models,o(e)):"albums"===t?(n=e.models[0],null!=n&&null!=n.moments?o(n):null!=n?n.load(function(){return function(){return o(n)}}(this)):i(null)):"singleAlbum"===t?o(e):"Story"===(null!=(s=e.attributes)?s._explicitType:void 0)?null!=e.moments?o(e):e.load(function(){return function(){return o(e)}}(this)):void 0},preloadMagicshop:function(){var e,t;return e=ThisLife.mgModalContainer?ThisLife.mgModalContainer.el:this.prepareModalContainer(),t=function(e){return function(t,i,n){var o;return o=e.mgShopping?e.mgSelectedMoments:e.collection,e.currentMomentsHash=ThisLife.ProductsLogic.hashMoments(o),i.collection=o,e.productsPreloaded[t].html=n.render(i).el,e.loadingPreload=!1,e.trigger("preload:finished")}}(this),this.productCategories.forEach(function(i){return function(n){var o,s,r,l;switch(n){case"photobook":s="books";break;case"photogifts":s="gifts";break;case"prints":s="prints";break;case"homedecor":s="decor";break;case"kids":s="kids";break;case"calendar":s="calendars";break;case"cns":s="cards"}return o=new ThisLife.View.MagicShopFloatingView({mouseleaveCallback:i.onMouseleaveMG.bind(i),mouseenterCallback:i.onMouseenterMg.bind(i),callback:i.actionCallback.bind(i),view:n,catcher:i.usingSmall?$(i.small_catcher):null,menuElement:null!=(l=$(i.menuElement))?l.find("li."+s):void 0,modalContainer:e}),r={productType:n,insideContainer:i.usingSmall,container:i.container},i.mgShopping&&(r.manualSelection=!0,r.collection=i.mgSelectedMoments),i.productsPreloaded[n]={widget:o,added:!0,currentState:"api"},i.loadingCollection||null==i.collection?i.loadingCollection?(i.loadingPreload=!0,i.on("collection:loaded",function(){return i.off("collection:loaded"),t(n,r,o)})):null!=i.homepageCollection?(i.collection=i.homepageCollection,t(n,r,o)):i.loadingHomepageCollection?(i.loadingPreload=!0,i.on("hpcollection:loaded",function(){return i.off("hpcollection:loaded"),i.collection=i.homepageCollection,t(n,r,o),i.trigger("preload:finished")})):i.loadingPersonCollection?(i.loadingPreload=!0,i.on("persontagcollection:loaded",function(){return i.off("persontagcollection:loaded"),t(n,r,o)})):i.productsPreloaded[n].html=o.render(r).el:t(n,r,o)}}(this)),ThisLife.mgModalContainer.setWidgets(this.productsPreloaded),this},updateWidgetsWithPhotos:function(){return this.productCategories.forEach(function(e){return function(t){var i;return i={productType:t,manualSelection:!0,collection:e.mgSelectedMoments,onlyUpdateCollection:!0},e.productsPreloaded[t].widget.updatePhotos(i)}}(this)),this.currentMomentsHash=ThisLife.ProductsLogic.hashMoments(this.mgSelectedMoments)},prepareModalContainer:function(){return ThisLife.mgModalContainer=new ThisLife.View.MagicShopModalContainer({defaultCategory:"prints",cancelCallback:this.doneShopping.bind(this)}),$("body").append(ThisLife.mgModalContainer.el),ThisLife.mgModalContainer.el},preloadTimed:function(){return this.getCurrentCollection(),clearTimeout(this.preloadTimer),this.prelaodTimer=setTimeout(this.preloadMagicshop.bind(this),2e3),this},loadAllCategories:function(e,t){var i;return i=_.without(this.productCategories,e),i.forEach(function(e){return function(i){return t.productType=i,e.productsPreloaded[i].widget.render(t).el}}(this))},showMgTooltip:function(e){var t,i,n,o;if(this.mgShopping)return this.hideFloatingWindows(),this.productsPreloaded[e].widget.show(this,e),void(this.showingMG=!0);if("people"!==ThisLife.app.currentState.fragment||(null!=(n=ThisLife.View.peopleSection.peopleView)?!n.inDrag:!0))return clearTimeout(this.preloadTimer),this.getCurrentCollection(),this.loadingPreload||(this.selection.isEmpty()?(i={productType:e,container:this.container,insideContainer:this.usingDropdownMenu},"library"===this.collectionType&&(this.didScroll?(this.collection=ThisLife.app.library._layout.getVisibleDateCollectionInCenterWithSurrounding(20),this.getPhotosFromCollection(this.collection,this.collectionType,function(e){return function(t){return e.collection=t}}(this))):(this.loadingCollection=!0,null===this.homepageCollection?ThisLife.ProductsLogic.getCollectionForHomepage(function(e){return function(t){return e.collection=t||new Backbone.Collection,e.homepageCollection=t||new Backbone.Collection,e.loadingCollection=!1,e.trigger("collection:loaded")}}(this)):(this.collection=this.homepageCollection,this.loadingCollection=!1,this.trigger("collection:loaded")))),"singleAlbum"===this.collectionType&&(i.manualSelection=!0),this.loadingCollection?this.on("collection:loaded",function(t){return function(){var n;return i.collection=t.collection,n=ThisLife.ProductsLogic.hashMoments(t.collection),n!==t.currentMomentsHash&&(t.currentMomentsHash=n,t.productsPreloaded[e].widget.render(i).el,_.defer(function(){return t.loadAllCategories(e,i)})),t.off("collection:loaded")}}(this)):(t=ThisLife.ProductsLogic.hashMoments(this.collection),null!=this.collection&&(i.collection=this.collection),t!==this.currentMomentsHash&&(this.currentMomentsHash=t,this.productsPreloaded[e].widget.render(i).el,_.defer(function(t){return function(){return t.loadAllCategories(e,i)}}(this)))),this.productsPreloaded[e].currentState="api"):(o=this.selection.getCollection(),t=ThisLife.ProductsLogic.hashMoments(o),t!==this.currentMomentsHash&&(this.currentMomentsHash=t,i={productType:e,container:this.container,manualSelection:!0,collection:o,insideContainer:this.usingDropdownMenu},this.productsPreloaded[e].widget.render(i).el,_.defer(function(t){return function(){return t.loadAllCategories(e,i)}}(this))),this.productsPreloaded[e].currentState="manual")),this.loadingCollection&&!this.loadingPreload?this.on("collection:loaded",function(t){return function(){return t.hideFloatingWindows(),t.productsPreloaded[e].widget.show(t,e),t.off("collection:loaded")}}(this)):!this.loadingCollection&&this.loadingPreload?this.on("preload:finished",function(t){return function(){return t.hideFloatingWindows(),_.defer(function(){return t.productsPreloaded[e].widget.show(t,e)}),t.off("preload:finished")}}(this)):(this.hideFloatingWindows(),this.productsPreloaded[e].widget.show(this,e)),this.showingMG=!0,this},books:function(){return this.showMgTooltip("photobook")},gifts:function(){return this.showMgTooltip("photogifts")},prints:function(){return this.showMgTooltip("prints")},decor:function(){return this.showMgTooltip("homedecor")},kids:function(){return this.showMgTooltip("kids")},calendars:function(){return this.showMgTooltip("calendar")},cards:function(){return this.showMgTooltip("cns")},startTimer:function(e){return clearTimeout(this.hoverTimer),this.hoverTimer=setTimeout(this.showProducts.bind(this,e),this.timerInterval)
},endHover:function(){return clearTimeout(this.hoverTimer)},startHoverBooks:function(){return this.currentHover="photobook",this.startTimer(this.currentHover),this},startHoverGifts:function(){return this.currentHover="photogifts",this.startTimer(this.currentHover),this},startHoverPrints:function(){return this.currentHover="prints",this.startTimer(this.currentHover),this},startHoverDecor:function(){return this.currentHover="homedecor",this.startTimer(this.currentHover),this},startHoverKids:function(){return this.currentHover="kids",this.startTimer(this.currentHover),this},startHoverCalendars:function(){return this.currentHover="calendar",this.startTimer(this.currentHover),this},startHoverCards:function(){return this.currentHover="cns",this.startTimer(this.currentHover),this},onMouseleaveMG:function(){return $("body").off("mousemove.mg"),$("body").off("click.mg"),$(this.magicShopOverlay).hide(),this.mgShopping&&this.doneShopping(),this.hideFloatingWindows(),this.showingMG=!1,this.insideTooltip=!1,this.usingSmall&&(this.usingDropdownMenu=!1,this.hideDropdown()),this},onMouseenterMg:function(){return this.insideTooltip=!0,this},doneCallback:function(e){var t,i;return t=ThisLife.Model.User.getLifePermission(),i=t.person_uid!==t.owner_person_uid?t.owner_person_uid:t.person_uid,"function"==typeof e?e(ThisLife.ProductsLogic.formatCollection(this.selection.getCollection(),i)):void 0},cancelCallback:function(e){return"function"==typeof e&&e(),this},actionCallback:function(e){var t,i,n,o,s,r;if(t=e.action,"select_photos"===t)ThisLife.ProductsLogic.shouldRedirectToLibrary()?(this.redirectedToLibrary=!0,this.redirectedFrom=Backbone.history.fragment,ThisLife.app.router.navigate("library")):(this.redirectedToLibrary=!1,this.redirectedFrom=null),ThisLife.app.controller("selection").start({viewType:"magicshop",viewTypeOption:e.productType,"default":"select_pb",isChoosePhotobookPhotos:!0,doneCallback:this.doneCallback.bind(this,e.onSuccess),cancelCallback:this.cancelCallback.bind(this,e.onFail),productType:e.productType}),ThisLife.mgModalContainer.hide();else{if("showing_product"===t)return this.redirectedToLibrary&&ThisLife.app.router.navigate(this.redirectedFrom),this;if("hide_window"===t)return this;if("finished_view_render_photos_vert"===t)return n=e.productType,this.currentHover===n&&null!=(o=this.productsPreloaded[n])&&o.widget.bindMouseMovement(),this;if("close_modal"===t)this.selection.done();else{if("update_modal_menu"===t)return s=e.category,r=e.pId,ThisLife.mgModalContainer.setSelection(s,r),this;if("load_categories"===t)return i={productType:e.productType,container:this.container,force:e.force,insideContainer:this.usingDropdownMenu},_.defer(function(t){return function(){return t.loadAllCategories(e.productType,i)}}(this)),this}}return this.onMouseleaveMG()},onMouseleaveButtonsArea:function(){return setTimeout(function(e){return function(){return e.insideTooltip||e.usingDropdownMenu?void 0:(e.hideFloatingWindows(),e.showingMG=!1)}}(this),200),this},showProducts:function(e){if(e===this.currentHover)switch(e){case"photobook":this.books();break;case"photogifts":this.gifts();break;case"prints":this.prints();break;case"homedecor":this.decor();break;case"kids":this.kids();break;case"calendar":this.calendars();break;case"cns":this.cards()}return this},disableButtons:function(){return $(this.el).find(".primary_btn").addClass("disabled")},enableButtons:function(){return $(this.el).find(".primary_btn").removeClass("disabled")},remove:function(){return this.unbindEvents(),this.removeAllMagicshops(),this.$el.remove(),this}}),e=function(){return'<div class="primary_btn create">\n    <div class="btn_text">\n      <span>PRODUCTS</span>\n    </div>\n</div>\n<div class=\'dropdown\'>\n  <div class="close-btn"><img src="/assets/1px.gif"></div>\n  <ul class="widget-list">\n    <li class="primary_btn prints">\n      <div class="btn_text">\n        <span>Prints</span>\n      </div>\n    </li>\n    <li class="primary_btn books ">\n      <div class="btn_text">\n        <span>Photo Books</span>\n      </div>\n    </li>\n    <li class="primary_btn cards">\n      <div class="btn_text">\n        <span>Cards</span>\n      </div>\n    </li>\n    <li class="primary_btn calendars">\n      <div class="btn_text">\n        <span>Calendars</span>\n      </div>\n    </li>\n    <li class="primary_btn gifts">\n      <div class="btn_text">\n        <span>Gifts</span>\n      </div>\n    </li>\n    <li class="primary_btn decor">\n      <div class="btn_text">\n        <span>Home Decor</span>\n      </div>\n    </li>\n    <li class="primary_btn kids">\n      <div class="btn_text">\n        <span>Kids</span>\n      </div>\n    </li>\n  </ul>\n  <div class="create-products-wrapper">\n  </div>\n  <div class="create-products-small-catcher"></div>\n\n</div>\n<div class="magicshop-overlay"></div>'},define("ThisLife.View.SecondaryBar.CreateBtns",[],function(){return ThisLife.View.SecondaryBar.CreateBtns})}.call(this),function(){var e;e=[{label:"People",slug:"people",subSection:"people",includeCount:!1},{label:"Tags",slug:"tags",subSection:"tags",includeCount:!1}],define("ThisLife.View.PrimaryBar.SectionDropdown",[],function(){var t;return t=Backbone.View.extend({id:"section_dropdown",className:"top_bar_dropdown section_dropdown",events:{mousedown:"_onMouseDown",mouseleave:"_onMouseLeave"},initialize:function(t){return this.section=t.section,this.subSection=t.subSection,this._bindEvents(),this.dropDownValues=e,this.currentItem=_.find(this.dropDownValues,function(e){return function(t){return e.subSection===t.subSection}}(this)),this.render()},_bindEvents:function(){return ThisLife.app.controller("selection").on("start",this.hideDropdown,this),ThisLife.PubSub.on("peopleViewInitialized",this._onHideNotification,this)},_unbindEvents:function(){return ThisLife.app.controller("selection").off(null,null,this)},render:function(){var e,t,i,n;return e=this.currentItem||this.dropDownValues[0],this.el.classList.remove("active"),this.el.insertAdjacentHTML("beforeend",this._getTemplate({dropDownValues:this.dropDownValues,currentLabel:(null!=(t=this.currentItem)?t.label:void 0)||"",subSection:(null!=(i=this.currentItem)?i.subSection:void 0)||""})),this._cacheElements(),this.el.classList.add(e.subSection),this._labelEl.dataset.href=e.subSection,this.dropDownValues.length<=1&&this.el.classList.add("text"),this.section===(null!=(n=this.currentItem)?n.subSection:void 0)&&this.el.classList.add("active"),this._addMobileUpdate(),this},_cacheElements:function(){return this._dropdownEl=this.el.querySelector(".dropdown"),this._labelEl=this.el.querySelector(".label"),this._iconEl=this.el.querySelector(".label .icon"),this._textEl=this.el.querySelector(".label .text"),this._sectionIconEl=this.el.querySelector(".section_dropdown .icon"),this},changeState:function(e){var t,i,n,o,s,r,l;for(this.el.classList.remove("active"),this._dropdownEl.classList.remove("first_item_selected"),s=this._dropdownEl.querySelectorAll("li"),t=0,n=s.length;n>t;t++)i=s[t],i.classList.remove("selected");return this.section=e.section,this.subSection=e.subSection,o=_.find(this.dropDownValues,function(e){return function(t){return e.subSection===t.subSection}}(this)),o?(this.el.classList.remove(null!=(r=this.currentItem)?r.subSection:void 0),o.label===this.dropDownValues[0].label&&this._dropdownEl.classList.add("first_item_selected"),this._textEl.innerHTML=o.label,this.el.classList.add("active"),this.el.classList.add(o.subSection),this._labelEl.dataset.href=o.subSection,null!=(l=this._dropdownEl.querySelector("li[data-href="+o.slug+"]"))&&l.classList.add("selected"),this.currentItem=o):void 0},_toggleDropdown:function(){return this.sectionDropdownVisible?this.hideDropdown():this.showDropdown()},_onHideNotification:function(){return this.peopleViewInitialized=!0,this._updatePeopleCount(0)},_onChangeGroupCount:function(e){return this._updatePeopleCount(e.get("count"))},_updatePeopleCount:function(e){return e>25&&(e="25+"),this.el.querySelector(".label .notify").dataset.count=e},_onMouseDown:function(){return this.showDropdown()},_onMouseLeave:function(){return this.hideDropdown()},showDropdown:function(){return this.sectionDropdownVisible=!0,this._dropdownEl.style.display="block",this.el.classList.add("dropdown_visible")},hideDropdown:function(){var e;return this.el.classList.remove("dropdown_visible"),this.sectionDropdownVisible=!1,null!=(e=this._dropdownEl)?e.style.display="none":void 0},remove:function(){return this._unbindEvents(),this.$el.remove(),this},_addMobileUpdate:function(){return ThisLife.app.isMobile?$(this._sectionIconEl).addClass("hidden-xs"):void 0},_getTemplate:function(e){var t,i,n,o,s,r;if(null==e&&(e={}),t="",e.dropDownValues.length>1){for(o="",r=e.dropDownValues,i=0,s=r.length;s>i;i++)n=r[i],o+='<li data-href="'+n.slug+"\" class='border "+(n.label===e.currentLabel?" selected":"")+"'>\n  "+n.label+'\n  <div class="check"></div>\n  '+(n.includeCount?'<div class="notify" data-count="0"></div>':"")+"\n</li>";t='<div class="dropdown '+(e.dropDownValues[0].label===e.currentLabel?"first_item_selected":"")+'">\n  <div class="hover_state_transition_wrap"></div>\n  <ul>'+o+"</ul>\n</div>"}return e.subSection||(e.subSection=e.dropDownValues[0].subSection,e.currentLabel=e.dropDownValues[0].label),'<div class="label dropdown_arrow">\n  <div class="icon">\n    <div class="notify" data-count="0"></div>\n  </div>\n  <div class="text">'+e.currentLabel+'</div>\n  <div class="arrow_bg"></div>\n  <div class="underline"></div>\n</div>\n'+t}})}),ThisLife.View.PrimaryBar.SectionDropdown=require("ThisLife.View.PrimaryBar.SectionDropdown")}.call(this),function(){var e;define("ThisLife.SecondaryBar.Views.Upload",["ThisLife.Helper.Features"],function(e){var t;return t=Backbone.View.extend({className:"secondarybar-upload",events:{click:"showFlyout"},initialize:function(t){return this.options=null!=t?t:{},"add"===this.options.state.fragment?this.el.classList.add("active"):this.el.classList.remove("active"),e.whenReady("upp",function(e){return function(t){return e.useUPP=t}}(this)),e.whenReady("upload_source",function(e){return function(t){return e.useUpload=t}}(this)),this},render:function(){return this.el.insertAdjacentHTML("afterbegin",this._template()),ThisLife.app.isMobile&&!this.useUPP&&(this.el.style.display="none"),this.flyout=this.el.querySelector(".upload__flyout"),this},_upload:function(e){var t,i,n,o;return t="albums"===ThisLife.app.currentState.name?ThisLife.app.album.getCurrentAlbum():null,i=t&&t.isOwner(ThisLife.currentLifeOwner)||t&&!t.isOwner(ThisLife.currentLifeOwner)&&!t.get("permission.view_only")?t.id:void 0,o={albumId:i,show_sfly:!1,context:e.action},"myComputer"===e.action&&(o.bypass=!0,o.filepicker=!0,n=document.getElementsByName("upp_filepicker")[0],n.click()),o.labelsContext="upload",ThisLife.app.controller("tracking").logUPPLaunchSource(e.action),ThisLife.app.controller("uploader").upp(o),this},showFlyout:function(e){var t,i,n;return n=e.target,n.classList.contains("disabled")?void 0:(t="albums"===ThisLife.app.currentState.name?ThisLife.app.album.getCurrentAlbum():null,i=t&&t.isOwner(ThisLife.currentLifeOwner)||t&&!t.isOwner(ThisLife.currentLifeOwner)&&!t.get("permission.view_only")?t.id:void 0,this.useUpload&&!ThisLife.app.isMobile?this.useUPP?this.flyout.classList.contains("active")?void this.hideDropdown():(this._dropdownView?this._dropdownView.show():this._createDropdown(),this.flyout.classList.add("active")):void(null==t||t.get("permission.view_only")?ThisLife.app.router.navigateToAdd():ThisLife.app.router.navigateToAlbumUpload(t.id)):ThisLife.app.controller("uploader").upp({albumId:i,show_sfly:!1,labelsContext:"upload"}))},_createDropdown:function(){var e;return e={items:[{action:"myComputer",icon:"my-computer",label:"My Computer",onClick:function(e){return function(t){return e._upload(t)}}(this)},{action:"mobiledevice",icon:"mobile-device",label:"Mobile Device",onClick:function(e){return function(t){return e._upload(t)}}(this)},{action:"sites",icon:"share-sites",label:"Share Sites",onClick:function(e){return function(t){return e._upload(t)}}(this)},{action:"google",icon:"google",label:"Google",onClick:function(e){return function(t){return e._upload(t)}}(this)},{action:"fb",icon:"facebook",label:"Facebook",onClick:function(e){return function(t){return e._upload(t)}}(this)},{action:"instagram",icon:"instagram",label:"Instagram",onClick:function(e){return function(t){return e._upload(t)}}(this)}],styles:{"default":{width:"168px",right:"18px",textTransform:"none",fontWeight:"normal",fontSize:"14px"},mobile:{bottom:"0px"}},arrowAlign:"right",classes:["upload-dropdown_flyout"],onHide:_.bind(this.hideDropdown,this)},this._dropdownView=ThisLife.app.controller("flyout").get("upload-dropdown").show(e),this.flyout.appendChild(this._dropdownView.el)},hideDropdown:function(){return this.flyout.classList.remove("active"),this._dropdownView=null},_template:function(){return'<div>Upload</div>\n<div class="upload__flyout"></div>'}})}),(e=ThisLife.View).SecondaryBar||(e.SecondaryBar={}),ThisLife.View.SecondaryBar.Upload=require("ThisLife.SecondaryBar.Views.Upload")}.call(this),function(){var e;define("ThisLife.Timeline.Views.SortByDropdown",["ThisLife.PubSub"],function(e){var t;return t=Backbone.View.extend({className:"top_bar_dropdown section_dropdown",sortOptions:{momentDate:"Date Taken",uploadDate:"Date Uploaded"},events:{"click .sort_by_mobile":"toggleDropdown","click .sort_by_date_link":"onSortLinkClick"},initialize:function(){return this},render:function(){return this.el.insertAdjacentHTML("beforeend",this._template()),this.cacheElements(),this.bindEvents(),this},cacheElements:function(){return this.sortMobile=this.el.querySelector(".sort_by_mobile"),this.mobile_selected=this.el.querySelector(".mobile_selected"),this.desktop_selected=this.el.querySelector(".sort_by")},teardown:function(){return this.unbindEvents(),this.remove()},bindEvents:function(){return e.on("update:sort",this.updateViewForSortingChange,this)},unbindEvents:function(){return e.off("update:sort",this.updateViewForSortingChange,this)},toggleDropdown:function(){return null!=this._dropdownView?(this._dropdownView.teardown(),this._dropdownView=null):this.createDropdown()},createDropdown:function(){var e,t,i;e=[];for(t in this.sortOptions)e.push({type:"radio",name:"permission_value",value:t,label:this.sortOptions[t],selected:t===ThisLife.Collection.moments.getSort()?!0:!1,disabled:!1,onClick:_.bind(this.setValueForFlyout,this)});return i={items:e,styles:{top:"41px",right:"-21px",width:"150px"},arrowAlign:"right"},this._dropdownView=ThisLife.app.controller("flyout").get("timeline_sort").show(i),this.sortMobile.appendChild(this._dropdownView.el)},updateViewForSortingChange:function(e){var t;return this.mobile_selected.textContent=this.sortOptions[e],null!=(t=this.desktop_selected.querySelector(".active"))&&t.classList.remove("active"),this.desktop_selected.querySelector('[data-sort="'+e+'"]').classList.add("active")},setValue:function(e){return e!==ThisLife.Collection.moments.getSort()?(this.updateViewForSortingChange(e),ThisLife.Collection.moments.setSort(e),this._sendMetrics(e)):void 0},_sendMetrics:function(e){var t,i,n;return i={momentDate:"Sort:click-moment_date",uploadDate:"Sort:click-upload_date"},t=i[e],n="albums"===ThisLife.app.currentState.name?"appalbum":"applibrary"},setValueForFlyout:function(e){return this.setValue(e.value)},onSortLinkClick:function(e){var t;return t=e.currentTarget.getAttribute("data-sort"),this.setValue(t)},_renderSortOptions:function(){var e,t,i,n,o;o="";for(i in this.sortOptions)n=this.sortOptions[i],e=i.toString(),t="",i.toString()===ThisLife.Collection.moments.getSort()&&(t=" active"),o+='<a href="javascript:;" data-sort="'+e+'" class="sort_by_date_link sort_by_link'+t+'">'+n+"</a>";return o},_template:function(){var e;return e=this.sortOptions[ThisLife.Collection.moments.getSort()],'<div class="sort_by_section">\n  <span class="sort_by_title">Sort by </span>\n  <div class="sort_by">\n    '+this._renderSortOptions()+'\n  </div>\n  <div class="sort_by_mobile">\n    <a href="javascript:;" class="mobile_selected">'+e+'</a>\n    <span class="arrow"></span>\n  </div>\n</div>'}})}),ThisLife.Timeline||(ThisLife.Timeline={}),(e=ThisLife.Timeline).Views||(e.Views={}),ThisLife.Timeline.Views.SortByDropdown=require("ThisLife.Timeline.Views.SortByDropdown")}.call(this),function(){var e;define("ThisLife.View.BottomBar",[],function(){var t;return t=Backbone.View.extend({el:"#tl_bottom_bar",events:{"click .upload":"upload","click .feedback":"toggleFeedback","click .feedback_icon":"toggleFeedback","click .close-btn":"toggleFeedback","click .feedback_btn":"launchFeedback","click .faq_btn":"launchFAQ","click .delete_icon:not(.disabled)":"openTrash","click .undo_link":"undoTrash"},initialize:function(){return ThisLife.PubSub.on("state:change",this.stateChanged,this),ThisLife.Model.User.on("change:default_life_subscription",this.subscriptionChanged,this).on("overPlanLimit",this.overPlanLimit,this),this.cacheElements(),this.addMobileUpdates(),ThisLife.Collection.moments.whenLoaded(function(e){return function(){return e.collection=ThisLife.Collection.moments,e.deleteCol=[],e.collection.on("change:hidden",e.addDeleteIcon,e).on("remove",e.addDeleteIcon,e),e.addDeleteIcon()}}(this))},unBindEvents:function(){return ThisLife.removeBlurEvent(blurEventCallback),ThisLife.removeBlurEvent(trashCanEventCallback)},getElement:function(e){return this[e+"El"]},removeActiveClass:function(){var e;return null!=(e=this.getElement(this.currentView))?e.classList.remove("active"):void 0},cacheElements:function(){var e,t,i,n,o;for(this.bottomLeft=document.getElementById("tl_bottom_bar_left"),this.bottomRight=document.getElementById("tl_bottom_bar_right"),this.bottomButtons=document.getElementById("tl_bottom_bar_btns"),this.upgradeWrap=$(".upgrade_wrap"),this.feedback=$(".feedback"),this.closeBtn=$(".close-btn"),this.feedback_secondary=$(".feedback_secondary"),this.helpBtn=$(".help_btn"),this.feedback_icon=$(".feedback_icon"),this.delete_icon=$(".delete_icon"),this.trashnum=$(".trash_num"),n=["day","month","year"],o=[],t=0,i=n.length;i>t;t++)e=n[t],o.push(this[e+"El"]=this.el.querySelector("."+e));return o},stateChanged:function(e){var t;return null!=(t=this.overlayView)&&t.remove(),ThisLife.Helper.DOM.addRemoveClass(this.helpButton,e.story,"hidden")},updateHelpTooltip:function(){return ThisLife.appModel.getFeedbackTooltip()?void 0:(this.feedback.addClass("show"),ThisLife.appModel.setFeedbackTooltip(!0),this.addFeedbackBlurEvent())},addMobileUpdates:function(){return ThisLife.Helper.Platform.mobile()?$(this.bottomButtons).addClass("mobile"):void 0},addFeedbackBlurEvent:function(){var e,t;return t?void 0:(t=!0,e=ThisLife.blurEvent($(".feedback"),function(e){return function(){return t=!1,e.feedback.removeClass("show")}}(this)))},upload:function(){var e;return e="albums"===ThisLife.app.currentState.name?ThisLife.app.album.getCurrentAlbum():null,null==e||e.get("permission.view_only")?ThisLife.app.router.navigateToAdd():ThisLife.app.router.navigateToAlbumUpload(e.id)},addHelpButton:function(){return this.helpButton?void 0:(this.bottomRight.insertAdjacentHTML("beforeend",e),this.helpButton=this.bottomRight.querySelector(".help_btn"))},addDeleteIcon:function(){return ThisLife.Collection.moments.getNumHidden()>0?$(this.delete_icon).removeClass("disabled"):$(this.delete_icon).addClass("disabled")},toggleFeedback:function(){return this.feedbackVisible?this.hideFeedback():this.showFeedback()},_sendMetrics:function(){},showFeedback:function(){var e;return this.feedbackVisible=!0,this.feedback_secondary.addClass("show"),this.helpBtn.addClass("show_feedback"),this.feedback_icon.addClass("selected"),null!=(e=this.feedback)&&e.removeClass("show"),this.blurEventCallback=ThisLife.blurEvent($(".feedback_secondary"),function(e){return function(){return e.hideFeedback()}}(this))},hideFeedback:function(){return this.feedbackVisible=!1,this.feedback_secondary.removeClass("show"),this.helpBtn.removeClass("show_feedback"),this.feedback_icon.removeClass("selected"),ThisLife.removeBlurEvent(this.blurEventCallback)},launchFeedback:function(){return ThisLife.app.loadMaritzCXSurvey(),this.toggleFeedback()},launchFAQ:function(){return window.open(ThisLife.Settings.faqUrl,"_blank"),this.toggleFeedback()},openTrash:function(){return ThisLife.app.router.navigateToTrash()}})}),e='<div class="help_btn">\n  <div class="icon"></div>\n</div>',ThisLife.View.BottomBar=require("ThisLife.View.BottomBar")}.call(this),function(){var e;ThisLife.View.FacebookReconnectPopup=Backbone.View.extend({className:"gray_dropdown_overlay",events:{"click .close-btn, .gray-btn":"remove","click #facebook_reconnect_btn":"reconnect"},initialize:function(){return this.render(),document.body.appendChild(this.el)},render:function(){return this.el.insertAdjacentHTML("beforeend",e)},reconnect:function(){return ThisLife.Service["import"].connect("facebook"),this.remove()}}),e='<div class="gray_dropdown cover_popup cover_tip facebook_reconnect">\n  <span class="close-btn"><img src="/assets/1px.gif"></span>\n  <h3>Please reconnect to Facebook</h3>\n  <p>Facebook sharing now enables you to share your full sized images.<br />To do this you need to reconnect with Facebook. <br /><br />(We will never post to your timeline unless you choose to share them to Facebook)</p>\n  <a id="facebook_reconnect_btn">Reconnect to Facebook</a>\n  <div class="bottom">\n    <a class="gray-btn">Not now</a>\n  </div>\n</div>'}.call(this),function(){var e,t;e=Backbone.View.extend({className:"tl_timeline_tooltip_overlay processing",initialize:function(){return ThisLife.PubSub.once("removeFilter",this.remove,this)},render:function(){return this.el.insertAdjacentHTML("afterbegin",t),document.body.appendChild(this.el),this},remove:function(){return this.$el.remove(),this}}),t="<div class='tl_timeline_tooltip'>\n  <div class='processing_filter'><img src='/assets/1px.gif' /></div>\n  <p>Processing Filter&hellip;</p>\n</div>",ThisLife.PubSub.on("addFilter",function(){var t;return t=new e,t.render().el})}.call(this),function(){var e,t,i,n;t=0,n=void 0,i=void 0,e=Backbone.View.extend({className:"loader",initialize:function(){return ThisLife.PubSub.on("addLoader",this.show,this),ThisLife.PubSub.on("removeLoader",this.hide,this),ThisLife.PubSub.once("state:change",this.stateChanged,this),this.setup()},stateChanged:function(){return this.loadedCount=0,ThisLife.Collection.moments.whenLoaded(function(e){return function(){return e.loadedCount++,e.checkLoadedCount()}}(this)),ThisLife.Collection.personTags.whenLoaded(function(e){return function(){return e.loadedCount++,e.checkLoadedCount()}}(this))},checkLoadedCount:function(){return this.loadedCount>1?this.hide():void 0},setup:function(){return this.setElement(document.querySelector("#loading-view"))},hide:function(){return document.getElementById("demo").classList.remove("loading"),this.$el.hide()},show:function(){return document.getElementById("demo").classList.add("loading"),this.$el.show()},remove:function(){return clearInterval(i),this.$el.remove(),this}}),ThisLife.View.LoaderView=e}.call(this),function(){ThisLife.View.HoverTooltip=Backbone.View.extend({events:{mouseenter:"show",mouseleave:"hide",click:"hide","click .disabled_tooltip_wrap":function(e){return e.stopPropagation()}},initialize:function(e){return null==e&&(e={}),this.onCanShow=e.onCanShow||function(){return!0},this.showClassName=e.showClassName||"show",this.wrapEl=this.el.querySelector(e.wrapSelector)},show:function(){var e;if(null!=this.wrapEl&&this.onCanShow(this.wrapEl))return this.wrapEl.classList.remove(this.showClassName),e=function(e){return function(){return e.wrapEl.classList.add(e.showClassName)}}(this),this.timerId=setTimeout(e,500)},hide:function(){var e;return clearTimeout(this.timerId),null!=(e=this.wrapEl)?e.classList.remove(this.showClassName):void 0},teardown:function(){return this.hide(),this.remove()}})}.call(this),function(){ThisLife.View.Error=Backbone.View.extend({className:"popover_wrap popover_view_error show",events:{"click .orange-btn":"teardown","click .js_close_popup":"teardown"},once:Backbone.Events.once,initialize:function(e){return null==e&&(e={}),this.message=e.message||this.getDefaultMessage(),this.buttonLabel=e.buttonLabel||"Close",this.onClose=e.onClose,this.render()},show:function(){return document.body.appendChild(this.el)},render:function(){return this.el.insertAdjacentHTML("beforeend",this.template()),this.popoverEl=this.el.querySelector(".popover"),this.bindEvents(),this.reposition(),this},bindEvents:function(){return this.blurEvent=ThisLife.blurEvent(this.$(".popover"),_.bind(this.teardown,this)),ThisLife.Support.keyInformant.on("cancel",this.teardownOnCancel,this)},unbindEvents:function(){return ThisLife.Support.keyInformant.off("cancel",this.teardownOnCancel,this),ThisLife.removeBlurEvent(this.blurEvent)},getDefaultMessage:function(){return"Oops! Sorry, something wrong happened."},reposition:function(){return _.defer(function(e){return function(){return e.popoverEl.style.marginTop=-$(e.popoverEl).height()/2+"px"}}(this))},teardownOnCancel:function(e){return e.preventDefault(),this.teardown()},teardown:function(){return this.unbindEvents(),this.remove(),"function"==typeof this.onClose?this.onClose():void 0},template:function(){return'<div class="popover">\n  <span class="close-btn js_close_popup">\n    <img src="/assets/1px.gif">\n  </span>\n  <div class="body">\n      <p>'+this.message+'</p>\n      <a class="orange-btn">'+this.buttonLabel+"</a>\n  </div>\n</div>"}}),define("ThisLife.View.Error",[],function(){return ThisLife.View.Error})}.call(this),function(){ThisLife.notification=function(e,t,i,n){var o,s;return $("#alerts-popup-text").html(e),s=$("#alerts-popup").show(),s[n?"addClass":"removeClass"]("twitter"),o=s.find("div.alerts-popup-content").unbind("click"),s.find(".alerts-close").one("click",function(){return s.fadeOut("fast")}),t&&_.delay(function(){return s.fadeOut("fast")},t),i?o.clickOff(function(){return s.fadeOut("fast"),i()}):void 0},ThisLife.notificationList=function(e){var t,i,n,o;switch(o=i=null,t=!0,e){case"getChanges":n="<div class='get_changes'>Checking for Moment updates\u2026</div><div class='progress_bar'></div>";break;case"foundChanges":n="<div class='get_changes'>Updating Moments\u2026</div><div class='progress_bar'></div>";break;case"doneChanges":n="Update complete",o=3e3;break;case"facebookRetry":n="<div class='facebook_alert'>Please reconnect to Facebook: <a class='fb_connect'></a> </div>",i=function(){return ThisLife.Service["import"].connect("facebook")};break;case"facebookFail":n="There was a problem connecting to Facebook - we're working on it.",o=1e4;break;case"validate":return void ThisLife.PubSub.trigger("notification:facebookretry")}return ThisLife.notification(n,o,i,t)}}.call(this),function(){var e,t;ThisLife.View.SocialImport=Backbone.View.extend({events:{"mouseup .import_btn.import":"importAll"},initialize:function(e){return this.options=null!=e?e:{},this.model=this.options.model,this.bindEvents(),this.importing={},this.backgroundImporting=!1,this.getSflyCookie(),this.render()},bindEvents:function(){return this.model.on("change:facebook_access_token",function(){return this.changeAccessToken("facebook")},this).on("change:flickr_access_token",function(){return this.changeAccessToken("flickr")},this).on("change:picasa_access_token",function(){return this.changeAccessToken("picasa")},this).on("change:instagram_access_token",function(){return this.changeAccessToken("instagram")},this).on("change:twitter_access_token",function(){return this.changeAccessToken("twitter")},this).on("change:smugmug_access_token",function(){return this.changeAccessToken("smugmug")},this)},getSflyCookie:function(){return this.newSflyUser=$.cookies.get("is_new_sfly_user"+ThisLife.Settings.cookieSuffix)},changeAccessToken:function(t){var i,n,o;return o=this.model.get(t+"_access_token"),o&&(this.$(".import_btn."+t).addClass("imported").removeClass("connect"),this.$(".import_btn."+t+" iframe").remove(),null!=(i=this.el.getElementsByClassName("background_importing"))&&null!=(n=i[0])&&(n.style.display="block"),this.$el.is(":visible")&&"instagram"!==t&&ThisLife.Service["import"].importAll(t)),this.$(".import_btn."+t).addClass("connect").removeClass("import"),e(t,this.model).appendTo(this.$(".import_btn."+t))},importAll:function(e){var t,i,n,o,s;return s=e.currentTarget,o=s.dataset.service,i=new Date,s.classList.add("imported"),s.classList.remove("import"),this.importing[o]=!0,this.backgroundImporting=!0,t=function(e){return function(){var t,i;return null!=(t=e.el.getElementsByClassName("background_importing"))&&null!=(i=t[0])?i.style.display="block":void 0}}(this),n=function(e){return function(){return e.importing[o]=!1,s.classList.remove("imported"),s.classList.add("import")}}(this),"instagram"!==o?ThisLife.Service["import"].importAll(o,t,n):void 0},render:function(){return ThisLife.Model.User.whenLoaded(function(i){return function(){var n;return i.$el.html(t(i.model,i.options)),n=["instagram","flickr","picasa","smugmug","facebook"],_.each(n,function(t){var n;return n=i.$el.find("."+t+".import_btn"),n?n.append(e(t,i.model)):void 0})}}(this)),this.el},teardown:function(){return this.model.off(null,null,this),this.remove()}}),t=function(e,t){var i,n,o,s,r,l,a,u;if(e)return r=(null!=e?e.attributes.instagram_access_token:void 0)?"reconnect":"connect",n=(null!=e?e.attributes.flickr_access_token:void 0)?"import":"connect",a=(null!=e?e.attributes.picasa_access_token:void 0)?"import":"connect",u=(null!=e?e.attributes.smugmug_access_token:void 0)?"import":"connect",i=(null!=e?e.attributes.facebook_access_token:void 0)?"import":"connect",l=ThisLife.Model.User.isPaidAccount()?"photos and videos":"photos",s=null!=t.header?t.header:"Connect to these services and we'll start importing your "+l+" in the background. As we intelligently organize them, you'll see everything come together and begin rediscovering your memories.",o=null!=t.footer?t.footer:'<h4 class="small space_top">Tip: You can always do this later by clicking the "Add" button in your library.</h4>\n<p class="background_importing">Note: Import time can vary when accessing external sites.</p>','<h4 class="small">'+s+'</h4>\n\n<ul class="onboarding_services">\n  <li class="facebook '+i+' import_btn" data-service="facebook">\n    <img src="/1px.gif" />\n    '+(t.nocaption?"":"Facebook")+'\n  </li>\n  <li class="instagram '+r+' import_btn" data-service="instagram">\n    <img src="/1px.gif" />\n    '+(t.nocaption?"":"Instagram")+'\n    \n  </li>\n  <li class="picasa '+a+' import_btn" data-service="picasa">\n    <img src="/1px.gif" />\n    \n    '+(t.nocaption?"":"Picasa")+'\n  </li>\n  <li class="flickr '+n+' import_btn" data-service="flickr">\n    <img src="/1px.gif" />\n    \n    '+(t.nocaption?"":"Flickr")+'\n  </li>\n  <li class="smugmug '+u+' import_btn" data-service="smugmug">\n    <img src="/1px.gif" />\n    \n    '+(t.nocaption?"":"SmugMug")+"\n  </li>\n</ul>\n\n"+o},e=function(e,t){return(null!=t?t.attributes[e+"_access_token"]:void 0)&&"instagram"!==e?"":ThisLife.app.socialToken.getServiceIframe(e)}}.call(this),function(){ThisLife.View.Toggle=Backbone.View.extend({events:{mousedown:"mouseDown"},initialize:function(e){return null==e&&(e={}),_.bindAll(this,"mouseMove","mouseUp"),this.dragCss=e.dragCss||"no_transition",this.onCss=e.onCss||"on",this.handleQuerySelector=e.handleQuerySelector||".handle",this.moveToLimit=e.moveToLimit||13},mouseDown:function(e){return this.$handle||(this.$handle=$(this.el.querySelector(this.handleQuerySelector))),this.el.classList.add(this.dragCss),this.posX=e.clientX,this.offsetX=this.$handle.get(0).offsetLeft,$(window).on("mousemove",this.mouseMove).on("mouseup",this.mouseUp)},mouseMove:function(e){var t;return t=Math.min(this.offsetX-(this.posX-e.clientX),this.moveToLimit),this.moveTo=Math.max(t,1),this.$handle.css({left:this.moveTo})},mouseUp:function(e){var t,i;return i=this.posX===e.clientX?null:this.moveTo<this.moveToLimit/2?!1:!0,null==i&&(t=this.el.classList,i=t.contains(this.onCss)?!1:!0),this.el.classList.remove(this.dragCss),$(window).off("mousemove",this.mouseMove).off("mouseup",this.mouseUp),this.$handle.css({left:""}),i?(this.el.classList.add(this.onCss),this.trigger("on")):(this.el.classList.remove(this.onCss),this.trigger("off"))}})}.call(this),function(){ThisLife.View.Dropdown=Backbone.View.extend({className:"tl_dropdown",events:{"click .default_wrap":"_clickDefault","click .list_wrap":"_clickListWrap","click .footer_wrap .create_btn.album":"_clickCreateAlbum","click .footer_wrap .create_btn.folder":"_clickCreateFolder"},_isOpen:!1,_selectedItem:null,initialize:function(e){if(null==e&&(e={}),this._defaultText=e.defaultText||"",this._type=e.type||null,null===this._type)throw new Error("A dropdown type must be defined.");
return this.render(),this._cacheElements(),this._renderListContent()},render:function(){return this.el.insertAdjacentHTML("beforeend",this._getTemplate())},_cacheElements:function(){return this._defaultWrapEl=this.el.querySelector(".default_wrap .text"),this._listWrapEl=this.el.querySelector(".list_wrap"),this._footerWrapEl=this.el.querySelector(".footer_wrap"),this._dropdownErrorContainer=this.el.querySelector(".default_wrap .error_container"),this._dropdownInputWrapEl=this.el.querySelector(".default_wrap"),this._dropdownContentEl=this.el.querySelector(".content_wrap")},showDropdownError:function(e){var t;return null!=(t=this._dropdownErrorView)&&t.teardown(),this._dropdownErrorView=new ThisLife.View.ErrorTooltip({message:e}),this._dropdownErrorContainer.appendChild(this._dropdownErrorView.el),this._dropdownInputWrapEl.classList.add("error")},dismissDropdownError:function(){var e;return this._dropdownErrorView?(null!=(e=this._dropdownErrorView)&&e.teardown(),this._dropdownInputWrapEl.classList.remove("error")):void 0},findAndSelect:function(e){return this._listView.findAndSelect(e)},_handleItemSelected:function(e){return this._selectedItem=e,this._setDefaultWrapText(e),this.el.classList.add("selected"),this.close(),this.trigger("itemSelected",e)},_setDefaultWrapText:function(e){var t;return t="string"==typeof e?e:("function"==typeof e.has?e.has("name"):void 0)?e.get("name"):"Selection name unavailable",t=ThisLife.Helper.String.escapeHtml(t),this._setDefaultWrapContent(t)},_setDefaultWrapContent:function(e){return this._defaultWrapEl.innerHTML=e},_clickDefault:function(e){return e.preventDefault(),this.dismissDropdownError(),this._isOpen?this.close():this.open()},_clickListWrap:function(e){return e.preventDefault()},open:function(){var e;return this._isOpen=!0,this.el.classList.add("open"),this.el.classList.remove("invert_list"),ThisLife.Support.keyInformant.on("cancel",this.close,this),e=$(this._dropdownContentEl),e.height()+e.offset().top>$(window).height()&&this.el.classList.add("invert_list"),this.trigger("opened")},close:function(){return this._isOpen=!1,this.el.classList.remove("open"),ThisLife.Support.keyInformant.off("cancel",this.close,this),this.trigger("closed")},isOpen:function(){return this._isOpen},getSelectedItem:function(){return this._selectedItem},reset:function(){return this._listView.unselectAll(),this._selectedItem=null,this.dismissDropdownError(),this._setDefaultWrapText(this._defaultText),this.el.classList.remove("selected"),this.close()},_bindEvents:function(){return this._listView.on("itemSelected",this._onItemSelected,this)},_unbindEvents:function(){var e;return null!=(e=this._listView)?e.off(null,null,this):void 0},teardown:function(){return this._unbindEvents(),this._listView.teardown(),this.remove()},_renderListContent:function(){switch(this._type){case"album":this._listView=new ThisLife.Albums.View.BasicList,this._listWrapEl.appendChild(this._listView.el),this._footerWrapEl.insertAdjacentHTML("beforeend",this._getCreateAlbumTemplate()),this._bindEvents();break;case"folder":this._listView=new ThisLife.Albums.View.BasicFolderList,this._listWrapEl.appendChild(this._listView.el),this._footerWrapEl.insertAdjacentHTML("beforeend",this._getCreateFolderTemplate()),this._bindEvents()}return null},_onItemSelected:function(e){return this._listView.unselectAll(),this._handleItemSelected(e)},_clickCreateAlbum:function(){return this._listView.unselectAll(),this._selectedItem=null,this.trigger("createNew"),this._setDefaultWrapContent(this._getCreateAlbumTemplate()),this.close()},_clickCreateFolder:function(){return this._listView.unselectAll(),this._selectedItem=null,this.trigger("createNew"),this._setDefaultWrapContent(this._getCreateFolderTemplate()),this.close()},_getTemplate:function(){return'<div class="default_wrap">\n  <div class="error_container"></div>\n  <div class="arrow_icon"></div>\n  <div class="text">'+this._defaultText+'</div>\n  <div class="error_icon"></div>\n</div>\n<div class="content_wrap">\n  <div class="list_wrap"></div>\n  <div class="footer_wrap"></div>\n</div>'},_getCreateAlbumTemplate:function(){return'<div class="create_btn album">\n  <span class="icon"></span>\n  <span class="label">Create New Album</span>\n</div>'},_getCreateFolderTemplate:function(){return'<div class="create_btn folder">\n  <span class="icon"></span>\n  <span class="label">Create New Folder</span>\n</div>'}})}.call(this),function(){var e;ThisLife.View.ErrorTooltip=Backbone.View.extend({className:"tl_error_tooltip",initialize:function(e){return null==e&&(e={}),this.message=e.message,this.render(),this.cacheElements()},render:function(){return this.el.insertAdjacentHTML("beforeend",e(this.message))},cacheElements:function(){return this.messageEl=this.el.querySelector(".message")},setMessage:function(e){return this.messageEl.innerHTML=ThisLife.Helper.String.escapeHtml(e)},teardown:function(){return this.remove()}}),e=function(e){return'<div class="tooltip_wrap">\n  <div class="error_wrap">\n    <div class="message">'+e+'</div>\n  </div>\n  <div class="tooltip_arrow"></div>\n</div>'}}.call(this),function(){var e,t;ThisLife.View.StoriesTooltip=Backbone.View.extend({className:"story_tooltip_wrap show",events:{mouseleave:"onMouseLeave","click li":"heartMoment","click #js_create_story":"createStory"},initialize:function(e){return this.options=null!=e?e:{},this.model=ThisLife.Model.masterStory,this.render(),this},createStory:function(){return new ThisLife.View.CreateNewStory({autoAdd:this.options.autoAdd,fmv:!!this.options.fmv,showStory:!0})},heartMoment:function(e){return this.options.parentView.heartMoment(e)},onMouseLeave:function(e){var t;return t=$(e.relatedTarget),t.parents(".framed_moment").length||t.hasClass("framed_moment")?void 0:this.options.parentView.removeStoriesTooltip()},remove:function(){return this.$el.remove(),this},setList:function(){var t,i,n,o,s,r,l,a,u,c,d,h,p,f;if(p=this.model.getFollowedStories(),t=this.el.getElementsByTagName("h4")[0].textContent="Add to Album",h=this.el.getElementsByClassName("scrollbar")[0],this.model.myStories.models.length>0){for(l="",c=this.model.myStories.models,i=0,o=c.length;o>i;i++)f=c[i],l+=e(f);r=(this.model.otherStories.models.length>0?"<h4>My Albums</h4>":"")+"\n<ul>\n  "+l+"\n</ul>",h.insertAdjacentHTML("beforeend",r)}if(this.model.otherStories.models.length>0){for(u="",d=this.model.otherStories.models,n=0,s=d.length;s>n;n++)f=d[n],u+=e(f);if(a="<h4>Friends' Stories</h4>\n<ul>\n  "+u+"\n</ul>",u)return h.insertAdjacentHTML("beforeend",a)}},render:function(){return this.el.insertAdjacentHTML("beforeend",t),this.model.whenLoaded(this.setList,this),this}}),t='<div class="story_tooltip">\n  <h4 class="bar">Loading&hellip;</h4>\n  <div class="scrollbar">  \n    <!--<div class="create">\n      <a class="orange-btn small-btn">New Story</a>\n    </div>-->\n  </div>\n  <div class="bar bottom">\n    <a class="orange-btn small-btn" id="js_create_story">New Story</a>\n  </div>\n</div>',e=function(e){var t,i,n,o,s,r,l,a,u,c;return c=e.get("view_only"),t=c?"view_only":"",r=ThisLife.Helper.Stories.getStoryNameFromStoryUid(e.get("story_uid")),r=ThisLife.Helper.String.escapeHtml(r),o=e.get("story"),n=o.cover_owner_uid,u=o.cover_moment_uid,l=o.cover_effects_modified_date,u?(s="style='background-image: url("+ThisLife.Helper.Image.imgUrl(u,"x-small",l,n)+")'",i=""):(s="style=''",i="no_avatar"),a=o.uid,c?"":'<li class="'+t+'" data-uid="'+a+'"><div class="avatar '+i+'" '+s+"></div><span>"+r+"</span></li>"}}.call(this),function(){var e,t;ThisLife.View.StoriesList=Backbone.View.extend({el:document.getElementById("js_story_list_view"),events:function(){return{"click .stories_view_nav a":"switchStoryViews","click #js_auto_stories_wrap h1 .triangle":"collapseAutoStories","click #js_auto_stories_wrap .view_all_wrap":"collapseAutoStories","click #js_story_invites_nav":"storyInvites","click .help_icon":"renderStoriesGuide"}},initialize:function(){var e,t,i;return this.addHoverTooltips(),this.setVars(),this.model=e=ThisLife.Model.masterStory,this.bindCallbacks(e),ThisLife.PubSub.on("resize",this.showViewAllLink,this),this.showAllAutoStories=ThisLife.Helper.LocalStorage.getObject("showAllAutoStories"),this.showAllAutoStories||(this.showAllAutoStories=!0,this.collapseAutoStories()),ThisLife.PubSub.on("state:changeTo:stories",this.goToMyStories,this),ThisLife.PubSub.on("state:changeTo:storiesFollowing",this.goToOthersStories,this),ThisLife.PubSub.on("state:preChangeTo:stories state:preChangeTo:storiesFollowing",this.preGoToStories,this),"storiesFollowing"===(null!=(t=ThisLife.app.currentState)?t.name:void 0)?this.goToOthersStories():"stories"===(null!=(i=ThisLife.app.currentState)?i.name:void 0)?this.goToMyStories():void 0},renderStoriesGuide:function(){var e;return this.storiesGuideView=new ThisLife.View.StoriesGuide,e=this.storiesGuideView.render().el,this.storiesGuideEl.appendChild(e),this.bindStoriesGuide()},bindStoriesGuide:function(){return this.storiesGuideView.on("remove",this.onStoriesGuideTeardown,this),this.hideHelpIcon()},onStoriesGuideTeardown:function(){return this.storiesGuideView.off("remove",this.onStoriesGuideTeardown,this),this.showHelpIcon()},unbindEvents:function(){return ThisLife.Support.keyInformant.off("cancel",this.modalKeysOnCancel,this)},hideHelpIcon:function(){return this.helpIcon.style.display="none"},showHelpIcon:function(){return this.helpIcon.style.display="inline-block"},addHoverTooltips:function(){var e;return e=".disabled_tooltip_wrap",new ThisLife.View.HoverTooltip({el:this.el.querySelector(".new_story_btn"),wrapSelector:e}),new ThisLife.View.HoverTooltip({el:this.el.querySelector(".my_stories_btn"),wrapSelector:e}),new ThisLife.View.HoverTooltip({el:this.el.querySelector(".friend_stories_btn"),wrapSelector:e})},bindCallbacks:function(e){return e.on("reset",this.checkNumStories,this),e.myStories.on("reset",this.renderMyStories,this).on("add",this.addMyStory,this).on("remove",this.removeStory,this).on("change:story_name",this.changeName,this),e.otherStories.on("reset",this.renderOtherStories,this).on("add",this.addOtherStory,this).on("remove",this.removeOtherStory,this).on("change:story_name",this.changeOtherStoryName,this),e.autoStories.on("reset",this.renderAutoStories,this).on("remove",this.removeAutoStory,this).on("change:last_viewed",this.updateAutoStoryCount,this)},storyInvites:function(e){var t;return e.currentTarget.classList.contains("disabled")?!1:(t=e.currentTarget.dataset.href,ThisLife.app.router.navigate(t))},switchStoryViews:function(e){var t,i;return i=e.currentTarget,t=i.dataset.href,$(i).addClass("active").siblings(".active").removeClass("active"),ThisLife.app.router.navigate(t)},goToOthersStories:function(){return $("#js_other_stories_nav").addClass("active").siblings(".active").removeClass("active"),this.showOtherStories()},goToMyStories:function(){return $("#js_my_stories_nav").addClass("active").siblings(".active").removeClass("active"),this.showMyStories()},preGoToStories:function(){return ThisLife.PubSub.trigger("addLoader")},goToStory:function(e){var t,i,n,o;return i=e.currentTarget,t=i.classList,n=t.contains("active"),o=i.dataset.uid,ThisLife.app.router.navigateToStory(o)},showMyStories:function(){return this.otherStoriesEl.style.display="none",this.showStoriesGroup(this.myStoriesEl),this.showStoriesGroup(this.autoStoriesWrapEl),this.updateAutoStoryCount(),this.autoStoriesWrapEl.style.display=this.model.autoStories.length>0?"block":"none",this.showViewAllLink()},showOtherStories:function(){return this.myStoriesEl.style.display="none",this.autoStoriesWrapEl.style.display="none",this.showStoriesGroup(this.otherStoriesEl)},showStoriesGroup:function(e){return e.style.display="block"},setVars:function(){var e;return e=document,this.otherStoriesEl=e.getElementById("js_other_stories_list"),this.myStoriesEl=e.getElementById("js_my_stories_list"),this.autoStoriesWrapEl=e.getElementById("js_auto_stories_wrap"),this.autoStoriesEl=e.getElementById("js_auto_stories_list"),this.invitationsEl=e.getElementById("js_my_invitations_list"),this.invitationsNotifier=e.getElementById("js_my_invitations_notifications"),this.storiesGuideEl=e.getElementById("js_stories_guide"),this.helpIcon=this.el.querySelector(".help_icon")},renderOtherStories:function(e){var t,i,n,o,s;if(e.length){for(o=e.models,s=[],t=0,i=o.length;i>t;t++)n=o[t],s.push(this.addOtherStory(n));return s}return this.addNoFollowedStoriesTemplate()},renderMyStories:function(e){var t,i,n,o,s;if(e.length){for(o=e.models,s=[],t=0,i=o.length;i>t;t++)n=o[t],s.push(this.addMyStory(n));return s}return this.addNoStoriesTemplate()},renderAutoStories:function(e){var t,i,n,o,s;if(e.length){for(ThisLife.appModel.getFirstTimeStoriesGuide()&&this.renderStoriesGuide(),o=e.models,s=[],t=0,i=o.length;i>t;t++)n=o[t],s.push(this.addAutoStory(n));return s}},addAutoStory:function(e,t,i){return null==i&&(i={}),t&&1===t.length&&this.removeNoStoriesTemplate(),i=_.extend(i,{parentEl:this.autoStoriesEl,type:"autoStory"}),this.addStory(e,t,i)},addMyStory:function(e,t,i){return null==i&&(i={}),t&&1===t.length&&this.removeNoStoriesTemplate(),i=_.extend(i,{parentEl:this.myStoriesEl,type:"myStory"}),this.addStory(e,t,i)},addOtherStory:function(e,t,i){return null==i&&(i={}),t&&1===t.length&&this.removeNoFollowedStoriesTemplate(),i=_.extend(i,{parentEl:this.otherStoriesEl,type:"otherStory"}),this.addStory(e,t,i)},addStory:function(e,t,i){var n,o,s,r,l;return l=new ThisLife.View.StoriesListItem({model:e,type:i.type,collection:t}),s=l.render().el,i||i.parentEl.appendChild(s),i.add?(r=t.indexOf(e)+1,o=i.parentEl.children,n=o[r],n?i.parentEl.insertBefore(s,n):i.parentEl.appendChild(s)):i.parentEl.appendChild(s)},removeStory:function(e,t){var i;return i=e.get("story_uid"),this.$("div.framed_moment[data-uid='"+i+"']").remove(),t.length?void 0:this.addNoStoriesTemplate()},removeAutoStory:function(e,t){var i;return i=e.get("story_uid"),this.$("div.framed_moment[data-uid='"+i+"']").remove(),this.updateAutoStoryCount(),0===t.length?this.autoStoriesWrapEl.style.display="none":void 0},removeOtherStory:function(e,t){return t.length?void 0:this.addNoFollowedStoriesTemplate()},changeName:function(e,t){var i,n;return n=e.get("story_uid"),null!=(i=this.el.querySelector("div.framed_moment[data-uid='"+n+"'] strong"))?i.textContent=t:void 0},changeOtherStoryName:function(e,t){var i,n,o;return o=e.get("name"),n=e.get("story_uid"),null!=(i=this.el.querySelector("div.framed_moment[data-uid='"+n+"'] strong"))?i.innerHTML=t+" <span class='author'>by "+o+"</span>":void 0},addNoFollowedStoriesTemplate:function(){return this.otherStoriesEl.insertAdjacentHTML("afterbegin",e)},removeNoFollowedStoriesTemplate:function(){return this.otherStoriesEl.removeChild(this.otherStoriesEl.firstElementChild)},addNoStoriesTemplate:function(){return this.myStoriesEl.insertAdjacentHTML("afterbegin",t)},removeNoStoriesTemplate:function(){var e,t;return t=this.myStoriesEl.querySelector(".empty"),e=this.myStoriesEl.querySelector("#empty_add_prompt"),t&&this.myStoriesEl.removeChild(t),e?this.myStoriesEl.removeChild(e):void 0},updateAutoStoryCount:function(){var e,t,i;return e=this.$el.find(".badge"),t=this.model.autoStories.filter(function(e){return!e.get("story").last_viewed}),i=t.length,i>0?(e.show(),e.attr("data-count",i)):e.hide()},collapseAutoStories:function(){return this.showAllAutoStories=!this.showAllAutoStories,ThisLife.Helper.LocalStorage.setObject("showAllAutoStories",this.showAllAutoStories),this.autoStoriesWrapEl.querySelector("h1 .triangle").classList.toggle("right"),this.autoStoriesWrapEl.classList.toggle("collapse")},showViewAllLink:function(){var e,t;return e=this.autoStoriesEl.children.length,t=e>0?this.autoStoriesEl.children[0].clientWidth:0,t*e>this.autoStoriesEl.clientWidth?this.autoStoriesWrapEl.classList.add("show_collapse"):this.autoStoriesWrapEl.classList.remove("show_collapse")}}),e='<div class="empty">\n  <div class="icon"></div>\n  <h3>You are not following any Friends\' Stories.</h3>\n</div>',t='<div id="empty_add_prompt">\n  <img src="/assets/1px.gif">\n</div>\n<div class="empty">\n  <div class="icon_my_stories"></div>\n  <h3>You have no Stories yet.</h3>\n</div>'}.call(this),function(){var e;ThisLife.View.StoriesGuide=Backbone.View.extend({className:"stories_guide",events:{"click .close":"remove"},initialize:function(){return this},remove:function(){return ThisLife.appModel.setFirstTimeStoriesGuide(),this.trigger("remove"),this.$el.remove(),this},render:function(){return this.el.insertAdjacentHTML("beforeend",e),this}}),e='<div class="close"><div></div></div>\n<h1>Stories for You</h1>\n<p>ThisLife automatically finds the best stories from the photos in your library and presents them beautifully for you to enjoy and share</p>\n<ul class="clearfix">\n  <li>\n    Take all the photos you want. No more editing!\n  </li>\n  <li>\n    We select your best photos and arrange them into a beautiful story.\n  </li>\n  <li>\n    Share more stories with friends and family.\n  </li>\n</ul>'}.call(this),function(){var e,t,i,n,o,s;ThisLife.View.StoriesListItem=Backbone.View.extend({className:"framed_moment stack story_element",events:{click:"onClick","click .close":"delete"},initialize:function(e){return this.options=null!=e?e:{},this.bindCallbacks(),this.setup()},bindCallbacks:function(){return ThisLife.PubSub.on("story:changed_cover",this.changeCover,this).on("story:changed_name",this.changeName,this),this.model.on("change:count",this.onChangeMomentCount,this).on("change:dates",this.onChangeDates,this).on("change:last_viewed",this.onChangeLastViewed,this).on("remove",this.teardown,this)},unbindCallbacks:function(){return ThisLife.PubSub.off(null,null,this),this.model.off(null,null,this)},setup:function(){var e;return e=this.model.get("story"),this.storyUid=e.uid,e.moment_count>0||this.el.classList.add("empty"),e.cover_moment_uid||this.el.classList.add("no_image"),this.isAutoStory()&&!this.model.get("story").last_viewed?this.el.classList.add("new"):void 0},teardown:function(){return this.unbindCallbacks(),this.remove()},changeName:function(e,t){var i,n;if(e===this.storyUid)return null!=(i=this.el.querySelector(".framed_moment_meta .title"))&&(i.textContent=t),$(this.el.querySelector(".framed_moment_meta .title")).attr("title",t),n=this.el.querySelector(".framed_moment_meta .subtitle"),n.textContent!==t?n.classList.remove("hidden"):n.classList.add("hidden")},render:function(){var e,t;return this.el.dataset.uid=this.model.get("story_uid"),t=this.getCoverUrl(),this.el.insertAdjacentHTML("afterbegin",this.getTemplate(t)),e=function(e){return function(t,i){return e.positionCoverImage(t,i)}}(this),ThisLife.Helper.Image.preloadImage(t,e,e),this.cacheElements(),this},cacheElements:function(){return this.imgEl=this.el.getElementsByClassName("img")[0]},isMyStory:function(){return"myStory"===this.options.type||this.isAutoStory()},isAutoStory:function(){return"autoStory"===this.options.type},getTemplate:function(e){return this.template=s(this.model,e,this.isMyStory())},"delete":function(e){return e.stopPropagation(),this.isMyStory()?this.deleteStory():this.unfollowStory()},deleteStory:function(){var e;return e=new ThisLife.View.ModalAlert({template:"deleteAlbumTemplate",callback:_.bind(this.deleteStoryContinue,this)}),$(document.body).append(e.render().el)},unfollowStory:function(){var e;return e=new ThisLife.View.ModalAlert({template:"unfollowStoryTemplate",callback:_.bind(this.unfollowStoryContinue,this)}),$(document.body).append(e.render().el)},unfollowStoryContinue:function(){return ThisLife.Model.masterStory.unfollowStory(this.model.get("story_uid"))},deleteStoryContinue:function(){return ThisLife.Model.masterStory.deleteStory(this.model.get("story_uid"))},onClick:function(e){return this.el.classList.remove("new"),this.goToStory(e)},onChangeMomentCount:function(e){var t,i;return null!=(i=this.el.getElementsByClassName("count"))&&(i[0].textContent=e),t=e>0?"remove":"add",this.el.classList[t]("empty")},onChangeDates:function(e,t){var i,o,s,r,l,a;return e&&t&&(s=n(e,t),a=this.el.getElementsByClassName("subtitle")[0],a?a.textContent=s:this.el.getElementsByClassName("title")[0].insertAdjacentHTML("afterend",'<span class="subtitle">'+s+"</span>")),this.options.collection?(l=this.el.parentNode,l.removeChild(this.el),this.options.collection.sort(),r=this.options.collection.indexOf(this.model)+1,o=l.children,i=o[r],i?l.insertBefore(this.el,i):l.appendChild(this.el)):void 0},onChangeLastViewed:function(e){return this.isAutoStory()&&!e?this.el.classList.add("new"):this.el.classList.remove("new")},changeCover:function(e,t){var i,n,o,s;if(t&&this.storyUid)return t===this.storyUid?e.cover_moment_uid?(n=function(t){return function(i,n){var o;return t.el.classList.remove("no_image"),null!=(o=t.imgEl)&&(o.style.backgroundImage="url("+s+")"),t.positionCoverImage(i,n,e)}}(this),i=function(e){return function(){var t;return e.el.classList.add("no_image"),null!=(t=e.imgEl)?t.style.backgroundImage="":void 0}}(this),s=this.getCoverUrl(e),ThisLife.Helper.Image.preloadImage(s,n,i)):(this.el.classList.add("no_image"),null!=(o=this.imgEl)?o.style.backgroundImage="":void 0):void 0},positionCoverImage:function(e,t,i){var n,o,s,r;return o="center center",n=i?i.cover_moment_aoi:this.model.get("story").cover_moment_aoi,n&&e&&t?o=ThisLife.Helper.Image.backgrounPositionForAreaOfInterest(n,e,t,this.imgEl.clientWidth,this.imgEl.clientHeight):(r=e||parseFloat(this.model.get("orig_width")),s=t||parseFloat(this.model.get("orig_height")),s>r&&(o="center 25%")),this.imgEl.style.backgroundPosition=o},goToStory:function(){return this.isMyStory()?ThisLife.app.router.navigateToStory(this.storyUid):ThisLife.app.router.navigateToStoryFollowing(this.storyUid)},getCoverUrl:function(e){var t,i,n,o,s,r,l,a,u,c;return e||(r=this.model.get("story"),e={cover_moment_uid:r.cover_moment_uid,cover_owner_uid:r.cover_owner_uid,cover_effects_modified_date:r.cover_effects_modified_date}),c=220,i=170,u=e.cover_moment_uid,s=e.cover_owner_uid,a=e.cover_effects_modified_date,n=ThisLife.Collection.moments.get(u),n&&(o=n.get("width")/n.get("height"),l=c/i,l>o?i=c/o:c=i*o),u?(t={height:i,width:c},ThisLife.Helper.Image.imageUrlDim(u,t,a,s)):""}}),i=function(e){var t,i,n,o,s,r,l,a,u;return u=220,i=170,a=e.cover_moment_uid,s=e.cover_owner_uid,l=e.cover_effects_modified_date,n=ThisLife.Collection.moments.get(a),n&&(o=n.get("width")/n.get("height"),r=u/i,r>o?i=u/o:u=i*o),a?(t={height:i,width:u},ThisLife.Helper.Image.imageUrlDim(a,t,l,s)):""},o=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],e=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],n=function(t,i){var n,s;return s=new Date(1e3*t),n=new Date(1e3*i),s.getFullYear()===n.getFullYear()?s.getMonth()===n.getMonth()?s.getDate()===n.getDate()?e[s.getDay()]+" "+o[s.getMonth()]+" "+s.getDate()+", "+s.getFullYear():o[s.getMonth()]+" "+s.getDate()+" - "+n.getDate()+", "+s.getFullYear():o[s.getMonth()]+" "+s.getDate()+" - "+o[n.getMonth()]+" "+n.getDate()+", "+s.getFullYear():o[s.getMonth()]+" "+s.getDate()+", "+s.getFullYear()+" - "+o[n.getMonth()]+" "+n.getDate()+", "+n.getFullYear()},t=function(e){var t,i,n;return n=ThisLife.Helper.Stories.getStoryInfoFromJSON(e),i=n[0],t=n[1],ThisLife.Helper.String.escapeHtml(t)},s=function(e,i,o){var s,r,l,a,u,c,d,h;return c=e.get("story"),u=c.moment_count||0,r=i?"background-image: url("+i+")":"",d=ThisLife.Helper.String.escapeHtml(c.name),l=c.start_date&&c.end_date?n(c.start_date,c.end_date):"",h=d!==l?"":" hidden",s=o?"":"<span class='author'>"+t(e)+"</span>",a=e.get("default")?"":'<div class="close"><div></div></div>','<div class="framed_moment_media">\n  <div class="img" style="'+r+'"></div>\n</div>\n<div class="framed_moment_meta">\n  <span class="title" title="'+d+'">'+d+"</span>\n  "+s+"<span class='subtitle"+h+"'>"+l+'</span>\n  <span class="count">'+u+'</span>\n</div>\n<div class="stack_graphic"></div>\n'+a}}.call(this),function(){define("ThisLife.View.TagsView",["ThisLife.Helper.Features"],function(e){var t;return t=Backbone.View.extend({id:"tags_view",className:"tags_view transition top-xs",events:{"keyup input":"keyupListener","focus input":"inputFocus","blur input":"inputBlur","click .search_input_wrap .icon_delete":"clearSearch","click .breadcrumb_bar .bc_back_wrapper":"clickedBack"},initialize:function(e){return this.options=null!=e?e:{},this.renderLoadingTemplate(),document.body.appendChild(this.el),this.tagsViewPubSub=_.extend({},Backbone.Events),this.bindings(),this.updateCollection()},updateCollection:function(){return this.collection.loaded?(this.collection.length=0,this.collection.loaded=!1,this.collection.updateTags()):void 0},bindings:function(){return ThisLife.PubSub.on("state:changeFrom:tags",this.remove,this),this.collection.on("add",this.added,this).on("change",this.arrangeTags,this).on("reset",this.render,this).on("remove",this.removed,this),this.debounceResize=_.debounce(_.bind(this.resizeView,this),100),ThisLife.PubSub.on("resize",this.debounceResize,this),ThisLife.Collection.moments.on("add",this.timelineChanged,this),ThisLife.Collection.moments.on("remove",this.timelineChanged,this)},removeBindings:function(){var e;return null!=(e=this.cardWrapEl)?e.removeEventListener("scroll",this.debounceScroll,!1):void 0},timelineChanged:function(){return 0===ThisLife.Collection.moments.getMomentCount()&&!this.timelineEmpty||ThisLife.Collection.moments.getMomentCount()>=1&&this.timelineEmpty?this.render():void 0},changeName:function(e,t,i){return e.trigger("tag_card:teardown"),this.added(e,this.collection,i)},keyupListener:function(){return this.arrangeTags(),this.updateInputIcon()},inputBlur:function(){return this.el.classList.add("transition")},inputFocus:function(){return this.el.classList.remove("transition")},updateInputIcon:function(){return this.query.length&&!this.showDeleteIcon?(this.searchWrap.classList.add("delete"),this.showDeleteIcon=!0):0===this.query.length&&this.showDeleteIcon?(this.searchWrap.classList.remove("delete"),this.showDeleteIcon=!1):void 0},arrangeTags:function(){var e,t;return this.query=null!=(t=this.searchInput.value)?t.trim().toLowerCase():void 0,this.visibleTags=this.getVisibleTags(),e=_.bind(this.matchesQuery,this),this.index=0,this.collection.each(e),this.lazyLoadTagThumbnails()},matchesQuery:function(e){var t,i;return t=_.indexOf(this.visibleTags,e),i=-1!==t,e.trigger("positionTag",i,t)},matcher:function(e){var t,i;return this.query?(e=e.get("name").replace(new RegExp("_","g"),"~"),this.query=this.query.replace(new RegExp("_","g"),"~"),t=new RegExp("\\b"+ThisLife.Helper.String.escapeRegExp(this.query),"gi"),i=e.match(t),!(null===i)):!0},added:function(e){return 1===this.collection.length?this.render():(this.addNewListItem(e),this.arrangeTags())},removed:function(){return 0===this.collection.length&&this.render(),this.arrangeTags()},resizeView:function(){return this.layoutCards(),this.tagsViewPubSub.trigger("resize")},layoutCards:function(){var e,t,i;return e=10,this.cardWidth=277+2*e,this.cardHeight=86+2*e,this.columnCount=Math.floor((ThisLife.Helper.DOM.windowWidth-2*e)/this.cardWidth),t=this.columnCount*this.cardWidth-2*e,null!=(i=this.cardWrapInnerEl)?i.style.width=t+"px":void 0},cacheDomElements:function(){return this.cardWrapEl=this.el.querySelector(".card_wrap"),this.cardWrapInnerEl=this.el.querySelector(".card_wrap_inner"),this.searchWrap=this.el.querySelector(".search_input_wrap"),this.searchInput=this.searchWrap.querySelector("input"),this.searchInputIcon=this.searchWrap.querySelector(".icon")},render:function(){return e.whenReady("upp",function(e){return function(t){return ThisLife.Collection.moments.whenLoaded(function(){var i;return e.timelineEmpty=!1,e.removeBindings(),0!==ThisLife.Collection.moments.getMomentCount()||t?e.collection.length?(i=ThisLife.appModel.getTagViewOptions(),e.sortType="count",e.sortOrder="desc",e.renderTagsTemplate(),_.defer(function(){return e.lazyLoadTagThumbnails()})):e.collection.loaded?e.renderNoTagsTemplate():e.renderLoadingTemplate():(e.timelineEmpty=!0,e.renderEmptyTemplate())})}}(this))},clearSearch:function(){return this.searchInput.value="",this.arrangeTags(),this.updateInputIcon()},scrollToTop:function(){var e;return e=this.el.querySelector(".card_wrap"),e.scrollTop=0},renderTagsTemplate:function(){var e,t,i,n,o,s,r,l;for(this.removeEmptyClasses(),this.el.innerHTML=this.template({sortType:this.sortType,sortOrder:this.sortOrder}),t=this.options.header,this.el.querySelector(".header_wrapper").appendChild(t.render().el),this.cacheDomElements(),this.debounceScroll=_.debounce(_.bind(this.lazyLoadTagThumbnails,this),300),this.cardWrapEl.addEventListener("scroll",this.debounceScroll,!1),this.layoutCards(),n=0,l=this.getSortedTags(),e=l.length,document.querySelector(".search_tags_input").disabled=!1,r=[],i=0,o=l.length;o>i;i++)s=l[i],r.push(_.defer(function(e){return function(t){var i;return i=e.addNewListItemView(t,n),e.cardWrapInnerEl.appendChild(i.render().el),n++}}(this),s));return r},lazyLoadTagThumbnails:function(){return this.tagsViewPubSub.trigger("scroll",$(this.cardWrapEl).offset().top,$(this.cardWrapEl).outerHeight())},tagRepositioned:function(e){return e($(this.cardWrapEl).offset().top,$(this.cardWrapEl).outerHeight())},getSortedTags:function(){var e,t;return e=_.bind(this.sortMomentsComparator,this),t=this.collection.sortBy(e),"desc"===this.sortOrder?t.reverse():t},getVisibleTags:function(){var e,t;return e=this.getSortedTags(),t=_.filter(e,function(e){return function(t){return e.matcher(t)}}(this))},sortMomentsComparator:function(e){switch(this.sortType){case"alpha":return(e.get("name")||"").toLowerCase();case"age":return e.get("updated");case"count":return e.getCount()}},removeEmptyClasses:function(){return this.el.classList.remove("empty")},addEmptyClasses:function(){return this.el.classList.add("empty")},renderEmptyTemplate:function(){var e,t;return $(this.el).empty(),this.addEmptyClasses(),e=this.options.header,this.el.innerHTML=this.emptyTagsTemplate(),this.el.querySelector(".header_wrapper").appendChild(e.render().el),this.uploadView=new ThisLife.View.TagsUploadView,this.el.appendChild(this.uploadView.el),null!=(t=document.querySelector(".search_tags_input"))?t.disabled=!0:void 0},renderNoTagsTemplate:function(){var e,t;return this.addEmptyClasses(),e=this.options.header,this.el.innerHTML=this.emptyTagsTemplate(),this.el.querySelector(".header_wrapper").appendChild(e.render().el),this.el.innerHTML+=this.noTagsTemplate(),ThisLife.appModel.getFirstTimeTagsGuide()&&"tags"===ThisLife.app.currentState.name&&"add"!==ThisLife.app.currentState.fragment&&this.renderTagsGuide(),null!=(t=document.querySelector(".search_tags_input"))?t.disabled=!0:void 0},renderTagsGuide:function(){return this.tagsGuideView?void 0:(this.tagsGuideView=new ThisLife.View.TagsGuide,$("body").append(this.tagsGuideView.render().el))},renderLoadingTemplate:function(){return this.addEmptyClasses(),this.el.innerHTML=this.loadingTagsTemplate()},addNewListItem:function(e,t){var i;return i=this.addNewListItemView(e,t),this.cardWrapInnerEl.appendChild(i.render().el)},addNewListItemView:function(e,t){return new ThisLife.View.TagCard({parentView:this,tagsViewPubSub:this.tagsViewPubSub,model:e,index:t})},remove:function(){var e,t,i;return this.collection.off(null,null,this),ThisLife.PubSub.off("state:changeFrom:tags",this.remove,this),ThisLife.PubSub.off("resize",this.debounceResize,this),null!=(e=this.tagsDropdown)&&e.remove(),null!=(t=this.uploadView)&&t.remove(),null!=(i=this.tagsGuideView)&&i.remove(),this.$el.remove(),this},clickedBack:function(){return ThisLife.app.router.navigateToLibrary()},template:function(){return'<div class="header_wrapper"></div>\n<div class="card_wrap">\n  <div class="card_wrap_inner">\n  </div>\n</div>'},noTagsTemplate:function(){return"<div class='no_tags'>\n  No tags yet!\n</div>"},loadingTagsTemplate:function(){return'<div class="empty_wrap">\n  <div class="empty_icon">\n  </div>\n  <p>Loading Tags&hellip;</p>\n</div>'},emptyTagsTemplate:function(){return'<div class="header_wrapper"></div>'}})}),ThisLife.View.TagsView=require("ThisLife.View.TagsView")}.call(this),function(){var e,t,i;e=void 0,ThisLife.View.TagCard=Backbone.View.extend({className:"tag_card_wrap",events:{"keyup textarea":"autoGrow","keydown textarea":"keydownListener","blur textarea":"blurTextarea","click .delete":"deleteTag","click .edit":"edit"},initialize:function(e){return this.options=null!=e?e:{},_.bindAll(this,"onMouseUp","onMouseDown","endTransition"),this.parentView=this.options.parentView,this.tagsViewPubSub=this.options.tagsViewPubSub,this.model.on("change:name",this.updateName,this).on("change:cover_moment_uid",this.updateImage,this).on("remove",this.remove,this).on("positionTag",this.positionTag,this).on("tag_card:teardown",this.remove,this).on("count_changed",this.rerender,this),this.tagsViewPubSub.on("resize",this.positionTag,this),this.tagsViewPubSub.on("scroll",this.lazyLoadThumbnail,this),ThisLife.Helper.DOM.addEventListener(this.el,"transitionend",this.endTransition,!1,this)
},positionTag:function(e,t){var i,n,o,s,r;return null==e&&(e=!0),null==t&&(t=this.index),this.index=t,i=e?"block":"none",o=Math.floor(t/this.parentView.columnCount),s=o*this.parentView.cardHeight,n=t%this.parentView.columnCount*this.parentView.cardWidth,r=ThisLife.Helper.CSS.browserPrefix("transform",ThisLife.Helper.CSS.resolveTranslate(n,s,0)),this.el.style.cssText=r+" display: "+i},endTransition:function(){return this.parentView.tagRepositioned(_.bind(this.lazyLoadThumbnail,this))},deleteTag:function(){var e,t;return t=this.model.id,e={template:"deleteMomentTagTemplate",callback:"deleteMomentTags",name:"Tag"},this.deleteTagModal(e,t)},deleteTagModal:function(e,t){var i,n,o;return n=ThisLife.Collection.momentTags.get(t),i=function(){var t,i;return ThisLife.Collection.momentTags.remove(n),ThisLife.Service.api[e.callback](n),t=$("#tl_modal_settings_tags"),i=e.name+" deleted.",ThisLife.Helper.Notifications.topOverlayNotification(t,i)},o=new ThisLife.View.ModalAlert({template:e.template,item:{tagName:n.get("name"),count:n.getCount()},callback:i}),document.body.appendChild(o.render().el)},edit:function(){var e;return this.originalValue=this.model.get("name"),this.editing=!0,this.el.classList.add("editing"),this.tagCardEl.insertAdjacentHTML("beforeend",i(this.model)),this.textarea=this.el.querySelector("textarea"),this.autoGrow(),this.textarea.focus(),e=this.model.get("name").length,this.textarea.setSelectionRange(0,e)},blurTextarea:function(){return this.updateTag(),this.removeEdit()},removeEdit:function(){return this.tagCardEl.removeChild(this.textarea),this.el.classList.remove("editing"),this.editing=!1},onMouseUp:function(){return this.blockClick||this.viewMoments(),this.blockClick=!1},onMouseDown:function(){return this.blockClick=this.editing},viewMoments:function(){},keydownListener:function(e){return this.autoGrow(),13===e.keyCode?this.textarea.blur():27===e.keyCode?(this.textarea.value=this.model.get("name"),this.textarea.blur()):void 0},updateTag:function(){var e,t;return e=this.textarea.value.trim(),""!==e&&e!==(this.model.get("name")||"").trim()?(this.nameEl.innerHTML=ThisLife.Helper.String.escapeHtml(e),this.el.classList.add("highlight"),t=ThisLife.Helper.CSS.browserPrefix("transform",ThisLife.Helper.CSS.resolveTranslate(0,0,1,1.05)),this.tagCardEl.style.cssText=""+t,_.delay(function(t){return function(){return t.saveTag(e),_.delay(function(){return t.tagCardEl.style.cssText="",_.delay(function(){return t.el.classList.remove("highlight")},200)},500)}}(this),200)):void 0},saveTag:function(e){return this.model.updateName(e,_.bind(this.onSaveTagError,this))},onSaveTagError:function(e){var t;return null!=(t=this.errorView)&&t.teardown(),this.errorView=new ThisLife.View.Error({message:e}),this.errorView.show(),this.nameEl.innerHTML=ThisLife.Helper.String.escapeHtml(this.originalValue)},autoGrow:function(){var e,t,i,n;return e=58,t=5,this.textarea.style.height=0,i=this.textarea.scrollHeight-2*t,"Firefox"===platform.name&&(i+=2*t),this.textarea.style.height=i+"px",n=Math.max(0,(e-i)/2),this.textarea.style.marginTop=n+"px"},changeTag:function(){},updateName:function(){return this.nameEl.innerHTML=ThisLife.Helper.String.escapeHtml(this.model.get("name"))},updateImage:function(){var e,t;return e=this.model.get("cover_moment_uid"),t=e?ThisLife.Helper.Image.imageUrlDim(e,70,null,ThisLife.currentLifeOwner):"",this.imageEl.style.backgroundImage="url("+t+")"},lazyLoadThumbnail:function(e,t){var i,n,o;if(!this.thumbnailLoaded)return n=this.$el.offset().top,o=n+e,i=t+e,n&&o>=0&&i>=n?(this.thumbnailLoaded=!0,this.updateImage()):void 0},render:function(){return this.coverMomentUid=this.model.get("cover_moment_uid"),this.$el.html(t(this.model)),this.cacheDomElements(),this.positionTag(!0,this.options.index),this.bindMouseEvents(),this},bindMouseEvents:function(){return this.tagCardEl.addEventListener("mousedown",this.onMouseDown,!1),this.tagCardEl.addEventListener("mouseup",this.onMouseUp,!1)},unbindMouseEvents:function(){return this.tagCardEl.removeEventListener("mousedown",this.onMouseDown,!1),this.tagCardEl.removeEventListener("mouseup",this.onMouseUp,!1)},rerender:function(){return this.coverMomentUid=this.model.get("cover_moment_uid"),this.$el.html(t(this.model)),this.cacheDomElements(),this.bindMouseEvents(),this},cacheDomElements:function(){return this.nameEl=this.el.querySelector(".name"),this.tagCardEl=this.el.querySelector(".tag_card"),this.imageEl=this.el.querySelector(".img")},remove:function(){return this.unbindMouseEvents(),ThisLife.Helper.DOM.removeEventListener(this.el,"transitionend",this.endTransition,!1,this),this.model.off(null,null,this),this.$el.remove(),this}}),i=function(e){return'<textarea maxlength="255">'+e.get("name")+"</textarea>"},t=function(e){var t;return t=e.getNameEscaped(),'<div class="tag_card">\n  <div class="name">'+t+"</div>\n  <div class='count'>"+e.getCount()+'</div>\n  <div class="img" style="background-image: url(/assets/search/default_tag.png)"></div>\n</div>\n<div class="icon delete">\n  <div></div>\n</div>\n<div class="icon edit">\n  <div></div>\n</div>'}}.call(this),function(){ThisLife.View.TagsUploadView=Backbone.View.extend({className:"tags_upload",initialize:function(e){return this.options=e,this.render()},render:function(){return this._uploadView=ThisLife.app.controller("timeline").upload({momentsText:"Drop photos to upload.",noWidgetHeader:!0,widgets:["EmptyTags"]}),this.el.appendChild(this._uploadView.el),this},remove:function(){var e;return null!=(e=this._uploadView)&&e.remove(),Backbone.View.prototype.remove.apply(this)}})}.call(this),function(){define("ThisLife.View.TagsUploadBox",["ThisLife.Timeline.Views.Upload","ThisLife.Timeline.Views.Widgets.EmptyTags"],function(e,t){var i;return i=e.extend({_appendWidgets:function(){var e;return this.widget=new t,this.subviews.push(this.widget),this.uploadContainerEl.classList.remove("stretch"),null!=(e=this.widgetPlaceholderEl)?e.appendChild(this.widget.el):void 0}})}),ThisLife.View.TagsUploadBox=require("ThisLife.View.TagsUploadBox")}.call(this),function(){var e;ThisLife.View.TagsGuide=Backbone.View.extend({className:"suggested_guide tags_guide",events:{"click .close":"hide","click .close-btn":"hide"},initialize:function(e){return this.options=null!=e?e:{},this},remove:function(){return this.$el.remove(),this},render:function(){return this.el.insertAdjacentHTML("beforeend",e),this},hide:function(){var e;return ThisLife.appModel.setFirstTimeTagsGuide(),this.remove(),"function"==typeof(e=this.options).callback?e.callback():void 0}}),e='<div class="guide-wrapper">\n  <div class="guide-content">\n    <div class=\'close-btn\'><img src=\'/assets/1px.gif\' /></div>\n    <h1>Find the photos you need!</h1>\n    <div class="guide-item logical">\n      <p>Tag logical groups</p>\n    </div>\n    <div class="guide-item multiple">\n      <p>Use multiple tags on one photo</p>\n    </div>\n    <div class="guide-item search">\n      <p>Tags help you find exactly what you\'re searching for</p>\n    </div>\n    <div class="close done-btn orange-btn">Got it!</div>\n  </div>\n</div>'}.call(this),function(){ThisLife.Filter=function(){function e(){this.filter=new ThisLife.Model.Filter,this.canChangeCollection=!0}return _.extend(e.prototype,Backbone.Events),e.prototype.setCollection=function(e){return this.collection=e},e.prototype.getCollection=function(){return this.collection||(this.collection=ThisLife.Collection.moments)},e.prototype.setShowRecentUploads=function(e,t){return this.filter.showRecentUploads=e,this.filter.showDropdownFromHome=t,this.updateFilter()},e.prototype.showDropdownFromHome=function(){return null!=this.filter.showDropdownFromHome?this.filter.showDropdownFromHome:!1},e.prototype.showRecentUploads=function(){return null!=this.filter.showRecentUploads?this.filter.showRecentUploads:!1},e.prototype.showRatedAs=function(){return this.filter.ratingFilterMask?this.filter.ratingFilterMask:ThisLife.Model.Filter.RATED_ALL},e.prototype.setShowFavorites=function(e){return this.filter.showFavorites=e,this.updateFilter()},e.prototype.showFavoritesMoments=function(){return null!=this.filter.showFavorites?this.filter.showFavorites:!1},e.prototype.updateRating=function(e,t){return this.filter.ratingFilterMask===ThisLife.Model.Filter.RATED_ALL&&(this.filter.ratingFilterMask=0),e?this.filter.ratingFilterMask+=t:this.filter.ratingFilterMask-=t,0===this.filter.ratingFilterMask&&(this.filter.ratingFilterMask=ThisLife.Model.Filter.RATED_ALL),this.updateFilter()},e.prototype.setMomentTypes=function(e){return this.filter.momentTypes=e,this.updateFilter()},e.prototype.showMomentTypes=function(){return null!=this.filter.momentTypes?this.filter.momentTypes:"both"},e.prototype.setShowOnlyImages=function(e){return this.filter.momentTypes=e?"image":"both",this.updateFilter()},e.prototype.setShowOnlyVideos=function(e){return this.filter.momentTypes=e?"video":"both",this.updateFilter()},e.prototype.showImagesAndVideos=function(){return"both"===this.showMomentTypes},e.prototype.showOnlyImages=function(){return"image"===this.showMomentTypes()},e.prototype.showOnlyVideos=function(){return"video"===this.showMomentTypes()},e.prototype.reset=function(e){var t,i;return null==e&&(e={}),e.showHidden||(e.showHidden=!1),e.showFavorites||(e.showFavorites=!1),this.isFiltered()||this.filter.showHidden!==e.showHidden?(i=this.filter.showRecentUploads,this.filter=new ThisLife.Model.Filter,this.filter.showHidden=e.showHidden,this.filter.showFavorites=e.showFavorites,e.maintain||(t=ThisLife.Collection.moments,i&&t.rebuildCollections()),this.updateFilter(t)):this.trigger("updated")},e.prototype.isFiltered=function(){var e;return e=this.filter.defaults,!(this.filter.showFavorites===e.showFavorites&&this.filter.momentTypes===e.momentTypes&&this.filter.showRecentUploads===e.showRecentUploads)},e.prototype.includeMoment=function(e){return this.isMomentOfType(e)&&this.isMomentVisible(e)&&this.isRated(e)?this.filter.showRecentUploads?this.isRecentUpload(e):!0:!1},e.prototype.includedMomentIsHidden=function(e){return this.isMomentOfType(e)&&this.isRated(e)?e.get("hidden"):!1},e.prototype.includeRating=function(e){var t;return t=this.findRatingBit(e),(t&this.filter.ratingFilterMask)>0},e.prototype.isMomentOfType=function(e){return"both"===this.filter.momentTypes?!0:e.get("moment_type")===this.filter.momentTypes},e.prototype.isRated=function(e){return this.filter.showFavorites?e.get("rating")>=1:!0},e.prototype.isMomentVisible=function(e){return this.filter.showHidden||!e.get("hidden")},e.prototype.findRatingBit=function(e){return 0===e?1:1===e?2:2===e?4:3===e?8:void 0},e.prototype.isRecentUpload=function(e){var t;return t=ThisLife.Helper.Date.getUTCString(e.get("upload_date"),!1),$.inArray(t,this.filter.uploadDates)>=0},e.prototype.updateFilter=function(e){var t;return e||(this.isFiltered()?(this.filter.showRecentUploads&&this.filter.scanUploadDates(this.getCollection()),t=this.getCollection().filter(_.bind(this.includeMoment,this)),e=new ThisLife.Collection.MomentsCollection(t)):(e=this.getCollection(),e.rebuildCollections())),this.trigger("change:filter",this.filter.momentTypes),this.trigger("change:collection",e),this.trigger("updated")},e}()}.call(this),function(){var e;ThisLife.View.Timeline.Loading=Backbone.View.extend({className:"loading",render:function(){return this.el.insertAdjacentHTML("afterbegin",e()),this}}),e=function(){return'<div class="throbber throbber_large"><div class="throbber_overlay"></div></div>'}}.call(this),function(){ThisLife.Library=function(){function e(){this.loading=null,_.defer(function(){return ThisLife.app.controller("timeline").show()})}return _.extend(e.prototype,Backbone.Events),e.prototype.getCollection=function(){return this._collection||this._allCollection()},e.prototype.noMoments=function(){return 0===this._allCollection().getMomentCount()},e.prototype.isLoading=function(){return!!this.loading},e.prototype.showLoading=function(){var e,t;return null!=(e=this.loading)&&e.remove(),this.loading=new ThisLife.View.Timeline.Loading,null!=(t=this._layout)?t.mainEl.appendChild(this.loading.render().el):void 0},e.prototype.hideLoading=function(){var e;return null!=(e=this.loading)&&e.remove(),this.loading=null},e.prototype.sortCollection=function(){var e;return e="momentDate"===this.getCollection().getSort()?"moment_date":"upload_date",ThisLife.app.controller("timeline").updateOptions({sort_by_attr:e,group_by_attr:e}),!0},e.prototype.areAllFiltered=function(){var e,t,i,n,o;if(!this._layoutCollection)return!1;if(ThisLife.app.filter.isFiltered()&&this.noMoments())return!0;if(this.noMoments())return!1;for(e=!1,o=this._layoutCollection,i=0,n=o.length;n>i;i++)if(t=o[i],t.isCollectionVisible()){e=!0;break}return!e},e.prototype.set=function(e,t,i){var n;return this._isCurrentAllCollection()||this._allCollection().setModel(e,t,i),null!=(n=this._collection)?n.setModel(e,t,i):void 0},e.prototype.centerOnMoment=function(e,t,i,n,o){var s,r;return null==o&&(o=!1),s=this._getMoment(e),ThisLife.app.controller("timeline").centerOnMoment(e),o?ThisLife.app.setState(n):s?n&&(r=s?{momentUid:s.id}:null,ThisLife.app.setState(n,r)):ThisLife.app.setState("library"),!0},e.prototype.dateMoments=function(e,t){var i,n,o,s,r,l,a,u,c,d,h,p,f,m,g,v;for(c=[],i=0,s=e.length;s>i;i++)v=e[i],a=this._getMoment(v),a&&(d=a.get("moment_date"),u=a.updateDate(t,{silent:!0}),this.set(a.id,{moment_date:u},{silent:!0}),ThisLife.Helper.Date.areSameDay(d,a.get("moment_date"))||(this._isCurrentAllCollection()||this._allCollection().removeFromDateCollection(a,{prevDate:d,silent:!0}),null!=(h=this._collection)&&h.removeFromDateCollection(a,{prevDate:d,silent:!0}),c.push(a)));if("uploadDate"!==this.getCollection().getSort()){if(this._isCurrentAllCollection()||this._allCollection().remove(c,{silent:!0}),null!=(p=this._collection)&&p.remove(c,{silent:!0}),!this._isCurrentAllCollection())for(this._allCollection().add(c,{silent:!0}),n=0,r=c.length;r>n;n++)a=c[n],this._allCollection().buildDateCollections(a,{silent:!0,sort:!0});for(null!=(f=this._collection)&&f.add(c,{silent:!0}),o=0,l=c.length;l>o;o++)a=c[o],null!=(m=this._collection)&&m.buildDateCollections(a,{silent:!0,sort:!0});return null!=(g=this._collection)?g.syncSelectedStatus(c):void 0}},e.prototype._changeCollection=function(e){return this._setupCollection(e),ThisLife.app.filter.setCollection(e)},e.prototype._isCurrentAllCollection=function(){return this._allCollection()===this._collection},e.prototype._allCollection=function(){return ThisLife.Collection.moments},e.prototype._getMoment=function(e){return this._allCollection().get(e)},e.prototype.rotateMoments=function(e,t){var i,n,o,s,r,l;for(s=[],r=[],i=0,n=e.length;n>i;i++)l=e[i],o=this._getMoment(l),o?(o.rotate(t),r.push(s.push(o))):r.push(void 0);return r},e.prototype.cropMoment=function(e,t){var i;return i=this._getMoment(e),i?i.crop(t):void 0},e.prototype.filterMoment=function(e){var t;return t=this._getMoment(e),t?t.filter():void 0},e}()}.call(this),function(){var e;ThisLife.Albums||(ThisLife.Albums={}),(e=ThisLife.Albums).View||(e.View={}),ThisLife.Albums.View.List=Backbone.View.extend({el:document.getElementById("album_list_view"),MOUSELEAVE_DELAY:500,initialize:function(){var e;return this.firstTimeLoad=!0,this._isMouseleaveBlocked=!1,this.cacheElements(),this.model=e=ThisLife.Model.Albums.Master,this.subViews={},this.bindCallbacks(e)},events:function(){return{"click .hide-container:not(.disabled)":"toggleTree","click .section-name":"clickSection","click .shared-with-me-folder-arrow, .automatic-folder-arrow, .lifetouch-folder-arrow":"clickSection","click .create-folder":"createFolder","mouseenter #bucket-wrapper, .hide-container":"_onMouseEnterSidebar","mouseleave #bucket-wrapper, .hide-container":"_onMouseLeaveSidebar"}},bindKeyListeners:function(){return window.addEventListener("mousedown",_.bind(this._keyListener,this),!1),ThisLife.Support.keyInformant.on("enter",this._keyListener,this),ThisLife.Support.keyInformant.on("cancel",this._keyListener,this)},unbindKeyListeners:function(){return window.removeEventListener("mousedown",_.bind(this._keyListener,this),!1),ThisLife.Support.keyInformant.off("enter",this._keyListener,this),ThisLife.Support.keyInformant.on("cancel",this._keyListener,this)},initializeData:function(){return this.albums=[],this.albums.owner=this.model.getOwnerAlbums(),this.albums.auto=this.model.getAutoAlbums(),this.albums.shared=this.model.getSharedAlbums(),this.albums.all=this.model.getAllAlbums(),this.albums.lifetouch=this.model.getLifetouchAlbums(),this.defaultFolder=this.model.getDefaultFolder(),this.ownerFolders=this.model.getFolderCollection(),this.listenTo(this.ownerFolders,"remove",this.removedFolder),this.listenTo(this.ownerFolders,"add",this.addedFolder),this.listenTo(this.ownerFolders,"change:name",this.renamedFolder),this.listenTo(this.albums.owner,"remove",this.removedOwnerAlbum),this.listenTo(this.albums.owner,"add",this.addedOwnerAlbum),this.listenTo(this.albums.auto,"remove",this.removedAutoAlbum),this.listenTo(this.albums.auto,"add",this.addedAutoAlbum),this.listenTo(this.albums.shared,"remove",this.removedSharedAlbum),this.listenTo(this.albums.shared,"add",this.addedSharedAlbum),this.listenTo(this.albums.lifetouch,"remove",this.removedLifetouchAlbum),this.listenTo(this.albums.lifetouch,"add",this.addedLifetouchAlbum),this.render(),this.bindKeyListeners()},render:function(){return this.renderSharedAlbums(),this.renderDefaultFolder(),this.renderOwnerFolders(),this.renderAutoAlbums(),this.renderLifetouchAlbums(),this.renderAlbumsGrid(this.albums.all,{type:"all"})},teardown:function(){var e,t,i,n;for(i=this.subViews,e=0,t=i.length;t>e;e++)n=i[e],n.teardown();return this.subViews={},this.unbindKeyListeners(),this.remove()},renderAlbumsGrid:function(e,t){return this.albumsGridView&&this.albumsGridView.teardown(),t=_.extend(t,{model:e,parent:this}),this.albumsGridView=new ThisLife.Albums.View.Grid(t),this.albumsGridView.render()},renderDefaultFolder:function(){return this._setUpOwnerFolder(this.defaultFolder)},renderOwnerFolders:function(){var e,t,i,n;for(n=this.ownerFolders.models,e=0,t=n.length;t>e;e++)i=n[e],i.get("default")||this._setUpOwnerFolder(i)},_setUpOwnerFolder:function(e){var t;return t={},1===this.ownerFolders.length&&(t.lastFolder=!0),this.addOwnerFolder(e,t)},renderAutoAlbums:function(){return this.checkNumAlbums("auto")},renderSharedAlbums:function(){return this.checkNumAlbums("shared")},renderLifetouchAlbums:function(){return this.checkNumAlbums("lifetouch")},addOwnerFolder:function(e,t){var i,n;return null==t&&(t={}),i=_.extend({},t,{parentEl:this.ownerAlbumsEl,type:"folder",closeSidebarCallback:_.bind(this._addHiddenClassToTree,this)}),n=this.addAlbum(e,i),n.on("deletePopoverOpened",this._onDeleteFolderPopoverOpened,this)},addAlbum:function(e,t){var i,n;return t=_.extend(t,{model:e,selected:this.activeAlbum===e?!0:!1,callback:_.bind(this.toggleFolders,this)}),n=new ThisLife.Albums.View.ListItem(t),i=n.render().el,$(t.parentEl).append(i),this.subViews[e.get("uid")]=n,n},changeName:function(e,t){var i,n;return n=e.get("uid"),null!=(i=this.el.querySelector("div.framed_moment[data-uid='"+n+"'] strong"))?i.textContent=t:void 0},changeOtherAlbumName:function(e,t){var i,n,o;return o=e.get("permission.name"),n=e.get("uid"),null!=(i=this.el.querySelector("div.framed_moment[data-uid='"+n+"'] strong"))?i.innerHTML=t+" <span class='author'>by "+o+"</span>":void 0},checkNumAlbums:function(e){var t,i,n,o,s,r;return t=this.albums[e],i=t.length,"auto"===e?(n=this.autoAlbumCountEl,s=this.autoAlbumsSectionEl):"shared"===e?(n=this.sharedAlbumCountEl,s=this.sharedAlbumsSectionEl):"lifetouch"===e&&(n=this.lifetouchAlbumCountEl,s=this.lifetouchAlbumsSectionEl),$(n).html("("+i+")"),r=(null!=(o=ThisLife.app.currentState)?o.fragment.indexOf("albums"):void 0)>-1,r?this.trigger("change:visibleAlbumCount",!i):void 0},toggleFolders:function(e,t){var i,n,o,s,r;return i=null,null!=t&&(t.album_uid&&"album"===t.type?(i=this.model.getAlbumById(t.album_uid),s=i.get("folder_uid"),this.activeAlbum=i,this.model.getActiveFolderId()!==s&&(this.$el.find(".selected").removeClass("selected"),this.$el.find("#"+i.get("folder_uid")+".folder-name").parent().addClass("selected"),this.model.setActiveFolderId(s))):(this.activeAlbum=null,this.$el.find(".selected").removeClass("selected"),null!=t.folder_uid&&"folder"===t.type?(o=this.ownerFolders.get(t.folder_uid),!o&&t.folder_uid?(o=this.model.getLifetouchFolder(),this.$el.find("#lifetouch").addClass("selected")):this.$el.find("#"+t.folder_uid+".folder-name").parent().addClass("selected"),n=this.model.getAlbumsByFolderId(t.folder_uid),i=o):(n=this.albums[t.type],"all"!==t.type&&(r=this.$el.find("#"+t.type+".section").addClass("selected"))),this.renderAlbumsGrid(n,{type:t.type,activeModel:i}))),this.updateBreadcrumbs(i),this._hideTree()},isVisible:function(){var e;return null!=(e=$(this.albumList).is(":visible"))?e:{"true":!1}},toggleTree:function(e){return($(e.target).hasClass("hide-container")||$(e.target).hasClass("hide-control"))&&this.albumsGridView.isNameEditValid()?(this.bucketWrapperEl.toggleClass("hidden"),$(this.navCtrl).toggleClass("hidden"),this._notifyPrimaryBtn(),this.albumsGridView.toggleScroll(this.bucketWrapperEl.hasClass("hidden")?!0:!1)):e.stopPropagation()},_keyListener:function(e){return this._canHideSideBar(e.target)&&!this._isMouseleaveBlocked?(this._addHiddenClassToTree(),this._notifyPrimaryBtn()):e.stopPropagation()},_hideTree:function(){return this.firstTimeLoad&&this.ownerFolders.length+this.albums.auto.length+this.albums.shared.length+this.albums.lifetouch.length<=1?(this.firstTimeLoad=!1,this._addHiddenClassToTree()):void 0},_canHideSideBar:function(e){var t;return t=!document.getElementById("bucket-wrapper").contains(e),t&&(t=!$(e).hasClass("hide-container")),t&&(t=!$(e).hasClass("hide-control")),t&&(t=!document.querySelector(".primary_btn.albums").contains(e)),t||(t=document.querySelector(".primary_btn.albums").contains(e)&&this.ownerFolders.length+this.albums.auto.length+this.albums.shared.length+this.albums.lifetouch.length>1),t},_notifyPrimaryBtn:function(){return $(".primary_btn.albums .notify").toggleClass("show",this.bucketWrapperEl.hasClass("hidden"))},_addHiddenClassToTree:function(){return this.bucketWrapperEl.addClass("hidden"),$(this.navCtrl).addClass("hidden"),this.albumsGridView.toggleScroll(!0)},createFolder:function(e){return this._isMouseleaveBlocked=!0,e.stopPropagation(),!$(this.navCtrl).hasClass("hidden")&&this.albumsGridView.isNameEditValid()?ThisLife.Albums.View.currentPopover=new ThisLife.Albums.View.AddFolderPopover:void 0},clickSection:function(e,t){var i,n,o;if(this.albumsGridView.isNameEditValid()){if(o=!0,e?(e.stopPropagation(),n=e.target,o=!0):(n=t.target,o=t.toggleFolders),o===!0)switch(null!=n&&null!=(i=n.parentNode)?i.id:void 0){case"shared":ThisLife.app.router.navigateToAlbumsFriends();break;case"auto":ThisLife.app.router.navigateToAlbumsSuggested();break;case"lifetouch":ThisLife.app.router.navigateToFolder(this.model.getLifetouchFolderId())}else if(n&&n.parentNode)switch(n.parentNode.id){case"shared":ThisLife.app.router.navigateToAlbumsFriends({trigger:!1}),ThisLife.app.router.controller.handleAlbumsRoute("friends",{toggleFolders:!1});break;case"auto":ThisLife.app.router.navigateToAlbumsSuggested({trigger:!1}),ThisLife.app.router.controller.handleAlbumsRoute("suggested",{toggleFolders:!1});break;case"lifetouch":ThisLife.app.router.navigateToFolder(this.model.getLifetouchFolderId(),{trigger:!1}),ThisLife.app.router.controller.handleAlbumsRoute("folder",{folder_uid:this.model.getLifetouchFolderId(),toggleFolders:!1})}else ThisLife.app.router.navigateToAlbums();if(null!=n?n.parentNode.classList.contains("selected"):void 0)return this._addHiddenClassToTree()}},cacheElements:function(){return this.ownerAlbumsEl=this.el.querySelector("#owner-folder-items"),this.autoAlbumCountEl=this.el.querySelector("#auto-album-count"),this.sharedAlbumCountEl=this.el.querySelector("#shared-album-count"),this.lifetouchAlbumCountEl=this.el.querySelector("#lifetouch-album-count"),this.sharedAlbumsSectionEl=this.el.querySelector("#shared"),this.autoAlbumsSectionEl=this.el.querySelector("#auto"),this.lifetouchAlbumsSectionEl=this.el.querySelector("#lifetouch"),this.albumsGrid=this.el.querySelector(".albums-grid"),this.treeViewEl=$("#tree-view"),this.navCtrl=this.el.querySelector(".hide-container"),this.bucketWrapperEl=$("#bucket-wrapper")},updateAllCounts:function(e,t){return this.albums.all=this.model.getAllAlbums(),this.checkNumAlbums(e),t?this.updateBreadcrumbs(t):void 0},updateBreadcrumbs:function(e){var t,i,n,o,s,r,l,a;if(null!=(r=this.albumsGridView)?!r.actionsBar.search.length:!0)return 0===this.albums.auto.models.length?$(this.autoAlbumsSectionEl).hide():$(this.autoAlbumsSectionEl).show(),0===this.albums.shared.models.length?$(this.sharedAlbumsSectionEl).hide():$(this.sharedAlbumsSectionEl).show(),this.model.getLifetouchFolder()?$(this.lifetouchAlbumsSectionEl).show():$(this.lifetouchAlbumsSectionEl).hide(),a=null!=e?e.get("uid"):void 0,n=null!=e?e.get("folder_uid"):void 0,ThisLife.app.currentState.fragment==="folder/"+a?(s=e.get("name"),t="("+ThisLife.Model.Albums.Master.getAlbumsByFolderId(e.get("uid")).length+")",e.get("default")||a===ThisLife.Model.Albums.Master.getLifetouchFolderId()||(o=!0)):ThisLife.app.currentState.fragment==="folder/"+n?(i=ThisLife.Model.Albums.Master.getFolderById(n),s=i.get("name"),t="("+ThisLife.Model.Albums.Master.getAlbumsByFolderId(i.get("uid")).length+")",i.get("default")||n===ThisLife.Model.Albums.Master.getLifetouchFolderId()||(o=!0)):"albums/suggested"===ThisLife.app.currentState.fragment?(s="Auto-Albums",t="("+this.albums.auto.length+")"):"albums/friends"===ThisLife.app.currentState.fragment?(s="Shared with Me",t="("+this.albums.shared.length+")"):"albums"===ThisLife.app.currentState.fragment&&(l=this.albums.all.length,s="All Albums",t="("+l+")"),s?this.albumsGridView.updateBreadcrumbs({newName:s,newCount:t,makeEditable:o}):void 0},removedOwnerAlbum:function(e){var t;return this.albums.owner=this.model.getOwnerAlbums(),t=this.subViews[e.get("folder_uid")],null!=t&&t.updateCount(),this.updateAllCounts("owner",e)},removedAutoAlbum:function(e){return this.albums.auto=this.model.getAutoAlbums(),this.updateAllCounts("auto",e)},removedSharedAlbum:function(e){return this.albums.shared=this.model.getSharedAlbums(),this.updateAllCounts("shared",e)},removedLifetouchAlbum:function(e){return this.albums.lifetouch=this.model.getLifetouchAlbums(),this.updateAllCounts("lifetouch",e)},addedAlbum:function(e,t){var i,n,o,s,r;switch(t){case"auto":s="autoAlbum",this.albums[t]=this.model.getAutoAlbums();break;case"owner":s="album",this.albums[t]=this.model.getOwnerAlbums(),i=this.model.getAlbumsByFolderId(e.get("folder_uid")),i.sort();break;case"lifetouch":this.albums[t]=this.model.getLifetouchAlbums();break;default:s="sharedAlbum",this.albums[t]=this.model.getSharedAlbums()}return o={model:e,type:s,callback:_.bind(this.toggleFolders,this)},r=new ThisLife.Albums.View.ListItem(o),n=r.render().el,this.subViews[e.get("uid")]=r,this.updateAllCounts(t,e),r},addedAutoAlbum:function(e){return this.addedAlbum(e,"auto")},addedSharedAlbum:function(e){return this.addedAlbum(e,"shared")},addedLifetouchAlbum:function(e){return this.addedAlbum(e,"lifetouch")},addedOwnerAlbum:function(e){var t,i,n,o;return t=e.get("folder_uid"),i=this.subViews[t],o=this.subViews[e.get("uid")],i?o||(o=this.addedAlbum(e,"owner")):this.albums.owner=this.model.getOwnerAlbums(),null!=i&&i.updateCount(),this.updateAllCounts("owner",e),n=ThisLife.Albums.View.currentPopover,n&&!n.isDestroyed?o.selectAlbum({toggleFolders:!1}):void 0},renamedFolder:function(e){var t,i,n,o,s;return o=e.get("uid"),n=this.ownerFolders.indexOf(e),this.ownerFolders=this.model.getFolderCollection(),this.ownerFolders.sort({silent:!0}),i=this.ownerFolders.indexOf(e),s=this.subViews[o],i!==n&&(t=$(".folder-item[data-uid="+e.get("uid")+"]"),$(t).detach(),this._shuffleFolderListElements(t,i)),s.renamedFolder(),this.updateBreadcrumbs(e)},removedFolder:function(e){var t,i;return this.ownerFolders=this.model.getFolderCollection(),t=$(".folder-item[data-uid="+e.get("uid")+"]"),i=this.subViews[e.get("uid")],$(t).find(".selected").length&&this.clickSection(null,{toggleFolders:!1}),$(t).remove(),this.subViews[e.get("uid")].teardown(),delete this.subViews[e.get("uid")],this.updateAllCounts("owner")},addedFolder:function(e){var t,i,n,o,s,r;return this.ownerFolders=this.model.getFolderCollection(),n=this.ownerFolders.indexOf(e),o={type:"folder",model:e,callback:_.bind(this.toggleFolders,this)},1===this.ownerFolders.length&&(o.lastFolder=!0),r=new ThisLife.Albums.View.ListItem(o),r.on("deletePopoverOpened",this._onDeleteFolderPopoverOpened,this),i=r.render().el,this.subViews[e.get("uid")]=r,this._shuffleFolderListElements(i,n),s=ThisLife.Albums.View.currentPopover,s&&!s.isDestroyed&&(this.model.setActiveFolderId(e.get("uid")),r.selectFolder({toggleFolders:!1})),this.updateAllCounts("owner"),t=this.model.getAlbumsByFolderId(e.get("uid")),t.length?this.addedOwnerAlbum(t[0]):void 0},_shuffleFolderListElements:function(e,t){return $(e).insertAfter(0===t?".folder-item[data-uid="+this.defaultFolder.get("uid")+"]":this.ownerFolders.at(t-1)&&this.ownerFolders.at(t-1).get("uid")!==this.defaultFolder.get("uid")?".folder-item[data-uid="+this.ownerFolders.at(t-1).get("uid")+"]":this.ownerFolders.at(t-2)?".folder-item[data-uid="+this.ownerFolders.at(t-2).get("uid")+"]":".folder-item[data-uid="+this.defaultFolder.get("uid")+"]")},bindCallbacks:function(e){var t,i;return this.listenTo(e,"reset",this.initializeData),null!=(t=ThisLife.app.controller("selection"))&&t.on("start",this.disableHide,this),null!=(i=ThisLife.app.controller("selection"))&&i.on("done",this.enableHide,this),ThisLife.PubSub.on("popoverClosed",this._onPopoverClosed,this)},disableHide:function(){return ThisLife.app.currentState.fragment.indexOf("album")>=0?(this.navCtrl.classList.contains("hidden")||this.navCtrl.click(),this.treeViewEl.addClass("hide-list")):void 0},enableHide:function(){var e;return null!=(e=this.treeViewEl)?e.removeClass("hide-list"):void 0},showLoading:function(){var e;return null!=(e=this.albumsGridView)?e.showLoading():void 0},hideLoading:function(){var e;return null!=(e=this.albumsGridView)?e.hideLoading():void 0},_onMouseEnterSidebar:function(){return this._isMouseleaveBlocked=!1,clearTimeout(this.sidebarTimer)},_onMouseLeaveSidebar:function(){return this._isMouseleaveBlocked?void 0:this.sidebarTimer=setTimeout(_.bind(this._addHiddenClassToTree,this),this.MOUSELEAVE_DELAY)},_onPopoverClosed:function(){return this._isMouseleaveBlocked=!1,this._onMouseLeaveSidebar()},_onDeleteFolderPopoverOpened:function(){return this._isMouseleaveBlocked=!0}})}.call(this),function(){ThisLife.Albums.View.ListItem=Backbone.View.extend({className:"folder-item",tagName:"li",initialize:function(e){return this.options=null!=e?e:{},this.model=this.options.model,this.type=this.options.type,this.selected=this.options.selected,$(this.el).attr("data-uid",this.model.get("uid")),this.listenTo(this.model,"change:album_count",this.updateCount)},teardown:function(){return this.remove()},render:function(){var e;return this.el.insertAdjacentHTML("afterbegin",this.getTemplate()),this.cacheElements(),e=_.extend(this.options,{caller:this,model:this.model,container:this.folderInfoEl}),this},closeCallback:function(){return $(this.folderInfoEl).removeClass("hover")},cacheElements:function(){return this.folderInfoEl=this.el.querySelector(".folder-info"),this.container=$("#bucket-list"),this.folderNameEl=this.el.querySelector(".folder-name .name")},getTemplate:function(){return this.model.get("folder_uid")?void 0:this.template=this.foldersTemplate()},events:{"click .folder-info":"clickItem","click .folder-item":"clickItem","hover .folder-arrow":"hoverArrow","click .delete-folder":"deleteFolder"},renamedFolder:function(){var e,t;return t=ThisLife.Helper.String.escapeHtml(this.model.get("name"))+" ",e=$(this.el).find(".folder-name"),this.folderNameEl.innerHTML=t},clickItem:function(e){var t,i;return t=e.target,e.stopPropagation(),i=!0,this.selectFolder(i)},hoverArrow:function(e){return e.stopPropagation(),$(e.target).toggleClass("hover")},selectFolder:function(e){var t;return e===!0?ThisLife.app.currentState.fragment==="folder/"+this.model.get("uid")?("function"==typeof(t=this.options).closeSidebarCallback&&t.closeSidebarCallback(),this.options.callback()):ThisLife.app.router.navigateToFolder(this.model.get("uid")):(ThisLife.app.router.navigateToFolder(this.model.get("uid"),{trigger:!1}),ThisLife.app.router.controller.handleAlbumsRoute("folder",{folder_uid:this.model.get("uid"),toggleFolders:!1}))},selectAlbum:function(e){return e===!0?ThisLife.app.currentState.fragment==="album/"+this.model.get("uid")?this.options.callback():ThisLife.app.router.navigateToAlbum(this.model.get("uid")):(ThisLife.app.router.navigateToAlbum(this.model.get("uid"),{trigger:!1}),ThisLife.app.router.controller.handleAlbumsRoute("album",{album_uid:this.model.get("uid"),toggleFolders:!1}))
},deleteFolder:function(e){return e.stopPropagation(),$(".hide-container").hasClass("hidden")?void 0:(ThisLife.Albums.View.currentPopover=new ThisLife.Albums.View.DeleteFolderPopover({model:this.model}),this.trigger("deletePopoverOpened",!0))},updateCount:function(){var e,t,i,n;if(e=this.model.get("album_count"),$(this.el).children(".folder-info").find(".count").text("("+e+")"),n=(null!=(t=ThisLife.app.currentState)?t.fragment.indexOf("album"):void 0)>-1||(null!=(i=ThisLife.app.currentState)?i.fragment.indexOf("folder"):void 0)>-1,0===e){if(n)return ThisLife.app.album.listViewObj.trigger("change:visibleAlbumCount",!0)}else if(n)return ThisLife.app.album.listViewObj.trigger("change:visibleAlbumCount",!1)},foldersTemplate:function(){var e,t,i,n,o,s;return n=ThisLife.Helper.String.escapeHtml(this.model.get("name")),i=this.model.get("album_count"),s=this.model.get("uid"),e=this.model.get("default")?"default-":"",t=this.options.lastFolder||this.model.get("default")?"":"<span class='delete-folder'></span>",o=""===t?"sticky":"","<div class='folder-info'>\n  <div class='"+e+"folder-arrow'></div>\n  <div class='folder-name' id='"+s+"'>\n    <div class=\"folder-name-count-holder\">\n      <span class='name'>"+n+"</span>\n      <span class='count "+o+"'>("+i+")</span>\n    </div>\n    "+t+"\n  </div>\n</div>"}})}.call(this),function(){var e;ThisLife.Albums||(ThisLife.Albums={}),(e=ThisLife.Albums).View||(e.View={}),ThisLife.Albums.View.Popover=Backbone.View.extend({className:"popover_wrap new_popover_wrap",folder:!1,initialize:function(e){return this.options=null!=e?e:{},this.uid=this.options.uid,this.isDestroyed=!1,this.moments=ThisLife.Model.User.isPaidAccount()?"Photos and videos":"Photos",this.foldersList=ThisLife.Model.Albums.Master.getFolderCollection(),this.folder_uid||(this.folder_uid=this.original_uid=this.model?this.model.get(this.model.get("folder_uid")?"folder_uid":"uid"):this.foldersList.models[0].get("uid")),this.render()},render:function(){return this.$el.html(this.template()),this.popover=this.el.querySelector(".popover"),this.blurEventCallback=ThisLife.blurEvent($(this.popover),_.bind(this.cancel,this)),document.body.appendChild(this.el),ThisLife.Support.keyInformant.on("cancel",this.cancel,this),ThisLife.Support.keyInformant.on("enter",this.confirm,this),$("body").addClass("modal-open"),this},cancel:function(e){return this.processing?void 0:this.cancelButton(e)},confirm:function(e){return this.processing?void 0:this.confirmButton(e)},teardown:function(){return $("body").removeClass("modal-open"),ThisLife.removeBlurEvent(this.blurEventCallback),ThisLife.Support.keyInformant.off("cancel",this.cancel,this),ThisLife.Support.keyInformant.off("enter",this.confirm,this),this.trigger("torndown"),this.remove(),this.isDestroyed=!0,this.processing=!1,ThisLife.Albums.View.currentPopover?(ThisLife.Albums.View.currentPopover=null,ThisLife.PubSub.trigger("popoverClosed")):void 0},confirmDone:function(e,t){return $(this.el).find(".popover").removeClass("one_button_modal"),$(this.el).find(".body").html('<div class="confirmDone">'+e+"</div>"),_.delay(function(e){return function(){var i;return e.teardown(),t?(i=new ThisLife.View.ModalAlert({template:"actionPermissionWarning"}),$(document.body).append(i.render().el)):void 0}}(this),1200)},confirmDoneNewToast:function(e,t){var i;return ThisLife.app.controller("toast")["new"]({title:e,style:"light",position:"bottom-left"}),this.teardown(),t?(i=new ThisLife.View.ModalAlert({template:"actionPermissionWarning"}),$(document.body).append(i.render().el)):void 0},getErrorText:function(e){var t;return t=this.errors[e],t||(t=this.errors.GENERIC),t},errors:{DUPLICATE_FOLDER_NAME:"This name already exists.  Please try again.",CANNOT_DELETE_SYSTEM_FOLDER:"You cannot delete this folder.",CANNOT_DELETE_MY_ALBUM:"You cannot delete this album.",DUPLICATE_ALBUM_NAME:"This name already exists.  Please try again.",BLANK_FOLDER:"Folder name cannot be blank!",BLANK_ALBUM:"Album name cannot be blank!",LONG_FOLDER:"Folder name is too long.",LONG_ALBUM:"Album name is too long.",GENERIC:"Something went wrong.  Please try again."},cancelButton:function(){return this.teardown()},confirmButton:function(){return this.teardown()},validateName:function(e,t){return e?e.length>ThisLife.Model.Albums.Master.maxAlbumTitleLength?t?"LONG_FOLDER":"LONG_ALBUM":null:t?"BLANK_FOLDER":"BLANK_ALBUM"},clearErrors:function(){var e;return e=$(".albums_popover_wrap .error"),e?e.removeClass("error"):void 0},showError:function(e,t){var i;return i=this.getErrorText(t),$(e).addClass("error"),t=$(e).find(".input_error"),$(t).text(i),!1},dismissError:function(e,t){var i;return i=e?$(e.target).parents(".error"):t,i.length&&$(i).hasClass("error")?($(i).removeClass("error"),$(this.el).hide().show(0),this.focusWithoutScroll($(i).find("input"))):void 0},showDialogError:function(e){var t;return t="<span class='close-btn'><img src='/assets/1px.gif'></span>\n<div class='confirmDone'>\n    "+this.getErrorText(e)+"\n</div>",$(this.el).find(".body").html(t),this.delegateEvents(),!1},keyPress:function(e){return ThisLife.Helper.Keyboard.isEnter(e.keyCode)?this.confirmButton(e):void 0},spinnerTemplate:function(){return"<div class='modal-spinner'>\n</div>"},displaySpinner:function(){return $(this.el).find(".body").html(this.spinnerTemplate()),$(".close-btn").addClass("hidden")},focusWithoutScroll:function(e,t){var i;return null==t&&(t="#album-view .albums-grid-scroll"),i=$(t).scrollTop(),e.focus(),$(t).scrollTop(i)}}),ThisLife.Albums.View.AddFolderPopover=ThisLife.Albums.View.Popover.extend({events:{"click .done-btn":"confirmButton","click .close-btn":"cancelButton","keypress input":"keyPress","click .error-text-icon":"dismissError","click input":"dismissError"},render:function(){return ThisLife.Albums.View.AddFolderPopover.__super__.render.apply(this,arguments),this.focusWithoutScroll($("input.name"))},confirmButton:function(){var e,t,i;if(t=$(".modal_information > input").val().trim(),e=this.validateName(t,!0))return this.showError(this.el.querySelector(".modal_information"),e);try{return this.processing=!0,i=function(e){return function(){return e.teardown()}}(this),ThisLife.Model.Albums.Master.createFolder(t,i),this.displaySpinner()}catch(n){return e=n,this.processing=!1,this.showError(this.el.querySelector(".modal_information"),e)}},template:function(){var e;return e=ThisLife.Model.Albums.Master.maxFolderTitleLength,'  <div class=\'popover one_button_modal\'>\n  <span class="close-btn"><img src="/assets/1px.gif"></span>\n  <div class="body">\n\n  <h4>Folder Name</h4>\n  <div class="modal_information">\n    <input type="text" placeholder="Folder name" class=\'name\' maxlength="'+e+'"/>\n    <div class="error-text-icon"><img src="/assets/1px.gif">\n              <div class="disabled_tooltip_wrap">\n                <div class="disabled_tooltip_arrow"></div>\n                <div class="disabled_tooltip">\n                  <div class="input_error">Error</div>\n                </div>\n              </div>\n        </div>\n  </div>\n\n  <div class="action_btn_wrap clearfix">\n    <a class="orange-btn done-btn">Create</a>\n  </div>\n\n</div>\n\n</div>\n'}}),ThisLife.Albums.View.AddAlbumPopover=ThisLife.Albums.View.AddFolderPopover.extend({events:{"click .close-btn":"cancelButton"},render:function(){return this.model=this.options.model,this.options.mode="modal",this.options.parent=this,ThisLife.Albums.View.AddAlbumPopover.__super__.render.apply(this,arguments),this.view=new ThisLife.Albums.View.AlbumCreate(this.options),this.el.querySelector(".popover.one_button_modal.new_album").appendChild(this.view.el)},teardown:function(){return this.view.teardown(),ThisLife.Albums.View.AddAlbumPopover.__super__.teardown.apply(this,arguments)},confirmButton:function(e){return this.view.confirmButton(e)},template:function(){return'<div class=\'popover one_button_modal new_album\'>\n  <span class="close-btn"><img src="/assets/1px.gif"></span>\n</div>'}}),ThisLife.Albums.View.RenameAlbumPopover=ThisLife.Albums.View.Popover.extend({events:{"click .done-btn":"confirmButton","click .close-btn":"cancelButton","keypress input":"keyPress","click .error-text-icon":"dismissError","click input":"dismissError"},render:function(){return ThisLife.Albums.View.RenameAlbumPopover.__super__.render.apply(this,arguments),this.focusWithoutScroll($("input.name")),$("input.name").select()},confirmButton:function(){var e,t,i;if(e=$(".modal_information > input").val().trim(),t=this.validateName(e,!1))return this.showError(this.el.querySelector(".modal_information"),t);try{return this.processing=!0,i=function(e){return function(){return e.teardown()}}(this),this.model.rename(e,i),this.displaySpinner()}catch(n){return t=n,this.processing=!1,this.showError(this.el.querySelector(".modal_information"),t)}},template:function(){var e,t;return e=ThisLife.Helper.String.escapeHtml(this.model.get("name")),t=ThisLife.Model.Albums.Master.maxAlbumTitleLength,'  <div class=\'popover one_button_modal\'>\n  <span class="close-btn"><img src="/assets/1px.gif"></span>\n  <div class="body">\n\n  <h4>Rename Album</h4>\n  <div class="modal_information">\n    <input type="text" class=\'name\' value="'+e+'" maxlength="'+t+'"/>\n    <div class="error-text-icon"><img src="/assets/1px.gif">\n              <div class="disabled_tooltip_wrap">\n                <div class="disabled_tooltip_arrow"></div>\n                <div class="disabled_tooltip">\n                  <div class="input_error">Error</div>\n                </div>\n              </div>\n      </div>\n  </div>\n\n  <div class="action_btn_wrap clearfix">\n    <a class="orange-btn done-btn">Rename</a>\n  </div>\n\n</div>\n</div>\n'}}),ThisLife.Albums.View.DeleteFolderPopover=ThisLife.Albums.View.Popover.extend({className:"popover_wrap new_popover_wrap delete",folder:!0,events:{"click .done-btn":"confirmButton","click .cancel_btn":"cancelButton","click .close-btn":"cancelButton"},confirmButton:function(e){var t,i;e.preventDefault();try{return this.processing=!0,i=function(e){return function(){return e.confirmDone("1 folder has been deleted")}}(this),ThisLife.Model.Albums.Master.deleteFolder(this.model.get("uid"),i),this.displaySpinner()}catch(n){return t=n,this.processing=!1,this.showDialogError(t)}},template:function(){var e,t,i,n;return n="All the albums will be deleted. "+this.moments+" won't be deleted, you can retrieve them on your All Photos page.",i="Delete this folder?",e=ThisLife.Model.Albums.Master.getAlbumsByFolderId(this.model.get("uid")),t=e.filter(function(e){return e.get("is_shared")===!0}),0===e.length&&(n="",i="Delete this empty folder?"),t.length>0&&(n="All albums will be deleted including shared albums.  The people invited to view these shared albums will no longer have access to them.  "+this.moments+" won't be deleted, you can retrieve them on your All Photos page."),"<div class='popover two_button_modal'>\n  <div class=\"body\">\n <h4>"+i+'</h4>\n  <div class="modal_information">\n    '+n+'\n  </div>\n\n  <div class="action_btn_wrap clearfix">\n    <a class="gray-btn cancel_btn">Cancel</a>\n    <a class="orange-btn done-btn">Delete</a>\n  </div>\n\n</div>\n</div>\n'}}),ThisLife.Albums.View.DeleteAlbumPopover=ThisLife.Albums.View.DeleteFolderPopover.extend({folder:!1,confirmButton:function(e){var t,i,n;e.preventDefault();try{return t="1 album has been deleted",this.model.get("is_shared")&&(t="1 shared album has been deleted"),n=function(e){return function(){return e.model.isFriendsAlbum()?ThisLife.Model.Albums.Master.handleInviteDelete(e.model.get("uid")):ThisLife.Model.Albums.Master.handleAlbumDelete(e.model.get("uid")),e.confirmDone(t)}}(this),this.processing=!0,ThisLife.Model.Albums.Master.deleteAlbum(this.model.get("uid"),n),this.displaySpinner()}catch(o){return i=o,this.processing=!1,this.showDialogError(i)}},template:function(){var e,t;return t="Delete this album?",e=this.moments+" will not be deleted from your Shutterfly account. You can view them on your All Photos page.",this.model.isFriendsAlbum()?e="You won't have access to this content anymore. Your friend will have to share it again with you...":this.model.get("is_shared")&&(t="Delete this shared album?",e="The people invited to view this album will no longer have access to it. "+this.moments+" won't be deleted, you can retrieve them on your All Photos page."),0===this.model.get("visible_moment_count")&&(t="Delete this empty album?",e=""),"<div class='popover two_button_modal'>\n  <div class=\"body\">\n <h4>"+t+'</h4>\n  <div class="modal_information">\n    '+e+'\n  </div>\n\n  <div class="action_btn_wrap clearfix">\n    <a class="gray-btn cancel_btn">Cancel</a>\n    <a class="orange-btn done-btn">Delete</a>\n  </div>\n\n</div>\n</div>\n'}}),ThisLife.Albums.View.CopyMoveAlbumPopover=ThisLife.Albums.View.AddFolderPopover.extend({events:{"click .done-btn":"confirmButton","click .close-btn":"cancelButton","click .dropdown-top":"toggleFoldersList","click .folders-dropdown > li":"selectFolder"},initialize:function(){return this.foldersList=ThisLife.Model.Albums.Master.getFolderCollection(),this.lifetouchFolder=ThisLife.Model.Albums.Master.getLifetouchFolder(),this.defaultFolder=ThisLife.Model.Albums.Master.getDefaultFolder(),this.folder_uid=this.original_uid=this.model.isAutoAlbum()||this.model.isFriendsAlbum()?this.defaultFolder.get("uid"):this.model.get("folder_uid"),ThisLife.Albums.View.CopyMoveAlbumPopover.__super__.initialize.apply(this,arguments)},confirmButton:function(){var e,t;try{return this.processing=!0,t=function(e){return function(t){var i,n,o,s;return t?(s=ThisLife.Model.Albums.Master.getFolderById(t.get("folder_uid")),i=ThisLife.Helper.String.escapeHtml(t.get("name")),o=ThisLife.Helper.String.escapeHtml(s.get("name")),n=i+" has been moved to "+o,e.options.copy&&(n=t.get("folder_uid")===e.folder_uid?i+" has been created in "+o:i+" has been copied to "+o),e.confirmDone(n)):e.teardown()}}(this),this.options.copy?this.model.copyToFolder(this.folder_uid,t):this.model.moveToFolder(this.folder_uid,t),this.displaySpinner()}catch(i){return e=i,this.processing=!1,this.teardown()}},toggleFoldersList:function(e){var t,i;return e.stopPropagation(),t=this.$el.find(".folder-list").toggleClass("expanded").removeClass("reverse-popover"),t.hasClass("expanded")&&(i=t.find(".folders-pullout"),i.height()+i.offset().top>$(window).height())?t.addClass("reverse-popover"):void 0},updateFoldersList:function(e,t,i,n){return this.folder_uid=t,this.$el.find(".dropdown-top span").text(e),$(this.el.querySelector(".dropdown-top")).removeClass("default-folder lifetouch-folder"),n&&$(this.el.querySelector(".dropdown-top")).addClass(n),this.$el.find(".folder-list").removeClass("expanded"),this.$el.find(".folder-list .selected").removeClass("selected"),this.$el.find(i).addClass("selected")},selectFolder:function(e,t){var i,n;return e&&(e.stopPropagation(),this.dismissError(null,$(".modal_information")),t=t||e.currentTarget),n=this.$el.find(t).children("span"),i=null,$(n).hasClass("default-folder")?i="default-folder":$(n).hasClass("lifetouch-folder")&&(i="lifetouch-folder"),this.updateFoldersList($(n).text(),$(t).attr("data-uid"),t,i),this.focusWithoutScroll($(this.el).find(".done-btn"))},_getFoldersList:function(){var e,t,i,n,o;for(i=this.lifetouchFolder?this.listItemTemplate(this.lifetouchFolder):"",i+=this.listItemTemplate(this.defaultFolder),o=this.foldersList.models,e=0,t=o.length;t>e;e++)n=o[e],n.get("default")||(i+=this.listItemTemplate(n));return i},listItemTemplate:function(e){var t,i;return i=e.get("uid")===this.folder_uid?"selected":"",t=e.get("default")?"default-folder":12===e.get("folder_type")?"lifetouch-folder":"","<li data-uid='"+e.get("uid")+"' class='"+i+"'><span class='"+t+"'>"+ThisLife.Helper.String.escapeHtml(e.get("name"))+"</span></li>"},template:function(){var e,t,i,n,o,s;return e=this.options.copy?"Copy":"Move",s=this.options.copy?"Copy to: ":"Move to: ",this.model.isFriendsAlbum()&&this.options.copy&&(s="Save to: ",e="Save"),n="",this.model?(t=ThisLife.Model.Albums.Master.getFolderById(this.model.get("folder_uid")),t?(i=ThisLife.Helper.String.escapeHtml(t.get("name")),t.get("default")||this.model.isFriendsAlbum()?(n="default-folder",i=ThisLife.Helper.String.escapeHtml(this.defaultFolder.get("name"))):12===t.get("folder_type")&&(n="lifetouch-folder")):i=ThisLife.Helper.String.escapeHtml(this.defaultFolder.get("name"))):i=ThisLife.Helper.String.escapeHtml(this.defaultFolder.get("name")),o="<ul class='folders-dropdown'>"+this._getFoldersList()+"</ul>",'<div class=\'popover one_button_modal copy_album\'>\n  <span class="close-btn"><img src="/assets/1px.gif"></span>\n  <div class="body">\n    <h4>'+s+"</h4>\n    <div class=\"modal_information\">\n      <div class='change-folder'>\n        <div class='folder-choices'>\n          <div class='folder-list'>\n            <div class='dropdown-top "+n+"'><span>"+i+"</span></div>\n            <div class='folders-pullout'>\n              "+o+'\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n    <div class="action_btn_wrap clearfix">\n      <a class="orange-btn done-btn">'+e+"</a>\n    </div>\n  </div>\n</div>"}}),ThisLife.Albums.View.Spinner=ThisLife.Albums.View.Popover.extend({initialize:function(){return ThisLife.Albums.View.Spinner.__super__.initialize.apply(this,arguments),this.displaySpinner()},template:function(){return'<div class="popover new_album">\n  <div class="body"></div>\n</div>'}})}.call(this),function(){var e={}.hasOwnProperty;ThisLife.Albums.View.Modals=ThisLife.Albums.View.Modals||{},ThisLife.Albums.View.Modals.Acceptance=Backbone.View.extend({className:"popover_wrap new_popover_wrap",events:{"click .cancel_btn":"teardown","click .close-btn":"teardown"},initialize:function(e){return this.options=null!=e?e:{},this.albumCollection=ThisLife.Model.Albums.Master.getAllAlbums(),this.listItemViews={},this.render(),this.renderAlbums(),this.bindCallbacks()},render:function(){return this.$el.html(this.template()),document.body.appendChild(this.el),this.listEl=this.el.querySelector(".list_container"),this.emptyListItem=this.el.querySelector(".empty_list_item")},renderAlbums:function(){return this.checkEmptyStatus(),this.checkInitialAlbum()},addAlbumToList:function(e){var t;return t=new ThisLife.Albums.View.Modals.AcceptanceItem({model:e}),this.listItemViews[e.id]=t,this.listEl.appendChild(t.el)},removeAlbumFromList:function(e){return this.listItemViews.hasOwnProperty(e)?(this.listItemViews[e].teardown(),delete this.listItemViews[e]):void 0},checkEmptyStatus:function(){return $(this.listEl).children().length>0?$(this.emptyListItem).hide():$(this.emptyListItem).show()},checkInitialAlbum:function(){var e;return null!=(null!=(e=this.options)?e.focusAlbum:void 0)&&this.listItemViews.hasOwnProperty(this.options.focusAlbum)&&(this.listItemViews[this.options.focusAlbum].el.scrollIntoView(),this.listEl.scrollTop>0&&this.listEl.scrollTop+this.listEl.clientHeight<this.listEl.scrollHeight)?this.listEl.scrollTop-=50:void 0},bindCallbacks:function(){return this.blurEventCallback=ThisLife.blurEvent(this.$el.find(".popover"),_.bind(this.teardown,this)),ThisLife.Support.keyInformant.on("cancel",this.teardown,this,!0),this.albumCollection.on("add",this.handleNewAlbum,this).on("remove",this.handleRemovedAlbum,this)},unbindCallbacks:function(){return ThisLife.removeBlurEvent(this.blurEventCallback),ThisLife.Support.keyInformant.off("cancel",this.teardown,this),this.albumCollection.off(null,null,this)},handleNewAlbum:function(){return this.checkEmptyStatus()},handleRemovedAlbum:function(e){return this.removeAlbumFromList(e.id),this.checkEmptyStatus()},teardown:function(){var t,i,n;i=this.listItemViews;for(t in i)e.call(i,t)&&(n=i[t],n.teardown());return this.unbindCallbacks(),this.remove()},template:function(){return'  <div class=\'popover accept_modal one_button_modal\'>\n    <span class="close-btn"><img src="/assets/1px.gif"></span>\n    <div class="body">\n      <h4>Accept or decline friends\' album invitations</h4>\n      <div class="popover_list_wrap">\n        <div class="list_header">Invitations</div>\n        <div class="list_container"></div>\n        <div class="list_item empty_list_item"><div class="icon-invitation"></div>You have no new invitations</div>\n      </div>\n  </div>\n</div>\n'}}),ThisLife.Albums.View.Modals.AcceptanceItem=Backbone.View.extend({className:"list_item",events:{"click .accept-btn":"acceptInvite","click .decline-btn":"declineInvite"},initialize:function(){return this.render()},render:function(){return this.$el.html(this.template()),this.buttonBlockEl=this.el.querySelector(".button_block")},acceptInvite:function(){return this.model.acceptInvitation(),$(this.buttonBlockEl).hide()},declineInvite:function(){return this.model.declineInvitation(),$(this.buttonBlockEl).hide()},teardown:function(){return this.remove()},template:function(){var e,t,i,n;return i=this.model.get("permission.view_only")?"view&nbsp;":"contribute",t=ThisLife.Helper.Image.imgUrl(this.model.get("cover_moment_uid"),"x-small",this.model.get("cover_effects_modified_date"),this.model.get("cover_owner_uid")),e=ThisLife.Helper.String.escapeHtml(this.model.get("name")),n=this.model.get("permission.owner_first_name")||this.model.get("permission.name")?this.model.get("permission.owner_first_name")||this.model.get("permission.name"):"",'<div class="album_icon" style="background-image: url('+t+');"></div>\n<div class="album_name" title="'+e+'">'+e+'</div>\n<div class="album_owner">'+n+'</div>\n<div class="invite_label">\n  Invited to <br />\n  '+i+'\n</div>\n<div class="button_block">\n  <div class="orange-btn accept-btn">Accept</div>\n  <div class="gray-btn decline-btn">Decline</div>\n</div>'}})}.call(this),function(){ThisLife.Albums.View.Modals=ThisLife.Albums.View.Modals||{},ThisLife.Albums.View.Modals.EmptySharedAlbum=Backbone.View.extend({className:"popover_wrap new_popover_wrap",events:{"click .done-btn, .close-btn":"teardown"},initialize:function(e){return this.options=null!=e?e:{},this.render()},render:function(){return this.$el.html(this._template()),document.body.appendChild(this.el)},teardown:function(){return this.remove()},_template:function(){return'<div class=\'popover\'>\n  <span class="close-btn"><img src="/assets/1px.gif"></span>\n  <div class="modal_information" style="margin: 50px 25px 0;">\n    <div>This album has no photos</div>\n  </div>\n  <div class="action_btn_wrap clearfix">\n    <div class="orange-btn done-btn">Ok</div>\n  </div>\n</div>'}})}.call(this),function(){define("ThisLife.Albums.Helpers",[],function(){var e;return e={isTreeOpen:function(){return!$("#bucket-wrapper").hasClass("hidden")}}})}.call(this),function(){define("ThisLife.Albums.View.GridItemMenu",[],function(){var e;return e=Backbone.View.extend({className:"edit_menu",id:"grid_edit_menu",events:{click:"cancelClick","click .rename":"rename","click .copy":"copyTo","click .save":"saveTo","click .move":"moveTo","click .delete":"delete","click .share":"share"},initialize:function(e){return this.options=null!=e?e:{},this.model=this.options.model,this.render()},render:function(){return this.el.insertAdjacentHTML("afterbegin",this.getTemplate())},rename:function(e){return e.stopPropagation(),this._sendMetrics("Rename"),ThisLife.Albums.View.currentPopover=new ThisLife.Albums.View.RenameAlbumPopover({model:this.model})},cancelClick:function(e){return e.stopPropagation()},copyTo:function(e){return e.stopPropagation(),this._sendMetrics("CopyTo"),ThisLife.Albums.View.currentPopover=new ThisLife.Albums.View.CopyMoveAlbumPopover({model:this.model,copy:!0})},saveTo:function(e){return e.stopPropagation(),this._sendMetrics("SaveTo"),ThisLife.Albums.View.currentPopover=new ThisLife.Albums.View.CopyMoveAlbumPopover({model:this.model,copy:!0})},moveTo:function(e){return e.stopPropagation(),this._sendMetrics("MoveTo"),ThisLife.Albums.View.currentPopover=new ThisLife.Albums.View.CopyMoveAlbumPopover({model:this.model,copy:!1})},"delete":function(e){return e.stopPropagation(),this._sendMetrics("Delete"),ThisLife.Albums.View.currentPopover=new ThisLife.Albums.View.DeleteAlbumPopover({model:this.model})},share:function(e){var t,i;return e.stopPropagation(),this._loadRequest?void 0:(this._sendMetrics("Share"),ThisLife.currentStory=this.model,ThisLife.storyUid=this.model.get("uid"),i=function(e){return function(){var t;return e._loadRequest=null,t={onClose:e.confirmAlbumShareClose},ThisLife.app.controller("albums").openShareModal(t)}}(this),t=function(e){return function(){return e._loadRequest=null,ThisLife.currentStory=null,ThisLife.storyUid=null}}(this),this._loadRequest=this.model.load(i,t,null,!0))},_unshareModal:function(){return new ThisLife.View.Album.SharePopupUnshareConfirmation},_sendMetrics:function(e){return ThisLife.app.controller("tracking").logClickAlbumsCoverAction(e)},remove:function(){return Backbone.View.prototype.remove.apply(this)},shareAlbum:function(){return ThisLife.PubSub.trigger("albumAction:share")},confirmAlbumShareClose:function(){return this.childView.confirmDone()},getTemplate:function(){var e,t,i,n;return i=this.model.isFriendsAlbum()?"":"<div class='rename'>Rename</div>",n=this.model.isFriendsAlbum()||0===this.model.get("visible_moment_count")?"":"<div class='share'>Share</div>",e="<div class='copy'>Copy to...</div>",this.model.isFriendsAlbum()&&(e="<div class='save'>Save to...</div>"),t=this.model.isFriendsAlbum()?"":"<div class='move'>Move to...</div>",n+"\n"+i+"\n"+e+"\n"+t+"\n <div class='divider'></div>\n <div class='delete'>Delete</div>\n"}})}),ThisLife.Albums.View.GridItemMenu=require("ThisLife.Albums.View.GridItemMenu")}.call(this),function(){define("ThisLife.Albums.View.GridItem",[],function(){var e;return e=Backbone.View.extend({className:"framed_moment stack story_element",events:{click:"onClick","mouseover .edit":"openEditMenu",mouseleave:"closeEditMenu"},initialize:function(e){return this.options=null!=e?e:{},this.parentView=this.options.parent,this.imageQueue=this.options.imageQueue,this.bindCallbacks(),this.setup()},bindCallbacks:function(){var e;return ThisLife.PubSub.on("story:changed_cover",this.changeCover,this).on("story:changed_name",this.onChangeName,this).on("popoverClosed",this.closeEditMenu,this),this.listenTo(this.model,"change:visible_moment_count",this.onChangeMomentCount),this.listenTo(this.model,"change:start_date change:end_date",this.onChangeDates),this.listenTo(this.model,"change:last_viewed",this.onChangeLastViewed),this.listenTo(this.model,"remove",this.teardown),e=ThisLife.Collection.moments.get(this.model.get("cover_moment_uid")),e?this.listenTo(e,"updateImageSource",this.changeCover):void 0},unbindCallbacks:function(){return ThisLife.PubSub.off(null,null,this)},setup:function(){return this.uid=this.model.get("uid"),this.folder=ThisLife.Model.Albums.Master.getFolderById(this.model.get("folder_uid")),this.model.get("cover_moment_uid")||this.el.classList.add("no_image"),this.model.isAutoAlbum()&&!this.model.get("last_viewed")?this.el.classList.add("new"):void 0},teardown:function(){var e,t;return null!=(e=this.editMenuView)&&e.remove(),null!=(t=this.albumNameView)&&t.remove(),this.unbindCallbacks(),this.remove()},onChangeName:function(e,t){return e===this.uid?this.albumNameView.setName(t):void 0},openEditMenu:function(e){return this.parentView.isNameEditValid()?(e.stopPropagation(),this._sendMetrics("albumActionHover"),this.editMenuView=new ThisLife.Albums.View.GridItemMenu({model:this.model,parent:this.options.parent}),this.el.appendChild(this.editMenuView.el)):void 0},_sendMetrics:function(e){return ThisLife.app.controller("tracking").logAlbumGridItemEvent(e)},closeEditMenu:function(){var e;return ThisLife.Albums.View.currentPopover?void 0:null!=(e=this.editMenuView)?e.remove():void 0},render:function(){return this.el.dataset.uid=this.model.get("uid"),this.el.insertAdjacentHTML("afterbegin",this.getTemplate()),this.checkLoadingThrobber(),this.cacheElements(),this.albumNameView=new ThisLife.Albums.View.InlineEditField({maxLength:ThisLife.Model.Albums.Master.maxAlbumTitleLength,model:this.model,parentView:this.options.parent}),$(this.metaEl).prepend(this.albumNameView.el),this},cacheElements:function(){return this.imgEl=this.el.querySelector(".img"),this.metaEl=this.el.querySelector(".framed_moment_meta")},getTemplate:function(){return this.template=this.albumTemplate()},onClick:function(e){if($(e.target).hasClass("editable")||$(e.target.parentNode).hasClass("editable"));else if("decline"===e.target.className){if(this.parentView.isNameEditValid())return this.model.declineInvitation(),this.teardown()}else if(this.parentView.isNameEditValid())return this.el.classList.remove("new"),this.goToAlbum(e)},onChangeMomentCount:function(e){var t;return e>999&&(e="999+"),null!=(t=this.el.getElementsByClassName("count"))&&(t[0].textContent=e),this.checkLoadingThrobber()},onChangeDates:function(){var e,t,i,n,o,s,r,l;return r=this.model.get("start_date"),n=this.model.get("end_date"),r&&n&&(i=this.getDateRange(),l=this.el.getElementsByClassName("subtitle")[0],l?l.textContent=i:this.el.getElementsByClassName("title")[0].insertAdjacentHTML("afterend",'<span class="subtitle">'+i+"</span>")),this.options.collection?(s=this.el.parentNode,s.removeChild(this.el),this.options.collection.sort(),o=this.options.collection.indexOf(this.model)+1,t=s.children,e=t[o],e?s.insertBefore(this.el,e):s.appendChild(this.el)):void 0},onChangeLastViewed:function(e){return this.model.isAutoAlbum()&&!e?this.el.classList.add("new"):this.el.classList.remove("new")},changeCover:function(e,t){var i,n,o,s;if(t&&this.uid)return t===this.uid?e.cover_moment_uid?(n=function(t){return function(i,n){var o;return t.el.classList.remove("no_image"),null!=(o=t.imgEl)&&(o.style.backgroundImage="url("+s+")"),t.positionCoverImage(i,n,e)}}(this),i=function(e){return function(){return e.el.classList.add("no_image"),e.imgEl.style.backgroundImage="url(/assets/1px.gif')"}}(this),s=this.getCoverUrl(e),ThisLife.Helper.Image.preloadImage(s,n,i)):(this.el.classList.add("no_image"),null!=(o=this.imgEl)?o.style.backgroundImage="url(/assets/1px.gif')":void 0):void 0},positionCoverImage:function(e,t,i){var n,o,s,r;return o="center center",n=i?i.cover_moment_aoi:this.model.get("cover_moment_aoi"),n&&e&&t?o=ThisLife.Helper.Image.backgrounPositionForAreaOfInterest(n,e,t,this.imgEl.clientWidth,this.imgEl.clientHeight):(r=e||parseFloat(this.model.get("orig_width")),s=t||parseFloat(this.model.get("orig_height")),s>r&&(o="center 25%")),this.imgEl.style.backgroundPosition=o},goToAlbum:function(){var e;return e=this.el.offsetTop-.5*this.options.parent.el.offsetHeight+.5*this.el.offsetHeight,this.options.parent.setInitialScroll(Math.max(0,e)),ThisLife.app.controller("timing").recordEvent("navigateAlbum"),ThisLife.app.router.navigateToAlbum(this.model.get("uid"))},getCoverUrl:function(e){var t,i,n,o,s,r,l,a,u;return e||(e={cover_moment_uid:this.model.get("cover_moment_uid"),cover_owner_uid:this.model.get("cover_owner_uid"),cover_effects_modified_date:this.model.get("cover_effects_modified_date")}),u=220,i=170,a=e.cover_moment_uid,s=e.cover_owner_uid,l=e.cover_effects_modified_date,n=ThisLife.Collection.moments.get(a),n&&(o=n.get("width")/n.get("height"),r=u/i,r>o?i=u/o:u=i*o),a?(t={height:i,width:u},ThisLife.Helper.Image.imageUrlDim(a,t,l,s)):""},getDateRange:function(){var e,t,i,n,o,s;return o=this.model.get("start_date"),t=this.model.get("end_date"),n=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],e=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],s=new Date(1e3*o),i=new Date(1e3*t),s.getFullYear()===i.getFullYear()?s.getMonth()===i.getMonth()?s.getDate()===i.getDate()?e[s.getDay()]+" "+n[s.getMonth()]+" "+s.getDate()+", "+s.getFullYear():n[s.getMonth()]+" "+s.getDate()+" - "+i.getDate()+", "+s.getFullYear():n[s.getMonth()]+" "+s.getDate()+" - "+n[i.getMonth()]+" "+i.getDate()+", "+s.getFullYear():n[s.getMonth()]+" "+s.getDate()+", "+s.getFullYear()+" - "+n[i.getMonth()]+" "+i.getDate()+", "+i.getFullYear()},getAuthorName:function(){var e,t;return t=this.model.get("name"),e=this.model.get("permission.owner_first_name")||this.model.get("permission.name"),ThisLife.Helper.String.escapeHtml(e)},checkLoadingThrobber:function(){var e,t;return e=this.el.querySelector(".loading"),null!=e&&null!=(t=e.parentNode)&&t.removeChild(e),this.model.get("recently_copied")&&this.model.pendingUploads.length>0?this.el.appendChild($('<div class="loading"><div class="throbber throbber_large"><div class="throbber_overlay"></div></div></div>')[0]):void 0},loadImage:function(e){var t;return this.imgEl.style.backgroundImage="url("+e+")",ThisLife.Model.Albums.Master.getFirstCoverLoaded()||(ThisLife.Model.Albums.Master.setFirstCoverLoaded(Date.now()),ThisLife.app.controller("timing").loadOrNavigateEvent("Albums")),this.model.isOwner()?(t=ThisLife.Collection.moments.get(this.model.get("cover_moment_uid")),this.positionCoverImage(t.get("width"),t.get("height"))):this.positionCoverImage()
},getImageUrl:function(){return this.getCoverUrl()},albumTemplate:function(){var e,t,i,n,o,s,r,l,a,u;return r=this.model.isFriendsAlbum(),u=this.model.isAutoAlbum(),l=this.model.get("visible_moment_count")||0,l>999&&(l="999+"),n="background-image: url(/assets/1px.gif')",e=ThisLife.Helper.String.escapeHtml(this.model.get("name")),o=this.model.get("start_date")&&this.model.get("start_date")>1&&this.model.get("end_date")&&this.model.get("end_date")>1?this.getDateRange():"Empty",a=e!==o?"<span class='subtitle'>"+o+"</span>":"",t=r?"<span class='author'>By "+this.getAuthorName()+"</span>":"",i=!r&&u?"<span class='auto-album'>Auto-album</span>":"",s=this.model.get("permission.default")?"":'<div id="grid_edit_button" class="edit"><div>Actions</div></div>','<div class="framed_moment_media">\n  <div class="img" style="'+n+'"></div>\n</div>\n<div class="framed_moment_meta">\n  '+t+"\n  "+i+"\n  "+a+'\n  <span class="count">'+l+'</span>\n</div>\n<div class="stack_graphic"></div>\n'+s}})}),ThisLife.Albums.View.GridItem=require("ThisLife.Albums.View.GridItem")}.call(this),function(){ThisLife.Albums.View.Grid=Backbone.View.extend({className:"albums-grid-scroll",events:function(){return{"click .create-album":"newAlbum","click .upload-btn":"upload"}},initialize:function(e){return this.options=null!=e?e:{},this.viewEl=$("#album-view"),this.viewEl.append(this.el),this.views={},this.type=this.options.type,this.activeModel=this.options.activeModel,this.listenTo(this.model,"remove",this.removedAlbum),this.listenTo(this.model,"add",this.addedAlbum),this.listenTo(this.model,"change:name",this.modifiedAlbum),this.listenTo(this.model,"change:visible_moment_count",this.modifiedAlbum),this.listenTo(this.model,"sort",this.modifiedSort),this.actionsBar=new ThisLife.Albums.View.AlbumsActionBar({model:this.model,parentView:this,empty:this.model.models.length?!1:!0,type:this.type,activeFolder:this.activeModel}),this.viewEl.append(this.actionsBar.el)},setInitialScroll:function(e){return this.options.parent.initialScroll=e},getInitialScroll:function(){return this.options.parent.initialScroll||0},scrollToTop:function(){return this.el.scrollTop=0},toggleScroll:function(e){return e?this.$el.removeClass("albums-grid-no-scroll"):this.$el.addClass("albums-grid-no-scroll")},renderAlbum:function(e){var t;return t=new ThisLife.Albums.View.GridItem({model:e,parent:this}),this.views[e.get("uid")]=t,this.actionsBar.search.length&&this.actionsBar.searchAlbums(),t.render().el},setNameEdit:function(e){return this.nameEditItem=e},clearNameEdit:function(){return this.nameEditItem=null},isNameEditValid:function(){return this.nameEditItem?this.nameEditItem.forceBlurName():!0},renderEmptyState:function(){return this.removeEmptyState(),"all"===this.type||"owner"===this.type?this.myEmptyTemplate():"folder"===this.type?this.folderEmptyTemplate():ThisLife.app.router.navigateToAlbums("auto"===this.type?{trigger:!0,replace:!0}:{trigger:!0,replace:!0})},render:function(){return this.$el.empty(),this.actionsBar.render(),"auto"===this.options.type&&this.model.models.length&&ThisLife.appModel.getFirstTimeAlbumGuide()&&this.renderSuggestedGuide(),this.gridEl=$("<div class='albums-grid'></div>")[0],this.$el.append(this.gridEl),this.renderAlbums(),_.defer(function(e){return function(){return e.el.scrollTop=e.getInitialScroll(),e.setInitialScroll(0)}}(this)),this.toggleScroll($("#bucket-wrapper").hasClass("hidden")?!0:!1)},renderAlbums:function(){var e,t,i,n;if($(this.gridEl).empty(),("all"===this.options.type||"folder"===this.options.type)&&this.model.models.length>0&&$(this.gridEl).append(this.createAlbumTemplate),this.model.models.length)for(this.$el.removeClass("empty"),n=this.model.models,e=0,t=n.length;t>e;e++)i=n[e],$(this.gridEl).append(this.renderAlbum(i));else this.$el.addClass("empty"),this.$el.append(this.renderEmptyState());return setTimeout(function(e){return function(){return e.lazyImageLoader=new ThisLife.Support.LazyImageLoader(e.el,_.toArray(e.views)),e.lazyImageLoader.setup()}}(this),0)},renderSuggestedGuide:function(){return this.suggestedGuideView?void 0:(this.suggestedGuideView=new ThisLife.Albums.View.SuggestedGuide,this.$el.append(this.suggestedGuideView.render().el))},teardown:function(){var e,t;return this.views&&_.each(this.views,function(e){return e.teardown()}),this.views={},this.actionsBar.remove(),null!=(e=this.suggestedGuideView)&&e.remove(),null!=(t=this.lazyImageLoader)&&t.destroy(),this.remove()},newAlbum:function(){var e;return this.isNameEditValid()?("folder"===this.type&&(e=this.activeModel),ThisLife.Albums.View.currentPopover=new ThisLife.Albums.View.AddAlbumPopover({model:e,navigateToAlbum:!0})):void 0},upload:function(){return ThisLife.app.router.navigateToAdd()},removedAlbum:function(e,t){var i;return i=e.get("uid"),$("div.framed_moment[data-uid='"+i+"']").remove(),this.views[e.get("uid")].teardown(),delete this.views[e.get("uid")],t.length?this.lazyImageLoader.updateViews(_.toArray(this.views)):($(this.gridEl).empty(),this.$el.addClass("empty"),this.$el.append(this.renderEmptyState()),this.actionsBar.hideOptions(),this.delegateEvents()),this.actionsBar.search.length?(this.actionsBar.searchCount--,this.actionsBar.updateSearchNoneFound(),_.delay(function(e){return function(){return e.actionsBar.updateSearchBreadcrumb()}}(this))):void 0},modifiedAlbum:function(){return this.model.sort(),this.renderAlbums()},modifiedSort:function(){return this.renderAlbums(),this.hideLoading()},addedAlbum:function(e,t){var i,n;return 1===t.length&&(this.actionsBar.showOptions(),this.removeEmptyState()),i=t.indexOf(e),0===i?$(this.gridEl).prepend(this.renderAlbum(e)):(n=$("div.framed_moment[data-uid="+t.at(i-1).get("uid")+" ]"),$(this.renderAlbum(e)).insertAfter(n)),this.lazyImageLoader.updateViews(_.toArray(this.views))},removeEmptyState:function(){return $(this.el.querySelector(".empty-grid")).remove()},updateBreadcrumbs:function(e){return this.actionsBar.updateBreadcrumbs(e)},showLoading:function(){return this.loadingEl||(this.loadingEl=$(this.loadingTemplate()),this.loadingEl.appendTo(this.el)),this.loadingEl.show()},hideLoading:function(){var e;return null!=(e=this.loadingEl)?e.hide():void 0},myEmptyTemplate:function(){var e,t,i;return i=new ThisLife.Albums.View.AlbumCreate,t=new ThisLife.Albums.View.NoAlbums,e=document.createElement("div"),e.className="empty-grid owner",e.appendChild(i.el),e.appendChild(t.el),e},folderEmptyTemplate:function(){var e,t,i,n;return i="folder"===this.type?this.activeModel:this.model,n=new ThisLife.Albums.View.AlbumCreate({model:i}),t=new ThisLife.Albums.View.NoAlbums,e=document.createElement("div"),e.className="empty-grid owner",e.appendChild(n.el),e.appendChild(t.el),e},loadingTemplate:function(){return'<div class="loading"><div class="throbber throbber_large"><div class="throbber_overlay"></div></div></div>"'},createAlbumTemplate:function(){return'<div class="framed_moment create-album stack story_element empty">\n  <div class="framed_moment_media">\n    <div class="create-wrapper">\n      <div class="plus_icon"></div>\n      <p>Create Album</p>\n    </div>\n  </div>\n  <div class="stack_graphic"></div>\n</div>'}})}.call(this),function(){ThisLife.Albums.View.SuggestedGuide=Backbone.View.extend({className:"suggested_guide albums_guide",events:{"click .close":"hide"},initialize:function(){return this},remove:function(){return this.$el.remove(),this},render:function(){return this.el.insertAdjacentHTML("beforeend",this.template()),this},hide:function(){return ThisLife.appModel.setFirstTimeAlbumGuide(),this.remove()},template:function(){var e;return e=ThisLife.Settings.sflyApp+"/upload-pictures/start.sfly",'<h1>New Auto Album has arrived for you!</h1>\n<ul class="clearfix">\n  <li>\n    <p class="auto-upload">\n      <span>Upload all the photos you take. We select the best ones for you!</span><br/>\n      <a href="'+e+'" target="_blank">Set up Auto-upload</a>\n    </p>\n  </li>\n  <li>\n    <p class="arrange"><span>We arrange them into a beautiful layout for you.</span></p>\n  </li>\n  <li>\n    <p class="share"><span>Share your adventures with friends and family.</span></p>\n    <p class="create"><span>Quickly create fantastic keepsafe and gifts.</span></p>\n  </li>\n</ul>\n<div class="close">Got it!</div>'}})}.call(this),function(){ThisLife.Albums.View.AlbumCreate=Backbone.View.extend({className:"album-create",events:{"click .done-btn":"confirmButton","keypress input":"keyPress","click #change-folder":"displayChangeFolder","click #cancel":"hideChangeFolder","click #folder-new":"displayNewFolder","click .dropdown-top":"toggleFoldersList","click .folders-dropdown > li":"selectFolder","click .error-text-icon":"dismissError","click input":"dismissError"},initialize:function(e){return this.options=null!=e?e:{},this.model=this.options.model,this.parent=this.options.parent,this.foldersList=ThisLife.Model.Albums.Master.getFolderCollection(),this.defaultFolder=ThisLife.Model.Albums.Master.getDefaultFolder(),this.folder_uid||(this.folder_uid=this.original_uid=this.model?this.model.get(this.model.get("folder_uid")?"folder_uid":"uid"):this.defaultFolder.get("uid")),this.model?this.listenTo(this.model,"change:name",this.renamedFolder):this.listenTo(this.foldersList.models[0],"change:name",this.renamedFolder),this.render()},render:function(){return this.$el.html(this.template()),ThisLife.Helper.Platform.windows()&&this.$el.addClass("windows"),_.defer(function(e){return function(){return e.$el.find("input#album-name").focus(),e.$el.find("input#album-name").select()}}(this))},teardown:function(){return"modal"===this.options.mode?this.remove():ThisLife.Albums.View.currentPopover?ThisLife.Albums.View.currentPopover.remove():void 0},isAlbumError:function(e){return"DUPLICATE_ALBUM_NAME"===e||"CREATE_ALBUM_REQUIRES_FOLDER"===e?!0:!1},keyPress:function(e){return ThisLife.Helper.Keyboard.isEnter(e.keyCode)?this.confirmButton(e):void 0},confirmButton:function(){var e,t,i,n,o,s,r,l,a,u,c;if(this.clearErrors(),i=this.$el.find("#album-name").val().trim(),t=this.validateName(i,!1),t&&this.showError(this.el.querySelector(".album-name-input"),t),this.folder_uid||(s=this.$el.find("#folder-name").val().trim(),o=this.validateName(s,!0),o&&this.showError(this.el.querySelector(".new-folder"),o)),!t&&!o)try{return a={},this.folder_uid?a.folder_uid=this.folder_uid:a.folder_name=s,this.processing=!0,e=this,this.options.autoAdd?(this.options.recentUploads||(c=this.options.copyMoment?"Copying to album ...":this.options.moveMoment?"Moving to album ...":this.options.copyMoment||this.options.recentUploads?null:"Adding to album ...",r=this.options.autoAdd.hasOwnProperty("models")?_.pluck(this.options.autoAdd.models,"id"):_.pluck(this.options.autoAdd,"id"),this.displaySpinner(c)),l=function(e){return function(t){var i,n,o,s;return e.options.moveMoment?(i="albums"===ThisLife.app.currentState.name?ThisLife.app.album.getCurrentAlbum():null,o=null!=i?i.get("uid"):void 0,ThisLife.Service.api.moveAlbumMoments(o,t,r,function(){var i;return null!=(i=e.spinnerView)&&i.teardown(),e.navigateToNewAlbum(t,r)})):e.options.recentUploads?("modal"===e.options.mode?e.parent.teardown():e.teardown(),ThisLife.app.controller("selection").getActions()._addRecentUploadsToStory(t,e.options.autoAdd,!0)):(n=ThisLife.app.album.getCurrentAlbum(),n&&n.isFriendsAlbum()?(s=ThisLife.app.controller("albums").getCurrentAlbum().id,e.copyFromSharedAlbum=!0,ThisLife.Service.api.copySharedMoments(s,t,r,function(){var i;return ThisLife.app.controller("selection").done(),null!=(i=e.spinnerView)&&i.teardown(),e.navigateToNewAlbum(t,r)})):ThisLife.Service.api.saveStoryMoments(t,r,function(){var i;return ThisLife.app.controller("selection").done(),null!=(i=e.spinnerView)&&i.teardown(),e.navigateToNewAlbum(t,r)}))}}(this)):(this.displaySpinner(),l=function(){var t;return null!=(t=e.spinnerView)&&t.teardown(),"modal"===e.options.mode?e.parent.teardown():e.teardown()}),ThisLife.Model.Albums.Master.createAlbum(i,a,l)}catch(d){return n=d,this.processing=!1,null!=(u=this.spinnerView)&&u.teardown(),this.isAlbumError(n)?this.showError(this.el.querySelector(".modal_information"),n):this.showError(this.el.querySelector(".new-folder"),n)}},renamedFolder:function(e){var t;return t=e.get("name"),$(this.el.querySelector(".choide-folder-name")).text(t),$(this.el.querySelector(".dropdown-top")).html("<span>"+ThisLife.Helper.String.escapeHtml(t)+"</span>"),$(this.el.querySelector(".dropdown-top")).removeClass("default-folder"),this.foldersList=ThisLife.Model.Albums.Master.getFolderCollection(),this.defaultFolder=ThisLife.Model.Albums.Master.getDefaultFolder(),$(this.el.querySelector(".folders-dropdown")).html(this._getFoldersList())},navigateToNewAlbum:function(e,t){var i,n,o,s,r,l,a,u,c,d;if(i=ThisLife.Model.Albums.Master.getAlbumById(e),i.addPendingUploads(t),u=[],this.copyFromSharedAlbum)for(r=0,a=t.length;a>r;r++)s=t[r],u.push(ThisLife.app.controller("albums").getMoment(s));else for(o=0,l=t.length;l>o;o++)s=t[o],u.push(ThisLife.Collection.moments.get(s));return c=ThisLife.Helper.String.pluralizePhotosVideos(u),ThisLife.app.controller("albums").removeMoments(e,t),ThisLife.app.controller("selection").done(),d=this.options.copyMoment?"COPIED":this.options.moveMoment?"MOVED":"ADDED TO ALBUM",n=t.length+" "+c.toUpperCase()+" "+d,this.copyFromSharedAlbum?this.parent.confirmDoneNewToast(n,!1):this.parent.confirmDoneNewToast(n,this.options.partialEdit),ThisLife.app.controller("visual_search").searchResultsHidden()?this.options.navigateToAlbum?(ThisLife.app.router.navigateToAlbum(e),ThisLife.app.controller("selection").done()):void 0:!1},displayChangeFolder:function(e){return e.stopPropagation(),$(this.el.parentElement).addClass("withLocation"),$(this.el.querySelector(".prompt")).addClass("hide"),$(this.el.querySelector(".folder-choices")).removeClass("hide"),!1},hideChangeFolder:function(e){return this.folder_uid=this.original_uid,e.stopPropagation(),$(this.el.querySelector(".prompt")).removeClass("hide"),$(this.el.querySelector(".folder-choices")).addClass("hide"),$(this.el.parentElement).removeClass("withLocation"),this.hideNewFolder(),this.selectFolder(null,$(this.el).find("[data-uid="+this.folder_uid+"]")[0]),!1},toggleFoldersList:function(e){var t,i;return e.stopPropagation(),t=this.$el.find(".folder-list").toggleClass("expanded").removeClass("reverse-popover"),t.hasClass("expanded")&&(i=t.find(".folders-pullout"),i.height()+i.offset().top>$(window).height()&&t.addClass("reverse-popover")),this.dismissError(null,$(".new-folder"))},updateFoldersList:function(e,t,i,n){return null==n&&(n=!1),this.folder_uid=t,this.$el.find(".dropdown-top span").text(e),$(this.el.querySelector(".dropdown-top")).toggleClass("default-folder",n),this.$el.find(".folder-list").removeClass("expanded"),this.$el.find(".folder-list .selected").removeClass("selected"),this.$el.find(i).addClass("selected")},displayNewFolder:function(e){return e.stopImmediatePropagation(),this.$el.find(".new-folder").removeClass("hide"),this.updateFoldersList($(e.target).text(),null,e.target),this.dismissError(null,$(".modal_information")),this.$el.find("input#folder-name").focus(),!1},hideNewFolder:function(){return this.$el.find(".new-folder").addClass("hide"),$(this.el.querySelector("#folder-name")).val("")},selectFolder:function(e,t){var i,n;return e&&(e.stopPropagation(),this.dismissError(null,$(".modal_information")),t=t||e.currentTarget),n=this.$el.find(t).children("span"),i=$(n).hasClass("default-folder"),this.hideNewFolder(),this.updateFoldersList($(n).text(),$(t).attr("data-uid"),t,i),$(this.el).find(".done-btn").focus()},validateName:function(e,t){return e?e.length>ThisLife.Model.Albums.Master.maxAlbumTitleLength?t?"LONG_FOLDER":"LONG_ALBUM":null:t?"BLANK_FOLDER":"BLANK_ALBUM"},spinnerTemplate:function(){return"<div class='modal-spinner'></div>"},displaySpinner:function(e){return null==e&&(e=null),"modal"===this.options.mode?(this.spinnerView=new ThisLife.View.SpinnerModal({progressText:e}),document.body.appendChild(this.spinnerView.el)):ThisLife.Albums.View.currentPopover=new ThisLife.Albums.View.Spinner},clearErrors:function(){var e;return e=this.$el.find(".albums_popover_wrap .error"),e?e.removeClass("error"):void 0},showError:function(e,t){var i;return i=this.getErrorText(t),this.$el.find(e).addClass("error"),this.$el.find(e).find(".warning-tooltip").text(i),!1},dismissError:function(e,t){var i;return i=e?this.$el.find(e.target).parents(".error"):t,i.length&&this.$el.find(i).hasClass("error")?(this.$el.find(i).removeClass("error"),this.$el.find(this.el).hide().show(0),this.$el.find(i).find("input").focus()):void 0},getErrorText:function(e){var t;return t=this.errors[e],t||(t=this.errors.GENERIC),t},errors:{DUPLICATE_FOLDER_NAME:"This name already exists.  Please try again.",CANNOT_DELETE_SYSTEM_FOLDER:"You cannot delete this folder.",CANNOT_DELETE_MY_ALBUM:"You cannot delete this album.",DUPLICATE_ALBUM_NAME:"This name already exists.  Please try again.",BLANK_FOLDER:"Folder name cannot be blank!",BLANK_ALBUM:"Album name cannot be blank!",LONG_FOLDER:"Folder name is too long.",LONG_ALBUM:"Album name is too long.",GENERIC:"Something went wrong.  Please try again."},_getFoldersList:function(){var e,t,i,n,o;for(i=this.listItemTemplate(this.defaultFolder),o=this.foldersList.models,e=0,t=o.length;t>e;e++)n=o[e],n.get("default")||(i+=this.listItemTemplate(n));return i},listItemTemplate:function(e){var t,i;return i=e.get("uid")===this.folder_uid?"selected":"",t=e.get("default")?"default-folder":"","<li data-uid='"+e.get("uid")+"' class='"+i+"'><span class='"+t+"'>"+ThisLife.Helper.String.escapeHtml(e.get("name"))+"</span></li>"},template:function(){var e,t,i,n,o;return n=ThisLife.Model.Albums.Master.maxAlbumTitleLength,o=ThisLife.Model.Albums.Master.maxFolderTitleLength,e="default-folder",this.model?(t=ThisLife.Helper.String.escapeHtml(this.model.get("name")),this.model.get("default")||(e="")):t=ThisLife.Helper.String.escapeHtml(this.defaultFolder.get("name")),i="<ul class='folders-dropdown'>"+this._getFoldersList()+"</ul>",'<div class="body">\n  <h4>Create an album</h4>\n  <div class="modal_information">\n    <div class=\'album-name-input\'>\n      <input id = \'album-name\' type="text" placeholder="Enter a name for your album" maxlength="'+n+'"/>\n      <div class="error-text-icon">\n        <img src="/assets/1px.gif">\n        <div class="warning-tooltip"></div>\n      </div>\n    </div>\n\n    <div class=\'change-folder\'>\n      <div class=\'prompt\'>\n        This album will be located in <span class=\'choide-folder-name\'>"'+t+"\"</span> (<a href='' id='change-folder'>Change</a>)\n      </div>\n\n      <div class='folder-choices hide'>\n        Change folder location <span id='cancel'><a href=''>Cancel</a></span>\n        <div class='folder-list'>\n          <div class='dropdown-top "+e+"'><span>"+t+"</span></div>\n          <div class='folders-pullout'>\n            "+i+"\n            <div id='folder-new'><span>Create New Folder</span></div>\n          </div>\n        </div>\n\n        <div class='new-folder hide'>\n          <input id = 'folder-name' type=\"text\" placeholder=\"Folder name\" maxlength=\""+o+'"/>\n          <div class="error-text-icon">\n            <img src="/assets/1px.gif">\n            <div class="warning-tooltip"></div>\n          </div>\n        </div>\n      </div>\n    </div>\n  </div>\n\n  <div class="action_btn_wrap clearfix">\n    <a class="orange-btn done-btn">Create</a>\n  </div>\n</div>'}})}.call(this),function(){ThisLife.Albums.View.NoAlbums=Backbone.View.extend({className:"no-albums",initialize:function(e){return this.options=null!=e?e:{},this.render(),this},render:function(){return this.$el.html(this._getTemplate())},teardown:function(){return this.remove()},_getTemplate:function(){return'<div class="content-wrap">\n  <div class="message">You don\'t have any albums yet.</div>\n</div>'}})}.call(this),function(){ThisLife.Albums.View.InlineEditField=Backbone.View.extend({className:"name_wrap",events:{click:"focusName","keydown .name":"onNameKeypress","click .error-text-icon.rename-error":"hideNameError"},initialize:function(e){return this.options=e,this.grandparent=this.options.parentView,this.parent=this.options.parent,this.model=this.options.model,this.maxLength=this.options.maxLength,this.bindEvents(),this.render(),this.cacheElements()},bindEvents:function(){var e;return ThisLife.PubSub.on("state:changeFrom:albums",this.cancelNameChange,this),null!=(e=this.model)?e.on("change:name",this.changeName,this):void 0},unbindEvents:function(){var e;return ThisLife.PubSub.off("state:changeFrom:albums",this.cancelNameChange,this),null!=(e=this.model)?e.off(null,null,this):void 0},remove:function(){return this.unbindEvents(),Backbone.View.prototype.remove.apply(this)},render:function(){var e,t;return this.el.insertAdjacentHTML("afterbegin",this.template()),this._updateNameToolTip(name),e=(null!=(t=this.model)&&"function"==typeof t.isFriendsAlbum?t.isFriendsAlbum():void 0)||!1,this.setEditable(e?!1:!0),this},cacheElements:function(){return this.nameEl=this.el.querySelector(".name"),this.nameErrorEl=this.el.querySelector(".error-text-icon.rename-error"),this},getName:function(){return this.nameEl.value},changeName:function(){var e,t;return e=ThisLife.Helper.String.escapeHtml(this.model.get("name")),null!=(t=this.nameEl)&&(t.value=e),this._updateNameToolTip(e)},setName:function(e){return this.nameEl.value=ThisLife.Helper.String.escapeHtml(e),this._updateNameToolTip(e)},_updateNameToolTip:function(e){return $(this.nameEl).attr("title",ThisLife.Helper.String.escapeHtml(e))},setEditable:function(e,t){return e?($(this.el).addClass("editable"),(null!=t?t.className:void 0)&&$(this.el).addClass(t.className),$(this.nameEl).removeProp("disabled","")):($(this.el).removeClass("editable"),(null!=t?t.className:void 0)&&$(this.el).removeClass(t.className),$(this.nameEl).prop("disabled","true"))},focusAllowed:function(){return this.hasFocus?"number"==typeof this.nameEl.selectionStart?!(0===this.nameEl.selectionStart&&this.nameEl.selectionEnd>0):"undefined"!=typeof document.selection?!document.selection.createRange().text.length>0:void 0:!0},focusName:function(e){var t,i,n,o,s;return t=this.grandparent&&!this.hasFocus?this.grandparent.isNameEditValid():!0,this.$el.hasClass("editable")&&(this.nameErrorState||t)&&this.focusAllowed()?(null!=(n=this.parent)?n.focusName:void 0)&&(i=null!=(o=this.parent)&&"function"==typeof o.focusName?o.focusName():void 0,!i)?!1:(this.hasFocus=!0,null!=(s=this.grandparent)&&s.setNameEdit(this),this.el.classList.contains("focus")||this.nameEl.select(),$(this.nameEl).prop("readonly",""),this._updateNameToolTip(""),$(this.nameEl).blur(),$(this.nameEl).focus(),$(this.el).addClass("focus"),this.originalName=this.model.get("name"),$(e.target).hasClass("name_wrap")&&$(this.nameEl).focus(),this.blurEventCallback=ThisLife.blurEvent($(this.nameEl),function(e){return function(){return e.blurName()}}(this))):!1},onNameKeypress:function(e){return ThisLife.Helper.Keyboard.isEnter(e.keyCode)?($(this.nameEl).blur(),this.blurName(),!1):(ThisLife.Helper.Keyboard.isTab(e.keyCode)&&e.preventDefault(),ThisLife.Helper.Keyboard.isEscape(e.keyCode)?(this.forceCancelNameChange(),!1):(this.nameErrorState&&(this.nameErrorState=!1,this.hideNameError()),!0))},blurName:function(){var e,t,i,n,o;if(this.blurEventCallback){if(ThisLife.removeBlurEvent(this.blurEventCallback),this.blurEventCallback=null,this.hasFocus=!1,$(this.nameEl).prop("readonly","readonly"),this._updateNameToolTip(this.model.get("name")),this.cancelEdit)return void this.cancelNameChange(!0);if(n=_.unescape(this.nameEl.value.trim().slice(0,this.maxLength)),!(n&&""!==n&&n!==this.originalName&&n.length<=this.maxLength))return this.cancelNameChange(!0);try{return this.model.rename(n),this.originalName=n,this.cancelEdit=!0,this.hideNameError(),this.cancelNameChange(!0),this._updateNameToolTip(n)}catch(s){return e=s,null!=(null!=(o=this.parent)?o.updateNameError:void 0)?this.parent.updateNameError():(i={DUPLICATE_FOLDER_NAME:"This name already exists.  Please try again.",DUPLICATE_ALBUM_NAME:"This name already exists."},t=i[e],this.showNameError(t))}}},showNameError:function(e){return null==e&&(e="Folder name cannot be blank!"),this.nameErrorState=!0,$(this.nameErrorEl).find(".input_error").text(e),$(this.nameErrorEl).show(),$(".album_list_view").addClass("name_error"),setTimeout(function(e){return function(){return $(e.nameEl).click(),$(e.nameEl).focus()}}(this),0)},hideNameError:function(e){return null!=e&&e.stopPropagation(),$(this.nameErrorEl).hide(),$(".album_list_view").removeClass("name_error"),this.originalName&&this.nameErrorState&&(this.nameEl.value=this.originalName),this.nameErrorState=!1,this.cancelEdit?void 0:this.nameEl.focus()},cancelNameChange:function(e){var t,i,n;if(null==e&&(e=!1),this.originalName&&(this.nameEl.value=this.originalName),this.nameErrorState&&this.hideNameError(),this.cancelEdit=!1,$(this.el).removeClass("focus"),null!=(i=this.grandparent)&&i.clearNameEdit(),null!=(n=this.parent)&&"function"==typeof n.blurName&&n.blurName(),e===!0)try{return ThisLife.Helper.DOM.resetInputPosition(this.nameEl)}catch(o){if(t=o,"Unspecified error."!==t.message)throw t}},forceCancelNameChange:function(){return this.cancelNameChange(!0)},forceBlurName:function(){return this.blurName(),!this.nameErrorState},template:function(){var e,t;return e=ThisLife.Helper.String.escapeHtml((null!=(t=this.model)?t.get("name"):void 0)||""),"<input type='text' maxlength=\""+this.maxLength+"\" class='name' value=\""+e+'" readonly="readonly" title="'+e+'" />\n<div class="error-text-icon rename-error"><img src="/assets/1px.gif"/>\n  <div class="disabled_tooltip_wrap">\n    <div class="disabled_tooltip_arrow"></div>\n    <div class="disabled_tooltip">\n      <div class="input_error">Album name can\'t be blank</div>\n    </div>\n  </div>\n</div>'}},define("ThisLife.Albums.View.InlineEditField",[],function(){return ThisLife.Albums.View.InlineEditField}))}.call(this),function(){var e;ThisLife.Albums.View.BasicList=Backbone.View.extend({className:"albums_list_wrap",initialize:function(e){return null==e&&(e={}),this._renderViewOnlyAlbums=!!e.renderViewOnlyAlbums||!1,this.currentAlbum=e.currentAlbum,this.render(),this._cacheElements(),this._albums={},ThisLife.Model.Albums.Master.whenLoaded(function(e){return function(){return e._onAlbumsLoaded()}}(this))},_onAlbumsLoaded:function(){return this._lastUsedAlbum=ThisLife.Model.Albums.Master.getLastUsedAlbum(),this._ownerFolders=ThisLife.Model.Albums.Master.getFolderCollection(),this._albums.auto=new ThisLife.Collection.AlbumsCollection(ThisLife.Model.Albums.Master.getAutoAlbums().models),this._albums.shared=new ThisLife.Collection.AlbumsCollection(ThisLife.Model.Albums.Master.getSharedAlbums().models),this._albums.lifetouch=new ThisLife.Collection.AlbumsCollection(ThisLife.Model.Albums.Master.getLifetouchAlbums().models),this._albums.auto.setSort("name:asc"),this._albums.shared.setSort("name:asc"),this._albums.lifetouch.setSort("name:asc"),this._renderData(),this._bindEvents()},render:function(){return this.el.insertAdjacentHTML("beforeend",e())},_cacheElements:function(){return this._lastUsedAlbumEl=this.el.querySelector(".album_section.last_used"),this._lastUsedAlbumListEl=this.el.querySelector(".last_used .album_list"),this._folderListEl=this.el.querySelector(".folder_list"),this._autoAlbumEl=this.el.querySelector(".auto_albums"),this._autoAlbumListEl=this.el.querySelector(".auto_albums .album_list"),this._shareAlbumEl=this.el.querySelector(".share_albums"),this._shareAlbumListEl=this.el.querySelector(".share_albums .album_list"),this._lifetouchAlbumEl=this.el.querySelector(".lifetouch_albums"),this._lifetouchAlbumListEl=this.el.querySelector(".lifetouch_albums .album_list")},_renderData:function(){var e,t,i,n,o,s,r,l,a,u,c,d,h,p,f,m,g,v,_,b,w,y,T,L;for(this._lastUsedAlbum&&(this._lastUsedAlbumView=new ThisLife.Albums.View.AlbumItem({model:this._lastUsedAlbum,currentAlbum:this.currentAlbum}),this._lastUsedAlbumListEl.appendChild(this._lastUsedAlbumView.el)),ThisLife.Helper.DOM.addRemoveClass(this._lastUsedAlbumEl,null===this._lastUsedAlbum,"hidden"),this._folderViews=[],this._folderViews.push(new ThisLife.Albums.View.FolderItem({model:ThisLife.Model.Albums.Master.getDefaultFolder(),renderContents:!0,currentAlbum:this.currentAlbum})),g=this._ownerFolders.models,n=0,l=g.length;l>n;n++)i=g[n],i.get("default")||this._folderViews.push(new ThisLife.Albums.View.FolderItem({model:i,renderContents:!0,currentAlbum:this.currentAlbum}));for(v=this._folderViews,o=0,a=v.length;a>o;o++)L=v[o],this._folderListEl.appendChild(L.el);for(t=this._albums.auto,this._autoAlbumViews=function(){var i,n,o,s;for(o=t.models,s=[],i=0,n=o.length;n>i;i++)e=o[i],s.push(new ThisLife.Albums.View.AlbumItem({model:e,currentAlbum:this.currentAlbum}));return s}.call(this),_=this._autoAlbumViews,s=0,u=_.length;u>s;s++)L=_[s],this._autoAlbumListEl.appendChild(L.el);for(ThisLife.Helper.DOM.addRemoveClass(this._autoAlbumEl,t.length<=0,"hidden"),T=this._albums.shared,this._shareAlbumViews=[],b=T.models,r=0,c=b.length;c>r;r++)e=b[r],(this._renderViewOnlyAlbums||!e.isViewOnly())&&this._shareAlbumViews.push(new ThisLife.Albums.View.AlbumItem({model:e,currentAlbum:this.currentAlbum}));for(w=this._shareAlbumViews,f=0,d=w.length;d>f;f++)L=w[f],this._shareAlbumListEl.appendChild(L.el);for(ThisLife.Helper.DOM.addRemoveClass(this._shareAlbumEl,this._shareAlbumViews.length<=0,"hidden"),p=this._albums.lifetouch,this._lifetouchAlbumViews=function(){var t,i,n,o;for(n=p.models,o=[],i=0,t=n.length;t>i;i++)e=n[i],o.push(new ThisLife.Albums.View.AlbumItem({model:e,currentAlbum:this.currentAlbum}));return o}.call(this),y=this._lifetouchAlbumViews,m=0,h=y.length;h>m;m++)L=y[m],this._lifetouchAlbumListEl.appendChild(L.el);return ThisLife.Helper.DOM.addRemoveClass(this._lifetouchAlbumEl,p.length<=0,"hidden")},_onAlbumSelected:function(e){return this.trigger("itemSelected",e)},_bindEvents:function(){var e,t,i,n,o,s,r,l,a,u,c,d,h;for(a=this._folderViews,e=0,o=a.length;o>e;e++)h=a[e],this._bindSubViewEvents(h);for(u=this._autoAlbumViews,t=0,s=u.length;s>t;t++)h=u[t],this._bindSubViewEvents(h);for(c=this._shareAlbumViews,i=0,r=c.length;r>i;i++)h=c[i],this._bindSubViewEvents(h);for(d=this._lifetouchAlbumViews,n=0,l=d.length;l>n;n++)h=d[n],this._bindSubViewEvents(h);this._lastUsedAlbumView&&this._bindSubViewEvents(this._lastUsedAlbumView)},_unbindEvents:function(){var e,t,i,n,o,s,r,l,a,u,c,d,h;for(a=this._folderViews,e=0,o=a.length;o>e;e++)h=a[e],this._unbindSubViewEvents(h);for(u=this._autoAlbumViews,t=0,s=u.length;s>t;t++)h=u[t],this._unbindSubViewEvents(h);for(c=this._shareAlbumViews,i=0,r=c.length;r>i;i++)h=c[i],this._unbindSubViewEvents(h);for(d=this._lifetouchAlbumViews,n=0,l=d.length;l>n;n++)h=d[n],this._unbindSubViewEvents(h);this._lastUsedAlbumView&&this._unbindSubViewEvents(this._lastUsedAlbumView)},_bindSubViewEvents:function(e){return e.on("itemSelected",this._onAlbumSelected,this)},_unbindSubViewEvents:function(e){return e.off(null,null,this)},unselectAll:function(){var e,t,i,n,o,s,r,l,a,u,c,d,h;for(a=this._folderViews,e=0,o=a.length;o>e;e++)h=a[e],h.unselectAll();for(u=this._autoAlbumViews,t=0,s=u.length;s>t;t++)h=u[t],h.unselect();for(c=this._shareAlbumViews,i=0,r=c.length;r>i;i++)h=c[i],h.unselect();for(d=this._lifetouchAlbumViews,n=0,l=d.length;l>n;n++)h=d[n],h.unselect();return this._lastUsedAlbumView?this._lastUsedAlbumView.unselect():void 0},findAndSelect:function(e){var t,i,n,o,s,r,l,a,u,c,d,h,p;for(u=this._folderViews,t=0,s=u.length;s>t;t++)if(p=u[t],p.findAndSelect(e))return!0;for(c=this._autoAlbumViews,i=0,r=c.length;r>i;i++)if(p=c[i],p.model.id===e.id)return p.select(),!0;for(d=this._shareAlbumViews,n=0,l=d.length;l>n;n++)if(p=d[n],p.model.id===e.id)return p.select(),!0;for(h=this._lifetouchAlbumViews,o=0,a=h.length;a>o;o++)if(p=h[o],p.model.id===e.id)return p.select(),!0;return!1},teardown:function(){var e,t,i,n,o,s,r,l,a,u,c,d,h;for(this._unbindEvents(),a=this._folderViews,e=0,o=a.length;o>e;e++)h=a[e],h.teardown();for(u=this._autoAlbumViews,t=0,s=u.length;s>t;t++)h=u[t],h.teardown();for(c=this._shareAlbumViews,i=0,r=c.length;r>i;i++)h=c[i],h.teardown();for(d=this._lifetouchAlbumViews,n=0,l=d.length;l>n;n++)h=d[n],h.teardown();return this._lastUsedAlbumView&&this._lastUsedAlbumView.teardown(),this.remove()}}),e=function(){return'<div class="album_section last_used">\n  <div class="name">Last Used</div>\n  <ul class="album_list"></ul>\n</div>\n<div class="album_section my_folders">\n  <div class="name">My Folders</div>\n  <ul class="folder_list"></ul>\n</div>\n<div class="album_section auto_albums">\n  <div class="name">Auto-Albums</div>\n  <ul class="album_list"></ul>\n</div>\n<div class="album_section share_albums">\n  <div class="name">Shared with me</div>\n  <ul class="album_list"></ul>\n</div>\n <div class="album_section lifetouch_albums">\n  <div class="name">Lifetouch</div>\n  <ul class="album_list"></ul>\n</div>'
}}.call(this),function(){var e;ThisLife.Albums.View.AlbumItem=Backbone.View.extend({className:"album_item selectable",tagName:"li",events:{click:"select"},_isSelected:!1,initialize:function(e){return this.model=e.model,this.currentAlbum=e.currentAlbum,this.render()},render:function(){return this.el.insertAdjacentHTML("beforeend",e(this.model)),this.currentAlbum&&this.currentAlbum===this.model.id?$(this.el.querySelector(".title_wrap")).parent().addClass("current_album"):void 0},teardown:function(){return this.remove()},select:function(){return this.trigger("itemSelected",this.model),this._isSelected=!0,this.el.classList.add("selected")},unselect:function(){return this._isSelected=!1,this.el.classList.remove("selected")}}),e=function(e){var t;return t=ThisLife.Helper.String.escapeHtml(e.get("name")),'<div class="title_wrap">\n  <span class="check"></span>\n  <span class="icon"></span>\n  <span class="name">'+t+'</span>\n  <span class="clearfix"></span>\n</div>'}}.call(this),function(){var e;ThisLife.Albums.View.BasicFolderList=Backbone.View.extend({className:"folder_list_wrap",initialize:function(){return this.render(),this._cacheElements(),ThisLife.Model.Albums.Master.whenLoaded(function(e){return function(){return e._onAlbumsLoaded()}}(this))},_onAlbumsLoaded:function(){return this._ownerFolders=ThisLife.Model.Albums.Master.getFolderCollection(),this._ownerFolders.setSort("name"),this._renderData(),this._bindEvents()},render:function(){return this.el.insertAdjacentHTML("beforeend",e())},_cacheElements:function(){return this._folderListEl=this.el.querySelector(".folder_list")},_renderData:function(){var e,t,i,n,o,s,r,l,a;for(this._folderViews=[],this._folderViews.push(new ThisLife.Albums.View.FolderItem({model:ThisLife.Model.Albums.Master.getDefaultFolder(),renderContents:!0,currentAlbum:this.currentAlbum})),s=this._ownerFolders.models,t=0,n=s.length;n>t;t++)e=s[t],e.get("default")||this._folderViews.push(new ThisLife.Albums.View.FolderItem({model:e,isSelectable:!0,renderContents:!1}));for(r=this._folderViews,l=[],i=0,o=r.length;o>i;i++)a=r[i],l.push(this._folderListEl.appendChild(a.el));return l},_onFolderSelected:function(e){return this.trigger("itemSelected",e)},_bindEvents:function(){var e,t,i,n;for(i=this._folderViews,e=0,t=i.length;t>e;e++)n=i[e],n.on("itemSelected",this._onFolderSelected,this)},_unbindEvents:function(){var e,t,i,n;for(i=this._folderViews,e=0,t=i.length;t>e;e++)n=i[e],n.off(null,null,this)},unselectAll:function(){var e,t,i,n;for(i=this._folderViews,e=0,t=i.length;t>e;e++)n=i[e],n.unselect()},findAndSelect:function(e){var t,i,n,o;for(n=this._folderViews,t=0,i=n.length;i>t;t++)if(o=n[t],o.findAndSelect(e))return!0;return!1},teardown:function(){var e,t,i,n;for(this._unbindEvents(),i=this._folderViews,e=0,t=i.length;t>e;e++)n=i[e],n.teardown();return this.remove()}}),e=function(){return'<ul class="folder_list"></ul>'}}.call(this),function(){var e;ThisLife.Albums.View.FolderItem=Backbone.View.extend({className:"folder_item",tagName:"li",events:{"click .title_wrap":"select"},_isSelected:!1,initialize:function(e){return this.model=e.model,this._isSelectable=!!e.isSelectable||!1,this._renderContents=!!e.renderContents||!1,this.currentAlbum=e.currentAlbum,this.render(),this._cacheElements(),this._renderContents&&this._renderAlbums(),this._bindEvents()},render:function(){return this.el.insertAdjacentHTML("beforeend",e(this.model)),this._isSelectable?this.el.classList.add("selectable"):void 0},_cacheElements:function(){return this._albumListEl=this.el.querySelector(".album_list")},_renderAlbums:function(){var e,t,i,n,o,s;for(t=new ThisLife.Collection.AlbumsCollection(ThisLife.Model.Albums.Master.getAlbumsByFolderId(this.model.get("uid")).models),t.setSort("name:asc"),this._albumViews=function(){var i,n,o,s;for(o=t.models,s=[],i=0,n=o.length;n>i;i++)e=o[i],s.push(new ThisLife.Albums.View.AlbumItem({model:e,currentAlbum:this.currentAlbum}));return s}.call(this),o=this._albumViews,i=0,n=o.length;n>i;i++)s=o[i],this._albumListEl.appendChild(s.el)},_bindEvents:function(){var e,t,i,n;if(this._renderContents)for(i=this._albumViews,e=0,t=i.length;t>e;e++)n=i[e],n.on("itemSelected",this._onAlbumSelected,this)},_unbindEvents:function(){var e,t,i,n;if(this._renderContents)for(i=this._albumViews,e=0,t=i.length;t>e;e++)n=i[e],n.off("itemSelected",this._onAlbumSelected)},_onAlbumSelected:function(e){return this.trigger("itemSelected",e)},unselectAll:function(){var e,t,i,n;if(this._renderContents)for(i=this._albumViews,e=0,t=i.length;t>e;e++)n=i[e],n.unselect();return this.unselect()},select:function(){return this._isSelectable?(this.trigger("itemSelected",this.model),this._isSelected=!0,this.el.classList.add("selected")):void 0},findAndSelect:function(e){var t,i,n,o;if(e.id===this.model.id)return this.select(),!0;if(this._renderContents)for(n=this._albumViews,t=0,i=n.length;i>t;t++)if(o=n[t],o.model.id===e.id)return o.select(),!0;return!1},unselect:function(){return this._isSelected=!1,this.el.classList.remove("selected")},teardown:function(){var e,t,i,n;for(this._unbindEvents(),i=this._albumViews,e=0,t=i.length;t>e;e++)n=i[e],n.teardown();return this.remove()}}),e=function(e){var t;return t=ThisLife.Helper.String.escapeHtml(e.get("name")),'<div class="title_wrap">\n  <span class="check"></span>\n  <span class="icon"></span>\n  <span class="name">'+t+'</span>\n</div>\n<ul class="album_list"></ul>'}}.call(this),function(){var e,t,i,n,o,s,r,l={}.hasOwnProperty;e="Invalid email address",t="Already in the list of invitees",i="Cannot share with yourself",ThisLife.View.Album.SharePopup=Backbone.View.extend({className:"popover_view_share_story",events:{"click .js_close_popup":"confirmDone","click .done_btn":"confirmDone","focus .person_row.new input":"clickInput","click .help_btn":"clickHelpButton","click .person_row.new .warning_icon":"clearPersonInput","click .menu_item":"clickMenuItem","keyup .custom_msg_input":"characterLimit","focus .custom_msg_input":"characterLimit","blur .custom_msg_input":"hideCharacterLimit","click #post_to_facebook":"postToFacebook","click .address_book_link":"showAddressBook"},_subviews:{},initialize:function(e){return this.options=null!=e?e:{},this.pubSub=_.extend({},Backbone.Events),this.model=ThisLife.currentStory,this.inviteQueue=[],this.lockHelpTooltip=!1,this.render(),this.cacheElements(),this.renderShorthand(),this.positionCoverImage(),new ThisLife.View.Album.SharePopupLink({album:this.model,parentContainer:this.linkContainer}),this.bindEvents(),this.focusCursor(),this},bindEvents:function(){return this.model.followers.on("add",this.updateShareModal,this).on("remove",this.removeFollowerRow,this),this.lockScrollDebounce=_.debounce(_.bind(this.setLockedScroll,this),1),this.pubSub.on("removeQueuedInvite",this.removeQueueItem,this).on("lockScroll",this.lockScrollDebounce,this).on("openedPopup",this.lockScroll,this).on("closedPopup",this.unlockScroll,this).on("validateEmail",this.validateEmail,this).on("emailAdded",this.addEmailInvitee,this),ThisLife.PubSub.on("albumAction:share",this.sendInviteQueue,this),ThisLife.PubSub.on("people:updateOrAdd",this.reRenderShorthand,this),ThisLife.Support.keyInformant.on("cancel",this.confirmDone,this,!0),this.model.on("change:cover_moment_uid",this.changeCover,this)},unbindEvents:function(){return this.model.followers.off(null,null,this),ThisLife.Support.keyInformant.off("cancel",this.confirmDone,this),ThisLife.PubSub.off("albumAction:share",this.sendInviteQueue,this),ThisLife.PubSub.off("people:updateOrAdd",this.renderShorthand,this),this.model.off("change:cover_moment_uid",this.changeCover,this)},render:function(){var e,t,i,o;for(this.coverUrl=this.model.getCoverUrl("small"),this.storyName=this.model.get("name").substring(0,150),this.momentCount=this.model.get("visible_moment_count")||0,this.el.insertAdjacentHTML("beforeend",this.template()),this.inviteWrap=this.el.querySelector(".invitees_wrap"),o=this.model.followers.nonDuplicatedFollowers(),e=0,t=o.length;t>e;e++)i=o[e],this.addFollowerRow(i,!1);return this.inviteWrap.insertAdjacentHTML("beforeend",s()),this.inviteWrap.insertAdjacentHTML("beforeend",n({coverUrl:this.coverUrl,storyName:this.storyName,momentCount:this.momentCount}))},cacheElements:function(){return this.smallAlbumImgEl=this.el.querySelector(".small .framed_moment_media .img"),this.followersEl=this.el.getElementsByClassName("js_followers")[0],this.inviteesWrapEl=this.el.querySelector(".invitees_wrap"),this.customMsgEl=this.el.querySelector(".custom_msg_input"),this.customMsgLmtEl=this.el.querySelector(".character_limit"),this.peopleDropdownEl=this.el.querySelector(".people_dropdown"),this.newPersonRowEl=this.el.querySelector(".person_row.new"),this.inviteInputEl=this.newPersonRowEl.querySelector("input"),this.helpButtonWrapEl=this.el.querySelector(".help_btn_tooltip_wrap"),this.textarea=this.el.querySelector(".custom_msg_input"),this.messageText=this.el.querySelector(".message_text"),this.personRowHolder=this.el.querySelector(".person_row_holder"),this.linkContainer=this.el.querySelector(".share_link_wrap")},changeCover:function(e){var t,i,n,o,s;return t=e.get("cover_moment_uid"),t?(n=function(t){return function(i,n){var o;return null!=(o=t.smallAlbumImgEl)&&(o.style.backgroundImage="url("+s+")"),t.positionCoverImage(i,n,e)}}(this),i=function(e){return function(){return e.smallAlbumImgEl.style.backgroundImage="url('/assets/1px.gif')"}}(this),s=this.model.getCoverUrl("small"),ThisLife.Helper.Image.preloadImage(s,n,i)):null!=(o=this.smallAlbumImgEl)?o.style.backgroundImage="url('/assets/1px.gif')":void 0},positionCoverImage:function(e,t,i){var n,o,s,r;return o="center center",n=i?i.cover_moment_aoi:this.model.get("cover_moment_aoi"),n&&e&&t?o=ThisLife.Helper.Image.backgrounPositionForAreaOfInterest(n,e,t,this.smallAlbumImgEl.clientWidth,this.smallAlbumImgEl.clientHeight):(r=e||parseFloat(this.model.get("orig_width")),s=t||parseFloat(this.model.get("orig_height")),s>r&&(o="center 25%")),this.smallAlbumImgEl.style.backgroundPosition=o},focusCursor:function(){return $(this.el.querySelector(".new_person_input")).focus(),this.clickInput()},showHelpTooltip:function(){return this.helpButtonWrapEl.classList.add("show")},hideHelpTooltip:function(){return this.lockHelpTooltip?void 0:this.helpButtonWrapEl.classList.remove("show")},forceHideHelpTooltip:function(){return this.lockHelpTooltip=!1,this.helpButtonWrapEl.classList.remove("show"),ThisLife.removeBlurEvent(this.hideTooltipBlur)},clickHelpButton:function(){return this.lockHelpTooltip=!this.lockHelpTooltip,this.lockHelpTooltip?this.hideTooltipBlur=ThisLife.blurEvent($("#help_button"),_.bind(this.forceHideHelpTooltip,this)):ThisLife.removeBlurEvent(this.hideTooltipBlur)},addPersonRowHolderBorder:function(){var e;return e=$(".person_row_holder"),e.hasClass("no_border")?e.removeClass("no_border"):void 0},changeFollowerCount:function(){var e,t;return t=this.model.followers.getNumFollowers(),e=this.el.querySelector(".invitees_header .count"),e.innerHTML=t},addFollowerRow:function(e,t){var i;return null==t&&(t=!0),i=new ThisLife.View.Album.SharePopupRow({model:e,parentPubSub:this.pubSub,album:this.model}),this.personRowHolder=this.el.querySelector(".person_row_holder"),this.personRowHolder.appendChild(i.el),this.addPersonRowHolderBorder(),this._subviews[e.id]=i,t?this.changeFollowerCount():void 0},removeFollowerRow:function(e){return this._subviews.hasOwnProperty(e.id)?(this._subviews[e.id].remove(),this._subviews[e.id].teardown(),delete this._subviews[e.id],this.changeFollowerCount()):void 0},updatePendingInvitesCount:function(){var e;return e=this.inviteQueue.length,e>0?ThisLife.app.controller("appmodal").get("album_share").enableButton("orange_button"):ThisLife.app.controller("appmodal").get("album_share").disableButton("orange_button"),ThisLife.PubSub.trigger("albumAction:inviteCount",{count:e})},inputKeydown:function(e){return ThisLife.Helper.Keyboard.isEnter(e.keyCode)?this.personSelected():void 0},addNewEmailInvitee:function(n){var o,s,r,l,a,u;return s=this.el.querySelector(".new_person_input"),o=s.value.trim(),a=$.Guid.New().toLowerCase(),l=$(".select_option_value").html(),u=!1,r={uid:a,email_shared_with:o,first_name:"",last_name:"",view_only:n||u},""!==o?ThisLife.Helper.Validate.email(o)?this.inviteExists(a,o)?this.setInputInvalid(t):this.isSelfInvite(o)?this.setInputInvalid(i):this.addNewInvitee(r):this.setInputInvalid(e):void 0},addNewTaggedInvitee:function(e){var n,o,s,r,l,a;return l=$.Guid.New().toLowerCase(),n=e.email||"",o=e.name,r=$(".select_option_value").html(),a=!1,s={uid:l,email_shared_with:n,first_name:this.getFirstName(o),last_name:this.getLastName(o),view_only:a,personUid:e.uid},this.isSelfInvite(n)?this.setInputInvalid(i):this.inviteExists(l,n)?this.setInputInvalid(t):this.addNewInvitee(s)},validateEmail:function(n,o){return ThisLife.Helper.Validate.email(o)?this.isSelfInvite(o)?n.validateEmailFailed(i):this.inviteExists("",o)?n.validateEmailFailed(t):n.validateEmailSuccess():n.validateEmailFailed(e)},addEmailInvitee:function(e,t){return e.model.set("email_shared_with",t),this.inviteQueue.push(e.model),this.focusCursor(),this.updatePendingInvitesCount()},inviteExists:function(e,t){var i,n,o,s,r,l,a,u,c,d;for(c=this.model.followers.models,o=0,r=c.length;r>o;o++){if(i=c[o],n=i.get("email_shared_with"),i.id===e)return!0;if(n&&n.toLowerCase()===t.toLowerCase())return!0}for(d=this.inviteQueue,s=0,l=d.length;l>s;s++){if(a=d[s],u=a.get("email_shared_with"),a.id===e)return!0;if(u&&u===t)return!0}return!1},isSelfInvite:function(e){return e===ThisLife.Model.User.get("email")},addNewInvitee:function(e){var t,i,n,o;return i=this.model.followers.createStoryPermission(e),t=i.get("email_shared_with")?!0:!1,o=new ThisLife.View.Album.SharePopupRow({model:i,queued:!0,parentPubSub:this.pubSub,personUid:e.personUid}),this._subviews[i.id]=o,this.personRowHolder=this.el.querySelector(".person_row_holder"),this.personRowHolder.appendChild(o.el),this.addPersonRowHolderBorder(),null!=(n=this.inviteesWrapEl.querySelector(".new_person_input"))&&(n.value=""),this.removeInputInvalid(),this.scrollToNextInvitee(),this.clearPersonInput(),$(this.peopleDropdownEl).hide(),t?(this.focusCursor(),this.inviteQueue.push(i),this.updatePendingInvitesCount(),ThisLife.Model.User.addEmailAddress(i.get("email_shared_with")),this.$inputEl.get(0).shorthand.updateSource(ThisLife.Service.api.getContactsWithoutFacebook().toJSON())):o.trigger("openEditEmail")},setInputInvalid:function(e){var t;return this.removeInputInvalid(),this.newPersonRowEl.classList.add("invalid"),null!=(t=this.errorTooltip)&&t.teardown(),this.errorTooltip=new ThisLife.View.Album.SharePopupTooltip({message:e}),this.newPersonRowEl.querySelector(".person_info_wrap").appendChild(this.errorTooltip.el)},showAddressBook:function(){var e,t,i;return i=function(){var t,i,n,o;for(n=this.inviteQueue,o=[],t=0,i=n.length;i>t;t++)e=n[t],o.push(e.get("email_shared_with"));return o}.call(this),t=function(){var t,i,n,o;for(n=this.model.followers.models,o=[],t=0,i=n.length;i>t;t++)e=n[t],o.push(e.get("email_shared_with"));return o}.call(this),ThisLife.app.controller("addressbook").show({sendToList:t.concat(i),cb:_.bind(this.onCloseAddressBook,this)}),ThisLife.app.controller("tracking").logClickShareAddressBook()},onCloseAddressBook:function(e){return _.each(e,function(e){return function(t){var i;return e.inviteExists("",t.email)||e.isSelfInvite(t.email)?void 0:(i={email_shared_with:t.email,first_name:t.fName,last_name:t.lName,view_only:!1},e.addNewInvitee(i))}}(this))},removeInputInvalid:function(){var e;return this.newPersonRowEl.classList.remove("invalid"),null!=(e=this.errorTooltip)&&e.teardown(),this.errorTooltip=null},removeQueueItem:function(e){var t,i,n,o,s,r;for(s=this.inviteQueue,r=[],n=t=0,o=s.length;o>t;n=++t){if(i=s[n],i.id===e){delete this._subviews[e],this.inviteQueue.splice(n,1),this.updatePendingInvitesCount();break}r.push(void 0)}return r},validateInviteQueue:function(){var e,t,i,n,o,s;for(s=this.inviteQueue,t=0,n=s.length;n>t;t++){if(i=s[t],e=i.get("email_shared_with"),o=i.get("first_name"),!e)return!1;if(this.model.followers.checkIfIgnoredMember(e))return!1}return!0},clickInviteBtn:function(e){return e.stopPropagation(),this.invitesSent?(this.updatePendingInvitesCount(),this.invitesSent=!1):void 0},sendInviteQueue:function(){var e,t,i,n,o,s,r,l;if(""!==(null!=(s=this.el.querySelector(".new_person_input"))?s.value.trim():void 0)&&this.addNewEmailInvitee(),this.validateInviteQueue()){for(this.hideCharacterLimit(),e=this.el.querySelector("#custom_msg_input").value.trim(),n=0,r=this.inviteQueue,t=0,o=r.length;o>t;t++)i=r[t],n++,i.setMessage(null!=e?e:""),i.set("view_only",this.model.get("locked")),this.model.followers.add(i),i.saveStoryPermission();return l=this.isLocked?"locked":"unlocked",l+="|"+this.inviteQueue.length,ThisLife.app.controller("tracking").logAlbumShare("postEmail",{numberOfInvites:l}),this.inviteQueue=[],this.invitesSent=!0,this.updatePendingInvitesCount(),this.pubSub.trigger("invitesSent"),ThisLife.app.controller("tracking").logAlbumShare("postEmail"),$("#popover_wrap").addClass("popover_view_shared"),$("div.middle_section").html(ThisLife.Templates.actionBar("postedToService",{text:"Your Album has been shared"})),_.delay(function(e){return function(){return e.confirmDone(null,!0)}}(this),1200),ThisLife.app.controller("appmodal").destroy("album_share"),ThisLife.app.controller("toast")["new"]({text:"Album Shared with "+n+" people"})}},confirmDone:function(e,t){var i;return null!=t?this.removeAlbumSharePopup():(""!==(null!=(i=this.el.querySelector(".new_person_input"))?i.value.trim():void 0)&&this.addNewEmailInvitee(),this.inviteQueue.length>0?(this.doneConfirmed=new ThisLife.View.Album.SharePopupConfirmation(this.inviteQueue.length),this.doneConfirmed.on("confirmed",this.removeAlbumSharePopup,this),this.doneConfirmed.on("cancel",this.selectEmailTab,this)):this.removeAlbumSharePopup())},removeAlbumSharePopup:function(){return this.parentController.removeView()},clearPersonInput:function(){return this.newPersonRowEl.querySelector("input").value="",this.removeInputInvalid()},characterLimit:function(e){var t,i,n;if($(".character_limit").show(),i=1e3,t=e.target.value.length,t>=i?(e.target.value=e.target.value.substr(0,i),t=i,$(".character_limit").addClass("invalid")):$(".character_limit").removeClass("invalid"),$(".character_limit").html(i-t+"/"+i),"focusin"!==e.type){for(n=[];$(this.textarea).height()>=this.textarea.scrollHeight&&$(this.textarea).height()>152;)n.push(this.textarea.style.height=parseInt($(this.textarea).height())-1+"px");return n}},hideCharacterLimit:function(){return $(".character_limit").hide()},showDoneButton:function(){return this.$(".tl_modal_bottom_left").empty(),this.$(".tl_modal_bottom_right").html('<a id="modal_cancel" class="small-btn porcelain-btn">Done</a>')},adjustBorderAndRotateArrow:function(){return $(".new .controls").removeClass("adjust_border"),$(".new .permission_arrow").removeClass("rotate")},selectEmailTab:function(e){return this.clickMenuItem(e,this.el.querySelector(".share_actions .email"))},clickMenuItem:function(e,t){var i,n,o,s,r,l,a,u,c;if(l=t||e.currentTarget,a=this.el.querySelectorAll(".share_actions .menu_item"),c=l.dataset.panelName,"share_fb_wrap"===c)return this.openFacebookShareDialog(),void ThisLife.app.controller("tracking").logAlbumShare("clickFacebook");for(i=0,o=a.length;o>i;i++)r=a[i],u=r.dataset.panelName,$(this.el.querySelector("."+u)).hide();for(n=0,s=a.length;s>n;n++)r=a[n],r.classList.remove("active");return l.classList.add("active"),this.updateBottomButton(c,this.inviteQueue.length),$(this.el.querySelector("."+c)).show(),"share_link_wrap"===c?ThisLife.app.controller("tracking").logAlbumShare("clickLink"):void 0},openFacebookShareDialog:function(){var e;return e=ThisLife.app.controller("albums").getShareURL({uid:this.model.get("uid"),channel:"facebook",callback:function(e){return function(t,i){return e._openFBDialog(i.result.payload.facebook)}}(this)}),e?this._openFBDialog(e):void 0},_openFBDialog:function(e){return FB.ui({method:"share",href:e},_.bind(this._successFBShare,this))},_successFBShare:function(e){e&&!e.error_message&&(ThisLife.app.controller("tracking").logAlbumShare("postFacebook"),ThisLife.Service.api.dataWarehouseLog({action:"share",date:Math.trunc(Date.now()/1e3),experience:ThisLife.isMobile?"m.web":"d.web",module:"share",shareDestination:"Facebook",shareType:"story",storyId:this.model.get("uid"),storyName:this.model.get("name"),userId:ThisLife.currentLifeOwner}),ThisLife.app.controller("toast")["new"]({text:"Album Shared to Facebook"}),ThisLife.app.controller("appmodal").destroy("album_share"))},updateBottomButton:function(e,t){return"share_link_wrap"===e||"share_fb_wrap"===e?ThisLife.app.controller("appmodal").get("album_share").disableButton("orange_button"):"share_email_wrap"===e&&t>0?ThisLife.app.controller("appmodal").get("album_share").enableButton("orange_button"):void 0},remove:function(){var e,t,i,n;this.unbindEvents(),t=this._subviews;for(e in t)l.call(t,e)&&(n=t[e],n.teardown());return null!=(i=this.doneConfirmed)&&i.off,ThisLife.Albums.View.currentPopover=null,this.options.onDone?this.options.onDone():void 0},clickInput:function(){return this.inputFocusBlur=ThisLife.blurEvent($(this.inviteInputEl),_.bind(this.submitInput,this))},submitInput:function(){var e;return ThisLife.removeBlurEvent(this.inputFocusBlur),this.el.querySelector(".email_popup")?void 0:null!=(e=this.$inputEl.get(0).shorthand)?e.select():void 0},openShorthand:function(e){return""!==e?(this.scrollToBottom(),this.showShorthand()):void 0},getPeopleShorthand:function(){var e,t,i;return i=ThisLife.Service.api.combineContacts().toJSON(),e=function(){var e,n,s;for(s=[],e=0,n=i.length;n>e;e++)t=i[e],s.push({name:t.name,email:t.email,url:t.default_face_url,uid:t.id,emailImage:t.email?o:"",defaultUrl:"/assets/people/defaultPerson.png"});return s}()},personSelected:function(e){var t;return e?this.addNewTaggedInvitee(e):(t=this.getPersonFromName(),t?this.addNewTaggedInvitee(t):this.addNewEmailInvitee())},getPersonFromName:function(){var e,t,i,n,o;for(t=this.el.querySelector(".new_person_input").value,n=this.getPeopleShorthand(),e=0,i=n.length;i>e;e++)if(o=n[e],t.toLowerCase()===o.name.toLowerCase())return o;return null},lockScroll:function(){return this.pubSub.trigger("lockScroll",!0)},unlockScroll:function(){return this.pubSub.trigger("lockScroll",!1)},setLockedScroll:function(e){return ThisLife.Helper.DOM.addRemoveClass(this.inviteesWrapEl,e,"locked_scroll")},reRenderShorthand:function(){return $(this.inviteInputEl).get(0).shorthand.destroy(),this.renderShorthand()},renderShorthand:function(){var t,i,n,o,s,l,a;return this.$dropdown=$(this.peopleDropdownEl),this.$inputEl=$(this.inviteInputEl),l=this,n=function(e){var t,i,n;return i=e.data("item"),t=l.$el.find(".people_dropdown_shorthand .active"),n=t.data("value")||t.data("email"),this.shown&&n&&e.val(n.trim()),n&&n.toLowerCase()===e.val().toLowerCase()&&e.data(t.data()),l.personSelected(e.data("item"))},i=function(e){return null==e&&(e=!1),$.fn.shorthand.Constructor.prototype.hide.call(this,e),l.hideShorthand()},a=function(){return $.fn.shorthand.Constructor.prototype.show.call(this),l.showShorthand()},o=function(){return ThisLife.Helper.String.contains(l.$inputEl.val()," ")?(l.removeInputInvalid(),l.setInputInvalid(e)):void 0},t=function(){var e;return null!=(e=l.$inputEl.get(0).shorthand)&&e.select(),l.hideShorthand()},s={source:ThisLife.Service.api.combineContacts().toJSON(),"class":"people_dropdown_shorthand",value:"name",parent:this.$dropdown,num:-1,sorted:!1,template:r,menu:"<ul></ul>",showAllForNoQuery:!1,hide:i,show:a,blur:function(){},noMatches:o,blurTimeout:1e3,highlighter:function(e){return e},matcher:function(e){var t;return t=e[this.value]+(e.email||""),t?~t.toLowerCase().indexOf(this.query.toLowerCase()):void 0},selectCallback:n},this.$dropdown.hide(),this.$inputEl.shorthand(s)},showShorthand:function(){return this.$dropdown.show(),this.shorthandBlurEvent&&ThisLife.removeBlurEvent(this.shorthandBlurEvent),this.shorthandBlurEvent=ThisLife.blurEvent(this.$dropdown,_.bind(this.hideShorthand,this))},hideShorthand:function(){var e;return null!=(e=this.$dropdown)&&e.hide(),this.shorthandBlurEvent?ThisLife.removeBlurEvent(this.shorthandBlurEvent):void 0},scrollToBottom:function(){return this.inviteesWrapEl.scrollTop=this.inviteesWrapEl.scrollHeight},scrollToNextInvitee:function(){var e,t;return t=$(".person_row"),e=t.length*t.height(),e>450?this.inviteesWrapEl.scrollTop=e-130:void 0},getFirstName:function(e){return this.separateName(e)[0]},getLastName:function(e){return this.separateName(e)[1]},separateName:function(e){var t,i,n,o,s,r,l;if(null==e&&(e=""),l=e.split(" "),r=[],r[0]=e,l.length>1){for(t="",o=i=0,s=l.length;s>i;o=++i)n=l[o],o<l.length-1&&(t+=n+" ");r[0]=t.trim(),r[1]=l[l.length-1]}return r},updateShareModal:function(e){return this.addFollowerRow(e,!0),this.model.followers.getNumFollowers()>0?ThisLife.app.controller("appmodal").get("album_share").enableButton("unshare"):void 0},template:function(){var e,t,i;return i='<p class="help_header">About Share Album</p>\n<p>People you invite can be given view only access or contribute access, where they can add their own photos and videos to the Album. You can change their permission anytime.<br/>Anyone who accepted will:</p>\n<ul class="help_ul">\n  <li>Be notified via email, at most once every 12 hours, when new content has been added to the Album.</li>\n  <li>The recipients who accept your shared albums will find them under \'Shared with me\'.</li>\n</ul>',e=this.inviteQueue.length,t=this.model.followers.nonDuplicatedFollowers().length,"<div class='shutterfly_share_wrapper' id='shutterfly_share_wrapper'>\n  <div class='share_actions'>\n    <div class='menu_item email active' data-panel-name=\"share_email_wrap\"><div class='icon'></div>Email</div>\n    <div class='menu_item fb' data-panel-name=\"share_fb_wrap\"><div class='icon'></div>Facebook</div>\n    <div class='menu_item link' data-panel-name=\"share_link_wrap\"><div class='icon'></div>Link</div>\n  </div>\n  <div class='share_email_wrap'>\n    <div class=\"invitees_wrap\">\n      <div class=\"invitees_header\">\n        <span class=\"title\">Invitees (<span class=\"count\">"+t+'</span>)</span>\n      </div>\n      <div class="person_row_holder '+(t||e?"":"no_border")+"\"></div>\n    </div>\n  </div>\n  <div class='share_link_wrap' style='display: none;'></div>\n</div>"}}),n=function(e){var t,i;return t=e.coverUrl?"background-image: url("+e.coverUrl+")":"",i=ThisLife.Helper.String.escapeHtml(e.storyName),'<div class="custom_msg">\n  <div class="framed_moment stack story_element small '+(e.momentCount<1?" empty":"")+" "+(e.coverUrl?"":" no_image")+'">\n    <div class="framed_moment_media">\n      <div class="img" style="'+t+'"></div>\n    </div>\n    <div class="framed_moment_meta">\n      <span class="title" title="'+i+'">'+i+'</span>\n    </div>\n    <div class="stack_graphic"></div>\n  </div>\n  <div class="textarea_holder">\n    <div class="text_title">\n      <div class="message_text">Message</div>\n      <div class="character_limit hidden"></div>\n    </div>\n    <textarea id="custom_msg_input" type="text"  class="custom_msg_input" autocomplete="off" maxlength="1000" placeholder="Add an optional message"></textarea>\n  </div>\n\n</div>'},s=function(){return'<div class="person_row new clearfix">\n  <div class="person_info_wrap">\n    <div class="new_person_info">\n      <input id="new_person_input" type="text" placeholder="Enter email or name" class="new_person_input" autocomplete="off">\n      <div class="warning_icon"></div>\n    </div>\n    <a href="javascript:;" class="address_book_link tertiary_link">Address book</a>\n  </div>\n  <div class="people_dropdown large" id="tl_people_dropdown"></div>\n</div>'},r="<% var emailImage = emailImage || null %>\n<% var uid = uid || null %>\n<li  data-email='<%= email %>' data-uid='<%= uid %>' >\n  <div class='row'>\n    <div class='row_avatar' style=\"background-image:url(<%= default_face_url %>)\" data-img=\"<%= default_face_url %>\">\n    </div>\n    <span class='row_name'><%= name %></span>\n    <span class='row_email'>\n      <%= emailImage %>\n      <span class=\"email\">\n        <%= email %>\n      </span>\n    </span>\n  </div>\n  <div class=\"row_separator\"></div>\n</li>",o='<div class="email_image"></div>'}.call(this),function(){var e;e=7,ThisLife.View.Album.SharePopupRow=Backbone.View.extend({className:"person_row",events:{"click .person_row .remove_btn":"revokeInvite","click .no_email .email_address_link":"openEditEmail"},initialize:function(e){return this.options=null!=e?e:{},this.currentStory=ThisLife.currentStory||this.options.album,this.model=this.options.model,this.personUid=this.options.personUid,this.parentPubSub=this.options.parentPubSub,this.pubSub=_.extend({},Backbone.Events),this.queued=this.options.queued||!1,this.followers=this.currentStory.followers,this.isEditEmailOpen=!1,this.tempEmail=null,this.bindEvents(),this.render(),this},bindEvents:function(){return this.model.on("change:ignored",this.changeIgnored,this).on("revokeInvite",this.revokeInvite,this),this.parentPubSub.on("invitesSent",this.onInvitesSent,this).on("clickAnywhere",this.clickAnywhere,this),this.pubSub.on("validateEmail",this.validateEmail,this).on("teardown",this.emailTeardown,this),ThisLife.Helper.Platform.webkit()&&(this.lockScrollDebounce=_.debounce(_.bind(this.reRender,this),150),this.parentPubSub.on("lockScroll",this.lockScrollDebounce,this)),this.on("openEditEmail",this.openEditEmail,this),this},unbindEvents:function(){return this.model.off(null,null,this),this.parentPubSub.off(null,null,this)},render:function(){var e;return this.queued?(e=this.queuedTemplate(),this.el.classList.add("queued")):e=this.template(),this.el.insertAdjacentHTML("beforeend",e),this},reRender:function(){return this.el.innerHTML="",this.render()},changeIgnored:function(){return this.model.get("ignored")?this.el.querySelector(".controls .status").textContent="Declined":void 0},clickAnywhere:function(e){return e!==this&&$(this.toggleEl).is(":visible")?$(this.toggleEl).hide():void 0},onInvitesSent:function(){return this.queued&&""!==this.model.get("email_shared_with")?(this.el.innerHTML="",this.el.insertAdjacentHTML("beforeend",this.template()),this.el.classList.remove("queued"),this.queued=!1):void 0},revokeInvite:function(){return this.queued?this.confirmedRevokeInvite():(this.confirm=new ThisLife.View.Album.SharePopupConfirmation(this.options),this.confirm.on("teardown",this.confirmedRevokeInvite,this))},removePersonRowHolderBorder:function(){var e,t;return e=$(".person_row_holder"),t=e.children().length,0===t?e.addClass("no_border"):void 0},confirmedRevokeInvite:function(){var e;return e=this,$(this.el).animate({opacity:0},200).animate({height:0},200,function(){return e.queued?e.parentPubSub.trigger("removeQueuedInvite",e.model.id):e.followers.revokeInvite(e.model.id),e.teardown()})},clickInvalidQueuedInvite:function(e){return e.target.classList.contains("remove_btn")||this.openEditEmail(),this},openEditEmail:function(){return this.emailPopup=new ThisLife.View.Album.SharePopupEmail({model:this.model,parentPubSub:this.pubSub,parentEl:this.el}),this.el.parentNode.appendChild(this.emailPopup.el),_.defer(function(e){return function(){return e.parentPubSub.trigger("openedPopup")}}(this)),this.emailPopup.focus()},validateEmail:function(e){return this.tempEmail=e,this.parentPubSub.trigger("validateEmail",this,e)},validateEmailSuccess:function(){var e,t,i,n,o;if(this.model.set("email_shared_with",this.tempEmail),null!=(n=this.emailPopup)&&n.teardown(),this.el.querySelector(".person_info_wrap").classList.remove("no_email"),this.tempEmail){for(o=ThisLife.Collection.personTags.models,e=0,t=o.length;t>e;e++)if(i=o[e],i.id===this.personUid){i.set("email",this.tempEmail).save();break}return $(this.el.querySelector(".email_address_link")).html(this.tempEmail),this.parentPubSub.trigger("emailAdded",this,this.tempEmail)}},validateEmailFailed:function(e){var t;return null==e&&(e=""),null!=(t=this.emailPopup)?t.setInvalid(e):void 0},emailTeardown:function(){return this.parentPubSub.trigger("closedPopup")},getName:function(){var e,t,i,n,o;return t=this.model.get("first_name"),i=this.model.get("last_name"),e=this.model.get("email"),n=this.model.get("name"),t?(o=t.capitalize(),i&&(o+=" "+i.capitalize()),o):n?n.capitalize():e?e:""},teardown:function(){var e,t,i;return null!=(e=this.confirm)&&e.off,this.unbindEvents(),this.remove(),this.removePersonRowHolderBorder(),0===(null!=(t=ThisLife.currentStory)&&null!=(i=t.followers)?i.length:void 0)?ThisLife.app.controller("appmodal").get("album_share").disableButton("unshare"):void 0},template:function(){var e,t,i,n,o,s;
return i=ThisLife.Helper.String.escapeHtml(this.getName()),e=ThisLife.Helper.String.escapeHtml(this.model.get("email")||this.model.get("email_shared_with")||""),s=this.model.get("view_only")?!0:!1,n=i?" header":"",t=i?"":" header",o=this.model.get("ignored")?"Declined":"",'<div class="person_info_wrap with_email">\n  <div class="person_info_holder">\n    <div class="info name'+n+'">'+i+'</div>\n    <div class="info email'+t+'">'+e+"</div>\n  </div>\n</div>"},queuedTemplate:function(){var e,t,i,n,o;return i=ThisLife.Helper.String.escapeHtml(this.getName()),e=ThisLife.Helper.String.escapeHtml(this.model.get("email_shared_with")||""),t=i?i:e,n=e?"":"no_email",o=this.model.get("view_only")?!0:!1,'<div class="person_info_wrap '+n+'">\n  <div class="name">\n    <span class="name_holder">'+(i?i:"")+'</span>\n    <span class="email_address_link">'+(e?e:"Add email address")+'</span>\n  </div>\n  <div class="remove_btn"></div>\n</div>'}})}.call(this),function(){ThisLife.View.Album.SharePopupEmail=Backbone.View.extend({className:"email_popup",events:{"click .save_btn":"saveEmail","click .invalid_icon":"clearInvalid"},initialize:function(e){return this.model=e.model||{},this.parentPubSub=e.parentPubSub,this.parentEl=e.parentEl,_.bindAll(this,"keyDown"),this.bindEvents(),this.render(),this.cacheElements(),this.debounceResize=_.debounce(_.bind(this.adjustSizePosition,this),100),ThisLife.PubSub.on("resize",this.debounceResize,this),this.adjustSizePosition(),this},adjustSizePosition:function(){var e,t,i,n,o,s;return i=$(this.parentEl).find(".person_info_wrap"),s=this.parentEl.offsetTop,o=this.parentEl.parentNode.parentNode.scrollTop,n=i.innerHeight(),t=n/2,this.el.style.top=s-o-t+"px",e=i.width(),window.innerWidth>768?this.el.style.left=e/2-130+"px":(this.el.style.left="-6px",$(this.el).width()>=$(window).width()?(this.el.style.width=$(window).width()+"px",this.el.classList.add("small")):(this.el.style.width="",this.el.classList.remove("small")))},keyDown:function(e){return ThisLife.Helper.Keyboard.isEnter(e.keyCode)?this.saveEmail():void 0},bindEvents:function(){return this.el.addEventListener("keydown",this.keyDown,!1),ThisLife.Support.keyInformant.on("cancel",this.teardown,this,!0)},unbindEvents:function(){return this.el.removeEventListener("keydown",this.keyDown,!1),ThisLife.Support.keyInformant.off("cancel",this.teardown,this),ThisLife.removeBlurEvent(this.blurEvent),ThisLife.PubSub.off("resize",this.debounceResize,this)},render:function(){var e;return e=this.template(this.model.toJSON()),this.el.insertAdjacentHTML("beforeend",e),this},cacheElements:function(){return this.inputEl=this.el.querySelector("input.email"),this.contentEl=this.el.querySelector(".content_wrap")},focus:function(){return $(this.inputEl).focus(),this.blurEvent=ThisLife.blurEvent($(this.contentEl),_.bind(this.teardown,this))},setInvalid:function(e){var t;return null==e&&(e=""),null!=(t=this.errorTooltip)&&t.teardown(),this.contentEl.classList.add("invalid"),this.errorTooltip=new ThisLife.View.Album.SharePopupTooltip({message:e}),this.el.querySelector(".content_wrap").insertBefore(this.errorTooltip.el,this.el.querySelector(".invalid_icon"))},clearInvalid:function(){var e;return this.inputEl.value="",this.contentEl.classList.remove("invalid"),null!=(e=this.errorTooltip)&&e.teardown(),this.focus()},saveEmail:function(){var e;return e=this.inputEl.value,this.parentPubSub.trigger("validateEmail",e)},teardown:function(){var e;return this.parentPubSub.trigger("teardown"),null!=(e=this.errorTooltip)&&e.teardown(),this.unbindEvents(),this.remove()},template:function(){return'<div class="selection_popover_dropdown dropdown content_wrap">\n  <input type="text" class="email" placeholder="Provide an email address"/>\n  <div class="invalid_icon"></div>\n  <div class="save_btn gray-btn">Save</div>\n</div>'}})}.call(this),function(){var e,t;t=e=void 0,ThisLife.View.Album.SharePopupLink=Backbone.View.extend({id:"popover_wrap_link",className:"",events:{"mousedown .toggle":"mouseDown"},initialize:function(e){return this.options=null!=e?e:{},_.bindAll(this,"mouseMove","mouseUp"),this.model=ThisLife.currentStory||this.options.album,this.parentContainer=this.options.parentContainer,this.render(),this.cacheElements(),this.checkToggleStatus(),this.positionCoverImage(),this.bindEvents(),this},bindEvents:function(){return this.model.on("change:cover_moment_uid",this.changeCover,this)},mouseDown:function(t){var i;return e=13,i=$(this.toggle),this.handle=i.find(".handle"),this.handle.addClass("no_transition"),this.posX=t.clientX,this.offsetX=this.handle.get(0).offsetLeft,$(window).on("mousemove",this.mouseMove).on("mouseup",this.mouseUp)},mouseMove:function(t){var i,n;return i=Math.min(this.offsetX-(this.posX-t.clientX),e),this.moveTo=n=Math.max(i,1),this.handle.css({left:n})},mouseUp:function(t){var i,n;return n=this.posX===t.clientX?null:this.moveTo<e/2?!1:!0,null==n&&(i=this.toggle.classList,n=i.contains("on")?!1:!0),this.confirmToggle(n),$(window).off("mousemove",this.mouseMove).off("mouseup",this.mouseUp)},updatePermissions:function(e){return this.model.updateShareLink(e)},confirmToggle:function(e){var t;return e?(t=this.changeToggle(e),this.updatePermissions(t),$(this.toggleDesc).html("This link is public")):(this.changeToggle(e),$(this.toggleDesc).html("This link is private"),this.confirmed=new ThisLife.View.Album.SharePopupLinkConfirmation,this.confirmed.on("confirmed",this.confirmMakePrivate,this),this.confirmed.on("teardown",this.cancelMakePrivate,this))},confirmMakePrivate:function(){var e;return e=this.changeToggle(!1),this.updatePermissions(e),this.handle.css({left:""}),this.handle.removeClass("no_transition")},cancelMakePrivate:function(){return this.changeToggle(!0),this.handle.css({left:""}),this.handle.removeClass("no_transition"),$(this.toggleDesc).html("This link is public")},cacheElements:function(){return this.toggle=this.el.querySelector("#js_public_link"),this.input=this.el.querySelector("#url-input"),this.toggleDesc=this.el.querySelector("#toggle_desc"),this.tinyAlbumImgEl=this.el.querySelector(".tiny .framed_moment_media .img")},changeCover:function(e){var t,i,n,o,s;return t=e.get("cover_moment_uid"),t?(n=function(t){return function(i,n){var o;return null!=(o=t.tinyAlbumImgEl)&&(o.style.backgroundImage="url("+s+")"),t.positionCoverImage(i,n,e)}}(this),i=function(e){return function(){return e.tinyAlbumImgEl.style.backgroundImage="url('/assets/1px.gif')"}}(this),s=this.model.getCoverUrl("small"),ThisLife.Helper.Image.preloadImage(s,n,i)):null!=(o=this.tinyAlbumImgEl)?o.style.backgroundImage="url('/assets/1px.gif')":void 0},positionCoverImage:function(e,t,i){var n,o,s,r;return o="center center",n=i?i.cover_moment_aoi:this.model.get("cover_moment_aoi"),n&&e&&t?o=ThisLife.Helper.Image.backgrounPositionForAreaOfInterest(n,e,t,this.tinyAlbumImgEl.clientWidth,this.tinyAlbumImgEl.clientHeight):(r=e||parseFloat(this.model.get("orig_width")),s=t||parseFloat(this.model.get("orig_height")),s>r&&(o="center 25%")),this.tinyAlbumImgEl.style.backgroundPosition=o},checkToggleStatus:function(){return this.model.get("public_link")?this.selectInputEl():void 0},selectInputEl:function(){return this.input.focus(),$(this.input).is(":visible")?this.input.select():void 0},changeToggle:function(e){var t,i,n;return t=this.toggle.classList,n=function(){switch(e){case!0:return"add";case!1:return"remove";default:return"toggle"}}(),t[n]("on"),i=t.contains("on"),i?this.input&&(this.selectInputEl(),this.input.classList.remove("disabled")):this.input&&(document.getSelection().removeAllRanges(),this.input.classList.add("disabled"),this.input.classList.add("link")),i},render:function(){return this.el.insertAdjacentHTML("beforeend",this.template()),$(this.parentContainer).append(this.el),ThisLife.PubSub.on("Album:getShareURL",_.bind(this._updateShareURL,this))},teardown:function(){return ThisLife.Support.keyInformant.off("cancel",this.teardown,this),ThisLife.PubSub.off("Album:getShareURL",_.bind(this._updateShareURL,this)),this.model.off("change:cover_moment_uid",this.changeCover,this),this.remove()},_updateShareURL:function(e){return this.input.value=e},template:function(){var e,t,i,n,o,s;return n=this.model.get("public_link")?"on":"",o=ThisLife.app.controller("albums").getShareURL({uid:this.model.get("uid"),channel:"link"})||"Loading...",t=this.model.getCoverUrl("small"),s=ThisLife.Helper.String.escapeHtml(this.model.get("name").substring(0,150)),i=this.model.get("visible_moment_count"),e=t?"background-image: url("+t+")":"",'<div class="link_story">\n  <div class="body">\n    <div class="share_story_options link">\n      <h2>Copy link and share this Album</h2>\n      <div class=\'wrapper\'>\n        <div class=\'actions\'>\n          <div class=\'subactions\'>\n            <input id=\'url-input\' type="text" readonly class="link" value="'+o+'" />\n          </div>\n          <div class="description">\n            Anyone with access to this link will have access to this album. You can see who has viewed this album under the number of people shared in your album.\n          </div>\n        </div>\n        <div class="framed_moment stack story_element tiny '+(1>i?" empty":"")+" "+(t?"":" no_image")+'">\n          <div class="framed_moment_media">\n            <div class="img" style="'+e+'"></div>\n          </div>\n          <div class="framed_moment_meta">\n            <span class="title" title="'+s+'">'+s+'</span>\n          </div>\n          <div class="stack_graphic"></div>\n        </div>\n      </div>\n    </div>\n  </div>\n</div>'}})}.call(this),function(){var e;ThisLife.View.Album.SharePopupConfirmation=Backbone.View.extend({id:"popover_wrap_confirmation",className:"popover_wrap new_popover_wrap popover_view_share_story tl_modal_wrap_visible popover_top popover_share_confirmation",events:{"click .cancel_btn":"cancelButton","click .confirm_btn":"confirmButton"},initialize:function(e){return this.options=null!=e?e:{},this.inviteCount=this.options,this.model=this.options.model,this.render(),document.body.appendChild(this.el),this},cancelButton:function(){return this.trigger("cancel"),this.teardown()},confirmButton:function(){return this.trigger(this.model?"teardown":"confirmed"),this.teardown()},render:function(){return $(".popover_wrap").css({background:"none"}),this.el.insertAdjacentHTML("beforeend",e(this.model,this.inviteCount)),ThisLife.Support.keyInformant.on("cancel",this.teardown,this),this},teardown:function(){var e;return null!=(e=this.model)&&e.off(null,null,this),ThisLife.Support.keyInformant.off("cancel",this.teardown,this),this.remove(),$(".popover_wrap").css({background:"rgba(0, 0, 0, 0.4)"})}}),e=function(e,t){var i,n,o,s,r,l,a,u;return e?(o=null!=(a=e.get("first_name"))?a.capitalize():void 0,o&&0!==(null!=o?o.length:void 0)||(o="invitee"),r=null!=(u=e.get("last_name"))?u:"",s="Remove "+o+" "+r.capitalize()+" from this Album?",n="We won't notify the user about it.",i="<a class='gray-btn cancel_btn'>Cancel</a><a class='orange-btn confirm_btn'>Remove</a>",l="confirm_remove"):(s="Are you sure you want to close Share Album?",n="You have "+ThisLife.Helper.String.pluralize(t,"unsent invitation")+".",i="<a class='gray-btn cancel_btn no_btn'>No</a><a class='orange-btn confirm_btn yes_btn'>Yes</a>",l="confirm_close"),s=ThisLife.Helper.String.escapeHtml(s),'<div class="popover two_button_modal '+l+'">\n  <div class="body">\n    <h4>'+s+'</h4>\n    <div  class="modal_information">\n        '+n+'\n    </div>\n\n    <div class="action_btn_wrap clearfix">\n      '+i+"\n    </div>\n     \n  </div>\n</div>"}}.call(this),function(){ThisLife.View.Album.SharePopupTooltip=Backbone.View.extend({className:"validation_tooltip",initialize:function(e){return this.options=null!=e?e:{},this.message=this.options.message||"",this.render(),this.options.contentClass&&this.el.classList.add(this.options.contentClass),this},render:function(){var e;return e=this.template(this.message),this.el.insertAdjacentHTML("beforeend",e),this},teardown:function(){return this.remove()},template:function(e){return'<div class="content_wrap">'+e+'</div>\n<div class="arrow"></div>\n<div class="arrow border"></div>'}})}.call(this),function(){define("ThisLife.View.Album.LockAlbumButton",["ThisLife.PubSub"],function(e){var t;return t=Backbone.View.extend({className:"lock_button",events:{"click .lock_button__icon":"showFlyout"},initialize:function(e){return this.options=null!=e?e:{},this.pubSub=_.extend({},Backbone.Events),this.model=ThisLife.currentStory,this.isLocked=this.model.isLocked(),this.render(),this.bindEvents(),this},render:function(){var e;return e=this.template(),this.el.insertAdjacentHTML("beforeend",e),this.cacheElements(),this.updateLockStatus(),this},teardown:function(){return this.remove()},cacheElements:function(){return this.lockIcon=this.el.querySelector(".lock_button__icon"),this.flyout=this.el.querySelector(".lock_button__flyout")},bindEvents:function(){return this.model.followers.on("remove",this.updateLockStatus,this),e.on("albumAction:lockAlbum",this.lockAlbum,this),e.on("albumAction:invitesSent",this.hideLock,this),e.on("albumAction:inviteCount",this.updateLockStatus,this)},unbindEvents:function(){return this.model.followers.off(null,null,this),e.off("albumAction:lockAlbum",this.lockAlbum,this),e.off("albumAction:inviteCount",this.updateLockStatus,this),e.off("albumAction:invitesSent",this.hideLock,this)},updateLockStatus:function(e){var t,i;return null==e&&(e=null),t=this.model.followers.length||0,(null!=e?e.count:void 0)&&(t+=e.count),(null!=(i=this.inviteeCount)?i.count:void 0)||(this.inviteeCount={count:t}),this.isLocked?this.el.classList.add("locked"):this.el.classList.remove("locked")},showFlyout:function(){return this.flyout.classList.contains("active")?(this.hideDropdown(),void this.lockIcon.classList.remove("active")):(this._dropdownView?this._dropdownView.show():this._createDropdown(),this.lockIcon.classList.add("active"),this.flyout.classList.add("active"))},lockAlbum:function(e){var t;return this.isLocked=_.isBoolean(e)?e:!this.isLocked,this.lockIcon.classList.remove("active"),this.updateLockStatus(this.inviteeCount),this.model.set("locked",this.isLocked),ThisLife.Service.api.lockAlbum(this.model.id,this.isLocked),t=this.isLocked?"locked":"unlocked",ThisLife.app.controller("tracking").logAlbumShareStatus(t)},_createDropdown:function(){var e;return e={items:[{type:"radio",name:"lock_value",value:!1,label:"Anyone can add photos",selected:this.isLocked?!1:!0,disabled:!1,onClick:_.bind(this.dropdownChange,this)},{type:"radio",name:"lock_value",value:!0,label:"No one can add photos",selected:this.isLocked?!0:!1,disabled:!1,onClick:_.bind(this.dropdownChange,this)}],styles:{"default":{bottom:"60px",left:"26px",width:"200px"},mobile:{bottom:"70px"}},arrowAlign:"leftBottom",classes:["album_share_lock_dropdown"],onHide:_.bind(this.hideDropdown,this)},this._dropdownView=ThisLife.app.controller("flyout").get("album_share").show(e),this.flyout.appendChild(this._dropdownView.el)},dropdownChange:function(e){return this.lockAlbum(e.value)},hideDropdown:function(){return this.lockIcon.classList.remove("active"),this.flyout.classList.remove("active"),this._dropdownView=null},hideLock:function(){return this.el.classList.add("hidden")},template:function(){return'<div class="lock_button__icon"></div>\n<div class="lock_button__flyout"></div>'}})}),ThisLife.View.Album.LockAlbumButton=require("ThisLife.View.Album.LockAlbumButton")}.call(this),define("ThisLife.Album.Views.UnshareModal",[],function(){return UnshareModal=Backbone.View.extend({className:"popover-unshare-album",initialize:function(){return this.render(),this},render:function(){return this.el.insertAdjacentHTML("afterbegin",this._template()),this},_template:function(){return"This action makes the album private and deactivates all links and shares."}}),UnshareModal}),function(){var e;define("ThisLife.View.Album.Invitees",[],function(){var e;return e=Backbone.View.extend({className:"story_invitees_popover",initialize:function(e){return this.options=null!=e?e:{},this.model=this.options.model,this.momentCount=ThisLife.app.album.getCollection().getNumPhotosAndVideos(),this.render()},render:function(){return this.$el.html(this.template()),this.cacheElements(),this.update(),this.blurEventCallback=ThisLife.blurEvent($(this.el),_.bind(this.teardown,this)),this},changeNumStoryMoments:function(e){return ThisLife.Helper.DOM.addRemoveClass(this.manageButton,1>e,"disabled")},template:function(){},cacheElements:function(){return this.list=this.el.querySelector(".scrollable ul"),this.manageButton=this.el.querySelector(".story_manage"),this},getInvitees:function(e){var t;return t=this.model.followers.nonDuplicatedFollowers(),t.map(function(t){return function(i){return{name:t.getName(i),show:e||i.get("person_uid")===ThisLife.currentLifeOwner}}}(this))},populate:function(e){var t,i,n,o;for(o=[],t=0,n=e.length;n>t;t++)i=e[t],o.push(i.show?this.list.insertAdjacentHTML("beforeend",this.listItem(i)):void 0);return o},getName:function(e){var t,i,n,o,s,r,l;return i=e.get("first_name"),n=e.get("last_name"),o=e.get("name"),s=e.get("owner_person_uid"),l=e.get("person_uid"),t=e.get("email_shared_with"),r=i&&n?i.capitalize()+" "+n.capitalize():o?o.capitalize():t},getOwnerName:function(e){var t,i,n,o,s,r,l;return i=e.get("permission.owner_first_name"),n=e.get("permission.owner_last_name"),o=e.get("permission.name"),s=e.get("permission.owner_person_uid"),l=e.get("permission.person_uid"),t=e.get("permission.email_shared_with"),r=i&&n?i.capitalize()+" "+n.capitalize():o?o.capitalize():t},listItem:function(e){var t;return t=ThisLife.Helper.String.escapeHtml(e.name),'<li class="view_only">\n  <div class="row">\n    <span class="invitee" title="'+t+'">'+t+"</span>\n  </div>\n</li>"},teardown:function(){return ThisLife.removeBlurEvent(this.blurEventCallback),this.trigger("torndown"),this.remove()}})}),define("ThisLife.View.Album.InviteesOwnerView",["ThisLife.View.Album.Invitees"],function(e){var t;return t=e.extend({events:{"click .story_manage":"showShareStory"},showShareStory:function(){return ThisLife.app.controller("albums").openShareModal(),this.teardown()},lockAlbum:function(){return ThisLife.PubSub.trigger("albumAction:lockAlbum")},update:function(){var e;return e=this.getInvitees(!0),this.populate(e)},template:function(){var e;return e=0!==this.momentCount||this.getInvitees()?"":" disabled",'<div class="selection_popover_dropdown dropdown owner_view">\n  <div class="icon_list list_header">\n    <ul>\n      <li class="view_only"><div class="story_manage orange-btn'+e+'">Manage</div></li>\n    </ul>\n  </div>\n  <div class="icon_list scrollable">\n    <ul>\n    </ul>\n  </div>\n</div>'}})}),define("ThisLife.View.Album.InviteesInviteeView",["ThisLife.View.Album.Invitees"],function(e){var t;return t=e.extend({className:"story_invitees_popover story_invitees_friends",update:function(){var e;return e=this.getInvitees(!1),this.populate(e)},template:function(){var e;return e=this.getOwnerName(this.model),'<div class="selection_popover_dropdown dropdown invitee_view">\n  <div class="icon_list list_header">\n    <ul>\n      <li class="view_only">\n        <div class="row">\n          <span class="status">Owner</span>\n          '+ThisLife.Helper.String.escapeHtml(e)+'\n        </div>\n      </li>\n    </ul>\n  </div>\n  <div class="icon_list scrollable">\n    <ul>\n    </ul>\n  </div>\n</div>'}})}),define("ThisLife.View.Album.InviteesListView",["ThisLife.View.Album.Invitees"],function(e){var t;return t=e.extend({className:"story_invitees_popover album_header",shareAlbum:function(){return ThisLife.PubSub.trigger("albumAction:share")},update:function(){var e;return e=this.getInvitees(!0),this.populate(e)},populate:function(){return t.__super__.populate.apply(this,arguments),this.model.isInvitee()?this.list:void 0},template:function(){var e;return e=0!==this.momentCount||this.getInvitees()?"":" disabled",'<div class="selection_popover_dropdown dropdown">\n  <div class="icon_list scrollable">\n    <ul></ul>\n  </div>\n</div>'}})}),ThisLife.View||(ThisLife.View={}),(e=ThisLife.View).Album||(e.Album={}),ThisLife.View.Album.Invitees=require("ThisLife.View.Album.Invitees"),ThisLife.View.Album.InviteesOwnerView=require("ThisLife.View.Album.InviteesOwnerView"),ThisLife.View.Album.InviteesInviteeView=require("ThisLife.View.Album.InviteesInviteeView"),ThisLife.View.Album.InviteesListView=require("ThisLife.View.Album.InviteesListView")}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}},t=[].slice;define("ThisLife.Albums.Controllers.Albums",["PMCHeimdall","ThisLife.Helper.Features","ThisLife.View.ModalAlert","ThisLife.Heimdall.Views.ActionMenu","ThisLife.Heimdall.Views.Breadcrumb","ThisLife.View.Album.LockAlbumButton","ThisLife.Album.Views.UnshareModal","ThisLife.Albums.Views.Banners.AlbumHeaderOwner","ThisLife.Albums.Views.Banners.AlbumHeaderShared","ThisLife.Albums.Views.Banners.EmptyAlbumFooter","ThisLife.View.Album.HeimdallLayout","ThisLife.PubSub","ThisLife.View.SpinnerModal","ThisLife.Albums.Helpers","ThisLife.Albums.Controllers.ShareWidget"],function(i,n,o,s,r,l,a,u,c,d,h,p,f,m,g){var v;return v=function(){function o(t){this.updateHeaderSelectAll=e(this.updateHeaderSelectAll,this);var i;this._master=ThisLife.Model.Albums.Master,this.listViewObj=new ThisLife.Albums.View.List(t),this._listViewContainer=this._getListViewContainer(),this._timelineContainer=$(h)[0],this._viewEl=this._timelineContainer.querySelector("#timeline_view"),this._loadingEl=this._timelineContainer.querySelector(".loading"),this._appendTimelineContainer(),this._sort=new ThisLife.Model.AlbumSort,this._views={},this._shareUrl={},g.bootstrap(),this._isChangingCover=!1,this._isSelectionMode=!1,ThisLife.PubSub.on("state:preChangeTo:albums",this._preStateChange,this).on("state:change",this._stateChange,this).on("modal:show",this._modalShowChange,this).on("modal:close",this._modalCloseChange,this),this._master.on("reset",function(e){return function(){return e._updateNavUnreadCount(),e._master.getAllAlbums().on("add remove change:permission.accepted change:last_viewed",e._updateNavUnreadCount,e).on("remove",e._checkActiveAlbum,e).on("change:cover_moment_uid",e._coverChange,e).on("change:cover_effects_modified_date",e._coverChange,e).on("change:visible_moment_count",e._checkLoadingStatus,e)}}(this)),i=document.getElementById("album_list_view"),null!=i&&i.classList.add("albumheader")}return _.extend(o.prototype,Backbone.Events),o.prototype.firstLoad=!0,o.prototype._appendTimelineContainer=function(){var e;return null!=(e=this.listViewObj.el.querySelector("#tree-view"))?e.appendChild(this._timelineContainer):void 0},o.prototype._getListViewContainer=function(){return this.listViewObj.el.querySelector("#albums-list")},o.prototype.isActive=function(){return!!this._album},o.prototype.getShareURL=function(e){var t,i,n;return n=e.uid,t=e.callback||_.bind(this._getShareURLCallback,this),i=function(){var e;return e=["link","facebook"],ThisLife.Service.api.getAlbumInviteLink(n,e,t)},this._shareUrl.hasOwnProperty(n)&&this._shareUrl[n][e.channel]?this._shareUrl[n][e.channel]:(i(),!1)},o.prototype._getShareURLCallback=function(e,t){return this._shareUrl[e]={facebook:t.result.payload.facebook,link:t.result.payload.link},p.trigger("Album:getShareURL",t.result.payload.link)},o.prototype.removeShareURL=function(e){return delete this._shareUrl[e]},o.prototype.isActiveStory=function(e){return this._album&&this._album.get("uid")===e},o.prototype.getCoverChangeStatus=function(){return this._isChangingCover},o.prototype.setCoverChangeStatus=function(e){return e?(this._isChangingCover=!0,this.updateOptions({read_only:!0}),this.oldCoverMomentUid=this._album.get("cover_moment_uid"),this.timeline.updateObjects({uid:this.oldCoverMomentUid,selected:!0,disabled:!0}),this._views.breadcrumb.disable(),this._views["action-menu"].disable()):(this._isChangingCover=!1,this.updateOptions({read_only:!1},{clear_scroll_id:!0}),this.oldCoverMomentUid?(this.timeline.updateObjects({uid:this.oldCoverMomentUid,selected:!1,disabled:!1}),this.oldCoverMomentUid=null,this._views.breadcrumb.enable(),this._views["action-menu"].enable()):void 0)},o.prototype.getSelectionStatus=function(){return this._isSelectionMode},o.prototype.setSelectionStatus=function(e){return this._isSelectionMode=e?!0:!1},o.prototype.getCollection=function(){return this._collection},o.prototype.getCurrentAlbum=function(){return this._album},o.prototype.openShareModal=function(e){return null==e&&(e={}),n.whenReady("share",function(t){return function(i){return i?t._useNewShareWidget():t._oldShareModal(e)}}(this))},o.prototype._oldShareModal=function(e){var t,i,n;return null==e&&(e={}),i={modalClass:"share_album_modal",width:"726",height:"628",fullPagePoint:"mediumScreen",title:"Share this album",childView:new ThisLife.View.Album.SharePopup,buttons:[{type:"orange_button",onclick:this._shareAlbum,text:"INVITE",noSubtext:!0},{type:"unshare",onclick:this._unshareModal.bind(this),text:"Unshare album",noSubtext:!0}]},t=this.getCurrentAlbum()||this._master.getAlbumById(ThisLife.currentStory.get("uid")),t.isOwner(ThisLife.currentLifeOwner)&&(i.leftButtonView=new l),i=_.extend(i,e),ThisLife.app.controller("appmodal").get("album_share").renderView(i).disableButton("orange_button"),t.isFriendsAlbum()&&ThisLife.app.controller("appmodal").get("album_share").hideButton("unshare"),0===(null!=(n=t.followers)?n.length:void 0)?ThisLife.app.controller("appmodal").get("album_share").disableButton("unshare"):void 0},o.prototype._useNewShareWidget=function(){return g.load({trackingEventLocation:"AlbumHeader:click-share"})},o.prototype._unshareModal=function(){var e;return e={modalClass:"unshare-album-modal",width:"490",height:"200",title:"Unshare Album with all?",disableClose:!0,childView:new a,backButton:"CANCEL",buttons:[{type:"orange_button",onclick:this._unshareAlbum.bind(this),text:"UNSHARE",noSubText:!0}]},ThisLife.app.controller("appmodal").get("album_revoke").renderView(e)},o.prototype._shareAlbum=function(){return ThisLife.PubSub.trigger("albumAction:share")},o.prototype._unshareAlbum=function(){var e;return null!=(e=this._album)&&e.followers.reset(),p.trigger("unshare:removeInvitee",!0),ThisLife.app.controller("appmodal").destroy("album_share"),ThisLife.app.controller("appmodal").destroy("album_revoke"),ThisLife.app.controller("toast")["new"]({text:"Album unshared"}),ThisLife.Service.api.unshareAlbum(ThisLife.currentStory.get("uid"),_.bind(this.removeShareURL,this)),ThisLife.Service.api.lockAlbum(ThisLife.currentStory.get("uid"),!1),ThisLife.app.controller("tracking").logAlbumUnshare()},o.prototype.getAlbumById=function(e){return this._master.getAlbumById(e)},o.prototype.noMoments=function(){return!this._collection||0===this._collection.getMoments().length},o.prototype.getMoment=function(e){var t;return null!=(t=this._collection)?t.get(e):void 0},o.prototype.setMoment=function(e,t,i){var n;return null!=(n=this._collection)?n.setModel(e,t,i):void 0},o.prototype.resetPosition=function(){var e;return null!=(e=this.timeline)?e.updatePosition(0):void 0},o.prototype.centerOnMoment=function(e){return null!=this.timeline?this.timeline.scrollToObject(e):void 0},o.prototype.hideMoment=function(){return this._updateTimeline()},o.prototype.deleteMoments=function(e){var t,i,n,o,s,r;if(this._collection){for(o=[],t=0,i=e.length;i>t;t++)r=e[t],n=this.getMoment(r),n&&(null!=(s=this._collection)&&s.deleteMoment(n,{silent:!0}),o.push(n));return this._updateTimeline()}},o.prototype.removeMoments=function(e,t){var i;if(e===(null!=(i=this._album)?i.id:void 0))return null!=this.timeline&&(_.isArray(t)||(t=[t]),this.timeline.removeObjects(t)),this.deleteMoments(t)},o.prototype.restoreMoments=function(e){var t;return t=_.pluck(e,"id"),this.updateObjects(t,{hidden:!1})},o.prototype.hideMoments=function(e,t){var i;return i=_.sortBy(e,this._sort.momentComparator),_.delay(function(e){return function(){var n;return e._updateTimeline(),null!=(n=e._uploadAlbumView)?n.listenForHiddenUpdates(i,t):void 0}}(this),300)},o.prototype.addMoments=function(e,t){var i,n,o,s,r,l,a,u;if(ThisLife.Model.Albums.Master.loaded&&null!=(a=ThisLife.Model.Albums.Master.getAlbumById(e))&&a.completePendingUploads(_.pluck(t,"uid")),this._collection&&e===this._album.id){for(i=[],n=0,o=t.length;o>n;n++)r=t[n],s=this.getMoment(r.uid),s||(s=null!=(u=this._collection)?u.addMoment(r,{silent:!0}):void 0,l=_.extend({},s.attributes),delete l.child,delete l.collection,this._album.isOwner(ThisLife.currentLifeOwner)&&!s.canEdit()?_.extend(l,{actions:{favorite:{hidden:!0}}}):this._album.isOwner(ThisLife.currentLifeOwner)||s.canEdit()||_.extend(l,{actions:{favorite:{disabled:!0},remove:{disabled:!0}}}),i.push(l));return null!=this.timeline?(this.timeline.addObjects(i),this._updateBanners()):void 0}},o.prototype.dateMoments=function(e,t,i){var n,o,s,r,l,a,u,c,d,h;if(this._collection&&e===this._album.id){for(l=[],n=0,o=t.length;o>n;n++)h=t[n],s=this.getMoment(h),s&&(a=s.get("moment_date"),r=s.updateDate(i,{silent:!0}),this.setMoment(s.id,{moment_date:r},{silent:!0}),ThisLife.Helper.Date.areSameDay(a,s.get("moment_date"))||(null!=(u=this._collection)&&u.removeFromDateCollection(s,{prevDate:a,silent:!0}),l.push(s)));return null!=(c=this._collection)&&c.remove(l,{silent:!0}),d=function(e){return function(){var t,i,n,o;for(null!=(n=e._collection)&&n.add(l,{silent:!0}),t=0,i=l.length;i>t;t++)s=l[t],null!=(o=e._collection)&&o.buildDateCollection(s,{silent:!0});return e._updateForAddedMoments(l,{maintainPosition:!1})}}(this),this._updateTimeline()}},o.prototype.rotateMoments=function(e,t){var i,n,o,s,r;if(this._collection)for(s=[],i=0,n=e.length;n>i;i++)r=e[i],o=this.getMoment(r),o&&(o.rotate(t),s.push(o));return this.updateAlbumCover(e)},o.prototype.updateAlbumCover=function(e){var t,i,n,o;for(n=[],t=0,i=e.length;i>t;t++)o=e[t],this.model=this._master.getAlbumByCoverMomentId(o),this.model?(this.updatedMoment=_.find(ThisLife.app.library.getCollection().models,{id:o}),n.push(this.updatedMoment?this.model.set({cover_effects_modified_date:this.updatedMoment.attributes.effects_modified_date,height:this.updatedMoment.attributes.height,orig_height:this.updatedMoment.attributes.height,width:this.updatedMoment.attributes.width,orig_width:this.updatedMoment.attributes.width}):void 0)):n.push(void 0);return n},o.prototype.cropMoment=function(e,t,i){var n;if(this._collection&&e===this._album.id&&(n=this.getMoment(t)))return n.crop(i)},o.prototype.filterMoment=function(e,t){var i;if(this._collection&&e===this._album.id&&(i=this.getMoment(t)))return i.filter()},o.prototype.momentEdited=function(e,t,i,n){var o,s,r,l;if(this._collection&&(!e||e===this._album.id)&&(s=this.getMoment(t)))return null!=this.timeline&&(i._explicitType&&delete i._explicitType,i.__className&&delete i.__className,l={},r=!1,o=_.keys(i),_.each(o,function(e){if("upload_date"===e||"moment_date"===e){if(s.get(e)!==1e3*i[e])return l[e]=1e3*i[e],r=!0}else if(s.get(e)!==i[e])return l[e]=i[e],r=!0}),r)?(this.updateObjects(t,l),s=this.setMoment(t,i,n)):void 0},o.prototype.whenLoaded=function(){var e,i,n,o;return i=arguments[0],n=arguments[1],e=3<=arguments.length?t.call(arguments,2):[],this._loaded?i.apply(n,e):(o=function(){return i.apply(n,e),this.off("loaded",o,this)},this.on("loaded",o,this))},o.prototype._show=function(e){var t,n;return this._loadingEl.classList.remove("hidden"),document.body.classList.add("grid-view"),ThisLife.currentStory=this._album=e,ThisLife.storyUid=this._album.get("uid"),n=function(t){return function(){var n,o,l,a,u,c,d;return t._loadRequest=null,t._noCover=!e.get("cover_moment_uid"),t._noCover&&e.set("view_mode","grid",{silent:!0}),t._sortUpdate(e.get("sort_option")),null!=(a=t._collection)&&a.off(),t._collection=new ThisLife.Collection.StoryMomentsCollection,t._collection.initialSet(t._album.moments,t._sort.toOptions()),n={},n=ThisLife.app.isMobile?{top:[{"class":"favorite"},{"class":"view",action:"view"}]}:{top:[{"class":"favorite",action:"favorite"},{"class":"view",action:"view"}],bottom:[{"class":"remove",action:"remove"}]},o="large",c=t._album.get("sort_option"),null!=c?(u=c.split(":")[0],d="desc"===c.split(":")[1]?!0:!1):(u="moment_date",d=!1),t._views.hasOwnProperty("breadcrumb")?t._views.breadcrumb.update({model:t._album,collection:t._collection,selected:t._allSelected(),show_album:!1}):t._views.breadcrumb=new r({model:t._album,collection:t._collection,controller:t,selected:t._allSelected(),show_album:!1}),t._views.hasOwnProperty("action-menu")?t._views["action-menu"].update({model:t._album,collection:t._collection,controller:t}):t._views["action-menu"]=new s({model:t._album,collection:t._collection,controller:t}),l={actionbar_options:{position:"top",sections:{left:[{view:t._views.breadcrumb,name:"breadcrumb"}],center:[{view:"layout-size"}],right:[{view:t._views["action-menu"],name:"action-menu"}]}},clickCallback:_.bind(t._clickHandler,t),trackingCallback:_.bind(t._heimdallTracking,t),container:t._viewEl,environment:ThisLife.Settings.sflyEnv,layout:"VerticalCondensed",layout_options:{date_summary:{mobile:!0},default_size:o,group_by_attr:u,lock_drawer:ThisLife.app.isMobile,group_objects:!0,moment_icons:n,object_id_attr:"uid",object_sizes:{small:{min_height:125,max_height:150},large:{min_height:200,max_height:300},mobile:{min_height:125,max_height:180}},offsets:{top:102,left:20,right:20,object:6},reverse_sort:d,sort_by_attr:u},life_uid:null,scrubber:"Basic",scrubber_options:{show_markers:!1,show_needle:!1,show_tooltip:!1,vertical:!0}},ThisLife.app.whenReady(function(){return l.life_uid=ThisLife.currentLifeOwner,ThisLife.Collection.moments.whenLoaded(function(){var e,n;
return t._loaded=!0,t.trigger("loaded"),t._loadingEl.classList.add("hidden"),n=[],t._collection.models.forEach(function(e){var i;return i=_.extend({},e.attributes),t._album.isOwner(ThisLife.currentLifeOwner)&&!e.canEdit()?_.extend(i,{actions:{favorite:{hidden:!0}}}):t._album.isOwner(ThisLife.currentLifeOwner)||e.canEdit()||_.extend(i,{actions:{favorite:{hidden:!0},remove:{disabled:!0}}}),n.push(i)}),t.timeline?(t.timeline.clearObjects(),t.timeline.setFirstImageLoaded(!1),delete l.layout_options.default_size,t.timeline.updateLayoutOptions(l.layout_options),t.timeline.addObjects(n),t._updateBanners(),t.timeline.updatePosition(0)):(t.timeline=new i(n,l),t._updateBanners(),t.timeline.updatePosition(0)),"function"==typeof(e=t._headerView)._setInputWidth?e._setInputWidth():void 0})})}}(this),t=function(e){return function(){return e._loadRequest=null,ThisLife.currentStory=null,ThisLife.storyUid=null,ThisLife.app.router.back()}}(this),this._loadRequest=this._album.load(n,t,!1,!0)},o.prototype._bannerUpdateCallback=function(e){return null==e&&(e={}),e.hasOwnProperty("visible")?e.visible?(this._views.breadcrumb.update({selected:this._allSelected(),show_album:!1}),this._views["action-menu"].update({show_actions:!0}),this.timeline.actionbar.el.classList.remove("is-alternative")):(this._views.breadcrumb.update({selected:this._allSelected(),show_album:!0}),this._views["action-menu"].update({show_actions:!1}),this.timeline.actionbar.el.classList.add("is-alternative")):void 0},o.prototype._clickHandler=function(e,t,i){var n,o,s,r,l,a,u,c,d,h,p;for(_.isArray(e)||(e=[e]),s=[],r=0,l=e.length;l>r;r++)p=e[r],a=this._collection.get(p),s.push(a);if(this.getCoverChangeStatus())return void("click"===t&&ThisLife.app.controller("selection").addModels(s[0],{silent:!0}));switch(t){case"delete":ThisLife.app.controller("selection").removeModels(s),ThisLife.app.controller("trash")["delete"](e);break;case"remove":this._removeFromAlbum(e);break;case"favorite":this._favoriteMoments(s);break;case"play":this._playVideo(s[0]);break;case"click":ThisLife.app.controller("selection").toggleModels(s[0],{event:i,storyUid:this._album.id});break;case"select":s.length>1?(n=_.every(s,function(e){return ThisLife.app.controller("selection").hasModel(e)}),n?ThisLife.app.controller("selection").removeModels(s):ThisLife.app.controller("selection").addModels(s,{event:i,storyUid:this._album.id})):ThisLife.app.controller("selection").toggleModels(s[0],{event:i,storyUid:this._album.id}),this._trackEvent("month_pill");break;case"sort":c="moment_date"===i?"moment_date:asc":"upload_date:desc",this._album.setSort(c),o="moment_date"===i?"momentDate":"uploadDate",d=c.split(":")[0],h="desc"===c.split(":")[1]?!0:!1,this.timeline.updateLayoutOptions({group_by_attr:d,reverse_sort:h,sort_by_attr:d});break;case"view":null==(null!=(u=ThisLife.app.controller("selection"))?u.getAlbumCollection():void 0)&&ThisLife.app.router.navigateToAlbumFullView(this._album.id,s[0].id);break;case"layout-change":this._trackEvent(i.size+"_view")}},o.prototype._heimdallTracking=function(e){return e.constructor===Array?_.each(e,function(e){return function(t){return e._trackMetric(t)}}(this)):this._trackMetric(e)},o.prototype._trackMetric=function(e){return"time"===e.type&&"firstPhoto"===e.name?ThisLife.app.controller("timing").loadOrNavigateEvent("Album",e.value):"click"!==e.type?ThisLife.app.controller("tracking").logClickTimeline(e.name,e.type):void 0},o.prototype._favoriteMoments=function(e){return ThisLife.app.controller("selection").getActions()._favorite({models:e})},o.prototype._removeFromAlbum=function(e){return ThisLife.app.controller("selection").getActions()._removeFromAlbum({storyUid:this._album.get("uid"),uids:e,callback:_.bind(this._showFlyout,this)})},o.prototype._showUpload=function(e){return n.whenReady("upp",function(t){return function(i){var n,o,s;return i?(n=e.get("uid"),ThisLife.app.router.navigateToAlbum(n),ThisLife.app.controller("uploader").upp({albumId:n,show_sfly:!0,labelsContext:"upload"})):(document.body.classList.add("upload"),$(t._timelineContainer).hide(),ThisLife.currentStory=t._album=e,ThisLife.storyUid=t._album.get("uid"),t._uploadAlbumView=new ThisLife.Albums.View.AlbumUploadView({album:t._album}),$("#tree-view").append(t._uploadAlbumView.el),t._uploadAlbumView.showLoading(),s=function(){var e;return t._loadRequest=null,null!=(e=t._collection)&&e.off(),t._collection=new ThisLife.Collection.StoryMomentsCollection,t._collection.initialSet(t._album.moments,t._sort.toOptions()),t._uploadAlbumView.render(t._collection)},o=function(){return t._loadRequest=null,ThisLife.currentStory=null,ThisLife.storyUid=null,ThisLife.app.router.back()},t._loadRequest=t._album.load(s,o))}}(this))},o.prototype._teardownForCurrentAlbum=function(){var e,t,i,n;return null!=(e=this._loadRequest)&&e.abort(),this._album=null,null!=(t=this._collection)&&t.off(),this._collection=null,this._loaded=!1,null!=(i=this._noMomentsView)&&i.remove(),this._noMomentsView=null,null!=(n=this._uploadAlbumView)&&n.remove(),this._uploadAlbumView=null,this._teardownLayout()},o.prototype._teardownLayout=function(){var e,t;return null!=(e=this._headerView)&&e.teardown(),null!=(t=this._footerView)&&t.teardown(),this.timeline?(this.timeline.updateLayoutOptions({banners:{header:void 0,footer:void 0}}),this.timeline.clearObjects()):void 0},o.prototype._updateTimeline=function(){return this._updateBanners()},o.prototype._updateBanners=function(){var e,t,i,n,o;return null!=(i=this._headerView)&&i.teardown(),this._headerView=this._album.isInvitee()?new c({model:this._album,collection:this._collection,controller:this}):new u({model:this._album,collection:this._collection,controller:this}),e=this._headerView.getHeaderHeight(document.body.clientWidth),this._headerOptions={el:this._headerView.el,height:e,update:_.bind(this._bannerUpdateCallback,this),updateDimensions:_.bind(this._updateHeaderDimensions,this)},null!=(n=this._footerView)&&n.teardown(),this._footerOptions=void 0,0===(null!=(o=this._collection)?o.getMoments().length:void 0)?(this._footerView=new d({model:this._album}),this._footerOptions={el:this._footerView.el,height:180},t={actions:{disabled:!0}},this._views["action-menu"].disable()):(t={actions:{disabled:!1}},this._views["action-menu"].enable()),this.timeline.updateLayoutOptions(_.extend({},{banners:{header:this._headerOptions,footer:this._footerOptions}},t))},o.prototype._updateHeaderDimensions=function(e){var t;return t=this._headerView?this._headerView.getHeaderHeight(e.width):0,{height:t}},o.prototype._updateForAddedMoments=function(e,t,i){return null==t&&(t={maintainPosition:!0}),this.timeline&&e&&e.length?"function"==typeof i?i():void 0:void("function"==typeof i&&i())},o.prototype._preStateChange=function(){return ThisLife.PubSub.trigger("addLoader")},o.prototype._stateChange=function(e){var t,i,n,o,s,r,l,a,u,c,d,h,p,f,g,v,_,b,w,y,T,L,S;if("albums"!==e.name)return this.albumState=null,void this._teardownForCurrentAlbum();if("albums"===e.name){if(ThisLife.app.controller("tracking").setTestVariation("show_header"),n=document.getElementById("tl_bottom_bar"),n.classList.add("vertical"),n.querySelector(".help_btn").classList.remove("hidden-xs"),this.getCoverChangeStatus()&&(ThisLife.app.controller("selection").done(),this.setCoverChangeStatus(!1)),"albums"===(null!=(s=e.previous)?s.name:void 0)&&"album"===(null!=(r=e.previous)&&null!=(p=r.options)?p.view:void 0)&&"folder"===(null!=(f=e.options)?f.view:void 0)&&ThisLife.app.controller("selection").isActive()&&ThisLife.app.controller("selection").done(),"albums"===(null!=(g=e.previous)?g.name:void 0)&&"upload"===(null!=(v=e.previous.options)?v.view:void 0)&&"folder"===(null!=(_=e.options)?_.view:void 0)&&(i=e.previous.options.album_uid))return void ThisLife.app.router.navigateToAlbum(i,{replace:!0,trigger:!0});if("library"===(null!=(b=e.previous)?b.name:void 0)&&"albums"===(null!=(w=e.previous.previous)?w.name:void 0)&&"upload"===(null!=(y=e.previous.previous.options)?y.view:void 0)&&ThisLife.app.controller("selection").isActive()&&(ThisLife.app.controller("selection").done(),i=e.previous.previous.options.album_uid))return void ThisLife.app.router.navigateToAlbumUpload(i,{replace:!0,trigger:!0})}if(null!=this._collection&&(T=0===this._collection.getMoments().length),o=this.albumState,this.albumState=e,!("album"!==(l=null!=o&&null!=(a=o.options)?a.view:void 0)&&"full"!==l||"album"!==(u=null!=(c=this.albumState.options)?c.view:void 0)&&"full"!==u||o.options.album_uid!==this.albumState.options.album_uid))return document.body.classList.add("grid-view"),void ThisLife.PubSub.trigger("removeLoader");switch(this._teardownForCurrentAlbum(),null==e.options&&ThisLife.app.router.back(),ThisLife.PubSub.trigger("removeLoader"),$(this._listViewContainer).show(),$(this._timelineContainer).hide(),null!=(null!=(d=e.options)?d.toggleFolders:void 0)?L=e.options.toggleFolders:this.firstLoad&&"albums"!==(null!=(h=e.previous)?h.name:void 0)?(L=!1,S=function(e){return function(){return m.isTreeOpen()?e.listViewObj.toggleFolders():void 0}}(this),setTimeout(S,0)):L=m.isTreeOpen(),this.firstLoad=!1,document.body.classList.contains("bucket-no-scroll")&&document.body.classList.remove("bucket-no-scroll"),e.options.view){case"all":return this.listViewObj.toggleFolders(null,{type:"all",toggleFolders:L});case"friends":return this.listViewObj.toggleFolders(null,{type:"shared",toggleFolders:L});case"suggested":return this.listViewObj.toggleFolders(null,{type:"auto",toggleFolders:L});case"folder":return this.listViewObj.toggleFolders(null,{type:"folder",folder_uid:e.options.folder_uid,toggleFolders:L}),document.body.classList.add("bucket-no-scroll");case"album":return $(this._listViewContainer).hide(),$(this._timelineContainer).show(),this.listViewObj.toggleFolders(null,{type:"album",album_uid:e.options.album_uid,toggleFolders:L}),t=this._master.getAlbumById(e.options.album_uid),t?t.isOwner(ThisLife.currentLifeOwner)||t.get("permission.view_only")!==!0&&t.get("locked")!==!0||0!==t.get("visible_moment_count")||0!==t.pendingUploads.length?this._show(t,e.options.moment_uid):(ThisLife.app.router.navigateToAlbums({replace:!0,trigger:!0}),new ThisLife.Albums.View.Modals.EmptySharedAlbum):ThisLife.app.router.back();case"upload":if($(this._listViewContainer).hide(),$(this._timelineContainer).show(),this.listViewObj.toggleFolders(null,{type:"album",album_uid:e.options.album_uid,toggleFolders:L}),t=this._master.getAlbumById(e.options.album_uid))return t.isViewOnly()?ThisLife.app.router.navigateToAlbum(t.id,{replace:!0,trigger:!0}):this._showUpload(t);break;default:return ThisLife.app.router.back()}},o.prototype._modalShowChange=function(){},o.prototype._modalCloseChange=function(){},o.prototype._hiddenInCollectionChange=function(e,t,i){return(null!=i?i.ignoreForLayout:void 0)||(t?this._updateTimeline():this._updateForAddedMoments([e],{maintainPosition:!0})),this.trigger("change:visibleMoments"),t?ThisLife.app.controller("selection").removeModels([e]):void 0},o.prototype._updateNavUnreadCount=function(){var e;return e=function(){return ThisLife.PubSub.trigger("albums:unread")},setTimeout(e,1)},o.prototype._checkActiveAlbum=function(e){var t,i;return(null!=(i=this._album)?i.id:void 0)===e.id?(t=this.listViewObj.el.querySelector('.folder-item[data-uid="'+e.id+'"] .selected'),t?ThisLife.app.router.navigateToFolder(e.get("folder_uid")):ThisLife.app.router.navigateToAlbums()):void 0},o.prototype._coverChange=function(e){var t,i;if(e.id===(null!=(i=this._album)?i.id:void 0))return t={cover_moment_uid:e.get("cover_moment_uid"),cover_owner_uid:e.get("cover_owner_uid"),cover_effects_modified_date:e.get("cover_effects_modified_date")},this.setCoverChangeStatus(!1)},o.prototype._checkLoadingStatus=function(e){var t;e.id!==(null!=(t=this._album)?t.id:void 0)||!e.loaded},o.prototype._sortUpdate=function(e,t){switch(null==t&&(t=!1),e){case"filename:asc":return this._sort.setToByFilename();case"upload_date:desc":return this._sort.setToByUploadDateReverse();case"moment_date:asc":return this._sort.setToByMomentDate()}},o.prototype._showFlyout=function(e){var t;return t="Photo removed from album",e&&(t="We encountered an error"),ThisLife.app.controller("toast")["new"]({text:t})},o.prototype.updateObjects=function(e,t){var i,n,o,s,r;if(null!=this.timeline&&(this.getCoverChangeStatus()&&!t.selected||!this.getCoverChangeStatus())){for(_.isArray(e)||(e=[e]),s=[],i=0,n=e.length;n>i;i++)o=e[i],s.push(_.extend({uid:o},t));r=this.timeline.updateObjects(s)}return _.defer(function(e){return function(){return e.updateHeaderSelectAll()}}(this))},o.prototype.updateOptions=function(e,t){var i;return null!=(i=this.timeline)?i.updateLayoutOptions(e,t):void 0},o.prototype._playVideo=function(e){var t;return null!=e?(_.contains(_.pluck(afterglow.lightboxtriggers,"playerid"),"video-"+e.id)||(document.body.insertAdjacentHTML("beforeend",this._playerTemplate(e)),afterglow.prepareLightboxVideos(),null!=(t=$("#video-container-"+e.id))&&t.remove()),afterglow.play("video-"+e.id),ThisLife.app.isMobile&&this.el.classList.add("mobile_hover"),_.defer(function(){var t;null!=(t=document.getElementById("video-"+e.id))&&t.focus(),afterglow.getPlayer("video-"+e.id)&&(afterglow.getPlayer("video-"+e.id).on("ended",function(){document.getElementById("video-"+e.id).focus()}),afterglow.getPlayer("video-"+e.id).on("error",function(){$("#video-"+e.id).click(function(){afterglow.closeLightbox()})}))})):void 0},o.prototype._playerTemplate=function(e,t){var i,n,o;return null==t&&(t={width:e.get("width"),height:e.get("height")}),n=e.get("story_moment_created_by")||ThisLife.currentLifeOwner,i=ThisLife.Settings.s3VideoUrl+"/"+n+"/"+e.id+"_medium.mp4",o=ThisLife.Settings.s3VideoUrl+"/"+n+"/"+e.id+"_small.mp4",'<div id="video-container-'+e.id+'" style="display: none;">\n  <a class="afterglow action_video" href="#video-'+e.id+'"></a>\n  <video id="video-'+e.id+'" data-skin="dark" width="'+t.width+'" height="'+t.height+'" data-autoresize="fit">\n    <source type="video/mp4" src="'+i+'" data-quality="hd">\n    <source type="video/mp4" src="'+o+'">\n  </video>\n</div>'},o.prototype._trackEvent=function(e){return ThisLife.app.controller("tracking").logClickAlbumAction(e)},o.prototype.startChangeCover=function(e,t){var i;return this.timeline.scrollToObject(this._album.get("cover_moment_uid")),i=function(t){return function(){return ThisLife.app.controller("selection").done(),t.timeline.updatePosition(0),e()}}(this),ThisLife.app.controller("selection").start({viewType:"albumCover",storyUid:this._album.id,doneCallback:i,cancelCallback:t})},o.prototype.getNextMoment=function(e,t){var i;return(null!=(i=this.timeline)?i.hasObjects():void 0)?this.timeline.nextObject(e,t):void 0},o.prototype.getPreviousMoment=function(e,t){var i;return(null!=(i=this.timeline)?i.hasObjects():void 0)?this.timeline.previousObject(e,t):void 0},o.prototype._allSelected=function(){var e;return(null!=(e=this.timeline)?e.allObjects({selected:!0}):void 0)?!0:!1},o.prototype.updateHeaderSelectAll=function(){var e,t;return null==this._headerView?!1:this._allSelected()?(this._headerView._selectAllEl.classList.add("selected"),null!=(e=this._views.breadcrumb)?e.update({selected:!0}):void 0):(this._headerView._selectAllEl.classList.remove("selected"),null!=(t=this._views.breadcrumb)?t.update({selected:!1}):void 0)},o.prototype.getFirstMoment=function(){var e;return e=this.timeline.getFirstObject(),"video"===(null!=e?e.moment_type:void 0)&&(e=this.getNextMoment(e.uid)),e.uid||e},o}()})}.call(this),function(){define("ThisLife.Albums.Controllers.ShareWidget",[],function(){var e;return e={_loaded:!1,_widget:null,bootstrap:function(){var e,t,i;if(!this._loaded)return e=ThisLife.Settings.sflyEnv,i="https://api2.shutterfly.com/frontendci/app/share-widget/env/"+e+"/current-version",t=function(e){return function(t){var i,n,o;return o=document.createElement("script"),o.src=t.rootUrl+"/dist/js/share.js",o.type="text/javascript",i=document.createElement("link"),i.href=t.rootUrl+"/dist/css/share.css",i.rel="stylesheet",n=function(){return e._loaded=!0},o.readyState?o.onreadystate=n:o.onload=n,document.head.appendChild(i),document.body.appendChild(o)}}(this),$.get(i,{},t,"json")},init:function(){return this._ctrl=ThisLife.app.controller("albums"),this._album=this._ctrl.getCurrentAlbum()||ThisLife.app.controller("albums").getAlbumById(ThisLife.storyUid),_.bindAll(this,"action","error","generateLink","sessionToken"),this._defaultOptions={callbacks:{action:this.action,error:this.error,generateLink:this.generateLink,session:this.sessionToken},data:{env:ThisLife.Settings.sflyEnv,invitees:this._buildInviteeList(),owner:this._album.isOwner(ThisLife.currentLifeOwner),locked:this._album.get("locked"),shared:this._album.get("shared"),type:"album",userId:ThisLife.Model.User.id,view:"home"}},this},load:function(e){return null==e&&(e={}),this.init(),this._album?(e.hasOwnProperty("callbacks")&&_.extend(this._defaultOptions.callbacks,e.callbacks),e.hasOwnProperty("data")&&_.extend(this._defaultOptions.data,e.data),this._widget?this._widget.update(this._defaultOptions):(this._widget=new(require("share-widget"))(this._defaultOptions),this._widget.init()),this._trackingEventLocation=e.trackingEventLocation,!0):void 0},unload:function(){return this._widget.unmount(!0),this._widget=null,!0},update:function(e){return this._widget.update(e),!0},action:function(e,t){var i;switch(null==e&&(e=""),null==t&&(t={}),e){case"shareLink":return this.unload(),this._album.set("shared",!0),"link"===t.type?ThisLife.app.controller("toast")["new"]({text:"Link copied to clipboard"}):"facebook"===t.type&&(t.locked!==this._album.get("locked")&&this._changeLockStatus(t.locked),ThisLife.app.controller("toast")["new"]({text:"Album shared via Facebook"})),ThisLife.app.controller("tracking").logAlbumShare("postFacebook"),this._datawarehouse(t.type);case"sendEmail":return this.unload(),t.recipients.forEach(function(e){return function(i){var n,o,s,r,l;return s=(null!=(r=i.name)?r.split(" "):void 0)||"",n=i.first_name?i.first_name:_.isArray(s)?s[0]:"",o=i.last_name?i.last_name:_.isArray(s)&&s.length>0?s[1]:"",l=e._album.followers.createStoryPermission({email_shared_with:i.email,first_name:n,last_name:o,message:t.message,story_uid:e._album.id.toString(),uid:$.Guid.New().toLowerCase(),view_only:e._album.get("locked")}),e._album.followers.add(l),l.saveStoryPermission()}}(this)),this._album.isOwner(ThisLife.currentLifeOwner)&&t.locked!==this._album.get("locked")&&this._changeLockStatus(t.locked),ThisLife.app.controller("toast")["new"]({text:"Album shared with "+t.recipients.length+" people"}),ThisLife.app.controller("tracking").logAlbumShare("postEmail"),this._datawarehouse("Email");case"close":return this.unload();case"update":if(i=this._album.id,t.hasOwnProperty("locked"))return this.update({data:{locked:t.locked}}),t.locked===!0?ThisLife.Service.api.lockAlbum(i,!0):ThisLife.Service.api.lockAlbum(i,!1);break;case"leaveAlbum":return this.unload(),ThisLife.Service.api.deleteAlbumPermission(this._album.get("permission.uid"));case"unshareAlbum":return this.unload(),ThisLife.Service.api.unshareAlbum(this._album.id),ThisLife.Service.api.lockAlbum(this._album.id,!1),this._album.followers.reset(),this._album.set("shared",!1),ThisLife.app.controller("toast")["new"]({text:"Album Unshared"}),ThisLife.app.controller("tracking").logAlbumUnshare();case"tracking":return this.handleTrackingAction(t);default:return console.log("Untracked action:",action,t)}},handleTrackingAction:function(e){var t,i;return null==e&&(e={}),t="album",(i=ThisLife.app.controller("tracking").logShareWidgetEvent(t))({event:e.event,launchTrigger:this._trackingEventLocation,view:e.view,value:e.value})},error:function(){return console.log("Something went wrong with the share widget.!")},generateLink:function(e){var t;return t=new Promise(function(t){return function(i){return t._getAlbumShareLink(t._album.id,e).then(function(t){return i({type:e,url:t})})}}(this))},sessionToken:function(){var e;return e=new Promise(function(e){return e(ThisLife.sessionToken)})},_buildInviteeList:function(){var e;return e=[],this._album.followers.models.forEach(function(t){var i,n,o,s;return n=t.get("first_name"),o=t.get("last_name"),s=n&&o?n+" "+o:null,i=t.get("email")||t.get("email_shared_with"),e.push({name:s,email:i})}),e},_getAlbumShareLink:function(e,t){var i;return i=new Promise(function(i){return function(n){return i._ctrl._shareUrl.hasOwnProperty(e)&&i._ctrl._shareUrl[e][t]?n(i._ctrl._shareUrl[e][t]):i._generatetAlbumShareLink(e,t).then(function(e){return n(e)})}}(this))},_generatetAlbumShareLink:function(e,t){var i;return i=new Promise(function(i){return function(n){var o;return o=function(e,o){return i._ctrl._shareUrl.hasOwnProperty(e)||(i._ctrl._shareUrl[e]={}),i._ctrl._shareUrl[e][t]=o.result.payload[t],n(o.result.payload[t])},ThisLife.Service.api.getAlbumInviteLink(e,[t],o)}}(this))},_datawarehouse:function(e){return ThisLife.Service.api.dataWarehouseLog({action:"share",date:Math.trunc(Date.now()/1e3),experience:ThisLife.isMobile?"m.web":"d.web",module:"share",shareDestination:e.capitalize(),shareType:"story",storyId:this._album.get("uid"),storyName:this._album.get("name"),userId:ThisLife.currentLifeOwner})},_changeLockStatus:function(e){return ThisLife.Service.api.lockAlbum(this._album.id,e)}}})}.call(this),function(){define("ThisLife.View.Album.HeimdallLayout",[],function(){return'<div class="timeline_container">\n  <div class="loading">\n    <div class="throbber throbber_large">\n      <div class="throbber_overlay"></div>\n    </div>\n  </div>\n  <div id="timeline_view"></div>\n</div>'})}.call(this),function(){define("ThisLife.Heimdall.Views.ActionMenu",["ThisLife.Helper.Features","ThisLife.View.SpinnerModal"],function(e,t){var i;return i=Backbone.View.extend({className:"album-action-menu",events:{"click .album-actions:not(.active):not(.disabled)":"_viewActionOptions","click .album-sort:not(.active):not(.disabled)":"_viewSortOptions"},initialize:function(e){return null==e&&(e={}),this.collection=e.collection,this.controller=e.controller,this.model=e.model,this.sort_type=this.model.get("sort_option"),this},render:function(){return this.el.insertAdjacentHTML("afterbegin",this._template()),e.whenReady("upp",function(e){return function(t){return e.useUPP=t,e._bindEvents(),e._cacheElements(),e._updateSortLabel()}}(this)),this},remove:function(){return this._unbindEvents(),i.__super__.remove.call(this),this.actions=null,this.sort=null,this},update:function(e){return null==e&&(e={}),e.hasOwnProperty("model")&&(this.model=e.model),this.sort_type=this.model.get("sort_option"),this._updateSortLabel(),e.hasOwnProperty("show_actions")&&(e.show_actions?(this.sort.classList.remove("hidden"),this.actions.classList.add("hidden")):(this.sort.classList.add("hidden"),this.actions.classList.remove("hidden"))),this},_cacheElements:function(){return this.actions=this.el.querySelector(".album-actions"),this.sort=this.el.querySelector(".album-sort"),this},_bindEvents:function(){return this.model.on("change:cover_moment_uid",this._coverChangeHandler,this)},_unbindEvents:function(){return this.model.off(null,null,this)},_getActionsOptions:function(){var e,t,i,n,o;return o=this.model.isInvitee()?!0:!1,n=ThisLife.app.controller("selection").isActive()?!0:!1,e={},t=[],t.push({type:"normal",value:"change_cover",label:"Change Cover Photo",disabled:n,onClick:_.bind(this._clickHandler,this)}),ThisLife.app.isMobile||(t=t.concat([{type:"normal",value:"add_photos",label:"Add Photos",disabled:this.model.isInvitee()&&this.model.isViewOnly()||n?!0:!1,onClick:_.bind(this._clickHandler,this)}])),t=t.concat([{type:"normal",value:"share",label:"Share",disabled:n,onClick:_.bind(this._clickHandler,this)},{type:"normal",value:"print_all",label:"Print All",disabled:n,onClick:_.bind(this._clickHandler,this)},{type:"normal",value:"make_book",label:"Make a Book",disabled:n,onClick:_.bind(this._clickHandler,this)},{type:"normal",value:"make_product",label:"Make a Product",disabled:n,onClick:_.bind(this._makeProductHandler,this)},{type:"divider",label:""},{type:"radio",name:"sort_order",value:"moment_date:asc",label:"Date Taken",selected:"moment_date:asc"===this.sort_type?!0:!1,disabled:o,onClick:_.bind(this._setSort,this)},{type:"radio",name:"sort_order",value:"upload_date:desc",label:"Date Uploaded",selected:"upload_date:desc"===this.sort_type?!0:!1,disabled:o,onClick:_.bind(this._setSort,this)},{type:"radio",name:"sort_order",value:"filename:asc",label:"File Name",selected:"filename:asc"===this.sort_type?!0:!1,disabled:o,onClick:_.bind(this._setSort,this)}]),e.items=t,e.styles={top:"40px",right:"-7px",width:"170px"},e.arrowAlign="right",e.onHide=_.bind(this._hideActions,this),this.model.isInvitee()&&(e.items=_.filter(e.items,function(e){var t;return!("change_cover"===(t=e.value)||"share"===t)})),ThisLife.app.isMobile&&(e.items=_.filter(e.items,function(e){var t;return!("change_cover"===(t=e.value))})),i=this.model.get("visible_moment_count")||0,e.items=20>i?_.filter(e.items,function(e){var t;return!("make_book"===(t=e.value))}):_.filter(e.items,function(e){var t;return!("make_product"===(t=e.value))}),e},_getSortOptions:function(){var e,t;return e=this.model.isInvitee()?!0:!1,t={items:[{type:"radio",name:"sort_order",value:"moment_date:asc",label:"Date Taken",selected:"moment_date:asc"===this.sort_type?!0:!1,disabled:e,onClick:_.bind(this._setSort,this)},{type:"radio",name:"sort_order",value:"upload_date:desc",label:"Date Uploaded",selected:"upload_date:desc"===this.sort_type?!0:!1,disabled:e,onClick:_.bind(this._setSort,this)},{type:"radio",name:"sort_order",value:"filename:asc",label:"File Name",selected:"filename:asc"===this.sort_type?!0:!1,disabled:e,onClick:_.bind(this._setSort,this)}],styles:{top:"25px",right:"-15px",width:"170px"},arrowAlign:"right",onHide:_.bind(this._hideSort,this)}},_updateSortLabel:function(e){var t,i;return"undefined"==typeof e&&(i=this._getSortOptions(),t=_.find(i.items,function(e){return function(t){return t.value===e.sort_type}}(this)),e=t.label),this.sort.querySelector("span.label-selected").textContent=e},_viewActionOptions:function(){return this.disabled?void 0:(this.actions.classList.add("active"),this._actionsDropdown?this._actionsDropdown.show():this._createActionsDropdown())},_viewSortOptions:function(){return this.disabled?void 0:(this.sort.classList.add("active"),this._dropdownView?this._dropdownView.show():this._createSortDropdown())},_createActionsDropdown:function(){return this._actionsDropdown=ThisLife.app.controller("flyout").get("album_actions").show(this._getActionsOptions()),this.actions.appendChild(this._actionsDropdown.el)},_createSortDropdown:function(){var e;return e=this._getSortOptions(),this._dropdownView=ThisLife.app.controller("flyout").get("album_sort").show(this._getSortOptions()),this.sort.appendChild(this._dropdownView.el)},_hideActions:function(){return this.actions.classList.remove("active"),this._actionsDropdown=null},_hideSort:function(){return this.sort.classList.remove("active"),this._dropdownView=null},_clickHandler:function(e){var t;switch(t=e.value){case"change_cover":this._changeCover();break;case"add_photos":this._addPhotosHandler();break;case"share":this._shareHandler();break;case"print_all":this._printAllHandler();break;case"make_book":this._makeBookHandler()}},_addPhotosHandler:function(){return ThisLife.app.controller("selection").done(),this.useUPP?ThisLife.app.controller("uploader").upp({albumId:this.model.id,show_sfly:!0}):ThisLife.app.router.navigateToAlbumUpload(this.model.id,{replace:!0,trigger:!0}),this._trackEvent("add_photos")},_changeCover:function(){var e,i;return this.controller.setCoverChangeStatus(!0),i=function(e){return function(){return e.controller.getCoverChangeStatus()?(e.controller.setCoverChangeStatus(!1),e._spinnerModalView&&e._spinnerModalView.teardown(),e._spinnerModalView=new t,document.body.appendChild(e._spinnerModalView.el)):void 0}}(this),e=function(e){return function(){return e.controller.setCoverChangeStatus(!1)}}(this),this.controller.startChangeCover(_.bind(i,this),e),this._trackEvent("change_cover")},_coverChangeHandler:function(){return this.controller.setCoverChangeStatus(!1),null!=this._spinnerModalView?this._spinnerModalView.teardown():void 0},_makeBookHandler:function(){return ThisLife.View.magicShop.doneShopping(),ThisLife.View.magicShop.on("collection:loaded",function(){return ThisLife.View.magicShop.startShopping(ThisLife.View.magicShop.collection,"photobook"),ThisLife.View.magicShop.off("collection:loaded")}),ThisLife.View.magicShop.getCurrentCollection(),this._trackEvent("make_book")},_makeProductHandler:function(){return ThisLife.View.magicShop.doneShopping(),ThisLife.View.magicShop.on("collection:loaded",function(){return ThisLife.View.magicShop.startShopping(this._collection,"photogifts",null,"albumaction"),ThisLife.View.magicShop.off("collection:loaded")}),ThisLife.View.magicShop.getCurrentCollection(),this._trackEvent("make_product")},_printAllHandler:function(){return ThisLife.View.magicShop.doneShopping(),ThisLife.View.magicShop.on("collection:loaded",function(){return ThisLife.View.magicShop.startShopping(ThisLife.View.magicShop.collection,"prints"),ThisLife.View.magicShop.off("collection:loaded")}),ThisLife.View.magicShop.getCurrentCollection(),this._trackEvent("print_all")},_shareHandler:function(){return ThisLife.app.controller("albums").openShareModal(),this._trackEvent("share")},_setSort:function(e){return this.sort_type=e.value,this.model.setSort(e.value),this.trigger("change:sort",e.value,!0),this._updateSortLabel(e.label),this._trackEvent("sort",e.value)},_trackEvent:function(e,t){return null==t&&(t=""),ThisLife.app.controller("tracking").logClickAlbumActionMenu(e,t)},_template:function(){return'<div class="album-sort">\n  <span class="label">Sort by</span>\n  <span class="label-selected"></span>\n</div>\n<div class="album-actions"></div>'},disable:function(){return this.el.classList.add("disabled"),this.disabled=!0},enable:function(){return this.el.classList.remove("disabled"),this.disabled=!1}})})}.call(this),function(){define("ThisLife.Heimdall.Views.Breadcrumb",["ThisLife.Model.Albums.Master"],function(e){var t;return t=Backbone.View.extend({className:"album-breadcrumb",events:{"click .folder-name":"_goBack","click .goback-icon":"_goBack","click .pill":"_selectAll"},initialize:function(e){return null==e&&(e={}),this.collection=e.collection,this.controller=e.controller,this.model=e.model,this.selected=e.selected,this.show_album=e.show_album,this},render:function(){return this.el.insertAdjacentHTML("afterbegin",this._template()),this._cacheElements(),this._bindEvents(),this.updateView(),this},remove:function(){var e;return null!=(e=this.el.parentNode)&&e.removeChild(this.el),this._unbindEvents(),this.albumEl=null,this.folderEl=null,this.pillEl=null,this},updateView:function(){return this._setFolderName(this._getFolderName()),this.show_album?(this.el.classList.add("is-alternative"),this._setAlbumName(this.model.get("name")),this._setPillCount(this.model.get("visible_moment_count"))):this.el.classList.remove("is-alternative"),this.selected?this.el.classList.add("selected"):this.el.classList.remove("selected")},update:function(e){return null==e&&(e={}),e.hasOwnProperty("model")&&(this._unbindEvents(),this.model=e.model,this._bindEvents()),e.hasOwnProperty("collection")&&(this.collection=e.collection),e.hasOwnProperty("selected")&&(this.selected=e.selected),e.hasOwnProperty("show_album")&&(this.show_album=e.show_album),this.updateView()},_cacheElements:function(){return this.albumEl=this.el.querySelector(".album-name"),this.folderEl=this.el.querySelector(".folder-name"),this.pillEl=this.el.querySelector(".pill"),this},_bindEvents:function(){var e,t;return this.model.on("change:name",this._nameChangeHandler,this),this.model.on("change:visible_moment_count",this._countChangeHandler,this),null!=(e=ThisLife.app.controller("selection"))&&e.on("start",this._onSelectStart,this),null!=(t=ThisLife.app.controller("selection"))&&t.on("done",this._onSelectDone,this),this},_unbindEvents:function(){return this.model.off(null,null,this),ThisLife.app.controller("selection").off(null,null,this),this},_nameChangeHandler:function(){return this._setAlbumName(this.model.get("name"))},_countChangeHandler:function(){return this._setPillCount(this.model.get("visible_moment_count"))},_goBack:function(){return this.controller.getCoverChangeStatus()||ThisLife.app.controller("selection").isActive()?void 0:this.model.isInvitee()?ThisLife.app.router.navigateToAlbumsFriends():ThisLife.app.router.navigateToAlbums()},_selectAll:function(){var e;if(!this.controller.getCoverChangeStatus()&&(e=_.pluck(this.collection.models,"id"),!_.isEmpty(e)))return this.collection.areAllSelected()?(ThisLife.app.controller("selection").done(),this.controller.updateObjects(e,{selected:!1}),this.el.classList.remove("selected")):(ThisLife.app.controller("selection").addModels(this.collection.getMoments(),{storyUid:this.model.id}),this.controller.updateObjects(e,{selected:!0}),this.el.classList.add("selected"))
},_getFolderName:function(){var t,i;return t=e.getFolderById(this.model.get("folder_uid")),t?i=t.get("name"):this.model.isFriendsAlbum()?i="Shared With Me":this.model.isAutoAlbum()?i="Auto Album":this.model.isLifetouchAlbum()&&(i="Lifetouch"),i},_setFolderName:function(e){var t,i;return null==e&&(e=""),null!=(t=this.folderEl)&&(t.textContent=e),null!=(i=this.folderEl)?i.setAttribute("title",e):void 0},_setAlbumName:function(e){var t,i;return null==e&&(e=""),null!=(t=this.albumEl)&&(t.textContent=e),null!=(i=this.albumEl)?i.setAttribute("title",e):void 0},_setPillCount:function(e){var t;return null==e&&(e="0"),null!=(t=this.pillEl)?t.textContent=e:void 0},_onSelectStart:function(){return this.disable()},_onSelectDone:function(){return this.enable()},_template:function(){return'<div class="goback-icon"></div>\n<div class="folder-name"></div>\n<div class="album-name"></div>\n<div class="pill"></div>'},disable:function(){return this.el.classList.add("disabled")},enable:function(){return this.el.classList.remove("disabled")}})})}.call(this),function(){define("ThisLife.Albums.Views.Banners.AlbumHeader",["ThisLife.Helper.DOM","ThisLife.Helper.Features","ThisLife.View.Album.InviteesListView","ThisLife.Albums.Controllers.ShareWidget","ThisLife.Selection.Helpers.Actions","ThisLife.View.SpinnerModal"],function(e,t,i,n,o,s){var r;return r=Backbone.View.extend({className:"banner album-header",events:{"click .button:not(.disabled).add-photos":"_addPhotosHandler","click .button:not(.disabled).slide-show":"_slideShowHandler","click .button:not(.disabled).share":"_shareHandler","click .button:not(.disabled).print-all":"_printAllHandler","click .button:not(.disabled).photo-book":"_makeBookHandler","click .button:not(.disabled).product":"_makeProductHandler","click .button:not(.disabled).save-album":"_saveAlbumHandler","click .button:not(.disabled).download-all":"_downloadAllHandler","click .change-cover-btn:not(.disabled)":"_startChangeCover","click .invitees span":"_openInviteesPopover","click .sub-item.options":"_sharingOptions","click .pill":"_selectAll","click .title":"_onTitleFocus","keydown .title":"_onTitleKeyPress"},initialize:function(e){var i,n;return this.options=null!=e?e:{},this.model=this.options.model,this._collection=this.options.collection,this.coverUrl=null!=(i=this.model)?i.getCoverUrl("small"):void 0,this.controller=this.options.controller,this.title=ThisLife.Helper.String.escapeHtml((null!=(n=this.model)?n.get("name"):void 0)||""),this.subtitle=ThisLife.Helper.String.escapeHtml(this.options.subtitle),t.whenReady("upp",function(e){return function(t){return e.useUPP=t,e._initButtons()}}(this)),this.params=ThisLife.Helper.URL.parseQueryString(window.location.search),this.params.action&&this.params.actionPerformed?this._performAction(this.params.action):void 0},render:function(){return this.$el.html(this._getTemplate()),this._updateHeaderStyles(),this._updateSubtitles()},_cacheElements:function(){return this._actionButtonWrapEl=this.el.querySelector(".action-buttons-wrap"),this._coverEl=this.el.querySelector(".cover"),this._titleEl=this.el.querySelector(".title-wrap .title"),this._titleWrapEl=this.el.querySelector(".title-wrap"),this._selectAllEl=this.el.querySelector(".pill"),this._dateEl=this.el.querySelector(".subtitle .date")},_bindEvents:function(){var e,t,i;return this.model.on("change:name",this._titleChangeHandler,this),this.model.on("change:start_date change:end_date",this._dateRangeChangeHandler,this),this.model.on("change:cover_moment_uid",this._coverChangeHandler,this),this.model.on("change:cover_effects_modified_date",this._coverChangeHandler,this),this.model.on("change:visible_moment_count",this._countChangeHandler,this),this.model.on("change:shared",this._followerUpdate,this),this.model.followers.on("add remove",this._followerUpdate,this),null!=(e=this._collection)&&e.on("add remove",this._updateHeaderStyles,this),null!=(t=ThisLife.app.controller("selection"))&&t.on("start",this._onSelectStart,this),null!=(i=ThisLife.app.controller("selection"))&&i.on("done",this._onSelectDone,this),ThisLife.PubSub.on("resize",this._onResize,this)},_unbindEvents:function(){var e;return this.model.off(null,null,this),this.model.followers.off(null,null,this),null!=(e=this._collection)&&e.off(null,null,this),ThisLife.app.controller("selection").off(null,null,this),ThisLife.PubSub.off("resize",this._onResize,this)},teardown:function(){return this._unbindEvents(),this.remove()},_initButtons:function(){return this.buttons=[]},_reRenderButtons:function(){var e;return e=this._getButtonsTemplate(),this._actionButtonWrapEl.innerHTML="",this._actionButtonWrapEl.insertAdjacentHTML("beforeend",e)},_addPhotosHandler:function(){var e;return this._trackEvent("add_photos"),null!=(e=ThisLife.app.controller("selection"))&&e.done(),this.useUPP?ThisLife.app.controller("uploader").upp({albumId:this.model.id,show_sfly:!0,context:"sfly/timeline"}):ThisLife.app.router.navigateToAlbumUpload(this.model.id,{replace:!0,trigger:!0})},_slideShowHandler:function(){var e,t;if(!(this.model.moments.length<1))return t=ThisLife.Helper.Platform.mobile()?"moment":"fullview",e=this.controller.getFirstMoment(),ThisLife.app.router.navigateToAlbumFullView(this.model.id,e,{trigger:!0}),ThisLife.app.controller(t).startSlideshow(),this._trackEvent("slideshow")},_shareHandler:function(){return ThisLife.app.controller("albums").openShareModal(),this._trackEvent("share")},_printAllHandler:function(){return ThisLife.View.magicShop.doneShopping(),ThisLife.View.magicShop.startShopping(this._collection,"prints",null,"albumaction"),this._trackEvent("print_all")},_makeBookHandler:function(){return ThisLife.View.magicShop.doneShopping(),ThisLife.View.magicShop.startShopping(this._collection,"photobook",null,"albumaction"),this._trackEvent("make_book")},_makeProductHandler:function(){return ThisLife.View.magicShop.doneShopping(),ThisLife.View.magicShop.startShopping(this._collection,"photogifts",null,"albumaction"),this._trackEvent("make_product")},_saveAlbumHandler:function(){return this._trackEvent("save"),ThisLife.Albums.View.currentPopover=new ThisLife.Albums.View.CopyMoveAlbumPopover({model:this.model,copy:!0})},_downloadAllHandler:function(){return this._trackEvent("download"),this._action=new o({collection:this._collection}),this._action._download({storyUid:this.model.id,downloadAll:!0,totalMedia:this.model.moments.length})},_titleChangeHandler:function(){return this._titleEl.innerHTML=ThisLife.Helper.String.escapeHtml(this.model.get("name"))},_coverChangeHandler:function(){var e,t;return this.controller.setCoverChangeStatus(!1),e=this.model.getCoverUrl("small"),null!=(t=this._coverEl)&&(t.style.backgroundImage="url("+e+")"),this.positionCoverImage(),null!=this._spinnerModalView?this._spinnerModalView.teardown():void 0},_countChangeHandler:function(){var e,t;return e=this.model.get("visible_moment_count"),null!=(t=this._selectAllEl)&&(t.textContent=e),this._initButtons(),this._reRenderButtons(),this._updateHeaderStyles(),e>0?this.enableActions():this.disableActions()},_followerUpdate:function(){return this._inviteeCountHandler(),this._updateOptionsText()},_inviteeCountHandler:function(){return this._inviteesCountEl.innerHTML=this._getInviteeCountText()},_updateOptionsText:function(){var e,t;return this.model.get("shared")||this.model.followers.length>0?null!=(e=this._optionsEl)?e.classList.remove("hidden"):void 0:null!=(t=this._optionsEl)?t.classList.add("hidden"):void 0},_dateRangeChangeHandler:function(){var t,i,n;return i=this._getDateRange(),n=i&&""!==i&&!("function"==typeof(t=ThisLife.app.album).noMoments?t.noMoments():void 0)?i:"",e.addRemoveClass(this._dateEl,""===i,"hidden"),this._dateEl.innerHTML=n},_getDateRange:function(){var e,t,i,n,o;return n=this.model.get("start_date"),t=this.model.get("end_date"),"undefined"!=typeof n&&"undefined"!=typeof t?(o=ThisLife.Helper.Date.humanDate(n),i=ThisLife.Helper.Date.humanDate(t),e=o===i?o:o+" - "+i,this.model.moments.length>0?""+e:""):""},_openInviteesPopover:function(){var e;if(!this._inviteesPopoverEl.classList.contains("open")&&0!==this.model.followers.models.length)return e=function(e){return function(){return e._inviteesPopoverEl.classList.remove("open")}}(this),this._inviteesPopoverView=new i({model:this.model}),this._inviteesPopoverEl.appendChild(this._inviteesPopoverView.el),this._inviteesPopoverEl.classList.add("open"),this._inviteesPopoverView.on("torndown",e),this.hideFullscreen?this._inviteesPopoverView.el.classList.add("move_left"):void 0},_sharingOptions:function(){return n.load({data:{view:"options"}})},_onSelectStart:function(){return this.controller.setSelectionStatus(!0),this.disableActions()},_onSelectDone:function(){return this.controller.setSelectionStatus(!1),this.enableActions()},_onTitleFocus:function(){},_onTitleKeyPress:function(){},_updateHeaderStyles:function(){return e.addRemoveClass(this.el,0===this.model.get("visible_moment_count"),"empty")},_updateSubtitles:function(){return setTimeout(function(e){return function(){var t,i;return t=e.el.querySelector(".content-wrap .subtitle").children,i=t[0].offsetTop,_.each(t,function(e){return e.classList.remove("end-line"),e.classList.remove("new-line")}),_.each(t,function(e,n){var o;return e.offsetTop>i?(null!=(o=t[n-1])&&o.classList.add("end-line"),e.classList.add("new-line"),i=e.offsetTop):void 0})}}(this))},_trackEvent:function(e){return ThisLife.app.controller("tracking").logClickAlbumHeader(e)},positionCoverImage:function(e,t,i){var n,o,s,r;return o="center center",n=i?i.cover_moment_aoi:this.model.get("story")?this.model.get("story").cover_moment_aoi:"",n&&e&&t?o=ThisLife.Helper.Image.backgrounPositionForAreaOfInterest(n,e,t,this._coverEl.clientWidth,this._coverEl.clientHeight):(r=e||parseFloat(this.model.get("orig_width")),s=t||parseFloat(this.model.get("orig_height")),s>r&&(o="center 25%")),this._coverEl&&this._coverEl.style?this._coverEl.style.backgroundPosition=o:void 0},disableActions:function(){var e,t,i,n,o,s;for(t=this._actionButtonWrapEl.querySelectorAll(".button"),s=[],i=0,n=t.length;n>i;i++)e=t[i],e.classList.contains("add-photos"&&!(null!=(o=ThisLife.app.controller("selection"))?o.isActive():void 0))||s.push(e.classList.add("disabled"));return s},enableActions:function(){var e,t,i,n,o;for(t=this._actionButtonWrapEl.querySelectorAll(".button"),o=[],i=0,n=t.length;n>i;i++)e=t[i],e.classList.contains("add-photos"&&!ThisLife.app.controller("selection").isActive())||o.push(e.classList.remove("disabled"));return o},isChangingCover:function(){return this.controller.getCoverChangeStatus()},_startChangeCover:function(){var e,t;return this.controller.setCoverChangeStatus(!0),t=function(e){return function(){return e.isChangingCover()?(e.controller.setCoverChangeStatus(!1),e._spinnerModalView&&e._spinnerModalView.teardown(),e._spinnerModalView=new s,document.body.appendChild(e._spinnerModalView.el),ThisLife.app.controller("albums").resetPosition()):void 0}}(this),e=function(e){return function(){return e.controller.setCoverChangeStatus(!1)}}(this),ThisLife.app.album.startChangeCover(_.bind(t,this),e),this._trackEvent("change_cover")},_selectAll:function(){var e;if(0!==this._collection.getMoments().length&&!this._selectAllEl.classList.contains("disabled"))return this.isChangingCover()?void 0:(e=_.pluck(this._collection.models,"id"),this._collection.areAllSelected()?(ThisLife.app.controller("selection").done(),this.controller.updateObjects(e,{selected:!1}),this._selectAllEl.classList.remove("selected")):(ThisLife.app.controller("selection").addModels(this._collection.getMoments(),{storyUid:this.model.id}),this.controller.updateObjects(e,{selected:!0}),this._selectAllEl.classList.add("selected")),this._trackEvent("select_album"))},_onResize:function(){return"function"==typeof this._setInputWidth&&this._setInputWidth(),this._updateSubtitles()},_getInviteeCount:function(){var e;return e=this.model.followers.nonDuplicatedFollowers(),e.length},_getInviteeCountText:function(){return ThisLife.Helper.String.pluralize(this._getInviteeCount(),"person","people")},_performAction:function(e){switch(window.history.pushState({},document.title,window.location.pathname),e){case"add_photos":return this._addPhotosHandler();case"slideshow":return this._slideShowHandler();case"share":return this._shareHandler();case"print_all":return this._printAllHandler();case"make_book":return this._makeBookHandler();case"make_product":return this._makeProductHandler();case"save":return this._saveAlbumHandler();case"download":return this._downloadAllHandler()}},_getTotalCountTemplate:function(e){var t;return null==e&&(e=""),t=this.model.get("visible_moment_count"),'<div class="pill '+e+'">'+t+"</div>"},_getButtonsTemplate:function(){var e,t,i,n,o;for(t="",o=this.buttons,i=0,n=o.length;n>i;i++)e=o[i],t+='<div class="button '+e.className+'">\n  <div class="icon"></div>\n  <div class="text">'+e.label+"</div>\n</div>";return t},_getTemplate:function(){var e;return e=this._getButtonsTemplate(),'<div class="content-wrap">\n  <div class="title-wrap">\n    <div class="title">'+this.title+'</div>\n  </div>\n  <div class="subtitle">'+this.subtitle+'</div>\n  <div class="action-buttons-wrap">'+e+"</div>\n</div>"}})})}.call(this),function(){var e=function(e,i){function n(){this.constructor=e}for(var o in i)t.call(i,o)&&(e[o]=i[o]);return n.prototype=i.prototype,e.prototype=new n,e.__super__=i.prototype,e},t={}.hasOwnProperty;define("ThisLife.Albums.Views.Banners.AlbumHeaderOwner",["ThisLife.Albums.Views.Banners.AlbumHeader","ThisLife.Model.Albums.Master","ThisLife.Helper.Platform","ThisLife.Helper.DOM","ThisLife.Helper.Features","ThisLife.Helper.Keyboard","ThisLife.PubSub","ThisLife.View.ModalAlert"],function(t,i,n,o,s,r,l,a){var u;return u=function(t){function u(){return u.__super__.constructor.apply(this,arguments)}return e(u,t),u.prototype.className="banner album-header owner",u.prototype.initialize=function(e){var t;return this.options=null!=e?e:{},u.__super__.initialize.call(this,this.options),this.allowTitleEdit=!(null!=(t=ThisLife.Mode)?t.PublicStory:void 0)&&!this.model.isFriendsAlbum(),l.on("unshare:removeInvitee",this._inviteeCountHandler,this),s.whenReady("share",function(e){return function(t){return e.useShare=t,e.render(),e._cacheElements(),e._bindEvents(),e.useShare&&e.el.classList.add("shutterfly-new-share"),e._dateRangeChangeHandler(),e._inviteeCountHandler(),e.positionCoverImage()}}(this))},u.prototype._cacheElements=function(){return u.__super__._cacheElements.call(this),this._coverWrapEl=this.el.querySelector(".cover-wrap"),this._inviteesEl=this.el.querySelector(".subtitle .invitees"),this._inviteesCountEl=this.el.querySelector(".subtitle .invitees .count"),this._inviteesPopoverEl=this.el.querySelector(".subtitle .invitees-popover"),this._optionsEl=this.el.querySelector(".sub-item.options"),this._pillEl=this.el.querySelector(".title-wrap .pill"),this._imgEl=this.el.querySelector(".cover")},u.prototype._inviteeCountHandler=function(e){return e===!0?o.addRemoveClass(this._inviteesEl,!0,"hidden"):(o.addRemoveClass(this._inviteesEl,0===this._getInviteeCount(),"hidden"),this._inviteesCountEl.innerHTML=this._getInviteeCountText())},u.prototype._bindEvents=function(){return u.__super__._bindEvents.call(this),this._titleEl.addEventListener("focusout",_.bind(this._onTitleFocusOut,this))},u.prototype._unbindEvents=function(){return u.__super__._unbindEvents.call(this),this._titleEl.removeEventListener("focusout",this._onTitleFocusOut)},u.prototype._onTitleFocus=function(){return this._titleEl.value&&(this._titleOnFocus=this._titleEl.value),this._enterInputEditState()},u.prototype._onTitleFocusOut=function(){return this._blurTitle()},u.prototype._onTitleKeyPress=function(e){return r.isEnter(e.keyCode)?(this._titleEl.blur(),this._blurTitle(),!1):r.keyPressIgnore(e.keyCode)?!0:void 0},u.prototype._enterInputEditState=function(){var e,t;if(this.model.canEditTitle()&&(null!=(e=this.selection)?!e.isActive():!0)&&!this.isChangingCover())return ThisLife.Support.keyInformant.on("cancel",this._onTitleEscapeKey,this),this.allowTitleEdit&&this.model.canEditTitle()&&!(null!=(t=this.selection)?t.isActive():void 0)&&!this.isChangingCover()&&(n.ie()&&(this._titleEl.blur(),this._titleEl.focus()),this._setInputWidth(!0),this._titleEl.classList.contains("editing")||(this._titleEl.classList.add("editing"),this._titleEl.select())),this.blurEventCallback=ThisLife.blurEvent($(this._titleEl),function(e){return function(){return e._blurTitle()}}(this))},u.prototype._blurTitle=function(){var e;this.blurEventCallback&&ThisLife.removeBlurEvent(this.blurEventCallback),this._removeTitleSelection(),this._saveAlbumName(),this._setInputWidth(),this._titleEl.scrollLeft=0;try{return o.resetInputPosition(this._titleEl)}catch(t){if(e=t,"Unspecified error."!==e.message)throw e}},u.prototype._removeTitleSelection=function(){return this.blurEventCallback&&ThisLife.removeBlurEvent(this.blurEventCallback),ThisLife.Support.keyInformant.off("cancel",this._onTitleEscapeKey,this),this._titleEl.classList.remove("editing"),this._titleEl.blur()},u.prototype._onTitleEscapeKey=function(){return this._removeTitleSelection(),this._resetAlbumName(),this._setInputWidth()},u.prototype._saveAlbumName=function(){var e,t,i,n;if(i=this._titleEl.value,i!==this._titleOnFocus&&0===i.length)return void this._resetAlbumName();try{if(i!==this._titleOnFocus)return this.model.rename(i)}catch(o){return e=o,t={heading:"Name already taken!",message:"Try a different name."},n=new a({template:"changeStoryNameErrorTemplate",item:t}),document.body.appendChild(n.render().el),this._resetAlbumName()}},u.prototype._resetAlbumName=function(){return this._titleEl.value=this.model.get("name")},u.prototype._setInputWidth=function(e){var t,i,n,s,r,l,a,u;return null==e&&(e=!1),s=this.el.clientWidth,t=this._titleEl.offsetWidth,i=this._titleWrapEl.getBoundingClientRect().width-((null!=(r=this._pillEl)?r.clientWidth:void 0)||0)-5,a=this._titleWrapEl.getBoundingClientRect().width-10,n=s>767?i:a,e&&n&&"none"!==n?void(this._titleEl.style.width=t>.75*n?n+"px":Math.round(.75*n)+"px"):(l=o.getInputValueWidth(this._titleEl)+20,u=n&&"none"!==n?Math.min(n,l):l,this._titleEl.style.width=u+"px")},u.prototype._initButtons=function(){var e;return e=ThisLife.app.album.noMoments()?"disabled":"",this.buttons=[],ThisLife.app.isMobile||(this.buttons=this.buttons.concat([{label:"Add Photos",className:"add-photos",clickHandler:_.bind(this._addPhotosHandler,this)}])),this.buttons=this.buttons.concat([{label:"Slide Show",className:"slide-show "+e,clickHandler:_.bind(this._slideShowHandler,this)},{label:"Download",className:"download-all "+e,clickHandler:_.bind(this._downloadAllHandler,this)},{label:"Share",className:"share "+e,clickHandler:_.bind(this._shareHandler,this)},{label:"Print All",className:"print-all "+e,clickHandler:_.bind(this._printAllHandler,this)}]),this.buttons.push(this.model.get("visible_moment_count")<20?{label:"Make a Product",className:"product "+e,clickHandler:_.bind(this._makeProductHandler,this)}:{label:"Make a Book",className:"photo-book",clickHandler:_.bind(this._makeBookHandler,this)})},u.prototype.disableActions=function(){var e;return u.__super__.disableActions.call(this),null!=(e=this._coverWrapEl)?e.classList.add("disabled"):void 0},u.prototype.enableActions=function(){var e;return u.__super__.enableActions.call(this),null!=(e=this._coverWrapEl)?e.classList.remove("disabled"):void 0},u.prototype.getHeaderHeight=function(e){return 479>=e?402:767>=e?230:173},u.prototype._getTemplate=function(){var e,t,n,o,s,r,l,a,u,c;for(n=this.model.getCoverUrl("small"),c=this._getTotalCountTemplate(),t="",u=this.buttons,s=0,l=u.length;l>s;s++)e=u[s],t+='<div class="button '+e.className+'">\n  <div class="icon"></div>\n  <div class="text">'+e.label+"</div>\n</div>";return r='<div class="sub-item invitees">Shared with <span class=\'link-btn\'><span class="count"></span> <span class=\'down_arrow\'></span></span>\n  <div class="invitees-popover"></div>\n</div>',this.useShare&&(r='<div class="sub-item invitees shutterfly-new-share">Shared with <span class=\'link-btn\'><span class="count"></span></span></div>'),a="",this.useShare&&(o=this.model.get("shared")||this.model.followers.length>0?"":" hidden",a="<div class='sub-item options"+o+"'><span>Sharing options</span></div>"),'<div class="cover-wrap">\n  <div class="cover" style="background-image: url('+n+')"></div>\n  <div class="change-cover-wrap">\n    <div class="change-cover-btn button filled">Change Cover</div>\n  </div>\n</div>\n<div class="content-wrap">\n  <div class="title-wrap">\n    <input type="text" class="title" maxlength=\''+i.maxAlbumTitleLength+"' value='"+this.title+"'/>\n    "+c+'\n  </div>\n  <div class="subtitle">\n    <div class="sub-item date"></div>\n    '+r+"\n    "+a+'\n  </div>\n  <div class="action-buttons-wrap '+(bowser.ios||bowser.android?"mobile":"")+'">'+t+'</div>\n  <div class="clearfix"></div>\n</div>'},u}(t)})}.call(this),function(){var e=function(e,i){function n(){this.constructor=e}for(var o in i)t.call(i,o)&&(e[o]=i[o]);return n.prototype=i.prototype,e.prototype=new n,e.__super__=i.prototype,e},t={}.hasOwnProperty;define("ThisLife.Albums.Views.Banners.AlbumHeaderShared",["ThisLife.Albums.Views.Banners.AlbumHeader","ThisLife.Helper.Features"],function(t,i){var n;return n=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return e(n,t),n.prototype.className="banner album-header shared",n.prototype.initialize=function(e){return this.options=null!=e?e:{},n.__super__.initialize.call(this,this.options),i.whenReady("share",function(e){return function(t){return e.useShare=t,e.render(),e._cacheElements(),e._bindEvents(),e.useShare&&e.el.classList.add("shutterfly-new-share"),e._dateRangeChangeHandler(),e._ownerEl.innerHTML=e.model.getOwnerFullName()+"'s Album",e._inviteesCountEl.innerHTML=e._getInviteeCountText()}}(this))},n.prototype._cacheElements=function(){return n.__super__._cacheElements.call(this),this._ownerEl=this.el.querySelector(".subtitle .owner"),this._inviteesCountEl=this.el.querySelector(".subtitle .invitees .count"),this._inviteesPopoverEl=this.el.querySelector(".subtitle .invitees-popover"),this._optionsEl=this.el.querySelector(".sub-item.options")},n.prototype._initButtons=function(){var e;return this.buttons=[],e=ThisLife.app.album.noMoments()?"disabled":"",this.buttons=this.buttons.concat([{label:"Save Album",className:"save-album filled",clickHandler:_.bind(this._saveAlbumHandler,this)}]),ThisLife.app.isMobile||this.model.get("locked")!==!1||(this.buttons=this.buttons.concat([{label:"Add Photos",className:"add-photos",clickHandler:_.bind(this._addPhotosHandler,this)}])),this.buttons=this.buttons.concat([{label:"Print All",className:"print-all",clickHandler:_.bind(this._printAllHandler,this)}]),this.buttons.push(this.model.get("visible_moment_count")<20?{label:"Make a Product",className:"product "+e,clickHandler:_.bind(this._makeProductHandler,this)}:{label:"Make a Book",className:"photo-book",clickHandler:_.bind(this._makeBookHandler,this)}),this.buttons.push({label:"Download",className:"download-all "+e,clickHandler:_.bind(this._downloadAllHandler,this)}),this.buttons.push({label:"Share",className:"share",clickHandler:_.bind(this._shareHandler,this)})},n.prototype.getHeaderHeight=function(e){return this.useShare?479>=e?435:767>=e?230:173:479>=e?165:767>=e?160:155},n.prototype._getTemplate=function(){var e,t,i,n,o,s,r,l,a,u;for(u=ThisLife.app.isMobile?"":this._getTotalCountTemplate(),t="",a=this.buttons,o=0,r=a.length;r>o;o++)e=a[o],t+='<div class="button '+e.className+'">\n  <div class="icon"></div>\n  <div class="text">'+e.label+"</div>\n</div>";return i="",this.useShare&&(n=this.model.getCoverUrl("small"),i='<div class="cover-wrap">\n  <div class="cover" style="background-image: url('+n+')"></div>\n</div>'),s='<div class="sub-item invitees '+(this.model.followers.length<1?"hidden":void 0)+'">\n  Shared with <span class=\'link-btn\'><span class="count"></span> <span class=\'down_arrow\'></span></span>\n  <div class="invitees-popover"></div>\n</div>',this.useShare&&(s='<div class="sub-item invitees shutterfly-new-share'+(this.model.followers.length<1?" hidden":"")+'">Shared with <span class=\'link-btn\'><span class="count"></span></span></div>'),l="",this.useShare&&"story"!==ThisLife.app.currentState.name&&(l='<div class="sub-item options"><span>Sharing options</span></div>'),i+'\n<div class="content-wrap">\n  <div class="title-wrap">\n    <div class="title">'+this.title+"</div>\n    "+u+'\n  </div>\n  <div class="subtitle">\n    <div class="sub-item owner"></div>\n    <div class="sub-item date"></div>\n    '+s+"\n    "+l+'\n  </div>\n  <div class="action-buttons-wrap '+(bowser.ios||bowser.android?"mobile":"")+'">'+t+"</div>\n</div>"},n}(t)})}.call(this),function(){define("ThisLife.Albums.Views.Banners.EmptyAlbumFooter",[],function(){var e;return e=Backbone.View.extend({className:"banner empty-album-footer",initialize:function(e){return this.options=null!=e?e:{},this.render(),this},render:function(){return this.$el.html(this._getTemplate())},teardown:function(){return this.remove()},_getTemplate:function(){return'<div class="content-wrap">\n  <div class="message">Select "Add Photos" to start your album.</div>\n</div>'}})})}.call(this),function(){var e;define("ThisLife.Albums.View.AlbumActionBar",["ThisLife.Model.Albums.Master","ThisLife.Helper.DOM","ThisLife.View.Album.InviteesInviteeView","ThisLife.Helper.Keyboard","ThisLife.View.ModalAlert","ThisLife.View.Album.InviteesOwnerView","ThisLife.Helper.Platform","ThisLife.PubSub","ThisLife.Albums.Views.Banners.AlbumHeaderOwner","ThisLife.Albums.Views.Banners.AlbumHeaderShared"],function(e,t,i,n,o,s,r,l){var a;return a=Backbone.View.extend({maxTitleLength:e.maxAlbumTitleLength,events:{"click .back_btn":"goBack","click .all_albums_link":"goToAllAlbums","click .back_album_link.":"goToAlbum"},initialize:function(e){return null==e&&(e={}),this.render()},bindEvents:function(){return this.updateTitleWait=_.debounce(_.bind(this.updateTitle,this),200),$(window).on("resize",this.updateTitleWait),l.on("accountmenu:open",this.hidePopovers,this)},unbindEvents:function(){return null!=this.updateTitleWait?$(window).off("resize",this.updateTitleWait):void 0},render:function(){return this.el.insertAdjacentHTML("beforeend",this.template()),this.storyNameEl=this.el.querySelector(".select_all_btn .album_name"),this.tooltipEl=this.el.querySelector(".title_tooltip_wrap"),this.actionCenterEl=this.el.querySelector(".album_action_center"),this.allAlbumsLink=this.el.querySelector(".all_albums_link"),this.folderName=this.el.querySelector(".folder_name"),this.backAlbumName=this.el.querySelector(".back_to_album_name"),this.backAlbumLink=this.el.querySelector(".back_album_link"),this},setUploadView:function(){return this.momentsCollection.getMoments().length?(this.allAlbumsLink.style.display="none",this.backAlbumLink.style.display="block",this.backAlbumName.textContent=this.album.get("name"),this._updateNameToolTip(this.album.get("name"))):void 0},show:function(t){var i;return this.unbindEvents(),this.album=t.album,this.momentsCollection=t.collection,this.selection=t.selection,this.bindEvents(),i=e.getFolderById(this.album.get("folder_uid")),i?(this.folderName.textContent=i.get("name"),this.folderName.setAttribute("title",i.get("name"))):this.album.isFriendsAlbum()?this.folderName.textContent="Shared With Me":this.album.isAutoAlbum()&&(this.folderName.textContent="Auto Album"),this.displayTitle(),t.isUploadView&&this.setUploadView(),this.el.style.display="block",this.updateTitleWait()},displayTitle:function(e){return e=this.album.get("name"),this.storyNameEl.value=this.album.get("name"),this.backAlbumName.textContent=this.album.get("name"),this._updateNameToolTip(this.album.get("name")),this._setInputWidth()},updateTitle:function(){return this._setInputWidth()},hide:function(){return this.unbindEvents(),this.el.style.display="none"},goToAllAlbums:function(){return this._changeCoverMode||this.selectionMode?void 0:this.album.isFriendsAlbum()?ThisLife.app.router.navigateToAlbumsFriends():this.album.isAutoAlbum()&&"Auto Album"===this.folderName.textContent?ThisLife.app.router.navigateToAlbumsSuggested():ThisLife.app.router.navigateToFolder(this.album.get("folder_uid"))},goToAlbum:function(){return this._changeCoverMode||this.selectionMode?void 0:ThisLife.app.router.navigateToAlbum(this.album.id,{replace:!0,trigger:!0})},remove:function(){return this.unbindEvents(),Backbone.View.prototype.remove.apply(this)},_setInputWidth:function(e){var i,n,o;return null==e&&(e=!1),i=this.actionCenterEl.getBoundingClientRect().width-20,e&&i&&"none"!==i?void(this.storyNameEl.style.width=i+"px"):(n=t.getInputValueWidth(this.storyNameEl)+5,o=i&&"none"!==i?Math.min(i,n):n,this.storyNameEl.style.width=o+"px")},_updateNameToolTip:function(e){return this.storyNameEl.setAttribute("title",e),this.backAlbumName.setAttribute("title",e)},template:function(){return'<div class=\'album_action_btn back_btn all_albums_link col-lg-4 col-md-4 col-sm-3\'>\n  <div class="folder_back">Back to\n    <span class="folder_name"></span>\n  </div>\n</div>\n<div class=\'album_action_btn back_btn back_album_link col-lg-4 col-md-4 col-sm-3\' style=\'display: none;\'>\n  <div class="folder_back">Back To\n    <span class="folder_name back_to_album_name"></span>\n  </div>\n</div>\n\n<div class=\'album_action_center col-lg-4 col-md-3 col-sm-4\'>\n  <div class="album_action_btn select_all_btn">\n    <div class=\'full_title\'>\n      <input type="text" class="album_name" maxlength=\''+this.maxTitleLength+"' readonly='true'   />\n    </div>\n  </div>\n</div>"}})}),ThisLife.Albums||(ThisLife.Albums={}),(e=ThisLife.Albums).View||(e.View={}),ThisLife.Albums.View.AlbumActionBar=require("ThisLife.Albums.View.AlbumActionBar")}.call(this),function(){var e;define("ThisLife.Albums.View.Upload",["ThisLife.Timeline.Views.Upload"],function(e){var t;return t=e.extend({initialize:function(e){return this.options=null!=e?e:{},this.album=this.options.album,this.widgetHeader=this.options.widgetHeader,this.library=ThisLife.app.library,this.prefix=Dropzone.dragAndDropSupport?"Drag and drop to add photos to ":"Add photos to ",this.momentsText=this.prefix+'"'+ThisLife.Helper.String.escapeHtml(this.album.get("name")+'"'),this.render(),this.listenTo(this.album,"change:name",this._updateAlbumName)},_appendWidgets:function(){var e,t,i;return this.widget=new(require("ThisLife.Timeline.Views.Widgets.AddFromTimeline"))({album:ThisLife.app.album}),this.subviews.push(this.widget),this.options.show_widgets&&!((null!=(e=this.library)?e.noMoments():void 0)||(null!=(t=this.library)?t.areAllFiltered():void 0))?(this.uploadContainerEl.classList.remove("stretch"),null!=(i=this.widgetPlaceholderEl)?i.appendChild(this.widget.el):void 0):this.uploadContainerEl.classList.add("stretch")},_updateAlbumName:function(e){return this.album.get("uid")===e.get("uid")?this._updateHeaderText(e.get("name")):void 0},_updateHeaderText:function(e){return $(this.headerTextEl).text(this.prefix+e)}})}),ThisLife.Albums||(ThisLife.Albums={}),(e=ThisLife.Albums).View||(e.View={}),ThisLife.Albums.View.Upload=require("ThisLife.Albums.View.Upload")}.call(this),function(){var e;define("ThisLife.Albums.View.UploadView",["ThisLife.Albums.View.AlbumActionBar","ThisLife.Albums.View.Upload"],function(e,t){var i;return i=Backbone.View.extend({className:"album_upload",initialize:function(e){return this.options={show_widgets:!0},_.extend(this.options,e),this.album=this.options.album},render:function(i){var n,o,s,r,l,a,u;if(this.collection=i,this.hideLoading(),this.el.insertAdjacentHTML("afterbegin",this.template()),this._actionBarEl=this.el.querySelector(".timeline_action_bar"),null!=(l=ThisLife.app.controller("trash"))?l.moments.length:void 0)for(a=ThisLife.app.controller("trash").moments,o=0,s=a.length;s>o;o++)r=a[o],this.collection.setModel(r,{hidden:!0});return this._actionBarView=new e({album:this.album,collection:this.collection}),this._actionBarEl.appendChild(this._actionBarView.el),this._actionBarView.show({album:this.album,collection:this.collection,isGridLayout:!1,selection:ThisLife.app.controller("selection"),isUploadView:!0}),0!==this.collection.getMoments().length&&("function"==typeof(n=ThisLife.app).isPreviousState?n.isPreviousState("trash"):void 0)?void(null!=(u=this._actionBarView)&&u.goToAlbum()):(this._uploadView=new t({album:this.album,widgetHeader:"Other ways to add photos",show_widgets:this.options.show_widgets}),this.el.appendChild(this._uploadView.el),this)},remove:function(){var e,t,i;return null!=(e=this._actionBarView)&&e.remove(),null!=(t=this._uploadView)&&t.remove(),null!=(i=this.loading)&&i.remove(),Backbone.View.prototype.remove.apply(this)},listenForHiddenUpdates:function(e,t){var i;
return t?void 0:null!=(i=this._actionBarView)?i.goToAlbum():void 0},isLoading:function(){return!!this.loading},showLoading:function(){var e;return null!=(e=this.loading)&&e.remove(),this.loading=new ThisLife.View.Timeline.Loading,this.el.appendChild(this.loading.render().el)},hideLoading:function(){var e;return null!=(e=this.loading)&&e.remove(),this.loading=null},template:function(){return'<div class="timeline_action_bar"></div> '}})}),ThisLife.Albums||(ThisLife.Albums={}),(e=ThisLife.Albums).View||(e.View={}),ThisLife.Albums.View.AlbumUploadView=require("ThisLife.Albums.View.UploadView")}.call(this),function(){define("ThisLife.Albums.View.AlbumsActionBar",["ThisLife.Albums.View.InlineEditField","ThisLife.Model.Albums.Master"],function(e,t){var i;return i=Backbone.View.extend({id:"top",className:"albums-action-bar",events:function(){return{"keyup .search-input":"searchAlbums","focus .search-input":"searchFocus","click .icon_delete":"searchCancel","click .search_cancel":"searchCancel","click #breadcrumbs .name_wrap.editable .name":"editName","blur  #breadcrumbs .name_wrap.editable .name":"blurName","keydown  #breadcrumbs .name_wrap.editable .name":"onNameKeypress","click .error-text-icon.rename-error":"cancelNameChange","mousedown #breadcrumbs .close-btn":"deleteName","click #album-sort:not(.active)":"_viewSortOptions"}},cacheElements:function(){return this.breadcrumbs=this.el.querySelector("#breadcrumbs"),this.searchEl=this.el.querySelector("#search"),this.searchIcon=this.el.querySelector(".search-icon"),this.searchInput=this.el.querySelector(".search-input"),this.sort=this.el.querySelector("#album-sort"),this},initialize:function(e){return this.options=e,this.search="",this.searchCount=0,this.parentView=this.options.parentView,this.activeFolder=this.options.activeFolder,this.empty=this.options.empty},render:function(){return this.el.insertAdjacentHTML("afterbegin",this.getTemplate()),this.cacheElements(),this.folderNameView=new e({maxLength:t.maxFolderTitleLength,model:this.activeFolder,parentView:this.parentView}),this.breadcrumbs.appendChild(this.folderNameView.el),this.listenTo(this.model,"sort",this.sortInit),this.sortInit(),this},_viewSortOptions:function(){return this.sort.classList.add("active"),this._dropdownView?this._dropdownView.show():this._createSortDropdown()},_createSortDropdown:function(){return this._dropdownView=ThisLife.app.controller("flyout").get("albums_sort").show(this.sortOptions),this.sort.appendChild(this._dropdownView.el)},sortInit:function(){var e,t;return t=this.getActiveSort(),"created:desc"!==t&&"name:asc"!==t&&(this.setSort("created:desc"),t="created:desc"),this.sortOptions={items:[{type:"radio",name:"sort_order",value:"created:desc",label:"Date Created",selected:"created:desc"===t?!0:!1,disabled:!1,onClick:_.bind(this.changeSort,this)},{type:"radio",name:"sort_order",value:"name:asc",label:"Album Name",selected:"name:asc"===t?!0:!1,disabled:!1,onClick:_.bind(this.changeSort,this)}],styles:{top:"50px",right:"-15px",width:"170px"},arrowAlign:"right",onHide:_.bind(this.hideSort,this)},e=_.find(this.sortOptions.items,function(e){return e.value===t}),this.updateSortLabel(e.label)},teardown:function(){var e;return this.noneFoundView&&(this.parentView.el.removeChild(this.parentView.el.querySelector(".search.none_found")),this.noneFoundView=null),null!=(e=this.folderNameView)&&e.remove(),this.remove()},hideOptions:function(){return this.searchEl.classList.add("hidden"),this.sort.classList.add("hidden")},showOptions:function(){return this.searchEl.classList.remove("hidden"),this.sort.classList.remove("hidden")},searchAlbums:function(){var e,t,i;return this.search=null!=(e=this.searchInput.value)?e.trim().toLowerCase():void 0,this.searchList=_.filter(this.parentView.views,_.bind(this.filterBySearch,this)),this.searchCount=this.searchList.length,this.search.length?null!=(t=this.parentView.el.querySelector(".framed_moment.create-album"))&&t.classList.add("hidden"):null!=(i=this.parentView.el.querySelector(".framed_moment.create-album"))&&i.classList.remove("hidden"),this.updateSearchIcon(),this.updateSearchBreadcrumb(),this.updateSearchNoneFound()},filterBySearch:function(e){var t,i,n,o,s,r,l;if(o=e.model.get("name"),i=o.toLowerCase(),s=!1,""===this.search)s=!0;else if(i){for(l=i.split(" "),t=0,n=l.length;n>t&&(r=l[t],!(s=-1===~r.indexOf(this.search)));t++);s||(s=-1===~i.indexOf(this.search))}return s?e.el.classList.remove("hidden"):e.el.classList.add("hidden"),s},updateSearchBreadcrumb:function(){var e,t,i,n;return n=this.search.length?this.searchCount:this.parentView.model.models.length,i="("+n+")",e=this.folderNameView.getName(),t="My Albums"===e||"Auto-Albums"===e||"Shared with Me"===e||"Lifetouch"===e?!1:!0,this.updateBreadcrumbs({newCount:i,makeEditable:t})},updateSearchNoneFound:function(){var e,t,i;if(this.search.length&&0===this.searchCount&&!this.noneFoundView){if(ThisLife.PubSub.trigger("showSort",!1),null!=(t=document.querySelector("div.empty-grid"))&&t.classList.add("hidden"),this.noneFoundView=this.searchNoneFound(),this.parentView.el.insertAdjacentHTML("afterbegin",this.noneFoundView),null!=this.parentView.suggestedGuideView)return this.parentView.suggestedGuideView.el.style.display="none"}else if(0===this.searchCount&&!this.search.length||this.searchCount>0)return _.isEmpty(this.parentView.views)||ThisLife.PubSub.trigger("showSort",!0),null!=(i=document.querySelector("div.empty-grid"))&&i.classList.remove("hidden"),e=this.parentView.el.querySelector(".search.none_found"),e&&this.parentView.el.removeChild(e),null!=this.parentView.suggestedGuideView&&(this.parentView.suggestedGuideView.el.style.display=""),this.noneFoundView=null},updateSearchIcon:function(){return this.search.length?(this.searchEl.classList.add("cancel"),this.sort.classList.add("hidden")):(this.searchEl.classList.remove("cancel"),this.sort.classList.remove("hidden"))},searchFocus:function(){var e;return e=document.querySelector(".hide-container"),e.classList.contains("hidden")?void 0:e.click()},searchCancel:function(){return this.searchInput.value="",this.searchAlbums()},_updateNameToolTip:function(e){return this.breadcrumbsName.setAttribute("title",e)},updateBreadcrumbs:function(e){return e.newName&&this.folderNameView.setName(e.newName),this.folderNameView.setEditable(e.makeEditable?!0:!1)},updateSortLabel:function(e){return this.sort.querySelector("span.label-selected").textContent=e},hideSort:function(){return this.sort.classList.remove("active")},changeSort:function(e){return ThisLife.app.album.listViewObj.showLoading(),this.setSort(e.value),this.updateSortLabel(e.label),ThisLife.app.controller("tracking").logClickAlbumsChangeSort(e.value)},setSort:function(e){switch(this.options.type){case"all":return t.setAllSort(e);case"owner":return t.setOwnerSort(e);case"shared":return t.setSharedSort(e);case"auto":return t.setAutoSort(e);default:return this.options.activeFolder.setSort(e)}},getActiveSort:function(){switch(this.options.type){case"all":return t.getAllSort();case"owner":return t.getOwnerSort();case"shared":return t.getSharedSort();case"auto":return t.getAutoSort();default:return this.options.activeFolder.get("sort_option")}},getTemplate:function(){var e;return e=this.empty?"hidden":"","<div id='breadcrumbs'></div>\n\n<div id=\"album-sort\" class='"+e+"'>\n  <span class=\"label\">Sort by</span>\n  <span class=\"label-selected\"></span>\n</div>\n\n<div id='search' class='"+e+'\'>\n    <input type="text" class="search-input" placeholder="Search album"/>\n    <div class="search-icon"></div>\n    <div class=\'icon_delete\'></div>\n    <a class=\'search_cancel\'>Clear</a>\n</div>'},searchNoneFound:function(){return'<div class="search none_found">\n  <div class="sadface"></div>\n  Oops, we can\'t find any albums with this name...\n</div>'}})}),ThisLife.Albums.View.AlbumsActionBar=require("ThisLife.Albums.View.AlbumsActionBar")}.call(this),function(){ThisLife.Router.Router=Backbone.Router.extend({initialize:function(){return this._bindControllerRoutes()},navigate:function(e,t){return null==t&&(t=!0),Backbone.Router.prototype.navigate.call(this,e,t)},back:function(){return window.history.back()},_bindControllerRoutes:function(){var e,t,i,n;if(this.controllerRoutes){assert(this.controller,"expected route controller to be defined"),t=this.controllerRoutes,i=[];for(n in t)e=t[n],i.push(this.route(n,e,_.bind(this.controller[e],this.controller)));return i}}})}.call(this),function(){var e,t;t={},ThisLife.Service.Import=function(){function i(){_.bindAll(this,"importServiceError","socialServiceRequired","exportToTumblr","importPhotosAndVideosOfMeSuccess")}return i.prototype.connect=function(i){var n,o,s,r,l,a,u;return r=ThisLife.services[""+i].connect,u=r.options.width,a=r.options.height,o=(window.screen.width-u)/2,n=(window.screen.height-a)/2-20,l=ThisLife.Settings.socialUrl+r.url,s=window.open(l,r.name,"resizable=0,scrollbars=1,status=1,width="+u+",height="+a+",left="+o+",top="+n),t[i]=setInterval(e(s,i),1e3)},i.prototype.autoImport=function(e,t){var i;return i={},i[e+"_auto_import"]=t,ThisLife.Model.User.set(i),ThisLife.Service.api.updatePerson(i)},i.prototype.cmdImport=function(e,t,i,n){return t=t||{},t.token=ThisLife.Model.User.get(e+"_access_token"),t.lifeUid=ThisLife.lifeUid,ThisLife.app.session.getSessionToken().then(function(o){return function(s){return $.ajax({type:"POST",dataType:"json",url:ThisLife.Settings.apiUrl,data:JSON.stringify({method:"import."+e,params:[s,t],id:null}),error:function(){return o.socialServiceRequired(e)},success:function(t){if(!t.result.success)return o.socialServiceRequired(e);if("Job already exists with a status PENDING"===t.result.message){if(n)return n(t.result.message)}else if(i)return i(e)}})}}(this))},i.prototype.importAll=function(e,t,i){var n,o;return"shutterfly"===e?(o=function(){return function(){return t(e)}}(this),n=function(e){return i(e.result.message)},ThisLife.Service.api.importSflyAll(o,n)):this.cmdImport(e,null,t,i)},i.prototype.importAlbum=function(e,t){var i;return"shutterfly"===e?(i=function(t){return function(){return t.socialServiceRequired(e)}}(this),ThisLife.Service.api.importSflyAlbum(t,null,i)):this.cmdImport(e,{albumId:t})},i.prototype.importPhotosAndVideosOfMe=function(){var e;return e=new AlbumList(null,{service:"facebook",type:"photos_and_videos_of_me"}),e.fetch({dataType:"jsonp",success:this.importPhotosAndVideosOfMeSuccess,error:function(e){return function(){return e.socialServiceRequired(service)}}(this)})},i.prototype.importPhotosAndVideosOfMeSuccess=function(e){var t,i;return i=function(){var i,n,o,s;for(o=e.models,s=[],i=0,n=o.length;n>i;i++)t=o[i],s.push(t.id);return s}(),i.length?this.cmdImport("facebook",{photos:i}):void 0},i.prototype.exportFacebookWall=function(e,t,i){var n,o,s,r,l,a,u;return null==t&&(t={}),l="facebook",a=ThisLife.Model.User.get(l+"_access_token"),s=ThisLife.Collection.organize,r=t.uid||s.pluck("uid").join("&photos[]="),o=t.groupUid||s.groupUid,n=t.galleryUrl||s.galleryUrl,u=ThisLife.services[l].exportFacebookWall(a,r,e,o,n),$.getJSON(ThisLife.Settings.socialUrl+u,function(e){return function(t){return t.success?i?i():void 0:e.importServiceError(l,t)}}(this)).error(function(e){return function(){return e.socialServiceRequired(l)}}(this))},i.prototype.exportFacebookFriendsWall=function(e){var t,i,n,o,s,r,l,a,u;return l="facebook",o=ThisLife.Collection.organize,a=ThisLife.Model.User.get(l+"_access_token"),s=o.pluck("uid").join("&photos[]="),t=(null!=(r=o.facebookFriends)?r.join("&friend_ids[]="):void 0)||"",n=o.groupUid,i=o.galleryUrl,u=ThisLife.services[l].exportFacebookFriendsWall(a,s,t,e,n,i),$.getJSON(ThisLife.Settings.socialUrl+u,function(e){return function(t){return t.success?void 0:e.importServiceError(l,t)}}(this)).error(function(e){return function(){return e.socialServiceRequired(l)}}(this))},i.prototype.tweet=function(e,t,i){var n,o;return n="twitter",o=ThisLife.Model.User.get(n+"_access_token"),t||(t=ThisLife.Collection.organize.galleryUrl),e=e+" "+t,t=ThisLife.services[n].tweet(o,e),$.getJSON(ThisLife.Settings.socialUrl+t,function(e){return function(t){return t.success?i?i():void 0:e.importServiceError(n,t)}}(this)).error(function(e){return function(){return e.socialServiceRequired(n)}}(this))},i.prototype.exportToTumblr=function(e){var t,i,n,o,s,r,l;return s="tumblr",n=ThisLife.Collection.organize,r=ThisLife.Model.User.get(s+"_access_token"),o=n.pluck("uid").join("&photos[]="),i=n.groupUid,t=n.galleryUrl,l=ThisLife.services[s].exportTumblrFeed(r,o,i,t,e),$.getJSON(ThisLife.Settings.socialUrl+l,function(e){return function(t){return t.success?void 0:e.importServiceError(s,t)}}(this)).error(function(e){return function(){return e.socialServiceRequired(s)}}(this))},i.prototype.getFacebookPhotos=function(e,t,i){var n;return n="facebook",!this.facebookAlbums[e]||i?(this.facebookAlbums[e]||(this.facebookAlbums[e]=new AlbumList(null,{service:n,albumId:e})),this.facebookAlbums[e].fetch({dataType:"jsonp",success:t,error:function(e){return function(){return e.socialServiceRequired(n)}}(this)})):t(this.facebookAlbums[e])},i.prototype.getShutterflyPhotos=function(e,t,i){var n,o,s,r;s="shutterfly",o=this.shutterflyAlbums;for(n in o)r=o[n],n!==e&&null!=r&&"function"==typeof r.cancel&&r.cancel();return!this.shutterflyAlbums[e]||i?(this.shutterflyAlbums[e]||(this.shutterflyAlbums[e]=new AlbumList(null,{service:s,type:"photos",albumId:e})),this.shutterflyAlbums[e].fetchLazy({headers:{"x-sfly-origin":"sfly-media"},success:t,error:function(e){return function(){return e.socialServiceRequired(s)}}(this)})):t(this.shutterflyAlbums[e])},i.prototype.getFlickrPhotos=function(e,t,i){var n,o,s,r,l;return s="flickr",!this.flickrAlbums[e]||i?(n=function(i){return function(){var n;return null!=(n=i.flickrAlbums[e])?n.fetch({success:t,error:function(){return i.socialServiceRequired(s)}}):void 0}}(this),i?n():(r=ThisLife.Model.User.get("flickr_access_token"),l="getPhotostreamThislife"!==e?"/go_social/feed/flickr?type=photos&access_token="+r+"&opts[album_id]="+e+"&jsoncallback=?":"/go_social/feed/flickr?type=notinset&access_token="+r+"&jsoncallback=?",o=ThisLife.Settings.socialUrl+l,$.getJSON(o,function(t){return function(i){var o;return o=i.signed_url,t.flickrAlbums[e]||(t.flickrAlbums[e]=new AlbumList(null,{service:s,albumId:e,url:o})),n()}}(this)).error(function(e){return function(){return e.socialServiceRequired(s)}}(this)))):t(this.flickrAlbums[e])},i.prototype.getFacebookAlbums=function(e,t){var i;return i="facebook",!this.facebookAlbums||t?(this.facebookAlbums||(this.facebookAlbums=new AlbumList(null,{service:i,type:"albums"})),this.facebookAlbums.fetch({dataType:"jsonp",success:e,error:function(e){return function(){return e.socialServiceRequired(i)}}(this)})):e(this.facebookAlbums)},i.prototype.getShutterflyAlbums=function(e,t,i){var n,o;return n="shutterfly",!this.shutterflyAlbums||i?(this.shutterflyAlbums||(this.shutterflyAlbums=new AlbumList(null,{service:n,type:"albums"})),o=this.shutterflyAlbums.findStartIndex(function(t){return t.get("collectionId")===e}),this.shutterflyAlbums.fetchLazy({headers:{"x-sfly-origin":"sfly-media"},firstIndex:o,success:t,error:function(e){return function(){return e.socialServiceRequired(n)}}(this)})):t(this.shutterflyAlbums)},i.prototype.getFlickrAlbums=function(e,t){var i,n,o,s,r,l;return o="flickr",!this.flickrAlbums||t?(n=this,i=function(t){return function(){var i;return null!=(i=t.flickrAlbums)?i.fetch({success:e,error:function(){return t.socialServiceRequired(o)}}):void 0}}(this),t?i():(r=ThisLife.Model.User.get("flickr_access_token"),s=ThisLife.Settings.socialUrl,l="/go_social/feed/flickr?type=token&access_token="+r+"&jsoncallback=?",$.getJSON(s+l,function(e){var t;return t=e.signed_url,$.getJSON(t,function(e){var t,l;return l=e.auth.user.nsid,t="/go_social/feed/flickr?type=albums&access_token="+r+"&opts[user_id]="+l+"&jsoncallback=?",$.getJSON(s+t,function(e){var t;return t=e.signed_url,n.flickrAlbums||(n.flickrAlbums=new AlbumList(null,{service:o,type:"albums",url:t})),i()}).error(function(){return n.socialServiceRequired(o)})}).error(function(){return n.socialServiceRequired(o)})}).error(function(){return n.socialServiceRequired(o)}))):e(this.flickrAlbums)},i.prototype.getShutterflyFolders=function(e,t){var i;return i="shutterfly",t||!this.shutterflyFolders?(this.shutterflyFolders||(this.shutterflyFolders=new AlbumList(null,{service:i,type:"folders"})),this.shutterflyFolders.fetchLazy({headers:{"x-sfly-origin":"sfly-media"},success:e,error:function(e){return function(){return e.socialServiceRequired(i)}}(this)})):e(this.shutterflyFolders)},i.prototype.importSocialServicePhotos=function(e,t){var i;return"shutterfly"===e?(i=function(t){return function(){return t.socialServiceRequired(e)}}(this),ThisLife.Service.api.importSflyPhotos(t,null,i)):this.cmdImport(e,{photos:t})},i.prototype.socialServiceRequired=function(e,t){var i,n;return null==t&&(t="retrySocialService"),e=(null!=(n=e.options)?n.service:void 0)||e,i=function(){return delete ThisLife.Service["import"][e+"Albums"],"shutterfly"===e&&delete ThisLife.Service["import"][e+"Folders"],ThisLife.Service["import"].connect(e)},ThisLife.PubSub.trigger(e+"_service_required",i)},i.prototype.importServiceError=function(e,t){var i,n,o,s;for(s=t.errors,n=0,o=s.length;o>n;n++)i=s[n],_.delay(function(){return ThisLife.notification(i,1800)},2e3);return this.socialServiceRequired(e)},i.prototype.cancel=function(e,t,i){var n,o;return n=this[""+e+t],"Folders"===t||"Albums"===t?null!=n?n.cancel():void 0:"Photos"===t&&null!=n&&null!=(o=n[i])?o.cancel():void 0},i}(),e=function(e,i){return function(){return e.closed?(ThisLife.PubSub.trigger("connectService:"+i),clearInterval(t[i])):void 0}}}.call(this),function(){var e,t,i,n,o=[].slice;t="1",i="2",n="3",e=APIModel.extend({initialize:function(){var e;return e=ThisLife.Collection.Stories,this.myStories=new e,this.invitedStories=new e,this.otherStories=new e,this.autoStories=new e,this.on("reset",this.bindEvents,this)},_getFolderByFolderType:function(e){switch(e){case t:return this.myStories;case i:return this.otherStories;case n:return this.autoStories}},_splitOtherAlbums:function(e){return this.otherStories.reset(e.albums),this.invitedStories.reset(e.newInvitedStories),this.invitedStories.albumCount=e.newInvitedStoriesCount},parse:function(e){var t,n,o,s,r;for(ThisLife.Model.User.set("newInvitedStories",0),r=e.result.payload,o=0,s=r.length;s>o;o++)t=r[o],n=this._getFolderByFolderType(t.folder_type),_.extend(n,_.pick(t,["albumCount","default","folder_type","life_uid","name","uid"])),t.folder_type===i?this._splitOtherAlbums(t):n.reset(t.albums);return{}},bindEvents:function(){return ThisLife.PubSub.on("story:newInvitation",this.newStoryInvitation,this).on("story:deletePermission",this.deleteStoryPermission,this).on("story:changed_cover",this.changedCover,this).on("story:changed_last_viewed",this.changeLastViewed,this)},changedCover:function(e,t){var i,n;return i=this.getPermissionByStoryId(t),i?(n=i.get("story"),n.cover_moment_uid=e.cover_moment_uid,n.cover_owner_uid=e.cover_owner_uid,n.cover_moment_aoi=e.cover_moment_aoi,n.cover_effects_modified_date=e.cover_effects_modified_date,e.name&&(n.name=e.name),i.updateDates(e.start_date,e.end_date)):void 0},changeLastViewed:function(e,t){var i;return i=this.getPermissionByStoryId(e),i?i.updateLastViewed(t):void 0},getFollowedStories:function(){return _.union(this.myStories.models,this.otherStories.models)},deleteStoryPermission:function(e){var t,i,n;return t=this.getPermission(e),t?(n=t.get("story_uid"),t.collection.remove(t),this.checkReroute(n)):null!=(i=ThisLife.currentStory)?i.followers.remove(e):void 0},isMine:function(e){return!!this.myStories.get(e)},getPermission:function(e){var t;return t=_.find([this.myStories,this.otherStories,this.invitedStories],function(t){return t.get(e)}),t?t.get(e):void 0},newStoryInvitation:function(e){var t;return t=this.invitedStories.addNewInvite(e),ThisLife.Helper.Stories.newStoryInviteNotification(t)},addedMoment:function(e,t){var i;return null!=(i=this.getPermissionByStoryId(e))?i.updateCount(t):void 0},removedMoment:function(e,t){var i;return null!=(i=this.getPermissionByStoryId(e))?i.updateCount(-t):void 0},fetch:function(e){var t,i,n,o;return n=this,o=e.success,t=e.error,e.type="POST","jsonp"!==e.dataType&&null==e.jsonp&&(e.jsonp=!1),e.data=APIModel.transformData(e),e.success=function(t,i,s){var r,l,a,u,c,d,h,p,f,m,g,v,_,b;for(u=[],_=t.result.payload,c=p=0,m=_.length;m>p;c=++p){if(h=_[c],a=c+1,l={_explicitType:"Folder",albumCount:h.length,albums:h,"default":"1",folder_type:""+a,hidden:"0",life_uid:ThisLife.lifeUid,name:"",stories:null,uid:$.Guid.New()},1===a)l.name="My Albums";else if(2===a){for(l.name="Friends' Albums",v=[],r=[],d=f=0,g=h.length;g>f;d=++f)b=h[d],b.accepted?r.push(b):v.push(b);l.newInvitedStories=v,l.newInvitedStoriesCount=v.length,l.albums=r,l.albumCount=r.length}else 3===a&&(l.name="Auto Albums");u.push(l)}return t.result.payload=u,n.set(n.parse(t,s),e)?(o&&o(n,t),n.trigger("sync",n,t,e)):!1},e.error=function(i,o){return"abort"!==o?(ThisLife.Helper.Error.errorHelper(i),t&&t(n,i),n.trigger("error",n,i,e)):void 0},null!=this._abortableRequestGroup&&this._abortableRequestGroup.abortAllForMethod(e.method),i=(this.sync||Backbone.sync).call(this,"read",this,e),e.abortable&&(null==this._abortableRequestGroup&&(this._abortableRequestGroup=new RequestGroup),this._abortableRequestGroup.add(e.method,i)),i},fetchStories:function(e){return ThisLife.app.session.getSessionToken().then(function(t){return function(i){return t.loading=!0,t.fetch({method:"getStories",params:[i,ThisLife.lifeUid,!0],success:function(i,n){return i.loaded=!0,ThisLife.PubSub.trigger("removeLoader"),i.trigger("reset",t),n.result.success?void 0:e(n)}})}}(this)),this},checkAccepted:function(e){return e.get("accepted")?void 0:this.joinInvitedStory(e.get("story_uid"))},getPermissionByStoryId:function(e){var t;return e=String(e),t=null,_.find([this.myStories,this.otherStories,this.invitedStories,this.autoStories],function(i){return i.find(function(i){return i.get("story_uid")===e&&(t=i),i.get("story_uid")===e})}),t},updateViewOnlyPermission:function(e,t){var i;return i=this.invitedStories.getStory(e),null!=i?i.saveStoryPermission({view_only:t}):void 0},joinInvitedStory:function(e){var t;return e=String(e),(t=this.invitedStories.getStory(e))?(t.saveStoryPermission({accepted:!0}),this.invitedStories.remove(t),this.otherStories.add(t)):void 0},updateStory:function(e){var t;return e=String(e),t=this.getPermissionByStoryId(e),null!=t?t.updateStory():void 0},unfollowStory:function(e){var t;return e=String(e),t=this.otherStories.getStory(e),this.otherStories.remove(t),t.deleteStoryPermission(),this.checkReroute(e)},ignoreStory:function(e){var t;return e=String(e),t=this.invitedStories.getStory(e),t.saveStoryPermission({ignored:!0}),this.invitedStories.remove(t),this.checkReroute(e)},deleteStory:function(e){var t;return e=String(e),t=this.myStories.getStory(e)||this.autoStories.getStory(e),this.myStories.remove(t),this.autoStories.remove(t),t.deleteStory(),this.checkReroute(e)},checkReroute:function(e){var t,i,n;return e=String(e),ThisLife.storyUid===e&&(t=this.myStories.getDefaultStory(),i=t.get("story_uid"),(null!=(n=ThisLife.app.currentState.options)?n.storyUid:void 0)===e)?ThisLife.app.router.navigateToStory(i):void 0},pathIsAvailable:function(e){var t;return e=String(e),t=this.myStories.find(function(t){return t.get("story").path===e}),!t},whenLoaded:function(){var e,t,i,n,s;return i=arguments[0],n=arguments[1],e=3<=arguments.length?o.call(arguments,2):[],null==n&&(n=this),t=_.bind(i,n),this.loaded?(t.apply(null,e),ThisLife.PubSub.trigger("removeLoader")):(null==this.loading&&this.fetchStories(),s=function(){return t.apply(null,e),this.off("reset",s,this)},this.on("reset",s,this))},getLastUsed:function(){var e,t,i;return e=[].concat(this.myStories.models,this.otherStories.models,this.autoStories.models),i=_.sortBy(e,this.lastViewedComparator),t=i[0]},lastViewedComparator:function(e){return-e.get("story").updated},nameExists:function(e){var t,i,n,o;for(e=e.trim(),n=this.myStories.models,t=0,i=n.length;i>t;t++)if(o=n[t],o.get("story").name.toLowerCase()===e.toLowerCase())return!0;return!1}}),ThisLife.Model.masterStory=new e}.call(this),function(){var e=[].slice;ThisLife.Support.Log=function(){function t(e){this._enabled=e,this._enabledDebug=e,this._enabledInfo=e,this._enabledWarn=e,this._enabledError=e,this._cacheNativeConsoleMethods(),this._enabled||this.disableConsole()}return t.CONSOLE_METHODS=["log","debug","info","warn","assert","dir","dirxml","group","groupEnd","time","timeEnd","count","trace","profile","profileEnd"],t.prototype.disableDebug=function(e){return null==e&&(e=!0),this._enabledDebug=!e},t.prototype.disableInfo=function(e){return null==e&&(e=!0),this._enabledInfo=!e},t.prototype.disableWarn=function(e){return null==e&&(e=!0),this._enabledWarn=!e},t.prototype.disableError=function(e){return null==e&&(e=!0),this._enabledError=!e},t.prototype.debug=function(){var t,i;return t=arguments[0],i=2<=arguments.length?e.call(arguments,1):[],this._enabled&&this._enabledDebug?(t=this._formatMessage("DEBUG",t),console.log.apply(console,[t].concat(e.call(i)))):void 0},t.prototype.info=function(){var t,i;return t=arguments[0],i=2<=arguments.length?e.call(arguments,1):[],this._enabled&&this._enabledInfo?(t=this._formatMessage("INFO",t),console.log.apply(console,[t].concat(e.call(i)))):void 0},t.prototype.warn=function(){var t,i;return t=arguments[0],i=2<=arguments.length?e.call(arguments,1):[],this._enabled&&this._enabledWarn?(t=this._formatMessage("WARN",t),console.warn.apply(console,[t].concat(e.call(i)))):void 0},t.prototype.error=function(){var t,i;return t=arguments[0],i=2<=arguments.length?e.call(arguments,1):[],this._enabled&&this._enabledError?(t=this._formatMessage("ERROR",t),console.error.apply(console,[t].concat(e.call(i)))):void 0},t.prototype._formatMessage=function(e,t){var i;return i=ThisLife.Helper.String.formatTime(),"["+e+"] "+i+": "+t},t.prototype._cacheNativeConsoleMethods=function(){var e,t,i,n;for(this._nativeConsoleMethods={},n=ThisLife.Support.Log.CONSOLE_METHODS,e=0,t=n.length;t>e;e++)i=n[e],this._nativeConsoleMethods[i]=console[i]},t.prototype.enableConsole=function(){var e,t,i,n;if(this._nativeConsoleMethods)for(n=ThisLife.Support.Log.CONSOLE_METHODS,e=0,t=n.length;t>e;e++)i=n[e],console[i]=this._nativeConsoleMethods[i]},t.prototype.disableConsole=function(){var e,t,i,n;for(n=ThisLife.Support.Log.CONSOLE_METHODS,e=0,t=n.length;t>e;e++)i=n[e],console[i]=function(){}},t}()}.call(this),function(){var e;ThisLife.Support.PerformanceMonitor=function(){function t(e,t){this._enabled=e,this._log=t}return t.prototype.start=function(t){var i;if(this._enabled)return i=new e(this._log),i.start(t),i},t.prototype.end=function(e,t){return this._enabled&&e?e.end(t):void 0},t}(),e=function(){function e(e){this._log=e}return e.prototype.start=function(e){return this._message=e,null!=console.time?console.time(e):this._startTime=this._timeNow()},e.prototype.end=function(e){var t;return null!=console.time?console.timeEnd(this._message):(t=this._timeNow()-this._startTime,this._log.debug(this._message+(": "+t+" ms"))),e?this._log.debug(e):void 0},e.prototype._timeNow=function(){return performance&&performance.now?performance.now():(new Date).getTime()},e}()}.call(this),function(){var e=[].slice;ThisLife.Support.GlobalErrorHandler={init:function(e,t){return null==t&&(t=!0),this._onError=e,this._enabled=t,window.onerror=_.bind(this._errorHandler,this)},protectedInvoke:function(){var t,i,n;t=arguments[0],i=2<=arguments.length?e.call(arguments,1):[];try{return t.apply(null,i)}catch(o){return n=o,this.handleError(null,n)}},handleError:function(e,t){return this._enabled?(e?t&&(e+=" "+this.describeError(t)):e=this.describeError(t),"function"==typeof this._onError?this._onError(e,t):void 0):void 0},describeError:function(e){var t;return e?t=e instanceof String?e:e instanceof Error?e.message+"\n"+e.stack:JSON.stringify(e):null},_errorHandler:function(e,t,i,n,o){var s,r;return this._enabled?(e&&t?(s="message: "+e+"\nfile: "+t+"\nline: "+i,o&&(s+="\nstack: "+o.stack),r=!0):(s="Something went wrong, check console log",o&&!ThisLife.Settings.isProdEnv()&&(s+="\n\nstack: "+o.stack),r=!1),"function"==typeof this._onError&&this._onError(s,o),r):!1}}}.call(this),function(){ThisLife.Support.assert=function(e,t){if(!e)throw new Error(t)},window.assert=ThisLife.Support.assert}.call(this),function(){var e,t,i,n,o=function(e,t){function i(){this.constructor=e}for(var n in t)s.call(t,n)&&(e[n]=t[n]);return i.prototype=t.prototype,e.prototype=new i,e.__super__=t.prototype,e},s={}.hasOwnProperty;t=6,e=function(){function e(){this.reset()}return e.prototype.add=function(e){return this._queued.unshift(e),this._spawn()},e.prototype.remove=function(e){var t;if(e)return t=_.indexOf(this._queued,e),t>-1?this._queued.splice(t,1):void 0},e.prototype.reset=function(){return this._queued=[],this._concurrentInProgress=0},e.prototype._sort=function(){return this._queued=_.sortBy(this._queued,function(e){return e.priority})},e.prototype._spawn=function(){var e,t;for(t=[];this._canSpawn();)e=this._queued.shift(),this._concurrentInProgress++,e.on("complete",this._loadComplete,this),e.on("error",this._loadError,this),t.push(e.start());return t},e.prototype._loadComplete=function(e){return this._loadDone(e)},e.prototype._loadError=function(e){var t;return e.canRetry()&&(t=function(){return e.attemptingRetry(),this.add(e)},_.delay(_.bind(t,this),e.retryDelay())),this._loadDone(e)},e.prototype._loadDone=function(e){return e.off(null,null,this),this._concurrentInProgress--,this._spawn()},e.prototype._canSpawn=function(){return 0<this._queued.length&&t>this._concurrentInProgress},e}(),n=function(){function e(e,t){null==t&&(t=0),this.priority=t,this.src=e,this._retryCount=0}return _.extend(e.prototype,Backbone.Events),e.prototype.start=function(){var e;return e=new Image,e.onload=_.bind(this._loadComplete,this),e.onerror=_.bind(this._loadError,this),e.src=this.src},e.prototype.canRetry=function(){return 3>this._retryCount},e.prototype.retryDelay=function(){switch(this._retryCount){case 0:return 1e3;case 1:return 3e3;case 2:return 6e3;default:return null}},e.prototype.attemptingRetry=function(){return this._retryCount++},e.prototype._loadComplete=function(){return this.trigger("complete",this)},e.prototype._loadError=function(){return this.trigger("error",this)},e}(),i=function(e){function t(e,t,i){null==i&&(i=0),this.priority=i,this.src=e.getImage(t),this._retryCount=0}return o(t,e),t}(n),ThisLife.Support.ImageQueue=e,ThisLife.Support.QueueableImage=n,ThisLife.Support.MomentQueueableImage=i,define("ThisLife.Support.ImageQueue",[],function(){return ThisLife.Support.ImageQueue})}.call(this),function(){var e;e=function(){function e(e,t){var i;this._$scrollEl=$(e),this._views=t,this._imageQueue=(null!=(i=ThisLife.app.library)?i._imageQueue:void 0)||new ThisLife.Support.ImageQueue,_.bindAll(this,"_scroll","_resize")}return e.prototype.updateViews=function(e){return this._views=e,this._scroll()},e.prototype.setup=function(){return this._views&&0<this._views.length?(this._calculateRowDimensions(),this._bindEvents(),this._scroll()):void 0},e.prototype.destroy=function(){return this._imageQueue.reset(),this._unbindEvents()},e.prototype._bindEvents=function(){return this._$scrollEl.on("scroll",this._scroll),this._$scrollEl.on("resize",this._resize)},e.prototype._unbindEvents=function(){return this._$scrollEl.off("scroll",this._scroll),this._$scrollEl.off("resize",this._resize)},e.prototype._resize=function(){return this._calculateRowDimensions(),this._scroll()},e.prototype._scroll=function(){var e,t,i,n,o,s,r,l,a,u;for(a=this._$scrollEl.scrollTop(),t=Math.floor(a/this._rowHeight),o=Math.ceil((a+this._$scrollEl.height())/this._rowHeight),u=t*this._itemsPerRow,e=Math.min(o*this._itemsPerRow,this._views.length),l=[],n=i=s=u,r=e;r>=s?r>i:i>r;n=r>=s?++i:--i)l.push(this._requestImage(this._views[n]));return l},e.prototype._requestImage=function(e){var t,i,n,o;if(e&&!e.imageRequested)return e.imageRequested=!0,o=e.getImageUrl(),t=function(t){return function(){return e.loadImage(o),n.off(null,null,t)}}(this),i=function(e){return function(){return n.off(null,null,e)}}(this),n=new ThisLife.Support.QueueableImage(o),n.on("complete",t,this),n.on("error",i,this),this._imageQueue.add(n)},e.prototype._calculateRowDimensions=function(){var e;return e=$(this._views[0].el),this._itemsPerRow=Math.floor(this._$scrollEl.width()/e.outerWidth()),this._rowHeight=e.outerHeight()},e}(),ThisLife.Support.LazyImageLoader=e}.call(this),function(){var e,t=function(e,t){function n(){this.constructor=e}for(var o in t)i.call(t,o)&&(e[o]=t[o]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e
},i={}.hasOwnProperty;e=function(e){function i(){return i.__super__.constructor.apply(this,arguments)}return t(i,e),i.prototype.setup=function(){return this._views&&0<this._views.length?(this._element=this._checkView(this._$scrollEl,this._views[0]),this._calculateRowDimensions(this._$scrollEl,this._element),this._bindEvents(),this._scroll()):void 0},i.prototype._resize=function(){return this._calculateRowDimensions(this._$scrollEl,this._element),this._scroll()},i.prototype._scroll=function(){var e,t,i,n,o,s,r,l,a,u;for(a=this._$scrollEl.scrollTop(),t=this._calcFirstVisibleRowIndex(a,this._rowHeight),o=this._calcLastVisibleRowIndex(this._$scrollEl.height(),this._rowHeight,t),u=t*this._itemsPerRow,e=Math.min(o*this._itemsPerRow,this._views.length),l=[],n=i=s=u,r=e;r>=s?r>i:i>r;n=r>=s?++i:--i)l.push(this._requestImage(this._views[n]));return l},i.prototype._requestImage=function(e){var t,i,n,o;if(e&&!e.imageRequested)return e.imageRequested=!0,o=e.getImageUrl(),t=function(t){return function(){return e.loadImage(o),t._$scrollEl[0].appendChild(e.$el[0]),n.off(null,null,t)}}(this),i=function(e){return function(){return n.off(null,null,e)}}(this),n=new ThisLife.Support.QueueableImage(o),n.on("complete",t,this),n.on("error",i,this),this._imageQueue.add(n)},i.prototype._calcFirstVisibleRowIndex=function(e,t){return 0===e?0:Math.ceil(e/t)},i.prototype._calcLastVisibleRowIndex=function(e,t,i){return Math.ceil((i*t+e)/t)},i.prototype._calculateRowDimensions=function(e,t){return this._itemsPerRow=Math.floor(e.width()/t.outerWidth()),this._rowHeight=t.outerHeight()},i.prototype._checkView=function(e,t){var i;return i=$(t.el),0===e.find(t.el).length&&(i=$(e.get(0).appendChild(t.render().el))),i},i}(ThisLife.Support.LazyImageLoader),ThisLife.Support.LazyImageLoaderPeople=e}.call(this),function(){ThisLife.AppRouter=ThisLife.Router.Router.extend({controllerRoutes:{"":"index","*path":"index","story/:id":"story","story/following/:id":"storyFollowing","library/:id":"momentLibrary","library/rediscovery/:action/:ids":"shareLibrary","library/date/:date":"dateLibrary","library/recentUpload":"recentlUpload",library:"library",videolibrary:"videoLibrary",stories:"stories","stories/following":"storiesFollowing",albums:"albums","albums/friends":"albumsFriends","albums/suggested":"albumsSuggested",lifetouch:"lifetouch","folder/:id":"albumsFolder","album/:id":"albumsView","album/:id/add":"albumsUploadView","album/:id/full/:moment":"albumsViewFull","album/:id/full/:moment/zoom":"albumsViewFull",people:"people",tags:"tags","people/suggestions":"peopleSuggestions","person/suggestions":"peopleSuggestions","people/:id":"peopleCatchall","people/:id/:moment":"peopleCatchall","people/edit/:id":"peopleCatchall","people/vip/:id":"peopleCatchall","tags/:id":"tagsCatchall","tags/:id/:moment":"tagsCatchall","full/:id":"fullView","full/:id/zoom":"fullView","story/:storyUid/full/:momentUid":"storyFullView","story/:storyUid/full/:momentUid/zoom":"storyFullView","stories/invites":"storyInvites",settings:"settings","settings/:view":"settingsView",share:"share",upgrade:"upgrade",logout:"logout",refresh:"refresh",add:"add",trash:"trash","email/rediscovery?*querystring":"emailRediscovery","email/holiday?*querystring":"emailHoliday","moment_download/:uid":"momentDownload","video_download/:uid":"videoDownload","gifts/:event":"giftingRoute","gifts/:event/page:page":"giftingRouteWithPage","gifts/:event?person=:person":"giftingRouteWithPerson","feature/:name/:enabled":"setFeatureStatus"},initialize:function(){return this.controller=new ThisLife.AppRouteController(this),ThisLife.Router.Router.prototype.initialize.apply(this,arguments)},start:function(e){var t;return null==e&&(e=!1),Backbone.history.start({pushState:!0,silent:!0}),t=Backbone.history.fragment,(e||/searched/.exec(t))&&this.navigateToIndex({trigger:!1,replace:!0}),Backbone.history.loadUrl()},navigateToIndex:function(e){return null==e&&(e=!0),this.navigate("",e)},navigateToLibrary:function(e){return null==e&&(e=!0),this.navigate("library",e)},navigateToLibraryMoment:function(e,t,i){return null==t&&(t=!0),null==i&&(i=""),this.navigate("library/"+e+i,t)},navigateToHome:function(e){return null==e&&(e=!0),this.navigate("home",e)},navigateToUpgrade:function(e){return null==e&&(e=!0),this.navigate("upgrade",e)},navigateToAdd:function(e){return null==e&&(e=!0),this.navigate("add",e)},navigateToStory:function(e,t){return null==t&&(t=!0),this.navigate("album/"+e,t)},navigateToStoryFollowing:function(e,t){return null==t&&(t=!0),this.navigate("album/"+e,t)},navigateToStoryInvites:function(e){return null==e&&(e=!0),this.navigate("albums",e)},navigateToStoryFullView:function(e,t,i){return null==i&&(i=!0),this.navigate("album/"+e+"/full/"+t,i)},navigateToStoryFullViewZoom:function(e,t,i){return null==i&&(i=!0),this.navigateToStoryFullView(e,t,i)},navigateToStories:function(e){return null==e&&(e=!0),this.navigate("albums",e)},navigateToAlbums:function(e){return null==e&&(e=!0),this.navigate("albums",e)},navigateToAlbumsFriends:function(e){return null==e&&(e=!0),this.navigate("albums/friends",e)},navigateToAlbumsSuggested:function(e){return null==e&&(e=!0),this.navigate("albums/suggested",e)},navigateToAlbum:function(e,t){return null==t&&(t=!0),this.navigate("album/"+e,t)},navigateToAlbumUpload:function(e,t){return null==t&&(t=!0),this.navigate("album/"+e+"/add",t)},navigateToAlbumFullView:function(e,t,i){return null==i&&(i=!0),this.navigate("album/"+e+"/full/"+t,i)},navigateToAlbumFullViewZoom:function(e,t,i){return null==i&&(i=!0),this.navigateToAlbumFullView(e,t,i)},navigateToFolder:function(e,t){return null==t&&(t=!0),this.navigate("folder/"+e,t)},navigateToStoriesFollowing:function(e){return null==e&&(e=!0),this.navigate("albums/friends",e)},navigateToFullView:function(e,t,i){return null==t&&(t=!0),null==i&&(i=""),this.navigate("full/"+e+i,t)},navigateToFullViewZoom:function(e,t){return null==t&&(t=!0),this.navigateToFullView(e,t)},navigateToPeople:function(e){return null==e&&(e=!0),this.navigate("people",e)},navigateToPeopleFiltered:function(e,t,i){var n;return null==i&&(i=!0),n="person/"+e,t&&(n+="/"+t),this.navigate(n,i)},navigateToPeopleChangeCover:function(e,t){return null==t&&(t=!0),this.navigate("person/cover/"+e,t)},navigateToPeopleSuggestions:function(e){return null==e&&(e=!0),"people"===this.fragment()||(this.navigateToPeople(),"person/suggestions"!==this.fragment())?this.navigate("person/suggestions",e):void 0},navigateToPersonDetails:function(e){return null==e&&(e=!0),"people"===this.fragment()||(this.navigateToPeople(),"person/details"!==this.fragment())?this.navigate("person/details",e):void 0},navigateToLogout:function(e){return null==e&&(e=!0),this.navigate("logout",e)},navigateToTags:function(e){return null==e&&(e=!0),this.navigate("tags",e)},navigateToTagsFiltered:function(e,t,i){var n;return null==i&&(i=!0),n="tag/"+e,t&&(n+="/"+t),this.navigate(n,i)},navigateToSettings:function(e){return null==e&&(e=!0),this.navigate("settings",e)},navigateToSettingsView:function(e,t){return null==t&&(t=!0),this.navigate("settings/"+e,t)},navigateToShare:function(e){return null==e&&(e=!0),this.navigate("share",e)},navigateToTrash:function(e){return null==e&&(e=!0),this.navigate("trash",e)},fragment:function(){return Backbone.history.fragment}})}.call(this),function(){ThisLife.AppRouterMobile=ThisLife.AppRouter.extend({controllerRoutes:{"":"index","*path":"index","email/rediscovery?*querystring":"emailRediscovery","email/holiday?*querystring":"emailHoliday","gifts/:event":"giftingRoute","gifts/:event/page:page":"giftingRouteWithPage","gifts/:event?person=:person":"giftingRouteWithPerson","full/:id":"fullViewMobile",library:"library","library/:id":"momentLibrary","library/date/:date":"dateLibrary","feature/:name/:enabled":"setFeatureStatus",albums:"albums","albums/friends":"albumsFriends","albums/suggested":"albumsSuggested","folder/:id":"albumsFolder","album/:id":"albumsView","album/:id/add":"albumsUploadView","album/:id/full/:moment":"albumsViewFull","album/:id/full/:moment/zoom":"albumsViewFull"}})}.call(this),function(){var e,t,i,n,o;e=require("ThisLife.LifeTouch.Views.WelcomeOverlay"),ThisLife.AppRouteController=function(){function s(e){this.router=e}return s.prototype.index=function(){var e;return e=this.router.fragment(),ThisLife.app.whenReady(function(t){return function(){return e===t.router.fragment()?"home"===ThisLife.app.defaultStateName()?t.router.navigateToHome({replace:!0,trigger:!0}):t.router.navigateToLibrary({replace:!0,trigger:!0}):void 0}}(this))},s.prototype.momentLibrary=function(e){return this.library({momentUid:e})},s.prototype.shareLibrary=function(e,t){var i;return null==e&&(e="share"),this.router.navigateToLibrary({replace:!0}),i=this.router.fragment(),ThisLife.Collection.moments.whenLoaded(function(n){return function(){var o,s;if(i===n.router.fragment()){if(t=t.split(","),s=ThisLife.Collection.moments.getOrderedByDate(t,!1),!s.length)return void n.library();switch(n.momentLibrary(s[0].id),ThisLife.app.controller("selection").start(),ThisLife.app.controller("selection").addModels(s),o=ThisLife.app.controller("selection").getActions(),e){case"email":o._shareEmail();break;case"link":o._shareLink();break;case"share_sites":o._shareSites();break;case"facebook":o._shareFacebook();break;case"twitter":o._shareTwitter();break;case"tumblr":o._shareTumblr()}return ThisLife.Service.api.setSubSource("shareMoments","RediscoveryEmail"),ThisLife.app.controller("selection").once("done",function(){return ThisLife.Service.api.clearSubSource("shareMoments")})}}}(this))},s.prototype.recentlUpload=function(e){var t,o,s;return o=(null!=(s=ThisLife.app.lastLibraryState)?s.name:void 0)||"library",i(o),this.router.navigateToLibrary({replace:!0}),t=this.router.fragment(),ThisLife.Collection.moments.whenLoaded(function(i){return function(){return t===i.router.fragment()?(n(o,e),ThisLife.Collection.moments.setSort("uploadDate"),ThisLife.PubSub.trigger("update:sort","uploadDate")):void 0}}(this))},s.prototype.dateLibrary=function(e){return this.library({momentDate:e})},s.prototype.videoLibrary=function(){return this.router.navigateToLibrary(),ThisLife.Collection.moments.whenLoaded(function(){return function(){return ThisLife.app.filter.setShowOnlyVideos(!0)}}(this))},s.prototype.library=function(e){var o,s,r;return s=(null!=(r=ThisLife.app.lastLibraryState)?r.name:void 0)||"library",t(s)?void 0:(i(s),o=this.router.fragment(),ThisLife.Helper.Features.whenReady("upp",function(t){return function(i){return ThisLife.Collection.moments.whenLoaded(function(){return o===t.router.fragment()?0!==ThisLife.Collection.moments.getMomentCount()||ThisLife.app.isMobile||i?n(s,e):void t.router.navigateToAdd({trigger:!0,replace:!0}):void 0})}}(this)))},s.prototype.story=function(e){return this.router.navigateToAlbum(e,{replace:!0,trigger:!0})},s.prototype.storyFollowing=function(e){return this.router.navigateToAlbum(e,{replace:!0,trigger:!0})},s.prototype.lifetouch=function(t,i){return null==i&&(i={}),ThisLife.app.whenReady(function(t){return function(){return ThisLife.Model.Albums.Master.whenLoaded(function(){var i,n;return ThisLife.Model.Albums.Master.setActiveFolderId("lifetouch"),t.router.navigateToAlbums({replace:!0,trigger:!0}),i=ThisLife.appModel.getOnboardingFlows(),1!==i.l?(n=new e,document.body.appendChild(n.el)):void 0})}}(this))},s.prototype.handleAlbumsRoute=function(e,o){var s;return null==o&&(o={}),t("albums")&&"full"!==e?void 0:(o.view=e,i("albums"),s=this.router.fragment(),ThisLife.app.whenReady(function(t){return function(){return ThisLife.Model.Albums.Master.whenLoaded(function(){var i;if(s===t.router.fragment())return"album"!==e||ThisLife.Model.Albums.Master.getAlbumById(o.album_uid)?"folder"!==e||ThisLife.Model.Albums.Master.getFolderById(o.folder_uid)||!o.folder_uid!==ThisLife.Model.Albums.Master.getLifetouchFolderId()?n("albums",o):(ThisLife.Model.Albums.Master.setActiveFolderId(null),t.router.navigateToAlbums({replace:!0,trigger:!0})):(i=new ThisLife.View.Error({message:"You do not have access to this Album in your account. Please contact the Album owner to invite you to the Album to get access."}),i.show(),t.router.navigateToAlbums({replace:!0,trigger:!0}))})}}(this)))},s.prototype.albums=function(){return ThisLife.app.whenReady(function(e){return function(){var t;return t=ThisLife.Model.User.get("migration_status"),"sfly"!==t&&"sfly_migrated"!==t&&"tl_migrated"!==t?(ThisLife.log.debug("%c Navigate to albums migration page!","background-color: green; color: yellow;"),void ThisLife.app.controller("albums_migration").showMigrationView()):(ThisLife.Model.Albums.Master.loaded||ThisLife.PubSub.trigger("addLoader"),ThisLife.Model.Albums.Master.whenLoaded(function(){var t,i;if(t=ThisLife.Model.Albums.Master.getActiveFolderId()){if("friends"===t)return ThisLife.app.router.navigateToAlbumsFriends();if("suggested"===t)return ThisLife.app.router.navigateToAlbumsSuggested();if("lifetouch"===t)return t=ThisLife.Model.Albums.Master.getLifetouchFolderId(),ThisLife.app.router.navigateToFolder(t);if(ThisLife.Model.Albums.Master.getFolderById(t))return ThisLife.app.router.navigateToFolder(t)}else{if(!(i=ThisLife.Model.Albums.Master.getDefaultFolder()))return e.handleAlbumsRoute("all");if(i&&i.get("uid"))return ThisLife.app.router.navigateToFolder(i.get("uid"))}}))}}(this))},s.prototype.albumsFriends=function(){return ThisLife.app.whenReady(function(e){return function(){return ThisLife.Model.Albums.Master.whenLoaded(function(){return 0===ThisLife.Model.Albums.Master.getSharedAlbums().models.length?ThisLife.app.router.navigateToAlbums():(ThisLife.Model.Albums.Master.setActiveFolderId("friends"),e.handleAlbumsRoute("friends"))})}}(this))},s.prototype.albumsSuggested=function(){return ThisLife.app.whenReady(function(e){return function(){return ThisLife.Model.Albums.Master.whenLoaded(function(){return 0===ThisLife.Model.Albums.Master.getAutoAlbums().models.length?ThisLife.app.router.navigateToAlbums():(ThisLife.Model.Albums.Master.setActiveFolderId("suggested"),e.handleAlbumsRoute("suggested"))})}}(this))},s.prototype.albumsFolder=function(e){return ThisLife.app.whenReady(function(){return function(){return ThisLife.Model.Albums.Master.whenLoaded(function(){return ThisLife.Model.Albums.Master.setActiveFolderId(e)})}}(this)),this.handleAlbumsRoute("folder",{folder_uid:e})},s.prototype.albumsView=function(e){return this.handleAlbumsRoute("album",{album_uid:e})},s.prototype.albumsUploadView=function(e){return this.handleAlbumsRoute("upload",{album_uid:e})},s.prototype.albumsViewFull=function(e,t,i){var s,r;return null==i&&(i={}),ThisLife.app.album.isActiveStory(e)?(r=ThisLife.app.album.getCollection().get(t),r?(n("albums",{album_uid:e,moment_uid:t,view:"full"}),o("fullView",{album_uid:e,inStory:!0,moment:r,moment_uid:t,selection:ThisLife.app.controller("selection"),share:!1})):this.router.back()):(s=this.router.fragment(),ThisLife.app.whenReady(function(n){return function(){return ThisLife.Model.Albums.Master.whenLoaded(function(){return s===n.router.fragment()?ThisLife.Model.Albums.Master.getAlbumById(e)?(n.router.navigateToAlbums({replace:!0}),n.router.navigateToAlbum(e),s=n.router.fragment(),ThisLife.app.album.whenLoaded(function(){return s===n.router.fragment()?n.router.navigateToAlbumFullView(e,t):void 0})):(n.router.navigateToLibrary({replace:!0,trigger:!0}),n.router.navigate(s,{trigger:!1}),ThisLife.app.controller("moment").show("mobile",{moment_uid:t,album_uid:e,share:i.share})):void 0})}}(this)))},s.prototype.albumsViewFullMobile=function(e,t,i){var n;return null==i&&(i={}),n=this.router.fragment(),ThisLife.Collection.moments.whenLoaded(function(o){return function(){return n===o.router.fragment()?(ThisLife.PubSub.trigger("removeLoader"),ThisLife.app.controller("moment").show("mobile",{moment_uid:t,album_uid:e,share:i.share})):void 0}}(this))},s.prototype.stories=function(){return this.router.navigateToAlbums({replace:!0})},s.prototype.storiesFollowing=function(){return this.router.navigateToAlbumsFriends({replace:!0})},s.prototype.storyInvites=function(){return t("storyInvites")?void 0:(ThisLife.app.currentState||(this.router.navigateToStoriesFollowing({replace:!0,trigger:!0}),this.router.navigateToStoryInvites({trigger:!1})),o("storyInvites"))},s.prototype.people=function(){return i("people"),n("people"),ThisLife.app.controller("tags").show("people")},s.prototype.tags=function(){return i("tags"),n("tags"),ThisLife.app.controller("tags").show("tags")},s.prototype.peopleSuggestions=function(){ThisLife.app.currentState||(this.router.navigateToPeople({replace:!0,trigger:!0}),this.router.navigateToPeopleSuggestions({trigger:!1}))},s.prototype.fullView=function(e,t){var i;return null==t&&(t=""),t&&(t="?"+t),i=this.router.fragment(),null!=ThisLife.app.currentState||this.forceFullView?ThisLife.Collection.moments.whenLoaded(function(t){return function(){var n;if(i===t.router.fragment())return n=ThisLife.Collection.moments.get(e),n?o("fullView",{moment:n,selection:ThisLife.app.controller("selection")}):t.router.back()}}(this)):(this.forceFullView=!0,this.router.navigateToLibraryMoment(e,{replace:!0},t),void this.router.navigateToFullView(e,!0,t))},s.prototype.fullViewMobile=function(e,t){var i;return i=this.router.fragment(),ThisLife.Collection.moments.whenLoaded(function(o){return function(){return i===o.router.fragment()?(ThisLife.PubSub.trigger("removeLoader"),n("fullview",{}),ThisLife.app.controller("moment").show("mobile",{moment_uid:e,share:null!=t?t.share:void 0})):void 0}}(this))},s.prototype.storyFullView=function(e,t){return this.router.navigateToAlbumFullView(e,t,{replace:!0,trigger:!0})},s.prototype.settings=function(){return this._ensureIndexIsDefaultForModal(),ThisLife.Collection.moments.whenLoaded(function(){return function(){return o("settings")}}(this))},s.prototype.settingsView=function(e){return this._ensureIndexIsDefaultForModal(),ThisLife.Collection.moments.whenLoaded(function(){return function(){return o("settings",{view:e})}}(this))},s.prototype.share=function(){var e;return this._ensureIndexIsDefaultForModal(),e=this.router.fragment(),ThisLife.Model.User.whenLoaded(function(t){return function(){return e===t.router.fragment()?o("share"):void 0}}(this))},s.prototype.upgrade=function(){return this._ensureIndexIsDefaultForModal(),ThisLife.Collection.moments.whenLoaded(function(e){return function(){var t;return t=e.router.fragment(),ThisLife.Model.User.whenLoaded(function(){return t===e.router.fragment()?o("upgrade"):void 0})}}(this))},s.prototype.add=function(){var e;return e=this.router.fragment(),i("timeline"),ThisLife.Collection.moments.whenLoaded(function(t){return function(){return e===t.router.fragment()?(ThisLife.PubSub.trigger("removeLoader"),n("timeline",{}),ThisLife.app.controller("timeline").upload(null,!0)):void 0}}(this))},s.prototype.trash=function(){var e;return e=this.router.fragment(),ThisLife.Collection.moments.whenLoaded(function(t){return function(){return e===t.router.fragment()?(n("trash",{}),ThisLife.app.controller("trash").show()):void 0}}(this))},s.prototype.emailRediscovery=function(e){var t;return null==e&&(e=""),t=this.router.fragment(),ThisLife.Model.User.whenLoaded(function(i){return function(){var n,o,s,r,l;if(t===i.router.fragment()){if(r=ThisLife.Helper.URL.parseQueryString(e),r.life_uid&&r.life_uid!==ThisLife.Model.User.get("life_permissions")[0].life_uid)return s=function(){var e,t;return null!=(e=ThisLife.app)&&"function"==typeof e.controller&&null!=(t=e.controller("timing"))&&t.recordSessionEvents({event:"logout",err:"logout callback",session_method:"emailRediscovery"}),ThisLife.app.logout(!1,!0)},o=function(){return i.router.navigateToLibrary()},l=new ThisLife.View.ModalAlert({template:"privateAccount",callback:s,cancelCallback:o}),$(document.body).append(l.render().el),ThisLife.app.controller("tracking").logPrivateAccountError();switch(n="?CID=",null!=r.CID?n+=r.CID:n="",r.view){case"fmv":return i.router.navigateToFullView(r.moment_uid,!0,n);case"library":return null!=r.moment_uid?i.router.navigateToLibraryMoment(r.moment_uid):i.router.navigate("library/date/"+r.start_date+n);case"share":return i.shareLibrary(r.share_type,r.moment_uids);default:return i.router.navigateToLibrary()}}}}(this)),ThisLife.app.controller("tracking").logPageEvent("email/rediscovery",!0)},s.prototype.emailHoliday=function(e){var t;return null==e&&(e=""),t=ThisLife.Helper.URL.parseQueryString(e),null==t.moment?this.router.navigate("/"):null!=t.album?(this.router.navigate("/album/"+t.album+"/full/"+t.moment,{trigger:!1}),this.albumsViewFull(t.album,t.moment,{share:t.share})):(this.router.navigate("/full/"+t.moment,{trigger:!1}),this.fullViewMobile(t.album,t.moment,{share:t.share}))},s.prototype.giftingRoute=function(e,t){return null==t&&(t={}),ThisLife.app.whenReady(function(){return function(){return i("gifting",{}),n("gifting",{}),ThisLife.app.controller("gifting").show(e,1,t)}}(this))},s.prototype.giftingRouteWithPage=function(e,t,o){return null==o&&(o={}),i("gifting",{}),n("gifting",{}),ThisLife.app.controller("gifting").show(e,t,o)},s.prototype.giftingRouteWithPerson=function(e,t){return this.giftingRoute(e,{person:t})},s.prototype.setFeatureStatus=function(e,t){var i;return i="true"===t?!0:!1,ThisLife.Helper.Features.setFeature(e,i,!0),this.router.navigateToLibrary({replace:!0,trigger:!0})},s.prototype.momentDownload=function(e){var t;return t=this.router.fragment(),ThisLife.Model.User.whenLoaded(function(i){return function(){var n;if(t===i.router.fragment())return i.router.navigateToLibrary(),n=ThisLife.app.controller("download"),n.show({uid:e})}}(this))},s.prototype.videoDownload=function(e){var t;return t=this.router.fragment(),ThisLife.Model.User.whenLoaded(function(i){return function(){var n;if(t===i.router.fragment())return i.router.navigateToLibrary(),n=ThisLife.app.controller("video"),n.show({uid:e})}}(this))},s.prototype.logout=function(){var e,t;return null!=(e=ThisLife.app)&&"function"==typeof e.controller&&null!=(t=e.controller("timing"))&&t.recordSessionEvents({event:"user logout",session_method:"logout"}),ThisLife.app.logout()},s.prototype.refresh=function(){return ThisLife.app.refresh()},s.prototype.peopleCatchall=function(){var e;return e=Backbone.history.fragment.replace("people","person"),this.router.navigate(e,{replace:!0,trigger:!0})},s.prototype.tagsCatchall=function(){var e;return e=Backbone.history.fragment.replace("tags","tag"),this.router.navigate(e,{replace:!0,trigger:!0})},s.prototype._ensureIndexIsDefaultForModal=function(){var e;return ThisLife.app.currentState?void 0:(e=this.router.fragment(),this.router.navigateToIndex({replace:!0}),this.router.navigate(e,{trigger:!1}))},s}(),n=function(e,t){return ThisLife.app.whenReady(function(){return function(){return ThisLife.app.setState(e,t)}}(this))},i=function(e){return ThisLife.app.whenReady(function(){return function(){return ThisLife.app.preStateChange(e)}}(this))},o=function(e,t){return ThisLife.app.whenReady(function(){return function(){return ThisLife.app.showModal(e,t)}}(this))},t=function(e){var t;return t=ThisLife.app.currentState,null!=t&&e===t.name&&ThisLife.app.router.fragment()===t.fragment?(i(e),n(e,ThisLife.app.currentState.options),!0):!1},define("ThisLife.AppRouteController",[],function(){return AppRouteController})}.call(this),function(){var e,t,i,n,o=function(e,t){function i(){this.constructor=e}for(var n in t)s.call(t,n)&&(e[n]=t[n]);return i.prototype=t.prototype,e.prototype=new i,e.__super__=t.prototype,e},s={}.hasOwnProperty;ThisLife.AppBrowser=function(){function o(){this.cssClassName="",this.isMobile()}return o.create=function(){var o;return o=ThisLife.Helper.Platform.safari()?new n:ThisLife.Helper.Platform.firefox()?new t:ThisLife.Helper.Platform.ie()||ThisLife.Helper.Platform.msedge()?new i:ThisLife.Helper.Platform.chrome()?new e:new ThisLife.AppBrowser},o.prototype.isMobile=function(){return ThisLife.Helper.Platform.mobile()?(""!==this.cssClassName&&(this.cssClassName+=" "),this.cssClassName+="mobile"):void 0},o}(),t=function(e){function t(){this.cssClassName="firefox",this.isMobile(),window.addEventListener("keydown",this._preventKillServerRequestsHandler)}return o(t,e),t.prototype._preventKillServerRequestsHandler=function(e){return ThisLife.Helper.Keyboard.isEscape(e.keyCode)?e.preventDefault():void 0},t}(ThisLife.AppBrowser),i=function(e){function t(){this.cssClassName="msie",ThisLife.Helper.Platform.ie10()?this.cssClassName+=" msie10":ThisLife.Helper.Platform.ie11()?this.cssClassName+=" msie11":ThisLife.Helper.Platform.msedge()&&(this.cssClassName+=" msedge"),this.isMobile()}return o(t,e),t}(ThisLife.AppBrowser),e=function(e){function t(){this.cssClassName="chrome",this.isMobile()}return o(t,e),t}(ThisLife.AppBrowser),n=function(e){function t(){this.cssClassName="safari",this.isMobile()}return o(t,e),t}(ThisLife.AppBrowser)}.call(this),function(){_.extend(ThisLife.Settings,{hdVideos:!1,useDatabase:!0,disableAlbumUpload:!1,isProdEnv:function(){return"tlprod"===this.env},isStageEnv:function(){return"tlstage"===this.env},isDevelopmentEnv:function(){return"development"===this.env},uploaderUrl:function(){return ThisLife.Helper.Platform.macOSX()?this.isProdEnv()||this.isStageEnv()?ThisLife.manifest.macUploader:ThisLife.manifest.macUploader:this.isProdEnv()||this.isStageEnv()?ThisLife.manifest.winUploader:ThisLife.manifest.winUploader},macPhotosExtensionUrl:function(){return ThisLife.Helper.Platform.macOSX()?this.isProdEnv()||this.isStageEnv()?ThisLife.manifest.macPhotosExtension:ThisLife.manifest.macPhotosExtension:void 0},macPhotosExtnInstructionsUrl:function(){return this.isProdEnv()||this.isStageEnv()?ThisLife.manifest.macPhotosExtnInstructions:ThisLife.manifest.macPhotosExtnInstructions},enableLog:function(){return!this.isProdEnv()},enableGlobalErrorHandler:function(){return!this.isProdEnv()&&(ThisLife.Helper.Platform.ie()||!this.isDevelopmentEnv())}})}.call(this),function(){var e,t,i,n;e="upgrade_shown"+ThisLife.Settings.cookieSuffix,t=864e5,i="serverTimeAtLogin",ThisLife.AppModel=function(){function i(e){this.options=e,this.hdVideos=ThisLife.Settings.hdVideos,ThisLife.PubSub.on("state:change",n)}return _.extend(i.prototype,Backbone.Events),i.prototype.clear=function(){return $.cookies.del(!0,{domain:document.domain}),this._clearPreferences()},i.prototype.clearSession=function(e){var t;return null==e&&(e=!0),this._clearPreferences(),e?(t=ThisLife.Settings.cookieSuffix,$.cookies.del("perishable_token"+t,{domain:document.domain}),$.cookies.del("sessionToken"+t,{domain:document.domain}),$.cookies.del("life_uid"+t,{domain:document.domain}),$.cookies.del("old_life",{domain:document.domain}),$.cookies.del("sessionUpdated"+t,{domain:document.domain})):void 0},i.prototype.saveMoments=function(e){var t;return t=ThisLife.performanceMonitor.start("creating Backbone models/collections for "+e.length+" moments"),e.length?ThisLife.Collection.moments.initialSet(e):(ThisLife.Collection.moments.noMoments=!0,ThisLife.Collection.moments.reset()),ThisLife.performanceMonitor.end(t)},i.prototype.getOverlimitCheckDate=function(){return $.cookies.get(e)},i.prototype.isOverlimitCheckDateExpired=function(){var e,t,i;return i=ThisLife.appModel.getOverlimitCheckDate(),i?(e=new Date(i),t=new Date,e-t>=0?!1:!0):!0},i.prototype.updateCheckOverlimitDate=function(){var i;return i=new Date,i=new Date(i.setTime(i.getTime()+t)),$.cookies.set(e,i,{domain:document.domain,expiresAt:i}),this},i.prototype.addUsedRelationship=function(e){var t,i;return t=["01","02","03","19","20","04","05"],_.contains(t,e)?(i=this.getUsedRelationships()||[],i.push(e),"05"===e&&i.push("04"),"04"===e&&i.push("05"),this.setUsedRelationships(_.uniq(i)),ThisLife.PubSub.trigger("relationships:changed")):void 0},i.prototype.removeUsedRelationship=function(e){var t;return t=this.getUsedRelationships()||[],t=_.reject(t,function(t){return t===e}),this.setUsedRelationships(t),ThisLife.PubSub.trigger("relationships:changed"),this},i.prototype.toggleShowRatings=function(){return this._setShowRatings(!this.getShowRatings())},i.prototype.getShowRatings=function(){var e;return e=this._getLocalStorage("showRatings"),null!=e?e:!0},i.prototype.getTagViewOptions=function(){return this._getLocalStorage("tagsViewOptions")||{}},i.prototype.setTagViewOptions=function(e){return this._setLocalStorage("tagsViewOptions",e)},i.prototype.getFirstTimeSuggestedFaces=function(){return!this._getLocalStorage("firstTimeSuggestedFacesDontShowAgain")},i.prototype.setFirstTimeSuggestedFaces=function(e){return null==e&&(e=!0),this._setLocalStorage("firstTimeSuggestedFacesDontShowAgain",e)},i.prototype.getFirstTimeStoriesGuide=function(){return!this._getLocalStorage("firstTimeStoriesGuide")},i.prototype.setFirstTimeStoriesGuide=function(e){return null==e&&(e=!0),this._setLocalStorage("firstTimeStoriesGuide",e)},i.prototype.getFirstTimeAlbumGuide=function(){return!this._getLocalStorage("firstTimeAlbumGuide")},i.prototype.setFirstTimeAlbumGuide=function(e){return null==e&&(e=!0),this._setLocalStorage("firstTimeAlbumGuide",e)},i.prototype.getFirstTimeTagsGuide=function(){return!this._getLocalStorage("firstTimeTagsGuide")},i.prototype.setFirstTimeTagsGuide=function(e){return null==e&&(e=!0),this._setLocalStorage("firstTimeTagsGuide",e)},i.prototype.getFirstTimePeopleGuide=function(){return!this._getLocalStorage("firstTimePeopleGuide")},i.prototype.setFirstTimePeopleGuide=function(e){return null==e&&(e=!0),this._setLocalStorage("firstTimePeopleGuide",e)},i.prototype.getFirstTimeAddToStory=function(){return!this._getLocalStorage("firstTimeAddToStoryTooltip")},i.prototype.setFirstTimeAddToStory=function(e){return null==e&&(e=!0),this._setLocalStorage("firstTimeAddToStoryTooltip",e)},i.prototype.getFullViewSidebarHidden=function(){return this._getLocalStorage("fullViewSidebarHidden")},i.prototype.setFullViewSidebarHidden=function(e){return null==e&&(e=!0),this._setLocalStorage("fullViewSidebarHidden",e)},i.prototype.setFirstTimeSelectPhotos=function(e){return null==e&&(e=!0),this._setLocalStorage("firstTimeSelectPhotosMagicshop",e)},i.prototype.getFirstTimeSelectPhotos=function(){return this._getLocalStorage("firstTimeSelectPhotosMagicshop")},i.prototype.setUsedRelationships=function(e){return null==e&&(e=[]),this._setLocalStorage("usedRelationships",e)},i.prototype.getUsedRelationships=function(){return this._getLocalStorage("usedRelationships")},i.prototype.setGiftingUserSelection=function(e){return null==e&&(e={}),this._setLocalStorage("giftingUserSelection:"+ThisLife.lifeUid,e)},i.prototype.getGiftingUserSelection=function(){return this._getLocalStorage("giftingUserSelection:"+ThisLife.lifeUid)},i.prototype.getHideBirthdayTooltip=function(){return this._getLocalStorage("HideBirthdayTooltip")},i.prototype.setHideBirthdayTooltip=function(e){return null==e&&(e=!0),this._setLocalStorage("HideBirthdayTooltip",e)},i.prototype.getFeedbackTooltip=function(){return this._getLocalStorage("HideFeedbackTooltip")},i.prototype.setFeedbackTooltip=function(e){return null==e&&(e=!0),this._setLocalStorage("HideFeedbackTooltip",e)},i.prototype.getOnboarding=function(){return this._getLocalStorage("onboarding")},i.prototype.setOnboarding=function(e){return null==e&&(e=0),this._setLocalStorage("onboarding",e)},i.prototype.getSearchOnboarding=function(){return this._getLocalStorage("searchOnboarding")},i.prototype.setOnboardingFlows=function(e){return null==e&&(e=null),this._setLocalStorage("onboardingFlows",e)},i.prototype.getOnboardingFlows=function(){return this._getLocalStorage("onboardingFlows")},i.prototype._setShowRatings=function(e){return this._setLocalStorage("showRatings",e),this.trigger("change:showRatings",e)},i.prototype._setLocalStorage=function(e,t){return ThisLife.Helper.LocalStorage.setObject(e,t)},i.prototype._getLocalStorage=function(e){return ThisLife.Helper.LocalStorage.getObject(e)},i.prototype._clearPreferences=function(){return ThisLife.Helper.LocalStorage.clear()},i}(),n=function(e){var t,i;return t=Backbone.history.fragment.split("/")[0],i="app"+t,_.defer(function(){return"albums"===e.name&&e.fragment.indexOf("full")>=0?void 0:ThisLife.app.controller("tracking").logPageEvent(i,null,e)})}}.call(this),/*!
 * Pusher JavaScript Library v2.2.4
 * http://pusher.com/
 *
 * Copyright 2014, Pusher
 * Released under the MIT licence.
 */
function(){function e(t,i){(null===t||void 0===t)&&e.warn("Warning","You must pass your app key when you instantiate Pusher."),i=i||{};var n=this;this.key=t,this.config=e.Util.extend(e.getGlobalConfig(),i.cluster?e.getClusterConfig(i.cluster):{},i),this.channels=new e.Channels,this.global_emitter=new e.EventsDispatcher,this.sessionID=Math.floor(1e9*Math.random()),this.timeline=new e.Timeline(this.key,this.sessionID,{cluster:this.config.cluster,features:e.Util.getClientFeatures(),params:this.config.timelineParams||{},limit:50,level:e.Timeline.INFO,version:e.VERSION}),this.config.disableStats||(this.timelineSender=new e.TimelineSender(this.timeline,{host:this.config.statsHost,path:"/timeline/v2/jsonp"})),this.connection=new e.ConnectionManager(this.key,e.Util.extend({getStrategy:function(t){return t=e.Util.extend({},n.config,t),e.StrategyBuilder.build(e.getDefaultStrategy(t),t)},timeline:this.timeline,activityTimeout:this.config.activity_timeout,pongTimeout:this.config.pong_timeout,unavailableTimeout:this.config.unavailable_timeout},this.config,{encrypted:this.isEncrypted()})),this.connection.bind("connected",function(){n.subscribeAll(),n.timelineSender&&n.timelineSender.send(n.connection.isEncrypted())}),this.connection.bind("message",function(e){var t=0===e.event.indexOf("pusher_internal:");if(e.channel){var i=n.channel(e.channel);i&&i.handleEvent(e.event,e.data)}t||n.global_emitter.emit(e.event,e.data)}),this.connection.bind("disconnected",function(){n.channels.disconnect()}),this.connection.bind("error",function(t){e.warn("Error",t)}),e.instances.push(this),this.timeline.info({instances:e.instances.length}),e.isReady&&n.connect()}var t=e.prototype;e.instances=[],e.isReady=!1,e.debug=function(){e.log&&e.log(e.Util.stringify.apply(this,arguments))},e.warn=function(){var t=e.Util.stringify.apply(this,arguments);window.console&&(window.console.warn?window.console.warn(t):window.console.log&&window.console.log(t)),e.log&&e.log(t)},e.ready=function(){e.isReady=!0;for(var t=0,i=e.instances.length;i>t;t++)e.instances[t].connect()},t.channel=function(e){return this.channels.find(e)},t.allChannels=function(){return this.channels.all()},t.connect=function(){if(this.connection.connect(),this.timelineSender&&!this.timelineSenderTimer){var t=this.connection.isEncrypted(),i=this.timelineSender;this.timelineSenderTimer=new e.PeriodicTimer(6e4,function(){i.send(t)})}},t.disconnect=function(){this.connection.disconnect(),this.timelineSenderTimer&&(this.timelineSenderTimer.ensureAborted(),this.timelineSenderTimer=null)},t.bind=function(e,t){return this.global_emitter.bind(e,t),this},t.bind_all=function(e){return this.global_emitter.bind_all(e),this},t.subscribeAll=function(){for(var e in this.channels.channels)this.channels.channels.hasOwnProperty(e)&&this.subscribe(e)},t.subscribe=function(e){return e=this.channels.add(e,this),"connected"===this.connection.state&&e.subscribe(),e},t.unsubscribe=function(e){e=this.channels.remove(e),"connected"===this.connection.state&&e.unsubscribe()},t.send_event=function(e,t,i){return this.connection.send_event(e,t,i)},t.isEncrypted=function(){return"https:"===e.Util.getDocument().location.protocol?!0:Boolean(this.config.encrypted)},e.HTTP={},this.Pusher=e}.call(this),function(){function e(e){window.clearTimeout(e)}function t(e){window.clearInterval(e)}function i(e,t,i,n){var o=this;this.clear=t,this.timer=e(function(){null!==o.timer&&(o.timer=n(o.timer))},i)}var n=i.prototype;n.isRunning=function(){return null!==this.timer},n.ensureAborted=function(){this.timer&&(this.clear(this.timer),this.timer=null)},Pusher.Timer=function(t,n){return new i(setTimeout,e,t,function(){return n(),null})},Pusher.PeriodicTimer=function(e,n){return new i(setInterval,t,e,function(e){return n(),e})}}.call(this),function(){Pusher.Util={now:function(){return Date.now?Date.now():(new Date).valueOf()},defer:function(e){return new Pusher.Timer(0,e)},extend:function(e){for(var t=1;t<arguments.length;t++){var i,n=arguments[t];for(i in n)e[i]=n[i]&&n[i].constructor&&n[i].constructor===Object?Pusher.Util.extend(e[i]||{},n[i]):n[i]}return e},stringify:function(){for(var e=["Pusher"],t=0;t<arguments.length;t++)e.push("string"==typeof arguments[t]?arguments[t]:void 0===window.JSON?arguments[t].toString():JSON.stringify(arguments[t]));return e.join(" : ")},arrayIndexOf:function(e,t){var i=Array.prototype.indexOf;if(null===e)return-1;if(i&&e.indexOf===i)return e.indexOf(t);for(var i=0,n=e.length;n>i;i++)if(e[i]===t)return i;return-1},objectApply:function(e,t){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t(e[i],i,e)},keys:function(e){var t=[];return Pusher.Util.objectApply(e,function(e,i){t.push(i)}),t},values:function(e){var t=[];return Pusher.Util.objectApply(e,function(e){t.push(e)}),t},apply:function(e,t,i){for(var n=0;n<e.length;n++)t.call(i||window,e[n],n,e)},map:function(e,t){for(var i=[],n=0;n<e.length;n++)i.push(t(e[n],n,e,i));return i},mapObject:function(e,t){var i={};return Pusher.Util.objectApply(e,function(e,n){i[n]=t(e)}),i},filter:function(e,t){t=t||function(e){return!!e};for(var i=[],n=0;n<e.length;n++)t(e[n],n,e,i)&&i.push(e[n]);return i},filterObject:function(e,t){var i={};return Pusher.Util.objectApply(e,function(n,o){(t&&t(n,o,e,i)||Boolean(n))&&(i[o]=n)}),i},flatten:function(e){var t=[];return Pusher.Util.objectApply(e,function(e,i){t.push([i,e])}),t},any:function(e,t){for(var i=0;i<e.length;i++)if(t(e[i],i,e))return!0;return!1},all:function(e,t){for(var i=0;i<e.length;i++)if(!t(e[i],i,e))return!1;return!0},method:function(e){var t=Array.prototype.slice.call(arguments,1);return function(i){return i[e].apply(i,t.concat(arguments))}},getWindow:function(){return window},getDocument:function(){return document},getNavigator:function(){return navigator},getLocalStorage:function(){try{return window.localStorage}catch(e){}},getClientFeatures:function(){return Pusher.Util.keys(Pusher.Util.filterObject({ws:Pusher.WSTransport,flash:Pusher.FlashTransport},function(e){return e.isSupported({})}))},addWindowListener:function(e,t){var i=Pusher.Util.getWindow();void 0!==i.addEventListener?i.addEventListener(e,t,!1):i.attachEvent("on"+e,t)},removeWindowListener:function(e,t){var i=Pusher.Util.getWindow();void 0!==i.addEventListener?i.removeEventListener(e,t,!1):i.detachEvent("on"+e,t)},isXHRSupported:function(){var e=window.XMLHttpRequest;return Boolean(e)&&void 0!==(new e).withCredentials},isXDRSupported:function(e){e=e?"https:":"http:";var t=Pusher.Util.getDocument().location.protocol;return Boolean(window.XDomainRequest)&&t===e}}}.call(this),function(){Pusher.VERSION="2.2.4",Pusher.PROTOCOL=7,Pusher.host="ws.pusherapp.com",Pusher.ws_port=80,Pusher.wss_port=443,Pusher.sockjs_host="sockjs.pusher.com",Pusher.sockjs_http_port=80,Pusher.sockjs_https_port=443,Pusher.sockjs_path="/pusher",Pusher.stats_host="stats.pusher.com",Pusher.channel_auth_endpoint="/pusher/auth",Pusher.channel_auth_transport="ajax",Pusher.activity_timeout=12e4,Pusher.pong_timeout=3e4,Pusher.unavailable_timeout=1e4,Pusher.cdn_http="http://js.pusher.com/",Pusher.cdn_https="https://js.pusher.com/",Pusher.dependency_suffix=".min",Pusher.getDefaultStrategy=function(e){return[[":def","ws_options",{hostUnencrypted:e.wsHost+":"+e.wsPort,hostEncrypted:e.wsHost+":"+e.wssPort}],[":def","wss_options",[":extend",":ws_options",{encrypted:!0}]],[":def","sockjs_options",{hostUnencrypted:e.httpHost+":"+e.httpPort,hostEncrypted:e.httpHost+":"+e.httpsPort,httpPath:e.httpPath}],[":def","timeouts",{loop:!0,timeout:15e3,timeoutLimit:6e4}],[":def","ws_manager",[":transport_manager",{lives:2,minPingDelay:1e4,maxPingDelay:e.activity_timeout}]],[":def","streaming_manager",[":transport_manager",{lives:2,minPingDelay:1e4,maxPingDelay:e.activity_timeout}]],[":def_transport","ws","ws",3,":ws_options",":ws_manager"],[":def_transport","wss","ws",3,":wss_options",":ws_manager"],[":def_transport","flash","flash",2,":ws_options",":ws_manager"],[":def_transport","sockjs","sockjs",1,":sockjs_options"],[":def_transport","xhr_streaming","xhr_streaming",1,":sockjs_options",":streaming_manager"],[":def_transport","xdr_streaming","xdr_streaming",1,":sockjs_options",":streaming_manager"],[":def_transport","xhr_polling","xhr_polling",1,":sockjs_options"],[":def_transport","xdr_polling","xdr_polling",1,":sockjs_options"],[":def","ws_loop",[":sequential",":timeouts",":ws"]],[":def","wss_loop",[":sequential",":timeouts",":wss"]],[":def","flash_loop",[":sequential",":timeouts",":flash"]],[":def","sockjs_loop",[":sequential",":timeouts",":sockjs"]],[":def","streaming_loop",[":sequential",":timeouts",[":if",[":is_supported",":xhr_streaming"],":xhr_streaming",":xdr_streaming"]]],[":def","polling_loop",[":sequential",":timeouts",[":if",[":is_supported",":xhr_polling"],":xhr_polling",":xdr_polling"]]],[":def","http_loop",[":if",[":is_supported",":streaming_loop"],[":best_connected_ever",":streaming_loop",[":delayed",4e3,[":polling_loop"]]],[":polling_loop"]]],[":def","http_fallback_loop",[":if",[":is_supported",":http_loop"],[":http_loop"],[":sockjs_loop"]]],[":def","strategy",[":cached",18e5,[":first_connected",[":if",[":is_supported",":ws"],e.encrypted?[":best_connected_ever",":ws_loop",[":delayed",2e3,[":http_fallback_loop"]]]:[":best_connected_ever",":ws_loop",[":delayed",2e3,[":wss_loop"]],[":delayed",5e3,[":http_fallback_loop"]]],[":if",[":is_supported",":flash"],[":best_connected_ever",":flash_loop",[":delayed",2e3,[":http_fallback_loop"]]],[":http_fallback_loop"]]]]]]]}}.call(this),function(){Pusher.getGlobalConfig=function(){return{wsHost:Pusher.host,wsPort:Pusher.ws_port,wssPort:Pusher.wss_port,httpHost:Pusher.sockjs_host,httpPort:Pusher.sockjs_http_port,httpsPort:Pusher.sockjs_https_port,httpPath:Pusher.sockjs_path,statsHost:Pusher.stats_host,authEndpoint:Pusher.channel_auth_endpoint,authTransport:Pusher.channel_auth_transport,activity_timeout:Pusher.activity_timeout,pong_timeout:Pusher.pong_timeout,unavailable_timeout:Pusher.unavailable_timeout}},Pusher.getClusterConfig=function(e){return{wsHost:"ws-"+e+".pusher.com",httpHost:"sockjs-"+e+".pusher.com"}}}.call(this),function(){function e(e){var t=function(t){Error.call(this,t),this.name=e};return Pusher.Util.extend(t.prototype,Error.prototype),t}Pusher.Errors={BadEventName:e("BadEventName"),RequestTimedOut:e("RequestTimedOut"),TransportPriorityTooLow:e("TransportPriorityTooLow"),TransportClosed:e("TransportClosed"),UnsupportedTransport:e("UnsupportedTransport"),UnsupportedStrategy:e("UnsupportedStrategy")}}.call(this),function(){function e(e){this.callbacks=new t,this.global_callbacks=[],this.failThrough=e}function t(){this._callbacks={}}var i=e.prototype;i.bind=function(e,t,i){return this.callbacks.add(e,t,i),this},i.bind_all=function(e){return this.global_callbacks.push(e),this},i.unbind=function(e,t,i){return this.callbacks.remove(e,t,i),this},i.unbind_all=function(e,t){return this.callbacks.remove(e,t),this},i.emit=function(e,t){var i;for(i=0;i<this.global_callbacks.length;i++)this.global_callbacks[i](e,t);var n=this.callbacks.get(e);if(n&&0<n.length)for(i=0;i<n.length;i++)n[i].fn.call(n[i].context||window,t);else this.failThrough&&this.failThrough(e,t);return this},t.prototype.get=function(e){return this._callbacks["_"+e]},t.prototype.add=function(e,t,i){e="_"+e,this._callbacks[e]=this._callbacks[e]||[],this._callbacks[e].push({fn:t,context:i})},t.prototype.remove=function(e,t,i){e||t||i?(e=e?["_"+e]:Pusher.Util.keys(this._callbacks),t||i?Pusher.Util.apply(e,function(e){this._callbacks[e]=Pusher.Util.filter(this._callbacks[e]||[],function(e){return t&&t!==e.fn||i&&i!==e.context}),0===this._callbacks[e].length&&delete this._callbacks[e]},this):Pusher.Util.apply(e,function(e){delete this._callbacks[e]},this)):this._callbacks={}},Pusher.EventsDispatcher=e}.call(this),function(){function e(e,t){this.lastId=0,this.prefix=e,this.name=t}var t=e.prototype;t.create=function(e){this.lastId++;var t=this.lastId,i=this.prefix+t,n=this.name+"["+t+"]",o=!1,s=function(){o||(e.apply(null,arguments),o=!0)};return this[t]=s,{number:t,id:i,name:n,callback:s}},t.remove=function(e){delete this[e.number]},Pusher.ScriptReceiverFactory=e,Pusher.ScriptReceivers=new e("_pusher_script_","Pusher.ScriptReceivers")}.call(this),function(){function e(e){this.src=e}var t=e.prototype;t.send=function(e){var t=this,i="Error loading "+t.src;t.script=document.createElement("script"),t.script.id=e.id,t.script.src=t.src,t.script.type="text/javascript",t.script.charset="UTF-8",t.script.addEventListener?(t.script.onerror=function(){e.callback(i)},t.script.onload=function(){e.callback(null)}):t.script.onreadystatechange=function(){("loaded"===t.script.readyState||"complete"===t.script.readyState)&&e.callback(null)},void 0===t.script.async&&document.attachEvent&&/opera/i.test(navigator.userAgent)?(t.errorScript=document.createElement("script"),t.errorScript.id=e.id+"_error",t.errorScript.text=e.name+"('"+i+"');",t.script.async=t.errorScript.async=!1):t.script.async=!0;var n=document.getElementsByTagName("head")[0];n.insertBefore(t.script,n.firstChild),t.errorScript&&n.insertBefore(t.errorScript,t.script.nextSibling)},t.cleanup=function(){this.script&&(this.script.onload=this.script.onerror=null,this.script.onreadystatechange=null),this.script&&this.script.parentNode&&this.script.parentNode.removeChild(this.script),this.errorScript&&this.errorScript.parentNode&&this.errorScript.parentNode.removeChild(this.errorScript),this.errorScript=this.script=null},Pusher.ScriptRequest=e}.call(this),function(){function e(e){this.options=e,this.receivers=e.receivers||Pusher.ScriptReceivers,this.loading={}}var t=e.prototype;t.load=function(e,t,i){var n=this;if(n.loading[e]&&0<n.loading[e].length)n.loading[e].push(i);else{n.loading[e]=[i];var o=new Pusher.ScriptRequest(n.getPath(e,t)),s=n.receivers.create(function(t){if(n.receivers.remove(s),n.loading[e]){var i=n.loading[e];delete n.loading[e];for(var r=function(e){e||o.cleanup()},l=0;l<i.length;l++)i[l](t,r)}});o.send(s)}},t.getRoot=function(e){var t=Pusher.Util.getDocument().location.protocol;return(e&&e.encrypted||"https:"===t?this.options.cdn_https:this.options.cdn_http).replace(/\/*$/,"")+"/"+this.options.version},t.getPath=function(e,t){return this.getRoot(t)+"/"+e+this.options.suffix+".js"},Pusher.DependencyLoader=e}.call(this),function(){function e(){Pusher.ready()}function t(e){document.body?e():setTimeout(function(){t(e)},0)}function i(){t(e)}Pusher.DependenciesReceivers=new Pusher.ScriptReceiverFactory("_pusher_dependencies","Pusher.DependenciesReceivers"),Pusher.Dependencies=new Pusher.DependencyLoader({cdn_http:Pusher.cdn_http,cdn_https:Pusher.cdn_https,version:Pusher.VERSION,suffix:Pusher.dependency_suffix,receivers:Pusher.DependenciesReceivers}),window.JSON?i():Pusher.Dependencies.load("json2",{},i)}(),function(){for(var e=String.fromCharCode,t=0;64>t;t++)"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(t);var i=function(t){var i=t.charCodeAt(0);return 128>i?t:2048>i?e(192|i>>>6)+e(128|63&i):e(224|i>>>12&15)+e(128|i>>>6&63)+e(128|63&i)},n=function(e){var t=[0,2,1][e.length%3];return e=e.charCodeAt(0)<<16|(1<e.length?e.charCodeAt(1):0)<<8|(2<e.length?e.charCodeAt(2):0),["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(e>>>18),"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(e>>>12&63),t>=2?"=":"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(e>>>6&63),t>=1?"=":"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(63&e)].join("")},o=window.btoa||function(e){return e.replace(/[\s\S]{1,3}/g,n)};Pusher.Base64={encode:function(e){return o(e.replace(/[^\x00-\x7F]/g,i))}}}.call(this),function(){function e(e,t){this.url=e,this.data=t}function t(e){return Pusher.Util.mapObject(e,function(e){return"object"==typeof e&&(e=JSON.stringify(e)),encodeURIComponent(Pusher.Base64.encode(e.toString()))})}var i=e.prototype;i.send=function(e){if(!this.request){var i=Pusher.Util.filterObject(this.data,function(e){return void 0!==e}),i=Pusher.Util.map(Pusher.Util.flatten(t(i)),Pusher.Util.method("join","=")).join("&");this.request=new Pusher.ScriptRequest(this.url+"/"+e.number+"?"+i),this.request.send(e)}},i.cleanup=function(){this.request&&this.request.cleanup()},Pusher.JSONPRequest=e}.call(this),function(){function e(e,t,i){this.key=e,this.session=t,this.events=[],this.options=i||{},this.uniqueID=this.sent=0}var t=e.prototype;e.ERROR=3,e.INFO=6,e.DEBUG=7,t.log=function(e,t){e<=this.options.level&&(this.events.push(Pusher.Util.extend({},t,{timestamp:Pusher.Util.now()})),this.options.limit&&this.events.length>this.options.limit&&this.events.shift())},t.error=function(t){this.log(e.ERROR,t)},t.info=function(t){this.log(e.INFO,t)},t.debug=function(t){this.log(e.DEBUG,t)},t.isEmpty=function(){return 0===this.events.length},t.send=function(e,t){var i=this,n=Pusher.Util.extend({session:i.session,bundle:i.sent+1,key:i.key,lib:"js",version:i.options.version,cluster:i.options.cluster,features:i.options.features,timeline:i.events},i.options.params);return i.events=[],e(n,function(e,n){e||i.sent++,t&&t(e,n)}),!0},t.generateUniqueID=function(){return this.uniqueID++,this.uniqueID},Pusher.Timeline=e}.call(this),function(){function e(e,t){this.timeline=e,this.options=t||{}}e.prototype.send=function(e,t){var i=this;i.timeline.isEmpty()||i.timeline.send(function(t,n){var o=new Pusher.JSONPRequest("http"+(e?"s":"")+"://"+(i.host||i.options.host)+i.options.path,t),s=Pusher.ScriptReceivers.create(function(e,t){Pusher.ScriptReceivers.remove(s),o.cleanup(),t&&t.host&&(i.host=t.host),n&&n(e,t)});o.send(s)},t)},Pusher.TimelineSender=e}.call(this),function(){function e(e){this.strategies=e}function t(e,t,i){var o=Pusher.Util.map(e,function(e,n,o,s){return e.connect(t,i(n,s))});return{abort:function(){Pusher.Util.apply(o,n)},forceMinPriority:function(e){Pusher.Util.apply(o,function(t){t.forceMinPriority(e)})}}}function i(e){return Pusher.Util.all(e,function(e){return Boolean(e.error)})}function n(e){!e.error&&!e.aborted&&(e.abort(),e.aborted=!0)}var o=e.prototype;o.isSupported=function(){return Pusher.Util.any(this.strategies,Pusher.Util.method("isSupported"))},o.connect=function(e,n){return t(this.strategies,e,function(e,t){return function(o,s){(t[e].error=o)?i(t)&&n(!0):(Pusher.Util.apply(t,function(e){e.forceMinPriority(s.transport.priority)}),n(null,s))}})},Pusher.BestConnectedEverStrategy=e}.call(this),function(){function e(e,t,i){this.strategy=e,this.transports=t,this.ttl=i.ttl||18e5,this.encrypted=i.encrypted,this.timeline=i.timeline}function t(e){return"pusherTransport"+(e?"Encrypted":"Unencrypted")}function i(e){var i=Pusher.Util.getLocalStorage();if(i)try{var o=i[t(e)];if(o)return JSON.parse(o)}catch(s){n(e)}return null}function n(e){var i=Pusher.Util.getLocalStorage();if(i)try{delete i[t(e)]}catch(n){}}var o=e.prototype;o.isSupported=function(){return this.strategy.isSupported()},o.connect=function(e,o){var s=this.encrypted,r=i(s),l=[this.strategy];if(r&&r.timestamp+this.ttl>=Pusher.Util.now()){var a=this.transports[r.transport];a&&(this.timeline.info({cached:!0,transport:r.transport,latency:r.latency}),l.push(new Pusher.SequentialStrategy([a],{timeout:2*r.latency+1e3,failFast:!0})))}var u=Pusher.Util.now(),c=l.pop().connect(e,function d(i,r){if(i)n(s),0<l.length?(u=Pusher.Util.now(),c=l.pop().connect(e,d)):o(i);else{var a=r.transport.name,h=Pusher.Util.now()-u,p=Pusher.Util.getLocalStorage();if(p)try{p[t(s)]=JSON.stringify({timestamp:Pusher.Util.now(),transport:a,latency:h})}catch(f){}o(null,r)}});return{abort:function(){c.abort()},forceMinPriority:function(t){e=t,c&&c.forceMinPriority(t)}}},Pusher.CachedStrategy=e}.call(this),function(){function e(e,t){this.strategy=e,this.options={delay:t.delay}}var t=e.prototype;t.isSupported=function(){return this.strategy.isSupported()},t.connect=function(e,t){var i,n=this.strategy,o=new Pusher.Timer(this.options.delay,function(){i=n.connect(e,t)});return{abort:function(){o.ensureAborted(),i&&i.abort()},forceMinPriority:function(t){e=t,i&&i.forceMinPriority(t)}}},Pusher.DelayedStrategy=e}.call(this),function(){function e(e){this.strategy=e}var t=e.prototype;t.isSupported=function(){return this.strategy.isSupported()},t.connect=function(e,t){var i=this.strategy.connect(e,function(e,n){n&&i.abort(),t(e,n)});return i},Pusher.FirstConnectedStrategy=e}.call(this),function(){function e(e,t,i){this.test=e,this.trueBranch=t,this.falseBranch=i}var t=e.prototype;t.isSupported=function(){return(this.test()?this.trueBranch:this.falseBranch).isSupported()},t.connect=function(e,t){return(this.test()?this.trueBranch:this.falseBranch).connect(e,t)},Pusher.IfStrategy=e}.call(this),function(){function e(e,t){this.strategies=e,this.loop=Boolean(t.loop),this.failFast=Boolean(t.failFast),this.timeout=t.timeout,this.timeoutLimit=t.timeoutLimit}var t=e.prototype;t.isSupported=function(){return Pusher.Util.any(this.strategies,Pusher.Util.method("isSupported"))},t.connect=function(e,t){var i=this,n=this.strategies,o=0,s=this.timeout,r=null,l=function(a,u){u?t(null,u):(o+=1,i.loop&&(o%=n.length),o<n.length?(s&&(s*=2,i.timeoutLimit&&(s=Math.min(s,i.timeoutLimit))),r=i.tryStrategy(n[o],e,{timeout:s,failFast:i.failFast},l)):t(!0))},r=this.tryStrategy(n[o],e,{timeout:s,failFast:this.failFast},l);return{abort:function(){r.abort()},forceMinPriority:function(t){e=t,r&&r.forceMinPriority(t)}}},t.tryStrategy=function(e,t,i,n){var o=null,s=null;return 0<i.timeout&&(o=new Pusher.Timer(i.timeout,function(){s.abort(),n(!0)})),s=e.connect(t,function(e,t){e&&o&&o.isRunning()&&!i.failFast||(o&&o.ensureAborted(),n(e,t))}),{abort:function(){o&&o.ensureAborted(),s.abort()},forceMinPriority:function(e){s.forceMinPriority(e)}}},Pusher.SequentialStrategy=e}.call(this),function(){function e(e,t,i,n){this.name=e,this.priority=t,this.transport=i,this.options=n||{}}function t(e,t){return Pusher.Util.defer(function(){t(e)}),{abort:function(){},forceMinPriority:function(){}}}var i=e.prototype;i.isSupported=function(){return this.transport.isSupported({encrypted:this.options.encrypted})},i.connect=function(e,i){if(!this.isSupported())return t(new Pusher.Errors.UnsupportedStrategy,i);if(this.priority<e)return t(new Pusher.Errors.TransportPriorityTooLow,i);var n=this,o=!1,s=this.transport.createConnection(this.name,this.priority,this.options.key,this.options),r=null,l=function(){s.unbind("initialized",l),s.connect()},a=function(){r=new Pusher.Handshake(s,function(e){o=!0,d(),i(null,e)})},u=function(e){d(),i(e)},c=function(){d(),i(new Pusher.Errors.TransportClosed(s))},d=function(){s.unbind("initialized",l),s.unbind("open",a),s.unbind("error",u),s.unbind("closed",c)};return s.bind("initialized",l),s.bind("open",a),s.bind("error",u),s.bind("closed",c),s.initialize(),{abort:function(){o||(d(),r?r.close():s.close())},forceMinPriority:function(e){o||n.priority<e&&(r?r.close():s.close())}}},Pusher.TransportStrategy=e}.call(this),function(){function e(e,t,i){return e+(t.encrypted?"s":"")+"://"+(t.encrypted?t.hostEncrypted:t.hostUnencrypted)+i}function t(e,t){return"/app/"+e+("?protocol="+Pusher.PROTOCOL+"&client=js&version="+Pusher.VERSION+(t?"&"+t:""))}Pusher.URLSchemes={ws:{getInitial:function(i,n){return e("ws",n,t(i,"flash=false"))}},flash:{getInitial:function(i,n){return e("ws",n,t(i,"flash=true"))}},sockjs:{getInitial:function(t,i){return e("http",i,i.httpPath||"/pusher","")},getPath:function(e){return t(e)}},http:{getInitial:function(i,n){var o=(n.httpPath||"/pusher")+t(i);return e("http",n,o)}}}}.call(this),function(){function e(e,t,i,n,o){Pusher.EventsDispatcher.call(this),this.hooks=e,this.name=t,this.priority=i,this.key=n,this.options=o,this.state="new",this.timeline=o.timeline,this.activityTimeout=o.activityTimeout,this.id=this.timeline.generateUniqueID()}var t=e.prototype;Pusher.Util.extend(t,Pusher.EventsDispatcher.prototype),t.handlesActivityChecks=function(){return Boolean(this.hooks.handlesActivityChecks)},t.supportsPing=function(){return Boolean(this.hooks.supportsPing)},t.initialize=function(){var e=this;e.timeline.info(e.buildTimelineMessage({transport:e.name+(e.options.encrypted?"s":"")})),e.hooks.beforeInitialize&&e.hooks.beforeInitialize.call(e),e.hooks.isInitialized()?e.changeState("initialized"):e.hooks.file?(e.changeState("initializing"),Pusher.Dependencies.load(e.hooks.file,{encrypted:e.options.encrypted},function(t,i){e.hooks.isInitialized()?(e.changeState("initialized"),i(!0)):(t&&e.onError(t),e.onClose(),i(!1))})):e.onClose()},t.connect=function(){var e=this;if(e.socket||"initialized"!==e.state)return!1;var t=e.hooks.urls.getInitial(e.key,e.options);try{e.socket=e.hooks.getSocket(t,e.options)}catch(i){return Pusher.Util.defer(function(){e.onError(i),e.changeState("closed")}),!1}return e.bindListeners(),Pusher.debug("Connecting",{transport:e.name,url:t}),e.changeState("connecting"),!0},t.close=function(){return this.socket?(this.socket.close(),!0):!1},t.send=function(e){var t=this;return"open"===t.state?(Pusher.Util.defer(function(){t.socket&&t.socket.send(e)}),!0):!1},t.ping=function(){"open"===this.state&&this.supportsPing()&&this.socket.ping()},t.onOpen=function(){this.hooks.beforeOpen&&this.hooks.beforeOpen(this.socket,this.hooks.urls.getPath(this.key,this.options)),this.changeState("open"),this.socket.onopen=void 0},t.onError=function(e){this.emit("error",{type:"WebSocketError",error:e}),this.timeline.error(this.buildTimelineMessage({error:e.toString()}))},t.onClose=function(e){e?this.changeState("closed",{code:e.code,reason:e.reason,wasClean:e.wasClean}):this.changeState("closed"),this.unbindListeners(),this.socket=void 0},t.onMessage=function(e){this.emit("message",e)},t.onActivity=function(){this.emit("activity")},t.bindListeners=function(){var e=this;e.socket.onopen=function(){e.onOpen()},e.socket.onerror=function(t){e.onError(t)},e.socket.onclose=function(t){e.onClose(t)},e.socket.onmessage=function(t){e.onMessage(t)},e.supportsPing()&&(e.socket.onactivity=function(){e.onActivity()})},t.unbindListeners=function(){this.socket&&(this.socket.onopen=void 0,this.socket.onerror=void 0,this.socket.onclose=void 0,this.socket.onmessage=void 0,this.supportsPing()&&(this.socket.onactivity=void 0))},t.changeState=function(e,t){this.state=e,this.timeline.info(this.buildTimelineMessage({state:e,params:t})),this.emit(e,t)},t.buildTimelineMessage=function(e){return Pusher.Util.extend({cid:this.id},e)},Pusher.TransportConnection=e}.call(this),function(){function e(e){this.hooks=e}var t=e.prototype;t.isSupported=function(e){return this.hooks.isSupported(e)},t.createConnection=function(e,t,i,n){return new Pusher.TransportConnection(this.hooks,e,t,i,n)},Pusher.Transport=e}.call(this),function(){Pusher.WSTransport=new Pusher.Transport({urls:Pusher.URLSchemes.ws,handlesActivityChecks:!1,supportsPing:!1,isInitialized:function(){return Boolean(window.WebSocket||window.MozWebSocket)},isSupported:function(){return Boolean(window.WebSocket||window.MozWebSocket)},getSocket:function(e){return new(window.WebSocket||window.MozWebSocket)(e)}}),Pusher.FlashTransport=new Pusher.Transport({file:"flashfallback",urls:Pusher.URLSchemes.flash,handlesActivityChecks:!1,supportsPing:!1,isSupported:function(){try{return Boolean(new ActiveXObject("ShockwaveFlash.ShockwaveFlash"))}catch(e){try{var t=Pusher.Util.getNavigator();return Boolean(t&&t.mimeTypes&&void 0!==t.mimeTypes["application/x-shockwave-flash"])}catch(i){return!1}}},beforeInitialize:function(){void 0===window.WEB_SOCKET_SUPPRESS_CROSS_DOMAIN_SWF_ERROR&&(window.WEB_SOCKET_SUPPRESS_CROSS_DOMAIN_SWF_ERROR=!0),window.WEB_SOCKET_SWF_LOCATION=Pusher.Dependencies.getRoot({encrypted:this.options.encrypted})+"/WebSocketMain.swf"},isInitialized:function(){return void 0!==window.FlashWebSocket},getSocket:function(e){return new FlashWebSocket(e)}}),Pusher.SockJSTransport=new Pusher.Transport({file:"sockjs",urls:Pusher.URLSchemes.sockjs,handlesActivityChecks:!0,supportsPing:!1,isSupported:function(){return!0},isInitialized:function(){return void 0!==window.SockJS},getSocket:function(e,t){return new SockJS(e,null,{js_path:Pusher.Dependencies.getPath("sockjs",{encrypted:t.encrypted}),ignore_null_origin:t.ignoreNullOrigin})},beforeOpen:function(e,t){e.send(JSON.stringify({path:t}))}});var e={urls:Pusher.URLSchemes.http,handlesActivityChecks:!1,supportsPing:!0,isInitialized:function(){return Boolean(Pusher.HTTP.Socket)}},t=Pusher.Util.extend({getSocket:function(e){return Pusher.HTTP.getStreamingSocket(e)}},e),e=Pusher.Util.extend({getSocket:function(e){return Pusher.HTTP.getPollingSocket(e)}},e),i={file:"xhr",isSupported:Pusher.Util.isXHRSupported},n={file:"xdr",isSupported:function(e){return Pusher.Util.isXDRSupported(e.encrypted)}};Pusher.XHRStreamingTransport=new Pusher.Transport(Pusher.Util.extend({},t,i)),Pusher.XDRStreamingTransport=new Pusher.Transport(Pusher.Util.extend({},t,n)),Pusher.XHRPollingTransport=new Pusher.Transport(Pusher.Util.extend({},e,i)),Pusher.XDRPollingTransport=new Pusher.Transport(Pusher.Util.extend({},e,n))}.call(this),function(){function e(e,t,i){this.manager=e,this.transport=t,this.minPingDelay=i.minPingDelay,this.maxPingDelay=i.maxPingDelay,this.pingDelay=void 0}var t=e.prototype;t.createConnection=function(e,t,i,n){var o=this;n=Pusher.Util.extend({},n,{activityTimeout:o.pingDelay});var s=o.transport.createConnection(e,t,i,n),r=null,l=function(){s.unbind("open",l),s.bind("closed",a),r=Pusher.Util.now()},a=function(e){s.unbind("closed",a),1002===e.code||1003===e.code?o.manager.reportDeath():!e.wasClean&&r&&(e=Pusher.Util.now()-r,e<2*o.maxPingDelay&&(o.manager.reportDeath(),o.pingDelay=Math.max(e/2,o.minPingDelay)))};return s.bind("open",l),s},t.isSupported=function(e){return this.manager.isAlive()&&this.transport.isSupported(e)},Pusher.AssistantToTheTransportManager=e}.call(this),function(){function e(e){this.options=e||{},this.livesLeft=this.options.lives||1/0}var t=e.prototype;t.getAssistant=function(e){return new Pusher.AssistantToTheTransportManager(this,e,{minPingDelay:this.options.minPingDelay,maxPingDelay:this.options.maxPingDelay})},t.isAlive=function(){return 0<this.livesLeft},t.reportDeath=function(){this.livesLeft-=1},Pusher.TransportManager=e}.call(this),function(){function e(e){return function(t){return[e.apply(this,arguments),t]}}function t(e,i){if(0===e.length)return[[],i];var o=n(e[0],i),s=t(e.slice(1),o[1]);return[[o[0]].concat(s[0]),s[1]]}function i(e,i){if("string"==typeof e[0]&&":"===e[0].charAt(0)){var o=i[e[0].slice(1)];if(1<e.length){if("function"!=typeof o)throw"Calling non-function "+e[0];var s=[Pusher.Util.extend({},i)].concat(Pusher.Util.map(e.slice(1),function(e){return n(e,Pusher.Util.extend({},i))[0]}));return o.apply(this,s)}return[o,i]}return t(e,i)}function n(e,t){if("string"==typeof e){var n;if("string"==typeof e&&":"===e.charAt(0)){if(n=t[e.slice(1)],void 0===n)throw"Undefined symbol "+e;n=[n,t]}else n=[e,t];return n}return"object"==typeof e&&e instanceof Array&&0<e.length?i(e,t):[e,t]}var o={ws:Pusher.WSTransport,flash:Pusher.FlashTransport,sockjs:Pusher.SockJSTransport,xhr_streaming:Pusher.XHRStreamingTransport,xdr_streaming:Pusher.XDRStreamingTransport,xhr_polling:Pusher.XHRPollingTransport,xdr_polling:Pusher.XDRPollingTransport},s={isSupported:function(){return!1},connect:function(e,t){var i=Pusher.Util.defer(function(){t(new Pusher.Errors.UnsupportedStrategy)});return{abort:function(){i.ensureAborted()},forceMinPriority:function(){}}}},r={extend:function(e,t,i){return[Pusher.Util.extend({},t,i),e]},def:function(e,t,i){if(void 0!==e[t])throw"Redefining symbol "+t;return e[t]=i,[void 0,e]},def_transport:function(e,t,i,n,r,l){var a=o[i];if(!a)throw new Pusher.Errors.UnsupportedTransport(i);return i=e.enabledTransports&&-1===Pusher.Util.arrayIndexOf(e.enabledTransports,t)||e.disabledTransports&&-1!==Pusher.Util.arrayIndexOf(e.disabledTransports,t)||"flash"===t&&!0===e.disableFlash?s:new Pusher.TransportStrategy(t,n,l?l.getAssistant(a):a,Pusher.Util.extend({key:e.key,encrypted:e.encrypted,timeline:e.timeline,ignoreNullOrigin:e.ignoreNullOrigin},r)),n=e.def(e,t,i)[1],n.transports=e.transports||{},n.transports[t]=i,[void 0,n]},transport_manager:e(function(e,t){return new Pusher.TransportManager(t)}),sequential:e(function(e,t){var i=Array.prototype.slice.call(arguments,2);return new Pusher.SequentialStrategy(i,t)}),cached:e(function(e,t,i){return new Pusher.CachedStrategy(i,e.transports,{ttl:t,timeline:e.timeline,encrypted:e.encrypted})}),first_connected:e(function(e,t){return new Pusher.FirstConnectedStrategy(t)}),best_connected_ever:e(function(){var e=Array.prototype.slice.call(arguments,1);return new Pusher.BestConnectedEverStrategy(e)}),delayed:e(function(e,t,i){return new Pusher.DelayedStrategy(i,{delay:t})}),"if":e(function(e,t,i,n){return new Pusher.IfStrategy(t,i,n)}),is_supported:e(function(e,t){return function(){return t.isSupported()
}})};Pusher.StrategyBuilder={build:function(e,t){var i=Pusher.Util.extend({},r,t);return n(e,i)[1].strategy}}}.call(this),function(){Pusher.Protocol={decodeMessage:function(e){try{var t=JSON.parse(e.data);if("string"==typeof t.data)try{t.data=JSON.parse(t.data)}catch(i){if(!(i instanceof SyntaxError))throw i}return t}catch(n){throw{type:"MessageParseError",error:n,data:e.data}}},encodeMessage:function(e){return JSON.stringify(e)},processHandshake:function(e){if(e=this.decodeMessage(e),"pusher:connection_established"===e.event){if(!e.data.activity_timeout)throw"No activity timeout specified in handshake";return{action:"connected",id:e.data.socket_id,activityTimeout:1e3*e.data.activity_timeout}}if("pusher:error"===e.event)return{action:this.getCloseAction(e.data),error:this.getCloseError(e.data)};throw"Invalid handshake"},getCloseAction:function(e){return 4e3>e.code?1002<=e.code&&1004>=e.code?"backoff":null:4e3===e.code?"ssl_only":4100>e.code?"refused":4200>e.code?"backoff":4300>e.code?"retry":"refused"},getCloseError:function(e){return 1e3!==e.code&&1001!==e.code?{type:"PusherError",data:{code:e.code,message:e.reason||e.message}}:null}}}.call(this),function(){function e(e,t){Pusher.EventsDispatcher.call(this),this.id=e,this.transport=t,this.activityTimeout=t.activityTimeout,this.bindListeners()}var t=e.prototype;Pusher.Util.extend(t,Pusher.EventsDispatcher.prototype),t.handlesActivityChecks=function(){return this.transport.handlesActivityChecks()},t.send=function(e){return this.transport.send(e)},t.send_event=function(e,t,i){return e={event:e,data:t},i&&(e.channel=i),Pusher.debug("Event sent",e),this.send(Pusher.Protocol.encodeMessage(e))},t.ping=function(){this.transport.supportsPing()?this.transport.ping():this.send_event("pusher:ping",{})},t.close=function(){this.transport.close()},t.bindListeners=function(){var e=this,t={message:function(t){var i;try{i=Pusher.Protocol.decodeMessage(t)}catch(n){e.emit("error",{type:"MessageParseError",error:n,data:t.data})}if(void 0!==i){switch(Pusher.debug("Event recd",i),i.event){case"pusher:error":e.emit("error",{type:"PusherError",data:i.data});break;case"pusher:ping":e.emit("ping");break;case"pusher:pong":e.emit("pong")}e.emit("message",i)}},activity:function(){e.emit("activity")},error:function(t){e.emit("error",{type:"WebSocketError",error:t})},closed:function(t){i(),t&&t.code&&e.handleCloseEvent(t),e.transport=null,e.emit("closed")}},i=function(){Pusher.Util.objectApply(t,function(t,i){e.transport.unbind(i,t)})};Pusher.Util.objectApply(t,function(t,i){e.transport.bind(i,t)})},t.handleCloseEvent=function(e){var t=Pusher.Protocol.getCloseAction(e);(e=Pusher.Protocol.getCloseError(e))&&this.emit("error",e),t&&this.emit(t)},Pusher.Connection=e}.call(this),function(){function e(e,t){this.transport=e,this.callback=t,this.bindListeners()}var t=e.prototype;t.close=function(){this.unbindListeners(),this.transport.close()},t.bindListeners=function(){var e=this;e.onMessage=function(t){e.unbindListeners();try{var i=Pusher.Protocol.processHandshake(t);"connected"===i.action?e.finish("connected",{connection:new Pusher.Connection(i.id,e.transport),activityTimeout:i.activityTimeout}):(e.finish(i.action,{error:i.error}),e.transport.close())}catch(n){e.finish("error",{error:n}),e.transport.close()}},e.onClosed=function(t){e.unbindListeners();var i=Pusher.Protocol.getCloseAction(t)||"backoff";t=Pusher.Protocol.getCloseError(t),e.finish(i,{error:t})},e.transport.bind("message",e.onMessage),e.transport.bind("closed",e.onClosed)},t.unbindListeners=function(){this.transport.unbind("message",this.onMessage),this.transport.unbind("closed",this.onClosed)},t.finish=function(e,t){this.callback(Pusher.Util.extend({transport:this.transport,action:e},t))},Pusher.Handshake=e}.call(this),function(){function e(e,t){Pusher.EventsDispatcher.call(this),this.key=e,this.options=t||{},this.state="initialized",this.connection=null,this.encrypted=!!t.encrypted,this.timeline=this.options.timeline,this.connectionCallbacks=this.buildConnectionCallbacks(),this.errorCallbacks=this.buildErrorCallbacks(),this.handshakeCallbacks=this.buildHandshakeCallbacks(this.errorCallbacks);var i=this;Pusher.Network.bind("online",function(){i.timeline.info({netinfo:"online"}),("connecting"===i.state||"unavailable"===i.state)&&i.retryIn(0)}),Pusher.Network.bind("offline",function(){i.timeline.info({netinfo:"offline"}),i.connection&&i.sendActivityCheck()}),this.updateStrategy()}var t=e.prototype;Pusher.Util.extend(t,Pusher.EventsDispatcher.prototype),t.connect=function(){!this.connection&&!this.runner&&(this.strategy.isSupported()?(this.updateState("connecting"),this.startConnecting(),this.setUnavailableTimer()):this.updateState("failed"))},t.send=function(e){return this.connection?this.connection.send(e):!1},t.send_event=function(e,t,i){return this.connection?this.connection.send_event(e,t,i):!1},t.disconnect=function(){this.disconnectInternally(),this.updateState("disconnected")},t.isEncrypted=function(){return this.encrypted},t.startConnecting=function(){var e=this,t=function(i,n){i?e.runner=e.strategy.connect(0,t):"error"===n.action?(e.emit("error",{type:"HandshakeError",error:n.error}),e.timeline.error({handshakeError:n.error})):(e.abortConnecting(),e.handshakeCallbacks[n.action](n))};e.runner=e.strategy.connect(0,t)},t.abortConnecting=function(){this.runner&&(this.runner.abort(),this.runner=null)},t.disconnectInternally=function(){this.abortConnecting(),this.clearRetryTimer(),this.clearUnavailableTimer(),this.connection&&this.abandonConnection().close()},t.updateStrategy=function(){this.strategy=this.options.getStrategy({key:this.key,timeline:this.timeline,encrypted:this.encrypted})},t.retryIn=function(e){var t=this;t.timeline.info({action:"retry",delay:e}),e>0&&t.emit("connecting_in",Math.round(e/1e3)),t.retryTimer=new Pusher.Timer(e||0,function(){t.disconnectInternally(),t.connect()})},t.clearRetryTimer=function(){this.retryTimer&&(this.retryTimer.ensureAborted(),this.retryTimer=null)},t.setUnavailableTimer=function(){var e=this;e.unavailableTimer=new Pusher.Timer(e.options.unavailableTimeout,function(){e.updateState("unavailable")})},t.clearUnavailableTimer=function(){this.unavailableTimer&&this.unavailableTimer.ensureAborted()},t.sendActivityCheck=function(){var e=this;e.stopActivityCheck(),e.connection.ping(),e.activityTimer=new Pusher.Timer(e.options.pongTimeout,function(){e.timeline.error({pong_timed_out:e.options.pongTimeout}),e.retryIn(0)})},t.resetActivityCheck=function(){var e=this;e.stopActivityCheck(),e.connection.handlesActivityChecks()||(e.activityTimer=new Pusher.Timer(e.activityTimeout,function(){e.sendActivityCheck()}))},t.stopActivityCheck=function(){this.activityTimer&&this.activityTimer.ensureAborted()},t.buildConnectionCallbacks=function(){var e=this;return{message:function(t){e.resetActivityCheck(),e.emit("message",t)},ping:function(){e.send_event("pusher:pong",{})},activity:function(){e.resetActivityCheck()},error:function(t){e.emit("error",{type:"WebSocketError",error:t})},closed:function(){e.abandonConnection(),e.shouldRetry()&&e.retryIn(1e3)}}},t.buildHandshakeCallbacks=function(e){var t=this;return Pusher.Util.extend({},e,{connected:function(e){t.activityTimeout=Math.min(t.options.activityTimeout,e.activityTimeout,e.connection.activityTimeout||1/0),t.clearUnavailableTimer(),t.setConnection(e.connection),t.socket_id=t.connection.id,t.updateState("connected",{socket_id:t.socket_id})}})},t.buildErrorCallbacks=function(){function e(e){return function(i){i.error&&t.emit("error",{type:"WebSocketError",error:i.error}),e(i)}}var t=this;return{ssl_only:e(function(){t.encrypted=!0,t.updateStrategy(),t.retryIn(0)}),refused:e(function(){t.disconnect()}),backoff:e(function(){t.retryIn(1e3)}),retry:e(function(){t.retryIn(0)})}},t.setConnection=function(e){this.connection=e;for(var t in this.connectionCallbacks)this.connection.bind(t,this.connectionCallbacks[t]);this.resetActivityCheck()},t.abandonConnection=function(){if(this.connection){this.stopActivityCheck();for(var e in this.connectionCallbacks)this.connection.unbind(e,this.connectionCallbacks[e]);return e=this.connection,this.connection=null,e}},t.updateState=function(e,t){var i=this.state;this.state=e,i!==e&&(Pusher.debug("State changed",i+" -> "+e),this.timeline.info({state:e,params:t}),this.emit("state_change",{previous:i,current:e}),this.emit(e,t))},t.shouldRetry=function(){return"connecting"===this.state||"connected"===this.state},Pusher.ConnectionManager=e}.call(this),function(){function e(){Pusher.EventsDispatcher.call(this);var e=this;void 0!==window.addEventListener&&(window.addEventListener("online",function(){e.emit("online")},!1),window.addEventListener("offline",function(){e.emit("offline")},!1))}Pusher.Util.extend(e.prototype,Pusher.EventsDispatcher.prototype),e.prototype.isOnline=function(){return void 0===window.navigator.onLine?!0:window.navigator.onLine},Pusher.NetInfo=e,Pusher.Network=new e}.call(this),function(){function e(){this.reset()}var t=e.prototype;t.get=function(e){return Object.prototype.hasOwnProperty.call(this.members,e)?{id:e,info:this.members[e]}:null},t.each=function(e){var t=this;Pusher.Util.objectApply(t.members,function(i,n){e(t.get(n))})},t.setMyID=function(e){this.myID=e},t.onSubscription=function(e){this.members=e.presence.hash,this.count=e.presence.count,this.me=this.get(this.myID)},t.addMember=function(e){return null===this.get(e.user_id)&&this.count++,this.members[e.user_id]=e.user_info,this.get(e.user_id)},t.removeMember=function(e){var t=this.get(e.user_id);return t&&(delete this.members[e.user_id],this.count--),t},t.reset=function(){this.members={},this.count=0,this.me=this.myID=null},Pusher.Members=e}.call(this),function(){function e(e,t){Pusher.EventsDispatcher.call(this,function(t){Pusher.debug("No callbacks on "+e+" for "+t)}),this.name=e,this.pusher=t,this.subscribed=!1}var t=e.prototype;Pusher.Util.extend(t,Pusher.EventsDispatcher.prototype),t.authorize=function(e,t){return t(!1,{})},t.trigger=function(e,t){if(0!==e.indexOf("client-"))throw new Pusher.Errors.BadEventName("Event '"+e+"' does not start with 'client-'");return this.pusher.send_event(e,t,this.name)},t.disconnect=function(){this.subscribed=!1},t.handleEvent=function(e,t){0===e.indexOf("pusher_internal:")?"pusher_internal:subscription_succeeded"===e&&(this.subscribed=!0,this.emit("pusher:subscription_succeeded",t)):this.emit(e,t)},t.subscribe=function(){var e=this;e.authorize(e.pusher.connection.socket_id,function(t,i){t?e.handleEvent("pusher:subscription_error",i):e.pusher.send_event("pusher:subscribe",{auth:i.auth,channel_data:i.channel_data,channel:e.name})})},t.unsubscribe=function(){this.pusher.send_event("pusher:unsubscribe",{channel:this.name})},Pusher.Channel=e}.call(this),function(){function e(e,t){Pusher.Channel.call(this,e,t)}var t=e.prototype;Pusher.Util.extend(t,Pusher.Channel.prototype),t.authorize=function(e,t){return new Pusher.Channel.Authorizer(this,this.pusher.config).authorize(e,t)},Pusher.PrivateChannel=e}.call(this),function(){function e(e,t){Pusher.PrivateChannel.call(this,e,t),this.members=new Pusher.Members}var t=e.prototype;Pusher.Util.extend(t,Pusher.PrivateChannel.prototype),t.authorize=function(e,t){var i=this;Pusher.PrivateChannel.prototype.authorize.call(i,e,function(e,n){if(!e){if(void 0===n.channel_data)return Pusher.warn("Invalid auth response for channel '"+i.name+"', expected 'channel_data' field"),void t("Invalid auth response");var o=JSON.parse(n.channel_data);i.members.setMyID(o.user_id)}t(e,n)})},t.handleEvent=function(e,t){switch(e){case"pusher_internal:subscription_succeeded":this.members.onSubscription(t),this.subscribed=!0,this.emit("pusher:subscription_succeeded",this.members);break;case"pusher_internal:member_added":var i=this.members.addMember(t);this.emit("pusher:member_added",i);break;case"pusher_internal:member_removed":(i=this.members.removeMember(t))&&this.emit("pusher:member_removed",i);break;default:Pusher.PrivateChannel.prototype.handleEvent.call(this,e,t)}},t.disconnect=function(){this.members.reset(),Pusher.PrivateChannel.prototype.disconnect.call(this)},Pusher.PresenceChannel=e}.call(this),function(){function e(){this.channels={}}var t=e.prototype;t.add=function(e,t){if(!this.channels[e]){var i,n=this.channels;i=0===e.indexOf("private-")?new Pusher.PrivateChannel(e,t):0===e.indexOf("presence-")?new Pusher.PresenceChannel(e,t):new Pusher.Channel(e,t),n[e]=i}return this.channels[e]},t.all=function(){return Pusher.Util.values(this.channels)},t.find=function(e){return this.channels[e]},t.remove=function(e){var t=this.channels[e];return delete this.channels[e],t},t.disconnect=function(){Pusher.Util.objectApply(this.channels,function(e){e.disconnect()})},Pusher.Channels=e}.call(this),function(){Pusher.Channel.Authorizer=function(e,t){this.channel=e,this.type=t.authTransport,this.options=t,this.authOptions=(t||{}).auth||{}},Pusher.Channel.Authorizer.prototype={composeQuery:function(e){e="socket_id="+encodeURIComponent(e)+"&channel_name="+encodeURIComponent(this.channel.name);for(var t in this.authOptions.params)e+="&"+encodeURIComponent(t)+"="+encodeURIComponent(this.authOptions.params[t]);return e},authorize:function(e,t){return Pusher.authorizers[this.type].call(this,e,t)}};var e=1;Pusher.auth_callbacks={},Pusher.authorizers={ajax:function(e,t){var i;i=Pusher.XHR?new Pusher.XHR:window.XMLHttpRequest?new window.XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),i.open("POST",this.options.authEndpoint,!0),i.setRequestHeader("Content-Type","application/x-www-form-urlencoded");for(var n in this.authOptions.headers)i.setRequestHeader(n,this.authOptions.headers[n]);return i.onreadystatechange=function(){if(4===i.readyState)if(200===i.status){var e,n=!1;try{e=JSON.parse(i.responseText),n=!0}catch(o){t(!0,"JSON returned from webapp was invalid, yet status code was 200. Data was: "+i.responseText)}n&&t(!1,e)}else Pusher.warn("Couldn't get auth info from your webapp",i.status),t(!0,i.status)},i.send(this.composeQuery(e)),i},jsonp:function(t,i){void 0!==this.authOptions.headers&&Pusher.warn("Warn","To send headers with the auth request, you must use AJAX, rather than JSONP.");var n=e.toString();e++;var o=Pusher.Util.getDocument(),s=o.createElement("script");Pusher.auth_callbacks[n]=function(e){i(!1,e)},s.src=this.options.authEndpoint+"?callback="+encodeURIComponent("Pusher.auth_callbacks['"+n+"']")+"&"+this.composeQuery(t),n=o.getElementsByTagName("head")[0]||o.documentElement,n.insertBefore(s,n.firstChild)}}}.call(this);